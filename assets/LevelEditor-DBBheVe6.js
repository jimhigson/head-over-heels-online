import{j as o,r as l}from"./index-B8b6N-un.js";import{B as U,o as X,n as oe,S as se}from"./ShowBoundingBoxSelect-Cj2nPPFX.js";import{ap as Z,a9 as y,w as T,z as ne,B as J,S as re,s as ie,N as ae,aa as g,aq as k,a8 as B,ar as ce,as as G,R as I,at as le,F as ue,au as de,av as pe,$ as W,aw as me,ax as A,ay as xe,U as he,az as fe,aA as C,aB as ge,K as q,aj as $,o as ye,aC as ve,ao as be,aD as je,aE as we,aF as Se,aG as Ce,aH as Re,C as ke}from"./App-BdNRGo5m.js";import{useAppSelectorWithLevelEditorSlice as j,selectTool as S,setTool as V,selectCurrentEditingRoomColour as Te,changeRoomColour as z,selectCurrentEditingRoomScenery as Ie,changeRoomScenery as Ee,selectCurrentEditingRoomJson as L,applyToolAtPosition as Pe}from"./levelEditorSlice-DFhsGIpa.js";import{c as Ne,A as Be,s as Ae,R as $e,i as ze,z as Le,a as Me,p as Y}from"./roomRenderer-BCfZBZ5I.js";import"./Graphics-CMXdjcIC.js";import"./changeCharacterRoom-COIlarCX.js";const K=e=>e,c=({itemTool:e,children:t,className:s})=>{const n=j(S),i=Z(n?.type==="item"&&n.item,e);return o.jsx(U,{"data-isCurrentTool":i,className:`active:pt-oneScaledPix h-3 w-3 gap-0 inline-flex overflow-hidden ${i?"bg-pastelBlue":""} ${s??""}`,onClick:()=>y.dispatch(V({type:"item",item:e})),children:t})},_e=()=>{const t=j(S)?.type==="pointer";return o.jsx(U,{className:`flex w-3 h-3 ${t?"bg-pastelBlue":""}`,onClick:()=>y.dispatch(V({type:"pointer"})),children:o.jsx("span",{className:"sprite texture-hud.char.â†– relative [button:active_&]:top-quarter"})})},M=e=>{const{main:t}=Ne[e].basic;return{backgroundColor:t.basic.toHex(),borderColor:t.dimmed.toHex()}};function Fe(){const e=T(),t=j(Te);return o.jsxs(o.Fragment,{children:[o.jsx(X,{value:t.hue,onSelect:s=>{e(z({hue:s}))},values:ne,disableCommandInput:!0,OptionCommandItem:({value:s,onSelect:n})=>o.jsx(oe,{value:s,className:"border-1 h-4 w-2",style:M(s),onSelect:n}),triggerButtonLabel:o.jsx(J,{children:"colour"}),triggerButtonClassName:K(`${t.hue==="white"?"text-pureBlack":"text-white"}`),triggerButtonStyle:M(t.hue)}),o.jsx(re,{value:t.shade==="basic",onClick:(s,n)=>{e(z({shade:n?"basic":"dimmed"}))},falseLabel:"dimmed",trueLabel:"basic"})]})}function De(){const e=T(),t=j(Ie);return o.jsx(X,{value:t,onSelect:s=>{e(Ee(s))},values:ie,disableCommandInput:!0,triggerButtonClassName:"w-18 text-white",triggerButtonLabel:o.jsx(J,{children:t})})}const a=K("[button:not([data-isCurrentTool=true]):not(:hover)_&]:sprite-revert-to-two-tone"),He=()=>o.jsxs("div",{className:"flex fixed top-0 right-0 w-14 text-white bg-metallicBlueHalfbrite p-half gap-oneScaledPix flex-wrap justify-start",children:[o.jsx(De,{}),o.jsx(Fe,{}),o.jsxs("div",{className:"flex flex-wrap gap-oneScaledPix",children:[o.jsx(_e,{}),o.jsx(c,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}},children:o.jsx("span",{className:`sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek" ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}},children:o.jsx("span",{className:`sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"turn-to-player",startDirection:"towards"}},children:o.jsx("span",{className:`sprite texture-elephant.towards [button:hover_&]:texture-elephant.right ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}},children:o.jsx("span",{className:`sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"cyberman",activated:"on",movement:"towards-on-shortest-axis-xy4",startDirection:"towards"}},children:o.jsx("span",{className:`sprite texture-cyberman.towards [button:hover_&]:texture-cyberman.right ${a}`})}),o.jsx(c,{itemTool:{type:"block",config:{style:"artificial"}},children:o.jsx("span",{className:`sprite texture-block.artificial ${a}`})}),o.jsxs(c,{itemTool:{type:"lift",config:{top:11,bottom:0}},className:"inline relative",children:[o.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.static ${a} [button:active_&]:top-oneScaledPix`}),o.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.1 [button:hover_&]:texture-animated-lift ${a} [button:active_&]:top-oneScaledPix`})]}),o.jsx(c,{itemTool:{type:"barrier",config:{axis:"x"}},children:o.jsx("span",{className:`sprite texture-barrier.x ${a}`})}),o.jsx(c,{itemTool:{type:"block",config:{style:"organic"}},children:o.jsx("span",{className:`sprite texture-block.organic ${a}`})}),o.jsx(c,{itemTool:{type:"block",config:{style:"book"}},children:o.jsx("span",{className:`sprite texture-book.x ${a}`})}),o.jsx(c,{itemTool:{type:"pickup",config:{gives:"extra-life"}},children:o.jsx("span",{className:`sprite texture-whiteRabbit ${a}`})}),o.jsx(c,{itemTool:{type:"conveyor",config:{direction:"away"}},children:o.jsx("span",{className:`sprite texture-conveyor.y.1 [button:hover_&]:texture-animated-conveyor.x ${a}`})}),o.jsx(c,{itemTool:{type:"teleporter",config:{toRoom:"(placeholder)",toPosition:ae}},children:o.jsx("span",{className:`sprite texture-teleporter ${a}`})}),o.jsx(c,{itemTool:{type:"charles",config:g},children:o.jsx("span",{className:`sprite texture-charles.towards [button:hover_&]:texture-charles.right ${a}`})}),o.jsx(c,{itemTool:{type:"joystick",config:{controls:["(placeholder)"]}},children:o.jsx("span",{className:`sprite texture-joystick ${a}`})}),o.jsx(c,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:k}},children:o.jsx("span",{className:`sprite texture-switch.left [button:hover_&]:texture-switch.right ${a}`})}),o.jsx(c,{itemTool:{type:"ball",config:g},children:o.jsx("span",{className:`sprite texture-ball ${a}`})}),o.jsx(c,{itemTool:{type:"portableBlock",config:{style:"cube"}},children:o.jsx("span",{className:`sprite texture-cube ${a}`})}),o.jsx(c,{itemTool:{type:"pushableBlock",config:{style:"stepStool"}},children:o.jsx("span",{className:`sprite texture-stepStool ${a}`})}),o.jsx(c,{itemTool:{type:"movingPlatform",config:{style:"sandwich",movement:"clockwise",activated:"on",startDirection:"towards"}},children:o.jsx("span",{className:`sprite texture-sandwich ${a}`})}),o.jsx(c,{itemTool:{type:"spikes",config:g},children:o.jsx("span",{className:`sprite texture-spikes ${a}`})}),o.jsx(c,{itemTool:{type:"deadlyBlock",config:{style:"volcano"}},children:o.jsx("span",{className:`sprite texture-volcano.1 [button:hover_&]:texture-animated-volcano ${a}`})}),o.jsx(c,{itemTool:{type:"slidingDeadly",config:{style:"spikyBall",startingPhase:1}},children:o.jsx("span",{className:`sprite texture-spikyBall.1 [button:hover_&]:texture-spikyBall.2 ${a}`})}),o.jsx(c,{itemTool:{type:"door",config:{direction:"away",toRoom:"(placeholder)"}},children:o.jsx("span",{className:`sprite texture-door.frame.generic.x.whole ${a}`})})]}),o.jsx("div",{className:"flex flex-row gap-1",children:o.jsx(se,{})})]}),Q=l.createContext(null),Oe=()=>{const[e,t]=l.useState(()=>B({roomJson:L(y.getState()),roomPickupsCollected:g,scrollsRead:g,isNewGame:!0})),s=j(L);return l.useEffect(()=>{const n=B({roomJson:s,roomPickupsCollected:g,scrollsRead:g,isNewGame:!0});t(n)},[s]),e},Ue=({children:e})=>{const t=Oe();return o.jsx(Q,{value:t,children:e})},E=()=>{const e=l.useContext(Q);if(e===null)throw new Error("no room state in context, or no context");return e},ee=l.createContext(null),Xe=({children:e})=>{const[t,s]=l.useState(null);return l.useEffect(()=>{const n=new Be;return n.init({background:Ae.pureBlack,sharedTicker:!0}).then(()=>{s(n)}),()=>{}},[]),t===null?null:o.jsx(ee,{value:t,children:e})},v=()=>l.useContext(ee),Ze=(e,t)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:t},soundSettings:{mute:!0},pixiRenderer:e,gameState:void 0,paused:!1,colourised:!0,upscale:G(y.getState())}),_=(e,t,s)=>new $e({room:e,general:Ze(t,s)}),Je=()=>{const{renderer:e}=v(),t=ce();if(!e)throw new Error("this should never be falsey (typescript violation)");const s=E(),[n,i]=l.useState(()=>_(s,e,t));return l.useEffect(()=>{const r=_(s,e,t);return i(r),()=>{r.destroy()}},[s,e,t]),n},w="cursor",F=({room:e,pointingAt:t,valid:s,includeCursor:n,previewItems:i})=>{const{face:r,position:d}=t;for(const u of i)le({room:e,item:u});if(n){const u=ue(w,e.items);u?(u.state.position=d,u.state.face=r,u.state.valid=s):e.items[w]={type:"cursor",id:w,state:{...pe(),face:r,position:d,valid:s},config:{},aabb:de}}else delete e.items[w]},R=e=>{for(const t of I(e.items))t.isCursorPreview&&delete e.items[t.id]};let Ge=0;const te=(e,t)=>{if(t.type==="door"||e.face==="top")return A(e.position);const s=xe[e.face];return he(A(e.position),s)},D=(e,t,s)=>{const n=[...I(t.items).filter(r=>W(r)&&r.type!=="cursor"&&!r.isCursorPreview)],i=(r,d)=>{const u=te(e,s),m=fe(`cursor/${Ge++}`,{type:r,config:d,position:u},t.roomJson).toArray();return m.forEach(x=>{x.isCursorPreview=!0}),m};if(s.type==="door"){const r=t.items[e.itemId];if(r.type!=="wall")return;const d=r.config.direction;return i("door",{...s.config,direction:d})}else{const r=i(s.type,s.config);return r.some(u=>{const m=me(u,n);return!ze(m)})?void 0:r}},p=q.w/2,b=q.h,H=p/2,We=b/2,qe=({x:e,y:t})=>s=>{const{bottomCentre:n,topLeft:i,topRight:r}=Y(s.state.position,s.aabb);return!(e<i.x||e>r.x||t<r.y-(r.x-e)/2||t<i.y-(e-i.x)/2||t>n.y-(e-n.x)/2||t>n.y-(n.x-e)/2)},Ve=(e,{x:t,y:s})=>{const{bottomCentre:n,topLeft:i,topRight:r}=Y(e.state.position,e.aabb);return s<i.y-(i.x-t)/2?s<r.y-(t-r.x)/2?"top":"right":t<n.x?"towards":"right"},O=e=>e.fixedZIndex!==void 0,Ye=e=>{if(e.every(O))return e.toSorted((r,d)=>d.fixedZIndex-r.fixedZIndex).at(0);const t=e.filter(r=>!O(r));if(t.length===0)return;if(t.length===1)return t[0];const s=Object.fromEntries(t.map(r=>[r.id,r])),n=Le(s),{order:i}=Me(n,s);return s[i[0]]},Ke=({state:{position:e},aabb:t},s,n)=>{const i=s==="top"?"xy":s==="towards"?"xz":"yz",r=ge(n,e,t,i);return{x:i==="yz"?Math.round(r.x/p)*p:Math.floor((r.x-H)/p)*p,y:i==="xz"?Math.round(r.y/p)*p:Math.floor((r.y-H)/p)*p,z:i==="xy"?Math.round(r.z/b)*b:Math.floor((r.z+We)/b)*b}},Qe=e=>t=>{const s=W(t)&&t.type!=="cursor"&&!t.isCursorPreview;return e.type==="item"&&e.item.type==="door"?s&&t.type==="wall":s},et=(e,t,s)=>{const n=Ye(Array.from(I(t.items).filter(Qe(s)).filter(qe(e))));if(n){const i=Ve(n,e);return{itemId:n.id,face:i,position:Ke(n,i,e)}}else return},tt=(e,t)=>{const s=e.cssUpscale*e.gameEngineUpscale;return{x:t.x/s-e.gameEngineScreenSize.x/2,y:t.y/s-e.gameEngineScreenSize.y+16}},ot=e=>{const t=v(),s=C(G),n=T(),i=E(),r=l.useRef(void 0);l.useEffect(()=>{if(t.stage.eventMode="none",e===null)return;const d=m=>{const x=tt(s,m),h=S(y.getState()),f=et(x,i,h);if(!Z(f,r.current))if(r.current=f,f!==void 0)switch(h.type){case"item":{const P=D(f,i,h.item),N=P!==void 0;R(i),F({room:i,pointingAt:f,valid:N,includeCursor:!N,previewItems:P??k});break}case"pointer":{R(i),F({room:i,pointingAt:f,valid:!0,includeCursor:!0,previewItems:k});break}}else R(i)},u=m=>{const x=S(y.getState());switch(x.type){case"item":{const h=r.current;if(h===void 0||D(h,i,x.item)===void 0)return;n(Pe({blockPosition:te(h,x.item)}));break}}};return e.addEventListener("mousemove",d),e.addEventListener("click",u),()=>{e.removeEventListener("mousemove",d),e.removeEventListener("click",u)}},[t.stage,s,e,n,i])},st=e=>{const t=E();l.useEffect(()=>{let s=0;const n=({deltaMS:i})=>{if(e.destroyed)return;e.renderContext.room!==t&&console.warn("room renderer does not have the current room");const r=new Set(ye(t.items));e.tick({deltaMS:i,movedItems:r,progression:s++})};return $.shared.add(n),()=>{$.shared.remove(n)}},[e,t])},nt=e=>{const t=v();l.useEffect(()=>{if(e)return e.appendChild(t.canvas),()=>{e.removeChild(t.canvas)}},[e,t])},rt=()=>{const e=v(),t=C(s=>s.upscale.upscale.gameEngineUpscale);e.stage.scale=t},it=()=>{const e=v(),t=C(ve);l.useEffect(()=>{e.renderer?.resize(t.x,t.y)},[e.renderer,t])},at=e=>{const t=v(),[s]=l.useState(()=>new be),n=C(je);l.useEffect(()=>{if(e.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return s.addChild(e.output.graphics),t.stage.addChild(s),()=>{t.stage.removeChild(s),s.removeChild(e.output.graphics)}},[e,t,s]),l.useEffect(()=>{s.x=n.x/2,s.y=n.y-16},[s,n])};Se.defaultOptions.scaleMode="nearest";const ct=()=>{const e=Je(),[t,s]=l.useState(null);it(),at(e),st(e),ot(t),nt(t),rt();const n=we();return o.jsx("div",{style:n,ref:s})},ft=()=>(Ce(),Re(),o.jsxs(o.Fragment,{children:[o.jsx("title",{children:"Hoh Editor"}),o.jsx(Xe,{children:o.jsx(Ue,{children:o.jsx(ct,{})})}),o.jsx(ke,{scaleFactor:2,children:o.jsx(He,{})})]}));export{ft as default};
