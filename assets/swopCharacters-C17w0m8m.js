import{H as ye,I as A,J as Ie,K as ge,L as w,N as c,O as M,Q as z,W as P,p as be,X as ee,Y as te,Z as ve,a as we,_ as B,$ as _e,a0 as T,a1 as De,a2 as Xe,a3 as ie,a4 as ke,a5 as $e}from"./App-BXjDNwaa.js";import{g as We}from"./index-BgmUXWjS.js";var D={},X={},ae;function Ye(){if(ae)return X;ae=1;var e=ye(),t=e.iterableCurry,s=e.callReturn;function o(a,n){var r=a[Symbol.iterator](),u=r.next(),h=u.value,p=u.done;return p?n:(s(r),h)}X.__firstOr=o;var i=t(o,{reduces:!0});return X.firstOr=i,X}var ne;function Ve(){if(ne)return D;ne=1;var e=ye(),t=e.iterableCurry,s=Ye(),o=s.__firstOr;function i(n){return o(n,void 0)}D.__first=i;var a=t(i,{reduces:!0});return D.first=a,D}var Q,re;function Ge(){return re||(re=1,Q=Ve().first),Q}var Le=Ge();const qe=We(Le),Lt=e=>e.characterRooms[e.currentCharacterName],l={w:16,d:16,h:12},le={x:16,y:16,z:12},Ze=["head","heels"],Qe=[...Ze,"headOverHeels"],H=e=>e==="head"?"heels":"head",g=(...e)=>t=>e.includes(t.type),Ue=g("bubbles","stopAutowalk","floorEdge","firedDoughnut"),Ke=(e,t)=>Ue(e)||C(e)&&(t!==void 0&&me(t)||e.config.direction.z!==0)||st(e)&&e.config.type==="none",Y=(e,t)=>!Ke(e,t),Je=(e,t=!1)=>V(e)&&!(!t&&me(e)&&e.state.autoWalk),xe=["ball","slidingBlock","slidingDeadly"],je=g(...xe),et=["portableBlock","spring","sceneryPlayer"],qt=g(...et),me=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function V(e){return Te.includes(e.type)}const Te=[...Qe,"monster","ball","charles","movableBlock","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer"],tt=["monster","deadlyBlock","moveableDeadly","slidingDeadly"],Zt=e=>g(...tt)(e)||e.type==="floor"&&e.config.type==="deadly",Qt=e=>e.config.times!==void 0,C=g("portal"),Ut=g("teleporter"),Kt=g("heels","headOverHeels"),Jt=g("head","headOverHeels"),jt=g("lift"),es=g("monster"),st=g("floor"),ts=g("movableBlock"),ss=g("pickup"),os=g("spring"),ot=g("joystick"),is=g("monster","movableBlock"),ze=g("head"),Oe=g("heels"),G=g("headOverHeels"),O=(e,t)=>e.characterRooms[t]?.items[t],as=e=>O(e,e.currentCharacterName),ns=e=>{if(ze(e))return e.state;if(G(e))return e.state.head},it=e=>{if(Oe(e))return e.state;if(G(e))return e.state.heels},at=(e,t)=>{const s=O(e,e.currentCharacterName==="headOverHeels"?"headOverHeels":t);if(s!==void 0){if(t==="head"&&ze(s)||t==="heels"&&Oe(s))return s.state;if(t==="head"&&G(s))return s.state.head;if(t==="heels"&&G(s))return s.state.heels}},rs=at,x={x:12,y:12,z:l.h},nt={x:14,y:14,z:l.h},N={x:16,y:16,z:l.h},W={...x,z:l.h*2},Ne=e=>{switch(e.type){case"spring":case"portableBlock":case"moveableDeadly":case"slidingDeadly":case"firedDoughnut":return{aabb:x};case"slidingBlock":return e.config.style==="book"?{aabb:N}:{aabb:x};case"lift":return{aabb:{...x,z:x.z}};case"switch":return{aabb:{...x,z:x.z}};case"pickup":return e.config.gives==="scroll"?{aabb:{x:16,y:4,z:13}}:{aabb:x};case"charles":return{aabb:W};case"ball":return{aabb:{x:12,y:12,z:12}};case"movableBlock":return{aabb:N};case"block":switch(e.config.style){case"artificial":case"organic":case"book":return{aabb:N};case"tower":return{aabb:{x:11,y:11,z:l.h}};default:throw new Error("unknown block style")}case"monster":switch(e.config.which){case"skiHead":return{aabb:{...x,z:21}};case"bubbleRobot":case"cyberman":case"elephant":case"emperorsGuardian":case"monkey":case"computerBot":return{aabb:W};case"helicopterBug":case"dalek":return{aabb:x};default:return{aabb:N}}case"deadlyBlock":switch(e.config.style){case"toaster":return{aabb:{...N,y:N.y}};case"spikes":case"volcano":return{aabb:N}}break;case"bubbles":return{aabb:x};case"conveyor":case"hushPuppy":case"teleporter":return{aabb:N};case"barrier":return{aabb:e.config.axis==="y"?{x:3,y:15,z:l.h}:{x:15,y:3,z:l.h}};case"sceneryPlayer":return e.config.which==="headOverHeels"?{aabb:W}:{aabb:x};default:return{aabb:nt}}},K=(e,t)=>{const s={x:1,y:1,z:1,...t},o=A(le,e);return A(Ie(s,le),o)},v={renders:!0,aabb:x},rt=({config:{direction:e},position:t})=>e==="right"&&t.x===0||e==="towards"&&t.y===0,b=ge/1e3,ls={head:15e-5,heels:15e-5},lt=2e-4,ct={head:l.h*2/1e3,others:l.h*6/1e3},cs=lt*.35,ds=ct.others*.5,us=.8,ps=.001,hs={head:b,heels:2*b,charles:b,dalek:Math.SQRT2*b,cyberman:1*b,skiHead:b,helicopterBug:b,homingBot:2*b,monkey:b,elephant:b,elephantHead:0,emperor:b,emperorsGuardian:Math.SQRT2*b,bubbleRobot:b,computerBot:b,turtle:b,ball:2*b,firedDoughnut:2*b,movableBlock:b},dt=(e=1)=>e*ge/1e3,fs=dt(),ys=2,gs={head:l.h*2.6,heels:l.h},Z=11,bs=6e4,vs=9999,ce=8,ws=750,ks=2500,xs=200,ut=8,ms=(e,t)=>{const s=E(e);return t.x=s.x,t.y=s.y,t},pt=({x:e=0,y:t=0,z:s=0})=>({x:t-e,y:-(e+t)/2-s}),y=({x:e=0,y:t=0,z:s=0})=>({x:e*l.w,y:t*l.d,z:s*l.h}),E=e=>pt(y(e)),U=l.h*2,ht=4,$=l.h*4;function*ft(e,t){const{config:{direction:s},position:o}=e,i=ee(s),a=be(i),n=rt(e),r={...w,[a]:n?-.5:0},u=1,h={[a]:n?-1:0},p={[a]:u*l.w},k=9,d=8,f=8;yield{...e,...v,type:"doorFrame",id:`${t}/far`,config:{...e.config,inHiddenWall:n,part:"far"},state:{position:y(c(o,{[i]:1.5},r,h)),expires:null,stoodOnBy:M,disappear:null},aabb:c({[i]:d,[a]:f,z:$},p)},yield{...e,...v,type:"doorFrame",id:`${t}/near`,config:{...e.config,inHiddenWall:n,part:"near"},state:{position:y(c(o,r,h)),expires:null,stoodOnBy:M,disappear:null},aabb:c({[i]:k,[a]:f,z:$},p)},yield{...e,...v,type:"doorFrame",id:`${t}/top`,config:{...e.config,inHiddenWall:n,part:"top"},state:{position:c(y(c(o,r,h)),{[i]:k,z:U}),expires:null,stoodOnBy:M,disappear:null},aabb:c({[i]:2*l.w-k-d,[a]:f,z:$-U},p)},yield{...e,...v,id:`${t}/wall`,config:{style:"none",direction:"away",tiles:[]},renders:!1,type:"wall",state:{position:c(y(c(o,r)),{z:$}),expires:null,stoodOnBy:M,disappear:null},aabb:y({[i]:2,[a]:.5,z:Z-ht-o.z})},yield{...e,...v,type:"portal",id:`${t}/portal`,config:{...e.config,inHidden:n,relativePoint:y({...w,[a]:n?.25:-.25}),direction:z[s]},renders:!1,state:{position:c(y(c(o,{[a]:n?-.5:.5})),{[i]:k}),expires:null,stoodOnBy:M,disappear:null},aabb:{[i]:2*l.w-k-d,[a]:0,z:U}},o.z!==0&&(yield{...e,...v,type:"doorLegs",id:`${t}/legs`,config:{...e.config,inHiddenWall:n,style:"none",side:"away",height:o.z},renders:!0,shadowCastTexture:n?"shadow.door.floatingThreshold.double.y":void 0,shadowMask:{spriteOptions:{textureId:n?"shadowMask.door.floatingThreshold.double.y":"shadowMask.door.legs.threshold.double.y",flipX:i==="x"},relativeTo:"top"},state:{position:{...y(c(o,r,h)),z:0},expires:null,stoodOnBy:new Set,disappear:null},aabb:c(y({[i]:2,[a]:.5,z:o.z}),p)}),yield{type:"stopAutowalk",id:`${t}/stopAutowalk`,renders:!1,aabb:y({[i]:2,[a]:0,z:2}),config:{},state:{position:y(A(o,P(z[s],.75))),expires:null,stoodOnBy:M,disappear:null}}}const J=e=>{const t=y(e.position),{aabb:s}=Ne(e);if(s===void 0)throw new Error(`item type= ${e.type} config=${JSON.stringify(e.config)} has no bounding box`);return e.type==="wall"?t:c(t,{x:l.w-s.x>>1,y:l.d-s.y>>1})},F=()=>({expires:null,stoodOnBy:new Set,disappear:null}),S=()=>({standingOn:null,vels:{gravity:w,movingFloor:w},latentMovement:[]}),yt=e=>{const t=Te.includes(e.type);return{...F(),position:J(e),...t?{standingOn:null,vels:{gravity:w,movingFloor:w,...xe.includes(e.type)?{sliding:w}:{},...(e.type==="monster"||e.type==="movableBlock")&&e.config.movement&&e.config.movement!=="free"?{walking:w}:{}},latentMovement:[]}:{},...e.type==="monster"?{activated:e.config.activated,timeOfLastDirectionChange:Number.NEGATIVE_INFINITY,...e.config.which==="skiHead"||e.config.which==="turtle"||e.config.which==="elephantHead"||e.config.which==="cyberman"?{facing:z[e.config.startDirection]}:{facing:z.towards}}:{},...e.type==="pickup"?{collected:!1,disappear:"onTouchByPlayer"}:{},...e.type==="movableBlock"&&e.config.movement!=="free"?{activated:e.config.activated===!0,facing:z[e.config.startDirection]}:{},...e.type==="switch"?{setting:"left",touchedOnProgression:-1}:{},...e.type==="block"?{disappear:e.config.disappearing??null}:{},...e.type==="conveyor"?{disappear:e.config.disappearing??null}:{},...e.type==="barrier"?{disappear:e.config.disappearing??null}:{},...e.type==="lift"?{direction:"up",vels:{lift:w}}:{},...e.type==="charles"?{facing:z.towards}:{}}},L={config:ve,shadowCastTexture:"shadow.smallRound",aabb:x},I=()=>({action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:z.towards,walkStartFacing:z.towards,walkDistance:0,vels:{walking:w,gravity:w,movingFloor:w},actedOnAt:Number.NEGATIVE_INFINITY}),gt=e=>{const{infiniteLivesPoke:t}=te.getState().userSettings;return e.config.which==="head"?{id:"head",type:"head",...v,...L,state:{...F(),...S(),...I(),hasHooter:!1,gameWalkDistance:0,fastStepsStartedAtDistance:Number.NEGATIVE_INFINITY,lives:t?Number.POSITIVE_INFINITY:ce,shieldCollectedAt:Number.NEGATIVE_INFINITY,doughnuts:0,doughnutLastFireTime:Number.NEGATIVE_INFINITY,switchedToAt:Number.NEGATIVE_INFINITY,position:J(e),lastDiedAt:Number.NEGATIVE_INFINITY,gameTime:0}}:{id:"heels",type:"heels",...v,...L,state:{...F(),...S(),...I(),carrying:null,hasBag:!1,bigJumps:0,lives:t?Number.POSITIVE_INFINITY:ce,shieldCollectedAt:Number.NEGATIVE_INFINITY,switchedToAt:Number.NEGATIVE_INFINITY,position:J(e),lastDiedAt:Number.NEGATIVE_INFINITY,gameTime:0}}},Be=50,Pe=1,Me={x:l.w,y:l.d*Pe,z:Z*l.h},bt={x:Me.x,y:0,z:Be},Ae={x:l.w*Pe,y:l.d,z:Z*l.h},vt={x:0,y:Ae.y,z:Be},wt=(e,t)=>{const{config:{direction:s,times:o},position:i}=e,a=ee(s),n=be(a),r=s==="towards"||s==="right",u={...w,[n]:r?-1:0};return{type:"wall",id:t,config:e.config,aabb:K(a==="y"?Ae:Me,o),renders:!r,renderAabb:r?void 0:K(a==="y"?vt:bt,o),state:{position:y(c(i,u)),stoodOnBy:M,expires:null,disappear:null},shadowCastTexture:a==="y"?"shadow.wall.y":{textureId:"shadow.wall.y",flipX:!0}}};function*Fe(e,t,s,o={}){if(!s[e]&&!(t.type==="pickup"&&t.config.gives==="scroll"&&o[t.config.page]))switch(t.type){case"door":return yield*ft(t,e);case"player":{yield gt(t);return}case"wall":{yield wt(t,e);return}default:{const i=Ne(t),a=t.config.times!==void 0?{aabb:K(i.aabb,t.config.times),renderAabb:void 0}:i;yield{...t,...v,...a,shadowMask:kt(t),shadowCastTexture:xt(t),id:e,config:t.config,state:yt(t)}}}}const kt=e=>{switch(e.type){case"lift":return{spriteOptions:"shadowMask.smallBlock",relativeTo:"origin"};case"conveyor":return{spriteOptions:{textureId:"shadowMask.conveyor",flipX:we(e.config.direction)==="x"},relativeTo:"origin"};case"barrier":return{spriteOptions:{textureId:"shadowMask.barrier.y",flipX:e.config.axis==="x"},relativeTo:"origin"};case"spring":return{spriteOptions:"shadowMask.smallRound",relativeTo:"origin"};case"block":return{spriteOptions:e.config.style==="tower"?"shadowMask.tower":"shadowMask.fullBlock",relativeTo:"origin"};case"movableBlock":return{spriteOptions:e.config.style==="stepStool"?"shadowMask.stepStool":"shadowMask.fullBlock",relativeTo:"origin"};case"teleporter":return{spriteOptions:"shadowMask.teleporter",relativeTo:"origin"};case"hushPuppy":return{spriteOptions:"shadowMask.hushPuppy",relativeTo:"origin"};case"portableBlock":return{spriteOptions:e.config.style==="drum"?"shadowMask.smallRound":"shadowMask.smallBlock",relativeTo:"origin"};case"slidingBlock":return{spriteOptions:e.config.style==="book"?"shadowMask.fullBlock":"shadowMask.smallRound",relativeTo:"origin"};case"deadlyBlock":switch(e.config.style){case"volcano":return{spriteOptions:"shadowMask.volcano",relativeTo:"origin"};case"toaster":return{spriteOptions:"shadowMask.fullBlock",relativeTo:"origin"};case"spikes":return{spriteOptions:"shadowMask.spikes",relativeTo:"origin"};default:e.config.style}break;case"switch":return{spriteOptions:"shadowMask.switch",relativeTo:"origin"};case"pickup":return e.config.gives==="scroll"?{spriteOptions:"shadowMask.scroll",relativeTo:"origin"}:void 0;case"slidingDeadly":return{spriteOptions:"shadowMask.smallRound",relativeTo:"origin"};case"monster":switch(e.config.which){case"dalek":return{spriteOptions:"shadowMask.dalek",relativeTo:"origin"};default:return}case"joystick":return{spriteOptions:"shadowMask.joystick",relativeTo:"origin"}}},xt=e=>{switch(e.type){case"lift":return"shadow.smallBlock";case"conveyor":return{textureId:"shadow.fullBlock",flipX:we(e.config.direction)==="x"};case"barrier":return{textureId:"shadow.barrier.y",flipX:e.config.axis==="x"};case"spring":return"shadow.smallRound";case"block":return e.config.style==="tower"?"shadow.smallRound":"shadow.fullBlock";case"movableBlock":case"hushPuppy":case"deadlyBlock":return"shadow.fullBlock";case"portableBlock":return e.config.style==="drum"?"shadow.smallRound":"shadow.smallBlock";case"pickup":return e.config.gives==="scroll"?"shadow.scroll":"shadow.smallRound";case"monster":return"shadow.smallRound"}},Ce=({aabb:e,state:{position:t}},{aabb:s,state:{position:o}})=>!(t.x+e.x<=o.x||t.x>=o.x+s.x)&&!(t.y+e.y<=o.y||t.y>=o.y+s.y)&&!(t.z+e.z<=o.z||t.z>=o.z+s.z),se=(e,t)=>[...B(t).filter(s=>e.id!==s.id&&Ce(e,s))],mt=e=>{const t={},s=Object.values(e.items).filter(o=>o.type==="door");for(const{config:{direction:o},position:{x:i,y:a}}of s)ee(o)==="x"?a===0?t.towards=!0:a===e.size.y&&(t.away=!0):i===0?t.right=!0:i===e.size.x&&(t.left=!0);return t},Ee=e=>{const t=mt(e),s=t.right?-.5:0,o=e.size.x+(t.left?.5:0),i=t.towards?-.5:0,a=e.size.y+(t.away?.5:0);return{blockXMin:s,blockXMax:o,blockYMin:i,blockYMax:a,sidesWithDoors:t}},Ts=e=>{const{blockXMax:t,blockXMin:s,blockYMax:o,blockYMin:i,sidesWithDoors:a}=Ee(e),n=E({x:e.size.x+(a.right?.5:0),y:-i}).x,r=E({x:-s,y:e.size.y+(a.towards?.5:0)}).x,u=E({x:e.size.x,y:e.size.y}).y,h=E({x:s,y:i}),p=E({x:t,y:o});return{blockXMin:s,blockXMax:t,blockYMin:i,blockYMax:o,edgeLeftX:n,edgeRightX:r,topEdgeY:u,frontSide:h,backSide:p,sidesWithDoors:a}};function*Tt(e){const t=e.size.z??Z,s=y({...e.size,z:1}),{blockXMax:o,blockXMin:i,blockYMax:a,blockYMin:n}=Ee(e),r=y({x:o-i,y:a-n,z:1}),u=y({..._e,z:-1}),h=y({x:i,y:n,z:-1});if(yield{id:"floorEdge",...v,type:"floorEdge",state:{...F(),position:{...h,z:0}},aabb:w,config:{},fixedZIndex:9999},e.floor==="none"&&e.roomBelow!==void 0?(yield{...v,type:"floor",id:"floor",config:{type:"none"},aabb:s,shadowMask:void 0,state:{position:h,expires:null,stoodOnBy:new Set,disappear:null},renders:!0,fixedZIndex:-1},yield{...v,type:"portal",id:"floor/portal",config:{toRoom:e.roomBelow,relativePoint:{x:s.x/2,y:s.y/2,z:s.z},direction:z.down},aabb:s,state:{position:u,expires:null,stoodOnBy:new Set,disappear:null},renders:!1}):yield{...v,type:"floor",id:"floor",config:{type:e.floor==="deadly"?"deadly":"standable"},aabb:r,shadowMask:{relativeTo:"origin"},state:{position:h,expires:null,stoodOnBy:new Set,disappear:null},renders:!0,fixedZIndex:-1},e.roomAbove!==void 0){const p=c(u,{z:l.h*t});yield{...v,type:"portal",id:"ceiling",config:{toRoom:e.roomAbove,relativePoint:{...e.ceilingRelativePoint!==void 0?y(e.ceilingRelativePoint):{x:s.x/2,y:s.y/2},z:-12},direction:z.up},aabb:s,state:{position:p,expires:null,stoodOnBy:new Set,disappear:null},renders:!1}}}function*zt(e,t,s){const{scrollsRead:o}=te.getState(),i=De(e.items);for(const[a,n]of i)n.type==="player"&&!s||(yield*Fe(a,n,t,o))}const de=e=>B(e).reduce((t,s)=>({...t,[s.id]:s}),{}),Ot=(e,t,s=!1)=>{const o={...de(Tt(e)),...de(zt(e,t,s))};for(const a of T(o)){const r=se(a,T(o)).find(u=>Y(a)&&Y(u)&&!(a.type==="wall"&&u.type==="wall"));r!==void 0&&console.error(`in room ${e.id} item ${a.id} @${JSON.stringify(a.state.position)} #${JSON.stringify(a.aabb)} is colliding with (solid item) ${r.id} @${JSON.stringify(r.state.position)} #${JSON.stringify(r.aabb)} on loading room ${e.id}`)}return{...e,roomJson:e,items:{...o},roomTime:0}},Nt=({state:{position:e,facing:t,autoWalk:s,action:o,vels:i}})=>({position:e,facing:t,autoWalk:s,action:o,vels:{...i}}),j=e=>{e.state.standingOn!==null&&e.state.standingOn.state.stoodOnBy.delete(e),e.state.standingOn=null},He=({above:e,below:t})=>{e.state.standingOn=t,t.state.stoodOnBy.add(e)},R=({room:e,item:t})=>{const s=typeof t=="string"?e.items[t]:t;typeof t=="string"?delete e.items[t]:delete e.items[s.id],V(s)&&j(s);for(const o of s.state.stoodOnBy)j(o)};let Bt=0;const Pt=({gameState:e,room:t,itemType:s,config:o,position:i})=>{const a={type:s,config:o,position:w},n=`${s}/${Bt++}`,r=qe(Fe(n,a,e.pickupsCollected[t.id]));if(r===void 0)throw new Error("failed to generate any items");return r.state.position=i,q({room:t,item:r}),r},q=({room:e,item:t})=>(e.items[t.id]=t,t),Mt=1e3/25,Re=e=>{const t=Xe.animations[e],s=t.length,{animationSpeed:o}=t;return s*Mt/o};Re("bubbles.white");const At=Re("head.fadeOut"),Ft=({touchedItem:e,room:t,gameState:s})=>{R({room:t,item:e});const o=Pt({itemType:"bubbles",config:{style:"white"},position:w,room:t,gameState:s}),i=c(e.state.position,P(e.aabb,.5));o.state.position=A(i,P(o.aabb,.5)),o.state.expires=t.roomTime+At},Ct=(e,t)=>{const s=B(T(e.items)).filter(g("hushPuppy"));for(const o of s)Ft({touchedItem:o,gameState:t,room:e})},Et=.5,ue=(e,t,s,o)=>{const i=s.x+o.x-e.x,a=s.y+o.y-e.y,n=s.z+o.z-e.z,r=e.x+t.x-s.x,u=e.y+t.y-s.y,h=e.z+t.z-s.z,p=Math.abs(i)<Math.abs(r)?i:-r,k=Math.abs(a)<Math.abs(u)?a:-u,d=Math.abs(n)<Math.abs(h)?n:-h,f=Math.abs(p),m=Math.abs(k),_=Math.abs(d)*Et;return f<m&&f<_?{x:p,y:0,z:0}:m<_?{x:0,y:k,z:0}:{x:0,y:0,z:d}},pe=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),he={stopAutowalk:0,portal:0,wall:0,doorLegs:0,sceneryPlayer:0,bubbles:0,switch:1,block:2,barrier:2,floor:2,floorEdge:2,hushPuppy:2,teleporter:2,doorFrame:2,lift:3,movableBlock:3,portableBlock:3,slidingBlock:3,spring:3,ball:4,joystick:4,charles:4,conveyor:4,head:5,heels:5,headOverHeels:5,pickup:8,firedDoughnut:9,slidingDeadly:10,moveableDeadly:10,deadlyBlock:10,monster:10},Ht=(e,t)=>he[e.type]-he[t.type],Rt=(e,t)=>t.toSorted((s,o)=>{const i=Ht(s,o);if(i!==0)return i;const a=ie(e,pe(e,s)),n=ie(e,pe(e,o));return Math.abs(a-n)<1e-4?s.id<o.id?-1:1:a-n}),Se=({subjectItem:e,posDelta:t,gameState:s,room:o,pusher:i,deltaMS:a,forceful:n=g("lift")(e)&&i===void 0,recursionDepth:r=0,onTouch:u})=>{if(ke(t,w))return;const{state:{position:h}}=e;e.state.position=c(h,t),V(e)&&(e.state.actedOnAt=o.roomTime);const p=Rt(t,se(e,T(o.items)));let k=!1;for(const d of p){if(!Ce(e,d))continue;const f=ot(d);if(i!==d&&!(k&&f)&&u!==void 0&&(u({movingItem:e,touchedItem:d,movementVector:A(e.state.position,h),gameState:s,deltaMS:a,room:o}),k=k||f),o.items[e.id]===void 0)return;if(o.items[d.id]===void 0||!Y(d,e)||!Y(e))continue;const m=ue(e.state.position,e.aabb,d.state.position,d.aabb);if(Je(d,n)&&d!==i){const _=n||je(d)?-1:-.5,oe=P(m,_);if(e.state.position=c(e.state.position,m,oe),r<ut&&Se({subjectItem:d,posDelta:oe,pusher:e,gameState:s,room:o,deltaMS:a,forceful:n,recursionDepth:r+1,onTouch:u}),o.items[d.id]===void 0)continue;e.state.position=c(e.state.position,ue(e.state.position,e.aabb,d.state.position,d.aabb))}else e.state.position=c(e.state.position,m);V(e)&&m.z>0&&(e.state.standingOn===null||!p.includes(e.state.standingOn))&&(j(e),He({above:e,below:d}))}},St=(e,t,{changeType:s,sourceItem:o})=>{switch(s){case"portal":return B(T(e.items)).find(i=>C(i)&&i.config.toRoom===t.id&&ke(P(o.config.direction,-1),i.config.direction));case"level-select":return B(T(e.items)).find(i=>C(i)&&i.config.toRoom===t.id&&i.config.direction.z===0)??B(T(e.items)).find(i=>C(i)&&i.config.direction.z===0)??B(T(e.items)).find(i=>C(i)&&i.config.direction.z>0)??B(T(e.items)).find(C)}},It=(e,t,s,o)=>{const i=1*l.w;e.state.position=c(e.state.position,P(t,i));for(let a=0;a<i;a++)Se({subjectItem:e,posDelta:P(t,-1),gameState:s,room:o,deltaMS:16,forceful:!0,onTouch:void 0})},zs=e=>{const{playableItem:t,gameState:s,toRoomId:o,changeType:i,sourceItem:a}=e,n=s.characterRooms[t.id];if(n===void 0)throw new Error(`${t.id} is not in a room on the gameState`);if(o===n.id)throw new Error(`Can't move ${t.id} to the same room "${o}""`);let r;switch(i){case"portal":{const{config:{relativePoint:f},state:{position:m}}=a;r=A(t.state.position,c(m,f));break}case"teleport":{const{state:{position:f}}=a;r=A(t.state.position,f);break}case"level-select":r={x:0,y:0,z:0};break;default:throw new Error}const u=t.type==="headOverHeels"?void 0:s.characterRooms[H(t.id)],h=s.campaign.rooms[o];if(h===void 0)throw new Error(`room ${o} does not exist in campaign`);const p=u?.id===o?u:Ot(h,s.pickupsCollected[o]);R({room:n,item:t});const k=it(t);if(k!==void 0&&(k.carrying=null),(t.type==="head"||t.type==="headOverHeels")&&Ct(p,s),R({room:p,item:t}),p.items[t.id]=t,s.characterRooms[t.id]=p,e.changeType==="teleport"){const{config:{toPosition:f}}=e.sourceItem;t.state.position=c(y(f),r)}else{const f=St(p,n,e);if(console.log("putting",t.id,"into",o,"at portal",f,"because",i,"sourceportal",a),f===void 0)if(e.changeType==="level-select")t.state.position=y({x:1,y:1,z:8});else throw new Error(`trying to move ${t.id} from ${n.id} --to-> ${o} but no destination portal found to locate with`);else{t.state.position=c(f.state.position,f.config.relativePoint,r,i==="portal"&&a.config.direction.z>0?{z:l.h}:{});const{config:{direction:m}}=f;m.z===0&&(t.state.autoWalk=!0,t.state.facing=P(m,-1),t.state.action==="idle"&&(t.state.action="moving"),It(t,m,s,p))}}const d=se(t,T(p.items));d.length>0&&console.warn("on entering room",o,"character",t.id,"at",t.state.position,"collides with",d),s.entryState[t.id]=Nt(t),t.id==="headOverHeels"?(delete s.entryState.head,delete s.entryState.heels):(s.entryState[H(t.id)]||(s.entryState[H(t.id)]=s.entryState.headOverHeels),delete s.entryState.headOverHeels),te.dispatch($e(o))},_t=e=>{const t=O(e,"head"),s=O(e,"heels");return t!==void 0&&s!==void 0&&t.state.action==="idle"&&s.state.action==="idle"&&t.state.standingOn===s},fe=(e,...t)=>{const s={};for(const o of t)s[o]=e[o];return s},Dt=e=>{const t={id:"head",type:"head",...v,...L,state:{...F(),...S(),...I(),...e.state.head,facing:e.state.facing,position:c(e.state.position,{z:l.h}),switchedToAt:Number.NEGATIVE_INFINITY,actedOnAt:e.state.actedOnAt}},s={id:"heels",type:"heels",...v,...L,state:{...F(),...S(),...I(),...e.state.heels,facing:e.state.facing,position:c(e.state.position),switchedToAt:Number.NEGATIVE_INFINITY,actedOnAt:e.state.actedOnAt}};return{head:t,heels:s}},Xt=({head:e,heels:t})=>({type:"headOverHeels",id:"headOverHeels",...v,shadowCastTexture:t.shadowCastTexture,config:ve,aabb:W,state:{...F(),...S(),...I(),position:t.state.position,action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:t.state.facing,actedOnAt:Math.max(t.state.actedOnAt,t.state.actedOnAt),head:{...fe(e.state,"hasHooter","doughnuts","doughnutLastFireTime","fastStepsStartedAtDistance","gameWalkDistance","lives","gameTime","shieldCollectedAt","lastDiedAt"),switchedToAt:Number.NEGATIVE_INFINITY},heels:{...fe(t.state,"hasBag","bigJumps","carrying","lives","gameTime","shieldCollectedAt","lastDiedAt"),switchedToAt:Number.NEGATIVE_INFINITY}}}),$t=e=>{const t=e.characterRooms.head,s=O(e,"head"),o=O(e,"heels"),i=Xt({head:s,heels:o});R({room:t,item:"head"}),R({room:t,item:"heels"}),q({room:t,item:i}),e.previousPlayable=e.currentCharacterName,e.currentCharacterName="headOverHeels",e.characterRooms={head:void 0,heels:void 0,headOverHeels:t}},Wt=(e,t)=>{const s=e.characterRooms.headOverHeels,o=O(e,"headOverHeels"),i=t??H(e.previousPlayable),{head:a,heels:n}=Dt(o);R({room:s,item:"headOverHeels"}),q({room:s,item:a}),q({room:s,item:n}),He({above:a,below:n}),e.currentCharacterName=i,e.previousPlayable=void 0,e.characterRooms={head:s,heels:s,headOverHeels:void 0}},Yt=e=>{const t=O(e,e.currentCharacterName);t!==void 0&&(t.type==="headOverHeels"?(t.state.head.switchedToAt=t.state.head.gameTime,t.state.heels.switchedToAt=t.state.heels.gameTime):t.state.switchedToAt=t?.state.gameTime)},Os=(e,t)=>{_t(e)&&(!t||t===e.currentCharacterName)?$t(e):e.currentCharacterName==="headOverHeels"?Wt(e,t):(!t||t!==e.currentCharacterName)&&O(e,H(e.currentCharacterName))!==void 0&&(e.currentCharacterName=H(e.currentCharacterName)),Yt(e)};export{Jt as $,hs as A,us as B,ls as C,ts as D,cs as E,ds as F,At as G,fs as H,ks as I,es as J,ue as K,Ce as L,Ht as M,it as N,ns as O,Zt as P,Mt as Q,He as R,Ft as S,xe as T,qt as U,Se as V,R as W,se as X,q as Y,v as Z,Kt as _,V as a,jt as a0,is as a1,Dt as a2,Xt as a3,Ct as a4,j as a5,Os as a6,pt as a7,Qt as a8,ws as a9,xs as aa,Ts as ab,ms as ac,vs as ad,as as b,zs as c,$t as d,O as e,Pt as f,l as g,Nt as h,g as i,bs as j,rs as k,Ot as l,Ze as m,Y as n,H as o,E as p,lt as q,os as r,Lt as s,ct as t,Ut as u,ss as v,me as w,ys as x,gs as y,ps as z};
