import{j as s,r as l}from"./index-C9y6bIdq.js";import{B as U,g as ke,h as Ee,i as Te,C as Pe,j as Ae,k as Be,l as Me,m as ze,n as ce,S as $e}from"./ShowBoundingBoxSwitches-DGMtUfha.js";import{ap as le,a9 as b,aa as v,B as T,C as Fe,w as H,z as Le,S as Oe,s as De,N as Xe,aq as M,a8 as W,ar as ue,R as Y,as as _e,F as Ue,at as He,au as Ye,$ as de,av as Ze,aw as G,ax as We,U as Ge,ay as Je,az as A,aA as Ve,K as me,aj as J,o as qe,aB as Ke,ao as Qe,aC as et,aD as tt,aE as ot,aF as st,aG as nt}from"./App-CNRy90Yr.js";import{useAppSelectorWithLevelEditorSlice as C,selectTool as P,setTool as pe,selectCurrentEditingRoomColour as rt,changeRoomColour as V,selectCurrentEditingRoomScenery as it,changeRoomScenery as at,selectCurrentEditingRoomJson as q,applyToolAtPosition as ct}from"./levelEditorSlice-DiDGfUNo.js";import{c as lt,A as ut,s as dt,R as mt,i as pt,z as xt,a as ht,p as xe}from"./roomRenderer-D2VDsOPt.js";import"./Graphics-DqL5e8jN.js";import"./changeCharacterRoom-1Xhqvqew.js";const a=({itemTool:e,children:t})=>{const o=C(P),n=le(o?.type==="item"&&o.item,e);return s.jsx(U,{className:`h-3 w-3 overflow-hidden ${n?"bg-pastelBlue":""}`,onClick:()=>b.dispatch(pe({type:"item",item:e})),children:t})},ft=()=>{const t=C(P)?.type==="pointer";return s.jsx(U,{className:`flex-1 w-2 h-2 p-quarter ${t?"bg-pastelBlue":""}`,onClick:()=>b.dispatch(pe({type:"pointer"})),children:s.jsx("span",{className:"sprite texture-hud.char.↖ relative [button:active_&]:top-quarter"})})};var K=!1,y,z,$,N,k,he,E,F,L,O,fe,D,X,ge,ve;function m(){if(!K){K=!0;var e=navigator.userAgent,t=/(?:MSIE.(\d+\.\d+))|(?:(?:Firefox|GranParadiso|Iceweasel).(\d+\.\d+))|(?:Opera(?:.+Version.|.)(\d+\.\d+))|(?:AppleWebKit.(\d+(?:\.\d+)?))|(?:Trident\/\d+\.\d+.*rv:(\d+\.\d+))/.exec(e),o=/(Mac OS X)|(Windows)|(Linux)/.exec(e);if(D=/\b(iPhone|iP[ao]d)/.exec(e),X=/\b(iP[ao]d)/.exec(e),O=/Android/i.exec(e),ge=/FBAN\/\w+;/i.exec(e),ve=/Mobile/i.exec(e),fe=!!/Win64/.exec(e),t){y=t[1]?parseFloat(t[1]):t[5]?parseFloat(t[5]):NaN,y&&document&&document.documentMode&&(y=document.documentMode);var n=/(?:Trident\/(\d+.\d+))/.exec(e);he=n?parseFloat(n[1])+4:y,z=t[2]?parseFloat(t[2]):NaN,$=t[3]?parseFloat(t[3]):NaN,N=t[4]?parseFloat(t[4]):NaN,N?(t=/(?:Chrome\/(\d+\.\d+))/.exec(e),k=t&&t[1]?parseFloat(t[1]):NaN):k=NaN}else y=z=$=k=N=NaN;if(o){if(o[1]){var r=/(?:Mac OS X (\d+(?:[._]\d+)?))/.exec(e);E=r?parseFloat(r[1].replace("_",".")):!0}else E=!1;F=!!o[2],L=!!o[3]}else E=F=L=!1}}var _={ie:function(){return m()||y},ieCompatibilityMode:function(){return m()||he>y},ie64:function(){return _.ie()&&fe},firefox:function(){return m()||z},opera:function(){return m()||$},webkit:function(){return m()||N},safari:function(){return _.webkit()},chrome:function(){return m()||k},windows:function(){return m()||F},osx:function(){return m()||E},linux:function(){return m()||L},iphone:function(){return m()||D},mobile:function(){return m()||D||X||O||ve},nativeApp:function(){return m()||ge},android:function(){return m()||O},ipad:function(){return m()||X}},gt=_,vt=!!(typeof window<"u"&&window.document&&window.document.createElement),yt={canUseDOM:vt},ye=yt,we;ye.canUseDOM&&(we=document.implementation&&document.implementation.hasFeature&&document.implementation.hasFeature("","")!==!0);function wt(e,t){if(!ye.canUseDOM||t&&!("addEventListener"in document))return!1;var o="on"+e,n=o in document;if(!n){var r=document.createElement("div");r.setAttribute(o,"return;"),n=typeof r[o]=="function"}return!n&&we&&e==="wheel"&&(n=document.implementation.hasFeature("Events.wheel","3.0")),n}var bt=wt,Q=10,ee=40,te=800;function be(e){var t=0,o=0,n=0,r=0;return"detail"in e&&(o=e.detail),"wheelDelta"in e&&(o=-e.wheelDelta/120),"wheelDeltaY"in e&&(o=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),"axis"in e&&e.axis===e.HORIZONTAL_AXIS&&(t=o,o=0),n=t*Q,r=o*Q,"deltaY"in e&&(r=e.deltaY),"deltaX"in e&&(n=e.deltaX),(n||r)&&e.deltaMode&&(e.deltaMode==1?(n*=ee,r*=ee):(n*=te,r*=te)),n&&!t&&(t=n<1?-1:1),r&&!o&&(o=r<1?-1:1),{spinX:t,spinY:o,pixelX:n,pixelY:r}}be.getEventType=function(){return gt.firefox()?"DOMMouseScroll":bt("wheel")?"wheel":"mousewheel"};var jt=be;/**
* Checks if an event is supported in the current execution environment.
*
* NOTE: This will not work correctly for non-generic events such as `change`,
* `reset`, `load`, `error`, and `select`.
*
* Borrows from Modernizr.
*
* @param {string} eventNameSuffix Event name, e.g. "click".
* @param {?boolean} capture Check if the capture phase is supported.
* @return {boolean} True if the event is supported.
* @internal
* @license Modernizr 3.0.0pre (Custom Build) | MIT
*/const je=e=>{const{value:t,values:o,onSelect:n,triggerButtonClassName:r="",triggerButtonStyle:i=v,triggerButtonLabel:d="",OptionCommandItem:u}=e,[h,f]=l.useState(!1),p=l.useRef(0);return s.jsxs(ke,{open:h,onOpenChange:f,children:[s.jsx(Ee,{asChild:!0,children:s.jsxs(U,{className:`h-2 px-1 justify-between  ${r}`,style:i,onWheel:x=>{const w=jt(x.nativeEvent);if(p.current+=w.spinY,p.current>=1||p.current<=-1){const R=o.indexOf(t),Ie=(Math.round(R+p.current)+99*o.length)%o.length,Ne=o[Ie];n(Ne),p.current=0}},children:[d,s.jsx(T,{className:"ml-half shrink-0",children:h?"X":"⬇"})]})}),s.jsx(Te,{className:"p-0 z-dialog",children:s.jsx(Fe,{scaleFactor:1,children:s.jsxs(Pe,{className:"w-[--radix-popper-anchor-width]",children:[e.disableCommandInput===!0?null:s.jsx(Ae,{placeholder:e.placeholder}),s.jsxs(Be,{children:[s.jsx(Me,{children:"No room found"}),s.jsx(ze,{children:o.map(x=>s.jsx(u,{value:x,onSelect:w=>{f(!1),n(w)}},x))})]})]})})})]})},St=e=>e,oe=e=>{const{main:t}=lt[e].basic;return{backgroundColor:t.basic.toHex(),borderColor:t.dimmed.toHex()}};function Ct(){const e=H(),t=C(rt);return s.jsxs(s.Fragment,{children:[s.jsx(je,{value:t.hue,onSelect:o=>{e(V({hue:o}))},values:Le,disableCommandInput:!0,OptionCommandItem:({value:o,onSelect:n})=>s.jsx(ce,{value:o,className:"border-1 h-4 w-2",style:oe(o),onSelect:n}),triggerButtonLabel:s.jsx(T,{children:"colour"}),triggerButtonClassName:St(`${t.hue==="white"?"text-pureBlack":"text-white"}`),triggerButtonStyle:oe(t.hue)}),s.jsx(Oe,{value:t.shade==="basic",onClick:(o,n)=>{e(V({shade:n?"basic":"dimmed"}))},falseLabel:"dimmed",trueLabel:"basic"})]})}function Rt(){const e=H(),t=C(it);return s.jsx(je,{value:t,onSelect:o=>{e(at(o))},values:De,disableCommandInput:!0,OptionCommandItem:({value:o,onSelect:n})=>s.jsx(ce,{value:o,onSelect:n,children:s.jsx(T,{children:o})}),triggerButtonClassName:"w-18 text-white",triggerButtonLabel:s.jsx(T,{children:t})})}const c="relative [button:active_&]:top-oneScaledPix",It=()=>s.jsxs("div",{className:"fixed flex top-1 right-1 text-white bg-metallicBlueHalfbrite p-half gap-oneScaledPix w-24 flex-wrap justify-start",children:[s.jsx(Rt,{}),s.jsx(Ct,{}),s.jsx(ft,{}),s.jsx(a,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}},children:s.jsx("span",{className:`sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek" ${c}`})}),s.jsx(a,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}},children:s.jsx("span",{className:`sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right ${c}`})}),s.jsx(a,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"turn-to-player",startDirection:"towards"}},children:s.jsx("span",{className:`sprite texture-elephant.towards [button:hover_&]:texture-elephant.right ${c}`})}),s.jsx(a,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}},children:s.jsx("span",{className:`sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right ${c}`})}),s.jsx(a,{itemTool:{type:"monster",config:{which:"cyberman",activated:"on",movement:"towards-on-shortest-axis-xy4",startDirection:"towards"}},children:s.jsx("span",{className:`sprite texture-cyberman.towards [button:hover_&]:texture-cyberman.right ${c}`})}),s.jsx(a,{itemTool:{type:"block",config:{style:"artificial"}},children:s.jsx("span",{className:`sprite texture-block.artificial ${c}`})}),s.jsx(a,{itemTool:{type:"lift",config:{top:11,bottom:0}},children:s.jsx("span",{className:`sprite texture-lift.static [button:hover_&]:texture-animated-lift ${c}`})}),s.jsx(a,{itemTool:{type:"barrier",config:{axis:"x"}},children:s.jsx("span",{className:`sprite texture-barrier.x ${c}`})}),s.jsx(a,{itemTool:{type:"block",config:{style:"organic"}},children:s.jsx("span",{className:`sprite texture-block.organic ${c}`})}),s.jsx(a,{itemTool:{type:"block",config:{style:"book"}},children:s.jsx("span",{className:`sprite texture-book.x ${c}`})}),s.jsx(a,{itemTool:{type:"pickup",config:{gives:"extra-life"}},children:s.jsx("span",{className:`sprite texture-whiteRabbit ${c}`})}),s.jsx(a,{itemTool:{type:"conveyor",config:{direction:"away"}},children:s.jsx("span",{className:`sprite texture-conveyor.y.1 [button:hover_&]:texture-animated-conveyor.x ${c}`})}),s.jsx(a,{itemTool:{type:"teleporter",config:{toRoom:"(placeholder)",toPosition:Xe}},children:s.jsx("span",{className:`sprite texture-teleporter ${c}`})}),s.jsx(a,{itemTool:{type:"charles",config:v},children:s.jsx("span",{className:`sprite texture-charles.towards [button:hover_&]:texture-charles.right ${c}`})}),s.jsx(a,{itemTool:{type:"joystick",config:{controls:["(placeholder)"]}},children:s.jsx("span",{className:`sprite texture-joystick ${c}`})}),s.jsx(a,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:M}},children:s.jsx("span",{className:`sprite texture-switch.left [button:hover_&]:texture-switch.right ${c}`})}),s.jsx(a,{itemTool:{type:"ball",config:v},children:s.jsx("span",{className:`sprite texture-ball ${c}`})}),s.jsx(a,{itemTool:{type:"portableBlock",config:{style:"cube"}},children:s.jsx("span",{className:`sprite texture-cube ${c}`})}),s.jsx(a,{itemTool:{type:"pushableBlock",config:{style:"stepStool"}},children:s.jsx("span",{className:`sprite texture-stepStool ${c}`})}),s.jsx(a,{itemTool:{type:"movingPlatform",config:{style:"sandwich",movement:"clockwise",activated:"on",startDirection:"towards"}},children:s.jsx("span",{className:`sprite texture-sandwich ${c}`})}),s.jsx(a,{itemTool:{type:"spikes",config:v},children:s.jsx("span",{className:`sprite texture-spikes ${c}`})}),s.jsx(a,{itemTool:{type:"deadlyBlock",config:{style:"volcano"}},children:s.jsx("span",{className:`sprite texture-volcano.1 [button:hover_&]:texture-animated-volcano ${c}`})}),s.jsx(a,{itemTool:{type:"slidingDeadly",config:{style:"spikyBall",startingPhase:1}},children:s.jsx("span",{className:`sprite texture-spikyBall.1 [button:hover_&]:texture-spikyBall.2 ${c}`})}),s.jsx(a,{itemTool:{type:"door",config:{direction:"away",toRoom:"(placeholder)"}},children:s.jsx("span",{className:`sprite texture-door.frame.generic.x.whole ${c}`})}),s.jsx("div",{className:"flex flex-row gap-1",children:s.jsx($e,{})})]}),Se=l.createContext(null),Nt=()=>{const[e,t]=l.useState(()=>W({roomJson:q(b.getState()),roomPickupsCollected:v,scrollsRead:v,isNewGame:!0})),o=C(q);return l.useEffect(()=>{const n=W({roomJson:o,roomPickupsCollected:v,scrollsRead:v,isNewGame:!0});t(n)},[o]),e},kt=({children:e})=>{const t=Nt();return s.jsx(Se,{value:t,children:e})},Z=()=>{const e=l.useContext(Se);if(e===null)throw new Error("no room state in context, or no context");return e},Ce=l.createContext(null),Et=({children:e})=>{const[t,o]=l.useState(null);return l.useEffect(()=>{const n=new ut;return n.init({background:dt.pureBlack,sharedTicker:!0}).then(()=>{o(n)}),()=>{}},[]),t===null?null:s.jsx(Ce,{value:t,children:e})},j=()=>l.useContext(Ce),Tt=e=>({displaySettings:{emulatedResolution:"amigaLowResPal"},soundSettings:{mute:!0},pixiRenderer:e,gameState:void 0,paused:!1,colourised:!0,upscale:ue(b.getState())}),se=(e,t)=>new mt({room:e,general:Tt(t)}),Pt=()=>{const{renderer:e}=j();if(!e)throw new Error("this should never be falsey (typescript violation)");const t=Z(),[o,n]=l.useState(()=>se(t,e));return l.useEffect(()=>{const r=se(t,e);return n(r),()=>{r.destroy()}},[t,e]),o},I="cursor",ne=({room:e,pointingAt:t,valid:o,includeCursor:n,previewItems:r})=>{const{face:i,position:d}=t;for(const u of r)_e({room:e,item:u});if(n){const u=Ue(I,e.items);u?(u.state.position=d,u.state.face=i,u.state.valid=o):e.items[I]={type:"cursor",id:I,state:{...Ye(),face:i,position:d,valid:o},config:{},aabb:He}}else delete e.items[I]},B=e=>{for(const t of Y(e.items))t.isCursorPreview&&delete e.items[t.id]};let At=0;const Re=(e,t)=>{if(t.type==="door"||e.face==="top")return G(e.position);const o=We[e.face];return Ge(G(e.position),o)},re=(e,t,o)=>{const n=[...Y(t.items).filter(i=>de(i)&&i.type!=="cursor"&&!i.isCursorPreview)],r=(i,d)=>{const u=Re(e,o),h=Je(`cursor/${At++}`,{type:i,config:d,position:u},t.roomJson).toArray();return h.forEach(f=>{f.isCursorPreview=!0}),h};if(o.type==="door"){const i=t.items[e.itemId];if(i.type!=="wall")return;const d=i.config.direction;return r("door",{...o.config,direction:d})}else{const i=r(o.type,o.config);return i.some(u=>{const h=Ze(u,n);return!pt(h)})?void 0:i}},g=me.w/2,S=me.h,ie=g/2,Bt=S/2,Mt=({x:e,y:t})=>o=>{const{bottomCentre:n,topLeft:r,topRight:i}=xe(o.state.position,o.aabb);return!(e<r.x||e>i.x||t<i.y-(i.x-e)/2||t<r.y-(e-r.x)/2||t>n.y-(e-n.x)/2||t>n.y-(n.x-e)/2)},zt=(e,{x:t,y:o})=>{const{bottomCentre:n,topLeft:r,topRight:i}=xe(e.state.position,e.aabb);return o<r.y-(r.x-t)/2?o<i.y-(t-i.x)/2?"top":"right":t<n.x?"towards":"right"},ae=e=>e.fixedZIndex!==void 0,$t=e=>{if(e.every(ae))return e.toSorted((i,d)=>d.fixedZIndex-i.fixedZIndex).at(0);const t=e.filter(i=>!ae(i));if(t.length===0)return;if(t.length===1)return t[0];const o=Object.fromEntries(t.map(i=>[i.id,i])),n=xt(o),{order:r}=ht(n,o);return o[r[0]]},Ft=({state:{position:e},aabb:t},o,n)=>{const r=o==="top"?"xy":o==="towards"?"xz":"yz",i=Ve(n,e,t,r);return{x:r==="yz"?Math.round(i.x/g)*g:Math.floor((i.x-ie)/g)*g,y:r==="xz"?Math.round(i.y/g)*g:Math.floor((i.y-ie)/g)*g,z:r==="xy"?Math.round(i.z/S)*S:Math.floor((i.z+Bt)/S)*S}},Lt=e=>t=>{const o=de(t)&&t.type!=="cursor"&&!t.isCursorPreview;return e.type==="item"&&e.item.type==="door"?o&&t.type==="wall":o},Ot=(e,t,o)=>{const n=$t(Array.from(Y(t.items).filter(Lt(o)).filter(Mt(e))));if(n){const r=zt(n,e);return{itemId:n.id,face:r,position:Ft(n,r,e)}}else return},Dt=(e,t)=>{const o=e.cssUpscale*e.gameEngineUpscale;return{x:t.x/o-e.gameEngineScreenSize.x/2,y:t.y/o-e.gameEngineScreenSize.y+16}},Xt=e=>{const t=j(),o=A(ue),n=H(),r=Z(),i=l.useRef(void 0);l.useEffect(()=>{if(t.stage.eventMode="none",e===null)return;const d=h=>{const f=Dt(o,h),p=P(b.getState()),x=Ot(f,r,p);if(!le(x,i.current))if(i.current=x,x!==void 0)switch(p.type){case"item":{const w=re(x,r,p.item),R=w!==void 0;B(r),ne({room:r,pointingAt:x,valid:R,includeCursor:!R,previewItems:w??M});break}case"pointer":{B(r),ne({room:r,pointingAt:x,valid:!0,includeCursor:!0,previewItems:M});break}}else B(r)},u=h=>{const f=P(b.getState());switch(f.type){case"item":{const p=i.current;if(p===void 0||re(p,r,f.item)===void 0)return;n(ct({blockPosition:Re(p,f.item)}));break}}};return e.addEventListener("mousemove",d),e.addEventListener("click",u),()=>{e.removeEventListener("mousemove",d),e.removeEventListener("click",u)}},[t.stage,o,e,n,r])},_t=e=>{const t=Z();l.useEffect(()=>{let o=0;const n=({deltaMS:r})=>{if(e.destroyed)return;e.renderContext.room!==t&&console.warn("room renderer does not have the current room");const i=new Set(qe(t.items));e.tick({deltaMS:r,movedItems:i,progression:o++})};return J.shared.add(n),()=>{J.shared.remove(n)}},[e,t])},Ut=e=>{const t=j();l.useEffect(()=>{if(e)return e.appendChild(t.canvas),()=>{e.removeChild(t.canvas)}},[e,t])},Ht=()=>{const e=j(),t=A(o=>o.upscale.upscale.gameEngineUpscale);e.stage.scale=t},Yt=()=>{const e=j(),t=A(Ke);l.useEffect(()=>{e.renderer?.resize(t.x,t.y)},[e.renderer,t])},Zt=e=>{const t=j(),[o]=l.useState(()=>new Qe),n=A(et);l.useEffect(()=>{if(e.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return o.addChild(e.output.graphics),t.stage.addChild(o),()=>{t.stage.removeChild(o),o.removeChild(e.output.graphics)}},[e,t,o]),l.useEffect(()=>{o.x=n.x/2,o.y=n.y-16},[o,n])};ot.defaultOptions.scaleMode="nearest";const Wt=()=>{const e=Pt(),[t,o]=l.useState(null);Yt(),Zt(e),_t(e),Xt(t),Ut(t),Ht();const n=tt();return s.jsx("div",{style:n,ref:o})},to=()=>(st(),nt(),s.jsxs("div",{children:[s.jsx("title",{children:"Hoh Editor"}),s.jsx(Et,{children:s.jsx(kt,{children:s.jsx(Wt,{})})}),s.jsx(It,{})]}));export{to as default};
