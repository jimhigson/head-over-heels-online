import{aa as vt,ab as Zt,V as Kt,ac as Qt,d as en,v as tn,ad as nn,ae as on,af as xt,ag as wt,ah as rn,ai as _e,aj as We,ak as $e,a0 as O,al as H,b as bt,am as sn,C as x,an as pe,ao as z,ap as Ce,aq as U,N as je,ar as y,as as an,at as Ie,au as u,av as Z,aw as g,ax as Fe,ay as B,az as cn,aA as Ct,aB as ce,aC as N,aD as ln,aE as dn,aF as K,aG as _,aH as I,aI as un,aJ as ye,aK as hn,aL as re,aM as He,aN as ge,aO as fn,aP as pn,aQ as Ye,aR as mn,aS as Q,aT as ke,aU as De,aV as kt,aW as Ee,aX as ve,aY as yn,aZ as Xe,a_ as ie,a$ as Tt,b0 as ae,b1 as gn,b2 as Ge,b3 as Pt,b4 as V,b5 as Ot,b6 as G,b7 as xe,b8 as vn,b9 as xn,ba as q,bb as wn,bc as St,bd as bn,be as Mt,bf as Cn,bg as kn,bh as Tn,bi as Pn,bj as W,bk as ue,bl as ee,bm as On,bn as v,bo as he,bp as Sn,bq as Mn,br as Te,bs as qe,bt as An,bu as zn,bv as Je,bw as _n,bx as $n,by as In,bz as Fn,bA as Dn}from"./index-BOSt3YM_.js";import{F as At}from"./Filter-DnHr9YbM.js";import{G as J}from"./Graphics-CMAjM0i7.js";import"./State-3sV0XrC-.js";var Re={},Ne={},zt=vt,Bn=zt.iterableCurry,En=zt.callReturn;function _t(e,t){var n=e[Symbol.iterator](),o=n.next(),r=o.value,s=o.done;return s?t:(En(n),r)}Ne.__firstOr=_t;var Xn=Bn(_t,{reduces:!0});Ne.firstOr=Xn;var Rn=vt,Nn=Rn.iterableCurry,Vn=Ne,Ln=Vn.__firstOr;function $t(e){return Ln(e,void 0)}Re.__first=$t;var Un=Nn($t,{reduces:!0});Re.first=Un;var Wn=Re.first;const jn=Zt(Wn);class Hn extends Kt{constructor(t,n){const{text:o,resolution:r,style:s,anchor:i,width:a,height:l,roundPixels:c,...d}=t;super({...d}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=n,this.text=o??"",this.style=s,this.resolution=r??null,this.allowChildren=!1,this._anchor=new Qt({_onUpdate:()=>{this.onViewUpdate()}}),i&&(this.anchor=i),this.roundPixels=c??!1,a!==void 0&&(this.width=a),l!==void 0&&(this.height=l)}get anchor(){return this._anchor}set anchor(t){typeof t=="number"?this._anchor.set(t):this._anchor.copyFrom(t)}set text(t){t=t.toString(),this._text!==t&&(this._text=t,this.onViewUpdate())}get text(){return this._text}set resolution(t){this._autoResolution=t===null,this._resolution=t,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(t){t=t||{},this._style?.off("update",this.onViewUpdate,this),t instanceof this._styleClass?this._style=t:this._style=new this._styleClass(t),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get bounds(){return this._boundsDirty&&(this._updateBounds(),this._boundsDirty=!1),this._bounds}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(t){this._setWidth(t,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(t){this._setHeight(t,this.bounds.height)}getSize(t){return t||(t={}),t.width=Math.abs(this.scale.x)*this.bounds.width,t.height=Math.abs(this.scale.y)*this.bounds.height,t}setSize(t,n){typeof t=="object"?(n=t.height??t.width,t=t.width):n??(n=t),t!==void 0&&this._setWidth(t,this.bounds.width),n!==void 0&&this._setHeight(n,this.bounds.height)}addBounds(t){const n=this.bounds;t.addFrame(n.minX,n.minY,n.maxX,n.maxY)}containsPoint(t){const n=this.bounds.width,o=this.bounds.height,r=-n*this.anchor.x;let s=0;return t.x>=r&&t.x<=r+n&&(s=-o*this.anchor.y,t.y>=s&&t.y<=s+o)}onViewUpdate(){if(this._didViewChangeTick++,this._boundsDirty=!0,this.didViewUpdate)return;this.didViewUpdate=!0,this._didTextUpdate=!0;const t=this.renderGroup||this.parentRenderGroup;t&&t.onChildViewUpdate(this)}_getKey(){return`${this.text}:${this._style.styleKey}:${this._resolution}`}destroy(t=!1){super.destroy(t),this.owner=null,this._bounds=null,this._anchor=null,(typeof t=="boolean"?t:t?.style)&&this._style.destroy(t),this._style=null,this._text=null}}function Yn(e,t){let n=e[0]??{};return(typeof n=="string"||e[1])&&(en(tn,`use new ${t}({ text: "hi!", style }) instead`),n={text:n,style:e[1]}),n}class Gn extends Hn{constructor(...t){const n=Yn(t,"Text");super(n,nn),this.renderPipeId="text"}_updateBounds(){const t=this._bounds,n=this._anchor,o=on.measureText(this._text,this._style),{width:r,height:s}=o;t.minX=-n._x*r,t.maxX=t.minX+r,t.minY=-n._y*s,t.maxY=t.minY+s}}const qn=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Å","Ä","Ö","0","1","2","3","4","5","6","7","8","9","!","@","#","$","%","^","&","*","(",")","-","_","=","+","[","]","{","}",";",":","'",'"',",",".","/","<",">","?","\\","|"," ","Enter","Shift","Control","`","~","Tab","Backspace","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Numpad0","Numpad1","Numpad2","Numpad3","Numpad4","Numpad5","Numpad6","Numpad7","Numpad8","Numpad9","NumpadAdd","NumpadSubtract","NumpadMultiply","NumpadDivide","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"],Ze=e=>qn.includes(e),It=[...wt,"jump","fire","carry","swop","pause"],Jn=()=>({...xt(It.map(e=>[e,!1])),windowFocus:!0}),L={right:["P"],towards:["A"],left:["O"],away:["Q"],jump:[" ","M"],carry:["C","M"],fire:["N"],swop:["Enter","S"],pause:["H"]},Zn={right:["ArrowRight",...L.right],towards:["ArrowDown",...L.towards],left:["ArrowLeft",...L.left],away:["ArrowUp",...L.away],jump:["`",...L.jump],carry:["Shift","`",...L.carry],fire:["Control",...L.fire],swop:L.swop,pause:["F8",...L.pause]};function*Ke(e,t){for(const[n,o]of rn(e))o.includes(t)&&(yield n)}const Qe=e=>e.length===1?e.toUpperCase():e,Kn=({keyAssignment:e,inputState:t,onInputStateChange:n})=>{const o=({key:a})=>{const l=Qe(a);if(!Ze(l)){console.log("do not recognise key: ",l);return}for(const c of Ke(e,l))t[c]=!0;n?.(t)},r=({key:a})=>{const l=Qe(a);if(Ze(l)){for(const c of Ke(e,l))t[c]=!1;n?.(t)}},s=()=>{t.windowFocus=!0,n?.(t)},i=()=>{t.windowFocus=!1;for(const a of It)t[a]=!1;n?.(t)};return window.addEventListener("keydown",o,!1),window.addEventListener("keyup",r,!1),window.addEventListener("focus",s,!1),window.addEventListener("blur",i,!1),()=>{window.removeEventListener("keydown",o,!1),window.removeEventListener("keyup",r,!1),window.removeEventListener("focus",s,!1),window.removeEventListener("blur",i,!1)}};function Qn(e){return{all:e=e||new Map,on:function(t,n){var o=e.get(t);o?o.push(n):e.set(t,[n])},off:function(t,n){var o=e.get(t);o&&(n?o.splice(o.indexOf(n)>>>0,1):e.set(t,[]))},emit:function(t,n){var o=e.get(t);o&&o.slice().map(function(r){r(n)}),(o=e.get("*"))&&o.slice().map(function(r){r(t,n)})}}}const eo=e=>{const t={};for(const n of Object.values(e.rooms))for(const o of Object.values(n.items))if(o.type==="player"){const{which:r}=o.config;t[r]=n.id}if(t.head===void 0&&t.heels===void 0)throw new Error("couldn't find either head or heels in campaign");return t},to=(e,t)=>{const n=eo(e),o=xt(Object.keys(e.rooms).map(i=>[i,{}])),r=n.head&&_e(e.rooms[n.head],o[n.head]),s=n.heels===n.head?r:n.heels&&_e(e.rooms[n.heels],o[n.heels]);return{keyAssignment:Zn,currentCharacterName:n.head===void 0?"heels":"head",characterRooms:{head:r===void 0?void 0:{room:r,entryState:We(r.items.head)},heels:s===void 0?void 0:{room:s,entryState:We(s.items.heels)}},inputState:Jn(),renderOptions:t,campaign:e,events:Qn(),pickupsCollected:o,gameTime:0,progression:0}},no=e=>{let t=1;return{get curUpscale(){return t},rescale(){if(e.renderer.width===0||e.renderer.height===0)throw new Error;const n=Math.floor(Math.min(e.renderer.width/$e.width,e.renderer.height/$e.height)),o={x:Math.round(e.renderer.width/n),y:Math.round(e.renderer.height/n)};return t===n||(t=n,console.log("scale factor changed to:",n),e.stage.scale=n),o}}},F={original:new O("rgb(255, 255, 255)"),basic:new O("rgb(210, 210, 210)"),dimmed:new O("rgb(120, 120, 120)")},D={original:new O("rgb(255, 255, 0)"),basic:new O("hsl(50,58%,70%)"),dimmed:H().redShadow},E={original:new O("rgb(255, 0, 255)"),basic:H().pink,dimmed:new O("hsl(290,25%,40%)")},C={original:new O("rgb(0, 255, 255)"),basic:new O("hsl(183, 28%, 50%)"),dimmed:new O("hsl(183, 28%,39%)")},X={original:new O("rgb(0, 255, 0)"),basic:H().moss,dimmed:new O("hsl(73,35%,35%)")},Ve={white:{basic:{main:F,edges:{towards:C,right:D},hud:{lives:D,dimmed:E,icons:C}},dimmed:{main:F,edges:{towards:X,right:C},hud:{lives:D,dimmed:E,icons:C}}},yellow:{basic:{main:D,edges:{towards:X,right:F},hud:{lives:C,dimmed:E,icons:X}},dimmed:{main:D,edges:{towards:C,right:C},hud:{lives:C,dimmed:E,icons:X}}},magenta:{basic:{main:E,edges:{towards:X,right:C},hud:{lives:F,dimmed:C,icons:D}},dimmed:{main:E,edges:{towards:X,right:C},hud:{lives:F,dimmed:C,icons:D}}},cyan:{basic:{main:C,edges:{towards:E,right:F},hud:{lives:F,dimmed:X,icons:D}},dimmed:{main:C,edges:{towards:E,right:F},hud:{lives:F,dimmed:X,icons:D}}},green:{basic:{main:X,edges:{towards:C,right:D},hud:{lives:F,dimmed:E,icons:C}},dimmed:{main:X,edges:{towards:C,right:D},hud:{lives:F,dimmed:E,icons:C}}}},Ft=e=>Ve[e.hue][e.shade],Dt=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,oo=`in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uOriginalColor;
uniform vec3 uTargetColor;
uniform float uTolerance;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);
    vec3 colorDiff = uOriginalColor - (c.rgb / max(c.a, 0.0000000001));
    float colorDistance = length(colorDiff);
    float doReplace = step(colorDistance, uTolerance);
    finalColor = vec4(mix(c.rgb, uTargetColor * c.a, doReplace), c.a);
}
`;class me extends At{static DEFAULT_OPTIONS={originalColor:16711680,targetColor:0,tolerance:.4};uniforms;_originalColor;_targetColor;constructor(t){t={...me.DEFAULT_OPTIONS,...t};const n=bt.from({vertex:Dt,fragment:oo,name:"palette-swap-filter"});super({glProgram:n,resources:{colorReplaceUniforms:{uOriginalColor:{value:new Float32Array(3),type:"vec3<f32>"},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"},uTolerance:{value:t.tolerance,type:"f32"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this._originalColor=new O,this._targetColor=new O,this.originalColor=t.originalColor??16711680,this.targetColor=t.targetColor??0,Object.assign(this,t)}get originalColor(){return this._originalColor.value}set originalColor(t){this._originalColor.setValue(t);const[n,o,r]=this._originalColor.toArray();this.uniforms.uOriginalColor[0]=n,this.uniforms.uOriginalColor[1]=o,this.uniforms.uOriginalColor[2]=r}get targetColor(){return this._targetColor.value}set targetColor(t){this._targetColor.setValue(t);const[n,o,r]=this._targetColor.toArray();this.uniforms.uTargetColor[0]=n,this.uniforms.uTargetColor[1]=o,this.uniforms.uTargetColor[2]=r}get tolerance(){return this.uniforms.uTolerance}set tolerance(t){this.uniforms.uTolerance=t}}const Bt=e=>[new me({originalColor:H().replaceLight,targetColor:e.basic,tolerance:.1}),new me({originalColor:H().replaceDark,targetColor:e.dimmed,tolerance:.1})],Be=(e,t)=>Bt(Ve[e.color.hue][e.color.shade].edges[t]),ro=e=>Bt(Ve[e.color.hue][e.color.shade].main),oe=sn,so=`precision mediump float;
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uSourceBlacks[2];
uniform vec3 uTargetColor;

// colours are floats so check if they're very close rather than exactly equal:
bool colorsEffectivelyEqual(vec3 color1, vec3 color2) {    
    
    return distance(color1, color2) < 0.05;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a == 0.0 ) {
        finalColor = c;
        return;
    }

    if ( colorsEffectivelyEqual(c.rgb, uSourceBlacks[0]) || colorsEffectivelyEqual(c.rgb, uSourceBlacks[1])) {
        finalColor = vec4(0,0,0, 1.0);
    } else {
        finalColor = vec4(uTargetColor, 1);    
    }
}
`,et=[H().pureBlack,H().lightBlack];class se extends At{uniforms;constructor(t="white"){const n=bt.from({vertex:Dt,fragment:so,name:"revert-colourise-filter"});super({glProgram:n,resources:{colorReplaceUniforms:{uSourceBlacks:{value:new Float32Array(6),type:"vec3<f32>",size:6},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms;const[o,r,s]=et[0].toArray();this.uniforms.uSourceBlacks[0]=o,this.uniforms.uSourceBlacks[1]=r,this.uniforms.uSourceBlacks[2]=s;const[i,a,l]=et[1].toArray();this.uniforms.uSourceBlacks[3]=i,this.uniforms.uSourceBlacks[4]=a,this.uniforms.uSourceBlacks[5]=l,this.targetColor=t}set targetColor(t){const[n,o,r]=new O(t).toArray();this.uniforms.uTargetColor[0]=n,this.uniforms.uTargetColor[1]=o,this.uniforms.uTargetColor[2]=r}}const io=8,ao=24,co=56,lo=80,tt=112,te=e=>e==="heels"?1:-1,uo=e=>{const t=new se,n=new se,o=new se,r=(l=!1)=>{const c=l?2:1,d=new Gn({style:{fill:"white",fontFamily:"Head over Heels",fontSize:io,align:"center"},resolution:8,anchor:{x:.5,y:1}});return d.scale={x:1,y:c},d},s=l=>{const c=new je(y.textures[`${l}.walking.${l==="head"?"right":"towards"}.2`]);return c.anchor={x:.5,y:0},c},i=(l,c=!1,d=!1)=>{const h=new x;h.pivot={x:4,y:16};const p=new je({texture:y.textures[l],anchor:c?{x:.5,y:0}:{x:.5,y:1},filters:t,y:c?0:8});h.addChild(p);const f=r();return f.text="0",f.y=c?0:16,f.filters=n,f.x=p.x=an.w/2,h.addChild(f),d&&(f.visible=!1),{text:f,icon:p,container:h}},a={head:{sprite:s("head"),livesText:r(!0),shield:i("hud.shield"),extraSkill:i("hud.fastSteps"),donuts:i("donuts",!0),hooter:i("hooter",!0,!0)},heels:{sprite:s("heels"),livesText:r(!0),shield:i("hud.shield"),extraSkill:i("hud.bigJumps"),bag:i("bag",!0,!0),carrying:{container:new x}}};for(const l of pe)e.addChild(a[l].livesText),e.addChild(a[l].sprite),e.addChild(a[l].shield.container),e.addChild(a[l].extraSkill.container);return e.addChild(a.head.donuts.container),e.addChild(a.head.hooter.container),e.addChild(a.heels.bag.container),e.addChild(a.heels.carrying.container),(l,c)=>{const d=z(l),{hud:{dimmed:h,lives:p,icons:f}}=Ft(d.color),M=m=>{const{type:T,state:{shieldCollectedAt:P}}=m,{text:be,container:Le}=a[T].shield,{text:qt,container:Ue}=a[T].extraSkill;Ue.x=Le.x=(c.x>>1)+te(T)*lo;const Jt=P===null||l.gameTime>P+Ie?0:100-Math.ceil((l.gameTime-P)/(Ie/100));be.text=`${Jt}`,Le.y=c.y,qt.text=m.type==="head"?m.state.fastSteps:m.state.bigJumps,Ue.y=c.y-24},w=({type:m})=>{const T=l.currentCharacterName===m,P=a[m].sprite;P.filters=T?oe:o,P.x=(c.x>>1)+te(m)*co,P.y=c.y-U.h},A=({type:m,state:{lives:T}})=>{const P=a[m].livesText;P.x=(c.x>>1)+te(m)*ao,P.y=c.y,P.style.fill=p.basic,P.text=`${T??0}`},j=m=>{const{container:T}=a.heels.carrying,P=T.children.length>0;if(m===null&&P)for(const be of T.children)be.destroy();m!==null&&!P&&T.addChild(u(m.type==="spring"?"spring.released":m.config.style))};o.targetColor=h.dimmed,n.targetColor=h.basic,t.targetColor=f.basic;for(const m of pe){const T=Ce(l,m);T!==void 0&&(A(T),w(T),M(T))}a.head.hooter.container.x=a.head.donuts.container.x=(c.x>>1)+te("head")*tt,a.head.donuts.container.y=c.y-U.h-8,a.heels.carrying.container.y=c.y-U.h,a.heels.carrying.container.x=a.heels.bag.container.x=(c.x>>1)+te("heels")*tt,a.heels.bag.container.y=a.head.hooter.container.y=c.y-8;const{state:{hasHooter:b,donuts:S}}=Ce(l,"head");a.head.hooter.icon.filters=b?oe:o,a.head.donuts.icon.filters=S!==0?oe:o,a.head.donuts.text.text=`${S}`;const Y=Ce(l,"heels"),k=Y?.state.hasBag??!1;j(Y?.state.carrying??null),a.heels.bag.icon.filters=k?oe:o}},nt={movementType:"vel",vels:{gravity:B}},ho=(e,t,n)=>{if(!Z(e,t.progression))return nt;const{type:o,state:{vels:{gravity:{z:r}},standingOn:s}}=e,i=cn[o==="head"?"head":"others"];return s!==null?g("lift")(s)&&s.state.vels.lift.z<0?{movementType:"vel",vels:{gravity:{z:Math.max(r-Fe*n,-i)}}}:nt:{movementType:"vel",vels:{gravity:{z:Math.max(r-Fe*n,-i)}}}},le=e=>{const n=e/dn*ln;return(e+.5*Fe*n**2)/n},fo={head:le(ce.head),headOnSpring:le(ce.head+N.h),heels:le(ce.heels),heelsOnSpring:le(ce.heels+N.h)},po=(e,t)=>fo[`${e}${t?"OnSpring":""}`],mo=({type:e,state:{standingOn:t}},n,o)=>{const{inputState:{jump:r}}=n,s=t!==null&&g("teleporter")(t);if(!(r&&t!==null&&!s))return t!==null?{movementType:"steady",stateDelta:{jumped:!1}}:Ct;const a=g("spring")(t);return{movementType:"vel",vels:{gravity:{z:po(e,a)}},stateDelta:{action:"moving",jumped:!0}}},yo=({vel:e,acc:t,unitD:n,maxSpeed:o,deltaMS:r,crossComponentFade:s=0,minVelocity:i=0})=>{const a=K(e,n),l=Math.max(a+t*r,i),c=l>=o,d=un(n),h=K(e,d),p=h>=0?Math.max(h-s*r,0):Math.min(h+s*r,0);return _(I(n,c?o:l),I(d,p))},ot={movementType:"vel",vels:{walking:B}},go=(e,{inputState:t},n)=>{const{type:o,state:{autoWalk:r,standingOn:s,facing:i,teleporting:a,vels:{walking:l,gravity:c}}}=e,d=r?i:wt.find(A=>t[A]===!0),h=ge[o];if(a!==null)return ot;if(o==="heels"){if(s===null)return e.state.jumped?{movementType:"vel",vels:{walking:ye(l,I(l,hn*n))}}:ot;if(t.jump){const A=d??i,b=g("spring")(s)?1:fn;return{movementType:"vel",vels:{walking:I(re[A],h*b)},stateDelta:{facing:A}}}}const p=s===null&&c.z<0;if(d!==void 0)return p?{movementType:"vel",vels:{walking:I(re[d],h)},stateDelta:{facing:d,action:"falling"}}:{movementType:"vel",vels:{walking:yo({vel:l,acc:pn[o],deltaMS:n,maxSpeed:h,unitD:re[d],crossComponentFade:Ye[o],minVelocity:He[o]})},stateDelta:{facing:d,action:"moving"}};const f=mn(l),M=f===0?B:I(l,1/f),w=Math.max(f-Ye[o]*n,0);return{movementType:"vel",vels:{walking:I(M,w<He[o]?0:w)},stateDelta:{action:p?"falling":"idle"}}},rt=N.h,de=.001,vo=({totalDistance:e,currentAltitude:t,direction:n})=>{const o=ke**2/(2*Q);if(n==="up"){if(t<=o)return Math.max(de,Math.sqrt(2*Q*Math.max(t,0)));if(t>=e-o){const r=Math.max(0,e-t);return Math.max(de,Math.sqrt(2*Q*r))}else return ke}else if(t>=e-o){const r=Math.max(0,e-t);return Math.min(-de,-Math.sqrt(2*Q*r))}else return t<=o?Math.min(-de,-Math.sqrt(2*Q*Math.max(t,0))):-ke};function xo({config:{bottom:e,top:t},state:{direction:n,position:{z:o}}},r,s){const i=e*rt,a=t*rt,l=vo({currentAltitude:o-i,direction:n,totalDistance:a-i});if(Number.isNaN(l))throw new Error("velocity is NaN");const c=o<=i?"up":o>=a?"down":n;return{movementType:"vel",vels:{lift:{z:l}},stateDelta:{direction:c}}}const st=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),it={stopAutowalk:0,portal:0,wall:0,doorLegs:0,sceneryPlayer:0,block:1,barrier:1,floor:1,book:1,hushPuppy:1,teleporter:1,doorFrame:1,lift:2,movableBlock:2,portableBlock:2,slidingBlock:2,spring:2,ball:3,joystick:3,switch:3,charles:3,conveyor:3,head:3,heels:3,pickup:8,scroll:8,slidingDeadly:10,moveableDeadly:10,deadlyBlock:10,baddie:10},Et=(e,t)=>it[e.type]-it[t.type],wo=(e,t)=>t.toSorted((n,o)=>{const r=Et(n,o);if(r!==0)return r;const s=K(e,st(e,n)),i=K(e,st(e,o));return s-i});function bo({gameState:e,movingItem:t}){if(t.state.action==="death")return!1;const{shieldCollectedAt:n}=t.state;return n!==null&&n+Ie>e.gameTime?!1:(t.state.action="death",t.state.expires=e.gameTime+De,!0)}const Pe=g("head"),at=g("heels"),Co=({gameState:e,movingItem:t,touchedItem:n})=>{const o=z(e).id;if(e.pickupsCollected[o][n.id]===!0)return;const r=e.pickupsCollected[o];switch(r[n.id]=!0,kt(n,e),n.config.gives){case"hooter":{if(Pe(t)){t.state.hasHooter=!0;break}break}case"donuts":{if(Pe(t)){t.state.donuts+=6;break}break}case"bag":{if(at(t)){t.state.hasBag=!0;break}break}case"shield":{t.state.shieldCollectedAt=e.gameTime;break}case"fast":{Pe(t)&&(t.state.fastSteps=99);break}case"jumps":{at(t)&&(t.state.bigJumps=10);break}case"extra-life":t.state.lives+=2;break}},ko=({gameState:e,movingItem:t,touchedItem:n,movementVector:o})=>{const{config:{relativePoint:r,toRoom:s,direction:i},state:{position:a}}=n,l=re[i];return K(l,o)<=0?!1:(Ee({gameState:e,toRoomId:s,positionRelativeToSourcePortal:ye(t.state.position,_(a,r)),sourcePortal:n,changeType:"portal"}),!0)},To=({movingItem:e,movementVector:t,touchedItem:n})=>{const{config:{direction:o,nearness:r}}=n,s=ve(o),i=r==="far"?{x:s==="x"?-Math.abs(t.y):0,y:s==="y"?-Math.abs(t.x):0,z:0}:{x:s==="x"?Math.abs(t.y):0,y:s==="y"?Math.abs(t.x):0,z:0};return e.state.position=_(e.state.position,i),!1};function Po({movingItem:e}){return e.state.autoWalk=!1,!1}const Oo=({gameState:{events:e},touchedItem:t,gameState:{progression:n}})=>{const{config:o,state:{touchedOnProgression:r}}=t;t.state.touchedOnProgression=n,n!==r+1&&e.emit("scrollOpened",o)},$=(e,...t)=>g(...t)(e.touchedItem),Oe=(e,...t)=>g(...t)(e.movingItem),ct=e=>{switch(!0){case $(e,"stopAutowalk"):Po(e);break;case($(e,...yn)||$(e,"floor")&&e.touchedItem.config.deadly):if(bo(e))return!0;break;case $(e,"portal"):if(ko(e))return!0;break;case $(e,"pickup"):Co(e);break;case $(e,"doorFrame"):To(e);break;case $(e,"block","barrier"):{(g("barrier")(e.touchedItem)&&e.touchedItem.config.disappearing||g("block")(e.touchedItem)&&e.touchedItem.state.disappearing)&&kt(e.touchedItem,e.gameState);break}case $(e,"scroll"):Oo(e)}return!1},So=({touchedItem:e,gameState:t})=>{const n=z(t),{config:{activates:o},state:{setting:r,touchedOnProgression:s}}=e;if(e.state.touchedOnProgression=t.progression,t.progression===s+1)return;const i=e.state.setting=r==="left"?"right":"left";for(const[a,l]of Xe(o)){const c=n.items[a];c.state={...c.state,...l[i]}}return!1},Mo=({movingItem:e,touchedItem:t,gameState:n})=>{if(!Z(e,n.progression))return;const{state:{position:o},aabb:r}=t,s=ie(e.state.position,e.aabb,o,r);if(s.x===0||s.y===0)return;const i=Tt(s),a=I(i,-ge.ball);return t.state.vels.sliding=a,!1},Ao=({movingItem:e,touchedItem:t,gameState:n})=>{if(!Z(t,n.progression))return;const o=e.state.vels.sliding;if(ae(o,B))return;const{state:{position:r},aabb:s}=e,i=ie(t.state.position,t.aabb,r,s);return K(i,e.state.vels.sliding)>0&&(e.state.vels.sliding=B),!1},zo=({gameState:e,movingItem:t,touchedItem:n,deltaMS:o})=>{const r=z(e),{config:{controls:s},state:{position:i},aabb:a}=n,l=ie(t.state.position,t.aabb,i,a);if(l.x===0&&l.y===0)return;const c=Tt(l);for(const d of s){const h=r.items[d],p=I(c,-ge.charles*o);h.state.facing=p,we({subjectItem:h,posDelta:p,gameState:e,pusher:n,deltaMS:o})}return!1},Xt=e=>{switch(!0){case Oe(e,...pe):if(ct(e))return!0;break;case $(e,...pe):if(ct({...e,movingItem:e.touchedItem,touchedItem:e.movingItem}))return!0;break;case $(e,...Ge):if(Mo(e))return!0;break;case Oe(e,...Ge):if(Ao(e))return!0;break;case Oe(e,"baddie"):gn(e);break;case $(e,"switch"):if(So(e))return!0;break;case $(e,"joystick"):if(zo(e))return!0}return!1},Rt=e=>{e.state.standingOn!==null&&e.state.standingOn.state.stoodOnBy.delete(e),e.state.standingOn=null},Nt=(e,t)=>{e.state.standingOn=t,t.state.stoodOnBy.add(e)},we=({subjectItem:e,posDelta:t,gameState:n,pusher:o,deltaMS:r,forceful:s=g("lift")(e)&&o===void 0,recursionDepth:i=0})=>{if(ae(t,B))return!1;if(i>16)throw new Error("this probably means a non-terminating issue");const a=z(n),{state:{position:l}}=e;e.state.position=_(l,t);const c=wo(t,Pt(e,V(a.items)));for(const d of c){if(!Ot(e,d))continue;if(o!==d&&Xt({movingItem:e,touchedItem:d,movementVector:ye(e.state.position,l),gameState:n,deltaMS:r}))return!0;if(!Z(d,n.progression)||!Z(e,n.progression))continue;const h=ie(e.state.position,e.aabb,d.state.position,d.aabb);if(G(d)&&d!==o){const f=I(h,s?-1:-.5);if(e.state.position=_(e.state.position,h,f),we({subjectItem:d,posDelta:f,pusher:e,gameState:n,deltaMS:r,forceful:s,recursionDepth:i+1}))return!0;e.state.position=_(e.state.position,ie(e.state.position,e.aabb,d.state.position,d.aabb))}else e.state.position=_(e.state.position,h);G(e)&&h.z>0&&(e.state.standingOn===null||!c.includes(e.state.standingOn))&&(Rt(e),Nt(e,d))}return!1};function _o(e,t,n){const{state:{teleporting:o,standingOn:r}}=e,{inputState:{jump:s}}=t;if(o===null)return s&&r!==null&&g("teleporter")(r)?{movementType:"steady",stateDelta:{teleporting:{phase:"out",toRoom:r.config.toRoom,timeRemaining:De}}}:Ct;const i=Math.max(o.timeRemaining-n,0);switch(o.phase){case"out":if(i===0)return Ee({gameState:t,toRoomId:o.toRoom,changeType:"teleport"}),{movementType:"endTick",stateDelta:{teleporting:{phase:"in",timeRemaining:De}}};break;case"in":if(i===0)return{movementType:"steady",stateDelta:{teleporting:null}};break}return{movementType:"steady",stateDelta:{teleporting:{...o,timeRemaining:i}}}}const lt={movementType:"vel",vels:{movingFloor:B},stateDelta:{activeConveyor:null}},$o=(e,t,n)=>{if(xe(e)&&e.state.teleporting!==null)return lt;const{state:{standingOn:o}}=e;if(o===null||!g("conveyor")(o))return lt;const{config:{direction:r}}=o,i=g("heels")(e)&&e.state.action==="moving"&&e.state.facing===vn(r)?ge.heels:xn;return{movementType:"vel",vels:{movingFloor:I(re[r],i)},stateDelta:{activeConveyor:o}}},Io=(e,t,n,o)=>{const r=Math.max(0,Math.min(e.x+t.x,n.x+o.x)-Math.max(e.x,n.x)),s=Math.max(0,Math.min(e.y+t.y,n.y+o.y)-Math.max(e.y,n.y));return r*s},dt=({state:{position:e},aabb:t},{state:{position:n},aabb:o})=>Io(e,t,n,o),Fo=.001,Vt=(e,t,n)=>{if(!Z(t,n)||e.id===t.id)return!1;const{state:{position:o,vels:{gravity:{z:r}}},aabb:s,id:i}=e;if(r>0)return!1;const a=_(o,{z:-Fo});return Ot({state:{position:a},aabb:s,id:i},t)},Lt=(e,t,n)=>{const r=[...q(t).filter(i=>Vt(e,i,n))];return r.length===0?void 0:r.reduce((i,a)=>{const l=Et(a,i);return l>0||l===0&&dt(e,a)>dt(e,i)?a:i})},Ut=(e,t)=>{delete e.items[t.id];for(const n of t.state.stoodOnBy)n.state.standingOn=null};let Do=0;const Bo=(e,t,n,o)=>{const r={type:n,config:o,position:B},s=`${n}/${Do++}`,i=jn(wn(s,r,e.pickupsCollected[t.id]));if(i===void 0)throw new Error("failed to generate any items");return t.items[s]=i,i},Eo=(e,t,n,o)=>{const{inputState:r}=n,{state:{carrying:s,position:i,hasBag:a}}=e;if(!a)return;const l=q(V(t.items)).filter(St),c=s===null?Ro(e,t,n):void 0;for(const d of l)d.state.wouldPickUpNext=!1;if(c!==void 0&&(c.state.wouldPickUpNext=!0),r.carry){if(s===null){if(c===void 0){console.warn("nothing to pick up");return}Xo(t,e,c)}else{if(e.state.standingOn===null||!Wt(e,V(t.items)))return;const d=Bo(n,t,s.type,s.config);d.state.position=i,we({subjectItem:e,gameState:n,posDelta:{x:0,y:0,z:d.aabb.z},pusher:e,forceful:!0,deltaMS:o}),e.state.carrying=null}r.carry=!1}},Xo=(e,t,n)=>{const o={type:n.type,config:n.config};t.state.carrying=o,Ut(e,n)},Ro=(e,t,n)=>Lt(e,q(V(t.items)).filter(St),n.progression),Wt=(e,t)=>{const n={position:_(e.state.position,{z:N.h})},o=Pt({id:e.id,aabb:e.aabb,state:n},t);for(const r of o)if(!G(r)||!Wt(r,t))return!1;return!0};function*No(e,t,n){for(;(e.state.latentMovement.at(0)?.moveAtGameTime??Number.POSITIVE_INFINITY)<t.gameTime;){const{positionDelta:o}=e.state.latentMovement.shift();yield{movementType:"position",posDelta:o}}}function*Vo(e,t,n,o){G(e)&&(yield ho(e,n,o),yield $o(e),yield*No(e,n)),xe(e)&&e.type===n.currentCharacterName&&(yield _o(e,n,o),yield go(e,n,o),yield mo(e,n),g("heels")(e)&&Eo(e,t,n,o)),g("lift")(e)&&(yield xo(e)),g("baddie")(e)&&(yield bn(e,t,n,o))}const Lo=(e,t,n,o)=>{let r=B;const s=[...Vo(e,t,n,o)];for(const i of s){if(i.movementType==="position"&&(r=_(r,i.posDelta)),i.movementType==="vel"&&(G(e)||g("lift")(e)))for(const[l,c]of Xe(i.vels)){const d={...B,...c};e.state.vels[l]=d}const a=i.stateDelta;if(a!==void 0&&(e.state={...e.state,...a}),i.movementType==="endTick")return!0}return(G(e)||g("lift")(e))&&(r=_(r,...q(V(e.state.vels)).map(i=>I(i,o)))),we({subjectItem:e,posDelta:r,gameState:n,deltaMS:o})},Uo=e=>{e.currentCharacterName=Mt(e.currentCharacterName)},Wo=e=>{const{currentCharacterName:t}=e,{room:n,entryState:o}=e.characterRooms[t],r=n.items[t],s=Mt(t),i=r.state,a=r.state.lives-1;if(a===0){r.state.lives=a,e.characterRooms[t]=void 0,e.currentCharacterName=s;return}r.state={...i,...o,expires:null,lives:a,standingOn:null};const l=_e(e.campaign.rooms[n.id],e.pickupsCollected[n.id],{[t]:r});e.characterRooms[t].room=l},jo=10,Ho=(e,t)=>e.state.expires!==null&&e.state.expires<t.gameTime,Yo=(e,t)=>{for(const n of V(e.items)){const o=t[n.id];if(o===void 0)continue;ae(o,n.state.position)&&!Tn(n.state.position)&&(console.log(`snapping item ${n.id} to pixel grid`),n.state.position=Pn(n.state.position))}},Go=(e,t)=>{const n={lift:-4,head:-3,heels:-3,baddie:-2,block:1,deadlyBlock:1},o=n[e.type]??0,r=n[t.type]??0;return o-r},qo=(e,t)=>{const n=Math.ceil(t/jo),o=t/n,{inputState:r}=e;if(r.swop){Uo(e),r.swop=!1;return}const s=z(e);for(let i=0;i<n;i++){const a=Object.fromEntries(q(Xe(s.items)).map(([c,d])=>[c,d.state.position]));for(const c of V(s.items))if(Ho(c,e))if(xe(c)){Wo(e);return}else Ut(s,c);const l=Object.values(s.items).sort(Go);for(const c of l){if(Cn(e).state.action==="death")break;if(s.items[c.id]!==void 0&&Lo(c,s,e,o))return}for(const c of l)for(const d of c.state.stoodOnBy)if(Vt(d,c,e.progression)){const p={...ye(c.state.position,a[c.id]),z:0};ae(p,B)||d.state.latentMovement.push({moveAtGameTime:e.gameTime+2*kn,positionDelta:p})}else{Rt(d);const h=Lt(d,V(s.items),e.progression);h!==void 0&&Nt(d,h)}for(const c of l)!G(c)||c.state.standingOn===null||Xt({movingItem:c,touchedItem:c.state.standingOn,gameState:e,deltaMS:t,movementVector:{x:0,y:0,z:-1}});if(e.progression++,e.gameTime+=o,s!==z(e))throw new Error(`room has changed during physics tick ${s.id} -> ${z(e).id} but did not return out of the tick`);Yo(s,a)}},jt=e=>{const t={},n=Object.values(e.items).filter(g("doorFrame"));for(const{config:{direction:o},state:{position:{x:r,y:s}}}of n)ve(o)==="x"?s<0?t.towards=!0:s===e.size.y*N.d&&(t.away=!0):r<0?t.right=!0:r===e.size.x*N.w&&(t.left=!0);return t},Ht=e=>{const t=jt(e),n=t.right?-.5:0,o=e.size.x+(t.left?.5:0),r=t.towards?-.5:0,s=e.size.y+(t.away?.5:0),i=W({x:n,y:s}),a=W({x:o,y:r}),l=W({x:n,y:r}),c=W({x:o,y:s}),d=c.y+ue.h;return{blockXMin:n,blockXMax:o,blockYMin:r,blockYMax:s,rightSide:i,leftSide:a,frontSide:l,backSide:c,top:d}},Jo=e=>{const{towards:t,right:n}=jt(e),{blockXMin:o,blockYMin:r,rightSide:s,leftSide:i,frontSide:a,backSide:l}=Ht(e),{floor:c,color:{shade:d}}=e,h=new x({label:`floor(${e.id})`}),p=Object.fromEntries(e.floorSkip.map(({x:b,y:S})=>[`${b},${S}`,!0]));if(c!=="none"){const b=c==="deadly"?`generic${d==="dimmed"?".dark":""}.floor.deadly`:`${c}${d==="dimmed"?".dark":""}.floor`,S=new x;for(let k=-1;k<=e.size.x;k++)for(let m=k%2-1;m<=e.size.y;m+=2)p[`${k},${m}`]||S.addChild(ee({x:k,y:m},u({anchor:{x:.5,y:1},texture:b})));for(let k=0;k<=e.size.x;k++)e.walls.away[k]!=="none"&&S.addChild(ee({x:k,y:e.size.y},u({anchor:{x:0,y:1},texture:"generic.floor.overdraw",flipX:!0})));for(let k=0;k<=e.size.y;k++)e.walls.left[k]!=="none"&&S.addChild(ee({x:e.size.x,y:k},u({anchor:{x:0,y:1},texture:"generic.floor.overdraw"})));const Y=new J().poly([a,s,l,i],!0).fill(16711680).stroke({width:8});S.addChild(Y),S.mask=Y,h.addChild(S)}const f=new x;for(let b=o;b<=e.size.x;b+=.5)f.addChild(ee({x:b,y:t?-.5:0},u({pivot:{x:7,y:0},texture:"generic.edge.towards"})));f.filters=Be(e,"towards");const M=new x;for(let b=r;b<=e.size.y;b+=.5)M.addChild(ee({x:n?-.5:0,y:b},u({pivot:{x:0,y:0},texture:"generic.edge.right"})));M.filters=Be(e,"right");const w=W({x:0,y:e.size.y}),A=W({x:e.size.x,y:0}),j=new J().poly([{x:a.x,y:a.y+16},{x:w.x,y:w.y+16},{x:w.x,y:-999},{x:A.x,y:-999},{x:A.x,y:A.y+16}],!0).fill(16776960);return h.addChild(j),h.addChild(f),h.addChild(M),h.mask=j,h},ut=(e,t)=>{const n=v(e),o=v(_(e,{x:t.x,z:t.z})),r=v(_(e,{y:t.y,z:t.z}));return{bottomCentre:n,topLeft:o,topRight:r}},Se=(e,t,n,o,r=1e-5)=>o-r>e&&n<t-r,Zo=(e,t,n,o)=>{const r=ut(e,t),s=ut(n,o),i=r.topLeft.x,a=r.topRight.x,l=s.topLeft.x,c=s.topRight.x,d=Se(i,a,l,c),h=r.topRight.y-r.topRight.x/2,p=r.bottomCentre.y-r.bottomCentre.x/2;if(h>p)throw new Error(`aXAxisSlopeMinC ${h} > aXAxisSlopeMaxC ${p}`);const f=s.topRight.y-s.topRight.x/2,M=s.bottomCentre.y-s.bottomCentre.x/2;if(f>M)throw new Error("bXAxisSlopeMinC > bXAxisSlopeMaxC");const w=Se(h,p,f,M),A=r.topLeft.y+r.topLeft.x/2,j=r.bottomCentre.y+r.bottomCentre.x/2;if(A>j)throw new Error("aYAxisSlopeMinC > aYAxisSlopeMaxC");const b=s.topLeft.y+s.topLeft.x/2,S=s.bottomCentre.y+s.bottomCentre.x/2;if(b>S)throw new Error("bYAxisSlopeMinC > bYAxisSlopeMaxC");const Y=Se(A,j,b,S);return d&&w&&Y},Ko=(e,t)=>{if(e.renders===!1||t.renders===!1)return 0;const n=e.state.position,o=e.renderAabb||e.aabb,r=t.state.position,s=t.renderAabb||t.aabb;if(!Zo(n,o,r,s))return 0;for(const i of On){const a=e.state.position[i],l=a+o[i],c=t.state.position[i],d=c+s[i];if(l<=c)return 1*(i==="z"?-1:1);if(a>=d)return-1*(i==="z"?-1:1)}return ht(t)-ht(e)},ht=e=>e.state.position.x+e.state.position.y-e.state.position.z;class fe extends Error{constructor(t,n,o,r){super(t,r),this.cyclicDependency=n,this.hasClosedCycle=o}}const Qo=e=>er(tr(e),e),er=(e,t)=>{let n=e.length,o=n;const r=new Array(n),s={},i=nr(t),a=or(e);for(t.forEach(function(c){if(!a.has(c[0])||!a.has(c[1]))throw new Error("Unknown node. There is an unknown node in the supplied edges.")});o--;)s[o]||l(e[o],o,new Set);return r;function l(c,d,h){if(h.has(c))throw new fe("Cyclic dependency found - see .cyclicDependency of this error for details",[c],!1);if(!a.has(c))throw new Error("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(c));if(s[d])return;s[d]=!0;const p=i.get(c)||new Set,f=Array.from(p);if(d=f.length){h.add(c);do{const M=f[--d];try{l(M,a.get(M),h)}catch(w){throw w instanceof fe?w.hasClosedCycle?w:new fe(w.message,[...w.cyclicDependency,c],w.cyclicDependency.includes(c)):w}}while(d);h.delete(c)}r[--n]=c}};function tr(e){const t=new Set;for(let n=0,o=e.length;n<o;n++){const r=e[n];t.add(r[0]),t.add(r[1])}return Array.from(t)}function nr(e){const t=new Map;for(let n=0,o=e.length;n<o;n++){const r=e[n];t.has(r[0])||t.set(r[0],new Set),t.has(r[1])||t.set(r[1],new Set),t.get(r[0]).add(r[1])}return t}function or(e){const t=new Map;for(let n=0,o=e.length;n<o;n++)t.set(e[n],n);return t}const rr=e=>{const t=[];for(const n of e)if(n.renders)for(const o of e){if(n===o)break;if(!o.renders)continue;const r=Ko(n,o);r!==0&&(r>0?t.push([o.id,n.id]):t.push([n.id,o.id]))}return t},Yt=(e,t,n=3)=>{try{return{order:Qo(e),impossible:!1}}catch(o){if(o instanceof fe){const r=o.cyclicDependency,s=e.find(([i,a])=>r.includes(i)&&r.includes(a));if(s===void 0)throw new Error("could not find bad link");return{order:Yt(e.filter(i=>i!==s),t,n-1).order,impossible:!0}}else throw o}},sr=(e,t,n,o)=>`${e}${o?".dark":""}.wall.${t}.${n}`,ir=(e,t,n)=>{const r=y.textures[`${e.planet}.door.front.${t}`]!==void 0?e.planet:"generic",s=e.color.shade==="dimmed"&&y.textures[`${r}.dark.door.front.${t}`]!==void 0;return`${r}${s?".dark":""}.door.${n=="near"?"front":"back"}.${t}`};function Gt(e,t){const n=new x;for(const o of e)n.addChild(o);return n}const ft=e=>()=>({container:u(e),renderProps:{}}),R=e=>({item:t,room:n,currentlyRenderedProps:o})=>{if(o===void 0)return e({item:t,room:n})};function*ar({config:{direction:e,inHiddenWall:t,height:n}},o){const r=ve(e),s=r==="y"?0:16;function*i(a){if(t){if(n!==0){const c=u({pivot:{x:r==="x"?18:8,y:12},texture:`generic.door.floatingThreshold.${r}`,...Te(a,{y:-N.h*n})});c.filters=Be(o,r==="x"?"towards":"right"),yield c}}else{yield u({pivot:{x:s,y:12},texture:"generic.door.legs.base",...Te(a,{y:n})});for(let l=1;l<n;l++)yield u({pivot:{x:s,y:9},texture:"generic.door.legs.pillar",...Te(a,{y:-l*N.h})})}}yield*i(W({...he,[r]:1})),yield*i(he),t||(yield u({pivot:{x:16,y:N.h*n+13},texture:`generic.door.legs.threshold.double.${r}`,...W({...he,[r]:1})}))}const cr=R(({item:e,room:t})=>({container:Gt(ar(e,t)),renderProps:{}}));function*lr({config:{direction:e,inHiddenWall:t,nearness:n},state:{position:o}},r){const s=ve(e),{z:i}=o;if(!t&&i===0){const a=W({[Sn(s)]:.5});n==="far"&&(yield u({anchor:{x:0,y:1},flipX:s==="x",texture:"generic.wall.overdraw",...a}))}yield u({texture:ir(r,s,n),pivot:Mn[n][s]})}const dr=R(({item:e,room:t})=>({container:Gt(lr(e,t)),renderProps:{}})),pt=({item:{type:e,state:{action:t,facing:n,teleporting:o}},currentlyRenderedProps:r})=>r===void 0||r.action!==t||r.facingXy4!==n||r.teleportingPhase!==(o?.phase??null)?{container:(()=>{if(t==="death")return u({frames:y.animations[`${e}.fadeOut`]});if(o!==null){if(o.phase==="out")return u({frames:y.animations[`${e}.fadeOut`]});if(o.phase==="in")return u({frames:y.animations[`${e}.fadeOut`].toReversed()})}return t==="moving"?u({frames:y.animations[`${e}.walking.${n}`]}):t==="falling"&&e==="head"&&(n==="towards"||n==="right")?u(`head.falling.${n}`):e==="head"&&(n==="towards"||n==="right")?u({frames:y.animations[`head.idle.${n}`]}):u(`${e}.walking.${n}.2`)})(),renderProps:{action:t,facingXy4:n,teleportingPhase:o?.phase??null}}:void 0,Me={frames:y.animations["bubbles.cold"],animationSpeed:.25},ne=(e,t="headless-base")=>{const n=new x;n.addChild(u(t));const o=u(e);return o.y=-12,n.addChild(o),n},Ae=(e,t)=>t?new x({children:[u({texture:e,pivot:{x:U.w/2,y:U.h}}),u({texture:`${e}.outline`,pivot:{x:U.w/2+1,y:U.h+1}})]}):u(e),ze=R(({item:{config:{style:e}}})=>({container:u(e),renderProps:{}})),ur={head:pt,heels:pt,doorFrame:dr,doorLegs:cr,stopAutowalk(){throw new Error("these should always be non-rendering")},portal(){throw new Error("these should always be non-rendering")},wall:R(({item:{config:{side:e,style:t}},room:n})=>{if(e==="right"||e==="towards")throw new Error("this wall should be non-rendering");return{container:u({texture:sr(n.planet,t,e,n.color.shade==="dimmed"),pivot:e==="away"?{x:ue.w,y:ue.h+1}:{x:0,y:ue.h+1}}),renderProps:{}}}),barrier({item:{config:{axis:e},state:{expires:t}},currentlyRenderedProps:n}){const o=t!==null;if(n===void 0||o!==n.bubbles)return{container:o?u({frames:y.animations["bubbles.taupe"],playOnce:"and-destroy",pivot:qe[e]}):u({texture:`barrier.${e}`,pivot:qe[e]}),renderProps:{bubbles:o}}},deadlyBlock:ze,slidingDeadly:ze,slidingBlock:ze,block({item:{config:{style:e},state:{expires:t,disappearing:n}},currentlyRenderedProps:o}){const r=t!==null;if(o===void 0||o.bubbles!==r||o.disappearing!==n)return{container:r?u({frames:y.animations["bubbles.taupe"],playOnce:"and-destroy"}):u(`block.${e}${n?".disappearing":""}`),renderProps:{bubbles:r,disappearing:n}}},switch({item:{state:{setting:e}},currentlyRenderedProps:t}){if(t===void 0||e!==t.setting)return{container:u(`switch.${e}`),renderProps:{setting:e}}},conveyor({item:{config:{direction:e,count:t},state:{stoodOnBy:n}},currentlyRenderedProps:o}){const r=n.size>0;if(!(o===void 0||o.moving!==r))return;const i=new x,a=_n(e);return i.addChild(...q(An(t,0,-1)).map(l=>{const c=$n({[a]:(l-1)*N.w});return u(r?{frames:y.animations[`conveyor.${a}`],reverse:e==="towards"||e==="right",animationSpeed:.5,...c}:{texture:`conveyor.${a}.6`,...c})})),{container:i,renderProps:{moving:r}}},lift:R(()=>{const e=new x,t={x:U.w/2,y:U.h-In};return e.addChild(u({frames:y.animations.lift,pivot:t})),e.addChild(u({texture:"lift.static",pivot:t})),{container:e,renderProps:{}}}),teleporter({item:{state:{stoodOnBy:e}},currentlyRenderedProps:t}){const n=q(e).find(xe)!==void 0;return t===void 0||n!==t.flashing?{container:n?new x({children:[u("teleporter"),u({frames:y.animations["teleporter.flashing"]})]}):u("teleporter"),renderProps:{flashing:n}}:void 0},pickup({item:{config:{gives:e},state:{expires:t}},currentlyRenderedProps:n}){const o=t!==null;if(!(n===void 0||n.bubbles!==o))return;const i={shield:"bunny",jumps:"bunny",fast:"bunny","extra-life":"bunny",bag:"bag",donuts:"donuts",hooter:"hooter",crown:"crown",reincarnation:{frames:y.animations.fish,animationSpeed:.25}}[e];return{container:u(o?{frames:i==="donuts"?y.animations["bubbles.taupe"]:y.animations["bubbles.white"],playOnce:"and-destroy"}:i),renderProps:{bubbles:o}}},moveableDeadly:R(({item:{config:{style:e}}})=>({container:u(e==="deadFish"?"fish.1":"puck.deadly"),renderProps:{}})),sceneryPlayer:R(({item:{config:{which:e}}})=>({container:u(`${e}.walking.towards.2`),renderProps:{}})),charles({item:{state:{facing:e}},currentlyRenderedProps:t}){const n=Je(e);if(t===void 0||n!==t.facingXy4)return{container:ne(`charles.${n}`),renderProps:{facingXy4:n}}},baddie({item:{config:e,state:t},currentlyRenderedProps:n}){let o;const{activated:r}=t;switch(e.which){case"american-football-head":case"turtle":case"cyberman":o=e.startDirection;case"computer-bot":case"elephant":case"monkey":{const s=zn(t.vels.walking,he)?o??"towards":Je(t.vels.walking);if(!(n===void 0||r!==n.activated||s!==n.facingXy4))return;const a={facingXy4:s,activated:r};switch(e.which){case"american-football-head":return{container:u({texture:`${e.which}.${e.style}.${s}`}),renderProps:a};case"turtle":return{container:r?u({frames:y.animations[`${e.which}.${s}`],animationSpeed:.25}):u(`${e.which}.${s}.1`),renderProps:a};case"cyberman":return{container:t.activated?ne(`${e.which}.${s}`,Me):u(`${e.which}.${s}`),renderProps:a};case"computer-bot":case"elephant":case"monkey":return{container:ne(`${e.which}.${s}`),renderProps:a}}break}case"helicopter-bug":case"dalek":case"headless-base":case"elephant-head":case"bubble-robot":case"flying-ball":{if(!(n===void 0||r!==n.activated))return;const i={activated:r};switch(e.which){case"helicopter-bug":case"dalek":return{container:u({frames:y.animations[e.which],animationSpeed:.5}),renderProps:i};case"headless-base":return{container:u(e.which),renderProps:i};case"elephant-head":return{container:u("elephant.towards"),renderProps:i};case"bubble-robot":return{container:ne(Me),renderProps:i};case"flying-ball":return{container:ne("ball",Me),renderProps:i}}break}default:throw new Error(`unexpected baddie ${e}`)}},joystick:ft("joystick"),movableBlock:R(({item:{config:{style:e}}})=>({container:u(e),renderProps:{}})),portableBlock({item:{config:{style:e},state:{wouldPickUpNext:t}},currentlyRenderedProps:n}){const o=t;if(n===void 0||o!==n.highlighted)return{container:Ae(e,o),renderProps:{highlighted:o}}},spring({item:{state:{stoodOnBy:e,wouldPickUpNext:t}},currentlyRenderedProps:n}){const o=e.size>0,r=t;if(!(n===void 0||r!==n.highlighted||o!==n.compressed))return;const i=n?.compressed??!1;return{container:!o&&i?u({frames:y.animations["spring.bounce"],playOnce:"and-stop"}):Ae(o?"spring.compressed":"spring.released",r),renderProps:{compressed:o,highlighted:r}}},book:R(({item:{config:{slider:e}}})=>({container:u(`book.${e?"y":"x"}`),renderProps:{}})),hushPuppy({item:{state:{expires:e}},currentlyRenderedProps:t}){const n=e!==null;if(t===void 0||t.bubbles!==n)return{container:n?u({frames:y.animations["bubbles.taupe"],playOnce:"and-destroy"}):u("hushPuppy"),renderProps:{bubbles:n}}},ball:ft("ball"),floor(){throw new Error("floor should not be rendered as an item")},scroll:R(()=>({renderProps:{},container:u({texture:"scroll",pivot:{x:17,y:24}})}))},mt=(e,t)=>new J().poly([v({}),v({x:e.x}),v({x:e.x,y:e.y}),v({y:e.y})]).poly([v({}),v({z:e.z}),v({y:e.y,z:e.z}),v({y:e.y})]).poly([v({x:e.x}),v({x:e.x,z:e.z}),v(e),v({x:e.x,y:e.y})]).poly([v({z:e.z}),v({x:e.x,z:e.z}),v({x:e.x,y:e.y,z:e.z}),v({y:e.y,z:e.z})]).stroke({width:1,color:t,alpha:.5}),hr={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",stopAutowalk:"rgba(255,128,128)"},fr=e=>{const t=hr[e.type]??"rgba(255,255,255)",n=new x;if(g("portal")(e)){const o=v(e.config.relativePoint);n.addChild(new J().circle(o.x,o.y,5).stroke(t)),n.addChild(new J().circle(o.x,o.y,2).fill(t))}return n.addChild(new J().circle(0,0,2).fill(t)),n.addChild(mt(e.aabb,t)),e.renderAabb&&n.addChild(mt(e.renderAabb,"rgba(184, 184, 255)")),n},pr=(e,t,n)=>{t!==void 0&&(n.onItemClick&&t!==void 0&&(t.eventMode="static",t.on("pointertap",()=>{n.onItemClick(e,t)})),t.on("pointerenter",()=>{t.filters=new se("white")}),t.on("pointerleave",()=>{t.filters=[]}))},yt=({state:{position:e}},t)=>{const n=Fn(e);t.x=n.x,t.y=n.y},mr=(e,t,n)=>{const o=new x;n.showBoundingBoxes!=="none"&&(o.alpha=.5);const r=new x({label:`item(${e.id})`});r.addChild(o),pr(e,o,n),(n.showBoundingBoxes==="all"||n.showBoundingBoxes==="non-wall"&&e.type!=="wall")&&(r.addChild(fr(e)),yt(e,r));let s,i;return{get item(){return e},destroy(){r.destroy({children:!0}),o.destroy({children:!0})},tick(){if(!e.renders)return;const a=ur[e.type],l=a({item:e,room:t,currentlyRenderedProps:s});l!==void 0&&(s=l.renderProps,o.children.forEach(h=>h.destroy()),l.container!==null&&o.addChild(l.container));const{state:{position:c}}=e,d=i===void 0||!ae(i,c);return d&&(yt(e,r),i=c),d},container:r}},yr=(e,t)=>{const{leftSide:n,rightSide:o,frontSide:r,top:s}=Ht(e),i=(o.x+n.x)/2,a=(s+r.y)/2;t.x=-i,t.y=-a},gt=(e,t)=>{const n=new x({label:`room(${e.id})`}),o=new x({label:`items(room(${e.id}))`});n.addChild(Jo(e)),n.addChild(o),n.filters=ro(e),yr(e,n);const r=new Map;return{get container(){return n},get room(){return e},tick(){let s=!1;for(const i of V(e.items)){let a=r.get(i.id);a===void 0&&(a=mr(i,e,t),r.set(i.id,a),o.addChild(a.container)),s=a.tick()||s}for(const i of r.values())e.items[i.item.id]||(r.delete(i.item.id),i.destroy());if(s){const{order:i}=Yt(rr(V(e.items)),e.items);for(let a=0;a<i.length;a++){const l=r.get(i[a]);if(l===void 0)throw new Error(`Item id=${i[a]} does not have a renderer - cannot assign a z-index`);l.container.zIndex=a}}},destroy(){n.destroy({children:!0}),r.forEach(s=>{s.destroy()})},get renderOptions(){return t}}},gr=4,vr=(e,t)=>{const n=new x;n.label="world",n.y=$e.height*.7,e.stage.addChild(n);const o=new x;o.y=-gr,e.stage.addChild(o);const r=new se(H().shadow);let s=gt(z(t),t.renderOptions);n.addChild(s.container);const i=uo(o),a=no(e),l=({deltaMS:c})=>{const d=a.rescale();n.x=e.renderer.width/a.curUpscale/2;const{inputState:{windowFocus:h}}=t,p=!h;if(i(t,d),(s.room!==z(t)||s.renderOptions!==t.renderOptions)&&(s.destroy(),s=gt(z(t),t.renderOptions),n.addChild(s.container)),!p)e.stage.filters=oe,qo(t,c),s.tick();else{e.stage.filters=r;const f=z(t).color;r.targetColor=Ft(f).main.original}};return{start(){return e.ticker.add(l),this},stop(){e.stage.removeChild(n),e.ticker.remove(l)}}},kr=async e=>{const t={showBoundingBoxes:"none"},n=new Dn;await n.init({background:"#000000",resizeTo:window});const o=to(e,t),r=Kn({keyAssignment:o.keyAssignment,inputState:o.inputState,onInputStateChange(i){o.events.emit("inputStateChanged",i)}}),s=vr(n,o).start();return{campaign:e,events:o.events,renderIn(i){i.appendChild(n.canvas)},changeRoom(i){Ee({gameState:o,toRoomId:i,changeType:"level-select"})},get currentRoom(){return z(o)},get gameState(){return o},set renderOptions(i){o.renderOptions=i},stop(){console.warn("tearing down game"),n.canvas.parentNode?.removeChild(n.canvas),s.stop(),r(),n.destroy()}}};export{kr as gameMain};
