import{j as e,r as p}from"./index-ClmU2LKs.js";import{au as Q,a7 as C,B as h,C as ee,r as T,z as ge,S as ye,f as ve,L as te,a8 as k,av as L,a6 as D,aw as je,ax as se,P as H,ay as be,A as we,az as ke,aA as Ce,Z as oe,aB as Se,aC as z,c as Ne,e as F,aD as Te,aE as Ie,aF as Re,R as re,aG as Pe,ai as Be,aH as $e,I as A,aI as $,ao as O,o as Ee,aJ as ze,at as Ae,aK as _e,aL as Le,aM as Me,aN as He,aO as De}from"./App-BL0q33Nu.js";import{B as ne,g as Fe,h as ie,i as Oe,j as Ue,k as ae,C as Je,R as Xe,S as Ze}from"./RoomSelect-ValqisUS.js";import{useAppSelectorWithLevelEditorSlice as j,selectTool as P,setTool as le,selectCurrentEditingRoomColour as Ge,changeRoomColour as U,selectCurrentEditingRoomScenery as We,changeRoomScenery as Ke,selectCanUndo as qe,selectCanRedo as Ve,undo as ce,redo as de,changeToRoom as Ye,selectCurrentEditingRoomJson as J,setSelectedItemInRoom as Qe,applyToolToRoomJson as et,deleteSelected as tt,selectSelectedJsonItemIds as st}from"./levelEditorSlice-BANXkCuw.js";import{c as ot,A as rt,s as nt,R as it,i as at,z as lt,a as ct,p as ue}from"./roomRenderer-BFyg1iZl.js";import"./Graphics-D0O2TZXe.js";import"./changeCharacterRoom-NHGK7zxe.js";const me=t=>t,M="h-[calc(3*var(--block)-1px*var(--scale))] w-[calc(3*var(--block)-1px*var(--scale))]",B=({className:t,onClick:s,children:o,disabled:r=!1,isCurrentTool:i=!1})=>e.jsx(ne,{disabled:r,"data-iscurrenttool":i,className:`active:pt-oneScaledPix ${M} gap-0 inline-flex overflow-hidden ${i?"bg-pastelBlue":""} ${r?"bg-midGrey text-lightGrey":""} ${t??""}`,onClick:s,children:o}),n=({itemTool:t,children:s,className:o})=>{const r=j(P),i=Q(r?.type==="item"&&r.item,t);return e.jsx(B,{isCurrentTool:i,className:o,onClick:()=>C.dispatch(le({type:"item",item:t})),children:s})},N=({children:t})=>{const[s,o]=p.useState(!1),[r,i]=p.useState(0),l=t[r];return e.jsxs(Fe,{open:s,onOpenChange:o,children:[e.jsxs("div",{className:ie(M,"relative",{"drop-shadow-oneBlock z-popups":s}),children:[l,e.jsx(Oe,{asChild:!0,children:e.jsx(ne,{className:"absolute bottom-0 right-0 bg-metallicBlueHalfbrite",children:e.jsx(h,{className:"pl-oneScaledPix",children:s?"X":"â¬‡"})})})]}),e.jsx(Ue,{children:e.jsx(ee,{scaleFactor:2,children:e.jsx("div",{className:"flex flex-col gap-oneScaledPix py-oneScaledPix bg-metallicBlueHalfbrite",children:t.map((d,u)=>u===r?null:e.jsx("div",{className:M,onClick:()=>{i(u),o(!1)},children:d},u))})})})]})},dt=()=>{const s=j(P)?.type==="pointer";return e.jsx(B,{onClick:()=>C.dispatch(le({type:"pointer"})),isCurrentTool:s,children:e.jsx("span",{className:"sprite texture-hud.char.â†– relative"})})},X=t=>{const{main:s}=ot[t].basic;return{backgroundColor:s.basic.toHex(),borderColor:s.dimmed.toHex()}};function ut(){const t=T(),s=j(Ge);return e.jsxs(e.Fragment,{children:[e.jsx(ae,{value:s.hue,onSelect:o=>{t(U({hue:o}))},values:ge,disableCommandInput:!0,OptionCommandItem:({value:o,onSelect:r})=>e.jsx(Je,{value:o,className:"border-l-3 h-2 w-full p-0",style:X(o),onSelect:r}),triggerButtonLabel:"colour",triggerButtonClassName:ie("w-full",`${s.hue==="white"?"text-pureBlack":"text-white"}`),triggerButtonStyle:X(s.hue)}),e.jsx(ye,{value:s.shade==="basic",onClick:(o,r)=>{t(U({shade:r?"basic":"dimmed"}))},falseLabel:"dimmed",trueLabel:"basic"})]})}function mt(){const t=T(),s=j(We);return e.jsx(ae,{value:s,onSelect:o=>{t(Ke(o))},values:ve,disableCommandInput:!0,triggerButtonClassName:"w-full",triggerButtonLabel:s})}const Z="[button:not(:disabled):hover_&]:hidden mt-quarter",G="hidden [button:not(:disabled):hover_&]:inline mt-quarter",W="hidden [button:not(:disabled):hover_&]:inline",pt=()=>{const t=T(),s=j(qe),o=j(Ve);return e.jsxs(e.Fragment,{children:[e.jsxs(B,{disabled:!s,className:"flex-col",onClick:()=>{t(ce())},children:[e.jsx(h,{className:Z,children:"â¬…"}),e.jsx(h,{className:G,children:"Un"}),e.jsx(h,{className:W,children:"do"})]}),e.jsxs(B,{disabled:!o,className:"flex-col",onClick:()=>{t(de())},children:[e.jsx(h,{className:Z,children:"âž¡"}),e.jsx(h,{className:G,children:"Re"}),e.jsx(h,{className:W,children:"do"})]})]})},a=me("[button:not([data-iscurrenttool=true]):not(:hover)_&]:sprite-revert-to-two-tone"),y=me("flex flex-wrap gap-oneScaledPix w-full"),w=({topClasses:t,bottomClasses:s="texture-headlessBase"})=>e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("span",{className:`sprite absolute top-[calc(9px*var(--scale))] left-0 ${s} ${a}`}),e.jsx("span",{className:`sprite absolute top-[calc(-3px*var(--scale))] left-0 ${t} ${a}`})]}),b=({iconClasses:t,text:s})=>e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("span",{className:`sprite absolute top-0 left-0 ${t} ${a}`}),e.jsx(h,{className:"bg-metallicBlueHalfbrite absolute top-0 right-0 pl-oneScaledPix block",children:s})]}),xt=()=>{const t=j(o=>o.levelEditor.campaignInProgress),s=T();return e.jsxs("div",{className:"flex fixed top-0 bottom-0 right-0 w-12 box-content text-white bg-metallicBlueHalfbrite p-half gap-1 flex-wrap justify-start overflow-auto",children:[e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"Campaign"}),e.jsx(Xe,{campaign:t,onRoomSelect:o=>{s(Ye(o))}})]}),e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"Room"}),e.jsx(mt,{}),e.jsx(ut,{})]}),e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"Edit"}),e.jsx(dt,{}),e.jsx(pt,{})]}),e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"Monsters"}),e.jsx(n,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}},children:e.jsx("span",{className:`sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek" ${a}`})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"cyberman",activated:"on",movement:"towards-on-shortest-axis-xy4",startDirection:"towards"}},children:e.jsx(w,{topClasses:"texture-cyberman.towards [button:hover_&]:texture-cyberman.right",bottomClasses:"texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold"})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right ${a}`})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"helicopterBug",activated:"on",movement:"patrol-randomly-xy8"}},children:e.jsx("span",{className:`sprite texture-helicopterBug.1 [button:hover_&]:texture-animated-helicopterBug ${a}`})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right ${a}`})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"homingBot",activated:"on",movement:"towards-tripped-on-axis-xy4"}},children:e.jsx("span",{className:`sprite texture-headlessBase [button:hover_&]:texture-headlessBase.all ${a}`})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"computerBot",activated:"on",movement:"patrol-randomly-xy4-and-reverse"}},children:e.jsx(w,{topClasses:"texture-computerBot.towards [button:hover_&]:texture-computerBot.right"})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"monkey",activated:"on",movement:"patrol-randomly-xy4"}},children:e.jsx(w,{topClasses:"texture-monkey.towards [button:hover_&]:texture-monkey.right"})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"elephant",activated:"on",movement:"patrol-randomly-xy4"}},children:e.jsx(w,{topClasses:"texture-elephant.towards [button:hover_&]:texture-elephant.right"})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"turn-to-player",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-elephant.towards [button:hover_&]:texture-elephant.right ${a}`})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"emperorsGuardian",activated:"while-player-near",movement:"towards-analogue-unless-planet-crowns"}},className:"inline relative",children:e.jsx(w,{topClasses:"texture-ball",bottomClasses:"texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold"})}),e.jsx(n,{itemTool:{type:"monster",config:{which:"emperor",activated:"while-player-near",movement:"towards-analogue"}},children:e.jsx("span",{className:`sprite texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold ${a}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"Blocks"}),e.jsx(n,{itemTool:{type:"block",config:{style:"artificial"}},children:e.jsx("span",{className:`sprite texture-block.artificial ${a}`})}),e.jsx(n,{itemTool:{type:"block",config:{style:"organic"}},children:e.jsx("span",{className:`sprite texture-block.organic ${a}`})}),e.jsx(n,{itemTool:{type:"block",config:{style:"tower"}},children:e.jsx("span",{className:`sprite texture-tower ${a}`})}),e.jsx(n,{itemTool:{type:"block",config:{style:"book"}},children:e.jsx("span",{className:`sprite texture-book.x ${a}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"Pickups"}),e.jsxs(N,{children:[e.jsx(n,{itemTool:{type:"pickup",config:{gives:"extra-life"}},children:e.jsx(b,{iconClasses:"texture-whiteRabbit",text:"2"})}),e.jsx(n,{itemTool:{type:"pickup",config:{gives:"shield"}},children:e.jsx(b,{iconClasses:"texture-whiteRabbit",text:"ðŸ›¡"})}),e.jsx(n,{itemTool:{type:"pickup",config:{gives:"jumps"}},children:e.jsx(b,{iconClasses:"texture-whiteRabbit",text:"â™¨"})}),e.jsx(n,{itemTool:{type:"pickup",config:{gives:"fast"}},children:e.jsx(b,{iconClasses:"texture-whiteRabbit",text:"âš¡"})})]}),e.jsx(n,{itemTool:{type:"pickup",config:{gives:"bag"}},children:e.jsx("span",{className:`sprite texture-bag ${a}`})}),e.jsx(n,{itemTool:{type:"pickup",config:{gives:"hooter"}},children:e.jsx("span",{className:`sprite texture-hooter ${a}`})}),e.jsx(n,{itemTool:{type:"pickup",config:{gives:"doughnuts"}},children:e.jsx("span",{className:`sprite texture-doughnuts ${a}`})}),e.jsx(n,{itemTool:{type:"pickup",config:{gives:"crown",planet:"blacktooth"}},children:e.jsx("span",{className:`sprite texture-crown.blacktooth ${a}`})}),e.jsx(n,{itemTool:{type:"pickup",config:{gives:"scroll",page:"blacktooth"}},children:e.jsx("span",{className:`sprite texture-scroll ${a}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"misc."}),e.jsxs(n,{itemTool:{type:"lift",config:{top:11,bottom:0}},className:"inline relative",children:[e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.static ${a} [button:active_&]:top-oneScaledPix`}),e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.1 [button:hover_&]:texture-animated-lift ${a} [button:active_&]:top-oneScaledPix`})]}),e.jsxs(N,{children:[e.jsx(n,{itemTool:{type:"barrier",config:{axis:"x"}},children:e.jsx("span",{className:`sprite texture-barrier.x ${a}`})}),e.jsx(n,{itemTool:{type:"barrier",config:{axis:"y"}},children:e.jsx("span",{className:`sprite texture-barrier.y ${a}`})})]}),e.jsxs(N,{children:[e.jsx(n,{itemTool:{type:"conveyor",config:{direction:"away"}},children:e.jsx(b,{iconClasses:"texture-conveyor.y.1 [button:hover_&]:texture-animated-conveyor.y",text:"â†—"})}),e.jsx(n,{itemTool:{type:"conveyor",config:{direction:"towards"}},children:e.jsx(b,{iconClasses:"texture-conveyor.y.1 [button:hover_&]:texture-animated-reversed-conveyor.y",text:"â†™"})}),e.jsx(n,{itemTool:{type:"conveyor",config:{direction:"left"}},children:e.jsx(b,{iconClasses:"texture-conveyor.x.1 [button:hover_&]:texture-animated-conveyor.x",text:"â†–"})}),e.jsx(n,{itemTool:{type:"conveyor",config:{direction:"right"}},children:e.jsx(b,{iconClasses:"texture-conveyor.x.1 [button:hover_&]:texture-animated-reversed-conveyor.x",text:"â†˜"})})]}),e.jsx(n,{itemTool:{type:"teleporter",config:{toRoom:"(placeholder)",toPosition:te}},children:e.jsx("span",{className:`sprite texture-teleporter ${a}`})}),e.jsx(n,{itemTool:{type:"charles",config:k},children:e.jsx(w,{topClasses:"texture-charles.towards [button:hover_&]:texture-charles.right"})}),e.jsx(n,{itemTool:{type:"joystick",config:{controls:["(placeholder)"]}},children:e.jsx("span",{className:`sprite texture-joystick ${a}`})}),e.jsx(n,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:L}},children:e.jsx("span",{className:`sprite texture-switch.left [button:hover_&]:texture-switch.right ${a}`})}),e.jsx(n,{itemTool:{type:"ball",config:k},children:e.jsx("span",{className:`sprite texture-ball ${a}`})}),e.jsxs(N,{children:[e.jsx(n,{itemTool:{type:"portableBlock",config:{style:"cube"}},children:e.jsx("span",{className:`sprite texture-cube ${a}`})}),e.jsx(n,{itemTool:{type:"portableBlock",config:{style:"drum"}},children:e.jsx("span",{className:`sprite texture-drum ${a}`})}),e.jsx(n,{itemTool:{type:"portableBlock",config:{style:"sticks"}},children:e.jsx("span",{className:`sprite texture-sticks ${a}`})})]}),e.jsx(n,{itemTool:{type:"pushableBlock",config:{}},children:e.jsx("span",{className:`sprite texture-stepStool ${a}`})}),e.jsx(n,{itemTool:{type:"movingPlatform",config:{movement:"clockwise",activated:"on",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-sandwich ${a}`})}),e.jsx(n,{itemTool:{type:"spikes",config:k},children:e.jsx("span",{className:`sprite texture-spikes ${a}`})}),e.jsxs(N,{children:[e.jsx(n,{itemTool:{type:"deadlyBlock",config:{style:"volcano"}},children:e.jsx("span",{className:`sprite texture-volcano.1 [button:hover_&]:texture-animated-volcano ${a}`})}),e.jsx(n,{itemTool:{type:"deadlyBlock",config:{style:"toaster"}},children:e.jsx("span",{className:`sprite texture-toaster.off ${a}`})})]}),e.jsx(n,{itemTool:{type:"slidingBlock",config:{style:"puck"}},children:e.jsx("span",{className:`sprite texture-puck ${a}`})}),e.jsx(n,{itemTool:{type:"slidingDeadly",config:{style:"spikyBall",startingPhase:1}},children:e.jsx("span",{className:`sprite texture-spikyBall.1 [button:hover_&]:texture-spikyBall.2 ${a}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"Structure"}),e.jsx(n,{itemTool:{type:"door",config:{direction:"away",toRoom:"(placeholder)"}},children:e.jsx("span",{className:`sprite texture-door.frame.generic.x.whole ${a}`})}),e.jsx(n,{itemTool:{type:"wall",config:{direction:"away",tiles:["plain"]}},children:e.jsx("span",{className:`sprite texture-blacktooth.wall.plain.away ${a}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"Player"}),e.jsx(n,{itemTool:{type:"player",config:{which:"head"}},children:e.jsx("span",{className:`sprite texture-head.walking.towards.2 [button:hover_&]:texture-animated-head.walking.right ${a}`})}),e.jsx(n,{itemTool:{type:"player",config:{which:"heels"}},children:e.jsx("span",{className:`sprite texture-heels.walking.towards.2 [button:hover_&]:texture-animated-heels.walking.right ${a}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"NPCâ€™s"}),e.jsx(n,{itemTool:{type:"sceneryPlayer",config:{which:"head",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-head.walking.towards.2 [button:hover_&]:texture-animated-head.walking.right ${a}`})}),e.jsx(n,{itemTool:{type:"sceneryPlayer",config:{which:"heels",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-heels.walking.towards.2 [button:hover_&]:texture-animated-heels.walking.right ${a}`})}),e.jsx(n,{itemTool:{type:"sceneryPlayer",config:{which:"headOverHeels",startDirection:"towards"}},children:e.jsx(w,{topClasses:"texture-head.walking.towards.2 [button:hover_&]:texture-animated-head.walking.right",bottomClasses:"texture-heels.walking.towards.2 [button:hover_&]:texture-animated-heels.walking.right"})})]}),e.jsxs("div",{className:y,children:[e.jsx(h,{className:"w-full",children:"debug"}),e.jsx(Ze,{})]})]})},pe=p.createContext(null),ht=()=>{const[t,s]=p.useState(()=>D({roomJson:J(C.getState()),roomPickupsCollected:k,scrollsRead:k,isNewGame:!0})),o=j(J);return p.useEffect(()=>{const r=D({roomJson:o,roomPickupsCollected:k,scrollsRead:k,isNewGame:!0});s(r)},[o]),t},ft=({children:t})=>{const s=ht();return e.jsx(pe,{value:s,children:t})},E=()=>{const t=p.useContext(pe);if(t===null)throw new Error("no room state in context, or no context");return t},xe=p.createContext(null),gt=({children:t})=>{const[s,o]=p.useState(null);return p.useEffect(()=>{const r=new rt;return r.init({background:nt.pureBlack,sharedTicker:!0}).then(()=>{o(r)}),()=>{}},[]),s===null?null:e.jsx(xe,{value:s,children:t})},S=()=>p.useContext(xe),yt=(t,s)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:s},soundSettings:{mute:!0},pixiRenderer:t,gameState:void 0,paused:!1,colourised:!0,upscale:se(C.getState()),editor:!0}),K=(t,s,o)=>new it({room:t,general:yt(s,o)}),vt=()=>{const{renderer:t}=S(),s=je();if(!t)throw new Error("this should never be falsey (typescript violation)");const o=E(),[r,i]=p.useState(()=>K(o,t,s));return p.useEffect(()=>{const l=K(o,t,s);return i(l),()=>{l.destroy()}},[o,t,s]),r},R="cursor",q=({room:t,pointingAt:s,valid:o,includeCursor:r,previewItems:i})=>{const{face:l,position:d}=s;for(const u of i)be({room:t,item:u});if(r){const u=we(R,t.items);u?(u.state.position=d,u.state.face=l,u.state.valid=o):t.items[R]={type:"cursor",id:R,state:{...Ce(),face:l,position:d,valid:o},config:{},aabb:ke}}else delete t.items[R]},_=t=>{for(const s of H(t.items))s.isCursorPreview&&delete t.items[s.id]};let jt=0;const he=(t,s,o)=>{if(t.face==="up")return z(t.position);if(o.type==="door"){const i=s.items[t.itemId];if(i.type!=="wall")return;const{config:l,aabb:d,state:{position:u}}=i,f={x:1,y:1,...l.times},c=Ne(F(l.direction)),m=F(l.direction);if(f[c]<2)return;const x=u[c],g=u[c]+d[c]-Te,v=u.z,I=u.z+d.z-Ie,fe={[c]:Math.max(Math.min(t.position[c],g),x),[m]:t.position[m],z:Math.max(Math.min(t.position.z,I),v)};return z(fe)}const r=Re[t.face];return re(z(t.position),r)},V=(t,s,o)=>{const r=[...H(s.items).filter(f=>oe(f)&&f.type!=="cursor"&&!f.isCursorPreview)],i=(f,c,m)=>{const x=Pe(`cursor/${jt++}`,{type:f,config:c,position:m},s.roomJson).toArray();return x.forEach(g=>{g.isCursorPreview=!0}),x},l=he(t,s,o);if(l===void 0)return;if(o.type==="door"){const f=s.items[t.itemId];if(f.type!=="wall")return;const c=f.config.direction;return i("door",{...o.config,direction:c},l)}const d=i(o.type,o.config,l);return d.some(f=>{const c=Se(f,r);return!at(c)})?void 0:d},bt=({x:t,y:s})=>o=>{const{bottomCentre:r,topLeft:i,topRight:l}=ue(o.state.position,o.aabb);return!(t<i.x||t>l.x||s<l.y-(l.x-t)/2||s<i.y-(t-i.x)/2||s>r.y-(t-r.x)/2||s>r.y-(r.x-t)/2)},wt=(t,{x:s,y:o},r)=>{if(r.type==="item"&&r.item.type==="door"&&t.type==="wall")return Be(t.config.direction);const{bottomCentre:i,topLeft:l,topRight:d}=ue(t.state.position,t.aabb);return o<l.y-(l.x-s)/2?o<d.y-(s-d.x)/2?"up":"right":s<i.x?"towards":"right"},Y=t=>t.fixedZIndex!==void 0,kt=t=>{if(t.every(Y))return t.toSorted((l,d)=>d.fixedZIndex-l.fixedZIndex).at(0);const s=t.filter(l=>!Y(l));if(s.length===0)return;if(s.length===1)return s[0];const o=Object.fromEntries(s.map(l=>[l.id,l])),r=lt(o),{order:i}=ct(r,o);return o[i[0]]},Ct=({state:{position:t},aabb:s},o,r,i)=>{let l=te,d;switch(o){case"up":l={z:s.z},d="xy";break;case"down":d="xy";break;case"towards":d="xz";break;case"away":l={y:s.y},d="xz";break;case"left":l={x:s.x},d="yz";break;case"right":d="yz";break;default:throw new Error('unexpected face "'+o+'"')}const u=$e(r,re(t,l),d),c=i.type==="item"&&i.item.type==="door"?A.w:A.w/2,m=A.h,x=c/2,g=m/2;return{x:d==="yz"?Math.round(u.x/c)*c:Math.floor((u.x-x)/c)*c,y:d==="xz"?Math.round(u.y/c)*c:Math.floor((u.y-x)/c)*c,z:d==="xy"?Math.round(u.z/m)*m:Math.floor((u.z+g)/m)*m}},St=t=>s=>{const o=oe(s)&&s.type!=="cursor"&&!s.isCursorPreview;return t.type==="item"&&t.item.type==="door"?o&&s.type==="wall":o},Nt=(t,s,o)=>{const r=kt(Array.from(H(s.items).filter(St(o)).filter(bt(t))));if(r){const i=wt(r,t,o);return{itemId:r.id,face:i,position:Ct(r,i,t,o)}}else return},Tt=(t,s)=>{const o=t.cssUpscale*t.gameEngineUpscale;return{x:s.x/o-t.gameEngineScreenSize.x/2,y:s.y/o-t.gameEngineScreenSize.y+16}},It=t=>{const s=S(),o=$(se),r=T(),i=E(),l=p.useRef(void 0);p.useEffect(()=>{if(s.stage.eventMode="none",t===null)return;const d=c=>{const m=Tt(o,c),x=P(C.getState()),g=Nt(m,i,x);if(!Q(g,l.current))if(l.current=g,g!==void 0)switch(x.type){case"item":{const v=V(g,i,x.item),I=v!==void 0;_(i),q({room:i,pointingAt:g,valid:I,includeCursor:!I,previewItems:v??L});break}case"pointer":{_(i),q({room:i,pointingAt:g,valid:!0,includeCursor:!0,previewItems:L});const v=i.items[g.itemId]?.jsonItemId;i.editor={...i.editor,hoveredJsonItemId:v};break}}else _(i)},u=c=>{const m=P(C.getState());switch(m.type){case"item":{const x=l.current;if(x===void 0||V(x,i,m.item)===void 0)return;const v=i.items[x.itemId];r(et({blockPosition:he(x,i,m.item),pointedAtItem:{type:v.type,config:v.config,jsonItemId:v.jsonItemId}}));break}case"pointer":{const x=l.current;if(!x)return;const{jsonItemId:g}=i.items[x.itemId];r(Qe({jsonItemId:g,additive:c.ctrlKey||c.metaKey}));break}}},f=c=>{const m=c.key;(m==="Backspace"||m==="Delete")&&r(tt()),(m==="z"||m==="Z")&&(c.ctrlKey||c.metaKey)&&C.dispatch(c.shiftKey?de():ce())};return t.addEventListener("mousemove",d),t.addEventListener("click",u),window.addEventListener("keyup",f),()=>{t.removeEventListener("mousemove",d),t.removeEventListener("click",u),window.removeEventListener("keyup",f)}},[s.stage,o,t,r,i])},Rt=t=>{const s=E();p.useEffect(()=>{let o=0;const r=({deltaMS:i})=>{if(t.destroyed)return;t.renderContext.room!==s&&console.warn("room renderer does not have the current room");const l=new Set(Ee(s.items));s.roomTime+=i,t.tick({deltaMS:i,movedItems:l,progression:o++})};return O.shared.add(r),()=>{O.shared.remove(r)}},[t,s])},Pt=t=>{const s=S();p.useEffect(()=>{if(t)return t.appendChild(s.canvas),()=>{t.removeChild(s.canvas)}},[t,s])},Bt=()=>{const t=S(),s=$(o=>o.upscale.upscale.gameEngineUpscale);t.stage.scale=s},$t=()=>{const t=S(),s=$(ze);p.useEffect(()=>{t.renderer?.resize(s.x,s.y)},[t.renderer,s])},Et=t=>{const s=S(),[o]=p.useState(()=>new Ae),r=$(_e);p.useEffect(()=>{if(t.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return o.addChild(t.output.graphics),s.stage.addChild(o),()=>{s.stage.removeChild(o),o.removeChild(t.output.graphics)}},[t,s,o]),p.useEffect(()=>{o.x=r.x/2,o.y=r.y-16},[o,r])},zt=()=>{const t=E(),s=j(st);p.useEffect(()=>{t.editor||(t.editor={}),t.editor.selectedJsonItemId=s},[t,s])};Me.defaultOptions.scaleMode="nearest";const At=()=>{const t=vt(),[s,o]=p.useState(null);$t(),Et(t),Rt(t),It(s),Pt(s),Bt(),zt();const r=Le();return e.jsx("div",{style:r,ref:o})},Ut=()=>(He(),De(),e.jsxs(e.Fragment,{children:[e.jsx("title",{children:"Hoh Editor"}),e.jsx(gt,{children:e.jsx(ft,{children:e.jsx(At,{})})}),e.jsx(ee,{scaleFactor:2,children:e.jsx(xt,{})})]}));export{Ut as default};
