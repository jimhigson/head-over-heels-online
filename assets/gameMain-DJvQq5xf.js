const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-CVoTP_Fa.js","assets/index-CdgbSTDn.js","assets/index-BFMhuovJ.css","assets/colorToUniform-ctgBpyc5.js","assets/SharedSystems-BzXCbqvq.js","assets/Graphics-D_fxLPkm.js","assets/WebGLRenderer-BRS-8dHY.js"])))=>i.map(i=>d[i]);
import{u as Bn,y as tt,z as he,e as nt,E as ce,c as Xn,C as m,d as R,v as Fe,Y as T,D as je,a4 as pt,l as $n,R as Yt,K as Oe,a as me,b as ge,U as Ln,a5 as b,a6 as Wt,a7 as Un,a8 as qt,a9 as Ht,aa as Nn,ab as Ye,ac as mt,ad as We,ae as q,af as Vn,ag as ue,ah as X,ai as V,aj as ye,ak as Zt,al as qe,am as Gn,an as K,ao as k,ap as He,aq as $,ar as jn,as as Jt,at as ve,au as W,av as Yn,aw as Q,ax as F,ay as z,az as Wn,aA as Ae,aB as qn,aC as ae,aD as gt,aE as Me,aF as Hn,aG as Zn,aH as yt,aI as Jn,aJ as te,aK as De,aL as Ze,aM as rt,aN as ot,aO as Kn,aP as it,aQ as de,aR as Kt,aS as fe,aT as Qt,aU as H,aV as Z,aW as ee,aX as en,aY as vt,aZ as Qn,a_ as st,a$ as L,b0 as er,b1 as tr,b2 as nr,b3 as tn,b4 as rr,b5 as nn,b6 as or,b7 as ir,b8 as sr,b9 as rn,ba as ar,bb as lr,bc as cr,bd as ur,be as dr,bf as x,bg as hr,bh as Y,bi as le,bj as fr,bk as Re,bl as pr,bm as on,bn as ne,bo as mr,bp as gr,bq as xt,br as Be,bs as yr,bt as vr,bu as xr,bv as br,bw as wr,bx as Cr,by as Tr}from"./index-CdgbSTDn.js";import{S as kr,T as _e,G as J}from"./Graphics-D_fxLPkm.js";const sn=class Je extends Bn{constructor(t){t={...Je.defaultOptions,...t},super(t),this.enabled=!0,this._state=kr.for2d(),this.blendMode=t.blendMode,this.padding=t.padding,typeof t.antialias=="boolean"?this.antialias=t.antialias?"on":"off":this.antialias=t.antialias,this.resolution=t.resolution,this.blendRequired=t.blendRequired,this.addResource("uTexture",0,1)}apply(t,n,r,o){t.applyFilter(this,n,r,o)}get blendMode(){return this._state.blendMode}set blendMode(t){this._state.blendMode=t}static from(t){const{gpu:n,gl:r,...o}=t;let i,s;return n&&(i=tt.from(n)),r&&(s=he.from(r)),new Je({gpuProgram:i,glProgram:s,...o})}};sn.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1};let pe=sn;const Ke=[];nt.handleByNamedList(ce.Environment,Ke);async function Sr(e){if(!e)for(let t=0;t<Ke.length;t++){const n=Ke[t];if(n.value.test()){await n.value.load();return}}}let re;function Pr(){if(typeof re=="boolean")return re;try{re=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{re=!1}return re}var an=(e=>(e[e.NONE=0]="NONE",e[e.COLOR=16384]="COLOR",e[e.STENCIL=1024]="STENCIL",e[e.DEPTH=256]="DEPTH",e[e.COLOR_DEPTH=16640]="COLOR_DEPTH",e[e.COLOR_STENCIL=17408]="COLOR_STENCIL",e[e.DEPTH_STENCIL=1280]="DEPTH_STENCIL",e[e.ALL=17664]="ALL",e))(an||{});class Fr{constructor(t){this.items=[],this._name=t}emit(t,n,r,o,i,s,a,l){const{name:c,items:d}=this;for(let u=0,f=d.length;u<f;u++)d[u][c](t,n,r,o,i,s,a,l);return this}add(t){return t[this._name]&&(this.remove(t),this.items.push(t)),this}remove(t){const n=this.items.indexOf(t);return n!==-1&&this.items.splice(n,1),this}contains(t){return this.items.indexOf(t)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const Or=["init","destroy","contextChange","resolutionChange","reset","renderEnd","renderStart","render","update","postrender","prerender"],ln=class cn extends Xn{constructor(t){super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=t.type,this.name=t.name,this.config=t;const n=[...Or,...this.config.runners??[]];this._addRunners(...n),this._unsafeEvalCheck()}async init(t={}){const n=t.skipExtensionImports===!0?!0:t.manageImports===!1;await Sr(n),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const r in this._systemsHash)t={...this._systemsHash[r].constructor.defaultOptions,...t};t={...cn.defaultOptions,...t},this._roundPixels=t.roundPixels?1:0;for(let r=0;r<this.runners.init.items.length;r++)await this.runners.init.items[r].init(t);this._initOptions=t}render(t,n){let r=t;if(r instanceof m&&(r={container:r},n&&(R(Fe,"passing a second argument is deprecated, please use render options instead"),r.target=n.renderTexture)),r.target||(r.target=this.view.renderTarget),r.target===this.view.renderTarget&&(this._lastObjectRendered=r.container,r.clearColor=this.background.colorRgba),r.clearColor){const o=Array.isArray(r.clearColor)&&r.clearColor.length===4;r.clearColor=o?r.clearColor:T.shared.setValue(r.clearColor).toArray()}r.transform||(r.container.updateLocalTransform(),r.transform=r.container.localTransform),this.runners.prerender.emit(r),this.runners.renderStart.emit(r),this.runners.render.emit(r),this.runners.renderEnd.emit(r),this.runners.postrender.emit(r)}resize(t,n,r){const o=this.view.resolution;this.view.resize(t,n,r),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),r!==void 0&&r!==o&&this.runners.resolutionChange.emit(r)}clear(t={}){const n=this;t.target||(t.target=n.renderTarget.renderTarget),t.clearColor||(t.clearColor=this.background.colorRgba),t.clear??(t.clear=an.ALL);const{clear:r,clearColor:o,target:i}=t;T.shared.setValue(o??this.background.colorRgba),n.renderTarget.clear(i,r,T.shared.toArray())}get resolution(){return this.view.resolution}set resolution(t){this.view.resolution=t,this.runners.resolutionChange.emit(t)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...t){t.forEach(n=>{this.runners[n]=new Fr(n)})}_addSystems(t){let n;for(n in t){const r=t[n];this._addSystem(r.value,r.name)}}_addSystem(t,n){const r=new t(this);if(this[n])throw new Error(`Whoops! The name "${n}" is already in use`);this[n]=r,this._systemsHash[n]=r;for(const o in this.runners)this.runners[o].add(r);return this}_addPipes(t,n){const r=n.reduce((o,i)=>(o[i.name]=i.value,o),{});t.forEach(o=>{const i=o.value,s=o.name,a=r[s];this.renderPipes[s]=new i(this,a?new a:null)})}destroy(t=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(t),Object.values(this.runners).forEach(n=>{n.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(t){return this.textureGenerator.generateTexture(t)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!Pr())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}};ln.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let un=ln,xe;function _r(e){return xe!==void 0||(xe=(()=>{const t={stencil:!0,failIfMajorPerformanceCaveat:e??un.defaultOptions.failIfMajorPerformanceCaveat};try{if(!je.get().getWebGLRenderingContext())return!1;let r=je.get().createCanvas().getContext("webgl",t);const o=!!r?.getContextAttributes()?.stencil;if(r){const i=r.getExtension("WEBGL_lose_context");i&&i.loseContext()}return r=null,o}catch{return!1}})()),xe}let be;async function Ir(e={}){return be!==void 0||(be=await(async()=>{const t=je.get().getNavigator().gpu;if(!t)return!1;try{return await(await t.requestAdapter(e)).requestDevice(),!0}catch{return!1}})()),be}const bt=["webgl","webgpu","canvas"];async function zr(e){let t=[];e.preference?(t.push(e.preference),bt.forEach(i=>{i!==e.preference&&t.push(i)})):t=bt.slice();let n,r={};for(let i=0;i<t.length;i++){const s=t[i];if(s==="webgpu"&&await Ir()){const{WebGPURenderer:a}=await pt(async()=>{const{WebGPURenderer:l}=await import("./WebGPURenderer-CVoTP_Fa.js");return{WebGPURenderer:l}},__vite__mapDeps([0,1,2,3,4,5]));n=a,r={...e,...e.webgpu};break}else if(s==="webgl"&&_r(e.failIfMajorPerformanceCaveat??un.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:a}=await pt(async()=>{const{WebGLRenderer:l}=await import("./WebGLRenderer-BRS-8dHY.js");return{WebGLRenderer:l}},__vite__mapDeps([6,1,2,3,4,5]));n=a,r={...e,...e.webgl};break}else if(s==="canvas")throw r={...e},new Error("CanvasRenderer is not yet implemented")}if(delete r.webgpu,delete r.webgl,!n)throw new Error("No available renderer for the current environment");const o=new n;return await o.init(r),o}const dn="8.4.1";class hn{static init(){globalThis.__PIXI_APP_INIT__?.(this,dn)}static destroy(){}}hn.extension=ce.Application;class Ar{constructor(t){this._renderer=t}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,dn)}destroy(){this._renderer=null}}Ar.extension={type:[ce.WebGLSystem,ce.WebGPUSystem],name:"initHook",priority:-10};const fn=class Qe{constructor(...t){this.stage=new m,t[0]!==void 0&&R(Fe,"Application constructor options are deprecated, please use Application.init() instead.")}async init(t){t={...t},this.renderer=await zr(t),Qe._plugins.forEach(n=>{n.init.call(this,t)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return R(Fe,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(t=!1,n=!1){const r=Qe._plugins.slice(0);r.reverse(),r.forEach(o=>{o.destroy.call(this)}),this.stage.destroy(n),this.stage=null,this.renderer.destroy(t),this.renderer=null}};fn._plugins=[];let pn=fn;nt.handleByList(ce.Application,pn._plugins);nt.add(hn);var Mr=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,Er=`
in vec2 vTextureCoord;

out vec4 finalColor;

uniform float uAlpha;
uniform sampler2D uTexture;

void main()
{
    finalColor =  texture(uTexture, vTextureCoord) * uAlpha;
}
`,wt=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct AlphaUniforms {
  uAlpha:f32,
};

@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;

@group(1) @binding(0) var<uniform> alphaUniforms : AlphaUniforms;

struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>
  };

fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

fn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  
}

fn getSize() -> vec2<f32>
{
  return gfu.uGlobalFrame.zw;
}
  
@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition)
  );
}

@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
  @builtin(position) position: vec4<f32>
) -> @location(0) vec4<f32> {
 
    var sample = textureSample(uTexture, uSampler, uv);
    
    return sample * alphaUniforms.uAlpha;
}`;const mn=class gn extends pe{constructor(t){t={...gn.defaultOptions,...t};const n=tt.from({vertex:{source:wt,entryPoint:"mainVertex"},fragment:{source:wt,entryPoint:"mainFragment"}}),r=he.from({vertex:Mr,fragment:Er,name:"alpha-filter"}),{alpha:o,...i}=t,s=new $n({uAlpha:{value:o,type:"f32"}});super({...i,gpuProgram:n,glProgram:r,resources:{alphaUniforms:s}})}get alpha(){return this.resources.alphaUniforms.uniforms.uAlpha}set alpha(t){this.resources.alphaUniforms.uniforms.uAlpha=t}};mn.defaultOptions={alpha:1};let Dr=mn;const yn={5:[.153388,.221461,.250301],7:[.071303,.131514,.189879,.214607],9:[.028532,.067234,.124009,.179044,.20236],11:[.0093,.028002,.065984,.121703,.175713,.198596],13:[.002406,.009255,.027867,.065666,.121117,.174868,.197641],15:[489e-6,.002403,.009246,.02784,.065602,.120999,.174697,.197448]},Rr=["in vec2 vBlurTexCoords[%size%];","uniform sampler2D uTexture;","out vec4 finalColor;","void main(void)","{","    finalColor = vec4(0.0);","    %blur%","}"].join(`
`);function Br(e){const t=yn[e],n=t.length;let r=Rr,o="";const i="finalColor += texture(uTexture, vBlurTexCoords[%index%]) * %value%;";let s;for(let a=0;a<e;a++){let l=i.replace("%index%",a.toString());s=a,a>=n&&(s=e-a-1),l=l.replace("%value%",t[s].toString()),o+=l,o+=`
`}return r=r.replace("%blur%",o),r=r.replace("%size%",e.toString()),r}const Xr=`
    in vec2 aPosition;

    uniform float uStrength;

    out vec2 vBlurTexCoords[%size%];

    uniform vec4 uInputSize;
    uniform vec4 uOutputFrame;
    uniform vec4 uOutputTexture;

    vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

    vec2 filterTextureCoord( void )
    {
        return aPosition * (uOutputFrame.zw * uInputSize.zw);
    }

    void main(void)
    {
        gl_Position = filterVertexPosition();

        float pixelStrength = uInputSize.%dimension% * uStrength;

        vec2 textureCoord = filterTextureCoord();
        %blur%
    }`;function $r(e,t){const n=Math.ceil(e/2);let r=Xr,o="",i;t?i="vBlurTexCoords[%index%] =  textureCoord + vec2(%sampleIndex% * pixelStrength, 0.0);":i="vBlurTexCoords[%index%] =  textureCoord + vec2(0.0, %sampleIndex% * pixelStrength);";for(let s=0;s<e;s++){let a=i.replace("%index%",s.toString());a=a.replace("%sampleIndex%",`${s-(n-1)}.0`),o+=a,o+=`
`}return r=r.replace("%blur%",o),r=r.replace("%size%",e.toString()),r=r.replace("%dimension%",t?"z":"w"),r}function Lr(e,t){const n=$r(t,e),r=Br(t);return he.from({vertex:n,fragment:r,name:`blur-${e?"horizontal":"vertical"}-pass-filter`})}var Ur=`

struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct BlurUniforms {
  uStrength:f32,
};

@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;

@group(1) @binding(0) var<uniform> blurUniforms : BlurUniforms;


struct VSOutput {
    @builtin(position) position: vec4<f32>,
    %blur-struct%
  };

fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

fn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  
}

fn getSize() -> vec2<f32>
{
  return gfu.uGlobalFrame.zw;
}


@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {

  let filteredCord = filterTextureCoord(aPosition);

  let pixelStrength = gfu.uInputSize.%dimension% * blurUniforms.uStrength;

  return VSOutput(
   filterVertexPosition(aPosition),
    %blur-vertex-out%
  );
}

@fragment
fn mainFragment(
  @builtin(position) position: vec4<f32>,
  %blur-fragment-in%
) -> @location(0) vec4<f32> {

    var   finalColor = vec4(0.0);

    %blur-sampling%

    return finalColor;
}`;function Nr(e,t){const n=yn[t],r=n.length,o=[],i=[],s=[];for(let u=0;u<t;u++){o[u]=`@location(${u}) offset${u}: vec2<f32>,`,e?i[u]=`filteredCord + vec2(${u-r+1} * pixelStrength, 0.0),`:i[u]=`filteredCord + vec2(0.0, ${u-r+1} * pixelStrength),`;const f=u<r?u:t-u-1,p=n[f].toString();s[u]=`finalColor += textureSample(uTexture, uSampler, offset${u}) * ${p};`}const a=o.join(`
`),l=i.join(`
`),c=s.join(`
`),d=Ur.replace("%blur-struct%",a).replace("%blur-vertex-out%",l).replace("%blur-fragment-in%",a).replace("%blur-sampling%",c).replace("%dimension%",e?"z":"w");return tt.from({vertex:{source:d,entryPoint:"mainVertex"},fragment:{source:d,entryPoint:"mainFragment"}})}const vn=class xn extends pe{constructor(t){t={...xn.defaultOptions,...t};const n=Lr(t.horizontal,t.kernelSize),r=Nr(t.horizontal,t.kernelSize);super({glProgram:n,gpuProgram:r,resources:{blurUniforms:{uStrength:{value:0,type:"f32"}}},...t}),this.horizontal=t.horizontal,this._quality=0,this.quality=t.quality,this.blur=t.strength,this._uniforms=this.resources.blurUniforms.uniforms}apply(t,n,r,o){if(this._uniforms.uStrength=this.strength/this.passes,this.passes===1)t.applyFilter(this,n,r,o);else{const i=_e.getSameSizeTexture(n);let s=n,a=i;this._state.blend=!1;const l=t.renderer.type===Yt.WEBGPU;for(let c=0;c<this.passes-1;c++){t.applyFilter(this,s,a,c===0?!0:l);const d=a;a=s,s=d}this._state.blend=!0,t.applyFilter(this,s,r,o),_e.returnTexture(i)}}get blur(){return this.strength}set blur(t){this.padding=1+Math.abs(t)*2,this.strength=t}get quality(){return this._quality}set quality(t){this._quality=t,this.passes=t}};vn.defaultOptions={strength:8,quality:4,kernelSize:5};let Xe=vn;class bn extends pe{constructor(...t){let n=t[0]??{};typeof n=="number"&&(R(Fe,"BlurFilter constructor params are now options object. See params: { strength, quality, resolution, kernelSize }"),n={strength:n},t[1]!==void 0&&(n.quality=t[1]),t[2]!==void 0&&(n.resolution=t[2]||"inherit"),t[3]!==void 0&&(n.kernelSize=t[3])),n={...Xe.defaultOptions,...n};const{strength:r,strengthX:o,strengthY:i,quality:s,...a}=n;super({...a,compatibleRenderers:Yt.BOTH,resources:{}}),this._repeatEdgePixels=!1,this.blurXFilter=new Xe({horizontal:!0,...n}),this.blurYFilter=new Xe({horizontal:!1,...n}),this.quality=s,this.strengthX=o??r,this.strengthY=i??r,this.repeatEdgePixels=!1}apply(t,n,r,o){const i=Math.abs(this.blurXFilter.strength),s=Math.abs(this.blurYFilter.strength);if(i&&s){const a=_e.getSameSizeTexture(n);this.blurXFilter.blendMode="normal",this.blurXFilter.apply(t,n,a,!0),this.blurYFilter.blendMode=this.blendMode,this.blurYFilter.apply(t,a,r,o),_e.returnTexture(a)}else s?(this.blurYFilter.blendMode=this.blendMode,this.blurYFilter.apply(t,n,r,o)):(this.blurXFilter.blendMode=this.blendMode,this.blurXFilter.apply(t,n,r,o))}updatePadding(){this._repeatEdgePixels?this.padding=0:this.padding=Math.max(Math.abs(this.blurXFilter.blur),Math.abs(this.blurYFilter.blur))*2}get strength(){if(this.strengthX!==this.strengthY)throw new Error("BlurFilter's strengthX and strengthY are different");return this.strengthX}set strength(t){this.blurXFilter.blur=this.blurYFilter.blur=t,this.updatePadding()}get quality(){return this.blurXFilter.quality}set quality(t){this.blurXFilter.quality=this.blurYFilter.quality=t}get strengthX(){return this.blurXFilter.blur}set strengthX(t){this.blurXFilter.blur=t,this.updatePadding()}get strengthY(){return this.blurYFilter.blur}set strengthY(t){this.blurYFilter.blur=t,this.updatePadding()}get blur(){return R("8.3.0","BlurFilter.blur is deprecated, please use BlurFilter.strength instead."),this.strength}set blur(t){R("8.3.0","BlurFilter.blur is deprecated, please use BlurFilter.strength instead."),this.strength=t}get blurX(){return R("8.3.0","BlurFilter.blurX is deprecated, please use BlurFilter.strengthX instead."),this.strengthX}set blurX(t){R("8.3.0","BlurFilter.blurX is deprecated, please use BlurFilter.strengthX instead."),this.strengthX=t}get blurY(){return R("8.3.0","BlurFilter.blurY is deprecated, please use BlurFilter.strengthY instead."),this.strengthY}set blurY(t){R("8.3.0","BlurFilter.blurY is deprecated, please use BlurFilter.strengthY instead."),this.strengthY=t}get repeatEdgePixels(){return this._repeatEdgePixels}set repeatEdgePixels(t){this._repeatEdgePixels=t,this.updatePadding()}}bn.defaultOptions={strength:8,quality:4,kernelSize:5};class Ie extends Oe{constructor(...t){let n=t[0];Array.isArray(t[0])&&(n={textures:t[0],autoUpdate:t[1]});const{textures:r,autoUpdate:o,...i}=n,[s]=r;super({...i,texture:s instanceof me?s:s.texture}),this._textures=null,this._durations=null,this._autoUpdate=o??!0,this._isConnectedToTicker=!1,this.animationSpeed=1,this.loop=!0,this.updateAnchor=!1,this.onComplete=null,this.onFrameChange=null,this.onLoop=null,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=r}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(ge.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(ge.shared.add(this.update,this,Ln.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(t){this.stop(),this.currentFrame=t}gotoAndPlay(t){this.currentFrame=t,this.play()}update(t){if(!this._playing)return;const n=t.deltaTime,r=this.animationSpeed*n,o=this.currentFrame;if(this._durations!==null){let i=this._currentTime%1*this._durations[this.currentFrame];for(i+=r/60*1e3;i<0;)this._currentTime--,i+=this._durations[this.currentFrame];const s=Math.sign(this.animationSpeed*n);for(this._currentTime=Math.floor(this._currentTime);i>=this._durations[this.currentFrame];)i-=this._durations[this.currentFrame]*s,this._currentTime+=s;this._currentTime+=i/this._durations[this.currentFrame]}else this._currentTime+=r;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):o!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<o||this.animationSpeed<0&&this.currentFrame>o)&&this.onLoop(),this._updateTexture())}_updateTexture(){const t=this.currentFrame;this._previousFrame!==t&&(this._previousFrame=t,this.texture=this._textures[t],this.updateAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(){this.stop(),super.destroy(),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(t){const n=[];for(let r=0;r<t.length;++r)n.push(me.from(t[r]));return new Ie(n)}static fromImages(t){const n=[];for(let r=0;r<t.length;++r)n.push(me.from(t[r]));return new Ie(n)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(t){if(t[0]instanceof me)this._textures=t,this._durations=null;else{this._textures=[],this._durations=[];for(let n=0;n<t.length;n++)this._textures.push(t[n].texture),this._durations.push(t[n].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let t=Math.floor(this._currentTime)%this._textures.length;return t<0&&(t+=this._textures.length),t}set currentFrame(t){if(t<0||t>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${t}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const n=this.currentFrame;this._currentTime=t,n!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(t){t!==this._autoUpdate&&(this._autoUpdate=t,!this._autoUpdate&&this._isConnectedToTicker?(ge.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(ge.shared.add(this.update,this),this._isConnectedToTicker=!0))}}const Ct={x:.5,y:1},Tt=e=>typeof e!="string"&&Object.hasOwn(e,"frames"),h=e=>{if(typeof e=="string")return h({texture:e});{const{anchor:t,flipX:n,pivot:r,x:o,y:i}=e;let s;if(Tt(e)?s=Vr(e):s=new Oe(b.textures[e.texture]),t===void 0&&r===void 0)if(Tt(e))s.anchor=Ct;else{const a=b.data.frames[e.texture].frame;a.pivot!==void 0?s.pivot=a.pivot:s.anchor=Ct}else t!==void 0&&(s.anchor=t),r!==void 0&&(s.pivot=r);return o!==void 0&&(s.x=o),i!==void 0&&(s.y=i),s.eventMode="static",n===!0&&(s.scale.x=-1),s}};function Vr({frames:e,animationSpeed:t,reverse:n,playOnce:r}){const o=e.map(s=>({texture:s,time:Wt}));n&&o.reverse();const i=new Ie(o);return i.animationSpeed=t||Un,i.play(),r!==void 0&&(i.loop=!1,i.onComplete=()=>{i.stop(),r==="and-destroy"&&(i.visible=!1)}),i}const Gr=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Å","Ä","Ö","0","1","2","3","4","5","6","7","8","9","!","@","#","$","%","^","&","*","(",")","-","_","=","+","[","]","{","}",";",":","'",'"',",",".","/","<",">","?","\\","|"," ","Enter","Shift","Control","`","~","Tab","Backspace","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Numpad0","Numpad1","Numpad2","Numpad3","Numpad4","Numpad5","Numpad6","Numpad7","Numpad8","Numpad9","NumpadAdd","NumpadSubtract","NumpadMultiply","NumpadDivide","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"],kt=e=>Gr.includes(e),wn=[...Ht,"jump","fire","carry","swop","hold"],jr=()=>({...qt(wn.map(e=>[e,!1])),windowFocus:!0}),N={right:["P"],towards:["A"],left:["O"],away:["Q"],jump:[" ","M"],carry:["C","M"],fire:["N"],swop:["Enter","S"],hold:["H"]},Yr={right:["ArrowRight",...N.right],towards:["ArrowDown",...N.towards],left:["ArrowLeft",...N.left],away:["ArrowUp",...N.away],jump:["`",...N.jump],carry:["Shift","`",...N.carry],fire:["Control",...N.fire],swop:N.swop,hold:["F8",...N.hold]};function*St(e,t){for(const[n,r]of Nn(e))r.includes(t)&&(yield n)}const Pt=e=>e.length===1?e.toUpperCase():e,Wr=({keyAssignment:e,inputState:t,onInputStateChange:n})=>{const r=({key:a})=>{const l=Pt(a);if(!kt(l)){console.log("do not recognise key: ",l);return}for(const c of St(e,l))t[c]=!0;n?.(t)},o=({key:a})=>{const l=Pt(a);if(kt(l)){for(const c of St(e,l))t[c]=!1;n?.(t)}},i=()=>{t.windowFocus=!0,n?.(t)},s=()=>{t.windowFocus=!1;for(const a of wn)t[a]=!1;n?.(t)};return window.focus(),window.addEventListener("keydown",r,!1),window.addEventListener("keyup",o,!1),window.addEventListener("focus",i,!1),()=>{window.removeEventListener("keydown",r,!1),window.removeEventListener("keyup",o,!1),window.removeEventListener("focus",i,!1),window.removeEventListener("blur",s,!1)}};function qr(e){return{all:e=e||new Map,on:function(t,n){var r=e.get(t);r?r.push(n):e.set(t,[n])},off:function(t,n){var r=e.get(t);r&&(n?r.splice(r.indexOf(n)>>>0,1):e.set(t,[]))},emit:function(t,n){var r=e.get(t);r&&r.slice().map(function(o){o(n)}),(r=e.get("*"))&&r.slice().map(function(o){o(t,n)})}}}const Hr=e=>{const t={};for(const n of Object.values(e.rooms))for(const r of Object.values(n.items))if(r.type==="player"){const{which:o}=r.config;t[o]=n.id}if(t.head===void 0&&t.heels===void 0)throw new Error("couldn't find either head or heels in campaign");return t},Zr=(e,t)=>{const n=Hr(e),r=qt(Object.keys(e.rooms).map(s=>[s,{}])),o=n.head&&Ye(e.rooms[n.head],r[n.head]),i=n.heels===n.head?o:n.heels&&Ye(e.rooms[n.heels],r[n.heels]);return{keyAssignment:Yr,currentCharacterName:n.head===void 0?"heels":"head",characterRooms:{head:o===void 0?void 0:{room:o,entryState:mt(o.items.head)},heels:i===void 0?void 0:{room:i,entryState:mt(i.items.heels)}},inputState:jr(),renderOptions:t,campaign:e,events:qr(),pickupsCollected:r,gameTime:0,progression:0,gameSpeed:1}},Jr=e=>{let t=1;return{get curUpscale(){return t},rescale(){if(e.renderer.width===0||e.renderer.height===0)throw new Error;const n=Math.floor(Math.min(e.renderer.width/We.width,e.renderer.height/We.height)),r={x:Math.round(e.renderer.width/n),y:Math.round(e.renderer.height/n)};return t===n||(t=n,console.log("scale factor changed to:",n),e.stage.scale=n),r}}},A={original:new T("rgb(255, 255, 255)"),basic:new T("rgb(210, 210, 210)"),dimmed:new T("rgb(120, 120, 120)")},M={original:new T("rgb(255, 255, 0)"),basic:new T("hsl(50,58%,70%)"),dimmed:q.redShadow},E={original:new T("rgb(255, 0, 255)"),basic:q.pink,dimmed:new T("hsl(290,25%,40%)")},C={original:new T("rgb(0, 255, 255)"),basic:new T("hsl(183, 28%, 50%)"),dimmed:new T("hsl(183, 28%,39%)")},D={original:new T("rgb(0, 255, 0)"),basic:q.moss,dimmed:new T("hsl(73,35%,35%)")},at={white:{basic:{main:A,edges:{towards:C,right:M},hud:{lives:M,dimmed:E,icons:C}},dimmed:{main:A,edges:{towards:D,right:C},hud:{lives:M,dimmed:E,icons:C}}},yellow:{basic:{main:M,edges:{towards:D,right:A},hud:{lives:C,dimmed:E,icons:D}},dimmed:{main:M,edges:{towards:C,right:C},hud:{lives:C,dimmed:E,icons:D}}},magenta:{basic:{main:E,edges:{towards:D,right:C},hud:{lives:A,dimmed:C,icons:M}},dimmed:{main:E,edges:{towards:D,right:C},hud:{lives:A,dimmed:C,icons:M}}},cyan:{basic:{main:C,edges:{towards:E,right:A},hud:{lives:A,dimmed:D,icons:M}},dimmed:{main:C,edges:{towards:E,right:A},hud:{lives:A,dimmed:D,icons:M}}},green:{basic:{main:D,edges:{towards:C,right:M},hud:{lives:A,dimmed:E,icons:C}},dimmed:{main:D,edges:{towards:C,right:M},hud:{lives:A,dimmed:E,icons:C}}}},Cn=e=>at[e.hue][e.shade],Tn=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,Kr=`in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uOriginalColor;
uniform vec3 uTargetColor;
uniform float uTolerance;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);
    vec3 colorDiff = uOriginalColor - (c.rgb / max(c.a, 0.0000000001));
    float colorDistance = length(colorDiff);
    float doReplace = step(colorDistance, uTolerance);
    finalColor = vec4(mix(c.rgb, uTargetColor * c.a, doReplace), c.a);
}
`;class ze extends pe{static DEFAULT_OPTIONS={originalColor:16711680,targetColor:0,tolerance:.4};uniforms;_originalColor;_targetColor;constructor(t){t={...ze.DEFAULT_OPTIONS,...t};const n=he.from({vertex:Tn,fragment:Kr,name:"palette-swap-filter"});super({glProgram:n,resources:{colorReplaceUniforms:{uOriginalColor:{value:new Float32Array(3),type:"vec3<f32>"},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"},uTolerance:{value:t.tolerance,type:"f32"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this._originalColor=new T,this._targetColor=new T,this.originalColor=t.originalColor??16711680,this.targetColor=t.targetColor??0,Object.assign(this,t)}get originalColor(){return this._originalColor.value}set originalColor(t){this._originalColor.setValue(t);const[n,r,o]=this._originalColor.toArray();this.uniforms.uOriginalColor[0]=n,this.uniforms.uOriginalColor[1]=r,this.uniforms.uOriginalColor[2]=o}get targetColor(){return this._targetColor.value}set targetColor(t){this._targetColor.setValue(t);const[n,r,o]=this._targetColor.toArray();this.uniforms.uTargetColor[0]=n,this.uniforms.uTargetColor[1]=r,this.uniforms.uTargetColor[2]=o}get tolerance(){return this.uniforms.uTolerance}set tolerance(t){this.uniforms.uTolerance=t}}const kn=e=>[new ze({originalColor:q.replaceLight,targetColor:e.basic,tolerance:.1}),new ze({originalColor:q.replaceDark,targetColor:e.dimmed,tolerance:.1})],et=(e,t)=>kn(at[e.color.hue][e.color.shade].edges[t]),Qr=e=>kn(at[e.color.hue][e.color.shade].main),se=Vn,eo=`precision mediump float;
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uSourceBlacks[2];
uniform vec3 uTargetColor;

// colours are floats so check if they're very close rather than exactly equal:
bool colorsEffectivelyEqual(vec3 color1, vec3 color2) {    
    
    return distance(color1, color2) < 0.05;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a == 0.0 ) {
        finalColor = c;
        return;
    }

    if ( colorsEffectivelyEqual(c.rgb, uSourceBlacks[0]) || colorsEffectivelyEqual(c.rgb, uSourceBlacks[1])) {
        finalColor = vec4(0,0,0, 1.0);
    } else {
        finalColor = vec4(uTargetColor, 1);    
    }
}
`,Ft=[q.pureBlack,q.lightBlack];class ke extends pe{uniforms;constructor(t="white"){const n=he.from({vertex:Tn,fragment:eo,name:"revert-colourise-filter"});super({glProgram:n,resources:{colorReplaceUniforms:{uSourceBlacks:{value:new Float32Array(6),type:"vec3<f32>",size:6},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms;const[r,o,i]=Ft[0].toArray();this.uniforms.uSourceBlacks[0]=r,this.uniforms.uSourceBlacks[1]=o,this.uniforms.uSourceBlacks[2]=i;const[s,a,l]=Ft[1].toArray();this.uniforms.uSourceBlacks[3]=s,this.uniforms.uSourceBlacks[4]=a,this.uniforms.uSourceBlacks[5]=l,this.targetColor=t}set targetColor(t){const[n,r,o]=new T(t).toArray();this.uniforms.uTargetColor[0]=n,this.uniforms.uTargetColor[1]=r,this.uniforms.uTargetColor[2]=o}}function lt(e,t){const n=t||new m;for(const r of e)n.addChild(r);return n}const to=24,no=56,ro=80,Ot=112,oe=e=>e==="heels"?1:-1;function*oo(e){const t=e.toString().split(""),n=t.length;for(let r=0;r<n;r++){const o=`hud.char.${t[r]}`;Gn(o),yield h({texture:o,x:(r+.5-n/2)*Zt.w})}}function we(e,t){for(const n of e.children)n.destroy();lt(oo(t),e)}const io=e=>{const t=new ke,n=new ke,r=new ke,o=(l=!1)=>{const c=l?2:1,d=new m;return d.scale={x:1,y:c},d},i=l=>{const c=new Oe(b.textures[`${l}.walking.${l==="head"?"right":"towards"}.2`]);return c.anchor={x:.5,y:0},c},s=(l,c=!1,d=!1)=>{const u=new m;u.pivot={x:4,y:16};const f=new Oe({texture:b.textures[l],anchor:c?{x:.5,y:0}:{x:.5,y:1},filters:t,y:c?0:8});u.addChild(f);const p=o();return p.y=c?0:16,p.filters=n,p.x=f.x=Zt.w/2,u.addChild(p),d&&(p.visible=!1),{text:p,icon:f,container:u}},a={head:{sprite:i("head"),livesText:o(!0),shield:s("hud.shield"),extraSkill:s("hud.fastSteps"),donuts:s("donuts",!0),hooter:s("hooter",!0,!0)},heels:{sprite:i("heels"),livesText:o(!0),shield:s("hud.shield"),extraSkill:s("hud.bigJumps"),bag:s("bag",!0,!0),carrying:{container:new m}}};for(const l of ue)e.addChild(a[l].livesText),e.addChild(a[l].sprite),e.addChild(a[l].shield.container),e.addChild(a[l].extraSkill.container);return e.addChild(a.head.donuts.container),e.addChild(a.head.hooter.container),e.addChild(a.heels.bag.container),e.addChild(a.heels.carrying.container),(l,c)=>{const d=X(l),{hud:{dimmed:u,lives:f,icons:p}}=Cn(d.color),S=v=>{const _=ye(l,v),I=_?.state.shieldCollectedAt??null,{text:j,container:ht}=a[v].shield,{text:Dn,container:ft}=a[v].extraSkill;ft.x=ht.x=(c.x>>1)+oe(v)*ro;const Rn=I===null||l.gameTime>I+qe?0:100-Math.ceil((l.gameTime-I)/(qe/100));we(j,Rn),ht.y=c.y,we(Dn,_===void 0?0:_.type==="head"?_.state.fastSteps:_.state.bigJumps),ft.y=c.y-24},w=v=>{const _=l.currentCharacterName===v,I=a[v].sprite;I.filters=_?se:r,I.x=(c.x>>1)+oe(v)*no,I.y=c.y-V.h},g=v=>{const I=ye(l,v)?.state.lives??0,j=a[v].livesText;j.x=(c.x>>1)+oe(v)*to,j.y=c.y,j.tint=f.basic,we(j,I??0)},P=v=>{const{container:_}=a.heels.carrying,I=_.children.length>0;if(v===null&&I)for(const j of _.children)j.destroy();v!==null&&!I&&_.addChild(h(v.type==="spring"?"spring.released":v.config.style))};r.targetColor=u.dimmed,n.targetColor=u.basic,t.targetColor=p.basic;for(const v of ue)g(v),w(v),S(v);a.head.hooter.container.x=a.head.donuts.container.x=(c.x>>1)+oe("head")*Ot,a.head.donuts.container.y=c.y-V.h-8,a.heels.carrying.container.y=c.y-V.h,a.heels.carrying.container.x=a.heels.bag.container.x=(c.x>>1)+oe("heels")*Ot,a.heels.bag.container.y=a.head.hooter.container.y=c.y-8;const U=ye(l,"head"),y=U?.state.hasHooter??!1;a.head.hooter.icon.filters=y?se:r;const G=U?.state.donuts??0;a.head.donuts.icon.filters=G!==0?se:r,we(a.head.donuts.text,G);const dt=ye(l,"heels"),En=dt?.state.hasBag??!1;P(dt?.state.carrying??null),a.heels.bag.icon.filters=En?se:r}},_t={movementType:"vel",vels:{gravity:$}},so=(e,t,n)=>{if(!K(e))return _t;const{type:r,state:{vels:{gravity:{z:o}},standingOn:i}}=e,s=jn[r==="head"?"head":"others"];return i!==null?k("lift")(i)&&i.state.vels.lift.z<0?{movementType:"vel",vels:{gravity:{z:Math.max(o-He*n,-s)}}}:_t:{movementType:"vel",vels:{gravity:{z:Math.max(o-He*n,-s)}}}},Ce=e=>{const n=e/Yn*Wt;return(e+.5*He*n**2)/n},ao={head:Ce(ve.head),headOnSpring:Ce(ve.head+W.h),heels:Ce(ve.heels),heelsOnSpring:Ce(ve.heels+W.h)},lo=(e,t)=>ao[`${e}${t?"OnSpring":""}`],Sn=({type:e,state:{standingOn:t}},n)=>{const{inputState:{jump:r}}=n,o=t!==null&&k("teleporter")(t);if(!(r&&t!==null&&!o))return t!==null?{movementType:"steady",stateDelta:{jumped:!1}}:Jt;const s=k("spring")(t);return{movementType:"vel",vels:{gravity:{z:lo(e,s)}},stateDelta:{action:"moving",jumped:!0}}},co=({vel:e,acc:t,unitD:n,maxSpeed:r,deltaMS:o,crossComponentFade:i=0,minVelocity:s=0})=>{const a=Q(e,n),l=Math.max(a+t*o,s),c=l>=r,d=Wn(n),u=Q(e,d),f=u>=0?Math.max(u-i*o,0):Math.min(u+i*o,0);return F(z(n,c?r:l),z(d,f))},It={movementType:"vel",vels:{walking:$}},Pn=(e,{inputState:t},n)=>{const{type:r,state:{action:o,autoWalk:i,standingOn:s,facing:a,teleporting:l,vels:{walking:c,gravity:d}}}=e,u=i?a:Ht.find(P=>t[P]===!0),f=Me[r];if(l!==null||o==="death")return It;if(r==="heels"){if(s===null)return e.state.jumped?{movementType:"vel",vels:{walking:Ae(c,z(c,qn*n))}}:It;if(t.jump){const P=u??a,y=k("spring")(s)?1:Hn;return{movementType:"vel",vels:{walking:z(ae[P],f*y)},stateDelta:{facing:P}}}}const p=s===null&&d.z<0;if(u!==void 0)return p?{movementType:"vel",vels:{walking:z(ae[u],f)},stateDelta:{facing:u,action:"falling"}}:{movementType:"vel",vels:{walking:co({vel:c,acc:Zn[r],deltaMS:n,maxSpeed:f,unitD:ae[u],crossComponentFade:yt[r],minVelocity:gt[r]})},stateDelta:{facing:u,action:"moving"}};const S=Jn(c),w=S===0?$:z(c,1/S),g=Math.max(S-yt[r]*n,0);return{movementType:"vel",vels:{walking:z(w,g<gt[r]?0:g)},stateDelta:{action:p?"falling":"idle"}}},zt=W.h,Te=.001,uo=({totalDistance:e,currentAltitude:t,direction:n})=>{const r=De**2/(2*te);if(n==="up"){if(t<=r)return Math.max(Te,Math.sqrt(2*te*Math.max(t,0)));if(t>=e-r){const o=Math.max(0,e-t);return Math.max(Te,Math.sqrt(2*te*o))}else return De}else if(t>=e-r){const o=Math.max(0,e-t);return Math.min(-Te,-Math.sqrt(2*te*o))}else return t<=r?Math.min(-Te,-Math.sqrt(2*te*Math.max(t,0))):-De};function ho({config:{bottom:e,top:t},state:{direction:n,position:{z:r}}},o,i){const s=e*zt,a=t*zt,l=uo({currentAltitude:r-s,direction:n,totalDistance:a-s});if(Number.isNaN(l))throw new Error("velocity is NaN");const c=r<=s?"up":r>=a?"down":n;return{movementType:"vel",vels:{lift:{z:l}},stateDelta:{direction:c}}}const At=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),Mt={stopAutowalk:0,portal:0,wall:0,doorLegs:0,sceneryPlayer:0,bubbles:0,block:1,barrier:1,floor:1,book:1,hushPuppy:1,teleporter:1,doorFrame:1,lift:2,movableBlock:2,portableBlock:2,slidingBlock:2,spring:2,ball:3,joystick:3,switch:3,charles:3,conveyor:3,head:3,heels:3,pickup:8,slidingDeadly:10,moveableDeadly:10,deadlyBlock:10,baddie:10},Fn=(e,t)=>Mt[e.type]-Mt[t.type],fo=(e,t)=>t.toSorted((n,r)=>{const o=Fn(n,r);if(o!==0)return o;const i=Q(e,At(e,n)),s=Q(e,At(e,r));return i-s});function On({gameState:e,movingItem:t}){if(t.state.action==="death")return!1;const{shieldCollectedAt:n}=t.state;return n!==null&&n+qe>e.gameTime?!1:(t.state.action="death",t.state.expires=e.gameTime+Ze,!0)}const $e=k("head"),Et=k("heels"),po=e=>{const{gameState:t,movingItem:n,touchedItem:r,room:{id:o}}=e;if(t.pickupsCollected[o][r.id]===!0)return;const i=t.pickupsCollected[o];switch(i[r.id]=!0,r.config.gives){case"hooter":{if($e(n)){n.state.hasHooter=!0;break}break}case"donuts":{if($e(n)){n.state.donuts+=6;break}break}case"bag":{if(Et(n)){n.state.hasBag=!0;break}break}case"shield":{n.state.shieldCollectedAt=t.gameTime;break}case"fast":{$e(n)&&(n.state.fastSteps=99);break}case"jumps":{Et(n)&&(n.state.bigJumps=10);break}case"extra-life":n.state.lives+=2;break;case"scroll":t.inputState.jump=!1,t.events.emit("scrollOpened",{markdown:r.config.markdown});break;case"reincarnation":break;case"crown":break;default:r.config}},mo=({gameState:e,movingItem:t,touchedItem:n,movementVector:r})=>{const{config:{relativePoint:o,toRoom:i,direction:s},state:{position:a}}=n,l=ae[s];return Q(l,r)<=0?!1:(rt({gameState:e,toRoomId:i,positionRelativeToSourcePortal:Ae(t.state.position,F(a,o)),sourcePortal:n,changeType:"portal"}),!0)},go=({movingItem:e,movementVector:t,touchedItem:n})=>{const{config:{direction:r,nearness:o}}=n,i=ot(r),s=o==="far"?{x:i==="x"?-Math.abs(t.y):0,y:i==="y"?-Math.abs(t.x):0,z:0}:{x:i==="x"?Math.abs(t.y):0,y:i==="y"?Math.abs(t.x):0,z:0};return e.state.position=F(e.state.position,s),!1};function yo({movingItem:e}){return e.state.autoWalk=!1,!1}const B=(e,...t)=>k(...t)(e.touchedItem),Se=(e,...t)=>k(...t)(e.movingItem),Dt=e=>{switch(!0){case B(e,"stopAutowalk"):yo(e);break;case(B(e,...Kn)||B(e,"floor")&&e.touchedItem.config.deadly):if(On(e))return!0;break;case B(e,"portal"):if(mo(e))return!0;break;case B(e,"pickup"):po(e);break;case B(e,"doorFrame"):go(e);break}return!1},vo=({touchedItem:e,gameState:{progression:t},room:n})=>{const{config:{activates:r},state:{setting:o,touchedOnProgression:i}}=e;if(e.state.touchedOnProgression=t,t===i+1||t===i)return;const s=e.state.setting=o==="left"?"right":"left";for(const[a,l]of it(r)){const c=n.items[a];c!==void 0&&(c.state={...c.state,...l[s]})}return!1},xo=({movingItem:e,touchedItem:t})=>{if(!K(e))return;const{state:{position:n},aabb:r}=t,o=de(e.state.position,e.aabb,n,r);if(o.x===0&&o.y===0)return;const i=Kt(o),s=z(i,-Me.ball);return t.state.vels.sliding=s,!1},bo=({movingItem:e,touchedItem:t})=>{if(!K(t))return;const n=e.state.vels.sliding;if(fe(n,$))return;const{state:{position:r},aabb:o}=e,i=de(t.state.position,t.aabb,r,o);return Q(i,e.state.vels.sliding)>0&&(e.state.vels.sliding=$),!1},wo=({gameState:e,movingItem:t,touchedItem:n,deltaMS:r})=>{const o=X(e),{config:{controls:i},state:{position:s},aabb:a}=n,l=de(t.state.position,t.aabb,s,a);if(l.x===0&&l.y===0)return;const c=Kt(l);for(const d of i){const u=o.items[d],f=z(c,-Me.charles*r);u.state.facing=f,Ee({subjectItem:u,posDelta:f,gameState:e,pusher:n,deltaMS:r})}return!1},Co=(e,t,n,r)=>{const o=Math.max(0,Math.min(e.x+t.x,n.x+r.x)-Math.max(e.x,n.x)),i=Math.max(0,Math.min(e.y+t.y,n.y+r.y)-Math.max(e.y,n.y));return o*i},Rt=({state:{position:e},aabb:t},{state:{position:n},aabb:r})=>Co(e,t,n,r),Bt=.001,ct=(e,t,n=.001)=>{if(!K(t)||e.id===t.id)return!1;const{state:{vels:{gravity:{z:r}}}}=e;return r>0?!1:Qt({state:{position:F(e.state.position,{x:0,y:0,z:-Bt})},aabb:{...e.aabb,z:n+Bt},id:e.id},{state:{position:F(t.state.position,{x:0,y:0,z:t.aabb.z})},aabb:{...t.aabb,z:0},id:t.id})},_n=(e,t)=>{const r=[...H(t).filter(i=>ct(e,i))];return r.length===0?void 0:r.reduce((i,s)=>{const a=Fn(s,i);return a<0||a===0&&Rt(e,s)>Rt(e,i)?s:i})},In=e=>{e.state.standingOn!==null&&e.state.standingOn.state.stoodOnBy.delete(e),e.state.standingOn=null},ut=(e,t)=>{console.log("standing on changed:",e.id,"is now on",t.id),e.state.standingOn=t,t.state.stoodOnBy.add(e)},Xt=e=>{const t=Z(e.movingItem)&&ct(e.movingItem,e.touchedItem,Math.abs(e.movementVector.z));if(e.touchedItem.state.disappear==="onTouch"||e.touchedItem.state.disappear==="onTouchByPlayer"&&ee(e.movingItem)||e.touchedItem.state.disappear==="onStand"&&t){if(t&&Se(e,...ue)){ut(e.movingItem,e.touchedItem);const r=[Sn(e.movingItem,e.gameState),Pn(e.movingItem,e.gameState,e.deltaMS)];An(e.movingItem,r)}en(e)}},To=e=>{Se(e,...ue)&&Dt(e),B(e,...ue)&&Dt({...e,movingItem:e.touchedItem,touchedItem:e.movingItem}),B(e,...vt)&&xo(e),Se(e,...vt)&&bo(e),Se(e,"baddie")&&Qn(e),B(e,"switch")&&vo(e),B(e,"joystick")&&wo(e),e.touchedItem.state.disappear&&Xt(e),e.movingItem.state.disappear&&Xt({...e,movingItem:e.touchedItem,touchedItem:e.movingItem})},Ee=({subjectItem:e,posDelta:t,gameState:n,pusher:r,deltaMS:o,forceful:i=k("lift")(e)&&r===void 0,recursionDepth:s=0})=>{if(fe(t,$))return;if(s>16)throw new Error("this probably means a non-terminating issue");const a=X(n),{state:{position:l}}=e;e.state.position=F(l,t);const c=fo(t,st(e,L(a.items)));for(const d of c){if(!Qt(e,d))continue;if(r!==d&&To({movingItem:e,touchedItem:d,movementVector:Ae(e.state.position,l),gameState:n,deltaMS:o,room:a}),a.items[e.id]===void 0)return;if(a.items[d.id]===void 0||!K(d)||!K(e))continue;const u=de(e.state.position,e.aabb,d.state.position,d.aabb);if(Z(d)&&d!==r){const f=i||er(d)?-1:-.5,p=z(u,f);e.state.position=F(e.state.position,u,p),Ee({subjectItem:d,posDelta:p,pusher:e,gameState:n,deltaMS:o,forceful:i,recursionDepth:s+1}),e.state.position=F(e.state.position,de(e.state.position,e.aabb,d.state.position,d.aabb))}else e.state.position=F(e.state.position,u);Z(e)&&u.z>0&&(e.state.standingOn===null||!c.includes(e.state.standingOn))&&(In(e),ut(e,d))}};function ko(e,t,n){const{state:{teleporting:r,standingOn:o}}=e,{inputState:{jump:i}}=t;if(r===null)return i&&o!==null&&k("teleporter")(o)?{movementType:"steady",stateDelta:{teleporting:{phase:"out",toRoom:o.config.toRoom,timeRemaining:Ze}}}:Jt;const s=Math.max(r.timeRemaining-n,0);switch(r.phase){case"out":if(s===0)return rt({gameState:t,toRoomId:r.toRoom,changeType:"teleport"}),{movementType:"steady",stateDelta:{teleporting:{phase:"in",timeRemaining:Ze}}};break;case"in":if(s===0)return{movementType:"steady",stateDelta:{teleporting:null}};break}return{movementType:"steady",stateDelta:{teleporting:{...r,timeRemaining:s}}}}const $t={movementType:"vel",vels:{movingFloor:$},stateDelta:{activeConveyor:null}},So=(e,t,n)=>{if(ee(e)&&e.state.teleporting!==null)return $t;const{state:{standingOn:r}}=e;if(r===null||!k("conveyor")(r))return $t;const{config:{direction:o}}=r,s=k("heels")(e)&&e.state.action==="moving"&&e.state.facing===tr(o)?Me.heels:nr;return{movementType:"vel",vels:{movingFloor:z(ae[o],s)},stateDelta:{activeConveyor:r}}},Po=(e,t,n,r)=>{const{inputState:o}=n,{state:{carrying:i,position:s,hasBag:a}}=e;if(!a)return;const l=H(L(t.items)).filter(tn),c=i===null?Oo(e,t):void 0;for(const d of l)d.state.wouldPickUpNext=!1;if(c!==void 0&&(c.state.wouldPickUpNext=!0),o.carry){if(i===null){if(c===void 0){console.warn("nothing to pick up");return}Fo(t,e,c)}else{if(e.state.standingOn===null||!zn(e,L(t.items)))return;const d=rr({gameState:n,room:t,itemType:i.type,config:i.config,position:s});Ee({subjectItem:e,gameState:n,posDelta:{x:0,y:0,z:d.aabb.z},pusher:e,forceful:!0,deltaMS:r}),e.state.carrying=null}o.carry=!1}},Fo=(e,t,n)=>{const r={type:n.type,config:n.config};t.state.carrying=r,nn({room:e,item:n})},Oo=(e,t)=>_n(e,H(L(t.items)).filter(tn)),zn=(e,t)=>{const n={position:F(e.state.position,{z:W.h})},r=st({id:e.id,aabb:e.aabb,state:n},t);for(const o of r)if(!Z(o)||!zn(o,t))return!1;return!0};function*_o(e,t,n){for(;(e.state.latentMovement.at(0)?.moveAtGameTime??Number.POSITIVE_INFINITY)<t.gameTime;){const{positionDelta:r}=e.state.latentMovement.shift();yield{movementType:"position",posDelta:r}}}function*Io(e,t,n,r){Z(e)&&(yield so(e,n,r),yield So(e),yield*_o(e,n)),ee(e)&&e.type===n.currentCharacterName&&(yield ko(e,n,r),yield Pn(e,n,r),yield Sn(e,n),k("heels")(e)&&Po(e,t,n,r)),k("lift")(e)&&(yield ho(e)),k("baddie")(e)&&(yield ir(e,t,n,r))}const zo=(e,t,n,r)=>{ee(e)&&e.state.standingOn!==null&&or(e.state.standingOn)&&On({gameState:n,room:t,movingItem:e,touchedItem:e.state.standingOn,deltaMS:r,movementVector:{x:0,y:0,z:-1}});const o=[...Io(e,t,n,r)];Z(e)&&e.state.standingOn!==null&&e.state.standingOn.state.disappear==="onStand"&&en({touchedItem:e.state.standingOn,gameState:n,room:t});let i=An(e,o);(Z(e)||k("lift")(e))&&(i=F(i,...H(L(e.state.vels)).map(s=>z(s,r)))),Ee({subjectItem:e,posDelta:i,gameState:n,deltaMS:r})},An=(e,t)=>{let n=$;for(const r of t){if(r.movementType==="position"&&(n=F(n,r.posDelta)),r.movementType==="vel"&&(Z(e)||k("lift")(e)))for(const[i,s]of it(r.vels)){const a={...$,...s};e.state.vels[i]=a}const o=r.stateDelta;o!==void 0&&(e.state={...e.state,...o})}return n},Ao=e=>{sr(e)!==void 0&&(e.currentCharacterName=rn(e.currentCharacterName))},Mo=e=>{const{currentCharacterName:t}=e,{room:n,entryState:r}=e.characterRooms[t],o=n.items[t],i=rn(t),s=o.state,a=o.state.lives-1;if(a===0){o.state.lives=a,e.characterRooms[t]=void 0,e.currentCharacterName=i;return}o.state={...s,...r,expires:null,lives:a,standingOn:null},o.type==="heels"&&(o.state.carrying=null);const l=Ye(e.campaign.rooms[n.id],e.pickupsCollected[n.id],{[t]:o});e.characterRooms[t].room=l},Eo=9,Do=(e,t)=>e.state.expires!==null&&e.state.expires<t.gameTime,Ro=(e,t)=>{for(const n of L(e.items)){const r=t[n.id];if(r===void 0)continue;fe(r,n.state.position)&&!lr(n.state.position)&&(console.log(`snapping item ${n.id} to pixel grid`),n.state.position=cr(n.state.position))}},Bo=e=>{for(const t of e)for(const n of t.state.stoodOnBy)if(!ct(n,t)){In(n);const r=_n(n,e);r!==void 0&&ut(n,r)}},Xo=(e,t,n)=>{for(const r of e)for(const o of r.state.stoodOnBy){const s={...Ae(r.state.position,n[r.id]),z:0};fe(s,$)||o.state.latentMovement.push({moveAtGameTime:t.gameTime+2*ur,positionDelta:s})}},$o=(e,t)=>{const n={lift:-4,head:-3,heels:-3,baddie:-2,block:1,deadlyBlock:1},r=n[e.type]??0,o=n[t.type]??0;return r-o},Lo=(e,t)=>{const n=t*e.gameSpeed,r=Math.ceil(n/Eo),o=n/r,{inputState:i}=e;if(i.swop){Ao(e),i.swop=!1;return}const s=X(e);for(let a=0;a<r;a++){const l=Object.fromEntries(H(it(s.items)).map(([d,u])=>[d,u.state.position]));for(const d of L(s.items))if(Do(d,e))if(ee(d)){Mo(e);return}else nn({room:s,item:d});const c=Object.values(s.items).sort($o);for(const d of c){if(ar(e).state.action==="death")break;s.items[d.id]!==void 0&&zo(d,s,e,o)}if(Bo(c),Xo(c,e,l),e.progression++,e.gameTime+=o,s!==X(e))return;Ro(s,l)}},Lt=(e,t)=>{const n=x(e),r=x(F(e,{x:t.x,z:t.z})),o=x(F(e,{y:t.y,z:t.z}));return{bottomCentre:n,topLeft:r,topRight:o}},Le=(e,t,n,r,o=1e-5)=>r-o>e&&n<t-o,Uo=(e,t,n,r)=>{const o=Lt(e,t),i=Lt(n,r),s=o.topLeft.x,a=o.topRight.x,l=i.topLeft.x,c=i.topRight.x,d=Le(s,a,l,c),u=o.topRight.y-o.topRight.x/2,f=o.bottomCentre.y-o.bottomCentre.x/2;if(u>f)throw new Error(`aXAxisSlopeMinC ${u} > aXAxisSlopeMaxC ${f}`);const p=i.topRight.y-i.topRight.x/2,S=i.bottomCentre.y-i.bottomCentre.x/2;if(p>S)throw new Error("bXAxisSlopeMinC > bXAxisSlopeMaxC");const w=Le(u,f,p,S),g=o.topLeft.y+o.topLeft.x/2,P=o.bottomCentre.y+o.bottomCentre.x/2;if(g>P)throw new Error("aYAxisSlopeMinC > aYAxisSlopeMaxC");const U=i.topLeft.y+i.topLeft.x/2,y=i.bottomCentre.y+i.bottomCentre.x/2;if(U>y)throw new Error("bYAxisSlopeMinC > bYAxisSlopeMaxC");const G=Le(g,P,U,y);return d&&w&&G},No=(e,t)=>{if(e.renders===!1||t.renders===!1||e.fixedZIndex!==void 0||t.fixedZIndex!==void 0)return 0;const n=e.state.position,r=e.renderAabb||e.aabb,o=t.state.position,i=t.renderAabb||t.aabb;if(!Uo(n,r,o,i))return 0;for(const s of dr){const a=e.state.position[s],l=a+r[s],c=t.state.position[s],d=c+i[s];if(l<=c)return 1*(s==="z"?-1:1);if(a>=d)return-1*(s==="z"?-1:1)}return Ut(t)-Ut(e)},Ut=e=>e.state.position.x+e.state.position.y-e.state.position.z;class Pe extends Error{constructor(t,n,r,o){super(t,o),this.cyclicDependency=n,this.hasClosedCycle=r}}const Vo=e=>Go(jo(e),e),Go=(e,t)=>{let n=e.length,r=n;const o=new Array(n),i={},s=Yo(t),a=Wo(e);for(t.forEach(function(c){if(!a.has(c[0])||!a.has(c[1]))throw new Error("Unknown node. There is an unknown node in the supplied edges.")});r--;)i[r]||l(e[r],r,new Set);return o;function l(c,d,u){if(u.has(c))throw new Pe("Cyclic dependency found - see .cyclicDependency of this error for details",[c],!1);if(!a.has(c))throw new Error("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(c));if(i[d])return;i[d]=!0;const f=s.get(c)||new Set,p=Array.from(f);if(d=p.length){u.add(c);do{const S=p[--d];try{l(S,a.get(S),u)}catch(w){throw w instanceof Pe?w.hasClosedCycle?w:new Pe(w.message,[...w.cyclicDependency,c],w.cyclicDependency.includes(c)):w}}while(d);u.delete(c)}o[--n]=c}};function jo(e){const t=new Set;for(let n=0,r=e.length;n<r;n++){const o=e[n];t.add(o[0]),t.add(o[1])}return Array.from(t)}function Yo(e){const t=new Map;for(let n=0,r=e.length;n<r;n++){const o=e[n];t.has(o[0])||t.set(o[0],new Set),t.has(o[1])||t.set(o[1],new Set),t.get(o[0]).add(o[1])}return t}function Wo(e){const t=new Map;for(let n=0,r=e.length;n<r;n++)t.set(e[n],n);return t}const qo=e=>{const t=[];for(const n of e)if(n.renders)for(const r of e){if(n===r)break;if(!r.renders)continue;const o=No(n,r);o!==0&&(o>0?t.push([r.id,n.id]):t.push([n.id,r.id]))}return t},Mn=(e,t,n=3)=>{try{return{order:Vo(e),impossible:!1}}catch(r){if(r instanceof Pe){const o=r.cyclicDependency,i=e.find(([s,a])=>o.includes(s)&&o.includes(a));if(i===void 0)throw new Error("could not find bad link");return{order:Mn(e.filter(s=>s!==i),t,n-1).order,impossible:!0}}else throw r}},Ho=(e,t,n,r)=>`${e}${r?".dark":""}.wall.${t}.${n}`,Zo=(e,t,n)=>{const o=b.textures[`${e.planet}.door.front.${t}`]!==void 0?e.planet:"generic",i=e.color.shade==="dimmed"&&b.textures[`${o}.dark.door.front.${t}`]!==void 0;return`${o}${i?".dark":""}.door.${n=="near"?"front":"back"}.${t}`},Ue=e=>()=>({container:h(e),renderProps:{}}),O=e=>({item:t,room:n,currentlyRenderedProps:r})=>{if(r===void 0)return{container:e({item:t,room:n}),renderProps:hr}};function*Jo({config:{direction:e,inHiddenWall:t,height:n}},r){const o=ot(e),i=o==="y"?0:16;function*s(a){if(t){if(n!==0){const c=h({pivot:{x:o==="x"?18:8,y:12},texture:`generic.door.floatingThreshold.${o}`,...Re(a,{y:-W.h*n})});c.filters=et(r,o==="x"?"towards":"right"),yield c}}else{yield h({pivot:{x:i,y:12},texture:"generic.door.legs.base",...Re(a,{y:n})});for(let l=1;l<n;l++)yield h({pivot:{x:i,y:9},texture:"generic.door.legs.pillar",...Re(a,{y:-l*W.h})})}}yield*s(Y({...le,[o]:1})),yield*s(le),t||(yield h({pivot:{x:16,y:W.h*n+13},texture:`generic.door.legs.threshold.double.${o}`,...Y({...le,[o]:1})}))}const Ko=O(({item:e,room:t})=>lt(Jo(e,t)));function*Qo({config:{direction:e,inHiddenWall:t,nearness:n},state:{position:r}},o){const i=ot(e),{z:s}=r;if(!t&&s===0){const a=Y({[pr(i)]:.5});n==="far"&&(yield h({anchor:{x:0,y:1},flipX:i==="x",texture:"generic.wall.overdraw",...a}))}yield h({texture:Zo(o,i,n),pivot:fr[n][i]})}const ei=O(({item:e,room:t})=>lt(Qo(e,t))),Nt=({item:{type:e,state:{action:t,facing:n,teleporting:r}},currentlyRenderedProps:o})=>o===void 0||o.action!==t||o.facingXy4!==n||o.teleportingPhase!==(r?.phase??null)?{container:(()=>{if(t==="death")return h({frames:b.animations[`${e}.fadeOut`]});if(r!==null){if(r.phase==="out")return h({frames:b.animations[`${e}.fadeOut`]});if(r.phase==="in")return h({frames:b.animations[`${e}.fadeOut`].toReversed()})}return h(t==="moving"?{frames:b.animations[`${e}.walking.${n}`]}:t==="falling"&&e==="head"&&(n==="towards"||n==="right")?`head.falling.${n}`:e==="head"&&(n==="towards"||n==="right")?{frames:b.animations[`head.idle.${n}`]}:`${e}.walking.${n}.2`)})(),renderProps:{action:t,facingXy4:n,teleportingPhase:r?.phase??null}}:void 0,ti=O(({room:e})=>{const{blockXMin:t,blockYMin:n,blockXMax:r,blockYMax:o,sidesWithDoors:i}=on(e.roomJson),s=r-t,a=o-n,{floor:l,color:{shade:c}}=e,d=new m({label:`floor(${e.id})`});if(l!=="none"){const g=l==="deadly"?`generic${c==="dimmed"?".dark":""}.floor.deadly`:`${l}${c==="dimmed"?".dark":""}.floor`,P=new m;for(let y=-1;y<=r+2;y++)for(let G=y%2-1;G<=o+2;G+=2)P.addChild(ne({x:y+(i.right?-.5:0),y:G+(i.towards?-.5:0)},h({texture:g})));for(let y=0;y<=e.size.x;y++)e.walls.away[y]!=="none"&&P.addChild(ne({x:y-t,y:e.size.y+(i.towards?.5:0)},h({anchor:{x:0,y:1},texture:"generic.floor.overdraw",flipX:!0})));for(let y=0;y<=e.size.y;y++)e.walls.left[y]!=="none"&&P.addChild(ne({x:e.size.x+(i.right?.5:0),y:y-n},h({anchor:{x:0,y:1},texture:"generic.floor.overdraw"})));const U=new J().poly([le,Y({x:s,y:0}),Y({x:s,y:a}),Y({x:0,y:a})],!0).fill({color:16711680,alpha:.5}).stroke({width:8});P.addChild(U),P.mask=U,d.addChild(P)}const u=new m;for(let g=0;g<=s;g+=.5)u.addChild(ne({x:g,y:0},h({pivot:{x:7,y:0},texture:"generic.edge.towards"})));u.filters=et(e,"towards");const f=new m;for(let g=0;g<=a;g+=.5)f.addChild(ne({x:0,y:g},h({pivot:{x:0,y:0},texture:"generic.edge.right"})));f.filters=et(e,"right");const p=Y({x:e.size.x+(i.right?.5:0),y:-n}).x,S=Y({x:-t,y:e.size.y+(i.towards?.5:0)}).x,w=new J().poly([{x:p,y:16},{x:p,y:-999},{x:S,y:-999},{x:S,y:16}],!0).fill(16776960);return d.addChild(w),d.addChild(u),d.addChild(f),d.mask=w,d}),Ne={frames:b.animations["bubbles.cold"],animationSpeed:.25},ie=(e,t="headless-base")=>{const n=new m;n.addChild(h(t));const r=h(e);return r.y=-12,n.addChild(r),n},ni=(e,t,n)=>t==="organic"&&e?`block.organic.dark${n?".disappearing":""}`:`block.${t}${n?".disappearing":""}`,Ve=(e,t)=>t?new m({children:[h({texture:e,pivot:{x:V.w/2,y:V.h}}),h({texture:`${e}.outline`,pivot:{x:V.w/2+1,y:V.h+1}})]}):h(e),Ge=O(({item:{config:{style:e}}})=>h(e)),ri={head:Nt,heels:Nt,doorFrame:ei,doorLegs:Ko,stopAutowalk(){throw new Error("these should always be non-rendering")},portal(){throw new Error("these should always be non-rendering")},wall:O(({item:{config:{side:e,style:t}},room:n})=>{if(e==="right"||e==="towards")throw new Error("this wall should be non-rendering");return h({texture:Ho(n.planet,t,e,n.color.shade==="dimmed"),y:2,pivot:e==="away"?{x:Be.w,y:Be.h+1}:{x:0,y:Be.h+1}})}),barrier:O(({item:{config:{axis:e}}})=>h({texture:`barrier.${e}`})),deadlyBlock:Ge,slidingDeadly:Ge,slidingBlock:Ge,block({item:{config:{style:e},state:{disappear:t}},room:n,currentlyRenderedProps:r}){if(r===void 0||r.disappear!==t)return{container:h(ni(n.color.shade==="dimmed",e,t!==null)),renderProps:{disappear:t}}},switch({item:{state:{setting:e}},currentlyRenderedProps:t}){if(t===void 0||e!==t.setting)return{container:h(`switch.${e}`),renderProps:{setting:e}}},conveyor({item:{config:{direction:e,count:t},state:{stoodOnBy:n}},currentlyRenderedProps:r}){const o=n.size>0;if(!(r===void 0||r.moving!==o))return;const s=new m,a=yr(e);return s.addChild(...H(mr(t,0,-1)).map(l=>{const c=vr({[a]:(l-1)*W.w});return h(o?{frames:b.animations[`conveyor.${a}`],reverse:e==="towards"||e==="right",animationSpeed:.5,...c}:{texture:`conveyor.${a}.6`,...c})})),{container:s,renderProps:{moving:o}}},lift:O(()=>{const e=new m,t={x:V.w/2,y:V.h-xr};return e.addChild(h({frames:b.animations.lift,pivot:t})),e.addChild(h({texture:"lift.static",pivot:t})),e}),teleporter({item:{state:{stoodOnBy:e}},currentlyRenderedProps:t}){const n=H(e).find(ee)!==void 0;return t===void 0||n!==t.flashing?{container:n?new m({children:[h("teleporter"),h({frames:b.animations["teleporter.flashing"]})]}):h("teleporter"),renderProps:{flashing:n}}:void 0},pickup:O(({item:{config:{gives:e}}})=>{const n={shield:"bunny",jumps:"bunny",fast:"bunny","extra-life":"bunny",bag:"bag",donuts:"donuts",hooter:"hooter",crown:"crown",scroll:{texture:"scroll"},reincarnation:{frames:b.animations.fish,animationSpeed:.25}}[e];return h(n)}),moveableDeadly:O(({item:{config:{style:e}}})=>h(e==="deadFish"?"fish.1":"puck.deadly")),sceneryPlayer:O(({item:{config:{which:e}}})=>h(`${e}.walking.towards.2`)),charles({item:{state:{facing:e}},currentlyRenderedProps:t}){const n=xt(e);if(t===void 0||n!==t.facingXy4)return{container:ie(`charles.${n}`),renderProps:{facingXy4:n}}},baddie({item:{config:e,state:t},currentlyRenderedProps:n}){let r;const{activated:o}=t;switch(e.which){case"american-football-head":case"turtle":case"cyberman":r=e.startDirection;case"computer-bot":case"elephant":case"monkey":{const i=gr(t.vels.walking,le)?r??"towards":xt(t.vels.walking);if(!(n===void 0||o!==n.activated||i!==n.facingXy4))return;const a={facingXy4:i,activated:o};switch(e.which){case"american-football-head":return{container:h({texture:`${e.which}.${e.style}.${i}`}),renderProps:a};case"turtle":return{container:h(o?{frames:b.animations[`${e.which}.${i}`],animationSpeed:.25}:`${e.which}.${i}.1`),renderProps:a};case"cyberman":return{container:t.activated?ie(`${e.which}.${i}`,Ne):h(`${e.which}.${i}`),renderProps:a};case"computer-bot":case"elephant":case"monkey":return{container:ie(`${e.which}.${i}`),renderProps:a}}break}case"helicopter-bug":case"dalek":case"headless-base":case"elephant-head":case"bubble-robot":case"flying-ball":{if(!(n===void 0||o!==n.activated))return;const s={activated:o};switch(e.which){case"helicopter-bug":case"dalek":return{container:h({frames:b.animations[e.which],animationSpeed:.5}),renderProps:s};case"headless-base":return{container:h(e.which),renderProps:s};case"elephant-head":return{container:h("elephant.towards"),renderProps:s};case"bubble-robot":return{container:ie(Ne),renderProps:s};case"flying-ball":return{container:ie("ball",Ne),renderProps:s}}break}default:throw new Error(`unexpected baddie ${e}`)}},joystick:Ue("joystick"),movableBlock:O(({item:{config:{style:e}}})=>h(e)),portableBlock({item:{config:{style:e},state:{wouldPickUpNext:t}},currentlyRenderedProps:n}){const r=t;if(n===void 0||r!==n.highlighted)return{container:Ve(e,r),renderProps:{highlighted:r}}},spring({item:{state:{stoodOnBy:e,wouldPickUpNext:t}},currentlyRenderedProps:n}){const r=e.size>0,o=t;if(!(n===void 0||o!==n.highlighted||r!==n.compressed))return;const s=n?.compressed??!1;return{container:!r&&s?h({frames:b.animations["spring.bounce"],playOnce:"and-stop"}):Ve(r?"spring.compressed":"spring.released",o),renderProps:{compressed:r,highlighted:o}}},book:O(({item:{config:{slider:e}}})=>h(`book.${e?"y":"x"}`)),hushPuppy:Ue("hushPuppy"),bubbles:O(({item:{config:{style:e}}})=>h({frames:b.animations[`bubbles.${e}`]})),ball:Ue("ball"),floor:ti},Vt=(e,t)=>{const n=new J().poly([x({}),x({x:e.x}),x({x:e.x,y:e.y}),x({y:e.y})]).poly([x({}),x({z:e.z}),x({y:e.y,z:e.z}),x({y:e.y})]).poly([x({x:e.x}),x({x:e.x,z:e.z}),x(e),x({x:e.x,y:e.y})]).poly([x({z:e.z}),x({x:e.x,z:e.z}),x({x:e.x,y:e.y,z:e.z}),x({y:e.y,z:e.z})]).stroke({width:1,color:t,alpha:.5});return n.eventMode="static",n.on("pointerenter",()=>{n.fill({color:t,alpha:.5})}),n.on("pointerleave",()=>{n.fill({color:"transparent"})}),n},oi={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",stopAutowalk:"rgba(255,128,128)"},ii=e=>{const t=oi[e.type]??"rgba(255,255,255)",n=new m;if(k("portal")(e)){const r=x(e.config.relativePoint);n.addChild(new J().circle(r.x,r.y,5).stroke(t)),n.addChild(new J().circle(r.x,r.y,2).fill(t))}return n.addChild(new J().circle(0,0,2).fill(t)),n.addChild(Vt(e.aabb,t)),e.renderAabb&&n.addChild(Vt(e.renderAabb,"rgba(184, 184, 255)")),n},si=(e,t,n)=>{if(e.shadowMask===void 0)return;const r=new m({label:"mainShadows"}),o=new m({label:"shadows"});if(n.showShadowMasks||(r.filters=new Dr({alpha:.5})),e.shadowMask.spriteOptions){const s=h(e.shadowMask.spriteOptions);e.shadowMask.relativeTo==="top"&&(s.y=-e.aabb.z),r.addChild(s),n.showShadowMasks||(r.mask=s)}const i={};return r.addChild(o),{get item(){return e},destroy(){r.destroy({children:!0})},tick(s){const a=e.state.position.z+e.aabb.z,l=st({id:e.id,state:{position:{...e.state.position,z:a}},aabb:{...e.aabb,z:br}},L(t.items));let c=!1;const d=H(l).filter(u=>u.shadowCastTexture!==void 0);for(const u of d){if(i[u.id]===void 0){const g=h(u.shadowCastTexture);g.label=u.id,g.filters=[new bn],o.addChild(g),i[u.id]={container:g,usedOnProgression:s}}const f=i[u.id];f.usedOnProgression=s;const p=x({...wr(u.state.position,e.state.position),z:e.aabb.z});f.container.x=p.x,f.container.y=p.y;const S=u.state.position.z-a,[w]=f.container.filters;w.strength=.5+8*S/36,c=!0}for(const[u,{container:f,usedOnProgression:p}]of Cr(i))p!==s&&(f.destroy(),delete i[u]);r.visible=c},container:r}},ai=(e,t,n)=>{t!==void 0&&n.onItemClick&&t!==void 0&&(t.eventMode="static",t.on("pointertap",()=>{n.onItemClick(e,t)}))},Gt=({state:{position:e}},t)=>{const n=Tr(e);t.x=n.x,t.y=n.y},li=(e,t,n)=>{const r=new m({label:"render"});r.filters=Qr(t),n.showBoundingBoxes!=="none"&&(r.alpha=.5);const o=new m({label:`item(${e.id})`});o.addChild(r),e.fixedZIndex!==void 0&&(o.zIndex=e.fixedZIndex),ai(e,o,n),(n.showBoundingBoxes==="all"||n.showBoundingBoxes==="non-wall"&&e.type!=="wall")&&(o.addChild(ii(e)),Gt(e,o));let i,s;const a=ri[e.type],l=si(e,t,n);return l!==void 0&&o.addChild(l.container),{get item(){return e},destroy(){o.destroy({children:!0}),r.destroy({children:!0}),l&&l.destroy()},tick(c){if(!e.renders)return;const d=a({item:e,room:t,currentlyRenderedProps:i});d!==void 0&&(i=d.renderProps,r.children.forEach(p=>p.destroy()),d.container!==null&&r.addChild(d.container));const{state:{position:u}}=e,f=s===void 0||!fe(s,u);return f&&(Gt(e,o),s=u),l&&l.tick(c),f},container:o}},ci=(e,t)=>{const{leftSide:n,rightSide:r,frontSide:o,top:i}=on(e.roomJson),s=(r.x+n.x)/2,a=(i+o.y)/2;t.x=-s,t.y=-a},jt=(e,t)=>{const n=new m({label:`room(${e.id})`}),r=new m({label:`items(room(${e.id}))`});n.addChild(r),ci(e,n);const o=new Map;return{get container(){return n},get room(){return e},tick(i){let s=!1;for(const a of L(e.items)){let l=o.get(a.id);l===void 0&&(l=li(a,e,t),o.set(a.id,l),r.addChild(l.container)),s=l.tick(i)||s}for(const a of o.values())e.items[a.item.id]||(o.delete(a.item.id),a.destroy());if(s){const{order:a}=Mn(qo(L(e.items)),e.items);for(let l=0;l<a.length;l++){const c=o.get(a[l]);if(c===void 0)throw new Error(`Item id=${a[l]} does not have a renderer - cannot assign a z-index`);c.container.zIndex=l}}},destroy(){n.destroy({children:!0}),o.forEach(i=>{i.destroy()})},get renderOptions(){return t}}},ui=4,di=(e,t)=>{const n=new m;n.label="world",n.y=We.height*.7,e.stage.addChild(n);const r=new m;r.y=-ui,e.stage.addChild(r);const o=new ke(q.shadow);let i=jt(X(t),t.renderOptions);n.addChild(i.container);const s=io(r),a=Jr(e),l=({deltaMS:c})=>{const d=a.rescale();n.x=e.renderer.width/a.curUpscale/2;const u=t.gameSpeed===0;if(s(t,d),(i.room!==X(t)||i.renderOptions!==t.renderOptions)&&(i.destroy(),i=jt(X(t),t.renderOptions),n.addChild(i.container)),!u)e.stage.filters=se,Lo(t,c),i.tick(t.progression);else{e.stage.filters=o;const f=X(t).color;o.targetColor=Cn(f).main.original}};return{start(){return e.ticker.add(l),this},stop(){e.stage.removeChild(n),e.ticker.remove(l)}}},hi=async e=>{const t={showBoundingBoxes:"none",showShadowMasks:!1},n=new pn;await n.init({background:"#000000",resizeTo:window});const r=Zr(e,t),o=Wr({keyAssignment:r.keyAssignment,inputState:r.inputState,onInputStateChange(s){r.events.emit("inputStateChanged",s)}}),i=di(n,r).start();return{campaign:e,events:r.events,renderIn(s){s.appendChild(n.canvas)},changeRoom(s){rt({gameState:r,toRoomId:s,changeType:"level-select"})},get currentRoom(){return X(r)},get gameState(){return r},set renderOptions(s){r.renderOptions=s},stop(){console.warn("tearing down game"),n.canvas.parentNode?.removeChild(n.canvas),i.stop(),o(),n.destroy()}}},mi=Object.freeze(Object.defineProperty({__proto__:null,gameMain:hi},Symbol.toStringTag,{value:"Module"}));export{un as A,an as C,pe as F,Ar as R,Fr as S,dn as V,mi as g,Pr as u};
