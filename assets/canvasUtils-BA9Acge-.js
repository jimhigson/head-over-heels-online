import{D as y,g as C,C as I}from"./App-BXuZWElz.js";let m;function x(i){const e=y.get().createCanvas(6,1),a=e.getContext("2d");return a.fillStyle=i,a.fillRect(0,0,6,1),e}function M(){if(m!==void 0)return m;try{const i=x("#ff00ff"),e=x("#ffff00"),n=y.get().createCanvas(6,1).getContext("2d");n.globalCompositeOperation="multiply",n.drawImage(i,0,0),n.drawImage(e,2,0);const t=n.getImageData(2,0,1,1);if(!t)m=!1;else{const o=t.data;m=o[0]===255&&o[1]===0&&o[2]===0}}catch{m=!1}return m}const h={canvas:null,convertTintToImage:!1,cacheStepsPerColorChannel:8,canUseMultiply:M(),tintMethod:null,_canvasSourceCache:new WeakMap,_unpremultipliedCache:new WeakMap,getCanvasSource:i=>{const e=i.source,a=e?.resource;if(!a)return null;const n=e.alphaMode==="premultiplied-alpha",t=e.resourceWidth??e.pixelWidth,o=e.resourceHeight??e.pixelHeight,l=t!==e.pixelWidth||o!==e.pixelHeight;if(n){if((a instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&a instanceof OffscreenCanvas)&&!l)return a;const s=h._unpremultipliedCache.get(e);if(s?.resourceId===e._resourceId)return s.canvas}if(a instanceof Uint8Array||a instanceof Uint8ClampedArray||a instanceof Int8Array||a instanceof Uint16Array||a instanceof Int16Array||a instanceof Uint32Array||a instanceof Int32Array||a instanceof Float32Array||a instanceof ArrayBuffer){const s=h._canvasSourceCache.get(e);if(s?.resourceId===e._resourceId)return s.canvas;const r=y.get().createCanvas(e.pixelWidth,e.pixelHeight),u=r.getContext("2d"),c=u.createImageData(e.pixelWidth,e.pixelHeight),d=c.data,f=a instanceof ArrayBuffer?new Uint8Array(a):new Uint8Array(a.buffer,a.byteOffset,a.byteLength);if(e.format==="bgra8unorm")for(let g=0;g<d.length&&g+3<f.length;g+=4)d[g]=f[g+2],d[g+1]=f[g+1],d[g+2]=f[g],d[g+3]=f[g+3];else d.set(f.subarray(0,d.length));return u.putImageData(c,0,0),h._canvasSourceCache.set(e,{canvas:r,resourceId:e._resourceId}),r}if(n){const s=y.get().createCanvas(e.pixelWidth,e.pixelHeight),r=s.getContext("2d",{willReadFrequently:!0});s.width=e.pixelWidth,s.height=e.pixelHeight,r.drawImage(a,0,0);const u=r.getImageData(0,0,s.width,s.height),c=u.data;for(let d=0;d<c.length;d+=4){const f=c[d+3];if(f>0){const g=255/f;c[d]=Math.min(255,c[d]*g+.5),c[d+1]=Math.min(255,c[d+1]*g+.5),c[d+2]=Math.min(255,c[d+2]*g+.5)}}return r.putImageData(u,0,0),h._unpremultipliedCache.set(e,{canvas:s,resourceId:e._resourceId}),s}if(l){const s=h._canvasSourceCache.get(e);if(s?.resourceId===e._resourceId)return s.canvas;const r=y.get().createCanvas(e.pixelWidth,e.pixelHeight),u=r.getContext("2d");return r.width=e.pixelWidth,r.height=e.pixelHeight,u.drawImage(a,0,0),h._canvasSourceCache.set(e,{canvas:r,resourceId:e._resourceId}),r}return a},getTintedCanvas:(i,e)=>{const a=i.texture,n=I.shared.setValue(e).toHex(),t=a.tintCache||(a.tintCache={}),o=t[n],l=a.source._resourceId;if(o?.tintId===l)return o;const s=o&&"getContext"in o?o:y.get().createCanvas();return h.tintMethod(a,e,s),s.tintId=l,t[n]=s,t[n]},getTintedPattern:(i,e)=>{const a=I.shared.setValue(e).toHex(),n=i.patternCache||(i.patternCache={}),t=i.source._resourceId;let o=n[a];return o?.tintId===t||(h.canvas||(h.canvas=y.get().createCanvas()),h.tintMethod(i,e,h.canvas),o=h.canvas.getContext("2d").createPattern(h.canvas,"repeat"),o.tintId=t,n[a]=o),o},applyPatternTransform:(i,e,a=!0)=>{if(!e)return;const n=i;if(!n.setTransform)return;const t=globalThis.DOMMatrix;if(!t)return;const o=new t([e.a,e.b,e.c,e.d,e.tx,e.ty]);n.setTransform(a?o.inverse():o)},tintWithMultiply:(i,e,a)=>{const n=a.getContext("2d"),t=i.frame.clone(),o=i.source._resolution??i.source.resolution??1,l=i.rotate;t.x*=o,t.y*=o,t.width*=o,t.height*=o;const s=C.isVertical(l),r=s?t.height:t.width,u=s?t.width:t.height;a.width=Math.ceil(r),a.height=Math.ceil(u),n.save(),n.fillStyle=I.shared.setValue(e).toHex(),n.fillRect(0,0,r,u),n.globalCompositeOperation="multiply";const c=h.getCanvasSource(i);if(!c){n.restore();return}l&&h._applyInverseRotation(n,l,t.width,t.height),n.drawImage(c,t.x,t.y,t.width,t.height,0,0,t.width,t.height),n.globalCompositeOperation="destination-atop",n.drawImage(c,t.x,t.y,t.width,t.height,0,0,t.width,t.height),n.restore()},tintWithOverlay:(i,e,a)=>{const n=a.getContext("2d"),t=i.frame.clone(),o=i.source._resolution??i.source.resolution??1,l=i.rotate;t.x*=o,t.y*=o,t.width*=o,t.height*=o;const s=C.isVertical(l),r=s?t.height:t.width,u=s?t.width:t.height;a.width=Math.ceil(r),a.height=Math.ceil(u),n.save(),n.globalCompositeOperation="copy",n.fillStyle=I.shared.setValue(e).toHex(),n.fillRect(0,0,r,u),n.globalCompositeOperation="destination-atop";const c=h.getCanvasSource(i);if(!c){n.restore();return}l&&h._applyInverseRotation(n,l,t.width,t.height),n.drawImage(c,t.x,t.y,t.width,t.height,0,0,t.width,t.height),n.restore()},tintWithPerPixel:(i,e,a)=>{const n=a.getContext("2d"),t=i.frame.clone(),o=i.source._resolution??i.source.resolution??1,l=i.rotate;t.x*=o,t.y*=o,t.width*=o,t.height*=o;const s=C.isVertical(l),r=s?t.height:t.width,u=s?t.width:t.height;a.width=Math.ceil(r),a.height=Math.ceil(u),n.save(),n.globalCompositeOperation="copy";const c=h.getCanvasSource(i);if(!c){n.restore();return}l&&h._applyInverseRotation(n,l,t.width,t.height),n.drawImage(c,t.x,t.y,t.width,t.height,0,0,t.width,t.height),n.restore();const d=e>>16&255,f=e>>8&255,g=e&255,w=n.getImageData(0,0,r,u),v=w.data;for(let p=0;p<v.length;p+=4)v[p]=v[p]*d/255,v[p+1]=v[p+1]*f/255,v[p+2]=v[p+2]*g/255;n.putImageData(w,0,0)},_applyInverseRotation:(i,e,a,n)=>{const t=C.inv(e),o=C.uX(t),l=C.uY(t),s=C.vX(t),r=C.vY(t),u=-Math.min(0,o*a,s*n,o*a+s*n),c=-Math.min(0,l*a,r*n,l*a+r*n);i.transform(o,l,s,r,u,c)}};h.tintMethod=h.canUseMultiply?h.tintWithMultiply:h.tintWithPerPixel;export{M as a,h as c};
