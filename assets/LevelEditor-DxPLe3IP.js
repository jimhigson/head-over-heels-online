import{j as e,r as m}from"./index-D63mWPlL.js";import{at as J,ad as b,H as E,z as re,B as f,S as ae,l as ie,U as Z,ae as y,au as I,ac as A,av as ce,aw as W,Y as B,ax as le,M as ue,ay as de,az as pe,a3 as G,aA as me,aB as T,b as xe,g as _,aC as he,aD as fe,aE as ge,j as V,aF as ve,aG as N,aH as ye,aI as be,Q as R,an as M,o as je,aJ as we,as as Se,aK as ke,aL as Ce,aM as Ne,aN as Te,aO as Re,C as Pe}from"./App-WFwQ2e3R.js";import{B as Y,o as q,n as Ie,S as Ee}from"./ShowBoundingBoxSelect-B-2UlzV2.js";import{useAppSelectorWithLevelEditorSlice as w,selectTool as C,setTool as K,selectCurrentEditingRoomColour as Be,changeRoomColour as L,selectCurrentEditingRoomScenery as $e,changeRoomScenery as ze,selectCurrentEditingRoomJson as H,applyToolToRoomJson as Ae}from"./levelEditorSlice-4S7IFePk.js";import{c as _e,A as Me,s as Le,R as He,i as De,z as Fe,a as Oe,p as Q}from"./roomRenderer-D0NAMd9j.js";import"./Graphics-CwUqsZ2K.js";import"./changeCharacterRoom-ChsNOgPY.js";const $=t=>t,Ue="h-[calc(3*var(--block)-1px*var(--scale))] w-[calc(3*var(--block)-1px*var(--scale))]",c=({itemTool:t,children:o,className:s})=>{const n=w(C),r=J(n?.type==="item"&&n.item,t);return e.jsx(Y,{"data-iscurrenttool":r,className:`active:pt-oneScaledPix ${Ue} gap-0 inline-flex overflow-hidden ${r?"bg-pastelBlue":""} ${s??""}`,onClick:()=>b.dispatch(K({type:"item",item:t})),children:o})},Xe=()=>{const o=w(C)?.type==="pointer";return e.jsx(Y,{className:`flex w-3 h-3 ${o?"bg-pastelBlue":""}`,onClick:()=>b.dispatch(K({type:"pointer"})),children:e.jsx("span",{className:"sprite texture-hud.char.â†– relative [button:active_&]:top-quarter"})})},D=t=>{const{main:o}=_e[t].basic;return{backgroundColor:o.basic.toHex(),borderColor:o.dimmed.toHex()}};function Je(){const t=E(),o=w(Be);return e.jsxs(e.Fragment,{children:[e.jsx(q,{value:o.hue,onSelect:s=>{t(L({hue:s}))},values:re,disableCommandInput:!0,OptionCommandItem:({value:s,onSelect:n})=>e.jsx(Ie,{value:s,className:"border-1 h-4 w-2",style:D(s),onSelect:n}),triggerButtonLabel:e.jsx(f,{children:"colour"}),triggerButtonClassName:$(`${o.hue==="white"?"text-pureBlack":"text-white"}`),triggerButtonStyle:D(o.hue)}),e.jsx(ae,{value:o.shade==="basic",onClick:(s,n)=>{t(L({shade:n?"basic":"dimmed"}))},falseLabel:"dimmed",trueLabel:"basic"})]})}function Ze(){const t=E(),o=w($e);return e.jsx(q,{value:o,onSelect:s=>{t(ze(s))},values:ie,disableCommandInput:!0,triggerButtonClassName:"w-18 text-white",triggerButtonLabel:e.jsx(f,{children:o})})}const a=$("[button:not([data-iscurrenttool=true]):not(:hover)_&]:sprite-revert-to-two-tone"),v=$("flex flex-wrap gap-oneScaledPix w-full"),We=()=>e.jsxs("div",{className:"flex fixed top-0 bottom-0 right-0 w-12 box-content text-white bg-metallicBlueHalfbrite p-half gap-1 flex-wrap justify-start overflow-auto",children:[e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Room"}),e.jsx(Ze,{}),e.jsx(Je,{})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Edit"}),e.jsx(Xe,{})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Monsters"}),e.jsx(c,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}},children:e.jsx("span",{className:`sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek" ${a}`})}),e.jsx(c,{itemTool:{type:"monster",config:{which:"cyberman",activated:"on",movement:"towards-on-shortest-axis-xy4",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-cyberman.towards [button:hover_&]:texture-cyberman.right ${a}`})}),e.jsx(c,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right ${a}`})}),e.jsx(c,{itemTool:{type:"monster",config:{which:"helicopterBug",activated:"on",movement:"patrol-randomly-xy8"}},children:e.jsx("span",{className:`sprite texture-helicopterBug.1 [button:hover_&]:texture-animated-helicopterBug ${a}`})}),e.jsx(c,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right ${a}`})}),e.jsx(c,{itemTool:{type:"monster",config:{which:"homingBot",activated:"on",movement:"towards-tripped-on-axis-xy4"}},children:e.jsx("span",{className:`sprite texture-headlessBase [button:hover_&]:texture-headlessBase.all ${a}`})}),e.jsx(c,{itemTool:{type:"monster",config:{which:"computerBot",activated:"on",movement:"patrol-randomly-xy4-and-reverse"}},children:e.jsx("span",{className:`sprite texture-computerBot.towards [button:hover_&]:texture-computerBot.right ${a}`})}),e.jsx(c,{itemTool:{type:"monster",config:{which:"monkey",activated:"on",movement:"patrol-randomly-xy4"}},children:e.jsx("span",{className:`sprite texture-monkey.towards [button:hover_&]:texture-monkey.right ${a}`})}),e.jsxs(c,{itemTool:{type:"monster",config:{which:"elephant",activated:"on",movement:"patrol-randomly-xy4"}},className:"inline relative",children:[e.jsx("span",{className:`sprite inline-block absolute left-0 texture-headlessBase ${a} [button:active_&]:top-oneScaledPix`}),e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-elephant.towards [button:hover_&]:texture-elephant.right ${a} [button:active_&]:top-oneScaledPix`})]}),e.jsx(c,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"turn-to-player",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-elephant.towards [button:hover_&]:texture-elephant.right ${a}`})}),e.jsxs(c,{itemTool:{type:"monster",config:{which:"emperorsGuardian",activated:"while-player-near",movement:"towards-analogue-unless-planet-crowns"}},className:"inline relative",children:[e.jsx("span",{className:`sprite inline-block absolute left-0 texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold ${a} [button:active_&]:top-oneScaledPix`}),e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-ball [button:hover_&]:texture-ball ${a} [button:active_&]:top-oneScaledPix`})]}),e.jsx(c,{itemTool:{type:"monster",config:{which:"emperor",activated:"while-player-near",movement:"towards-analogue"}},children:e.jsx("span",{className:`sprite texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold ${a}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Blocks"}),e.jsx(c,{itemTool:{type:"block",config:{style:"artificial"}},children:e.jsx("span",{className:`sprite texture-block.artificial ${a}`})}),e.jsx(c,{itemTool:{type:"block",config:{style:"organic"}},children:e.jsx("span",{className:`sprite texture-block.organic ${a}`})}),e.jsx(c,{itemTool:{type:"block",config:{style:"book"}},children:e.jsx("span",{className:`sprite texture-book.x ${a}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Pickups"}),e.jsx(c,{itemTool:{type:"pickup",config:{gives:"extra-life"}},children:e.jsx("span",{className:`sprite texture-whiteRabbit ${a}`})}),e.jsx(c,{itemTool:{type:"pickup",config:{gives:"bag"}},children:e.jsx("span",{className:`sprite texture-bag ${a}`})}),e.jsx(c,{itemTool:{type:"pickup",config:{gives:"hooter"}},children:e.jsx("span",{className:`sprite texture-hooter ${a}`})}),e.jsx(c,{itemTool:{type:"pickup",config:{gives:"doughnuts"}},children:e.jsx("span",{className:`sprite texture-doughnuts ${a}`})}),e.jsx(c,{itemTool:{type:"pickup",config:{gives:"crown",planet:"blacktooth"}},children:e.jsx("span",{className:`sprite texture-crown.blacktooth ${a}`})}),e.jsx(c,{itemTool:{type:"pickup",config:{gives:"scroll",page:"blacktooth"}},children:e.jsx("span",{className:`sprite texture-scroll ${a}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"misc."}),e.jsxs(c,{itemTool:{type:"lift",config:{top:11,bottom:0}},className:"inline relative",children:[e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.static ${a} [button:active_&]:top-oneScaledPix`}),e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.1 [button:hover_&]:texture-animated-lift ${a} [button:active_&]:top-oneScaledPix`})]}),e.jsx(c,{itemTool:{type:"barrier",config:{axis:"x"}},children:e.jsx("span",{className:`sprite texture-barrier.x ${a}`})}),e.jsx(c,{itemTool:{type:"conveyor",config:{direction:"away"}},children:e.jsx("span",{className:`sprite texture-conveyor.y.1 [button:hover_&]:texture-animated-conveyor.x ${a}`})}),e.jsx(c,{itemTool:{type:"teleporter",config:{toRoom:"(placeholder)",toPosition:Z}},children:e.jsx("span",{className:`sprite texture-teleporter ${a}`})}),e.jsx(c,{itemTool:{type:"charles",config:y},children:e.jsx("span",{className:`sprite texture-charles.towards [button:hover_&]:texture-charles.right ${a}`})}),e.jsx(c,{itemTool:{type:"joystick",config:{controls:["(placeholder)"]}},children:e.jsx("span",{className:`sprite texture-joystick ${a}`})}),e.jsx(c,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:I}},children:e.jsx("span",{className:`sprite texture-switch.left [button:hover_&]:texture-switch.right ${a}`})}),e.jsx(c,{itemTool:{type:"ball",config:y},children:e.jsx("span",{className:`sprite texture-ball ${a}`})}),e.jsx(c,{itemTool:{type:"portableBlock",config:{style:"cube"}},children:e.jsx("span",{className:`sprite texture-cube ${a}`})}),e.jsx(c,{itemTool:{type:"pushableBlock",config:{style:"stepStool"}},children:e.jsx("span",{className:`sprite texture-stepStool ${a}`})}),e.jsx(c,{itemTool:{type:"movingPlatform",config:{style:"sandwich",movement:"clockwise",activated:"on",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-sandwich ${a}`})}),e.jsx(c,{itemTool:{type:"spikes",config:y},children:e.jsx("span",{className:`sprite texture-spikes ${a}`})}),e.jsx(c,{itemTool:{type:"deadlyBlock",config:{style:"volcano"}},children:e.jsx("span",{className:`sprite texture-volcano.1 [button:hover_&]:texture-animated-volcano ${a}`})}),e.jsx(c,{itemTool:{type:"slidingDeadly",config:{style:"spikyBall",startingPhase:1}},children:e.jsx("span",{className:`sprite texture-spikyBall.1 [button:hover_&]:texture-spikyBall.2 ${a}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Structure"}),e.jsx(c,{itemTool:{type:"door",config:{direction:"away",toRoom:"(placeholder)"}},children:e.jsx("span",{className:`sprite texture-door.frame.generic.x.whole ${a}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"debug"}),e.jsx(Ee,{})]})]}),ee=m.createContext(null),Ge=()=>{const[t,o]=m.useState(()=>A({roomJson:H(b.getState()),roomPickupsCollected:y,scrollsRead:y,isNewGame:!0})),s=w(H);return m.useEffect(()=>{const n=A({roomJson:s,roomPickupsCollected:y,scrollsRead:y,isNewGame:!0});o(n)},[s]),t},Ve=({children:t})=>{const o=Ge();return e.jsx(ee,{value:o,children:t})},z=()=>{const t=m.useContext(ee);if(t===null)throw new Error("no room state in context, or no context");return t},te=m.createContext(null),Ye=({children:t})=>{const[o,s]=m.useState(null);return m.useEffect(()=>{const n=new Me;return n.init({background:Le.pureBlack,sharedTicker:!0}).then(()=>{s(n)}),()=>{}},[]),o===null?null:e.jsx(te,{value:o,children:t})},j=()=>m.useContext(te),qe=(t,o)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:o},soundSettings:{mute:!0},pixiRenderer:t,gameState:void 0,paused:!1,colourised:!0,upscale:W(b.getState())}),F=(t,o,s)=>new He({room:t,general:qe(o,s)}),Ke=()=>{const{renderer:t}=j(),o=ce();if(!t)throw new Error("this should never be falsey (typescript violation)");const s=z(),[n,r]=m.useState(()=>F(s,t,o));return m.useEffect(()=>{const i=F(s,t,o);return r(i),()=>{i.destroy()}},[s,t,o]),n},k="cursor",O=({room:t,pointingAt:o,valid:s,includeCursor:n,previewItems:r})=>{const{face:i,position:u}=o;for(const d of r)le({room:t,item:d});if(n){const d=ue(k,t.items);d?(d.state.position=u,d.state.face=i,d.state.valid=s):t.items[k]={type:"cursor",id:k,state:{...pe(),face:i,position:u,valid:s},config:{},aabb:de}}else delete t.items[k]},P=t=>{for(const o of B(t.items))o.isCursorPreview&&delete t.items[o.id]};let Qe=0;const oe=(t,o,s)=>{if(t.face==="up")return T(t.position);if(s.type==="door"){const r=o.items[t.itemId];if(r.type!=="wall")return;const{config:i,aabb:u,state:{position:d}}=r,x={x:1,y:1,...i.times},l=xe(_(i.direction)),p=_(i.direction);if(x[l]<2)return;const h=d[l],g=d[l]+u[l]-he,S=d.z,se=d.z+u.z-fe,ne={[l]:Math.max(Math.min(t.position[l],g),h),[p]:t.position[p],z:Math.max(Math.min(t.position.z,se),S)};return T(ne)}const n=ge[t.face];return V(T(t.position),n)},U=(t,o,s)=>{const n=[...B(o.items).filter(x=>G(x)&&x.type!=="cursor"&&!x.isCursorPreview)],r=(x,l,p)=>{const h=ve(`cursor/${Qe++}`,{type:x,config:l,position:p},o.roomJson).toArray();return h.forEach(g=>{g.isCursorPreview=!0}),h},i=oe(t,o,s);if(i===void 0)return;if(s.type==="door"){const x=o.items[t.itemId];if(x.type!=="wall")return;const l=x.config.direction;return r("door",{...s.config,direction:l},i)}const u=r(s.type,s.config,i);return u.some(x=>{const l=me(x,n);return!De(l)})?void 0:u},et=({x:t,y:o})=>s=>{const{bottomCentre:n,topLeft:r,topRight:i}=Q(s.state.position,s.aabb);return!(t<r.x||t>i.x||o<i.y-(i.x-t)/2||o<r.y-(t-r.x)/2||o>n.y-(t-n.x)/2||o>n.y-(n.x-t)/2)},tt=(t,{x:o,y:s},n)=>{if(n.type==="item"&&n.item.type==="door"&&t.type==="wall")return ye(t.config.direction);const{bottomCentre:r,topLeft:i,topRight:u}=Q(t.state.position,t.aabb);return s<i.y-(i.x-o)/2?s<u.y-(o-u.x)/2?"up":"right":o<r.x?"towards":"right"},X=t=>t.fixedZIndex!==void 0,ot=t=>{if(t.every(X))return t.toSorted((i,u)=>u.fixedZIndex-i.fixedZIndex).at(0);const o=t.filter(i=>!X(i));if(o.length===0)return;if(o.length===1)return o[0];const s=Object.fromEntries(o.map(i=>[i.id,i])),n=Fe(s),{order:r}=Oe(n,s);return s[r[0]]},st=({state:{position:t},aabb:o},s,n,r)=>{let i=Z,u;switch(s){case"up":i={z:o.z},u="xy";break;case"down":u="xy";break;case"towards":u="xz";break;case"away":i={y:o.y},u="xz";break;case"left":i={x:o.x},u="yz";break;case"right":u="yz";break;default:throw new Error('unexpected face "'+s+'"')}const d=be(n,V(t,i),u),l=r.type==="item"&&r.item.type==="door"?R.w:R.w/2,p=R.h,h=l/2,g=p/2;return{x:u==="yz"?Math.round(d.x/l)*l:Math.floor((d.x-h)/l)*l,y:u==="xz"?Math.round(d.y/l)*l:Math.floor((d.y-h)/l)*l,z:u==="xy"?Math.round(d.z/p)*p:Math.floor((d.z+g)/p)*p}},nt=t=>o=>{const s=G(o)&&o.type!=="cursor"&&!o.isCursorPreview;return t.type==="item"&&t.item.type==="door"?s&&o.type==="wall":s},rt=(t,o,s)=>{const n=ot(Array.from(B(o.items).filter(nt(s)).filter(et(t))));if(n){const r=tt(n,t,s);return{itemId:n.id,face:r,position:st(n,r,t,s)}}else return},at=(t,o)=>{const s=t.cssUpscale*t.gameEngineUpscale;return{x:o.x/s-t.gameEngineScreenSize.x/2,y:o.y/s-t.gameEngineScreenSize.y+16}},it=t=>{const o=j(),s=N(W),n=E(),r=z(),i=m.useRef(void 0);m.useEffect(()=>{if(o.stage.eventMode="none",t===null)return;const u=x=>{const l=at(s,x),p=C(b.getState()),h=rt(l,r,p);if(!J(h,i.current))if(i.current=h,h!==void 0)switch(p.type){case"item":{const g=U(h,r,p.item),S=g!==void 0;P(r),O({room:r,pointingAt:h,valid:S,includeCursor:!S,previewItems:g??I});break}case"pointer":{P(r),O({room:r,pointingAt:h,valid:!0,includeCursor:!0,previewItems:I});break}}else P(r)},d=x=>{const l=C(b.getState());switch(l.type){case"item":{const p=i.current;if(p===void 0||U(p,r,l.item)===void 0)return;n(Ae({blockPosition:oe(p,r,l.item),pointedAtItem:r.items[p.itemId]}));break}}};return t.addEventListener("mousemove",u),t.addEventListener("click",d),()=>{t.removeEventListener("mousemove",u),t.removeEventListener("click",d)}},[o.stage,s,t,n,r])},ct=t=>{const o=z();m.useEffect(()=>{let s=0;const n=({deltaMS:r})=>{if(t.destroyed)return;t.renderContext.room!==o&&console.warn("room renderer does not have the current room");const i=new Set(je(o.items));t.tick({deltaMS:r,movedItems:i,progression:s++})};return M.shared.add(n),()=>{M.shared.remove(n)}},[t,o])},lt=t=>{const o=j();m.useEffect(()=>{if(t)return t.appendChild(o.canvas),()=>{t.removeChild(o.canvas)}},[t,o])},ut=()=>{const t=j(),o=N(s=>s.upscale.upscale.gameEngineUpscale);t.stage.scale=o},dt=()=>{const t=j(),o=N(we);m.useEffect(()=>{t.renderer?.resize(o.x,o.y)},[t.renderer,o])},pt=t=>{const o=j(),[s]=m.useState(()=>new Se),n=N(ke);m.useEffect(()=>{if(t.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return s.addChild(t.output.graphics),o.stage.addChild(s),()=>{o.stage.removeChild(s),s.removeChild(t.output.graphics)}},[t,o,s]),m.useEffect(()=>{s.x=n.x/2,s.y=n.y-16},[s,n])};Ne.defaultOptions.scaleMode="nearest";const mt=()=>{const t=Ke(),[o,s]=m.useState(null);dt(),pt(t),ct(t),it(o),lt(o),ut();const n=Ce();return e.jsx("div",{style:n,ref:s})},jt=()=>(Te(),Re(),e.jsxs(e.Fragment,{children:[e.jsx("title",{children:"Hoh Editor"}),e.jsx(Ye,{children:e.jsx(Ve,{children:e.jsx(mt,{})})}),e.jsx(Pe,{scaleFactor:2,children:e.jsx(We,{})})]}));export{jt as default};
