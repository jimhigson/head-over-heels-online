import{j as t,r as u}from"./index-BndJllJT.js";import{B as J,o as G,n as ae,S as ie}from"./ShowBoundingBoxSelect-BkZn_3fG.js";import{ap as W,a9 as g,w as P,z as ce,B as q,S as le,s as ue,N as V,aa as y,aq as N,a8 as _,ar as pe,as as K,R as I,at as de,F as me,au as xe,av as he,$ as Y,aw as fe,ax as R,ay as ye,az as A,aA as ge,U as Q,aB as ve,aC as C,aD as be,aE as je,K as ee,aj as M,o as we,aF as Se,ao as ke,aG as Ce,aH as Re,aI as Te,aJ as Ne,aK as Pe,C as Ie}from"./App-B7olYmBA.js";import{useAppSelectorWithLevelEditorSlice as w,selectTool as k,setTool as te,selectCurrentEditingRoomColour as Ee,changeRoomColour as L,selectCurrentEditingRoomScenery as Be,changeRoomScenery as $e,selectCurrentEditingRoomJson as F,applyToolAtPosition as ze}from"./levelEditorSlice-DqAmANnr.js";import{c as _e,A as Ae,s as Me,R as Le,i as Fe,z as De,a as He,p as oe}from"./roomRenderer-BCXnDx2U.js";import"./Graphics-DS-AYXGJ.js";import"./changeCharacterRoom-D7p7stiV.js";const E=e=>e,c=({itemTool:e,children:o,className:s})=>{const a=w(k),r=W(a?.type==="item"&&a.item,e);return t.jsx(J,{"data-iscurrenttool":r,className:`active:pt-oneScaledPix h-3 w-3 gap-0 inline-flex overflow-hidden ${r?"bg-pastelBlue":""} ${s??""}`,onClick:()=>g.dispatch(te({type:"item",item:e})),children:o})},Oe=()=>{const o=w(k)?.type==="pointer";return t.jsx(J,{className:`flex w-3 h-3 ${o?"bg-pastelBlue":""}`,onClick:()=>g.dispatch(te({type:"pointer"})),children:t.jsx("span",{className:"sprite texture-hud.char.â†– relative [button:active_&]:top-quarter"})})},D=e=>{const{main:o}=_e[e].basic;return{backgroundColor:o.basic.toHex(),borderColor:o.dimmed.toHex()}};function Ue(){const e=P(),o=w(Ee);return t.jsxs(t.Fragment,{children:[t.jsx(G,{value:o.hue,onSelect:s=>{e(L({hue:s}))},values:ce,disableCommandInput:!0,OptionCommandItem:({value:s,onSelect:a})=>t.jsx(ae,{value:s,className:"border-1 h-4 w-2",style:D(s),onSelect:a}),triggerButtonLabel:t.jsx(q,{children:"colour"}),triggerButtonClassName:E(`${o.hue==="white"?"text-pureBlack":"text-white"}`),triggerButtonStyle:D(o.hue)}),t.jsx(le,{value:o.shade==="basic",onClick:(s,a)=>{e(L({shade:a?"basic":"dimmed"}))},falseLabel:"dimmed",trueLabel:"basic"})]})}function Xe(){const e=P(),o=w(Be);return t.jsx(G,{value:o,onSelect:s=>{e($e(s))},values:ue,disableCommandInput:!0,triggerButtonClassName:"w-18 text-white",triggerButtonLabel:t.jsx(q,{children:o})})}const i=E("[button:not([data-iscurrenttool=true]):not(:hover)_&]:sprite-revert-to-two-tone"),b=E("flex flex-wrap gap-oneScaledPix w-full"),Ze=()=>t.jsxs("div",{className:"flex fixed top-0 right-0 w-14 text-white bg-metallicBlueHalfbrite p-half gap-oneScaledPix flex-wrap justify-start",children:[t.jsx(Xe,{}),t.jsx(Ue,{}),t.jsx("div",{className:b,children:t.jsx(Oe,{})}),t.jsxs("div",{className:b,children:[t.jsx(c,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}},children:t.jsx("span",{className:`sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek" ${i}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"cyberman",activated:"on",movement:"towards-on-shortest-axis-xy4",startDirection:"towards"}},children:t.jsx("span",{className:`sprite texture-cyberman.towards [button:hover_&]:texture-cyberman.right ${i}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}},children:t.jsx("span",{className:`sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right ${i}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"helicopterBug",activated:"on",movement:"patrol-randomly-xy8"}},children:t.jsx("span",{className:`sprite texture-helicopterBug.1 [button:hover_&]:texture-animated-helicopterBug ${i}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}},children:t.jsx("span",{className:`sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right ${i}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"homingBot",activated:"on",movement:"towards-tripped-on-axis-xy4"}},children:t.jsx("span",{className:`sprite texture-headlessBase [button:hover_&]:texture-headlessBase.all ${i}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"computerBot",activated:"on",movement:"patrol-randomly-xy4-and-reverse"}},children:t.jsx("span",{className:`sprite texture-computerBot.towards [button:hover_&]:texture-computerBot.right ${i}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"monkey",activated:"on",movement:"patrol-randomly-xy4"}},children:t.jsx("span",{className:`sprite texture-monkey.towards [button:hover_&]:texture-monkey.right ${i}`})}),t.jsxs(c,{itemTool:{type:"monster",config:{which:"elephant",activated:"on",movement:"patrol-randomly-xy4"}},className:"inline relative",children:[t.jsx("span",{className:`sprite inline-block absolute left-0 texture-headlessBase ${i} [button:active_&]:top-oneScaledPix`}),t.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-elephant.towards [button:hover_&]:texture-elephant.right ${i} [button:active_&]:top-oneScaledPix`})]}),t.jsx(c,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"turn-to-player",startDirection:"towards"}},children:t.jsx("span",{className:`sprite texture-elephant.towards [button:hover_&]:texture-elephant.right ${i}`})}),t.jsxs(c,{itemTool:{type:"monster",config:{which:"emperorsGuardian",activated:"while-player-near",movement:"towards-analogue-unless-planet-crowns"}},className:"inline relative",children:[t.jsx("span",{className:`sprite inline-block absolute left-0 texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold ${i} [button:active_&]:top-oneScaledPix`}),t.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-ball [button:hover_&]:texture-ball ${i} [button:active_&]:top-oneScaledPix`})]}),t.jsx(c,{itemTool:{type:"monster",config:{which:"emperor",activated:"while-player-near",movement:"towards-analogue"}},children:t.jsx("span",{className:`sprite texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold ${i}`})})]}),t.jsxs("div",{className:b,children:[t.jsx(c,{itemTool:{type:"block",config:{style:"artificial"}},children:t.jsx("span",{className:`sprite texture-block.artificial ${i}`})}),t.jsx(c,{itemTool:{type:"block",config:{style:"organic"}},children:t.jsx("span",{className:`sprite texture-block.organic ${i}`})}),t.jsx(c,{itemTool:{type:"block",config:{style:"book"}},children:t.jsx("span",{className:`sprite texture-book.x ${i}`})})]}),t.jsxs("div",{className:b,children:[t.jsx(c,{itemTool:{type:"pickup",config:{gives:"extra-life"}},children:t.jsx("span",{className:`sprite texture-whiteRabbit ${i}`})}),t.jsx(c,{itemTool:{type:"pickup",config:{gives:"bag"}},children:t.jsx("span",{className:`sprite texture-bag ${i}`})}),t.jsx(c,{itemTool:{type:"pickup",config:{gives:"hooter"}},children:t.jsx("span",{className:`sprite texture-hooter ${i}`})}),t.jsx(c,{itemTool:{type:"pickup",config:{gives:"doughnuts"}},children:t.jsx("span",{className:`sprite texture-doughnuts ${i}`})}),t.jsx(c,{itemTool:{type:"pickup",config:{gives:"crown",planet:"blacktooth"}},children:t.jsx("span",{className:`sprite texture-crown.blacktooth ${i}`})})]}),t.jsxs("div",{className:b,children:[t.jsxs(c,{itemTool:{type:"lift",config:{top:11,bottom:0}},className:"inline relative",children:[t.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.static ${i} [button:active_&]:top-oneScaledPix`}),t.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.1 [button:hover_&]:texture-animated-lift ${i} [button:active_&]:top-oneScaledPix`})]}),t.jsx(c,{itemTool:{type:"barrier",config:{axis:"x"}},children:t.jsx("span",{className:`sprite texture-barrier.x ${i}`})}),t.jsx(c,{itemTool:{type:"conveyor",config:{direction:"away"}},children:t.jsx("span",{className:`sprite texture-conveyor.y.1 [button:hover_&]:texture-animated-conveyor.x ${i}`})}),t.jsx(c,{itemTool:{type:"teleporter",config:{toRoom:"(placeholder)",toPosition:V}},children:t.jsx("span",{className:`sprite texture-teleporter ${i}`})}),t.jsx(c,{itemTool:{type:"charles",config:y},children:t.jsx("span",{className:`sprite texture-charles.towards [button:hover_&]:texture-charles.right ${i}`})}),t.jsx(c,{itemTool:{type:"joystick",config:{controls:["(placeholder)"]}},children:t.jsx("span",{className:`sprite texture-joystick ${i}`})}),t.jsx(c,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:N}},children:t.jsx("span",{className:`sprite texture-switch.left [button:hover_&]:texture-switch.right ${i}`})}),t.jsx(c,{itemTool:{type:"ball",config:y},children:t.jsx("span",{className:`sprite texture-ball ${i}`})}),t.jsx(c,{itemTool:{type:"portableBlock",config:{style:"cube"}},children:t.jsx("span",{className:`sprite texture-cube ${i}`})}),t.jsx(c,{itemTool:{type:"pushableBlock",config:{style:"stepStool"}},children:t.jsx("span",{className:`sprite texture-stepStool ${i}`})}),t.jsx(c,{itemTool:{type:"movingPlatform",config:{style:"sandwich",movement:"clockwise",activated:"on",startDirection:"towards"}},children:t.jsx("span",{className:`sprite texture-sandwich ${i}`})}),t.jsx(c,{itemTool:{type:"spikes",config:y},children:t.jsx("span",{className:`sprite texture-spikes ${i}`})}),t.jsx(c,{itemTool:{type:"deadlyBlock",config:{style:"volcano"}},children:t.jsx("span",{className:`sprite texture-volcano.1 [button:hover_&]:texture-animated-volcano ${i}`})}),t.jsx(c,{itemTool:{type:"slidingDeadly",config:{style:"spikyBall",startingPhase:1}},children:t.jsx("span",{className:`sprite texture-spikyBall.1 [button:hover_&]:texture-spikyBall.2 ${i}`})}),t.jsx(c,{itemTool:{type:"door",config:{direction:"away",toRoom:"(placeholder)"}},children:t.jsx("span",{className:`sprite texture-door.frame.generic.x.whole ${i}`})})]}),t.jsx("div",{className:"flex flex-row gap-1",children:t.jsx(ie,{})})]}),se=u.createContext(null),Je=()=>{const[e,o]=u.useState(()=>_({roomJson:F(g.getState()),roomPickupsCollected:y,scrollsRead:y,isNewGame:!0})),s=w(F);return u.useEffect(()=>{const a=_({roomJson:s,roomPickupsCollected:y,scrollsRead:y,isNewGame:!0});o(a)},[s]),e},Ge=({children:e})=>{const o=Je();return t.jsx(se,{value:o,children:e})},B=()=>{const e=u.useContext(se);if(e===null)throw new Error("no room state in context, or no context");return e},ne=u.createContext(null),We=({children:e})=>{const[o,s]=u.useState(null);return u.useEffect(()=>{const a=new Ae;return a.init({background:Me.pureBlack,sharedTicker:!0}).then(()=>{s(a)}),()=>{}},[]),o===null?null:t.jsx(ne,{value:o,children:e})},v=()=>u.useContext(ne),qe=(e,o)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:o},soundSettings:{mute:!0},pixiRenderer:e,gameState:void 0,paused:!1,colourised:!0,upscale:K(g.getState())}),H=(e,o,s)=>new Le({room:e,general:qe(o,s)}),Ve=()=>{const{renderer:e}=v(),o=pe();if(!e)throw new Error("this should never be falsey (typescript violation)");const s=B(),[a,r]=u.useState(()=>H(s,e,o));return u.useEffect(()=>{const n=H(s,e,o);return r(n),()=>{n.destroy()}},[s,e,o]),a},S="cursor",O=({room:e,pointingAt:o,valid:s,includeCursor:a,previewItems:r})=>{const{face:n,position:l}=o;for(const p of r)de({room:e,item:p});if(a){const p=me(S,e.items);p?(p.state.position=l,p.state.face=n,p.state.valid=s):e.items[S]={type:"cursor",id:S,state:{...he(),face:n,position:l,valid:s},config:{},aabb:xe}}else delete e.items[S]},T=e=>{for(const o of I(e.items))o.isCursorPreview&&delete e.items[o.id]};let Ke=0;const re=(e,o,s)=>{if(e.face==="up")return R(e.position);if(s.type==="door"){const r=o.items[e.itemId];if(r.type!=="wall")return;const n={x:Math.max(Math.min(e.position.x,r.state.position.x+r.aabb.x-A),r.state.position.x),y:Math.max(Math.min(e.position.y,r.state.position.y+r.aabb.y-A),r.state.position.y),z:Math.max(Math.min(e.position.z,r.state.position.z+r.aabb.z-ye),r.state.position.z)};return R(n)}const a=ge[e.face];return Q(R(e.position),a)},U=(e,o,s)=>{const a=[...I(o.items).filter(n=>Y(n)&&n.type!=="cursor"&&!n.isCursorPreview)],r=(n,l)=>{const p=re(e,o,s),d=ve(`cursor/${Ke++}`,{type:n,config:l,position:p},o.roomJson).toArray();return d.forEach(x=>{x.isCursorPreview=!0}),d};if(s.type==="door"){const n=o.items[e.itemId];if(n.type!=="wall")return;const l=n.config.direction;return r("door",{...s.config,direction:l})}else{const n=r(s.type,s.config);return n.some(p=>{const d=fe(p,a);return!Fe(d)})?void 0:n}},m=ee.w/2,j=ee.h,X=m/2,Ye=j/2,Qe=({x:e,y:o})=>s=>{const{bottomCentre:a,topLeft:r,topRight:n}=oe(s.state.position,s.aabb);return!(e<r.x||e>n.x||o<n.y-(n.x-e)/2||o<r.y-(e-r.x)/2||o>a.y-(e-a.x)/2||o>a.y-(a.x-e)/2)},et=(e,{x:o,y:s},a)=>{if(a.type==="item"&&a.item.type==="door"&&e.type==="wall")return be(e.config.direction);const{bottomCentre:r,topLeft:n,topRight:l}=oe(e.state.position,e.aabb);return s<n.y-(n.x-o)/2?s<l.y-(o-l.x)/2?"up":"right":o<r.x?"towards":"right"},Z=e=>e.fixedZIndex!==void 0,tt=e=>{if(e.every(Z))return e.toSorted((n,l)=>l.fixedZIndex-n.fixedZIndex).at(0);const o=e.filter(n=>!Z(n));if(o.length===0)return;if(o.length===1)return o[0];const s=Object.fromEntries(o.map(n=>[n.id,n])),a=De(s),{order:r}=He(a,s);return s[r[0]]},ot=({state:{position:e},aabb:o},s,a)=>{let r=V,n;switch(s){case"up":r={z:o.z},n="xy";break;case"down":n="xy";break;case"towards":n="xz";break;case"away":r={y:o.y},n="xz";break;case"left":r={x:o.x},n="yz";break;case"right":n="yz";break;default:throw new Error('unexpected face "'+s+'"')}const l=je(a,Q(e,r),n);return{x:n==="yz"?Math.round(l.x/m)*m:Math.floor((l.x-X)/m)*m,y:n==="xz"?Math.round(l.y/m)*m:Math.floor((l.y-X)/m)*m,z:n==="xy"?Math.round(l.z/j)*j:Math.floor((l.z+Ye)/j)*j}},st=e=>o=>{const s=Y(o)&&o.type!=="cursor"&&!o.isCursorPreview;return e.type==="item"&&e.item.type==="door"?s&&o.type==="wall":s},nt=(e,o,s)=>{const a=tt(Array.from(I(o.items).filter(st(s)).filter(Qe(e))));if(a){const r=et(a,e,s);return{itemId:a.id,face:r,position:ot(a,r,e)}}else return},rt=(e,o)=>{const s=e.cssUpscale*e.gameEngineUpscale;return{x:o.x/s-e.gameEngineScreenSize.x/2,y:o.y/s-e.gameEngineScreenSize.y+16}},at=e=>{const o=v(),s=C(K),a=P(),r=B(),n=u.useRef(void 0);u.useEffect(()=>{if(o.stage.eventMode="none",e===null)return;const l=d=>{const x=rt(s,d),h=k(g.getState()),f=nt(x,r,h);if(!W(f,n.current))if(n.current=f,f!==void 0)switch(h.type){case"item":{const $=U(f,r,h.item),z=$!==void 0;T(r),O({room:r,pointingAt:f,valid:z,includeCursor:!z,previewItems:$??N});break}case"pointer":{T(r),O({room:r,pointingAt:f,valid:!0,includeCursor:!0,previewItems:N});break}}else T(r)},p=d=>{const x=k(g.getState());switch(x.type){case"item":{const h=n.current;if(h===void 0||U(h,r,x.item)===void 0)return;a(ze({blockPosition:re(h,r,x.item)}));break}}};return e.addEventListener("mousemove",l),e.addEventListener("click",p),()=>{e.removeEventListener("mousemove",l),e.removeEventListener("click",p)}},[o.stage,s,e,a,r])},it=e=>{const o=B();u.useEffect(()=>{let s=0;const a=({deltaMS:r})=>{if(e.destroyed)return;e.renderContext.room!==o&&console.warn("room renderer does not have the current room");const n=new Set(we(o.items));e.tick({deltaMS:r,movedItems:n,progression:s++})};return M.shared.add(a),()=>{M.shared.remove(a)}},[e,o])},ct=e=>{const o=v();u.useEffect(()=>{if(e)return e.appendChild(o.canvas),()=>{e.removeChild(o.canvas)}},[e,o])},lt=()=>{const e=v(),o=C(s=>s.upscale.upscale.gameEngineUpscale);e.stage.scale=o},ut=()=>{const e=v(),o=C(Se);u.useEffect(()=>{e.renderer?.resize(o.x,o.y)},[e.renderer,o])},pt=e=>{const o=v(),[s]=u.useState(()=>new ke),a=C(Ce);u.useEffect(()=>{if(e.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return s.addChild(e.output.graphics),o.stage.addChild(s),()=>{o.stage.removeChild(s),s.removeChild(e.output.graphics)}},[e,o,s]),u.useEffect(()=>{s.x=a.x/2,s.y=a.y-16},[s,a])};Te.defaultOptions.scaleMode="nearest";const dt=()=>{const e=Ve(),[o,s]=u.useState(null);ut(),pt(e),it(e),at(o),ct(o),lt();const a=Re();return t.jsx("div",{style:a,ref:s})},bt=()=>(Ne(),Pe(),t.jsxs(t.Fragment,{children:[t.jsx("title",{children:"Hoh Editor"}),t.jsx(We,{children:t.jsx(Ge,{children:t.jsx(dt,{})})}),t.jsx(Ie,{scaleFactor:2,children:t.jsx(Ze,{})})]}));export{bt as default};
