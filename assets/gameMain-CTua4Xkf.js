const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-BP4O_z1I.js","assets/index-CpqBEu7p.js","assets/index-BjHlzwDb.css","assets/colorToUniform-KTpA7KSL.js","assets/SharedSystems-XYbQ6ZNH.js","assets/Graphics-Bn5eFjjp.js","assets/WebGLRenderer-DW4-K5PK.js"])))=>i.map(i=>d[i]);
import{s as ao,x as Tn,y as ge,e as Ot,E as he,a as lo,C as y,d as at,v as lt,Z as O,D as ct,a5 as Dt,k as co,K as Ee,t as be,T as we,U as uo,a6 as ho,a7 as fo,a8 as po,a9 as w,aa as Cn,ab as mo,ac as kn,ad as vo,ae as We,af as z,ag as On,ah as dt,ai as Ne,aj as g,ak as go,al as X,am as Et,an as fe,ao as ue,ap as Te,aq as In,ar as ut,as as yo,at as ee,au as I,av as ht,aw as xo,ax as Pn,ay as Ce,az as $,aA as bo,aB as re,aC as C,aD as R,aE as wo,aF as ye,aG as Ue,aH as To,aI as ft,aJ as Nt,aK as ne,aL as Co,aM as ko,aN as $t,aO as Oo,aP as ie,aQ as Ke,aR as pt,aS as Bt,aT as Qe,aU as It,aV as Pt,aW as Z,aX as Io,aY as pe,aZ as _n,a_ as xe,a$ as Le,b0 as L,b1 as J,b2 as Ge,b3 as Fn,b4 as Ht,b5 as Po,b6 as An,b7 as P,b8 as _o,b9 as mt,ba as $e,bb as Fo,bc as Ao,bd as Sn,be as So,bf as me,bg as Be,bh as _t,bi as se,bj as Ro,bk as zo,bl as Mo,bm as Do,bn as Wt,bo as vt,bp as gt,bq as yt,br as Eo,bs as ve,bt as No,bu as Ft,bv as $o,bw as Bo,bx as Ho,by as b,bz as K,bA as et,bB as Rn,bC as ze,bD as Wo,bE as Uo,bF as Lo,bG as tt,bH as Go,bI as Vo,bJ as Xo,bK as jo,bL as qo,bM as Jo,bN as Zo}from"./index-CpqBEu7p.js";import{S as Yo,G as oe}from"./Graphics-Bn5eFjjp.js";const zn=class xt extends ao{constructor(t){t={...xt.defaultOptions,...t},super(t),this.enabled=!0,this._state=Yo.for2d(),this.blendMode=t.blendMode,this.padding=t.padding,typeof t.antialias=="boolean"?this.antialias=t.antialias?"on":"off":this.antialias=t.antialias,this.resolution=t.resolution,this.blendRequired=t.blendRequired,this.clipToViewport=t.clipToViewport,this.addResource("uTexture",0,1)}apply(t,n,o,r){t.applyFilter(this,n,o,r)}get blendMode(){return this._state.blendMode}set blendMode(t){this._state.blendMode=t}static from(t){const{gpu:n,gl:o,...r}=t;let s,i;return n&&(s=Tn.from(n)),o&&(i=ge.from(o)),new xt({gpuProgram:s,glProgram:i,...r})}};zn.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1,clipToViewport:!0};let Ve=zn;const bt=[];Ot.handleByNamedList(he.Environment,bt);async function Ko(e){if(!e)for(let t=0;t<bt.length;t++){const n=bt[t];if(n.value.test()){await n.value.load();return}}}let ae;function Qo(){if(typeof ae=="boolean")return ae;try{ae=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{ae=!1}return ae}var Mn=(e=>(e[e.NONE=0]="NONE",e[e.COLOR=16384]="COLOR",e[e.STENCIL=1024]="STENCIL",e[e.DEPTH=256]="DEPTH",e[e.COLOR_DEPTH=16640]="COLOR_DEPTH",e[e.COLOR_STENCIL=17408]="COLOR_STENCIL",e[e.DEPTH_STENCIL=1280]="DEPTH_STENCIL",e[e.ALL=17664]="ALL",e))(Mn||{});class er{constructor(t){this.items=[],this._name=t}emit(t,n,o,r,s,i,a,l){const{name:d,items:c}=this;for(let u=0,h=c.length;u<h;u++)c[u][d](t,n,o,r,s,i,a,l);return this}add(t){return t[this._name]&&(this.remove(t),this.items.push(t)),this}remove(t){const n=this.items.indexOf(t);return n!==-1&&this.items.splice(n,1),this}contains(t){return this.items.indexOf(t)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const tr=["init","destroy","contextChange","resolutionChange","reset","renderEnd","renderStart","render","update","postrender","prerender"],Dn=class En extends lo{constructor(t){super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=t.type,this.name=t.name,this.config=t;const n=[...tr,...this.config.runners??[]];this._addRunners(...n),this._unsafeEvalCheck()}async init(t={}){const n=t.skipExtensionImports===!0?!0:t.manageImports===!1;await Ko(n),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const o in this._systemsHash)t={...this._systemsHash[o].constructor.defaultOptions,...t};t={...En.defaultOptions,...t},this._roundPixels=t.roundPixels?1:0;for(let o=0;o<this.runners.init.items.length;o++)await this.runners.init.items[o].init(t);this._initOptions=t}render(t,n){let o=t;if(o instanceof y&&(o={container:o},n&&(at(lt,"passing a second argument is deprecated, please use render options instead"),o.target=n.renderTexture)),o.target||(o.target=this.view.renderTarget),o.target===this.view.renderTarget&&(this._lastObjectRendered=o.container,o.clearColor=this.background.colorRgba),o.clearColor){const r=Array.isArray(o.clearColor)&&o.clearColor.length===4;o.clearColor=r?o.clearColor:O.shared.setValue(o.clearColor).toArray()}o.transform||(o.container.updateLocalTransform(),o.transform=o.container.localTransform),o.container.enableRenderGroup(),this.runners.prerender.emit(o),this.runners.renderStart.emit(o),this.runners.render.emit(o),this.runners.renderEnd.emit(o),this.runners.postrender.emit(o)}resize(t,n,o){const r=this.view.resolution;this.view.resize(t,n,o),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),o!==void 0&&o!==r&&this.runners.resolutionChange.emit(o)}clear(t={}){const n=this;t.target||(t.target=n.renderTarget.renderTarget),t.clearColor||(t.clearColor=this.background.colorRgba),t.clear??(t.clear=Mn.ALL);const{clear:o,clearColor:r,target:s}=t;O.shared.setValue(r??this.background.colorRgba),n.renderTarget.clear(s,o,O.shared.toArray())}get resolution(){return this.view.resolution}set resolution(t){this.view.resolution=t,this.runners.resolutionChange.emit(t)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...t){t.forEach(n=>{this.runners[n]=new er(n)})}_addSystems(t){let n;for(n in t){const o=t[n];this._addSystem(o.value,o.name)}}_addSystem(t,n){const o=new t(this);if(this[n])throw new Error(`Whoops! The name "${n}" is already in use`);this[n]=o,this._systemsHash[n]=o;for(const r in this.runners)this.runners[r].add(o);return this}_addPipes(t,n){const o=n.reduce((r,s)=>(r[s.name]=s.value,r),{});t.forEach(r=>{const s=r.value,i=r.name,a=o[i];this.renderPipes[i]=new s(this,a?new a:null)})}destroy(t=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(t),Object.values(this.runners).forEach(n=>{n.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(t){return this.textureGenerator.generateTexture(t)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!Qo())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}};Dn.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let Nn=Dn,ke;function nr(e){return ke!==void 0||(ke=(()=>{const t={stencil:!0,failIfMajorPerformanceCaveat:e??Nn.defaultOptions.failIfMajorPerformanceCaveat};try{if(!ct.get().getWebGLRenderingContext())return!1;let o=ct.get().createCanvas().getContext("webgl",t);const r=!!o?.getContextAttributes()?.stencil;if(o){const s=o.getExtension("WEBGL_lose_context");s&&s.loseContext()}return o=null,r}catch{return!1}})()),ke}let Oe;async function or(e={}){return Oe!==void 0||(Oe=await(async()=>{const t=ct.get().getNavigator().gpu;if(!t)return!1;try{return await(await t.requestAdapter(e)).requestDevice(),!0}catch{return!1}})()),Oe}const Ut=["webgl","webgpu","canvas"];async function rr(e){let t=[];e.preference?(t.push(e.preference),Ut.forEach(s=>{s!==e.preference&&t.push(s)})):t=Ut.slice();let n,o={};for(let s=0;s<t.length;s++){const i=t[s];if(i==="webgpu"&&await or()){const{WebGPURenderer:a}=await Dt(async()=>{const{WebGPURenderer:l}=await import("./WebGPURenderer-BP4O_z1I.js");return{WebGPURenderer:l}},__vite__mapDeps([0,1,2,3,4,5]));n=a,o={...e,...e.webgpu};break}else if(i==="webgl"&&nr(e.failIfMajorPerformanceCaveat??Nn.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:a}=await Dt(async()=>{const{WebGLRenderer:l}=await import("./WebGLRenderer-DW4-K5PK.js");return{WebGLRenderer:l}},__vite__mapDeps([6,1,2,3,4,5]));n=a,o={...e,...e.webgl};break}else if(i==="canvas")throw o={...e},new Error("CanvasRenderer is not yet implemented")}if(delete o.webgpu,delete o.webgl,!n)throw new Error("No available renderer for the current environment");const r=new n;return await r.init(o),r}const $n="8.6.6";class Bn{static init(){globalThis.__PIXI_APP_INIT__?.(this,$n)}static destroy(){}}Bn.extension=he.Application;class sr{constructor(t){this._renderer=t}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,$n)}destroy(){this._renderer=null}}sr.extension={type:[he.WebGLSystem,he.WebGPUSystem],name:"initHook",priority:-10};const Hn=class wt{constructor(...t){this.stage=new y,t[0]!==void 0&&at(lt,"Application constructor options are deprecated, please use Application.init() instead.")}async init(t){t={...t},this.renderer=await rr(t),wt._plugins.forEach(n=>{n.init.call(this,t)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return at(lt,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(t=!1,n=!1){const o=wt._plugins.slice(0);o.reverse(),o.forEach(r=>{r.destroy.call(this)}),this.stage.destroy(n),this.stage=null,this.renderer.destroy(t),this.renderer=null}};Hn._plugins=[];let Wn=Hn;Ot.handleByList(he.Application,Wn._plugins);Ot.add(Bn);var ir=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,ar=`
in vec2 vTextureCoord;

out vec4 finalColor;

uniform float uAlpha;
uniform sampler2D uTexture;

void main()
{
    finalColor =  texture(uTexture, vTextureCoord) * uAlpha;
}
`,Lt=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct AlphaUniforms {
  uAlpha:f32,
};

@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;

@group(1) @binding(0) var<uniform> alphaUniforms : AlphaUniforms;

struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>
  };

fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

fn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  
}

fn getSize() -> vec2<f32>
{
  return gfu.uGlobalFrame.zw;
}
  
@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition)
  );
}

@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
  @builtin(position) position: vec4<f32>
) -> @location(0) vec4<f32> {
 
    var sample = textureSample(uTexture, uSampler, uv);
    
    return sample * alphaUniforms.uAlpha;
}`;const Un=class Ln extends Ve{constructor(t){t={...Ln.defaultOptions,...t};const n=Tn.from({vertex:{source:Lt,entryPoint:"mainVertex"},fragment:{source:Lt,entryPoint:"mainFragment"}}),o=ge.from({vertex:ir,fragment:ar,name:"alpha-filter"}),{alpha:r,...s}=t,i=new co({uAlpha:{value:r,type:"f32"}});super({...s,gpuProgram:n,glProgram:o,resources:{alphaUniforms:i}})}get alpha(){return this.resources.alphaUniforms.uniforms.uAlpha}set alpha(t){this.resources.alphaUniforms.uniforms.uAlpha=t}};Un.defaultOptions={alpha:1};let lr=Un;class He extends Ee{constructor(...t){let n=t[0];Array.isArray(t[0])&&(n={textures:t[0],autoUpdate:t[1]});const{textures:o,autoUpdate:r,...s}=n,[i]=o;super({...s,texture:i instanceof be?i:i.texture}),this._textures=null,this._durations=null,this._autoUpdate=r??!0,this._isConnectedToTicker=!1,this.animationSpeed=1,this.loop=!0,this.updateAnchor=!1,this.onComplete=null,this.onFrameChange=null,this.onLoop=null,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=o}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(we.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(we.shared.add(this.update,this,uo.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(t){this.stop(),this.currentFrame=t}gotoAndPlay(t){this.currentFrame=t,this.play()}update(t){if(!this._playing)return;const n=t.deltaTime,o=this.animationSpeed*n,r=this.currentFrame;if(this._durations!==null){let s=this._currentTime%1*this._durations[this.currentFrame];for(s+=o/60*1e3;s<0;)this._currentTime--,s+=this._durations[this.currentFrame];const i=Math.sign(this.animationSpeed*n);for(this._currentTime=Math.floor(this._currentTime);s>=this._durations[this.currentFrame];)s-=this._durations[this.currentFrame]*i,this._currentTime+=i;this._currentTime+=s/this._durations[this.currentFrame]}else this._currentTime+=o;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):r!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<r||this.animationSpeed<0&&this.currentFrame>r)&&this.onLoop(),this._updateTexture())}_updateTexture(){const t=this.currentFrame;this._previousFrame!==t&&(this._previousFrame=t,this.texture=this._textures[t],this.updateAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(){this.stop(),super.destroy(),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(t){const n=[];for(let o=0;o<t.length;++o)n.push(be.from(t[o]));return new He(n)}static fromImages(t){const n=[];for(let o=0;o<t.length;++o)n.push(be.from(t[o]));return new He(n)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(t){if(t[0]instanceof be)this._textures=t,this._durations=null;else{this._textures=[],this._durations=[];for(let n=0;n<t.length;n++)this._textures.push(t[n].texture),this._durations.push(t[n].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let t=Math.floor(this._currentTime)%this._textures.length;return t<0&&(t+=this._textures.length),t}set currentFrame(t){if(t<0||t>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${t}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const n=this.currentFrame;this._currentTime=t,n!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(t){t!==this._autoUpdate&&(this._autoUpdate=t,!this._autoUpdate&&this._isConnectedToTicker?(we.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(we.shared.add(this.update,this),this._isConnectedToTicker=!0))}}var Ie={},Gt;function cr(){if(Gt)return Ie;Gt=1;var e=ho(),t=e.mark(s),n=fo(),o=n.wrapWithIterableIterator,r=n.ensureIterable;function s(){var a,l,d,c,u,h,f=arguments;return e.wrap(function(v){for(;;)switch(v.prev=v.next){case 0:for(a=f.length,l=new Array(a),d=0;d<a;d++)l[d]=f[d];c=0,u=l;case 2:if(!(c<u.length)){v.next=8;break}return h=u[c],v.delegateYield(r(h),"t0",5);case 5:c++,v.next=2;break;case 8:case"end":return v.stop()}},t)}Ie.__concat=s;var i=o(s);return Ie.concat=i,Ie}var nt,Vt;function dr(){return Vt||(Vt=1,nt=cr().concat),nt}var ur=dr();const Me=po(ur),Xt={x:.5,y:1},jt=e=>typeof e!="string"&&Object.hasOwn(e,"frames"),p=e=>{if(typeof e=="string")return p({texture:e});{const{anchor:t,flipX:n,pivot:o,x:r,y:s,filter:i}=e;let a;if(jt(e)?a=hr(e):a=new Ee(w.textures[e.texture]),t===void 0&&o===void 0)if(jt(e))a.anchor=Xt;else{const l=w.data.frames[e.texture].frame;l.pivot!==void 0?a.pivot=l.pivot:a.anchor=Xt}else t!==void 0&&(a.anchor=t),o!==void 0&&(a.pivot=o);return r!==void 0&&(a.x=r),s!==void 0&&(a.y=s),i!==void 0&&(a.filters=i),a.eventMode="static",n===!0&&(a.scale.x=-1),a}};function hr({frames:e,animationSpeed:t,reverse:n,playOnce:o}){const r=e.map(i=>({texture:i,time:Cn}));n&&r.reverse();const s=new He(r);return s.animationSpeed=t||mo,s.play(),o!==void 0&&(s.loop=!1,s.onComplete=()=>{s.stop(),o==="and-destroy"&&(s.visible=!1)}),s}const fr=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Å","Ä","Ö","0","1","2","3","4","5","6","7","8","9","!","@","#","$","%","^","&","*","(",")","-","_","=","+","[","]","{","}",";",":","'",'"',",",".","/","<",">","?","\\","|"," ","Enter","Shift","Control","`","~","Tab","Backspace","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Numpad0","Numpad1","Numpad2","Numpad3","Numpad4","Numpad5","Numpad6","Numpad7","Numpad8","Numpad9","NumpadAdd","NumpadSubtract","NumpadMultiply","NumpadDivide","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"],qt=e=>fr.includes(e),Gn=["jump","fire","carry","swop","hold"],Vn=()=>({...kn(Gn.map(e=>[e,!1])),windowFocus:!0,direction:{x:0,y:0,z:0}}),pr=Object.freeze(Vn()),V={right:["P"],towards:["A"],left:["O"],away:["Q"],jump:[" ","M"],carry:["C","M"],fire:["N"],swop:["Enter","S"],hold:["H"]},mr={right:["ArrowRight",...V.right],towards:["ArrowDown",...V.towards],left:["ArrowLeft",...V.left],away:["ArrowUp",...V.away],jump:["`",...V.jump],carry:["Shift","`",...V.carry],fire:["D",...V.fire],swop:V.swop,hold:["F8",...V.hold]};function*Jt(e,t){for(const[n,o]of vo(e))o.includes(t)&&(yield n)}const Zt=e=>e.length===1?e.toUpperCase():e,Yt=e=>e==="away"||e==="towards"||e==="left"||e==="right",vr=({keyAssignment:e,inputState:t,onInputStateChange:n})=>{let o=0;const r={},s=()=>{let c=-1,u;for(const[h,f]of We(r))f>c&&(c=f,u=h);t.direction=u===void 0?z:On[u]},i=({key:c,repeat:u})=>{if(u)return;const h=Zt(c);if(!qt(h)){console.log("do not recognise key: ",h);return}for(const f of Jt(e,h))Yt(f)?r[f]=o++:t[f]=!0;s(),n?.(t)},a=({key:c})=>{const u=Zt(c);if(qt(u)){for(const h of Jt(e,u))Yt(h)?delete r[h]:t[h]=!1;s(),n?.(t)}},l=()=>{t.windowFocus=!0,n?.(t)},d=()=>{t.windowFocus=!1;for(const c of Gn)t[c]=!1;n?.(t)};return window.focus(),window.addEventListener("keydown",i,!1),window.addEventListener("keyup",a,!1),window.addEventListener("focus",l,!1),window.addEventListener("blur",d,!1),()=>{window.removeEventListener("keydown",i,!1),window.removeEventListener("keyup",a,!1),window.removeEventListener("focus",l,!1),window.removeEventListener("blur",d,!1)}};function gr(e){return{all:e=e||new Map,on:function(t,n){var o=e.get(t);o?o.push(n):e.set(t,[n])},off:function(t,n){var o=e.get(t);o&&(n?o.splice(o.indexOf(n)>>>0,1):e.set(t,[]))},emit:function(t,n){var o=e.get(t);o&&o.slice().map(function(r){r(n)}),(o=e.get("*"))&&o.slice().map(function(r){r(t,n)})}}}const yr=e=>{const t={};for(const n of Object.values(e.rooms))for(const o of Object.values(n.items))if(o.type==="player"){const{which:r}=o.config;t[r]=n.id}if(t.head===void 0&&t.heels===void 0)throw new Error("couldn't find either head or heels in campaign");return t},xr=({campaign:e,renderOptions:t})=>{const n=yr(e),o=kn(Object.keys(e.rooms).map(i=>[i,{}])),r=n.head&&dt(e.rooms[n.head],o[n.head],!0),s=n.heels===n.head?r:n.heels&&dt(e.rooms[n.heels],o[n.heels],!0);return{keyAssignment:mr,currentCharacterName:n.head===void 0?"heels":"head",characterRooms:{head:r,heels:s},entryState:{head:r===void 0?void 0:Ne(r.items.head),heels:s===void 0?void 0:Ne(s.items.heels)},inputState:Vn(),renderOptions:t,campaign:e,events:gr(),pickupsCollected:o,gameTime:0,progression:0,gameSpeed:1}},br={showBoundingBoxes:"none",showShadowMasks:!1,scaleFactor:1},D={original:new O("rgb(255, 255, 255)"),basic:new O("rgb(210, 210, 210)"),dimmed:new O("rgb(120, 120, 120)")},E={original:new O("rgb(255, 255, 0)"),basic:new O("hsl(50,58%,70%)"),dimmed:g.redShadow},W={original:new O("rgb(255, 0, 255)"),basic:g.pink,dimmed:new O("hsl(290,25%,40%)")},T={original:new O("rgb(0, 255, 255)"),basic:new O("hsl(183, 28%, 50%)"),dimmed:new O("hsl(183, 28%,39%)")},U={original:new O("rgb(0, 255, 0)"),basic:g.moss,dimmed:new O("hsl(73,35%,35%)")},At={white:{basic:{main:D,edges:{towards:T,right:E},hud:{lives:E,dimmed:W,icons:T}},dimmed:{main:D,edges:{towards:U,right:T},hud:{lives:E,dimmed:W,icons:T}}},yellow:{basic:{main:E,edges:{towards:U,right:D},hud:{lives:T,dimmed:W,icons:U}},dimmed:{main:E,edges:{towards:T,right:T},hud:{lives:T,dimmed:W,icons:U}}},magenta:{basic:{main:W,edges:{towards:U,right:T},hud:{lives:D,dimmed:T,icons:E}},dimmed:{main:W,edges:{towards:U,right:T},hud:{lives:D,dimmed:T,icons:E}}},cyan:{basic:{main:T,edges:{towards:W,right:D},hud:{lives:D,dimmed:U,icons:E}},dimmed:{main:T,edges:{towards:W,right:D},hud:{lives:D,dimmed:U,icons:E}}},green:{basic:{main:U,edges:{towards:T,right:E},hud:{lives:D,dimmed:W,icons:T}},dimmed:{main:U,edges:{towards:T,right:E},hud:{lives:D,dimmed:W,icons:T}}}},Xn=e=>At[e.hue][e.shade],St=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,wr=`in vec2 vTextureCoord;
out vec4 finalColor;

const int SWOP_COUNT = \${SWOP_COUNT};

uniform sampler2D uTexture;
uniform vec3 uOriginal[SWOP_COUNT];
uniform vec3 uReplacement[SWOP_COUNT];

// colours are floats so check if they're very close rather than exactly equal:
bool colorsEffectivelyEqual(vec3 color1, vec3 color2) {       
    return distance(color1, color2) < 0.05;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a == 0.0 ) {
        finalColor = c;
        return;
    }
    
    for(int i = 0; i < SWOP_COUNT; i++) {
        if ( colorsEffectivelyEqual(c.rgb, uOriginal[i]) ) {
            finalColor = vec4(uReplacement[i], c.a);            
            return;
        }
    }    
    finalColor = vec4(c.rgb, c.a);
}
`;class Xe extends Ve{constructor(t){const n=Object.keys(t).length,o=ge.from({vertex:St,fragment:wr.replace(/\$\{SWOP_COUNT\}/g,n.toFixed(0)),name:"palette-swop-filter"});super({glProgram:o,resources:{colorReplaceUniforms:{uOriginal:{value:new Float32Array(3*n),type:"vec3<f32>",size:n},uReplacement:{value:new Float32Array(3*n),type:"vec3<f32>",size:n}}}});const r=this.resources.colorReplaceUniforms.uniforms;Object.entries(t).forEach(([s,i],a)=>{g[s].toArray().forEach((l,d)=>{r.uOriginal[a*3+d]=l}),i.toArray().forEach((l,d)=>{r.uReplacement[a*3+d]=l})})}}const jn=({basic:e,dimmed:t})=>({replaceLight:e,replaceDark:t}),qn=e=>jn(At[e.color.hue][e.color.shade].main),Tr=e=>new Xe({lightBeige:g.lightGrey,redShadow:g.shadow,pink:g.lightGrey,moss:g.lightGrey,midRed:g.midGrey,highlightBeige:g.lightGrey,...qn(e)}),Cr=new Xe({midGrey:g.midRed,lightGrey:g.lightBeige,white:g.highlightBeige,metallicBlue:g.redShadow,pink:g.midRed,moss:g.midRed,replaceDark:g.midRed,replaceLight:g.lightBeige}),Tt=(e,t)=>new Xe(jn(At[e.color.hue][e.color.shade].edges[t])),q=e=>new Xe(qn(e)),ce=go,kr=`precision mediump float;
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uSourceBlacks[2];
uniform vec3 uTargetColor;

// colours are floats so check if they're very close rather than exactly equal:
bool colorsEffectivelyEqual(vec3 color1, vec3 color2) {    
    
    return distance(color1, color2) < 0.05;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a == 0.0 ) {
        finalColor = c;
        return;
    }

    if ( colorsEffectivelyEqual(c.rgb, uSourceBlacks[0]) || colorsEffectivelyEqual(c.rgb, uSourceBlacks[1])) {
        finalColor = vec4(0,0,0, 1.0);
    } else {
        finalColor = vec4(uTargetColor, 1);    
    }
}
`,Kt=[g.pureBlack,g.lightBlack];class de extends Ve{uniforms;constructor(t="white"){const n=ge.from({vertex:St,fragment:kr,name:"revert-colourise-filter"});super({glProgram:n,resources:{colorReplaceUniforms:{uSourceBlacks:{value:new Float32Array(6),type:"vec3<f32>",size:6},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms;const[o,r,s]=Kt[0].toArray();this.uniforms.uSourceBlacks[0]=o,this.uniforms.uSourceBlacks[1]=r,this.uniforms.uSourceBlacks[2]=s;const[i,a,l]=Kt[1].toArray();this.uniforms.uSourceBlacks[3]=i,this.uniforms.uSourceBlacks[4]=a,this.uniforms.uSourceBlacks[5]=l,this.targetColor=t}set targetColor(t){const[n,o,r]=new O(t).toArray();this.uniforms.uTargetColor[0]=n,this.uniforms.uTargetColor[1]=o,this.uniforms.uTargetColor[2]=r}}function je(e,t){const n=t||new y;for(const o of e)n.addChild(o);return n}const Jn=e=>{const t=X(e,"head"),n=X(e,"heels");return t!==void 0&&n!==void 0&&t.state.action==="idle"&&n.state.action==="idle"&&t.state.standingOn===n},Or=24,Ir=56,Pr=80,Qt=112,le=e=>e==="heels"?1:-1;function*_r(e){const t=e.toString().split(""),n=t.length;for(let o=0;o<n;o++){const r=`hud.char.${t[o]}`;yo(r),yield p({texture:r,x:(o+.5-n/2)*In.w})}}function Pe(e,t){for(const n of e.children)n.destroy();je(_r(t),e)}const Fr=e=>{const t=new de,n=new de,o=new de,r=new de,s=(d=!1)=>{const c=d?2:1,u=new y;return u.scale={x:1,y:c},u},i=d=>{const c=new Ee(w.textures[`${d}.walking.${d==="head"?"right":"towards"}.2`]);return c.anchor={x:.5,y:0},c},a=(d,c=!1,u=!1)=>{const h=new y;h.pivot={x:4,y:16};const f=new Ee({texture:w.textures[d],anchor:c?{x:.5,y:0}:{x:.5,y:1},filters:t,y:c?0:8});h.addChild(f);const m=s();return m.y=c?0:16,m.filters=n,m.x=f.x=In.w/2,h.addChild(m),u&&(m.visible=!1),{text:m,icon:f,container:h}},l={head:{sprite:i("head"),livesText:s(!0),shield:a("hud.shield"),extraSkill:a("hud.fastSteps"),donuts:a("donuts",!0),hooter:a("hooter",!0,!0)},heels:{sprite:i("heels"),livesText:s(!0),shield:a("hud.shield"),extraSkill:a("hud.bigJumps"),bag:a("bag",!0,!0),carrying:{container:new y}}};for(const d of Et)e.addChild(l[d].livesText),e.addChild(l[d].sprite),e.addChild(l[d].shield.container),e.addChild(l[d].extraSkill.container);return e.addChild(l.head.donuts.container),e.addChild(l.head.hooter.container),e.addChild(l.heels.bag.container),e.addChild(l.heels.carrying.container),(d,c)=>{const u=fe(d),{hud:{dimmed:h,lives:f,icons:m}}=Xn(u.color),v=x=>{const _=Te(d,x),H=_?.shieldCollectedAt??null,{text:S,container:Ye}=l[x].shield,{text:so,container:Mt}=l[x].extraSkill;Mt.x=Ye.x=(c.x>>1)+le(x)*Pr;const io=_!==void 0&&H!==null&&_?.gameTime<=H+ut?100-Math.ceil((_.gameTime-H)/(ut/100)):0;Pe(S,io),Ye.y=c.y,Pe(so,_===void 0?0:x==="head"?_.fastSteps:_.bigJumps),Mt.y=c.y-24},B=x=>{const{currentCharacterName:_}=d,H=_===x||_==="headOverHeels",S=l[x].sprite;H?S.filters=ce:Jn(d)?(r.targetColor=h.basic,S.filters=r):S.filters=o,S.x=(c.x>>1)+le(x)*Ir,S.y=c.y-ue.h},k=x=>{const H=Te(d,x)?.lives??0,S=l[x].livesText;S.x=(c.x>>1)+le(x)*Or,S.y=c.y,S.tint=f.basic,Pe(S,H??0)},A=x=>{const{container:_}=l.heels.carrying,H=_.children.length>0;if(x===null&&H)for(const S of _.children)S.destroy();x!==null&&!H&&_.addChild(p(x.type==="spring"?"spring.released":x.config.style))};o.targetColor=h.dimmed,n.targetColor=h.basic,t.targetColor=m.basic;for(const x of Et)k(x),B(x),v(x);l.head.hooter.container.x=l.head.donuts.container.x=(c.x>>1)+le("head")*Qt,l.head.donuts.container.y=c.y-ue.h-8,l.heels.carrying.container.y=c.y-ue.h,l.heels.carrying.container.x=l.heels.bag.container.x=(c.x>>1)+le("heels")*Qt,l.heels.bag.container.y=l.head.hooter.container.y=c.y-8;const G=Te(d,"head"),M=G?.hasHooter??!1;l.head.hooter.icon.filters=M?ce:o;const j=G?.donuts??0;l.head.donuts.icon.filters=j!==0?ce:o,Pe(l.head.donuts.text,j);const Je=Te(d,"heels"),Ze=Je?.hasBag??!1;A(Je?.carrying??null),l.heels.bag.icon.filters=Ze?ce:o}},en={movementType:"vel",vels:{gravity:z}},Ar=(e,t,n)=>{if(!ee(e))return en;const{type:o,state:{vels:{gravity:{z:r}},standingOn:s}}=e,a=xo[(o==="headOverHeels"?"head":o)==="head"?"head":"others"];return s!==null?I("lift")(s)&&s.state.vels.lift.z<0?{movementType:"vel",vels:{gravity:{z:Math.max(r-ht*n,-a)}}}:en:{movementType:"vel",vels:{gravity:{z:Math.max(r-ht*n,-a)}}}},_e=e=>{const n=e/bo*Cn;return(e+.5*ht*n**2)/n},Sr={head:_e(Ce.head),headOnSpring:_e(Ce.head+$.h),heels:_e(Ce.heels),heelsOnSpring:_e(Ce.heels+$.h)},Rr=(e,t)=>Sr[`${e==="headOverHeels"?"head":e}${t?"OnSpring":""}`],Zn=({type:e,state:{standingOn:t}},n)=>{const{inputState:{jump:o}}=n,r=t!==null&&I("teleporter")(t);if(!(o&&t!==null&&!r))return t!==null?{movementType:"steady",stateDelta:{jumped:!1}}:Pn;const i=I("spring")(t);return{movementType:"vel",vels:{gravity:{z:Rr(e,i)}},stateDelta:{action:"moving",jumped:!0}}},zr=({vel:e,acc:t,unitD:n,maxSpeed:o,deltaMS:r,crossComponentFade:s=0,minVelocity:i=0})=>{const a=re(e,n),l=Math.max(a+t*r,i),d=l>=o,c=wo(n),u=re(e,c),h=u>=0?Math.max(u-s*r,0):Math.min(u+s*r,0);return C(R(n,d?o:l),R(c,h))},tn={movementType:"vel",vels:{walking:z}},Yn=(e,{inputState:t,currentCharacterName:n},o)=>{const{type:r,state:{action:s,autoWalk:i,standingOn:a,facing:l,teleporting:d,vels:{walking:c,gravity:u}}}=e,f=n===e.id?t:pr,m=r==="headOverHeels"?"heels":r,v=i?l:f.direction,B=ye[m];if(d!==null||s==="death")return tn;if(r==="heels"){if(a===null)return e.state.jumped?{movementType:"vel",vels:{walking:Ue(c,R(c,To*o))}}:tn;if(f.jump){const j=ft(v,ne)?l:v,Ze=I("spring")(a)?1:Co;return{movementType:"vel",vels:{walking:R({...j,z:0},B*Ze)}}}}const k=a===null&&u.z<0;if(!ft(v,z))return k?{movementType:"vel",vels:{walking:R({...v,z:0},B)},stateDelta:{facing:v,action:"falling"}}:{movementType:"vel",vels:{walking:zr({vel:c,acc:ko[m],deltaMS:o,maxSpeed:B,unitD:v,crossComponentFade:$t[m],minVelocity:Nt[m]})},stateDelta:{facing:v,action:"moving"}};const A=Oo(c),G=A===0?z:R(c,1/A),M=Math.max(A-$t[m]*o,0);return{movementType:"vel",vels:{walking:R(G,M<Nt[m]?0:M)},stateDelta:{action:k?"falling":"idle"}}},nn=$.h,Fe=.001,Mr=({totalDistance:e,currentAltitude:t,direction:n})=>{const o=Ke**2/(2*ie);if(n==="up"){if(t<=o)return Math.max(Fe,Math.sqrt(2*ie*Math.max(t,0)));if(t>=e-o){const r=Math.max(0,e-t);return Math.max(Fe,Math.sqrt(2*ie*r))}else return Ke}else if(t>=e-o){const r=Math.max(0,e-t);return Math.min(-Fe,-Math.sqrt(2*ie*r))}else return t<=o?Math.min(-Fe,-Math.sqrt(2*ie*Math.max(t,0))):-Ke};function Dr({config:{bottom:e,top:t},state:{direction:n,position:{z:o}}},r,s){const i=e*nn,a=t*nn,l=Mr({currentAltitude:o-i,direction:n,totalDistance:a-i});if(Number.isNaN(l))throw new Error("velocity is NaN");const d=o<=i?"up":o>=a?"down":n;return{movementType:"vel",vels:{lift:{z:l}},stateDelta:{direction:d}}}const on=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),rn={stopAutowalk:0,portal:0,wall:0,doorLegs:0,sceneryPlayer:0,bubbles:0,block:1,barrier:1,floor:1,book:1,hushPuppy:1,teleporter:1,doorFrame:1,lift:2,movableBlock:2,portableBlock:2,slidingBlock:2,spring:2,ball:3,joystick:3,switch:3,charles:3,conveyor:3,head:4,heels:4,headOverHeels:4,pickup:8,firedDonut:9,slidingDeadly:10,moveableDeadly:10,deadlyBlock:10,baddie:10},Kn=(e,t)=>rn[e.type]-rn[t.type],Er=(e,t)=>t.toSorted((n,o)=>{const r=Kn(n,o);if(r!==0)return r;const s=re(e,on(e,n)),i=re(e,on(e,o));return s-i}),Nr=e=>{const{shieldCollectedAt:t,gameTime:n}=e.type==="headOverHeels"?e.state.head:e.state;return t!==null&&t+ut>n};function Qn({room:{roomTime:e},movingItem:t}){t.state.action!=="death"&&(Nr(t)||(t.state.action="death",t.state.expires=e+pt))}const $r=e=>{const{gameState:t,movingItem:n,touchedItem:o,room:{id:r}}=e;if(t.pickupsCollected[r][o.id]===!0)return;const s=t.pickupsCollected[r];switch(s[o.id]=!0,o.config.gives){case"hooter":{const i=Qe(n);if(i!==void 0){i.hasHooter=!0;break}break}case"donuts":{const i=Qe(n);i!==void 0&&(i.donuts+=6);break}case"bag":{const i=Bt(n);if(i!==void 0){i.hasBag=!0;break}break}case"shield":{n.type==="headOverHeels"?(n.state.head.shieldCollectedAt=n.state.head.gameTime,n.state.heels.shieldCollectedAt=n.state.heels.gameTime):n.state.shieldCollectedAt=n.state.gameTime;break}case"fast":{const i=Qe(n);i!==void 0&&(i.fastSteps=99);break}case"jumps":{const i=Bt(n);i!==void 0&&(i.bigJumps+=10);break}case"extra-life":if(n.type==="headOverHeels"){n.state.head.lives+=2,n.state.heels.lives+=2;break}else n.state.lives+=2;break;case"scroll":t.inputState.jump=!1,t.events.emit("scrollOpened",{markdown:o.config.markdown});break;case"reincarnation":break;case"crown":break;default:o.config}},Br=({gameState:e,movingItem:t,touchedItem:n,movementVector:o})=>{const{config:{relativePoint:r,toRoom:s,direction:i},state:{position:a}}=n;re(i,o)<=0||It({playableItem:t,gameState:e,toRoomId:s,positionRelativeToSourcePortal:Ue(t.state.position,C(a,r)),sourcePortal:n,changeType:"portal"})},Hr=({movingItem:e,movementVector:t,touchedItem:n})=>{const{config:{direction:o,part:r}}=n,s=Pt(o);if(r==="top")return;const i=r==="far"?{x:s==="x"?-Math.abs(t.y):0,y:s==="y"?-Math.abs(t.x):0,z:0}:{x:s==="x"?Math.abs(t.y):0,y:s==="y"?Math.abs(t.x):0,z:0};e.state.position=C(e.state.position,i)};function Wr({movingItem:e}){e.state.autoWalk=!1}const N=(e,...t)=>I(...t)(e.touchedItem),Ae=(e,...t)=>I(...t)(e.movingItem),eo=e=>Z(e.movingItem),Ur=e=>Z(e.touchedItem),sn=e=>{switch(!0){case N(e,"stopAutowalk"):Wr(e);break;case(N(e,...Io)||N(e,"floor")&&e.touchedItem.config.deadly):Qn(e);break;case N(e,"portal"):Br(e);break;case N(e,"pickup"):$r(e);break;case N(e,"doorFrame"):Hr(e);break}},Lr=({touchedItem:e,gameState:{progression:t},room:n})=>{const{config:{activates:o},state:{setting:r,touchedOnProgression:s}}=e;if(e.state.touchedOnProgression=t,t===s+1||t===s)return;const i=e.state.setting=r==="left"?"right":"left";for(const[a,l]of We(o)){const d=n.items[a];d!==void 0&&(d.state={...d.state,...l[i]})}return!1},Gr=({movingItem:e,touchedItem:t})=>{if(!ee(e))return;const{state:{position:n},aabb:o}=t,r=pe(e.state.position,e.aabb,n,o);if(r.x===0&&r.y===0)return;const s=_n(r),i=R(s,-ye.ball);return t.state.vels.sliding=i,!1},Vr=({movingItem:e,touchedItem:t})=>{if(!ee(t))return;const n=e.state.vels.sliding;if(xe(n,z))return;const{state:{position:o},aabb:r}=e,s=pe(t.state.position,t.aabb,o,r);return re(s,e.state.vels.sliding)>0&&(e.state.vels.sliding=z),!1},Xr=({gameState:e,movingItem:t,room:n,touchedItem:o,deltaMS:r})=>{const{config:{controls:s},state:{position:i},aabb:a}=o,l=pe(t.state.position,t.aabb,i,a);if(l.x===0&&l.y===0)return;const d=_n(l);for(const c of s){const u=n.items[c],h=R(d,-ye.charles*r);u.state.facing=h,qe({subjectItem:u,posDelta:h,gameState:e,room:n,pusher:o,deltaMS:r})}},jr=(e,t,n,o)=>{const r=Math.max(0,Math.min(e.x+t.x,n.x+o.x)-Math.max(e.x,n.x)),s=Math.max(0,Math.min(e.y+t.y,n.y+o.y)-Math.max(e.y,n.y));return r*s},an=({state:{position:e},aabb:t},{state:{position:n},aabb:o})=>jr(e,t,n,o),ln=.001,Rt=(e,t,n=.001)=>{if(!ee(t)||e.id===t.id)return!1;const{state:{vels:{gravity:{z:o}}}}=e;return o>0?!1:Le({state:{position:C(e.state.position,{x:0,y:0,z:-ln})},aabb:{...e.aabb,z:n+ln},id:e.id},{state:{position:C(t.state.position,{x:0,y:0,z:t.aabb.z})},aabb:{...t.aabb,z:0},id:t.id})},to=(e,t)=>{const o=[...L(t).filter(s=>Rt(e,s))];return o.length===0?void 0:o.reduce((s,i)=>{const a=Kn(i,s);return a<0||a===0&&an(e,i)>an(e,s)?i:s})},cn=e=>{const t=J(e.movingItem)&&Rt(e.movingItem,e.touchedItem,Math.abs(e.movementVector.z));if(e.touchedItem.state.disappear==="onTouch"||e.touchedItem.state.disappear==="onTouchByPlayer"&&Z(e.movingItem)||e.touchedItem.state.disappear==="onStand"&&t){if(t&&eo(e)){Ge({above:e.movingItem,below:e.touchedItem});const o=[Zn(e.movingItem,e.gameState),Yn(e.movingItem,e.gameState,e.deltaMS)];oo(e.movingItem,o)}Fn(e)}};function qr(e){const t=e.movingItem.type==="baddie"?e.movingItem:e.touchedItem;t.state.busyLickingDoughnutsOffFace=!0}const Jr=e=>{eo(e)&&sn(e),Ur(e)&&sn({...e,movingItem:e.touchedItem,touchedItem:e.movingItem}),N(e,...Ht)&&Gr(e),Ae(e,...Ht)&&Vr(e),(Ae(e,"baddie")&&N(e,"firedDonut")||Ae(e,"firedDonut")&&N(e,"baddie"))&&qr(e),Ae(e,"baddie")&&Po(e),N(e,"switch")&&Lr(e),N(e,"joystick")&&Xr(e),e.touchedItem.state.disappear&&cn(e),e.movingItem.state.disappear&&ee(e.touchedItem)&&cn({...e,movingItem:e.touchedItem,touchedItem:e.movingItem})},qe=({subjectItem:e,posDelta:t,gameState:n,room:o,pusher:r,deltaMS:s,forceful:i=I("lift")(e)&&r===void 0,recursionDepth:a=0})=>{if(xe(t,z))return;if(a>16)throw new Error("this probably means a non-terminating issue");const{state:{position:l}}=e;e.state.position=C(l,t);const d=Er(t,An(e,P(o.items)));for(const c of d){if(!Le(e,c))continue;if(r!==c&&Jr({movingItem:e,touchedItem:c,movementVector:Ue(e.state.position,l),gameState:n,deltaMS:s,room:o}),o.items[e.id]===void 0)return;if(o.items[c.id]===void 0||!ee(c)||!ee(e))continue;const u=pe(e.state.position,e.aabb,c.state.position,c.aabb);if(J(c)&&c!==r){const h=i||_o(c)?-1:-.5,f=R(u,h);if(e.state.position=C(e.state.position,u,f),qe({subjectItem:c,posDelta:f,pusher:e,gameState:n,room:o,deltaMS:s,forceful:i,recursionDepth:a+1}),o.items[c.id]===void 0)continue;e.state.position=C(e.state.position,pe(e.state.position,e.aabb,c.state.position,c.aabb))}else e.state.position=C(e.state.position,u);J(e)&&u.z>0&&(e.state.standingOn===null||!d.includes(e.state.standingOn))&&(mt(e),Ge({above:e,below:c}))}};function Zr(e,t,n){const{state:{teleporting:o,standingOn:r}}=e,{inputState:{jump:s}}=t;if(o===null)return s&&r!==null&&I("teleporter")(r)?{movementType:"steady",stateDelta:{teleporting:{phase:"out",toRoom:r.config.toRoom,timeRemaining:pt}}}:Pn;const i=Math.max(o.timeRemaining-n,0);switch(o.phase){case"out":if(i===0)return It({playableItem:e,gameState:t,toRoomId:o.toRoom,changeType:"teleport"}),{movementType:"steady",stateDelta:{teleporting:{phase:"in",timeRemaining:pt}}};break;case"in":if(i===0)return{movementType:"steady",stateDelta:{teleporting:null}};break}return{movementType:"steady",stateDelta:{teleporting:{...o,timeRemaining:i}}}}const dn={movementType:"vel",vels:{movingFloor:z}},Yr=(e,t,n)=>{if(Z(e)&&e.state.teleporting!==null)return dn;const{state:{standingOn:o}}=e;if(o===null||!I("conveyor")(o))return dn;const{config:{direction:r}}=o,i=I("heels")(e)&&e.state.action==="moving"&&$e(e.state.facing)===Fo(r)?ye.heels:Ao;return{movementType:"vel",vels:{movingFloor:R(On[r],i)}}},Kr=(e,t,n,o)=>{const{inputState:r}=n,s=e.type==="heels"?e.state:e.state.heels,{carrying:i,hasBag:a}=s,{state:{position:l}}=e;if(!a)return;const d=L(P(t.items)).filter(Sn),c=i===null?es(e,t):void 0;for(const u of d)u.state.wouldPickUpNext=!1;if(c!==void 0&&(c.state.wouldPickUpNext=!0),r.carry){if(i===null){if(c===void 0){console.warn("nothing to pick up");return}Qr(t,s,c)}else{if(e.state.standingOn===null||!no(e,P(t.items)))return;const u=So({gameState:n,room:t,itemType:i.type,config:i.config,position:l});qe({subjectItem:e,gameState:n,room:t,posDelta:{x:0,y:0,z:u.aabb.z},pusher:e,forceful:!0,deltaMS:o}),s.carrying=null}r.carry=!1}},Qr=(e,t,n)=>{const o={type:n.type,config:n.config};t.carrying=o,me({room:e,item:n})},es=(e,t)=>to(e,L(P(t.items)).filter(Sn)),no=(e,t)=>{const n={position:C(e.state.position,{z:$.h})},o=An({id:e.id,aabb:e.aabb,state:n},t);for(const r of o)if(!J(r)||!no(r,t))return!1;return!0};function*ts(e,t,n,o){for(;(e.state.latentMovement.at(0)?.moveAtRoomTime??Number.POSITIVE_INFINITY)<t.roomTime;){const{positionDelta:r}=e.state.latentMovement.shift();yield{movementType:"position",posDelta:r}}}const ns=(e,t,n,o)=>{const{inputState:{fire:r}}=n,s=e.type==="head"?e.state:e.state.head,{donuts:i,hasHooter:a,donutLastFireTime:l,gameTime:d}=s,{state:{position:c,facing:u}}=e;if(r&&a&&i>0&&l+500<d){const f={type:"firedDonut",...Be,config:_t,id:`firedDonut/${n.progression}`,shadowCastTexture:"shadow.smallRound",state:{position:C(c,R(u,$.w),e.type==="headOverHeels"?{z:$.h}:z),vels:{fired:R(u,ye.firedDonut)},disappear:"onTouch",expires:null,stoodOnBy:new Set}};se({room:t,item:f}),s.donuts-=1,s.donutLastFireTime=s.gameTime,n.inputState.fire=!1}};function*os(e,t,n,o){J(e)&&(yield Ar(e,n,o),yield Yr(e),yield*ts(e,t)),Z(e)&&(yield Yn(e,n,o),e.id===n.currentCharacterName&&(yield Zr(e,n,o),yield Zn(e,n),zo(e)&&Kr(e,t,n,o),Mo(e)&&ns(e,t,n))),I("lift")(e)&&(yield Dr(e)),I("baddie")(e)&&(yield Do(e,t,n,o))}const rs=(e,t,n,o)=>{Z(e)&&e.state.standingOn!==null&&Ro(e.state.standingOn)&&Qn({gameState:n,room:t,movingItem:e,touchedItem:e.state.standingOn,deltaMS:o,movementVector:{x:0,y:0,z:-1}});const r=[...os(e,t,n,o)];J(e)&&e.state.standingOn!==null&&e.state.standingOn.state.disappear==="onStand"&&Fn({touchedItem:e.state.standingOn,gameState:n,room:t});let s=oo(e,r);(J(e)||I("lift")(e)||I("firedDonut")(e))&&(s=C(s,...L(P(e.state.vels)).map(i=>R(i,o)))),qe({subjectItem:e,posDelta:s,gameState:n,room:t,deltaMS:o})},oo=(e,t)=>{let n=z;for(const o of t){if(o.movementType==="position"&&(n=C(n,o.posDelta)),o.movementType==="vel"&&(J(e)||I("lift")(e)))for(const[s,i]of We(o.vels)){const a={...z,...i};e.state.vels[s]=a}const r=o.stateDelta;r!==void 0&&(e.state={...e.state,...r})}return n},un=(e,...t)=>{const n={};for(const o of t)n[o]=e[o];return n},Ct=e=>{const t={id:"head",type:"head",...Be,...Wt,state:{...vt(),...gt(),...yt(),...e.state.head,facing:e.state.facing,position:C(e.state.position,{z:$.h}),switchedToAt:Number.NEGATIVE_INFINITY}},n={id:"heels",type:"heels",...Be,...Wt,state:{...vt(),...gt(),...yt(),...e.state.heels,facing:e.state.facing,position:C(e.state.position),switchedToAt:Number.NEGATIVE_INFINITY}};return{head:t,heels:n}},zt=({head:e,heels:t})=>({type:"headOverHeels",id:"headOverHeels",...Be,shadowCastTexture:t.shadowCastTexture,config:_t,aabb:Eo,state:{...vt(),...gt(),...yt(),position:t.state.position,action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:t.state.facing,head:{...un(e.state,"hasHooter","donuts","donutLastFireTime","fastSteps","lives","gameTime","shieldCollectedAt"),switchedToAt:Number.NEGATIVE_INFINITY},heels:{...un(t.state,"hasBag","bigJumps","carrying","lives","gameTime","shieldCollectedAt"),switchedToAt:Number.NEGATIVE_INFINITY}}}),ss=e=>{const t=e.characterRooms.head,n=X(e,"head"),o=X(e,"heels"),r=zt({head:n,heels:o});me({room:t,item:"head"}),me({room:t,item:"heels"}),se({room:t,item:r}),e.previousPlayable=e.currentCharacterName,e.currentCharacterName="headOverHeels",e.characterRooms={head:void 0,heels:void 0,headOverHeels:t}},is=e=>{const t=e.characterRooms.headOverHeels,n=X(e,"headOverHeels"),o=ve(e.previousPlayable),{head:r,heels:s}=Ct(n);me({room:t,item:"headOverHeels"}),se({room:t,item:r}),se({room:t,item:s}),Ge({above:r,below:s}),e.currentCharacterName=o,e.previousPlayable=void 0,e.characterRooms={head:t,heels:t,headOverHeels:void 0}},as=e=>{const t=X(e,e.currentCharacterName);t!==void 0&&(t.type==="headOverHeels"?(t.state.head.switchedToAt=t.state.head.gameTime,t.state.heels.switchedToAt=t.state.heels.gameTime):t.state.switchedToAt=t?.state.gameTime)},ls=e=>{if(Jn(e))ss(e);else if(e.currentCharacterName==="headOverHeels")is(e);else{if(X(e,ve(e.currentCharacterName))===void 0)return;e.currentCharacterName=ve(e.currentCharacterName)}as(e)},cs=(e,t)=>{const n=e.characterRooms.headOverHeels;if(t.state.head.lives--,t.state.heels.lives--,t.state.head.lives+t.state.heels.lives===0){e.events.emit("gameOver");return}const r=t.state.head.lives>0,s=t.state.heels.lives>0;if(r&&!s||!r&&s){const d=r?"head":"heels";e.currentCharacterName=d,Q(e,t);const c=Ct(t)[d],u=te({gameState:e,playableItems:[c],roomId:n.id});e.characterRooms={[d]:u},e.entryState={[d]:Ne(c)};return}if(e.entryState.headOverHeels!==void 0){Q(e,t);const d=te({gameState:e,playableItems:[t],roomId:n.id});e.characterRooms={headOverHeels:d};return}else{const{head:d,heels:c}=Ct(t);if(Q(e,d),Q(e,c),Le(d,c)){const u=zt({head:d,heels:c});Q(e,u,"heels");const h=te({gameState:e,playableItems:[u],roomId:n.id});e.characterRooms={headOverHeels:h},e.entryState={headOverHeels:Ne(u)};return}else{const u=te({gameState:e,playableItems:[d,c],roomId:n.id});e.characterRooms={head:u,heels:u};return}}},te=({gameState:e,playableItems:t,roomId:n})=>{const{campaign:o}=e,r=dt(o.rooms[n],e.pickupsCollected[n]);for(const s of t)se({room:r,item:s});return r},Q=(e,t,n=t.id)=>{const o=e.entryState[n];t.state={...t.state,...o,expires:null,standingOn:null}},ds=(e,t)=>{const n=X(e,ve(t.type));if(t.state.lives--,t.type==="heels"&&(t.state.carrying=null),t.state.lives===0)if(delete e.characterRooms[t.id],n!==void 0){e.currentCharacterName=n.type;return}else{e.events.emit("gameOver");return}else{const o=e.characterRooms[t.type];Q(e,t);const r=n===void 0?void 0:e.characterRooms[n.type];if(o===r){if(e.entryState.headOverHeels!==void 0){const a=zt({head:o.items.head,heels:o.items.heels});Q(e,a);const l=te({gameState:e,playableItems:[a],roomId:o.id});e.characterRooms={headOverHeels:l};return}se({room:o,item:t});return}else{const i=te({gameState:e,playableItems:[t],roomId:o.id});e.characterRooms[t.id]=i;return}}},us=(e,t)=>{t.type==="headOverHeels"?cs(e,t):ds(e,t)},hs=e=>{for(const t of P(e.items))for(const n of t.state.stoodOnBy){if(!e.items[n.id]){mt(n);continue}if(!Rt(n,t)){mt(n);const o=to(n,P(e.items));o!==void 0&&Ge({above:n,below:o})}}},fs=(e,t,n)=>{for(const o of e){const r=n[o.id];if(r===void 0)continue;const i={...Ue(o.state.position,r),z:0};if(!xe(i,z))for(const a of o.state.stoodOnBy)a.state.latentMovement.push({moveAtRoomTime:t.roomTime+2*No,positionDelta:i})}},ps=(e,t)=>e.state.expires!==null&&e.state.expires<t.roomTime,ms=(e,t,n)=>{for(const o of P(e.items)){const r=t[o.id];if(r===void 0)continue;xe(r,o.state.position)&&!$o(o.state.position)&&(console.log(`snapping item ${o.id} to pixel grid`),o.state.position=Bo(o.state.position),n.add(o))}},vs=(e,t)=>{const n={lift:-4,head:-3,heels:-3,baddie:-2,block:1,deadlyBlock:1},o=n[e.type]??0,r=n[t.type]??0;return o-r},gs=(e,t)=>{if(e.gameSpeed>1){let n=new Set;for(let o=0;o<e.gameSpeed;o++)n=new Set(Me(n,hn(e,t)));return n}return hn(e,t*e.gameSpeed)},hn=(e,t)=>{const{inputState:n}=e,o=fe(e),r=Object.fromEntries(L(We(o.items)).map(([a,l])=>[a,l.state.position]));n.swop&&(ls(e),n.swop=!1);for(const a of P(o.items))ps(a,o)&&(me({room:o,item:a}),Z(a)&&us(e,a));const s=Object.values(o.items).sort(vs);for(const a of s){if(Ft(e).state.action==="death")break;o.items[a.id]!==void 0&&rs(a,o,e,t)}hs(o);const i=new Set(L(P(o.items)).filter(a=>r[a.id]===void 0||!xe(a.state.position,r[a.id])));return fs(i,o,r),ms(o,r,i),ys(e,o,t),i},ys=(e,t,n)=>{e.progression++,e.gameTime+=n,t.roomTime+=n;const o=Ft(e);if(o.type==="headOverHeels")o.state.head.gameTime+=n,o.state.heels.gameTime+=n;else if(o.state.gameTime+=n,e.characterRooms.head===e.characterRooms.heels){const s=X(e,ve(o.type));s!==void 0&&(s.state.gameTime+=n)}},fn=(e,t)=>{const n=b(e),o=b(C(e,{x:t.x,z:t.z})),r=b(C(e,{y:t.y,z:t.z}));return{bottomCentre:n,topLeft:o,topRight:r}},ot=(e,t,n,o,r=1e-5)=>o-r>e&&n<t-r,xs=(e,t,n,o)=>{const r=fn(e,t),s=fn(n,o),i=r.topLeft.x,a=r.topRight.x,l=s.topLeft.x,d=s.topRight.x,c=ot(i,a,l,d),u=r.topRight.y-r.topRight.x/2,h=r.bottomCentre.y-r.bottomCentre.x/2,f=s.topRight.y-s.topRight.x/2,m=s.bottomCentre.y-s.bottomCentre.x/2,v=ot(u,h,f,m),B=r.topLeft.y+r.topLeft.x/2,k=r.bottomCentre.y+r.bottomCentre.x/2,A=s.topLeft.y+s.topLeft.x/2,G=s.bottomCentre.y+s.bottomCentre.x/2,M=ot(B,k,A,G);return c&&v&&M},bs=(e,t)=>{if(e.renders===!1||t.renders===!1||e.fixedZIndex!==void 0||t.fixedZIndex!==void 0)return 0;const n=e.state.position,o=e.renderAabb||e.aabb,r=t.state.position,s=t.renderAabb||t.aabb;if(!xs(n,o,r,s))return 0;for(const i of Ho){const a=e.state.position[i],l=a+o[i],d=t.state.position[i],c=d+s[i];if(l<=d)return 1*(i==="z"?-1:1);if(a>=c)return-1*(i==="z"?-1:1)}return pn(t)-pn(e)},pn=e=>e.state.position.x+e.state.position.y-e.state.position.z;class De extends Error{constructor(t,n,o){super(`CyclicDependencyError: .cyclicDependency property of this error has nodes as an array. ${t.join(" -> ")}`,o),this.cyclicDependency=t,this.hasClosedCycle=n}}const ws=e=>{const t=Ts(e);let n=t.length,o=n;const r=new Array(n),s={},i=Cs(t);for(;o--;)s[o]||a(t[o],o,new Set);return r;function a(l,d,c){if(c.has(l))throw new De([l],!1);if(s[d])return;s[d]=!0;const u=e.get(l)||new Set,h=Array.from(u);if(d=h.length){c.add(l);do{const f=h[--d];try{a(f,i.get(f),c)}catch(m){throw m instanceof De?m.hasClosedCycle?m:new De([l,...m.cyclicDependency],m.cyclicDependency.includes(l)):m}}while(d);c.delete(l)}r[--n]=l}};function Ts(e){const t=new Set;for(const[n,o]of e.entries()){t.add(n);for(const r of o)t.add(r)}return Array.from(t)}function Cs(e){const t=new Map;for(let n=0,o=e.length;n<o;n++)t.set(e[n],n);return t}const mn=(e,t,n)=>{e.has(t)||e.set(t,new Set),e.get(t).add(n)},Se=(e,t,n)=>{const o=e.get(t);o!==void 0&&(o?.delete(n),o.size===0&&e.delete(t))},ks=(e,t=new Set(P(e)),n=new Map)=>{const o=new Map;for(const[r,s]of n)if(!e[r])n.delete(r);else for(const i of s)e[i]||Se(n,r,i);for(const r of t)if(r.renders)for(const s of P(e)){if(!s.renders||o.get(s)?.has(r)||r===s)continue;const i=bs(r,s);if(mn(o,r,s),i===0){Se(n,r.id,s.id),Se(n,s.id,r.id);continue}const a=i>0?r.id:s.id,l=i>0?s.id:r.id;mn(n,a,l),Se(n,l,a)}return n},ro=(e,t,n=3)=>{try{return{order:ws(e),impossible:!1}}catch(o){if(o instanceof De){const r=o.cyclicDependency;return e.get(r[0])?.delete(r[1]),{order:ro(e,t,n-1).order,impossible:!0}}else throw o}},Os=(e,t,n,o)=>`${e}${o?".dark":""}.wall.${t}.${n}`,Is=(e,t,n)=>{const r=w.textures[`door.frame.${e.planet}.${t}.near`]!==void 0?e.planet:"generic",s=e.color.shade==="dimmed"&&w.textures[`door.frame.${r}.dark.${t}.${n}`]!==void 0;return`door.frame.${r}${s?".dark":""}.${t}.${n}`},Re=e=>F(()=>p(e)),F=e=>({item:t,room:n,currentlyRenderedProps:o,renderOptions:r})=>{if(o===void 0)return{container:e({item:t,room:n,renderOptions:r}),renderProps:_t}};function*Ps({config:{direction:e,inHiddenWall:t,height:n}},o){const r=Pt(e),s=r==="y"?1:16;function*i(a){if(t){if(n!==0){const d=p({pivot:{x:r==="x"?18:8,y:12},texture:`generic.door.floatingThreshold.${r}`,...et(a,{y:-$.h*n})});d.filters=Tt(o,r==="x"?"towards":"right"),yield d}}else{yield p({pivot:{x:s,y:9},texture:"generic.door.legs.base",...et(a,{})});for(let l=1;l<n;l++)yield p({pivot:{x:s,y:9},texture:"generic.door.legs.pillar",...et(a,{y:-l*$.h})})}}yield*i(K({...ne,[r]:1})),yield*i(ne),t||(yield p({pivot:{x:16,y:$.h*n+13},texture:`generic.door.legs.threshold.double.${r}`,...K({...ne,[r]:1})}))}const _s=F(({item:e,room:t})=>je(Ps(e,t),new y({filters:q(t)})));function*Fs({config:{direction:e,part:t}},n){const o=Pt(e);yield p({texture:Is(n,o,t),filter:q(n)})}const As=F(({item:e,room:t})=>je(Fs(e,t))),rt={frames:w.animations["bubbles.cold"],animationSpeed:.25},Y=({top:e,bottom:t="headless-base",filter:n})=>{const o=new y({filters:n});o.addChild(p(t));const r=p(e);return r.y=-12,o.addChild(r),o},Ss=`#version 300 es

in vec2 vTextureCoord;
out vec4 finalColor;

uniform vec2 uTextureSize;
uniform sampler2D uTexture;
uniform vec3 uOutline;
uniform float uOutlineWidth;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a != 0.0 ) {
        finalColor = c;
        return;
    }

    vec2 texelSize = vec2(1.0) / vec2(textureSize(uTexture, 0));

    // right
    if( vTextureCoord.x + texelSize.x * uOutlineWidth >= 1.0 ) {
        finalColor = c;
        return;
    }
    vec4 cRight = texture(uTexture, vec2(vTextureCoord.x + texelSize.x * uOutlineWidth, vTextureCoord.y));

    if( cRight.a != 0.0 ) {
        finalColor = vec4(uOutline, 1);
        return;
    }

    // left
    if( vTextureCoord.x - texelSize.x <= 0.0 ) {
        finalColor = c;
        return;
    }

    vec4 cLeft = texture(uTexture, vec2(vTextureCoord.x - texelSize.x * uOutlineWidth, vTextureCoord.y));

    if( cLeft.a != 0.0 ) {
        finalColor = vec4(uOutline, 1);
        return;
    }


    // down
    if( vTextureCoord.y + texelSize.y * uOutlineWidth > 1.0 ) {
        finalColor = c;
        return;
    }

    vec4 cDown = texture(uTexture, vec2(vTextureCoord.x, vTextureCoord.y + texelSize.y * uOutlineWidth));

    if( cDown.a != 0.0 ) {
        finalColor = vec4(uOutline, 1);
        return;
    }

    // up
    if( vTextureCoord.y - texelSize.y * uOutlineWidth < 0.0 ) {
        finalColor = c;
        return;
    }

    vec4 cUp = texture(uTexture, vec2(vTextureCoord.x, vTextureCoord.y - texelSize.y * uOutlineWidth));

    if( cUp.a != 0.0 ) {
        finalColor = vec4(uOutline, 1);
        return;
    }    

    finalColor = c;
}
`;class kt extends Ve{constructor(t,n){const o=ge.from({vertex:St,fragment:Ss,name:"outline-filter"});super({glProgram:o,padding:n,resources:{colorReplaceUniforms:{uOutline:{value:new Float32Array(3),type:"vec3<f32>"},uOutlineWidth:{value:new Float32Array(1),type:"f32"}}}}),this.upscale=n;const r=this.resources.colorReplaceUniforms.uniforms,[s,i,a]=t.toArray();r.uOutline[0]=s,r.uOutline[1]=i,r.uOutline[2]=a,r.uOutlineWidth[0]=n}}const st=({name:e,action:t,facingXy4:n,teleporting:o,highlighted:r,scaleFactor:s})=>{if(t==="death")return{frames:w.animations[`${e}.fadeOut`]};if(o!==null){if(o.phase==="out")return{frames:w.animations[`${e}.fadeOut`]};if(o.phase==="in")return{frames:w.animations[`${e}.fadeOut`].toReversed()}}const i=r?new kt(e==="head"?g.metallicBlue:g.pink,s):void 0;return t==="moving"?{frames:w.animations[`${e}.walking.${n}`],filter:i}:t==="falling"&&e==="head"&&(n==="towards"||n==="right")?{texture:`head.falling.${n}`,filter:i}:e==="head"&&(n==="towards"||n==="right")?{frames:w.animations[`head.idle.${n}`],filter:i}:{texture:`${e}.walking.${n}.2`,filter:i}},vn=({gameTime:e,switchedToAt:t})=>t+500>e,it=({item:e,currentlyRenderedProps:t,renderOptions:n})=>{const{type:o,state:{action:r,facing:s,teleporting:i}}=e,a=$e(s),l=e.type==="headOverHeels"?vn(e.state.head):vn(e.state);if(t===void 0||t.action!==r||t.facingXy4!==a||t.teleportingPhase!==(i?.phase??null)||t.highlighted!==l)return{container:o==="headOverHeels"?Y({top:st({name:"head",action:r,facingXy4:a,teleporting:i,highlighted:l,scaleFactor:n.scaleFactor}),bottom:st({name:"heels",action:r,facingXy4:a,teleporting:i,highlighted:l,scaleFactor:n.scaleFactor})}):p(st({name:o,action:r,facingXy4:a,teleporting:i,highlighted:l,scaleFactor:n.scaleFactor})),renderProps:{action:r,facingXy4:a,teleportingPhase:i?.phase??null,highlighted:l}}};function*Rs(e,t,n){for(const o of Wo){const r=Uo(o),s=o==="x"?"towards":"right",i=o==="x"?"away":"left";for(let a=0;a<=e.size[o];a++){let l;if(e.walls[i][a]==="none"){const d=L(P(e.roomJson.items)).find(c=>c.type==="door"&&c.config.direction===i&&(c.position[o]===a||c.position[o]+1===a)&&c.position[r]===e.size[r]);d===void 0?l="none":d.position.z===0?l="behind-door":l="corner-on-floor"}else l="corner-on-floor";l!=="none"&&(yield ze({[o]:a-t[o],[r]:e.size[r]+(n[s]?.5:0)+(l==="behind-door"?.5:0)},p(l==="behind-door"?{anchor:{x:0,y:1},texture:"generic.wall.overdraw",flipX:o==="x"}:{anchor:{x:0,y:1},texture:"generic.floor.overdraw",flipX:o==="x"})))}}}const zs=F(({item:e,room:t})=>{const{blockXMin:n,blockYMin:o,blockXMax:r,blockYMax:s,sidesWithDoors:i}=Rn(t.roomJson),a=r-n,l=s-o,{floor:d,color:{shade:c}}=t,u=new y({label:`floor(${t.id})`});if(d!=="none"){const k=d==="deadly"?`generic${c==="dimmed"?".dark":""}.floor.deadly`:`${d}${c==="dimmed"?".dark":""}.floor`,A=new y;for(let M=-1;M<=r+2;M++)for(let j=M%2-1;j<=s+2;j+=2)A.addChild(ze({x:M+(i.right?-.5:0),y:j+(i.towards?-.5:0)},p({texture:k})));je(Rs(t,{x:n,y:o},i),A);const G=new oe().poly([ne,K({x:a,y:0}),K({x:a,y:l}),K({x:0,y:l})],!0).fill({color:16711680,alpha:.5}).stroke({width:8});A.addChild(G),A.filters=q(t),A.mask=G,u.addChild(A)}const h=new y;for(let k=0;k<=a;k+=.5)h.addChild(ze({x:k,y:0},p({pivot:{x:7,y:0},texture:"generic.edge.towards"})));h.filters=Tt(t,"towards");const f=new y;for(let k=0;k<=l;k+=.5)f.addChild(ze({x:0,y:k},p({pivot:{x:0,y:0},texture:"generic.edge.right"})));f.filters=Tt(t,"right");const m=K({x:t.size.x+(i.right?.5:0),y:-o}).x,v=K({x:-n,y:t.size.y+(i.towards?.5:0)}).x,B=new oe().poly([{x:m,y:16},{x:m,y:-999},{x:v,y:-999},{x:v,y:16}],!0).fill(16776960);return u.addChild(B),u.addChild(h),u.addChild(f),u.mask=B,u.y=-e.aabb.z,u.cacheAsTexture(!0),u}),Ms=(e,t,n)=>t==="organic"&&e?`block.organic.dark${n?".disappearing":""}`:`block.${t}${n?".disappearing":""}`,gn=g.moss,yn=F(({item:{config:{style:e}}})=>p(e)),Ds={head:it,heels:it,headOverHeels:it,doorFrame:As,doorLegs:_s,stopAutowalk(){throw new Error("these should always be non-rendering")},portal(){throw new Error("these should always be non-rendering")},wall:F(({item:{config:{side:e,style:t}},room:n})=>{if(e==="right"||e==="towards")throw new Error("this wall should be non-rendering");return p({texture:Os(n.planet,t,e,n.color.shade==="dimmed"),y:1,pivot:e==="away"?{x:tt.w,y:tt.h+1}:{x:0,y:tt.h+1},filter:q(n)})}),barrier:F(({item:{config:{axis:e}}})=>p({texture:`barrier.${e}`})),deadlyBlock:F(({item:{config:{style:e}},room:t})=>p({texture:e,filter:e==="volcano"?q(t):void 0})),slidingDeadly:yn,slidingBlock:yn,block({item:{config:{style:e},state:{disappear:t}},room:n,currentlyRenderedProps:o}){if(o===void 0||o.disappear!==t)return{container:p({texture:Ms(n.color.shade==="dimmed",e,t!==null),filter:e==="organic"?q(n):void 0}),renderProps:{disappear:t}}},switch({item:{state:{setting:e}},currentlyRenderedProps:t}){if(t===void 0||e!==t.setting)return{container:p(`switch.${e}`),renderProps:{setting:e}}},conveyor({item:{config:{direction:e,count:t},state:{stoodOnBy:n}},currentlyRenderedProps:o}){const r=n.size>0;if(!(o===void 0||o.moving!==r))return;const i=new y,a=Go(e);return i.addChild(...L(Lo(t,0,-1)).map(l=>{const d=Vo({[a]:(l-1)*$.w});return p(r?{frames:w.animations[`conveyor.${a}`],reverse:e==="towards"||e==="right",animationSpeed:.5,...d}:{texture:`conveyor.${a}.6`,...d})})),{container:i,renderProps:{moving:r}}},lift:F(()=>{const e=new y,t={x:ue.w/2,y:ue.h-Xo};return e.addChild(p({frames:w.animations.lift,pivot:t})),e.addChild(p({texture:"lift.static",pivot:t})),e}),teleporter({item:{state:{stoodOnBy:e}},currentlyRenderedProps:t}){const n=L(e).find(Z)!==void 0;return t===void 0||n!==t.flashing?{container:n?new y({children:[p("teleporter"),p({frames:w.animations["teleporter.flashing"]})]}):p("teleporter"),renderProps:{flashing:n}}:void 0},pickup:F(({item:{config:{gives:e}},room:t})=>{const o={shield:"bunny",jumps:"bunny",fast:"bunny","extra-life":"bunny",bag:"bag",donuts:"donuts",hooter:"hooter",crown:"crown",scroll:{texture:"scroll",filter:q(t)},reincarnation:{frames:w.animations.fish,animationSpeed:.25}}[e];return p(o)}),moveableDeadly:F(({item:{config:{style:e}}})=>p(e==="deadFish"?"fish.1":"puck.deadly")),sceneryPlayer:F(({item:{config:{which:e}}})=>e==="headOverHeels"?Y({top:"head.walking.towards.2",bottom:"heels.walking.towards.2"}):p(`${e}.walking.towards.2`)),charles({item:{state:{facing:e}},currentlyRenderedProps:t}){const n=$e(e);if(t===void 0||n!==t.facingXy4)return{container:Y({top:`charles.${n}`}),renderProps:{facingXy4:n}}},baddie({item:{config:e,state:t},room:n,currentlyRenderedProps:o}){let r;const{activated:s,busyLickingDoughnutsOffFace:i}=t,a=i?Cr:s?void 0:Tr(n);switch(e.which){case"american-football-head":case"turtle":case"cyberman":r=e.startDirection;case"computer-bot":case"elephant":case"monkey":{const l=ft(t.vels.walking,ne)?r??"towards":$e(t.vels.walking);if(!(o===void 0||s!==o.activated||i!==o.busyLickingDoughnutsOffFace||l!==o.facingXy4))return;const c={facingXy4:l,activated:s,busyLickingDoughnutsOffFace:i};switch(e.which){case"american-football-head":return{container:p({texture:`${e.which}.${e.style}.${l}`,filter:a}),renderProps:c};case"turtle":return{container:p(s&&!i?{frames:w.animations[`${e.which}.${l}`],animationSpeed:.25,filter:a}:{texture:`${e.which}.${l}.1`,filter:a}),renderProps:c};case"cyberman":return{container:t.activated||t.busyLickingDoughnutsOffFace?Y({top:{texture:`${e.which}.${l}`,filter:a||q(n)},bottom:rt}):p({texture:`${e.which}.${l}`,filter:a}),renderProps:c};case"computer-bot":case"elephant":case"monkey":return{container:Y({top:`${e.which}.${l}`,filter:a}),renderProps:c}}break}case"helicopter-bug":case"dalek":case"headless-base":case"elephant-head":case"bubble-robot":case"flying-ball":{if(!(o===void 0||i!==o.busyLickingDoughnutsOffFace||s!==o.activated))return;const d={activated:s,busyLickingDoughnutsOffFace:i};switch(e.which){case"helicopter-bug":case"dalek":{const c=w.animations[e.which];return{container:p(s&&!i?{frames:c,animationSpeed:.5,filter:a}:{texture:`${e.which}.1`,filter:a}),renderProps:d}}case"headless-base":return{filter:a,container:p({texture:e.which,filter:a}),renderProps:d};case"elephant-head":return{container:p({texture:"elephant.towards",filter:a}),renderProps:d};case"bubble-robot":return{container:Y({top:rt,filter:a}),renderProps:d};case"flying-ball":return{container:Y({top:"ball",bottom:rt,filter:a}),renderProps:d}}break}default:throw new Error(`unexpected baddie ${e}`)}},joystick:Re("joystick"),movableBlock:F(({item:{config:{style:e}}})=>p(e)),portableBlock({item:{config:{style:e},state:{wouldPickUpNext:t}},currentlyRenderedProps:n,renderOptions:o}){const r=t;if(!(n===void 0||r!==n.highlighted))return;const i=r?new kt(gn,o.scaleFactor):void 0;return{container:p({texture:e,filter:i}),renderProps:{highlighted:r}}},spring({item:{state:{stoodOnBy:e,wouldPickUpNext:t}},currentlyRenderedProps:n,renderOptions:o}){const r=e.size>0,s=t;if(!(n===void 0||s!==n.highlighted||r!==n.compressed))return;const a=n?.compressed??!1,l=s?new kt(gn,o.scaleFactor):void 0;return{container:p(!r&&a?{frames:w.animations["spring.bounce"],playOnce:"and-stop",filter:l}:{texture:r?"spring.compressed":"spring.released",filter:l}),renderProps:{compressed:r,highlighted:s}}},book:F(({item:{config:{slider:e}}})=>p(`book.${e?"y":"x"}`)),hushPuppy:Re("hushPuppy"),bubbles:F(({item:{config:{style:e}}})=>p({frames:w.animations[`bubbles.${e}`]})),firedDonut:Re({frames:w.animations["bubbles.donut"]}),ball:Re("ball"),floor:zs},xn=(e,t)=>{const n=new oe().poly([b({}),b({x:e.x}),b({x:e.x,y:e.y}),b({y:e.y})]).poly([b({}),b({z:e.z}),b({y:e.y,z:e.z}),b({y:e.y})]).poly([b({x:e.x}),b({x:e.x,z:e.z}),b(e),b({x:e.x,y:e.y})]).poly([b({z:e.z}),b({x:e.x,z:e.z}),b({x:e.x,y:e.y,z:e.z}),b({y:e.y,z:e.z})]).stroke({width:.25,color:t,alpha:1});return n.eventMode="static",n.on("pointerenter",()=>{n.fill({color:t,alpha:.5})}),n.on("pointerleave",()=>{n.fill({color:"transparent"})}),n},Es={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",stopAutowalk:"rgba(255,128,128)"},Ns=e=>{const t=Es[e.type]??"rgba(255,255,255)",n=new y;if(I("portal")(e)){const o=b(e.config.relativePoint);n.addChild(new oe().circle(o.x,o.y,5).stroke(t)),n.addChild(new oe().circle(o.x,o.y,2).fill(t))}return n.addChild(new oe().circle(0,0,2).fill(t)),n.addChild(xn(e.aabb,t)),e.renderAabb&&n.addChild(xn(e.renderAabb,"rgba(184, 184, 255)")),n},$s=(e,t,n)=>{if(e.shadowMask===void 0)return;const o=new y({label:"ItemShadowRenderer"}),r=new y({label:"shadows"});if(n.showShadowMasks||(o.filters=new lr({alpha:.5})),e.shadowMask.spriteOptions){const i=p(e.shadowMask.spriteOptions);e.shadowMask.relativeTo==="top"&&(i.y=-e.aabb.z),o.addChild(i),n.showShadowMasks||(o.mask=i)}const s={};return o.addChild(r),{get item(){return e},destroy(){o.destroy({children:!0})},tick({movedItems:i,progression:a}){const l=i.has(e),d=e.state.position.z+e.aabb.z,c=L(P(t.items)).filter(function(m){return m.shadowCastTexture!==void 0}),u={id:e.id,state:{position:{...e.state.position,z:d}},aabb:{...e.aabb,z:jo}},h=Object.groupBy(c,f=>{const m=s[f.id]!==void 0,v=i.has(f);return!l&&!v?m?"keepUnchanged":"noShadow":Le(u,f)?m?"update":"create":"noShadow"});for(const f of Me(h.keepUnchanged,h.update))s[f.id].renderedOnProgression=a;for(const f of Me(h.create)){const m=p(f.shadowCastTexture);m.label=f.id,r.addChild(m),s[f.id]={sprite:m,renderedOnProgression:a}}for(const f of Me(h.create,h.update)){const{sprite:m}=s[f.id],v=b({...qo(f.state.position,e.state.position),z:e.aabb.z});m.x=v.x,m.y=v.y}for(const[f,{sprite:m,renderedOnProgression:v}]of Jo(s))v!==a&&(m.destroy(),delete s[f]);o.visible=(h.keepUnchanged?.length??0)+(h.update?.length??0)+(h.create?.length??0)>0},container:o}},Bs=(e,t,n)=>{t!==void 0&&n.onItemClick&&t!==void 0&&(t.eventMode="static",t.on("pointertap",()=>{n.onItemClick(e,t)}))},bn=({state:{position:e}},t)=>{const n=Zo(e);t.x=n.x,t.y=n.y},Hs=(e,t,n)=>{const o=n.showBoundingBoxes==="all"||n.showBoundingBoxes==="non-wall"&&e.type!=="wall";if(!e.renders&&!o)return;const r=new y({label:"render"});n.showBoundingBoxes!=="none"&&(r.alpha=.5);const s=new y({label:`ItemRenderer(${e.id})`});s.addChild(r),e.fixedZIndex!==void 0&&(s.zIndex=e.fixedZIndex),Bs(e,s,n),o&&(s.addChild(Ns(e)),bn(e,s));let i;const a=Ds[e.type],l=$s(e,t,n);return l!==void 0&&s.addChild(l.container),{get item(){return e},destroy(){s.destroy({children:!0}),r.destroy({children:!0}),l&&l.destroy()},tick(d){const c=e.renders?a({item:e,room:t,currentlyRenderedProps:i,renderOptions:n}):void 0;c!==void 0&&(i=c.renderProps,r.children.forEach(h=>h.destroy()),c.container!==null&&r.addChild(c.container)),d.movedItems.has(e)&&bn(e,s),l&&l.tick(d)},container:s}},Ws=(e,t)=>{const{leftSide:n,rightSide:o,frontSide:r}=Rn(e.roomJson),s=(o.x+n.x)/2;t.x=-s,t.y=-r.y-Math.abs(s>>1)},wn=(e,t)=>{const n=new y({label:`RoomRenderer(${e.id})`}),o=new y({label:"items"});let r=!0;const s=new Map;n.addChild(o),Ws(e,n);const i=new Map;return{get container(){return n},get room(){return e},tick(a){const l=r?{movedItems:new Set(P(e.items)),progression:0}:a;for(const d of P(e.items)){let c=i.get(d.id);if(c!==null){if(c===void 0){if(c=Hs(d,e,t),c===void 0){i.set(d.id,null);continue}i.set(d.id,c),o.addChild(c.container)}c.tick(l)}}for(const[d,c]of i.entries())e.items[d]===void 0&&(c!==null&&c.destroy(),i.delete(d));if(r||l.movedItems.size>0){const{order:d}=ro(ks(e.items,l.movedItems,s),e.items);for(let c=0;c<d.length;c++){const u=i.get(d[c]);if(u===void 0)throw new Error(`Item id=${d[c]} does not have a renderer - cannot assign a z-index`);u.container.zIndex=d.length-c}}r=!1},destroy(){n.destroy({children:!0}),i.forEach(a=>{a!==null&&a.destroy()})},get renderOptions(){return t}}},Us=16,Ls=(e,t)=>{const n=new y({label:"world"}),o=new y({label:"hud"});e.stage.addChild(n),e.stage.addChild(o);const r=new de(g.shadow);let s=wn(fe(t),t.renderOptions);n.addChild(s.container);const i=Fr(o),a=({deltaMS:l})=>{n.x=e.renderer.width/t.renderOptions.scaleFactor/2;const d=t.gameSpeed===0,c={x:Math.floor(e.renderer.width/t.renderOptions.scaleFactor),y:Math.floor(e.renderer.height/t.renderOptions.scaleFactor)};n.y=c.y-Us,i(t,c);const u=fe(t);if((s.room!==u||s.renderOptions!==t.renderOptions)&&(s.destroy(),s=wn(u,t.renderOptions),n.addChild(s.container),t.events.emit("roomChange",u.id),e.stage.scale=t.renderOptions.scaleFactor),d){e.stage.filters=r;const h=u.color;r.targetColor=Xn(h).main.original}else{e.stage.filters=ce;const h=gs(t,l);s.tick({progression:t.progression,movedItems:h})}};return{start(){return e.ticker.add(a),this},stop(){e.stage.removeChild(n),e.ticker.remove(a)}}},Gs=async e=>{const t=br,n=new Wn;await n.init({background:"#000000",resizeTo:window});const o=xr({campaign:e,renderOptions:t}),r=vr({keyAssignment:o.keyAssignment,inputState:o.inputState,onInputStateChange(i){o.events.emit("inputStateChanged",i)}}),s=Ls(n,o).start();return{campaign:e,events:o.events,renderIn(i){i.appendChild(n.canvas)},changeRoom(i){It({playableItem:Ft(o),gameState:o,toRoomId:i,changeType:"level-select"})},get currentRoom(){return fe(o)},get gameState(){return o},set renderOptions(i){o.renderOptions=i},stop(){console.warn("tearing down game"),n.canvas.parentNode?.removeChild(n.canvas),s.stop(),r(),n.destroy()}}},qs=Object.freeze(Object.defineProperty({__proto__:null,gameMain:Gs},Symbol.toStringTag,{value:"Module"}));export{Nn as A,Mn as C,Ve as F,sr as R,er as S,$n as V,qs as g,Qo as u};
