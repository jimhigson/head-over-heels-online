import{a8 as be,a9 as R,aa as $e,ab as ve,ac as k,ad as c,ae as O,af as P,ag as B,p as ke,ah as ie,ai as z,aj as We,ak as Y,al as Ee,b as we,i as W,am as Ne,o as _e,an as Le,ao as qe,ap as Ye,aq as Ge,ar as ne,as as xe,at as Ie,au as re}from"./App-BHOW5Ty8.js";import{g as Ve}from"./index-DG3f2H_A.js";var N={},_={},le;function Ze(){if(le)return _;le=1;var e=be(),t=e.iterableCurry,s=e.callReturn;function i(a,n){var r=a[Symbol.iterator](),h=r.next(),p=h.value,d=h.done;return d?n:(s(r),p)}_.__firstOr=i;var o=t(i,{reduces:!0});return _.firstOr=o,_}var ce;function Qe(){if(ce)return N;ce=1;var e=be(),t=e.iterableCurry,s=Ze(),i=s.__firstOr;function o(n){return i(n,void 0)}N.__first=o;var a=t(o,{reduces:!0});return N.first=a,N}var J,de;function Ue(){return de||(de=1,J=Qe().first),J}var Ke=Ue();const Je=Ve(Ke),ss=e=>e.characterRooms[e.currentCharacterName],l={w:16,d:16,h:12},ue={x:16,y:16,z:12},je=["head","heels"],et=[...je,"headOverHeels"],S=e=>e==="head"?"heels":"head",f=(...e)=>t=>e.includes(t.type),tt=f("bubbles","stopAutowalk","floorEdge","firedDoughnut"),st=(e,t)=>tt(e)||H(e)&&(t!==void 0&&ze(t)||e.config.direction.z!==0)||ct(e)&&e.config.type==="none",G=(e,t)=>!st(e,t),it=e=>(e.type==="movingPlatform"||e.type==="pushableBlock")&&e.config.style==="stepStool",ot=(e,t,s=!1)=>I(t)&&!(!s&&ze(t)&&t.state.autoWalk)&&!(lt(e)&&it(t)),me=["ball","slidingBlock","slidingDeadly"],at=f(...me),nt=["portableBlock","spring","sceneryPlayer"],is=f(...nt),ze=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function I(e){return Oe.includes(e.type)}const Oe=[...et,"monster","ball","charles","pushableBlock","movingPlatform","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer"],rt=["monster","deadlyBlock","moveableDeadly","slidingDeadly"],os=e=>f(...rt)(e)||e.type==="floor"&&e.config.type==="deadly",as=e=>e.config.times!==void 0,H=f("portal"),ns=f("teleporter");f("heels");f("head");const rs=f("heels","headOverHeels"),ls=f("head","headOverHeels"),lt=f("lift"),cs=f("monster"),ct=f("floor"),ds=f("pickup"),us=f("spring"),dt=f("joystick"),ps=f("monster","movingPlatform"),Pe=f("head"),Te=f("heels"),V=f("headOverHeels"),T=(e,t)=>e.characterRooms[t]?.items[t],hs=e=>T(e,e.currentCharacterName),fs=e=>{if(Pe(e))return e.state;if(V(e))return e.state.head},ut=e=>{if(Te(e))return e.state;if(V(e))return e.state.heels},pt=(e,t)=>{const s=T(e,e.currentCharacterName==="headOverHeels"?"headOverHeels":t);if(s!==void 0){if(t==="head"&&Pe(s)||t==="heels"&&Te(s))return s.state;if(t==="head"&&V(s))return s.state.head;if(t==="heels"&&V(s))return s.state.heels}},ys=pt,x={x:12,y:12,z:l.h},ht={x:14,y:14,z:l.h},M={x:16,y:16,z:l.h},q={...x,z:l.h*2},Me=e=>{switch(e.type){case"spring":case"portableBlock":case"moveableDeadly":case"slidingDeadly":case"firedDoughnut":return{aabb:x};case"slidingBlock":return e.config.style==="book"?{aabb:M}:{aabb:x};case"lift":return{aabb:{...x,z:x.z}};case"switch":return{aabb:{...x,z:x.z}};case"pickup":return e.config.gives==="scroll"?{aabb:{x:16,y:4,z:13}}:{aabb:x};case"charles":return{aabb:q};case"ball":return{aabb:{x:12,y:12,z:12}};case"pushableBlock":case"movingPlatform":return{aabb:M};case"block":switch(e.config.style){case"artificial":case"organic":case"book":return{aabb:M};case"tower":return{aabb:{x:11,y:11,z:l.h}};default:throw new Error("unknown block style")}case"monster":switch(e.config.which){case"skiHead":return{aabb:{...x,z:21}};case"bubbleRobot":case"cyberman":case"elephant":case"emperorsGuardian":case"monkey":case"computerBot":return{aabb:q};case"helicopterBug":case"dalek":return{aabb:x};default:return{aabb:M}}case"deadlyBlock":switch(e.config.style){case"toaster":return{aabb:{...M,y:M.y}};case"spikes":case"volcano":return{aabb:M}}break;case"bubbles":return{aabb:x};case"conveyor":case"hushPuppy":case"teleporter":return{aabb:M};case"barrier":return{aabb:e.config.axis==="y"?{x:3,y:15,z:l.h}:{x:15,y:3,z:l.h}};case"sceneryPlayer":return e.config.which==="headOverHeels"?{aabb:q}:{aabb:x};default:return{aabb:ht}}},ee=(e,t)=>{const s={x:1,y:1,z:1,...t},i=R(ue,e);return R($e(s,ue),i)},v={renders:!0,aabb:x},ft=({config:{direction:e},position:t})=>e==="right"&&t.x===0||e==="towards"&&t.y===0,b=ve/1e3,gs={head:15e-5,heels:15e-5},yt=2e-4,gt={head:l.h*2/1e3,others:l.h*6/1e3},bs=yt*.35,vs=gt.others*.5,ks=.8,ws=.001,xs={head:b,heels:2*b,charles:b,dalek:Math.SQRT2*b,bubbleRobot:(Math.SQRT2+1)/2*b,cyberman:1*b,skiHead:b,helicopterBug:b,homingBot:2*b,monkey:b,elephant:b,elephantHead:0,emperor:b,emperorsGuardian:Math.SQRT2*b,computerBot:b,turtle:b,ball:2*b,firedDoughnut:2*b,movingPlatform:b},bt=(e=1)=>e*ve/1e3,ms=bt(),zs=2,Os={head:l.h*2.6,heels:l.h},U=11,Ps=6e4,Ts=9999,pe=8,Ms=750,Bs=2500,As=200,vt=8,Rs=(e,t)=>{const s=F(e);return t.x=s.x,t.y=s.y,t},kt=({x:e=0,y:t=0,z:s=0})=>({x:t-e,y:-(e+t)/2-s}),g=({x:e=0,y:t=0,z:s=0})=>({x:e*l.w,y:t*l.d,z:s*l.h}),F=e=>kt(g(e)),j=l.h*2,wt=4,L=l.h*4;function*xt(e,t){const{config:{direction:s},position:i}=e,o=ie(s),a=ke(o),n=ft(e),r={...k,[a]:n?-.5:0},h=1,p={[a]:n?-1:0},d={[a]:h*l.w},w=9,u=8,y=8;yield{...e,...v,type:"doorFrame",id:`${t}/far`,config:{...e.config,inHiddenWall:n,part:"far"},state:{position:g(c(i,{[o]:1.5},r,p)),expires:null,stoodOnBy:O,disappear:null},aabb:c({[o]:u,[a]:y,z:L},d)},yield{...e,...v,type:"doorFrame",id:`${t}/near`,config:{...e.config,inHiddenWall:n,part:"near"},state:{position:g(c(i,r,p)),expires:null,stoodOnBy:O,disappear:null},aabb:c({[o]:w,[a]:y,z:L},d)},yield{...e,...v,type:"doorFrame",id:`${t}/top`,config:{...e.config,inHiddenWall:n,part:"top"},state:{position:c(g(c(i,r,p)),{[o]:w,z:j}),expires:null,stoodOnBy:O,disappear:null},aabb:c({[o]:2*l.w-w-u,[a]:y,z:L-j},d)},yield{...e,...v,type:"wall",id:`${t}/wall`,config:{style:"none",direction:"away",tiles:[]},renders:!1,state:{position:c(g(c(i,r)),{z:L}),expires:null,stoodOnBy:O,disappear:null},aabb:g({[o]:2,[a]:.5,z:U-wt-i.z})},yield{...e,...v,type:"portal",id:`${t}/portal`,config:{...e.config,inHidden:n,relativePoint:g({...k,[a]:n?.25:-.25}),direction:P[s]},renders:!1,state:{position:c(g(c(i,{[a]:n?-.5:.5})),{[o]:w}),expires:null,stoodOnBy:O,disappear:null},aabb:{[o]:2*l.w-w-u,[a]:0,z:j}},i.z!==0&&(yield{...e,...v,type:"doorLegs",id:`${t}/legs`,config:{...e.config,inHiddenWall:n,style:"none",side:"away",height:i.z},renders:!0,shadowCastTexture:n?"shadow.door.floatingThreshold.double.y":void 0,shadowMask:{spriteOptions:{textureId:n?"shadowMask.door.floatingThreshold.double.y":"shadowMask.door.legs.threshold.double.y",flipX:o==="x"},relativeTo:"top"},state:{position:{...g(c(i,r,p)),z:0},expires:null,stoodOnBy:{},disappear:null},aabb:c(g({[o]:2,[a]:.5,z:i.z}),d)}),yield{type:"stopAutowalk",id:`${t}/stopAutowalk`,renders:!1,aabb:g({[o]:2,[a]:0,z:2}),config:{},state:{position:g(R(i,B(P[s],.75))),expires:null,stoodOnBy:O,disappear:null}}}const te=e=>{const t=g(e.position),{aabb:s}=Me(e);if(s===void 0)throw new Error(`item type= ${e.type} config=${JSON.stringify(e.config)} has no bounding box`);return e.type==="wall"?t:c(t,{x:l.w-s.x>>1,y:l.d-s.y>>1})},C=()=>({expires:null,stoodOnBy:{},disappear:null}),X=()=>({standingOnItemId:null,vels:{gravity:k,movingFloor:k},latentMovement:[]}),mt=e=>{const t=Oe.includes(e.type);return{...C(),position:te(e),...t?{standingOnItemId:null,vels:{gravity:k,movingFloor:k,...me.includes(e.type)?{sliding:k}:{},...e.type==="monster"||e.type==="movingPlatform"?{walking:k}:{}},latentMovement:[]}:{},...e.type==="monster"?{activated:e.config.activated==="on",timeOfLastDirectionChange:Number.NEGATIVE_INFINITY,...e.config.which==="skiHead"||e.config.which==="turtle"||e.config.which==="elephantHead"||e.config.which==="cyberman"?{facing:P[e.config.startDirection]}:{facing:P.towards}}:{},...e.type==="pickup"?{collected:!1,disappear:"onTouchByPlayer"}:{},...e.type==="movingPlatform"?{activated:e.config.activated==="on",facing:P[e.config.startDirection]}:{},...e.type==="switch"?{setting:"left",touchedOnProgression:-1}:{},...e.type==="block"?{disappear:e.config.disappearing??null}:{},...e.type==="conveyor"?{disappear:e.config.disappearing??null}:{},...e.type==="barrier"?{disappear:e.config.disappearing??null}:{},...e.type==="lift"?{direction:"up",vels:{lift:k}}:{},...e.type==="charles"?{facing:P.towards}:{}}},Z={config:O,shadowCastTexture:"shadow.smallRound",aabb:x},$=()=>({action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:P.towards,walkStartFacing:P.towards,walkDistance:0,vels:{walking:k,gravity:k,movingFloor:k},actedOnAt:z}),zt=e=>{const t=We(Y.getState()),s=Ee(Y.getState());return e.config.which==="head"?{id:"head",type:"head",...v,...Z,state:{...C(),...X(),...$(),hasHooter:!1,gameWalkDistance:0,fastStepsStartedAtDistance:z,lives:t?"infinite":pe,shieldCollectedAt:z,doughnuts:s?"infinite":0,doughnutLastFireTime:z,switchedToAt:z,position:te(e),lastDiedAt:z,gameTime:0}}:{id:"heels",type:"heels",...v,...Z,state:{...C(),...X(),...$(),carrying:null,hasBag:!1,bigJumps:0,lives:t?"infinite":pe,shieldCollectedAt:z,switchedToAt:z,position:te(e),lastDiedAt:z,gameTime:0}}},Be=50,Ae=1,Ot=(e=U)=>({x:l.w,y:l.d*Ae,z:e*l.h}),Pt={x:l.w,y:0,z:Be},Tt=(e=U)=>({x:l.w*Ae,y:l.d,z:e*l.h}),Mt={x:0,y:l.d,z:Be},Bt=(e,t,s)=>{const{config:{direction:i,times:o},position:a}=t,{size:{z:n}}=s,r=ie(i),h=ke(r),p=i==="towards"||i==="right",d={...k,[h]:p?-1:0};return{type:"wall",id:e,config:t.config,aabb:ee(r==="y"?Tt(n):Ot(n),o),renders:!p,renderAabb:p?void 0:ee(r==="y"?Mt:Pt,o),state:{position:g(c(a,d)),stoodOnBy:O,expires:null,disappear:null},shadowCastTexture:r==="y"?"shadow.wall.y":{textureId:"shadow.wall.y",flipX:!0}}};function*Re(e,t,s,i,o={}){if(!i[e]&&!(t.type==="pickup"&&t.config.gives==="scroll"&&o[t.config.page]))switch(t.type){case"door":return yield*xt(t,e);case"player":{yield zt(t);return}case"wall":{yield Bt(e,t,s);return}default:{const a=Me(t),n=t.config.times!==void 0?{aabb:ee(a.aabb,t.config.times),renderAabb:void 0}:a;yield{...t,...v,...n,shadowMask:At(t),shadowCastTexture:Rt(t),id:e,config:t.config,state:mt(t)}}}}const At=e=>{switch(e.type){case"lift":return{spriteOptions:"shadowMask.smallBlock",relativeTo:"origin"};case"conveyor":return{spriteOptions:{textureId:"shadowMask.conveyor",flipX:we(e.config.direction)==="x"},relativeTo:"origin"};case"barrier":return{spriteOptions:{textureId:"shadowMask.barrier.y",flipX:e.config.axis==="x"},relativeTo:"origin"};case"spring":return{spriteOptions:"shadowMask.smallRound",relativeTo:"origin"};case"block":return{spriteOptions:e.config.style==="tower"?"shadowMask.tower":"shadowMask.fullBlock",relativeTo:"origin"};case"pushableBlock":case"movingPlatform":return{spriteOptions:e.config.style==="stepStool"?"shadowMask.stepStool":"shadowMask.fullBlock",relativeTo:"origin"};case"teleporter":return{spriteOptions:"shadowMask.teleporter",relativeTo:"origin"};case"hushPuppy":return{spriteOptions:"shadowMask.hushPuppy",relativeTo:"origin"};case"portableBlock":return{spriteOptions:e.config.style==="drum"?"shadowMask.smallRound":"shadowMask.smallBlock",relativeTo:"origin"};case"slidingBlock":return{spriteOptions:e.config.style==="book"?"shadowMask.fullBlock":"shadowMask.smallRound",relativeTo:"origin"};case"deadlyBlock":switch(e.config.style){case"volcano":return{spriteOptions:"shadowMask.volcano",relativeTo:"origin"};case"toaster":return{spriteOptions:"shadowMask.fullBlock",relativeTo:"origin"};case"spikes":return{spriteOptions:"shadowMask.spikes",relativeTo:"origin"};default:e.config.style}break;case"switch":return{spriteOptions:"shadowMask.switch",relativeTo:"origin"};case"pickup":return e.config.gives==="scroll"?{spriteOptions:"shadowMask.scroll",relativeTo:"origin"}:void 0;case"slidingDeadly":return{spriteOptions:"shadowMask.smallRound",relativeTo:"origin"};case"monster":switch(e.config.which){case"dalek":return{spriteOptions:"shadowMask.dalek",relativeTo:"origin"};default:return}case"joystick":return{spriteOptions:"shadowMask.joystick",relativeTo:"origin"}}},Rt=e=>{switch(e.type){case"lift":return"shadow.smallBlock";case"conveyor":return{textureId:"shadow.fullBlock",flipX:we(e.config.direction)==="x"};case"barrier":return{textureId:"shadow.barrier.y",flipX:e.config.axis==="x"};case"spring":return"shadow.smallRound";case"block":return e.config.style==="tower"?"shadow.smallRound":"shadow.fullBlock";case"pushableBlock":case"movingPlatform":case"hushPuppy":case"deadlyBlock":return"shadow.fullBlock";case"portableBlock":return e.config.style==="drum"?"shadow.smallRound":"shadow.smallBlock";case"pickup":return e.config.gives==="scroll"?"shadow.scroll":"shadow.smallRound";case"monster":return"shadow.smallRound"}},Ce=({aabb:e,state:{position:t}},{aabb:s,state:{position:i}})=>!(t.x+e.x<=i.x||t.x>=i.x+s.x)&&!(t.y+e.y<=i.y||t.y>=i.y+s.y)&&!(t.z+e.z<=i.z||t.z>=i.z+s.z),oe=(e,t)=>[...W(t).filter(s=>e.id!==s.id&&Ce(e,s))],Ct=e=>{const t={},s=Object.values(e.items).filter(i=>i.type==="door");for(const{config:{direction:i},position:{x:o,y:a}}of s)ie(i)==="x"?a===0?t.towards=!0:a===e.size.y&&(t.away=!0):o===0?t.right=!0:o===e.size.x&&(t.left=!0);return t},He=e=>{const t=Ct(e),s=t.right?-.5:0,i=e.size.x+(t.left?.5:0),o=t.towards?-.5:0,a=e.size.y+(t.away?.5:0);return{blockXMin:s,blockXMax:i,blockYMin:o,blockYMax:a,sidesWithDoors:t}},Cs=e=>{const{blockXMax:t,blockXMin:s,blockYMax:i,blockYMin:o,sidesWithDoors:a}=He(e),n=F({x:e.size.x+(a.right?.5:0),y:-o}).x,r=F({x:-s,y:e.size.y+(a.towards?.5:0)}).x,h=F({x:e.size.x,y:e.size.y}).y,p=F({x:s,y:o}),d=F({x:t,y:i});return{blockXMin:s,blockXMax:t,blockYMin:o,blockYMax:i,edgeLeftX:n,edgeRightX:r,topEdgeY:h,frontSide:p,backSide:d,sidesWithDoors:a}};function*Ht(e){const t=e.size.z??U,s=g({...e.size,z:1}),{blockXMax:i,blockXMin:o,blockYMax:a,blockYMin:n}=He(e),r=g({x:i-o,y:a-n,z:1}),h=g({...Ne,z:-1}),p=g({x:o,y:n,z:-1});if(yield{id:"floorEdge",...v,type:"floorEdge",state:{...C(),position:{...p,z:0}},aabb:k,config:{},fixedZIndex:9999},e.floor==="none"&&e.roomBelow!==void 0?(yield{...v,type:"floor",id:"floor",config:{type:"none"},aabb:s,shadowMask:void 0,state:{position:p,expires:null,stoodOnBy:{},disappear:null},renders:!0,fixedZIndex:-1},yield{...v,type:"portal",id:"floor/portal",config:{toRoom:e.roomBelow,relativePoint:{x:s.x/2,y:s.y/2,z:s.z},direction:P.down},aabb:s,state:{position:h,expires:null,stoodOnBy:{},disappear:null},renders:!1}):yield{...v,type:"floor",id:"floor",config:{type:e.floor==="deadly"?"deadly":"standable"},aabb:r,shadowMask:{relativeTo:"origin"},state:{position:p,expires:null,stoodOnBy:{},disappear:null},renders:!0,fixedZIndex:-1},e.roomAbove!==void 0){const d=c(h,{z:l.h*t});yield{...v,type:"portal",id:"ceiling",config:{toRoom:e.roomAbove,relativePoint:{...e.ceilingRelativePoint!==void 0?g(e.ceilingRelativePoint):{x:s.x/2,y:s.y/2},z:-12},direction:P.up},aabb:s,state:{position:d,expires:null,stoodOnBy:{},disappear:null},renders:!1}}}const Hs=(e,t)=>t?.[e],K=e=>_e(e),A=e=>W(K(e)),Fs=e=>W(Le(e)),Ss=e=>({head:e.head,heels:e.heels,headOverHeels:e.headOverHeels});function*Ft(e,t,s){const{gameMenus:{scrollsRead:i}}=Y.getState(),o=qe(e.items);for(const[a,n]of o)n.type==="player"&&!s||(yield*Re(a,n,e,t,i))}const he=e=>W(e).reduce((t,s)=>({...t,[s.id]:s}),{}),St=({roomJson:e,roomPickupsCollected:t,isNewGame:s=!1})=>{const i={...he(Ht(e)),...he(Ft(e,t,s))};for(const a of A(i)){const r=oe(a,K(i)).find(h=>G(a)&&G(h)&&!(a.type==="wall"&&h.type==="wall"));r!==void 0&&console.error(`in room ${e.id} item ${a.id} @${JSON.stringify(a.state.position)} #${JSON.stringify(a.aabb)} is colliding with (solid item) ${r.id} @${JSON.stringify(r.state.position)} #${JSON.stringify(r.aabb)} on loading room ${e.id}`)}return{...e,roomJson:e,items:{...i},roomTime:0}},Dt=({state:{position:e,facing:t,autoWalk:s,action:i,vels:o}})=>({position:e,facing:t,autoWalk:s,action:i,vels:{...o}}),Xt=(e,t)=>W(Ye(e)).map(s=>t.items[s]);function Fe(e,t){return e===null?null:t.items[e]}const se=(e,t)=>{if(e.state.standingOnItemId!==null){const s=Fe(e.state.standingOnItemId,t);delete s.state.stoodOnBy[e.id],e.state.standingOnItemId=null}},Se=({above:e,below:t})=>{e.state.standingOnItemId=t.id,t.state.stoodOnBy[e.id]=!0},D=({room:e,item:t})=>{const s=typeof t=="string"?e.items[t]:t;I(s)&&se(s,e);for(const i of Xt(s.state.stoodOnBy,e))se(i,e);typeof t=="string"?delete e.items[t]:delete e.items[s.id]};let $t=0;const Wt=({gameState:e,room:t,itemType:s,config:i,position:o})=>{const a={type:s,config:i,position:k},n=`${s}/${$t++}`,r=Je(Re(n,a,t.roomJson,e.pickupsCollected[t.id]??O));if(r===void 0)throw console.error("failed to generate any items for json",n,a),new Error("failed to generate any items");return r.state.position=o,Q({room:t,item:r}),r},Q=({room:e,item:t})=>(e.items[t.id]=t,t),Et=1e3/25,De=e=>{const t=Ge.animations[e],s=t.length,{animationSpeed:i}=t;return s*Et/i};De("bubbles.white");const Nt=De("head.fadeOut"),_t=({touchedItem:e,room:t,gameState:s})=>{D({room:t,item:e});const i=Wt({itemType:"bubbles",config:{style:"white"},position:k,room:t,gameState:s}),o=c(e.state.position,B(e.aabb,.5));i.state.position=R(o,B(i.aabb,.5)),i.state.expires=t.roomTime+Nt},Lt=(e,t)=>{const s=A(e.items).filter(f("hushPuppy"));for(const i of s)_t({touchedItem:i,gameState:t,room:e})},qt=.5,fe=(e,t,s,i)=>{const o=s.x+i.x-e.x,a=s.y+i.y-e.y,n=s.z+i.z-e.z,r=e.x+t.x-s.x,h=e.y+t.y-s.y,p=e.z+t.z-s.z,d=Math.abs(o)<Math.abs(r)?o:-r,w=Math.abs(a)<Math.abs(h)?a:-h,u=Math.abs(n)<Math.abs(p)?n:-p,y=Math.abs(d),m=Math.abs(w),E=Math.abs(u)*qt;return y<m&&y<E?{x:d,y:0,z:0}:m<E?{x:0,y:w,z:0}:{x:0,y:0,z:u}},ye=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),ge={stopAutowalk:5,portal:5,wall:5,doorLegs:5,sceneryPlayer:5,bubbles:5,switch:10,doorFrame:15,block:20,barrier:20,floor:20,floorEdge:20,hushPuppy:20,teleporter:20,lift:30,movingPlatform:30,pushableBlock:30,portableBlock:30,slidingBlock:30,spring:30,ball:40,joystick:40,charles:40,conveyor:40,head:50,heels:50,headOverHeels:50,pickup:80,firedDoughnut:90,slidingDeadly:100,moveableDeadly:100,deadlyBlock:100,monster:100},Yt=(e,t)=>ge[e.type]-ge[t.type],Gt=(e,t)=>t.toSorted((s,i)=>{const o=Yt(s,i);if(o!==0)return o;const a=ne(e,ye(e,s)),n=ne(e,ye(e,i));return Math.abs(a-n)<1e-4?s.id<i.id?-1:1:a-n}),Xe=({subjectItem:e,posDelta:t,gameState:s,room:i,pusher:o,deltaMS:a,forceful:n=f("lift")(e)&&o===void 0,recursionDepth:r=0,onTouch:h})=>{if(xe(t,k))return;const{state:{position:p}}=e;e.state.position=c(p,t),I(e)&&(e.state.actedOnAt=i.roomTime);const d=Gt(t,oe(e,K(i.items)));let w=!1;for(const u of d){if(!Ce(e,u))continue;const y=dt(u);if(o!==u&&!(w&&y)&&h!==void 0&&(h({movingItem:e,touchedItem:u,movementVector:R(e.state.position,p),gameState:s,deltaMS:a,room:i}),w=w||y),i.items[e.id]===void 0)return;if(i.items[u.id]===void 0||!G(u,e)||!G(e))continue;const m=fe(e.state.position,e.aabb,u.state.position,u.aabb);if(ot(e,u,n)&&u!==o){const E=n||at(u)?-1:-.5,ae=B(m,E);if(e.state.position=c(e.state.position,m,ae),r<vt&&Xe({subjectItem:u,posDelta:ae,pusher:e,gameState:s,room:i,deltaMS:a,forceful:n,recursionDepth:r+1,onTouch:h}),i.items[u.id]===void 0)continue;e.state.position=c(e.state.position,fe(e.state.position,e.aabb,u.state.position,u.aabb))}else e.state.position=c(e.state.position,m);I(e)&&m.z>0&&(e.state.standingOnItemId===null||!d.includes(Fe(e.state.standingOnItemId,i)))&&(se(e,i),Se({above:e,below:u}))}},It=(e,t,{changeType:s,sourceItem:i})=>{switch(s){case"portal":return A(e.items).find(o=>H(o)&&o.config.toRoom===t.id&&xe(B(i.config.direction,-1),o.config.direction));case"level-select":return A(e.items).find(o=>H(o)&&o.config.toRoom===t.id&&o.config.direction.z===0)??A(e.items).find(o=>H(o)&&o.config.direction.z===0)??A(e.items).find(o=>H(o)&&o.config.direction.z>0)??A(e.items).find(H)}},Vt=(e,t,s,i)=>{const o=1*l.w;e.state.position=c(e.state.position,B(t,o));for(let a=0;a<o;a++)Xe({subjectItem:e,posDelta:B(t,-1),gameState:s,room:i,deltaMS:16,forceful:!0,onTouch:void 0})},Ds=e=>{const{playableItem:t,gameState:s,toRoomId:i,changeType:o,sourceItem:a}=e,n=s.characterRooms[t.id];if(n===void 0)throw new Error(`${t.id} is not in a room on the gameState`);if(i===n.id)throw new Error(`Can't move ${t.id} to the same room "${i}""`);let r;switch(o){case"portal":{const{config:{relativePoint:y},state:{position:m}}=a;r=R(t.state.position,c(m,y));break}case"teleport":{const{state:{position:y}}=a;r=R(t.state.position,y);break}case"level-select":r={x:0,y:0,z:0};break;default:throw new Error}const h=t.type==="headOverHeels"?void 0:s.characterRooms[S(t.id)],p=s.campaign.rooms[i];if(p===void 0)throw new Error(`room ${i} does not exist in campaign`);const d=h?.id===i?h:St({roomJson:p,roomPickupsCollected:s.pickupsCollected[i]??O});D({room:n,item:t});const w=ut(t);if(w!==void 0&&(w.carrying=null),t.state.latentMovement=[],(t.type==="head"||t.type==="headOverHeels")&&Lt(d,s),D({room:d,item:t}),d.items[t.id]=t,s.characterRooms[t.id]=d,e.changeType==="teleport"){const{config:{toPosition:y}}=e.sourceItem;t.state.position=c(g(y),r)}else{const y=It(d,n,e);if(console.log("putting",t.id,"into",i,"at portal",y,"because",o,"sourceportal",a),y===void 0)if(e.changeType==="level-select")t.state.position=g({x:1,y:1,z:8});else throw new Error(`trying to move ${t.id} from ${n.id} --to-> ${i} but no destination portal found to locate with`);else{t.state.position=c(y.state.position,y.config.relativePoint,r,o==="portal"&&a.config.direction.z>0?{z:l.h}:{});const{config:{direction:m}}=y;m.z===0&&(t.state.autoWalk=!0,t.state.facing=B(m,-1),t.state.action==="idle"&&(t.state.action="moving"),Vt(t,m,s,d))}}const u=oe(t,K(d.items));u.length>0&&console.warn("on entering room",i,"character",t.id,"at",t.state.position,"collides with",u),s.entryState[t.id]=Dt(t),t.id==="headOverHeels"?(delete s.entryState.head,delete s.entryState.heels):(s.entryState[S(t.id)]||(s.entryState[S(t.id)]=s.entryState.headOverHeels),delete s.entryState.headOverHeels),Y.dispatch(Ie(i))},Zt=e=>{const t=T(e,"head"),s=T(e,"heels");return t!==void 0&&s!==void 0&&t.state.action==="idle"&&s.state.action==="idle"&&t.state.standingOnItemId==="heels"},Qt=e=>{const t={id:"head",type:"head",...v,...Z,state:{...C(),...X(),...$(),...e.state.head,facing:e.state.facing,position:c(e.state.position,{z:l.h}),switchedToAt:z,actedOnAt:e.state.actedOnAt}},s={id:"heels",type:"heels",...v,...Z,state:{...C(),...X(),...$(),...e.state.heels,facing:e.state.facing,position:c(e.state.position),switchedToAt:z,actedOnAt:e.state.actedOnAt}};return{head:t,heels:s}},Ut=({head:e,heels:t})=>({id:"headOverHeels",type:"headOverHeels",...v,shadowCastTexture:t.shadowCastTexture,config:O,aabb:q,state:{...C(),...X(),...$(),position:t.state.position,action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:t.state.facing,actedOnAt:Math.max(t.state.actedOnAt,t.state.actedOnAt),head:{...re(e.state,"hasHooter","doughnuts","doughnutLastFireTime","fastStepsStartedAtDistance","gameWalkDistance","lives","gameTime","shieldCollectedAt","lastDiedAt"),switchedToAt:z},heels:{...re(t.state,"hasBag","bigJumps","carrying","lives","gameTime","shieldCollectedAt","lastDiedAt"),switchedToAt:z}}}),Kt=e=>{const t=e.characterRooms.head,s=T(e,"head"),i=T(e,"heels"),o=Ut({head:s,heels:i});D({room:t,item:"head"}),D({room:t,item:"heels"}),Q({room:t,item:o}),e.previousPlayable=e.currentCharacterName,e.currentCharacterName="headOverHeels",e.characterRooms={head:void 0,heels:void 0,headOverHeels:t}},Jt=(e,t)=>{const s=e.characterRooms.headOverHeels,i=T(e,"headOverHeels"),o=t??S(e.previousPlayable),{head:a,heels:n}=Qt(i);D({room:s,item:"headOverHeels"}),Q({room:s,item:a}),Q({room:s,item:n}),Se({above:a,below:n}),e.currentCharacterName=o,e.previousPlayable=void 0,e.characterRooms={head:s,heels:s,headOverHeels:void 0}},jt=e=>{const t=T(e,e.currentCharacterName);t!==void 0&&(t.type==="headOverHeels"?(t.state.head.switchedToAt=t.state.head.gameTime,t.state.heels.switchedToAt=t.state.heels.gameTime):t.state.switchedToAt=t?.state.gameTime)},Xs=(e,t)=>{Zt(e)&&(!t||t===e.currentCharacterName)?Kt(e):e.currentCharacterName==="headOverHeels"?Jt(e,t):(!t||t!==e.currentCharacterName)&&T(e,S(e.currentCharacterName))!==void 0&&(e.currentCharacterName=S(e.currentCharacterName)),jt(e)};export{vs as $,xs as A,fe as B,Xt as C,Et as D,Fe as E,us as F,ns as G,ds as H,yt as I,zs as J,Os as K,ws as L,ks as M,gs as N,Se as O,_t as P,me as Q,A as R,is as S,K as T,Xe as U,D as V,oe as W,je as X,ys as Y,gt as Z,bs as _,I as a,ms as a0,Q as a1,v as a2,rs as a3,ls as a4,lt as a5,ps as a6,Qt as a7,Ut as a8,Lt as a9,se as aa,Fs as ab,Xs as ac,kt as ad,Ts as ae,as as af,Ms as ag,As as ah,Cs as ai,Rs as aj,hs as b,Ds as c,Kt as d,T as e,Wt as f,Hs as g,l as h,f as i,Dt as j,Ps as k,St as l,G as m,Ce as n,S as o,F as p,Yt as q,Bs as r,ss as s,Nt as t,ut as u,fs as v,ze as w,os as x,Ss as y,cs as z};
