import{a8 as ve,a9 as C,aa as $e,ab as ke,ac as k,ad as d,ae as O,af as T,ag as A,p as we,ah as se,ai as w,aj as ne,ak as Ee,al as G,am as Ne,b as me,i as N,an as _e,o as Le,ao as qe,ap as Ye,aq as Ge,ar as Ve,as as re,at as xe,au as Ze,av as le}from"./App-DRGZy5rn.js";import{g as Ie}from"./index-dDPPo0bA.js";var _={},L={},ce;function Qe(){if(ce)return L;ce=1;var e=ve(),t=e.iterableCurry,i=e.callReturn;function s(a,n){var r=a[Symbol.iterator](),h=r.next(),p=h.value,u=h.done;return u?n:(i(r),p)}L.__firstOr=s;var o=t(s,{reduces:!0});return L.firstOr=o,L}var de;function Ue(){if(de)return _;de=1;var e=ve(),t=e.iterableCurry,i=Qe(),s=i.__firstOr;function o(n){return s(n,void 0)}_.__first=o;var a=t(o,{reduces:!0});return _.first=a,_}var J,ue;function Ke(){return ue||(ue=1,J=Ue().first),J}var Je=Ke();const je=Ie(Je),si=e=>e.characterRooms[e.currentCharacterName],c={w:16,d:16,h:12},pe={x:16,y:16,z:12},et=["head","heels"],tt=[...et,"headOverHeels"],W=e=>e==="head"?"heels":"head",f=(...e)=>t=>e.includes(t.type),it=f("bubbles","stopAutowalk","floorEdge","firedDoughnut"),st=(e,t)=>it(e)||F(e)&&(t!==void 0&&Oe(t)||e.config.direction.z!==0)||dt(e)&&e.config.type==="none",V=(e,t)=>!st(e,t),ot=e=>(e.type==="movingPlatform"||e.type==="pushableBlock")&&e.config.style==="stepStool",at=(e,t,i=!1)=>X(t)&&!(!i&&Oe(t)&&t.state.autoWalk)&&!(ct(e)&&ot(t)),ze=["ball","slidingBlock","slidingDeadly"],nt=f(...ze),rt=["portableBlock","spring","sceneryPlayer"],oi=f(...rt),Oe=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function X(e){return Te.includes(e.type)}const Te=[...tt,"monster","ball","charles","pushableBlock","movingPlatform","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer"],lt=["monster","deadlyBlock","moveableDeadly","slidingDeadly"],ai=e=>f(...lt)(e)||e.type==="floor"&&e.config.type==="deadly",ni=e=>e.config.times!==void 0,F=f("portal"),ri=f("teleporter");f("heels");f("head");const li=f("heels","headOverHeels"),ci=f("head","headOverHeels"),ct=f("lift"),di=f("monster"),dt=f("floor"),ui=f("pickup"),pi=f("spring"),ut=f("joystick"),hi=f("monster","movingPlatform"),Pe=f("head"),Me=f("heels"),Z=f("headOverHeels"),M=(e,t)=>e.characterRooms[t]?.items[t],fi=e=>M(e,e.currentCharacterName),yi=e=>{if(Pe(e))return e.state;if(Z(e))return e.state.head},pt=e=>{if(Me(e))return e.state;if(Z(e))return e.state.heels},ht=(e,t)=>{const i=M(e,e.currentCharacterName==="headOverHeels"?"headOverHeels":t);if(i!==void 0){if(t==="head"&&Pe(i)||t==="heels"&&Me(i))return i.state;if(t==="head"&&Z(i))return i.state.head;if(t==="heels"&&Z(i))return i.state.heels}},gi=ht,x={x:12,y:12,z:c.h},ft={x:14,y:14,z:c.h},B={x:16,y:16,z:c.h},Y={...x,z:c.h*2},Be=e=>{switch(e.type){case"spring":case"portableBlock":case"moveableDeadly":case"slidingDeadly":case"firedDoughnut":return{aabb:x};case"slidingBlock":return e.config.style==="book"?{aabb:B}:{aabb:x};case"lift":return{aabb:{...x,z:x.z}};case"switch":return{aabb:{...x,z:x.z}};case"pickup":return e.config.gives==="scroll"?{aabb:{x:16,y:4,z:13}}:{aabb:x};case"charles":return{aabb:Y};case"ball":return{aabb:{x:12,y:12,z:12}};case"pushableBlock":case"movingPlatform":return{aabb:B};case"block":switch(e.config.style){case"artificial":case"organic":case"book":return{aabb:B};case"tower":return{aabb:{x:11,y:11,z:c.h}};default:throw new Error("unknown block style")}case"monster":switch(e.config.which){case"skiHead":return{aabb:{...x,z:21}};case"bubbleRobot":case"cyberman":case"elephant":case"emperorsGuardian":case"monkey":case"computerBot":return{aabb:Y};case"helicopterBug":case"dalek":return{aabb:x};default:return{aabb:B}}case"deadlyBlock":switch(e.config.style){case"toaster":return{aabb:{...B,y:B.y}};case"spikes":case"volcano":return{aabb:B}}break;case"bubbles":return{aabb:x};case"conveyor":case"hushPuppy":case"teleporter":return{aabb:B};case"barrier":return{aabb:e.config.axis==="y"?{x:3,y:15,z:c.h}:{x:15,y:3,z:c.h}};case"sceneryPlayer":return e.config.which==="headOverHeels"?{aabb:Y}:{aabb:x};default:return{aabb:ft}}},ee=(e,t)=>{const i={x:1,y:1,z:1,...t},s=C(pe,e);return C($e(i,pe),s)},v={renders:!0,aabb:x},yt=({config:{direction:e},position:t})=>e==="right"&&t.x===0||e==="towards"&&t.y===0,b=ke/1e3,bi={head:15e-5,heels:15e-5},gt=2e-4,bt={head:c.h*2/1e3,others:c.h*6/1e3},vi=gt*.35,ki=bt.others*.5,wi=.8,mi=.001,xi={head:b,heels:2*b,charles:b,dalek:Math.SQRT2*b,bubbleRobot:(Math.SQRT2+1)/2*b,cyberman:1*b,skiHead:b,helicopterBug:b,homingBot:2*b,monkey:b,elephant:b,elephantHead:0,emperor:b,emperorsGuardian:Math.SQRT2*b,computerBot:b,turtle:b,ball:2*b,firedDoughnut:2*b,movingPlatform:b},vt=(e=1)=>e*ke/1e3,zi=vt(),Oi=2,Ti={head:c.h*2.6,heels:c.h},U=11,Pi=6e4,Mi=9999,he=8,Bi=750,Ai=2500,Ri=200,kt=8,Ci=(e,t)=>{const i=S(e);return t.x=i.x,t.y=i.y,t},Hi=({x:e=0,y:t=0})=>t-e,wt=({x:e=0,y:t=0,z:i=0})=>({x:t-e,y:-(e+t)/2-i}),g=({x:e=0,y:t=0,z:i=0})=>({x:e*c.w,y:t*c.d,z:i*c.h}),S=e=>wt(g(e)),j=c.h*2,mt=4,q=c.h*4;function*xt(e,t){const{config:{direction:i},position:s}=e,o=se(i),a=we(o),n=yt(e),r={...k,[a]:n?-.5:0},h=1,p={[a]:n?-1:0},u={[a]:h*c.w},m=9,l=8,y=8;yield{...e,...v,type:"doorFrame",id:`${t}/far`,config:{...e.config,inHiddenWall:n,part:"far"},state:{position:g(d(s,{[o]:1.5},r,p)),expires:null,stoodOnBy:O,disappear:null},aabb:d({[o]:l,[a]:y,z:q},u)},yield{...e,...v,type:"doorFrame",id:`${t}/near`,config:{...e.config,inHiddenWall:n,part:"near"},state:{position:g(d(s,r,p)),expires:null,stoodOnBy:O,disappear:null},aabb:d({[o]:m,[a]:y,z:q},u)},yield{...e,...v,type:"doorFrame",id:`${t}/top`,config:{...e.config,inHiddenWall:n,part:"top"},state:{position:d(g(d(s,r,p)),{[o]:m,z:j}),expires:null,stoodOnBy:O,disappear:null},aabb:d({[o]:2*c.w-m-l,[a]:y,z:q-j},u)},yield{...e,...v,type:"wall",id:`${t}/wall`,config:{style:"none",direction:"away",tiles:[]},renders:!1,state:{position:d(g(d(s,r)),{z:q}),expires:null,stoodOnBy:O,disappear:null},aabb:g({[o]:2,[a]:.5,z:U-mt-s.z})},yield{...e,...v,type:"portal",id:`${t}/portal`,config:{...e.config,inHidden:n,relativePoint:g({...k,[a]:n?.25:-.25}),direction:T[i]},renders:!1,state:{position:d(g(d(s,{[a]:n?-.5:.5})),{[o]:m}),expires:null,stoodOnBy:O,disappear:null},aabb:{[o]:2*c.w-m-l,[a]:0,z:j}},s.z!==0&&(yield{...e,...v,type:"doorLegs",id:`${t}/legs`,config:{...e.config,inHiddenWall:n,style:"none",side:"away",height:s.z},renders:!0,shadowCastTexture:n?"shadow.door.floatingThreshold.double.y":void 0,shadowMask:{spriteOptions:{textureId:n?"shadowMask.door.floatingThreshold.double.y":"shadowMask.door.legs.threshold.double.y",flipX:o==="x"},relativeTo:"top"},state:{position:{...g(d(s,r,p)),z:0},expires:null,stoodOnBy:{},disappear:null},aabb:d(g({[o]:2,[a]:.5,z:s.z}),u)}),yield{type:"stopAutowalk",id:`${t}/stopAutowalk`,renders:!1,aabb:g({[o]:2,[a]:0,z:2}),config:{},state:{position:g(C(s,A(T[i],.75))),expires:null,stoodOnBy:O,disappear:null}}}const te=e=>{const t=g(e.position),{aabb:i}=Be(e);if(i===void 0)throw new Error(`item type= ${e.type} config=${JSON.stringify(e.config)} has no bounding box`);return e.type==="wall"?t:d(t,{x:c.w-i.x>>1,y:c.d-i.y>>1})},H=()=>({expires:null,stoodOnBy:{},disappear:null}),$=()=>({standingOnItemId:null,vels:{gravity:k,movingFloor:k},latentMovement:[],actedOnAt:{roomTime:w,by:O},collidedWith:{roomTime:w,by:O}}),zt=e=>{const t=Te.includes(e.type);return{...H(),position:te(e),...t?{standingOnItemId:null,vels:{gravity:k,movingFloor:k,...ze.includes(e.type)?{sliding:k}:{},...e.type==="monster"||e.type==="movingPlatform"?{walking:k}:{}},latentMovement:[],actedOnAt:{roomTime:w,by:ne},collidedWith:{roomTime:w,by:ne}}:{},...e.type==="monster"?{activated:e.config.activated==="on",timeOfLastDirectionChange:Number.NEGATIVE_INFINITY,...e.config.which==="skiHead"||e.config.which==="turtle"||e.config.which==="elephantHead"||e.config.which==="cyberman"?{facing:T[e.config.startDirection]}:{facing:T.towards}}:{},...e.type==="pickup"?{collected:!1,disappear:"onTouchByPlayer"}:{},...e.type==="movingPlatform"?{activated:e.config.activated==="on",facing:T[e.config.startDirection]}:{},...e.type==="switch"?{setting:"left",touchedOnProgression:-1}:{},...e.type==="block"?{disappear:e.config.disappearing??null}:{},...e.type==="conveyor"?{disappear:e.config.disappearing??null}:{},...e.type==="barrier"?{disappear:e.config.disappearing??null}:{},...e.type==="lift"?{direction:"up",vels:{lift:k}}:{},...e.type==="charles"?{facing:T.towards}:{}}},I={config:O,shadowCastTexture:"shadow.smallRound",aabb:x},E=()=>({action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:T.towards,walkStartFacing:T.towards,walkDistance:0,vels:{walking:k,gravity:k,movingFloor:k}}),Ot=e=>{const t=Ee(G.getState()),i=Ne(G.getState());return e.config.which==="head"?{id:"head",type:"head",...v,...I,state:{...H(),...$(),...E(),hasHooter:!1,gameWalkDistance:0,fastStepsStartedAtDistance:w,lives:t?"infinite":he,shieldCollectedAt:w,doughnuts:i?"infinite":0,doughnutLastFireTime:w,switchedToAt:w,position:te(e),lastDiedAt:w,gameTime:0}}:{id:"heels",type:"heels",...v,...I,state:{...H(),...$(),...E(),carrying:null,hasBag:!1,bigJumps:0,lives:t?"infinite":he,shieldCollectedAt:w,switchedToAt:w,position:te(e),lastDiedAt:w,gameTime:0}}},Ae=50,Re=1,Tt=(e=U)=>({x:c.w,y:c.d*Re,z:e*c.h}),Pt={x:c.w,y:0,z:Ae},Mt=(e=U)=>({x:c.w*Re,y:c.d,z:e*c.h}),Bt={x:0,y:c.d,z:Ae},At=(e,t,i)=>{const{config:{direction:s,times:o},position:a}=t,{size:{z:n}}=i,r=se(s),h=we(r),p=s==="towards"||s==="right",u={...k,[h]:p?-1:0};return{type:"wall",id:e,config:t.config,aabb:ee(r==="y"?Mt(n):Tt(n),o),renders:!p,renderAabb:p?void 0:ee(r==="y"?Bt:Pt,o),state:{position:g(d(a,u)),stoodOnBy:O,expires:null,disappear:null},shadowCastTexture:r==="y"?"shadow.wall.y":{textureId:"shadow.wall.y",flipX:!0}}};function*Ce(e,t,i,s,o={}){if(!s[e]&&!(t.type==="pickup"&&t.config.gives==="scroll"&&o[t.config.page]))switch(t.type){case"door":return yield*xt(t,e);case"player":{yield Ot(t);return}case"wall":{yield At(e,t,i);return}default:{const a=Be(t),n=t.config.times!==void 0?{aabb:ee(a.aabb,t.config.times),renderAabb:void 0}:a;yield{...t,...v,...n,shadowMask:Rt(t),shadowCastTexture:Ct(t),id:e,config:t.config,state:zt(t)}}}}const Rt=e=>{switch(e.type){case"lift":return{spriteOptions:"shadowMask.smallBlock",relativeTo:"origin"};case"conveyor":return{spriteOptions:{textureId:"shadowMask.conveyor",flipX:me(e.config.direction)==="x"},relativeTo:"origin"};case"barrier":return{spriteOptions:{textureId:"shadowMask.barrier.y",flipX:e.config.axis==="x"},relativeTo:"origin"};case"spring":return{spriteOptions:"shadowMask.smallRound",relativeTo:"origin"};case"block":return{spriteOptions:e.config.style==="tower"?"shadowMask.tower":"shadowMask.fullBlock",relativeTo:"origin"};case"pushableBlock":case"movingPlatform":return{spriteOptions:e.config.style==="stepStool"?"shadowMask.stepStool":"shadowMask.fullBlock",relativeTo:"origin"};case"teleporter":return{spriteOptions:"shadowMask.teleporter",relativeTo:"origin"};case"hushPuppy":return{spriteOptions:"shadowMask.hushPuppy",relativeTo:"origin"};case"portableBlock":return{spriteOptions:e.config.style==="drum"?"shadowMask.smallRound":"shadowMask.smallBlock",relativeTo:"origin"};case"slidingBlock":return{spriteOptions:e.config.style==="book"?"shadowMask.fullBlock":"shadowMask.smallRound",relativeTo:"origin"};case"deadlyBlock":switch(e.config.style){case"volcano":return{spriteOptions:"shadowMask.volcano",relativeTo:"origin"};case"toaster":return{spriteOptions:"shadowMask.fullBlock",relativeTo:"origin"};case"spikes":return{spriteOptions:"shadowMask.spikes",relativeTo:"origin"};default:e.config.style}break;case"switch":return{spriteOptions:"shadowMask.switch",relativeTo:"origin"};case"pickup":return e.config.gives==="scroll"?{spriteOptions:"shadowMask.scroll",relativeTo:"origin"}:void 0;case"slidingDeadly":return{spriteOptions:"shadowMask.smallRound",relativeTo:"origin"};case"monster":switch(e.config.which){case"dalek":return{spriteOptions:"shadowMask.dalek",relativeTo:"origin"};default:return}case"joystick":return{spriteOptions:"shadowMask.joystick",relativeTo:"origin"}}},Ct=e=>{switch(e.type){case"lift":return"shadow.smallBlock";case"conveyor":return{textureId:"shadow.fullBlock",flipX:me(e.config.direction)==="x"};case"barrier":return{textureId:"shadow.barrier.y",flipX:e.config.axis==="x"};case"spring":return"shadow.smallRound";case"block":return e.config.style==="tower"?"shadow.smallRound":"shadow.fullBlock";case"pushableBlock":case"movingPlatform":case"hushPuppy":case"deadlyBlock":return"shadow.fullBlock";case"portableBlock":return e.config.style==="drum"?"shadow.smallRound":"shadow.smallBlock";case"pickup":return e.config.gives==="scroll"?"shadow.scroll":"shadow.smallRound";case"monster":return"shadow.smallRound"}},He=({aabb:e,state:{position:t}},{aabb:i,state:{position:s}})=>!(t.x+e.x<=s.x||t.x>=s.x+i.x)&&!(t.y+e.y<=s.y||t.y>=s.y+i.y)&&!(t.z+e.z<=s.z||t.z>=s.z+i.z),oe=(e,t)=>[...N(t).filter(i=>e.id!==i.id&&He(e,i))],Ht=e=>{const t={},i=Object.values(e.items).filter(s=>s.type==="door");for(const{config:{direction:s},position:{x:o,y:a}}of i)se(s)==="x"?a===0?t.towards=!0:a===e.size.y&&(t.away=!0):o===0?t.right=!0:o===e.size.x&&(t.left=!0);return t},Fe=e=>{const t=Ht(e),i=t.right?-.5:0,s=e.size.x+(t.left?.5:0),o=t.towards?-.5:0,a=e.size.y+(t.away?.5:0);return{blockXMin:i,blockXMax:s,blockYMin:o,blockYMax:a,sidesWithDoors:t}},Fi=e=>{const{blockXMax:t,blockXMin:i,blockYMax:s,blockYMin:o,sidesWithDoors:a}=Fe(e),n=S({x:e.size.x+(a.right?.5:0),y:-o}).x,r=S({x:-i,y:e.size.y+(a.towards?.5:0)}).x,h=S({x:e.size.x,y:e.size.y}).y,p=S({x:i,y:o}),u=S({x:t,y:s});return{blockXMin:i,blockXMax:t,blockYMin:o,blockYMax:s,edgeLeftX:n,edgeRightX:r,topEdgeY:h,frontSide:p,backSide:u,sidesWithDoors:a}};function*Ft(e){const t=e.size.z??U,i=g({...e.size,z:1}),{blockXMax:s,blockXMin:o,blockYMax:a,blockYMin:n}=Fe(e),r=g({x:s-o,y:a-n,z:1}),h=g({..._e,z:-1}),p=g({x:o,y:n,z:-1});if(yield{id:"floorEdge",...v,type:"floorEdge",state:{...H(),position:{...p,z:0}},aabb:k,config:{},fixedZIndex:9999},e.floor==="none"&&e.roomBelow!==void 0?(yield{...v,type:"floor",id:"floor",config:{type:"none"},aabb:i,shadowMask:void 0,state:{position:p,expires:null,stoodOnBy:{},disappear:null},renders:!0,fixedZIndex:-1},yield{...v,type:"portal",id:"floor/portal",config:{toRoom:e.roomBelow,relativePoint:{x:i.x/2,y:i.y/2,z:i.z},direction:T.down},aabb:i,state:{position:h,expires:null,stoodOnBy:{},disappear:null},renders:!1}):yield{...v,type:"floor",id:"floor",config:{type:e.floor==="deadly"?"deadly":"standable"},aabb:r,shadowMask:{relativeTo:"origin"},state:{position:p,expires:null,stoodOnBy:{},disappear:null},renders:!0,fixedZIndex:-1},e.roomAbove!==void 0){const u=d(h,{z:c.h*t});yield{...v,type:"portal",id:"ceiling",config:{toRoom:e.roomAbove,relativePoint:{...e.ceilingRelativePoint!==void 0?g(e.ceilingRelativePoint):{x:i.x/2,y:i.y/2},z:-12},direction:T.up},aabb:i,state:{position:u,expires:null,stoodOnBy:{},disappear:null},renders:!1}}}const Si=(e,t)=>t?.[e],K=e=>Le(e),R=e=>N(K(e)),Wi=e=>N(qe(e)),Di=e=>({head:e.head,heels:e.heels,headOverHeels:e.headOverHeels});function*St(e,t,i){const{gameMenus:{scrollsRead:s}}=G.getState(),o=Ye(e.items);for(const[a,n]of o)n.type==="player"&&!i||(yield*Ce(a,n,e,t,s))}const fe=e=>N(e).reduce((t,i)=>({...t,[i.id]:i}),{}),Wt=({roomJson:e,roomPickupsCollected:t,isNewGame:i=!1})=>{const s={...fe(Ft(e)),...fe(St(e,t,i))};for(const a of R(s)){const r=oe(a,K(s)).find(h=>V(a)&&V(h)&&!(a.type==="wall"&&h.type==="wall"));r!==void 0&&console.error(`in room ${e.id} item ${a.id} @${JSON.stringify(a.state.position)} #${JSON.stringify(a.aabb)} is colliding with (solid item) ${r.id} @${JSON.stringify(r.state.position)} #${JSON.stringify(r.aabb)} on loading room ${e.id}`)}return{...e,roomJson:e,items:{...s},roomTime:0}},Dt=({state:{position:e,facing:t,autoWalk:i,action:s,vels:o}})=>({position:e,facing:t,autoWalk:i,action:s,vels:{...o}}),Xt=(e,t)=>N(Ge(e)).map(i=>t.items[i]);function Se(e,t){return e===null?null:t.items[e]}const ie=(e,t)=>{if(e.state.standingOnItemId!==null){const i=Se(e.state.standingOnItemId,t);delete i.state.stoodOnBy[e.id],e.state.standingOnItemId=null}},We=({above:e,below:t})=>{e.state.standingOnItemId=t.id,t.state.stoodOnBy[e.id]=!0},D=({room:e,item:t})=>{const i=typeof t=="string"?e.items[t]:t;X(i)&&ie(i,e);for(const s of Xt(i.state.stoodOnBy,e))ie(s,e);typeof t=="string"?delete e.items[t]:delete e.items[i.id]};let $t=0;const Et=({gameState:e,room:t,itemType:i,config:s,position:o})=>{const a={type:i,config:s,position:k},n=`${i}/${$t++}`,r=je(Ce(n,a,t.roomJson,e.pickupsCollected[t.id]??O));if(r===void 0)throw console.error("failed to generate any items for json",n,a),new Error("failed to generate any items");return r.state.position=o,Q({room:t,item:r}),r},Q=({room:e,item:t})=>(e.items[t.id]=t,t),Nt=1e3/25,De=e=>{const t=Ve.animations[e],i=t.length,{animationSpeed:s}=t;return i*Nt/s};De("bubbles.white");const _t=De("head.fadeOut"),Lt=({touchedItem:e,room:t,gameState:i})=>{D({room:t,item:e});const s=Et({itemType:"bubbles",config:{style:"white",was:e.type==="pickup"?{type:"pickup",gives:e.config.gives}:{type:"disappearing"}},position:k,room:t,gameState:i}),o=d(e.state.position,A(e.aabb,.5));s.state.position=C(o,A(s.aabb,.5)),s.state.expires=t.roomTime+_t},qt=(e,t)=>{const i=R(e.items).filter(f("hushPuppy"));for(const s of i)Lt({touchedItem:s,gameState:t,room:e})},Yt=.5,ye=(e,t,i,s)=>{const o=i.x+s.x-e.x,a=i.y+s.y-e.y,n=i.z+s.z-e.z,r=e.x+t.x-i.x,h=e.y+t.y-i.y,p=e.z+t.z-i.z,u=Math.abs(o)<Math.abs(r)?o:-r,m=Math.abs(a)<Math.abs(h)?a:-h,l=Math.abs(n)<Math.abs(p)?n:-p,y=Math.abs(u),z=Math.abs(m),P=Math.abs(l)*Yt;return y<z&&y<P?{x:u,y:0,z:0}:z<P?{x:0,y:m,z:0}:{x:0,y:0,z:l}},ge=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),be={stopAutowalk:5,portal:5,wall:5,doorLegs:5,sceneryPlayer:5,bubbles:5,switch:10,doorFrame:15,ball:18,block:20,barrier:20,floor:20,floorEdge:20,hushPuppy:20,teleporter:20,lift:30,movingPlatform:30,pushableBlock:30,portableBlock:30,slidingBlock:30,spring:30,joystick:40,charles:40,conveyor:40,head:50,heels:50,headOverHeels:50,pickup:80,firedDoughnut:90,slidingDeadly:100,moveableDeadly:100,deadlyBlock:100,monster:100},Gt=(e,t)=>be[e.type]-be[t.type],Vt=(e,t)=>t.toSorted((i,s)=>{const o=Gt(i,s);if(o!==0)return o;const a=re(e,ge(e,i)),n=re(e,ge(e,s));return Math.abs(a-n)<1e-4?i.id<s.id?-1:1:a-n}),Xe=({subjectItem:e,posDelta:t,gameState:i,room:s,pusher:o,deltaMS:a,forceful:n=f("lift")(e)&&o===void 0,recursionDepth:r=0,onTouch:h})=>{if(xe(t,k))return;const{state:{position:p}}=e;if(e.state.position=d(p,t),X(e)){const{actedOnAt:l}=e.state;l.roomTime===s.roomTime?o&&(l.by[o.id]=!0):(l.by=o?{[o.id]:!0}:{},l.roomTime=s.roomTime)}const u=Vt(t,oe(e,K(s.items)));let m=!1;for(const l of u){if(!He(e,l))continue;if(X(e)){const{collidedWith:P}=e.state;P.roomTime===s.roomTime?o&&(P.by[l.id]=!0):(P.by={[l.id]:!0},P.roomTime=s.roomTime)}const y=ut(l);if(o!==l&&!(m&&y)&&h!==void 0&&(h({movingItem:e,touchedItem:l,movementVector:C(e.state.position,p),gameState:i,deltaMS:a,room:s}),m=m||y),s.items[e.id]===void 0)return;if(s.items[l.id]===void 0||!V(l,e)||!V(e))continue;const z=ye(e.state.position,e.aabb,l.state.position,l.aabb);if(at(e,l,n)&&l!==o){const P=n||nt(l)?-1:-.5,ae=A(z,P);if(e.state.position=d(e.state.position,z,ae),r<kt&&Xe({subjectItem:l,posDelta:ae,pusher:e,gameState:i,room:s,deltaMS:a,forceful:n,recursionDepth:r+1,onTouch:h}),s.items[l.id]===void 0)continue;e.state.position=d(e.state.position,ye(e.state.position,e.aabb,l.state.position,l.aabb))}else e.state.position=d(e.state.position,z);X(e)&&z.z>0&&(e.state.standingOnItemId===null||!u.includes(Se(e.state.standingOnItemId,s)))&&(ie(e,s),We({above:e,below:l}))}},Zt=(e,t,{changeType:i,sourceItem:s})=>{switch(i){case"portal":return R(e.items).find(o=>F(o)&&o.config.toRoom===t.id&&xe(A(s.config.direction,-1),o.config.direction));case"level-select":return R(e.items).find(o=>F(o)&&o.config.toRoom===t.id&&o.config.direction.z===0)??R(e.items).find(o=>F(o)&&o.config.direction.z===0)??R(e.items).find(o=>F(o)&&o.config.direction.z>0)??R(e.items).find(F)}},It=(e,t,i,s)=>{const o=1*c.w;e.state.position=d(e.state.position,A(t,o));for(let a=0;a<o;a++)Xe({subjectItem:e,posDelta:A(t,-1),gameState:i,room:s,deltaMS:16,forceful:!0,onTouch:void 0})},Xi=e=>{const{playableItem:t,gameState:i,toRoomId:s,changeType:o,sourceItem:a}=e,n=i.characterRooms[t.id];if(n===void 0)throw new Error(`${t.id} is not in a room on the gameState`);if(s===n.id)throw new Error(`Can't move ${t.id} to the same room "${s}""`);let r;switch(o){case"portal":{const{config:{relativePoint:y},state:{position:z}}=a;r=C(t.state.position,d(z,y));break}case"teleport":{const{state:{position:y}}=a;r=C(t.state.position,y);break}case"level-select":r={x:0,y:0,z:0};break;default:throw new Error}const h=t.type==="headOverHeels"?void 0:i.characterRooms[W(t.id)],p=i.campaign.rooms[s];if(p===void 0)throw new Error(`room ${s} does not exist in campaign`);const u=h?.id===s?h:Wt({roomJson:p,roomPickupsCollected:i.pickupsCollected[s]??O});D({room:n,item:t});const m=pt(t);if(m!==void 0&&(m.carrying=null),t.state.latentMovement=[],(t.type==="head"||t.type==="headOverHeels")&&qt(u,i),D({room:u,item:t}),u.items[t.id]=t,i.characterRooms[t.id]=u,e.changeType==="teleport"){const{config:{toPosition:y}}=e.sourceItem;t.state.position=d(g(y),r)}else{const y=Zt(u,n,e);if(console.log("putting",t.id,"into",s,"at portal",y,"because",o,"sourceportal",a),y===void 0)if(e.changeType==="level-select")t.state.position=g({x:1,y:1,z:8});else throw new Error(`trying to move ${t.id} from ${n.id} --to-> ${s} but no destination portal found to locate with`);else{t.state.position=d(y.state.position,y.config.relativePoint,r,o==="portal"&&a.config.direction.z>0?{z:c.h}:{});const{config:{direction:z}}=y;z.z===0&&(t.state.autoWalk=!0,t.state.facing=A(z,-1),t.state.action==="idle"&&(t.state.action="moving"),It(t,z,i,u))}}const l=oe(t,K(u.items));l.length>0&&console.warn("on entering room",s,"character",t.id,"at",t.state.position,"collides with",l),i.entryState[t.id]=Dt(t),t.id==="headOverHeels"?(delete i.entryState.head,delete i.entryState.heels):(i.entryState[W(t.id)]||(i.entryState[W(t.id)]=i.entryState.headOverHeels),delete i.entryState.headOverHeels),G.dispatch(Ze(s))},Qt=e=>{const t=M(e,"head"),i=M(e,"heels");return t!==void 0&&i!==void 0&&t.state.action==="idle"&&i.state.action==="idle"&&t.state.standingOnItemId==="heels"},Ut=e=>{const t={id:"head",type:"head",...v,...I,state:{...H(),...$(),...E(),...e.state.head,facing:e.state.facing,position:d(e.state.position,{z:c.h}),switchedToAt:w,actedOnAt:e.state.actedOnAt,collidedWith:e.state.collidedWith}},i={id:"heels",type:"heels",...v,...I,state:{...H(),...$(),...E(),...e.state.heels,facing:e.state.facing,position:d(e.state.position),switchedToAt:w,actedOnAt:e.state.actedOnAt,collidedWith:e.state.collidedWith}};return{head:t,heels:i}},Kt=({head:e,heels:t})=>({id:"headOverHeels",type:"headOverHeels",...v,shadowCastTexture:t.shadowCastTexture,config:O,aabb:Y,state:{...H(),...$(),...E(),position:t.state.position,action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:t.state.facing,actedOnAt:t.state.actedOnAt.roomTime>e.state.actedOnAt.roomTime?t.state.actedOnAt:e.state.actedOnAt,collidedWith:t.state.collidedWith.roomTime>e.state.collidedWith.roomTime?t.state.collidedWith:e.state.collidedWith,head:{...le(e.state,"hasHooter","doughnuts","doughnutLastFireTime","fastStepsStartedAtDistance","gameWalkDistance","lives","gameTime","shieldCollectedAt","lastDiedAt"),switchedToAt:w},heels:{...le(t.state,"hasBag","bigJumps","carrying","lives","gameTime","shieldCollectedAt","lastDiedAt"),switchedToAt:w}}}),Jt=e=>{const t=e.characterRooms.head,i=M(e,"head"),s=M(e,"heels"),o=Kt({head:i,heels:s});D({room:t,item:"head"}),D({room:t,item:"heels"}),Q({room:t,item:o}),e.previousPlayable=e.currentCharacterName,e.currentCharacterName="headOverHeels",e.characterRooms={head:void 0,heels:void 0,headOverHeels:t}},jt=(e,t)=>{const i=e.characterRooms.headOverHeels,s=M(e,"headOverHeels"),o=t??W(e.previousPlayable),{head:a,heels:n}=Ut(s);D({room:i,item:"headOverHeels"}),Q({room:i,item:a}),Q({room:i,item:n}),We({above:a,below:n}),e.currentCharacterName=o,e.previousPlayable=void 0,e.characterRooms={head:i,heels:i,headOverHeels:void 0}},ei=e=>{const t=M(e,e.currentCharacterName);t!==void 0&&(t.type==="headOverHeels"?(t.state.head.switchedToAt=t.state.head.gameTime,t.state.heels.switchedToAt=t.state.heels.gameTime):t.state.switchedToAt=t?.state.gameTime)},$i=(e,t)=>{Qt(e)&&(!t||t===e.currentCharacterName)?Jt(e):e.currentCharacterName==="headOverHeels"?jt(e,t):(!t||t!==e.currentCharacterName)&&M(e,W(e.currentCharacterName))!==void 0&&(e.currentCharacterName=W(e.currentCharacterName)),ei(e)};export{zi as $,di as A,xi as B,ye as C,Xe as D,Se as E,pi as F,ri as G,ui as H,gt as I,Oi as J,Ti as K,mi as L,wi as M,bi as N,We as O,Lt as P,ze as Q,R,oi as S,K as T,D as U,oe as V,et as W,gi as X,bt as Y,vi as Z,ki as _,X as a,Q as a0,v as a1,Xt as a2,li as a3,ci as a4,ct as a5,hi as a6,Ut as a7,Kt as a8,qt as a9,ie as aa,Nt as ab,Wi as ac,$i as ad,wt as ae,Mi as af,ni as ag,Bi as ah,Ri as ai,Fi as aj,Ci as ak,ut as al,Hi as am,g as an,fi as b,Xi as c,Jt as d,M as e,Et as f,Si as g,c as h,f as i,Dt as j,Pi as k,Wt as l,V as m,He as n,W as o,S as p,Gt as q,Qe as r,si as s,Ai as t,_t as u,pt as v,yi as w,Oe as x,ai as y,Di as z};
