import{j as o,r as u}from"./index-TplYrkDL.js";import{B as J,o as G,n as ie,S as ae}from"./ShowBoundingBoxSelect-rewcgYTJ.js";import{ap as W,a9 as g,w as P,z as ce,B as q,S as le,s as ue,N as V,aa as y,aq as I,a8 as A,ar as de,as as K,R as E,at as pe,F as me,au as xe,av as he,$ as Y,aw as fe,ax as R,ay as ye,az as M,aA as ge,U as Q,aB as ve,aC as k,aD as be,aE as je,K as ee,aj as L,o as we,aF as Se,ao as Ce,aG as ke,aH as Re,aI as Te,aJ as Ie,aK as Pe,C as Ee}from"./App-DIb0nj6o.js";import{useAppSelectorWithLevelEditorSlice as j,selectTool as C,setTool as te,selectCurrentEditingRoomColour as Ne,changeRoomColour as _,selectCurrentEditingRoomScenery as Be,changeRoomScenery as ze,selectCurrentEditingRoomJson as F,applyToolAtPosition as $e}from"./levelEditorSlice-CRs4sjWk.js";import{c as Ae,A as Me,s as Le,R as _e,i as Fe,z as De,a as He,p as oe}from"./roomRenderer-C1GXh2x1.js";import"./Graphics-IExbwQyI.js";import"./changeCharacterRoom-Eb5vVvTm.js";const N=e=>e,c=({itemTool:e,children:t,className:s})=>{const i=j(C),n=W(i?.type==="item"&&i.item,e);return o.jsx(J,{"data-iscurrenttool":n,className:`active:pt-oneScaledPix h-3 w-3 gap-0 inline-flex overflow-hidden ${n?"bg-pastelBlue":""} ${s??""}`,onClick:()=>g.dispatch(te({type:"item",item:e})),children:t})},Oe=()=>{const t=j(C)?.type==="pointer";return o.jsx(J,{className:`flex w-3 h-3 ${t?"bg-pastelBlue":""}`,onClick:()=>g.dispatch(te({type:"pointer"})),children:o.jsx("span",{className:"sprite texture-hud.char.â†– relative [button:active_&]:top-quarter"})})},D=e=>{const{main:t}=Ae[e].basic;return{backgroundColor:t.basic.toHex(),borderColor:t.dimmed.toHex()}};function Ue(){const e=P(),t=j(Ne);return o.jsxs(o.Fragment,{children:[o.jsx(G,{value:t.hue,onSelect:s=>{e(_({hue:s}))},values:ce,disableCommandInput:!0,OptionCommandItem:({value:s,onSelect:i})=>o.jsx(ie,{value:s,className:"border-1 h-4 w-2",style:D(s),onSelect:i}),triggerButtonLabel:o.jsx(q,{children:"colour"}),triggerButtonClassName:N(`${t.hue==="white"?"text-pureBlack":"text-white"}`),triggerButtonStyle:D(t.hue)}),o.jsx(le,{value:t.shade==="basic",onClick:(s,i)=>{e(_({shade:i?"basic":"dimmed"}))},falseLabel:"dimmed",trueLabel:"basic"})]})}function Xe(){const e=P(),t=j(Be);return o.jsx(G,{value:t,onSelect:s=>{e(ze(s))},values:ue,disableCommandInput:!0,triggerButtonClassName:"w-18 text-white",triggerButtonLabel:o.jsx(q,{children:t})})}const a=N("[button:not([data-iscurrenttool=true]):not(:hover)_&]:sprite-revert-to-two-tone"),w=N("flex flex-wrap gap-oneScaledPix w-full"),Ze=()=>o.jsxs("div",{className:"flex fixed top-0 right-0 w-14 text-white bg-metallicBlueHalfbrite p-half gap-oneScaledPix flex-wrap justify-start",children:[o.jsx(Xe,{}),o.jsx(Ue,{}),o.jsx("div",{className:w,children:o.jsx(Oe,{})}),o.jsxs("div",{className:w,children:[o.jsx(c,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}},children:o.jsx("span",{className:`sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek" ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}},children:o.jsx("span",{className:`sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"turn-to-player",startDirection:"towards"}},children:o.jsx("span",{className:`sprite texture-elephant.towards [button:hover_&]:texture-elephant.right ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}},children:o.jsx("span",{className:`sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"cyberman",activated:"on",movement:"towards-on-shortest-axis-xy4",startDirection:"towards"}},children:o.jsx("span",{className:`sprite texture-cyberman.towards [button:hover_&]:texture-cyberman.right ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"helicopterBug",activated:"on",movement:"patrol-randomly-xy8"}},children:o.jsx("span",{className:`sprite texture-helicopterBug.1 [button:hover_&]:texture-animated-helicopterBug ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"homingBot",activated:"on",movement:"towards-tripped-on-axis-xy4"}},children:o.jsx("span",{className:`sprite texture-headlessBase [button:hover_&]:texture-headlessBase.all ${a}`})}),o.jsx(c,{itemTool:{type:"monster",config:{which:"computerBot",activated:"on",movement:"patrol-randomly-xy4-and-reverse"}},children:o.jsx("span",{className:`sprite texture-computerBot.towards [button:hover_&]:texture-computerBot.right ${a}`})})]}),o.jsxs("div",{className:w,children:[o.jsx(c,{itemTool:{type:"block",config:{style:"artificial"}},children:o.jsx("span",{className:`sprite texture-block.artificial ${a}`})}),o.jsx(c,{itemTool:{type:"block",config:{style:"organic"}},children:o.jsx("span",{className:`sprite texture-block.organic ${a}`})}),o.jsx(c,{itemTool:{type:"block",config:{style:"book"}},children:o.jsx("span",{className:`sprite texture-book.x ${a}`})})]}),o.jsxs("div",{className:w,children:[o.jsxs(c,{itemTool:{type:"lift",config:{top:11,bottom:0}},className:"inline relative",children:[o.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.static ${a} [button:active_&]:top-oneScaledPix`}),o.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.1 [button:hover_&]:texture-animated-lift ${a} [button:active_&]:top-oneScaledPix`})]}),o.jsx(c,{itemTool:{type:"barrier",config:{axis:"x"}},children:o.jsx("span",{className:`sprite texture-barrier.x ${a}`})}),o.jsx(c,{itemTool:{type:"pickup",config:{gives:"extra-life"}},children:o.jsx("span",{className:`sprite texture-whiteRabbit ${a}`})}),o.jsx(c,{itemTool:{type:"conveyor",config:{direction:"away"}},children:o.jsx("span",{className:`sprite texture-conveyor.y.1 [button:hover_&]:texture-animated-conveyor.x ${a}`})}),o.jsx(c,{itemTool:{type:"teleporter",config:{toRoom:"(placeholder)",toPosition:V}},children:o.jsx("span",{className:`sprite texture-teleporter ${a}`})}),o.jsx(c,{itemTool:{type:"charles",config:y},children:o.jsx("span",{className:`sprite texture-charles.towards [button:hover_&]:texture-charles.right ${a}`})}),o.jsx(c,{itemTool:{type:"joystick",config:{controls:["(placeholder)"]}},children:o.jsx("span",{className:`sprite texture-joystick ${a}`})}),o.jsx(c,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:I}},children:o.jsx("span",{className:`sprite texture-switch.left [button:hover_&]:texture-switch.right ${a}`})}),o.jsx(c,{itemTool:{type:"ball",config:y},children:o.jsx("span",{className:`sprite texture-ball ${a}`})}),o.jsx(c,{itemTool:{type:"portableBlock",config:{style:"cube"}},children:o.jsx("span",{className:`sprite texture-cube ${a}`})}),o.jsx(c,{itemTool:{type:"pushableBlock",config:{style:"stepStool"}},children:o.jsx("span",{className:`sprite texture-stepStool ${a}`})}),o.jsx(c,{itemTool:{type:"movingPlatform",config:{style:"sandwich",movement:"clockwise",activated:"on",startDirection:"towards"}},children:o.jsx("span",{className:`sprite texture-sandwich ${a}`})}),o.jsx(c,{itemTool:{type:"spikes",config:y},children:o.jsx("span",{className:`sprite texture-spikes ${a}`})}),o.jsx(c,{itemTool:{type:"deadlyBlock",config:{style:"volcano"}},children:o.jsx("span",{className:`sprite texture-volcano.1 [button:hover_&]:texture-animated-volcano ${a}`})}),o.jsx(c,{itemTool:{type:"slidingDeadly",config:{style:"spikyBall",startingPhase:1}},children:o.jsx("span",{className:`sprite texture-spikyBall.1 [button:hover_&]:texture-spikyBall.2 ${a}`})}),o.jsx(c,{itemTool:{type:"door",config:{direction:"away",toRoom:"(placeholder)"}},children:o.jsx("span",{className:`sprite texture-door.frame.generic.x.whole ${a}`})})]}),o.jsx("div",{className:"flex flex-row gap-1",children:o.jsx(ae,{})})]}),se=u.createContext(null),Je=()=>{const[e,t]=u.useState(()=>A({roomJson:F(g.getState()),roomPickupsCollected:y,scrollsRead:y,isNewGame:!0})),s=j(F);return u.useEffect(()=>{const i=A({roomJson:s,roomPickupsCollected:y,scrollsRead:y,isNewGame:!0});t(i)},[s]),e},Ge=({children:e})=>{const t=Je();return o.jsx(se,{value:t,children:e})},B=()=>{const e=u.useContext(se);if(e===null)throw new Error("no room state in context, or no context");return e},re=u.createContext(null),We=({children:e})=>{const[t,s]=u.useState(null);return u.useEffect(()=>{const i=new Me;return i.init({background:Le.pureBlack,sharedTicker:!0}).then(()=>{s(i)}),()=>{}},[]),t===null?null:o.jsx(re,{value:t,children:e})},v=()=>u.useContext(re),qe=(e,t)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:t},soundSettings:{mute:!0},pixiRenderer:e,gameState:void 0,paused:!1,colourised:!0,upscale:K(g.getState())}),H=(e,t,s)=>new _e({room:e,general:qe(t,s)}),Ve=()=>{const{renderer:e}=v(),t=de();if(!e)throw new Error("this should never be falsey (typescript violation)");const s=B(),[i,n]=u.useState(()=>H(s,e,t));return u.useEffect(()=>{const r=H(s,e,t);return n(r),()=>{r.destroy()}},[s,e,t]),i},S="cursor",O=({room:e,pointingAt:t,valid:s,includeCursor:i,previewItems:n})=>{const{face:r,position:l}=t;for(const d of n)pe({room:e,item:d});if(i){const d=me(S,e.items);d?(d.state.position=l,d.state.face=r,d.state.valid=s):e.items[S]={type:"cursor",id:S,state:{...he(),face:r,position:l,valid:s},config:{},aabb:xe}}else delete e.items[S]},T=e=>{for(const t of E(e.items))t.isCursorPreview&&delete e.items[t.id]};let Ke=0;const ne=(e,t,s)=>{if(e.face==="up")return R(e.position);if(s.type==="door"){const n=t.items[e.itemId];if(n.type!=="wall")return;const r={x:Math.max(Math.min(e.position.x,n.state.position.x+n.aabb.x-M),n.state.position.x),y:Math.max(Math.min(e.position.y,n.state.position.y+n.aabb.y-M),n.state.position.y),z:Math.max(Math.min(e.position.z,n.state.position.z+n.aabb.z-ye),n.state.position.z)};return R(r)}const i=ge[e.face];return Q(R(e.position),i)},U=(e,t,s)=>{const i=[...E(t.items).filter(r=>Y(r)&&r.type!=="cursor"&&!r.isCursorPreview)],n=(r,l)=>{const d=ne(e,t,s),p=ve(`cursor/${Ke++}`,{type:r,config:l,position:d},t.roomJson).toArray();return p.forEach(x=>{x.isCursorPreview=!0}),p};if(s.type==="door"){const r=t.items[e.itemId];if(r.type!=="wall")return;const l=r.config.direction;return n("door",{...s.config,direction:l})}else{const r=n(s.type,s.config);return r.some(d=>{const p=fe(d,i);return!Fe(p)})?void 0:r}},m=ee.w/2,b=ee.h,X=m/2,Ye=b/2,Qe=({x:e,y:t})=>s=>{const{bottomCentre:i,topLeft:n,topRight:r}=oe(s.state.position,s.aabb);return!(e<n.x||e>r.x||t<r.y-(r.x-e)/2||t<n.y-(e-n.x)/2||t>i.y-(e-i.x)/2||t>i.y-(i.x-e)/2)},et=(e,{x:t,y:s},i)=>{if(i.type==="item"&&i.item.type==="door"&&e.type==="wall")return be(e.config.direction);const{bottomCentre:n,topLeft:r,topRight:l}=oe(e.state.position,e.aabb);return s<r.y-(r.x-t)/2?s<l.y-(t-l.x)/2?"up":"right":t<n.x?"towards":"right"},Z=e=>e.fixedZIndex!==void 0,tt=e=>{if(e.every(Z))return e.toSorted((r,l)=>l.fixedZIndex-r.fixedZIndex).at(0);const t=e.filter(r=>!Z(r));if(t.length===0)return;if(t.length===1)return t[0];const s=Object.fromEntries(t.map(r=>[r.id,r])),i=De(s),{order:n}=He(i,s);return s[n[0]]},ot=({state:{position:e},aabb:t},s,i)=>{let n=V,r;switch(s){case"up":n={z:t.z},r="xy";break;case"down":r="xy";break;case"towards":r="xz";break;case"away":n={y:t.y},r="xz";break;case"left":n={x:t.x},r="yz";break;case"right":r="yz";break;default:throw new Error('unexpected face "'+s+'"')}const l=je(i,Q(e,n),r);return{x:r==="yz"?Math.round(l.x/m)*m:Math.floor((l.x-X)/m)*m,y:r==="xz"?Math.round(l.y/m)*m:Math.floor((l.y-X)/m)*m,z:r==="xy"?Math.round(l.z/b)*b:Math.floor((l.z+Ye)/b)*b}},st=e=>t=>{const s=Y(t)&&t.type!=="cursor"&&!t.isCursorPreview;return e.type==="item"&&e.item.type==="door"?s&&t.type==="wall":s},rt=(e,t,s)=>{const i=tt(Array.from(E(t.items).filter(st(s)).filter(Qe(e))));if(i){const n=et(i,e,s);return{itemId:i.id,face:n,position:ot(i,n,e)}}else return},nt=(e,t)=>{const s=e.cssUpscale*e.gameEngineUpscale;return{x:t.x/s-e.gameEngineScreenSize.x/2,y:t.y/s-e.gameEngineScreenSize.y+16}},it=e=>{const t=v(),s=k(K),i=P(),n=B(),r=u.useRef(void 0);u.useEffect(()=>{if(t.stage.eventMode="none",e===null)return;const l=p=>{const x=nt(s,p),h=C(g.getState()),f=rt(x,n,h);if(!W(f,r.current))if(r.current=f,f!==void 0)switch(h.type){case"item":{const z=U(f,n,h.item),$=z!==void 0;T(n),O({room:n,pointingAt:f,valid:$,includeCursor:!$,previewItems:z??I});break}case"pointer":{T(n),O({room:n,pointingAt:f,valid:!0,includeCursor:!0,previewItems:I});break}}else T(n)},d=p=>{const x=C(g.getState());switch(x.type){case"item":{const h=r.current;if(h===void 0||U(h,n,x.item)===void 0)return;i($e({blockPosition:ne(h,n,x.item)}));break}}};return e.addEventListener("mousemove",l),e.addEventListener("click",d),()=>{e.removeEventListener("mousemove",l),e.removeEventListener("click",d)}},[t.stage,s,e,i,n])},at=e=>{const t=B();u.useEffect(()=>{let s=0;const i=({deltaMS:n})=>{if(e.destroyed)return;e.renderContext.room!==t&&console.warn("room renderer does not have the current room");const r=new Set(we(t.items));e.tick({deltaMS:n,movedItems:r,progression:s++})};return L.shared.add(i),()=>{L.shared.remove(i)}},[e,t])},ct=e=>{const t=v();u.useEffect(()=>{if(e)return e.appendChild(t.canvas),()=>{e.removeChild(t.canvas)}},[e,t])},lt=()=>{const e=v(),t=k(s=>s.upscale.upscale.gameEngineUpscale);e.stage.scale=t},ut=()=>{const e=v(),t=k(Se);u.useEffect(()=>{e.renderer?.resize(t.x,t.y)},[e.renderer,t])},dt=e=>{const t=v(),[s]=u.useState(()=>new Ce),i=k(ke);u.useEffect(()=>{if(e.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return s.addChild(e.output.graphics),t.stage.addChild(s),()=>{t.stage.removeChild(s),s.removeChild(e.output.graphics)}},[e,t,s]),u.useEffect(()=>{s.x=i.x/2,s.y=i.y-16},[s,i])};Te.defaultOptions.scaleMode="nearest";const pt=()=>{const e=Ve(),[t,s]=u.useState(null);ut(),dt(e),at(e),it(t),ct(t),lt();const i=Re();return o.jsx("div",{style:i,ref:s})},bt=()=>(Ie(),Pe(),o.jsxs(o.Fragment,{children:[o.jsx("title",{children:"Hoh Editor"}),o.jsx(We,{children:o.jsx(Ge,{children:o.jsx(pt,{})})}),o.jsx(Ee,{scaleFactor:2,children:o.jsx(Ze,{})})]}));export{bt as default};
