import{A as le,F as Ne,H as ce,I as x,J as X,K as y,L as p,N as k,O as _,Q as F,W as Ae,X as J,Y as de,Z as ue,_ as z,$ as Pe,a0 as O,a1 as Be,a2 as Me,a3 as Fe,a4 as Ie,a5 as te}from"./App-CsGyxqis.js";import{g as Re}from"./index-DfSwvxid.js";var H={},C={},se;function Ee(){if(se)return C;se=1;var e=le(),t=e.iterableCurry,s=e.callReturn;function o(i,r){var l=i[Symbol.iterator](),h=l.next(),v=h.value,g=h.done;return g?r:(s(l),v)}C.__firstOr=o;var a=t(o,{reduces:!0});return C.firstOr=a,C}var oe;function He(){if(oe)return H;oe=1;var e=le(),t=e.iterableCurry,s=Ee(),o=s.__firstOr;function a(r){return o(r,void 0)}H.__first=a;var i=t(a,{reduces:!0});return H.first=i,H}var Z,ae;function Ce(){return ae||(ae=1,Z=He().first),Z}var Se=Ce();const $e=Re(Se),It=e=>e.characterRooms[e.currentCharacterName],n={w:16,d:16,h:12},Xe=["head","heels"],_e=[...Xe,"headOverHeels"],P=e=>e==="head"?"heels":"head",f=(...e)=>t=>e.includes(t.type),De=f("bubbles","stopAutowalk","floorEdge","firedDoughnut"),We=(e,t)=>De(e)||M(e)&&(t!==void 0&&Ge(t)||e.config.direction.z!==0)||Le(e)&&e.config.type==="none",ie=(e,t)=>!We(e,t),pe=["ball","slidingBlock","slidingDeadly"],Rt=f(...pe),Ye=["portableBlock","spring","sceneryPlayer"],Et=f(...Ye),Ge=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function Ve(e){return he.includes(e.type)}const he=[..._e,"monster","ball","charles","movableBlock","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer"],qe=["monster","deadlyBlock","moveableDeadly","slidingDeadly"],Ht=e=>f(...qe)(e)||e.type==="floor"&&e.config.type==="deadly",M=f("portal"),Ct=f("heels","headOverHeels"),St=f("head","headOverHeels"),$t=f("lift"),Xt=f("monster"),Le=f("floor"),_t=f("monster","movableBlock"),ye=f("head"),fe=f("heels"),D=f("headOverHeels"),m=(e,t)=>e.characterRooms[t]?.items[t],Dt=e=>m(e,e.currentCharacterName),Wt=e=>{if(ye(e))return e.state;if(D(e))return e.state.head},Ze=e=>{if(fe(e))return e.state;if(D(e))return e.state.heels},Ue=(e,t)=>{const s=m(e,e.currentCharacterName==="headOverHeels"?"headOverHeels":t);if(s!==void 0){if(t==="head"&&ye(s)||t==="heels"&&fe(s))return s.state;if(t==="head"&&D(s))return s.state.head;if(t==="heels"&&D(s))return s.state.heels}},Yt=Ue,Gt=(e,t)=>{const s=A(e);return t.x=s.x,t.y=s.y,t},Qe=e=>Ne(e)?Ke(e):Je(e),Ke=({x:e=0,y:t=0,z:s=0})=>{const o=Math.round(e),a=Math.round(t);return{x:a-o,y:Math.floor(-((o+a)/2)-s)}},Je=({x:e=0,y:t=0,z:s=0})=>({x:t-e,y:-(e+t)/2-s}),c=({x:e=0,y:t=0,z:s=0})=>({x:e*n.w,y:t*n.d,z:s*n.h}),A=e=>Qe(c(e)),u=ce/1e3,Vt={head:2e-4,heels:2e-4},je=2e-4,et={head:n.h*2/1e3,others:n.h*6/1e3},qt=je*.5,Lt=et.others*.5,Zt=.8,Ut=.001,Qt={head:u,heels:2*u,charles:u,dalek:Math.SQRT2*u,cyberman:1*u,skiHead:u,helicopterBug:u,homingBot:2*u,monkey:u,elephant:u,elephantHead:0,emperor:u,emperorsGuardian:u,bubbleRobot:u,computerBot:u,turtle:u,ball:2*u,firedDoughnut:2*u,movableBlock:u},tt=(e=1)=>e*ce/1e3,Kt=tt(),Jt=2,jt={head:n.h*2.6,heels:n.h},L=11,es=6e4,ts=9999,re=8,b={x:12,y:12,z:n.h},be={x:14,y:14,z:n.h},T={x:16,y:16,z:n.h},$={...b,z:n.h*2},ge=50,W=1,Y={x:n.w,y:n.d*W,z:L*n.h},we={x:Y.x,y:0,z:ge},G={x:n.w*W,y:n.d,z:L*n.h},ve={x:0,y:G.y,z:ge},xe=e=>{switch(e.type){case"spring":case"portableBlock":case"moveableDeadly":case"slidingDeadly":case"firedDoughnut":return{aabb:b};case"slidingBlock":return e.config.style==="book"?{aabb:T}:{aabb:b};case"lift":return{aabb:{...b,z:b.z}};case"switch":return{aabb:{...b,z:b.z}};case"pickup":return e.config.gives==="scroll"?{aabb:{x:16,y:4,z:12}}:{aabb:b};case"charles":return{aabb:$};case"ball":return{aabb:{x:11,y:11,z:12}};case"movableBlock":return{aabb:T};case"block":switch(e.config.style){case"artificial":case"organic":case"book":return{aabb:T};case"tower":return{aabb:{x:11,y:11,z:n.h}};default:throw new Error("unknown block style")}case"monster":switch(e.config.which){case"skiHead":return{aabb:{...b,z:21}};case"bubbleRobot":case"cyberman":case"elephant":case"emperorsGuardian":case"monkey":case"computerBot":return{aabb:$};case"helicopterBug":case"dalek":return{aabb:b};default:return{aabb:T}}case"deadlyBlock":switch(e.config.style){case"toaster":return{aabb:{...T,y:T.y}};case"spikes":case"volcano":return{aabb:T}}break;case"bubbles":return{aabb:b};case"conveyor":case"hushPuppy":case"teleporter":return{aabb:T};case"barrier":return{aabb:e.config.axis==="y"?{x:3,y:15,z:n.h}:{x:15,y:3,z:n.h}};case"wall":return e.config.side==="left"||e.config.side==="right"?{aabb:G,renderAabb:ve}:{aabb:Y,renderAabb:we};case"sceneryPlayer":return e.config.which==="headOverHeels"?{aabb:$}:{aabb:b};default:return{aabb:be}}},d={renders:!0,aabb:b};function*st(e){for(let t=e.size.y-1;t>=0;t--){const s=e.walls.left[t];s!=="none"&&(yield{...d,type:"wall",id:`wall-left-${t}`,config:{side:"left",style:s},state:{position:{...c({x:e.size.x,y:t,z:0}),z:0},expires:null,stoodOnBy:x,disappear:null},aabb:G,renderAabb:ve}),Object.values(e.items).find(a=>a.type==="door"&&X(a.config.direction)==="y"&&a.position.x===0&&(a.position.y===t||a.position.y+1===t))!==void 0||(yield{...d,type:"wall",id:`wall-right-${t}`,config:{side:"right",style:"none"},shadowCastTexture:"shadow.wall.y",state:{position:c({x:-W,y:t,z:0}),expires:null,stoodOnBy:x,disappear:null},aabb:G,renders:!1})}for(let t=e.size.x-1;t>=0;t--){const s=e.walls.away[t];s!=="none"&&(yield{...d,type:"wall",id:`wall-away-${t}`,config:{side:"away",style:s},state:{position:{...c({x:t,y:e.size.y,z:0}),z:0},expires:null,stoodOnBy:x,disappear:null},aabb:Y,renderAabb:we}),Object.values(e.items).find(a=>a.type==="door"&&X(a.config.direction)==="x"&&(a.position.x===t||a.position.x+1===t)&&a.position.y===0)!==void 0||(yield{...d,type:"wall",id:`wall-towards-${t}`,config:{side:"towards",style:"none"},shadowCastTexture:{texture:"shadow.wall.y",flipX:!0},state:{position:c({x:t,y:-W,z:0}),expires:null,stoodOnBy:x,disappear:null},aabb:Y,renders:!1})}}const ot=({config:{direction:e},position:t})=>e==="right"&&t.x===0||e==="towards"&&t.y===0,U=n.h*2,at=4,S=n.h*4;function*it(e,t){const{config:{direction:s},position:o}=e,a=X(s),i=Ae(a),r=ot(e),l={...y,[i]:r?-.5:0};yield{...e,...d,type:"doorFrame",id:`${t}/far`,config:{...e.config,inHiddenWall:r,part:"far"},state:{position:c(p(o,{[a]:1.5},l)),expires:null,stoodOnBy:x,disappear:null},aabb:{x:8,y:8,z:S}};const h=c(p(o,l));yield{...e,...d,type:"doorFrame",id:`${t}/near`,config:{...e.config,inHiddenWall:r,part:"near"},state:{position:h,expires:null,stoodOnBy:x,disappear:null},aabb:{[a]:9,[i]:8,z:S}},yield{...e,...d,type:"doorFrame",id:`${t}/top`,config:{...e.config,inHiddenWall:r,part:"top"},state:{position:p(c(p(o,l)),{[a]:9,z:U}),expires:null,stoodOnBy:x,disappear:null},aabb:{[a]:2*n.w-8-9,[i]:8,z:S-U}},yield{...e,...d,id:`${t}/wall`,config:{style:"none",side:"away"},renders:!1,type:"wall",state:{position:p(c(p(o,l)),{z:S}),expires:null,stoodOnBy:x,disappear:null},aabb:c({[a]:2,[i]:.5,z:L-at})},yield{...e,...d,type:"portal",id:`${t}/portal`,config:{...e.config,inHiddenWall:r,relativePoint:c({...y,[i]:r?.25:-.25}),direction:k[s]},renders:!1,state:{position:c(p(o,{[a]:.5},{[i]:r?-.5:.5})),expires:null,stoodOnBy:x,disappear:null},aabb:{[a]:n.w,[i]:0,z:U}},o.z!==0&&(yield{...e,...d,type:"doorLegs",id:`${t}/legs`,config:{...e.config,inHiddenWall:r,style:"none",side:"away",height:o.z},renders:!0,shadowCastTexture:r?"shadow.door.floatingThreshold.double.y":void 0,shadowMask:{spriteOptions:{texture:r?"shadowMask.door.floatingThreshold.double.y":"shadowMask.door.legs.threshold.double.y",flipX:a==="x"},relativeTo:"top"},state:{position:p({...c(p(o,l)),z:0}),expires:null,stoodOnBy:new Set,disappear:null},aabb:c({[a]:2,[i]:.5,z:o.z})}),yield{type:"stopAutowalk",id:`${t}/stopAutowalk`,renders:!1,aabb:c({[a]:2,[i]:0,z:2}),config:{},state:{position:c(_(o,F(k[s],.75))),expires:null,stoodOnBy:x,disappear:null}}}const K=e=>{const t=c(e.position),{aabb:s}=xe(e);if(s===void 0)throw new Error(`item type= ${e.type} config=${JSON.stringify(e.config)} has no bounding box`);return e.type==="wall"?t:p(t,{x:n.w-s.x>>1,y:n.d-s.y>>1})},N=()=>({expires:null,stoodOnBy:new Set,disappear:null}),I=()=>({standingOn:null,vels:{gravity:y,movingFloor:y},latentMovement:[]}),rt=e=>{const t=he.includes(e.type);return{...N(),position:K(e),...t?{standingOn:null,vels:{gravity:y,movingFloor:y,...pe.includes(e.type)?{sliding:y}:{},...(e.type==="monster"||e.type==="movableBlock")&&e.config.movement&&e.config.movement!=="free"?{walking:y}:{}},latentMovement:[]}:{},...e.type==="monster"?{activated:e.config.activated,timeOfLastDirectionChange:Number.NEGATIVE_INFINITY,...e.config.which==="skiHead"||e.config.which==="turtle"||e.config.which==="elephantHead"||e.config.which==="cyberman"?{facing:k[e.config.startDirection]}:{facing:k.towards}}:{},...e.type==="pickup"?{collected:!1,disappear:"onTouchByPlayer"}:{},...e.type==="movableBlock"&&e.config.movement!=="free"?{activated:e.config.activated===!0,facing:k[e.config.startDirection]}:{},...e.type==="switch"?{setting:"left",touchedOnProgression:-1}:{},...e.type==="block"?{disappear:e.config.disappearing??null}:{},...e.type==="conveyor"?{disappear:e.config.disappearing??null}:{},...e.type==="barrier"?{disappear:e.config.disappearing??null}:{},...e.type==="lift"?{direction:"up",vels:{lift:y}}:{},...e.type==="charles"?{facing:k.towards}:{}}},V={config:de,shadowCastTexture:"shadow.smallRound",aabb:be},R=()=>({action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:k.towards,walkDistance:0,vels:{walking:y,gravity:y,movingFloor:y}}),nt=e=>{const{infiniteLivesPoke:t}=J.getState().userSettings;return e.config.which==="head"?{id:"head",type:"head",...d,...V,state:{...N(),...I(),...R(),hasHooter:!1,totalWalkDistance:0,fastStepsStartedAtDistance:Number.NEGATIVE_INFINITY,lives:t?Number.POSITIVE_INFINITY:re,shieldCollectedAt:Number.NEGATIVE_INFINITY,doughnuts:0,doughnutLastFireTime:Number.NEGATIVE_INFINITY,switchedToAt:Number.NEGATIVE_INFINITY,position:K(e),gameTime:0,actedOnAt:Number.NEGATIVE_INFINITY}}:{id:"heels",type:"heels",...d,...V,state:{...N(),...I(),...R(),carrying:null,hasBag:!1,bigJumps:0,lives:t?Number.POSITIVE_INFINITY:re,shieldCollectedAt:Number.NEGATIVE_INFINITY,switchedToAt:Number.NEGATIVE_INFINITY,position:K(e),gameTime:0,actedOnAt:Number.NEGATIVE_INFINITY}}};function*ke(e,t,s,o={}){if(!s[e]&&!(t.type==="pickup"&&t.config.gives==="scroll"&&o[t.config.page]))switch(t.type){case"door":return yield*it(t,e);case"player":{yield nt(t);return}default:yield{...t,...d,...xe(t),renders:!(t.type==="wall"&&(t.config.side==="right"||t.config.side==="towards")),shadowMask:lt(t),shadowCastTexture:ct(t),id:e,config:t.config,state:rt(t)}}}const lt=e=>{switch(e.type){case"lift":return{spriteOptions:"shadowMask.smallBlock",relativeTo:"origin"};case"conveyor":return{spriteOptions:{texture:"shadowMask.conveyor",flipX:ue(e.config.direction)==="x"},relativeTo:"origin"};case"barrier":return{spriteOptions:{texture:"shadowMask.barrier.y",flipX:e.config.axis==="x"},relativeTo:"origin"};case"spring":return{spriteOptions:"shadowMask.smallRound",relativeTo:"origin"};case"block":return{spriteOptions:e.config.style==="tower"?"shadowMask.tower":"shadowMask.fullBlock",relativeTo:"origin"};case"movableBlock":return{spriteOptions:e.config.style==="stepStool"?"shadowMask.stepStool":"shadowMask.fullBlock",relativeTo:"origin"};case"teleporter":return{spriteOptions:"shadowMask.teleporter",relativeTo:"origin"};case"hushPuppy":return{spriteOptions:"shadowMask.hushPuppy",relativeTo:"origin"};case"portableBlock":return{spriteOptions:e.config.style==="drum"?"shadowMask.smallRound":"shadowMask.smallBlock",relativeTo:"origin"};case"slidingBlock":return{spriteOptions:e.config.style==="book"?"shadowMask.fullBlock":"shadowMask.smallRound",relativeTo:"origin"};case"deadlyBlock":switch(e.config.style){case"volcano":return{spriteOptions:"shadowMask.volcano",relativeTo:"origin"};case"toaster":return{spriteOptions:"shadowMask.fullBlock",relativeTo:"origin"};case"spikes":return{spriteOptions:"shadowMask.spikes",relativeTo:"origin"};default:e.config.style}break;case"switch":return{spriteOptions:"shadowMask.switch",relativeTo:"origin"};case"pickup":return e.config.gives==="scroll"?{spriteOptions:"shadowMask.scroll",relativeTo:"origin"}:void 0;case"slidingDeadly":return{spriteOptions:"shadowMask.smallRound",relativeTo:"origin"};case"monster":switch(e.config.which){case"dalek":return{spriteOptions:"shadowMask.dalek",relativeTo:"origin"};default:return}case"joystick":return{spriteOptions:"shadowMask.joystick",relativeTo:"origin"}}},ct=e=>{switch(e.type){case"lift":return"shadow.smallBlock";case"conveyor":return{texture:"shadow.fullBlock",flipX:ue(e.config.direction)==="x"};case"barrier":return{texture:"shadow.barrier.y",flipX:e.config.axis==="x"};case"spring":return"shadow.smallRound";case"block":return e.config.style==="tower"?"shadow.smallRound":"shadow.fullBlock";case"movableBlock":case"hushPuppy":case"deadlyBlock":return"shadow.fullBlock";case"portableBlock":return e.config.style==="drum"?"shadow.smallRound":"shadow.smallBlock";case"pickup":return e.config.gives==="scroll"?"shadow.scroll":"shadow.smallRound";case"monster":return"shadow.smallRound"}},dt=({aabb:e,state:{position:t}},{aabb:s,state:{position:o}})=>!(t.x+e.x<=o.x||t.x>=o.x+s.x)&&!(t.y+e.y<=o.y||t.y>=o.y+s.y)&&!(t.z+e.z<=o.z||t.z>=o.z+s.z),me=(e,t)=>[...z(t).filter(s=>e.id!==s.id&&dt(e,s))],ut=e=>{const t={},s=Object.values(e.items).filter(o=>o.type==="door");for(const{config:{direction:o},position:{x:a,y:i}}of s)X(o)==="x"?i===0?t.towards=!0:i===e.size.y&&(t.away=!0):a===0?t.right=!0:a===e.size.x&&(t.left=!0);return t},Te=e=>{const t=ut(e),s=t.right?-.5:0,o=e.size.x+(t.left?.5:0),a=t.towards?-.5:0,i=e.size.y+(t.away?.5:0);return{blockXMin:s,blockXMax:o,blockYMin:a,blockYMax:i,sidesWithDoors:t}},ss=e=>{const{blockXMax:t,blockXMin:s,blockYMax:o,blockYMin:a,sidesWithDoors:i}=Te(e),r=A({x:e.size.x+(i.right?.5:0),y:-a}).x,l=A({x:-s,y:e.size.y+(i.towards?.5:0)}).x,h=A({x:e.size.x,y:e.size.y}).y,v=A({x:s,y:a}),g=A({x:t,y:o});return{blockXMin:s,blockXMax:t,blockYMin:a,blockYMax:o,edgeLeftX:r,edgeRightX:l,topEdgeY:h,frontSide:v,backSide:g,sidesWithDoors:i}};function*pt(e){const t=e.size.z??L,s=c({...e.size,z:1}),{blockXMax:o,blockXMin:a,blockYMax:i,blockYMin:r}=Te(e),l=c({x:o-a,y:i-r,z:1}),h=c({...Pe,z:-1}),v=c({x:a,y:r,z:-1});if(yield{id:"floorEdge",...d,type:"floorEdge",state:{...N(),position:{...v,z:0}},aabb:y,config:{},fixedZIndex:9999},e.floor==="none"&&e.roomBelow!==void 0?(yield{...d,type:"floor",id:"floor",config:{type:"none"},aabb:s,shadowMask:void 0,state:{position:v,expires:null,stoodOnBy:new Set,disappear:null},renders:!0,fixedZIndex:-1},yield{...d,type:"portal",id:"floor/portal",config:{toRoom:e.roomBelow,relativePoint:{x:s.x/2,y:s.y/2,z:s.z},direction:k.down},aabb:s,state:{position:h,expires:null,stoodOnBy:new Set,disappear:null},renders:!1}):yield{...d,type:"floor",id:"floor",config:{type:e.floor==="deadly"?"deadly":"standable"},aabb:l,shadowMask:{relativeTo:"origin"},state:{position:v,expires:null,stoodOnBy:new Set,disappear:null},renders:!0,fixedZIndex:-1},e.roomAbove!==void 0){const g=p(h,{z:n.h*t});yield{...d,type:"portal",id:"ceiling",config:{toRoom:e.roomAbove,relativePoint:{x:s.x/2,y:s.y/2,z:-n.h},direction:k.up},aabb:s,state:{position:g,expires:null,stoodOnBy:new Set,disappear:null},renders:!1}}}function*ht(e,t,s){const{scrollsRead:o}=J.getState(),a=Be(e.items);for(const[i,r]of a)r.type==="player"&&!s||(yield*ke(i,r,t,o))}const Q=e=>z(e).reduce((t,s)=>({...t,[s.id]:s}),{}),yt=(e,t,s=!1)=>{const o={...Q(pt(e)),...Q(st(e)),...Q(ht(e,t,s))};for(const i of O(o)){const l=me(i,O(o)).find(h=>ie(i)&&ie(h)&&!(i.type==="wall"&&h.type==="wall"));if(l!==void 0)throw new Error(`item ${i.id} @${JSON.stringify(i.state.position)} #${JSON.stringify(i.aabb)} is colliding with (solid item) ${l.id} @${JSON.stringify(l.state.position)} #${JSON.stringify(l.aabb)} on loading room ${e.id}`)}return{...e,roomJson:e,items:{...o},roomTime:0}},ft=({state:{position:e,facing:t,autoWalk:s,action:o,vels:a}})=>({position:e,facing:t,autoWalk:s,action:o,vels:{...a}}),ne=e=>{e.state.standingOn!==null&&e.state.standingOn.state.stoodOnBy.delete(e),e.state.standingOn=null},bt=({above:e,below:t})=>{e.state.standingOn=t,t.state.stoodOnBy.add(e)},B=({room:e,item:t})=>{const s=typeof t=="string"?e.items[t]:t;typeof t=="string"?delete e.items[t]:delete e.items[s.id],Ve(s)&&ne(s);for(const o of s.state.stoodOnBy)ne(o)};let gt=0;const wt=({gameState:e,room:t,itemType:s,config:o,position:a})=>{const i={type:s,config:o,position:y},r=`${s}/${gt++}`,l=$e(ke(r,i,e.pickupsCollected[t.id]));if(l===void 0)throw new Error("failed to generate any items");return l.state.position=a,q({room:t,item:l}),l},q=({room:e,item:t})=>(e.items[t.id]=t,t),vt=1e3/25,Oe=e=>{const t=Me.animations[e],s=t.length,{animationSpeed:o}=t;return s*vt/o};Oe("bubbles.white");const xt=Oe("head.fadeOut"),kt=({touchedItem:e,room:t,gameState:s})=>{B({room:t,item:e});const o=wt({itemType:"bubbles",config:{style:"white"},position:y,room:t,gameState:s}),a=p(e.state.position,F(e.aabb,.5));o.state.position=_(a,F(o.aabb,.5)),o.state.expires=t.roomTime+xt},mt=(e,t)=>{const s=z(O(e.items)).filter(f("hushPuppy"));for(const o of s)kt({touchedItem:o,gameState:t,room:e})},Tt=(e,t,{changeType:s,sourceItem:o})=>{switch(s){case"portal":return z(O(e.items)).find(a=>M(a)&&a.config.toRoom===t.id&&Ie(F(o.config.direction,-1),a.config.direction));case"level-select":return z(O(e.items)).find(a=>M(a)&&a.config.toRoom===t.id&&a.config.direction.z===0)??z(O(e.items)).find(a=>M(a)&&a.config.direction.z===0)??z(O(e.items)).find(M)}},os=e=>{const{playableItem:t,gameState:s,toRoomId:o,changeType:a,sourceItem:i}=e,r=s.characterRooms[t.id];if(r===void 0)throw new Error(`${t.id} is not in a room on the gameState`);if(o===r.id)throw new Error(`Can't move ${t.id} to the same room "${o}""`);let l;switch(a){case"portal":{const{config:{relativePoint:w},state:{position:E}}=i;l=_(t.state.position,p(E,w));break}case"teleport":{const{state:{position:w}}=i;l=_(t.state.position,w);break}case"level-select":l={x:0,y:0,z:0};break;default:throw new Error("unknown changeType"+a)}const h=t.type==="headOverHeels"?void 0:s.characterRooms[P(t.id)],v=s.campaign.rooms[o];if(v===void 0)throw new Error(`room ${o} does not exist in campaign`);const g=h?.id===o?h:yt(v,s.pickupsCollected[o]);if(B({room:r,item:t}),e.changeType==="teleport"){const{config:{toPosition:w}}=e.sourceItem;t.state.position=p(c(w),l)}else{const w=Tt(g,r,e);if(console.log("putting",t.id,"into",o,"at portal",w,"because",a,"sourceportal",i),w===void 0)if(e.changeType==="level-select")t.state.position=c({x:1,y:1,z:8});else throw new Error(`trying to move ${t.id} from ${r.id} --to-> ${o} but no destination portal found to locate with`);else{t.state.position=p(w.state.position,w.config.relativePoint,l,a==="portal"&&i.config.direction.z>0?{z:n.h}:{});const{config:{direction:E}}=w;if(E.z===0){const ze=E;t.state.autoWalk=!0,t.state.facing=F(ze,-1),t.state.action==="idle"&&(t.state.action="moving")}}}console.log(t,"is now stood on by",[...t.state.stoodOnBy]);const j=Ze(t);j!==void 0&&(j.carrying=null),(t.type==="head"||t.type==="headOverHeels")&&mt(g,s),B({room:g,item:t}),g.items[t.id]=t;const ee=me(t,O(g.items));ee.length>0&&console.warn("on entering room",o,"character",t.id,"at",t.state.position,"collides with",ee),s.characterRooms[t.id]=g,s.entryState[t.id]=ft(t),t.id==="headOverHeels"?(delete s.entryState.head,delete s.entryState.heels):(s.entryState[P(t.id)]||(s.entryState[P(t.id)]=s.entryState.headOverHeels),delete s.entryState.headOverHeels),J.dispatch(Fe(o))},Ot=e=>{const t=m(e,"head"),s=m(e,"heels");return t!==void 0&&s!==void 0&&t.state.action==="idle"&&s.state.action==="idle"&&t.state.standingOn===s},zt=e=>{const t={id:"head",type:"head",...d,...V,state:{...N(),...I(),...R(),...e.state.head,facing:e.state.facing,position:p(e.state.position,{z:n.h}),switchedToAt:Number.NEGATIVE_INFINITY,actedOnAt:e.state.actedOnAt}},s={id:"heels",type:"heels",...d,...V,state:{...N(),...I(),...R(),...e.state.heels,facing:e.state.facing,position:p(e.state.position),switchedToAt:Number.NEGATIVE_INFINITY,actedOnAt:e.state.actedOnAt}};return{head:t,heels:s}},Nt=({head:e,heels:t})=>({type:"headOverHeels",id:"headOverHeels",...d,shadowCastTexture:t.shadowCastTexture,config:de,aabb:$,state:{...N(),...I(),...R(),position:t.state.position,action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:t.state.facing,actedOnAt:Math.max(t.state.actedOnAt,t.state.actedOnAt),head:{...te(e.state,"hasHooter","doughnuts","doughnutLastFireTime","fastStepsStartedAtDistance","totalWalkDistance","lives","gameTime","shieldCollectedAt"),switchedToAt:Number.NEGATIVE_INFINITY},heels:{...te(t.state,"hasBag","bigJumps","carrying","lives","gameTime","shieldCollectedAt"),switchedToAt:Number.NEGATIVE_INFINITY}}}),At=e=>{const t=e.characterRooms.head,s=m(e,"head"),o=m(e,"heels"),a=Nt({head:s,heels:o});B({room:t,item:"head"}),B({room:t,item:"heels"}),q({room:t,item:a}),e.previousPlayable=e.currentCharacterName,e.currentCharacterName="headOverHeels",e.characterRooms={head:void 0,heels:void 0,headOverHeels:t}},Pt=e=>{const t=e.characterRooms.headOverHeels,s=m(e,"headOverHeels"),o=P(e.previousPlayable),{head:a,heels:i}=zt(s);B({room:t,item:"headOverHeels"}),q({room:t,item:a}),q({room:t,item:i}),bt({above:a,below:i}),e.currentCharacterName=o,e.previousPlayable=void 0,e.characterRooms={head:t,heels:t,headOverHeels:void 0}},Bt=e=>{const t=m(e,e.currentCharacterName);t!==void 0&&(t.type==="headOverHeels"?(t.state.head.switchedToAt=t.state.head.gameTime,t.state.heels.switchedToAt=t.state.heels.gameTime):t.state.switchedToAt=t?.state.gameTime)},as=e=>{if(Ot(e))At(e);else if(e.currentCharacterName==="headOverHeels")Pt(e);else{if(m(e,P(e.currentCharacterName))===void 0)return;e.currentCharacterName=P(e.currentCharacterName)}Bt(e)};export{as as $,Lt as A,xt as B,Ze as C,Wt as D,Ge as E,Ht as F,Xt as G,vt as H,dt as I,bt as J,kt as K,pe as L,me as M,Rt as N,ne as O,Kt as P,Et as Q,B as R,d as S,q as T,Ct as U,St as V,$t as W,_t as X,zt as Y,Nt as Z,mt as _,Ve as a,Je as a0,A as a1,ss as a2,Gt as a3,Qe as a4,ts as a5,At as b,os as c,m as d,Dt as e,wt as f,n as g,ft as h,f as i,es as j,Xe as k,yt as l,Yt as m,Ot as n,P as o,ie as p,je as q,jt as r,It as s,et as t,Jt as u,Ut as v,Qt as w,Zt as x,Vt as y,qt as z};
