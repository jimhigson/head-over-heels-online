const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-CSTHyw9H.js","assets/index-Ctar_Tmj.js","assets/index-B1uLVQQF.css","assets/colorToUniform-CsjpEFI9.js","assets/SharedSystems-L-KdTHxr.js","assets/Graphics-CGytQxUt.js","assets/WebGLRenderer-RhtZYpPU.js"])))=>i.map(i=>d[i]);
import{a4 as Br,a5 as Nt,a6 as Bt,a7 as Lt,a8 as Lr,a9 as Xt,u as Xr,y as Ur,z as et,e as tt,E as ce,c as Hr,C as k,d as Ce,v as _e,Y as O,D as Ve,aa as ht,K as rt,a as ae,b as fe,U as Wr,V as Vr,ab as Gr,ac as jr,ad as Yr,ae as ke,af as qr,ag as te,ah as Zr,ai as Ut,aj as V,ak as W,al as Ht,am as Kr,an as Jr,ao as Qr,ap as en,aq as Wt,ar as N,as as tn,at as rn,au as G}from"./index-Ctar_Tmj.js";import{S as nn,G as ee}from"./Graphics-CGytQxUt.js";var Me={};function Vt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return typeof e=="number"&&!isNaN(e)&&isFinite(e)&&!(t&&e===0)}Me.isInteger=Vt;function sn(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return Vt(e)&&(t?e>0:e>=0)}Me.isPositiveInteger=sn;function on(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return typeof e=="number"&&!isNaN(e)&&!(t&&e===0)}Me.isIntegerOrInfinite=on;var Gt={exports:{}},jt={exports:{}};(function(e){function t(r){if(Array.isArray(r))return r}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports})(jt);var an=jt.exports,Yt={exports:{}};(function(e){function t(r,n){var s=r==null?null:typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(s!=null){var o,i,a,l,c=[],d=!0,f=!1;try{if(a=(s=s.call(r)).next,n===0){if(Object(s)!==s)return;d=!1}else for(;!(d=(o=a.call(s)).done)&&(c.push(o.value),c.length!==n);d=!0);}catch(p){f=!0,i=p}finally{try{if(!d&&s.return!=null&&(l=s.return(),Object(l)!==l))return}finally{if(f)throw i}}return c}}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports})(Yt);var ln=Yt.exports,qt={exports:{}};(function(e){function t(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports})(qt);var cn=qt.exports;(function(e){var t=an,r=ln,n=Br,s=cn;function o(i,a){return t(i)||r(i,a)||n(i,a)||s()}e.exports=o,e.exports.__esModule=!0,e.exports.default=e.exports})(Gt);var dn=Gt.exports,Zt={},un=Nt;function hn(e){return un(e)==="object"&&e!==null}Zt.isObject=hn;var nt={},fn=Nt,Ge=Bt,pn=Ge.mark(st),yn=Lt,gn=yn.wrapWithIterableIterator,xn=Object.prototype.hasOwnProperty;function st(e){var t;return Ge.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(e!=null){n.next=2;break}return n.abrupt("return");case 2:n.t0=Ge.keys(e);case 3:if((n.t1=n.t0()).done){n.next=10;break}if(t=n.t1.value,!xn.call(e,t)){n.next=8;break}return n.next=8,e[t];case 8:n.next=3;break;case 10:case"end":return n.stop()}},pn)}nt.__objectValues=st;var mn=gn(st,{validateArgs:function(t){if(!(t[0]==null||fn(t[0])==="object"))throw new Error("obj argument to objectValues must be an object, null, or undefined")}});nt.objectValues=mn;var ot={},bn=dn,Kt=Bt,wn=Kt.mark(it),vn=Lt,Cn=vn.wrapWithIterableIterator,Jt=Me,ft=Jt.isInteger,_n=Jt.isIntegerOrInfinite,kn=Zt,Tn=kn.isObject,On=Lr,Be=On.notUndefined;function it(){var e,t,r,n,s=arguments;return Kt.wrap(function(i){for(;;)switch(i.prev=i.next){case 0:e=s.length>0&&s[0]!==void 0?s[0]:0,t=s.length>1&&s[1]!==void 0?s[1]:1/0,r=s.length>2&&s[2]!==void 0?s[2]:1,n=e;case 4:if(!(r>0?n<t:n>t)){i.next=10;break}return i.next=7,n;case 7:n+=r,i.next=4;break;case 10:case"end":return i.stop()}},wn)}ot.__range=it;var zn=Cn(it,{growRight:!0,validateArgs:function(t){var r=bn(t,3),n=r[0],s=r[1],o=s===void 0?1/0:s,i=r[2],a;if(Tn(n)?(a=n.start,o=n.end,i=n.step):t.length>1?a=n:o=n,Be(a)&&!ft(a))throw new TypeError("The specified start was not an integer");if(Be(o)&&!_n(o))throw new TypeError("The specified end was not an integer or infinite");if(Be(i)&&!ft(i,!0))throw new TypeError("The specified step was not a non-zero integer");t[0]=a,t[1]=o,t[2]=i}});ot.range=zn;var An=nt.objectValues;const w=Xt(An);var Pn=ot.range;const Sn=Xt(Pn),Qt=class je extends Xr{constructor(t){t={...je.defaultOptions,...t},super(t),this.enabled=!0,this._state=nn.for2d(),this.blendMode=t.blendMode,this.padding=t.padding,typeof t.antialias=="boolean"?this.antialias=t.antialias?"on":"off":this.antialias=t.antialias,this.resolution=t.resolution,this.blendRequired=t.blendRequired,this.addResource("uTexture",0,1)}apply(t,r,n,s){t.applyFilter(this,r,n,s)}get blendMode(){return this._state.blendMode}set blendMode(t){this._state.blendMode=t}static from(t){const{gpu:r,gl:n,...s}=t;let o,i;return r&&(o=Ur.from(r)),n&&(i=et.from(n)),new je({gpuProgram:o,glProgram:i,...s})}};Qt.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1};let er=Qt;const Ye=[];tt.handleByNamedList(ce.Environment,Ye);async function $n(e){if(!e)for(let t=0;t<Ye.length;t++){const r=Ye[t];if(r.value.test()){await r.value.load();return}}}let se;function Fn(){if(typeof se=="boolean")return se;try{se=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{se=!1}return se}var tr=(e=>(e[e.NONE=0]="NONE",e[e.COLOR=16384]="COLOR",e[e.STENCIL=1024]="STENCIL",e[e.DEPTH=256]="DEPTH",e[e.COLOR_DEPTH=16640]="COLOR_DEPTH",e[e.COLOR_STENCIL=17408]="COLOR_STENCIL",e[e.DEPTH_STENCIL=1280]="DEPTH_STENCIL",e[e.ALL=17664]="ALL",e))(tr||{});class Mn{constructor(t){this.items=[],this._name=t}emit(t,r,n,s,o,i,a,l){const{name:c,items:d}=this;for(let f=0,p=d.length;f<p;f++)d[f][c](t,r,n,s,o,i,a,l);return this}add(t){return t[this._name]&&(this.remove(t),this.items.push(t)),this}remove(t){const r=this.items.indexOf(t);return r!==-1&&this.items.splice(r,1),this}contains(t){return this.items.indexOf(t)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const Rn=["init","destroy","contextChange","resolutionChange","reset","renderEnd","renderStart","render","update","postrender","prerender"],rr=class nr extends Hr{constructor(t){super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=t.type,this.name=t.name,this.config=t;const r=[...Rn,...this.config.runners??[]];this._addRunners(...r),this._unsafeEvalCheck()}async init(t={}){const r=t.skipExtensionImports===!0?!0:t.manageImports===!1;await $n(r),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const n in this._systemsHash)t={...this._systemsHash[n].constructor.defaultOptions,...t};t={...nr.defaultOptions,...t},this._roundPixels=t.roundPixels?1:0;for(let n=0;n<this.runners.init.items.length;n++)await this.runners.init.items[n].init(t);this._initOptions=t}render(t,r){let n=t;if(n instanceof k&&(n={container:n},r&&(Ce(_e,"passing a second argument is deprecated, please use render options instead"),n.target=r.renderTexture)),n.target||(n.target=this.view.renderTarget),n.target===this.view.renderTarget&&(this._lastObjectRendered=n.container,n.clearColor=this.background.colorRgba),n.clearColor){const s=Array.isArray(n.clearColor)&&n.clearColor.length===4;n.clearColor=s?n.clearColor:O.shared.setValue(n.clearColor).toArray()}n.transform||(n.container.updateLocalTransform(),n.transform=n.container.localTransform),this.runners.prerender.emit(n),this.runners.renderStart.emit(n),this.runners.render.emit(n),this.runners.renderEnd.emit(n),this.runners.postrender.emit(n)}resize(t,r,n){const s=this.view.resolution;this.view.resize(t,r,n),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),n!==void 0&&n!==s&&this.runners.resolutionChange.emit(n)}clear(t={}){const r=this;t.target||(t.target=r.renderTarget.renderTarget),t.clearColor||(t.clearColor=this.background.colorRgba),t.clear??(t.clear=tr.ALL);const{clear:n,clearColor:s,target:o}=t;O.shared.setValue(s??this.background.colorRgba),r.renderTarget.clear(o,n,O.shared.toArray())}get resolution(){return this.view.resolution}set resolution(t){this.view.resolution=t,this.runners.resolutionChange.emit(t)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...t){t.forEach(r=>{this.runners[r]=new Mn(r)})}_addSystems(t){let r;for(r in t){const n=t[r];this._addSystem(n.value,n.name)}}_addSystem(t,r){const n=new t(this);if(this[r])throw new Error(`Whoops! The name "${r}" is already in use`);this[r]=n,this._systemsHash[r]=n;for(const s in this.runners)this.runners[s].add(n);return this}_addPipes(t,r){const n=r.reduce((s,o)=>(s[o.name]=o.value,s),{});t.forEach(s=>{const o=s.value,i=s.name,a=n[i];this.renderPipes[i]=new o(this,a?new a:null)})}destroy(t=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(t),Object.values(this.runners).forEach(r=>{r.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(t){return this.textureGenerator.generateTexture(t)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!Fn())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}};rr.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let sr=rr,pe;function En(e){return pe!==void 0||(pe=(()=>{const t={stencil:!0,failIfMajorPerformanceCaveat:e??sr.defaultOptions.failIfMajorPerformanceCaveat};try{if(!Ve.get().getWebGLRenderingContext())return!1;let n=Ve.get().createCanvas().getContext("webgl",t);const s=!!n?.getContextAttributes()?.stencil;if(n){const o=n.getExtension("WEBGL_lose_context");o&&o.loseContext()}return n=null,s}catch{return!1}})()),pe}let ye;async function Dn(e={}){return ye!==void 0||(ye=await(async()=>{const t=Ve.get().getNavigator().gpu;if(!t)return!1;try{return await(await t.requestAdapter(e)).requestDevice(),!0}catch{return!1}})()),ye}const pt=["webgl","webgpu","canvas"];async function In(e){let t=[];e.preference?(t.push(e.preference),pt.forEach(o=>{o!==e.preference&&t.push(o)})):t=pt.slice();let r,n={};for(let o=0;o<t.length;o++){const i=t[o];if(i==="webgpu"&&await Dn()){const{WebGPURenderer:a}=await ht(async()=>{const{WebGPURenderer:l}=await import("./WebGPURenderer-CSTHyw9H.js");return{WebGPURenderer:l}},__vite__mapDeps([0,1,2,3,4,5]));r=a,n={...e,...e.webgpu};break}else if(i==="webgl"&&En(e.failIfMajorPerformanceCaveat??sr.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:a}=await ht(async()=>{const{WebGLRenderer:l}=await import("./WebGLRenderer-RhtZYpPU.js");return{WebGLRenderer:l}},__vite__mapDeps([6,1,2,3,4,5]));r=a,n={...e,...e.webgl};break}else if(i==="canvas")throw n={...e},new Error("CanvasRenderer is not yet implemented")}if(delete n.webgpu,delete n.webgl,!r)throw new Error("No available renderer for the current environment");const s=new r;return await s.init(n),s}const or="8.4.1";class ir{static init(){globalThis.__PIXI_APP_INIT__?.(this,or)}static destroy(){}}ir.extension=ce.Application;class Nn{constructor(t){this._renderer=t}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,or)}destroy(){this._renderer=null}}Nn.extension={type:[ce.WebGLSystem,ce.WebGPUSystem],name:"initHook",priority:-10};const ar=class qe{constructor(...t){this.stage=new k,t[0]!==void 0&&Ce(_e,"Application constructor options are deprecated, please use Application.init() instead.")}async init(t){t={...t},this.renderer=await In(t),qe._plugins.forEach(r=>{r.init.call(this,t)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return Ce(_e,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(t=!1,r=!1){const n=qe._plugins.slice(0);n.reverse(),n.forEach(s=>{s.destroy.call(this)}),this.stage.destroy(r),this.stage=null,this.renderer.destroy(t),this.renderer=null}};ar._plugins=[];let lr=ar;tt.handleByList(ce.Application,lr._plugins);tt.add(ir);class Te extends rt{constructor(...t){let r=t[0];Array.isArray(t[0])&&(r={textures:t[0],autoUpdate:t[1]});const{textures:n,autoUpdate:s,...o}=r,[i]=n;super({...o,texture:i instanceof ae?i:i.texture}),this._textures=null,this._durations=null,this._autoUpdate=s??!0,this._isConnectedToTicker=!1,this.animationSpeed=1,this.loop=!0,this.updateAnchor=!1,this.onComplete=null,this.onFrameChange=null,this.onLoop=null,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=n}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(fe.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(fe.shared.add(this.update,this,Wr.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(t){this.stop(),this.currentFrame=t}gotoAndPlay(t){this.currentFrame=t,this.play()}update(t){if(!this._playing)return;const r=t.deltaTime,n=this.animationSpeed*r,s=this.currentFrame;if(this._durations!==null){let o=this._currentTime%1*this._durations[this.currentFrame];for(o+=n/60*1e3;o<0;)this._currentTime--,o+=this._durations[this.currentFrame];const i=Math.sign(this.animationSpeed*r);for(this._currentTime=Math.floor(this._currentTime);o>=this._durations[this.currentFrame];)o-=this._durations[this.currentFrame]*i,this._currentTime+=i;this._currentTime+=o/this._durations[this.currentFrame]}else this._currentTime+=n;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):s!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<s||this.animationSpeed<0&&this.currentFrame>s)&&this.onLoop(),this._updateTexture())}_updateTexture(){const t=this.currentFrame;this._previousFrame!==t&&(this._previousFrame=t,this.texture=this._textures[t],this.updateAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(){this.stop(),super.destroy(),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(t){const r=[];for(let n=0;n<t.length;++n)r.push(ae.from(t[n]));return new Te(r)}static fromImages(t){const r=[];for(let n=0;n<t.length;++n)r.push(ae.from(t[n]));return new Te(r)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(t){if(t[0]instanceof ae)this._textures=t,this._durations=null;else{this._textures=[],this._durations=[];for(let r=0;r<t.length;r++)this._textures.push(t[r].texture),this._durations.push(t[r].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let t=Math.floor(this._currentTime)%this._textures.length;return t<0&&(t+=this._textures.length),t}set currentFrame(t){if(t<0||t>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${t}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const r=this.currentFrame;this._currentTime=t,r!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(t){t!==this._autoUpdate&&(this._autoUpdate=t,!this._autoUpdate&&this._isConnectedToTicker?(fe.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(fe.shared.add(this.update,this),this._isConnectedToTicker=!0))}}class Bn extends Vr{constructor(t,r){const{text:n,resolution:s,style:o,anchor:i,width:a,height:l,roundPixels:c,...d}=t;super({...d}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=r,this.text=n??"",this.style=o,this.resolution=s??null,this.allowChildren=!1,this._anchor=new Gr({_onUpdate:()=>{this.onViewUpdate()}}),i&&(this.anchor=i),this.roundPixels=c??!1,a!==void 0&&(this.width=a),l!==void 0&&(this.height=l)}get anchor(){return this._anchor}set anchor(t){typeof t=="number"?this._anchor.set(t):this._anchor.copyFrom(t)}set text(t){t=t.toString(),this._text!==t&&(this._text=t,this.onViewUpdate())}get text(){return this._text}set resolution(t){this._autoResolution=t===null,this._resolution=t,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(t){t=t||{},this._style?.off("update",this.onViewUpdate,this),t instanceof this._styleClass?this._style=t:this._style=new this._styleClass(t),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get bounds(){return this._boundsDirty&&(this._updateBounds(),this._boundsDirty=!1),this._bounds}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(t){this._setWidth(t,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(t){this._setHeight(t,this.bounds.height)}getSize(t){return t||(t={}),t.width=Math.abs(this.scale.x)*this.bounds.width,t.height=Math.abs(this.scale.y)*this.bounds.height,t}setSize(t,r){typeof t=="object"?(r=t.height??t.width,t=t.width):r??(r=t),t!==void 0&&this._setWidth(t,this.bounds.width),r!==void 0&&this._setHeight(r,this.bounds.height)}addBounds(t){const r=this.bounds;t.addFrame(r.minX,r.minY,r.maxX,r.maxY)}containsPoint(t){const r=this.bounds.width,n=this.bounds.height,s=-r*this.anchor.x;let o=0;return t.x>=s&&t.x<=s+r&&(o=-n*this.anchor.y,t.y>=o&&t.y<=o+n)}onViewUpdate(){if(this._didViewChangeTick++,this._boundsDirty=!0,this.didViewUpdate)return;this.didViewUpdate=!0,this._didTextUpdate=!0;const t=this.renderGroup||this.parentRenderGroup;t&&t.onChildViewUpdate(this)}_getKey(){return`${this.text}:${this._style.styleKey}:${this._resolution}`}destroy(t=!1){super.destroy(t),this.owner=null,this._bounds=null,this._anchor=null,(typeof t=="boolean"?t:t?.style)&&this._style.destroy(t),this._style=null,this._text=null}}function Ln(e,t){let r=e[0]??{};return(typeof r=="string"||e[1])&&(Ce(_e,`use new ${t}({ text: "hi!", style }) instead`),r={text:r,style:e[1]}),r}class Xn extends Bn{constructor(...t){const r=Ln(t,"Text");super(r,jr),this.renderPipeId="text"}_updateBounds(){const t=this._bounds,r=this._anchor,n=Yr.measureText(this._text,this._style),{width:s,height:o}=n;t.minX=-r._x*s,t.maxX=t.minX+s,t.minY=-r._y*o,t.maxY=t.minY+o}}const S=e=>e.characterRooms[e.currentCharacterName].room,Un=e=>e.characterRooms[e.currentCharacterName].room.items[e.currentCharacterName],Hn=(e,t)=>e.characterRooms[t]?.room.items[t],P={renders:!0},de=["away","towards","left","right"],at=e=>e==="away"||e==="towards"?"y":"x",cr=e=>e==="away"?"towards":e==="towards"?"away":e==="left"?"right":"left",j=e=>Re(at(e)),J={away:{x:0,y:1,z:0},left:{x:1,y:0,z:0},right:{x:-1,y:0,z:0},towards:{x:0,y:-1,z:0},down:{x:0,y:0,z:-1},up:{x:0,y:0,z:1}},Re=e=>e==="x"?"y":"x",we=(e,...t)=>t.reduce((r,n)=>({x:r.x+(n.x??0),y:r.y+(n.y??0)}),e),Q=(e,t)=>({x:e.x*t,y:e.y*t,z:e.z*t}),_=(e,...t)=>t.reduce((r,n)=>({x:r.x+(n.x??0),y:r.y+(n.y??0),z:r.z+(n.z??0)}),e),dr=(e,...t)=>t.reduce((r,n)=>({x:r.x-(n.x??0),y:r.y-(n.y??0),z:r.z-(n.z??0)}),e),Ee=({x:e,y:t,z:r},{x:n,y:s,z:o})=>e===n&&t===s&&r===o,Le=e=>Math.abs(e-Math.round(e))<.001,Wn=({x:e=0,y:t=0,z:r=0})=>Le(e)&&Le(t)&&Le(r),Vn=({x:e=0,y:t=0,z:r=0})=>Number.isInteger(e)&&Number.isInteger(t)&&Number.isInteger(r),Gn=({x:e,y:t,z:r})=>({x:Math.round(e),y:Math.round(t),z:Math.round(r)}),yt=Object.freeze({x:0,y:0}),U=Object.freeze({x:0,y:0,z:0}),ur=["x","y","z"],hr=(e,t)=>e.x*t.x+e.y*t.y+e.z*t.z,y={w:16,d:16,h:12},jn={near:{x:{x:15,y:57},y:{x:8,y:57}},far:{x:{x:8,y:52},y:{x:15,y:52}}},gt={x:{x:18,y:22},y:{x:6,y:22}},oe=(e,t)=>{const r=I(e);return t.x=r.x,t.y=r.y,t},fr=e=>Wn(e)?pr(e):C(e),pr=({x:e=0,y:t=0,z:r=0})=>({x:t-e,y:-(e+t>>1)-r}),C=({x:e=0,y:t=0,z:r=0})=>({x:t-e,y:-(e+t)/2-r}),A=({x:e=0,y:t=0,z:r=0})=>({x:e*y.w,y:t*y.d,z:r*y.h}),I=e=>fr(A(e)),yr={head:ke/1e3,heels:2*ke/1e3},gr=(e=1)=>e*ke/1e3,Yn=gr(),qn=2,ge={head:y.h*2.5,heels:y.h},xr=2e-4,Zn={head:-(y.h*2)/1e3,others:-(y.h*6)/1e3},Kn=gr(2),De=9,mr=2,q={x:12,y:12,z:y.h},xt={x:14,y:14,z:y.h},xe={x:16,y:16,z:y.h},mt={...q,z:y.h*2},br=50,Oe={x:y.w,y:0,z:De*y.h},wr={...Oe,z:br},ze={x:0,y:y.d,z:De*y.h},vr={...ze,z:br},ue=e=>{switch(e.type){case"spring":case"portable-block":case"pickup":case"player":return{aabb:q};case"lift":return{aabb:{...q,z:q.z-mr}};case"charles":return{aabb:mt};case"ball":case"switch":case"fish":return{aabb:xt};case"block":switch(e.config.style){case"artificial":case"organic":return{aabb:xe};case"tower":return{aabb:{x:11,y:11,z:y.h}};default:throw new Error("unknown block style")}case"baddie":switch(e.config.which){case"american-football-head":case"bubble-robot":case"cyberman":case"elephant":case"flying-ball":case"computer-bot":return{aabb:mt};case"helicopter-bug":case"dalek":return{aabb:q};default:return{aabb:xe}}case"deadly-block":switch(e.config.style){case"puck":return{aabb:q};default:return{aabb:xe}}case"book":case"conveyor":case"hush-puppy":case"teleporter":return{aabb:xe};case"barrier":return{aabb:e.config.axis==="y"?{x:3,y:15,z:y.h}:{x:15,y:3,z:y.h}};case"wall":return e.config.side==="left"||e.config.side==="right"?{aabb:ze,renderAabb:vr}:{aabb:Oe,renderAabb:wr};default:return console.warn("giving default aabb for item",e),{aabb:xt}}};function*Jn(e){for(let t=e.size.y-1;t>=0;t--){const r=e.walls.left[t];r!=="none"&&(yield{...P,type:"wall",id:`wall-left-${t}`,config:{side:"left",style:r},state:{position:A({x:e.size.x,y:t,z:0}),expires:null},aabb:ze,renderAabb:vr}),Object.values(e.items).find(s=>s.type==="door"&&j(s.config.direction)==="y"&&s.position.x===0&&(s.position.y===t||s.position.y+1===t))!==void 0||(yield{...P,type:"wall",id:`wall-right-${t}`,config:{side:"left",style:"none"},state:{position:A({x:0,y:t,z:0}),expires:null},aabb:ze,renders:!1})}for(let t=e.size.x-1;t>=0;t--){const r=e.walls.away[t];r!=="none"&&(yield{...P,type:"wall",id:`wall-away-${t}`,config:{side:"away",style:r},state:{position:A({x:t,y:e.size.y,z:0}),expires:null},aabb:Oe,renderAabb:wr}),Object.values(e.items).find(s=>s.type==="door"&&j(s.config.direction)==="x"&&(s.position.x===t||s.position.x+1===t)&&s.position.y===0)!==void 0||(yield{...P,type:"wall",id:`wall-towards-${t}`,config:{side:"towards",style:"none"},state:{position:A({x:t,y:0,z:0}),expires:null},aabb:Oe,renders:!1})}}const Qn=({config:{direction:e},position:t})=>e==="right"&&t.x===0||e==="towards"&&t.y===0,me=y.h*2,bt=y.h*4;function*es(e,t){const{config:{direction:r},position:n}=e,s=j(r),o=Re(s),i=Qn(e),a={...U,[o]:i?-.5:0};yield{...e,...P,type:"doorFrame",id:`${t}/far`,config:{...e.config,inHiddenWall:i,nearness:"far"},state:{position:A(_(n,{[s]:1.5},a)),expires:null},aabb:{x:8,y:8,z:me},renderAabb:{x:8,y:8,z:bt}};const l=A(_(n,a));yield{...e,...P,type:"doorFrame",id:`${t}/near`,config:{...e.config,inHiddenWall:i,nearness:"near"},state:{position:l,expires:null},aabb:{x:8,y:8,z:me},renderAabb:{x:8,y:8,z:bt}},yield{...e,...P,type:"portal",id:`${t}/portal`,config:{...e.config,inHiddenWall:i,relativePoint:A({...U,[o]:i?.25:-.25}),direction:r},renders:!1,state:{position:A(_(n,{[s]:.5},{[o]:i?-.5:.5})),expires:null},aabb:{[s]:y.w,[o]:0,z:me}},yield{...e,...P,id:`${t}/wall`,config:{style:"none",side:"away"},renders:!1,type:"wall",state:{position:_(A(_(n,a)),{z:me}),expires:null},aabb:A({[s]:2,[o]:.5,z:De-n.z-2})},n.z>0&&(yield{...e,...P,id:`${t}/legs`,config:{...e.config,inHiddenWall:i,style:"none",side:"away",height:n.z},renders:!0,type:"doorLegs",state:{position:_({...A(_(n,a)),z:0}),expires:null},aabb:{...A({[s]:2,[o]:.5,z:n.z})}})}const Ze=e=>{const t=A(e.position),{aabb:r}=ue(e);if(r===void 0)throw new Error(`item type= ${e.type} config=${JSON.stringify(e.config)} has no bounding box`);return e.type==="wall"?t:_(t,{x:y.w-r.x>>1,y:y.d-r.y>>1})},ts=e=>e.config.which==="head"?{type:"head",config:{},...P,...ue(e),id:"head",state:{facing:"towards",action:"idle",jumpEndTime:-1,hasHooter:!1,fast:0,shield:0,standingOn:null,velZ:0,lives:8,donuts:0,autoWalkDistance:0,teleporting:null,position:Ze(e),expires:null},falls:!0}:{type:"heels",config:{},...P,...ue(e),id:"heels",state:{facing:"towards",action:"idle",carrying:null,hasBag:!1,jumps:0,shield:0,standingOn:null,velZ:0,lives:8,autoWalkDistance:0,jumpEndTime:-1,teleporting:null,position:Ze(e),expires:null},falls:!0};function*rs(e,t,{id:r},n){if(!(t.type==="pickup"&&n[r][e]))switch(t.type){case"door":return yield*es(t,e);case"player":{yield ts(t);return}case"conveyor":{yield{...t,...P,...ue(t),id:e,config:{...t.config,count:1},state:wt(t)};return}default:yield{...t,...P,...ue(t),id:e,config:t.config,state:wt(t)}}}const wt=e=>{const t=qr.includes(e.type);return{expires:null,position:Ze(e),...t?{standingOn:null,velZ:0}:{},...e.type==="teleporter"?{flashing:!1}:{},...e.type==="pickup"?{collected:!1}:{},...e.type==="lift"?{direction:"up"}:{}}},R=e=>e[Symbol.iterator](),Cr=({aabb:e,state:{position:t}},{aabb:r,state:{position:n}})=>{for(const s of ur)if(t[s]+e[s]<=n[s]||t[s]>=n[s]+r[s])return!1;return!0},Ie=(e,t)=>[...R(t).filter(r=>e.id!==r.id&&Cr(e,r))];function*ns(e){const t={...A(we(e.size,{x:2,y:2})),z:0},r=A({x:-1,y:-1,z:0});if(e.floor==="none"&&e.roomBelow!==void 0?yield{...P,type:"portal",id:"floor",config:{toRoom:e.roomBelow,relativePoint:U,direction:"down"},aabb:t,state:{position:r,expires:null},renders:!1}:yield{...P,type:"floor",id:"floor",config:{deadly:e.floor==="deadly"},aabb:t,state:{position:r,expires:null},renders:!1},e.roomAbove!==void 0){const n=_(r,{z:y.h*De});yield{...P,type:"portal",id:"ceiling",config:{toRoom:e.roomAbove,relativePoint:{x:0,y:0,z:-y.h},direction:"up"},aabb:t,state:{position:n,expires:null},renders:!1}}}const ss=(e,t,r)=>t.type==="fish"||t.type==="portal"||t.type==="barrier"&&t.config.disappearing===!0||t.type==="pickup"&&r[t.id]===!0||t.type==="pickup"&&te(e)||e.type==="pickup"&&te(t),_r=(e,t,r)=>!ss(e,t,r),vt=.001,Ae=(e,t,r)=>{const{state:{position:n,standingOn:s},aabb:o,id:i}=e,a=_(n,{z:-vt}),c=Ie({state:{position:a},aabb:o,id:i},R(t).filter(d=>_r(e,d,r))).filter(d=>d.state.position.z+d.aabb.z-n.z<vt*2);return s!==null&&c.find(d=>d===s)||c.at(0)||null};function*os(e){const{conveyors:t=[],others:r=[]}=Object.groupBy(e,s=>s.type==="conveyor"?"conveyors":"others"),n=Object.groupBy(t,s=>s.config.direction);yield*r;for(const[s,o]of Zr(n)){const i=at(s),a=Re(i),l=Object.groupBy(o,c=>c.state.position[a]);for(const c of w(l)){if(c===void 0)continue;const d=g=>g.state.position[i],f=c.sort((g,x)=>d(g)-d(x)),p=[];for(const g of f){const x=p.at(-1);x===void 0||d(x)+x.aabb[i]!==d(g)?p.push(g):(x.aabb={...x.aabb,[i]:x.aabb[i]+y.w},x.config.count=(x.config.count??1)+1)}console.log(p),yield*p}}}function*is(e,t){const r=Ut(e.items);for(const[n,s]of r)yield*rs(n,s,e,t)}const kr=(e,t)=>{e.state.standingOn=Ae(e,w(t),{})},as=e=>{for(const t of w(e))V(t)&&kr(t,e)},Xe=e=>R(e).reduce((t,r)=>({...t,[r.id]:r}),{}),Pe=(e,t)=>{const r={...Xe(ns(e)),...Xe(Jn(e)),...Xe(os(is(e,t)))};for(const n of w(r)){const s=Ie(n,w(r));if(s.length>0)throw new Error(`error while loading room ${e.id}: item id=${n.id} is colliding with ${s.map(o=>`id=${o.id}`)}`)}return as(r),{...e,items:r}},Ke=({state:{position:e,facing:t,autoWalkDistance:r,action:n}})=>({position:e,facing:t,autoWalkDistance:r,action:n}),ls=["head","heels"],lt=e=>e==="head"?"heels":"head",ct=({gameState:e,toRoom:t,positionRelativeToSourcePortal:r=U,changeType:n,sourcePortal:s})=>{const{currentCharacterName:o}=e,i=e.characterRooms[o].room;if(t===i.id)throw new Error(`Can't move to the same room "${t}" from "${i.id}"`);const a=lt(o),l=e.characterRooms[a]?.room,c=l?.id===t?l:Pe(e.campaign.rooms[t],e.pickupsCollected),d=i.items[o];if(d===void 0)throw new Error(`Couldn't find character ${o} in room ${i.id} - can't move them to new room ${t}`);if(delete i.items[o],n!=="teleport"){const p=W("portal"),g=R(w(c.items)).find(v=>p(v)&&v.config.toRoom===i.id)||(n==="level-select"?R(w(c.items)).find(v=>p(v)&&de.includes(v.config.direction))||R(w(c.items)).find(p):void 0);if(console.log("putting",o,"into",t,"at portal",g),g===void 0)throw new Error(`trying to enter room id=${t} with no portals`);d.state.position=_(g.state.position,g.config.relativePoint,r,n==="portal"&&s.config.direction==="up"?{z:y.h}:{}),console.log("character put down at",d.state.position,"which is relative to","destination portal position",g.state.position,g.config.relativePoint,r);const{config:{direction:x}}=g;if(de.includes(x)){const v=x;d.state.autoWalkDistance=y.w*.75,d.state.action==="idle"&&(d.state.action="moving"),n==="level-select"&&(d.state.facing=cr(v))}}delete c.items[o],c.items[o]=d;const f=Ie(d,w(c.items));f.length>0&&console.warn("on entering room",t,"character",o,"collides with",f),d.state.standingOn=Ae(d,w(c.items),e.pickupsCollected[t]),e.characterRooms[o]={room:c,entryState:Ke(d)},e.events.emit("roomChange",t)},cs=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Å","Ä","Ö","0","1","2","3","4","5","6","7","8","9","!","@","#","$","%","^","&","*","(",")","-","_","=","+","[","]","{","}",";",":","'",'"',",",".","/","<",">","?","\\","|"," ","Enter","Shift","Control","`","~","Tab","Backspace","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Numpad0","Numpad1","Numpad2","Numpad3","Numpad4","Numpad5","Numpad6","Numpad7","Numpad8","Numpad9","NumpadAdd","NumpadSubtract","NumpadMultiply","NumpadDivide","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"],Ct=e=>cs.includes(e),E={right:["P"],towards:["A"],left:["O"],away:["Q"],jump:[" ","M"],carry:["C","M"],fire:["N"],swop:["Enter","S"],pause:["H"]},ds={right:["ArrowRight",...E.right],towards:["ArrowDown",...E.towards],left:["ArrowLeft",...E.left],away:["ArrowUp",...E.away],jump:E.jump,carry:["Shift",...E.carry],fire:["Control",...E.fire],swop:E.swop,pause:["F8",...E.pause]};function*_t(e,t){for(const[r,n]of Ut(e))n.includes(t)&&(yield r)}const kt=e=>e.length===1?e.toUpperCase():e,us=({keyAssignment:e,inputState:t})=>{const r=({key:i})=>{const a=kt(i);if(!Ct(a)){console.log("do not recognise key: ",a);return}for(const l of _t(e,a))t[l]=!0},n=({key:i})=>{const a=kt(i);if(Ct(a))for(const l of _t(e,a))t[l]=!1},s=()=>{t.windowFocus=!0},o=()=>{t.windowFocus=!1};return window.addEventListener("keydown",r,!1),window.addEventListener("keyup",n,!1),window.addEventListener("focus",s,!1),window.addEventListener("blur",o,!1),()=>{window.removeEventListener("keydown",r,!1),window.removeEventListener("keyup",n,!1),window.removeEventListener("focus",s,!1),window.removeEventListener("blur",o,!1)}};function hs(e){return{all:e=e||new Map,on:function(t,r){var n=e.get(t);n?n.push(r):e.set(t,[r])},off:function(t,r){var n=e.get(t);n&&(r?n.splice(n.indexOf(r)>>>0,1):e.set(t,[]))},emit:function(t,r){var n=e.get(t);n&&n.slice().map(function(s){s(r)}),(n=e.get("*"))&&n.slice().map(function(s){s(t,r)})}}}const fs=[...de,"jump","fire","carry","swop","pause"],ps=()=>({...Ht(fs.map(e=>[e,!1])),windowFocus:!0}),ys=e=>{const t={};for(const r of Object.values(e.rooms))for(const n of Object.values(r.items))if(n.type==="player"){const{which:s}=n.config;t[s]=r.id}if(t.head===void 0&&t.heels===void 0)throw new Error("couldn't find either head or heels in campaign");return t},gs=(e,t)=>{const r=ys(e),n=Ht(Object.keys(e.rooms).map(i=>[i,{}])),s=r.head&&Pe(e.rooms[r.head],n),o=r.heels&&Pe(e.rooms[r.heels],n);return{keyAssignment:ds,currentCharacterName:r.head===void 0?"heels":"head",characterRooms:{head:s===void 0?void 0:{room:s,entryState:Ke(s.items.head)},heels:o===void 0?void 0:{room:o,entryState:Ke(o.items.heels)}},inputState:ps(),renderOptions:t,campaign:e,events:hs(),pickupsCollected:n,gameTime:0}},Y=(e,{x:t,y:r},n)=>{function*s(){yield[`${e}.left`,{frame:{x:t,y:r,...n}}],yield[`${e}.away`,{frame:{x:t+n.w+2,y:r,...n}}],yield[`${e}.towards`,{frame:{x:t,y:r+n.h+2,...n}}],yield[`${e}.right`,{frame:{x:t+n.w+2,y:r+n.h+2,...n}}]}return Object.fromEntries(s())},m=(e,t,{x:r,y:n},s)=>{function*o(){for(let i=0;i<t;i++)yield[`${e}.${i+1}`,{frame:{x:r+i*(s.w+1),y:n,...s}}]}return Object.fromEntries(o())},le={w:32,h:16},F={w:16,h:55},B={w:23,h:57},z={w:32,h:28},u={w:24,h:24};function Tt(e){function*t(r,n){yield`${r}.walking.${n}.1`,yield`${r}.walking.${n}.2`,yield`${r}.walking.${n}.3`,yield`${r}.walking.${n}.2`}return de.reduce((r,n)=>({...r,[`${e}.walking.${n}`]:[...t(e,n)]}),{})}const xs={...m("head.walking.towards",3,{x:4,y:266},u),...m("head.walking.right",3,{x:80,y:266},u),...m("head.walking.left",3,{x:4,y:240},u),...m("head.walking.away",3,{x:80,y:240},u),"head.blinking.towards":{frame:{x:54,y:291,...u}},"head.blinking.right":{frame:{x:130,y:291,...u}},...m("head.idle.right",2,{x:4,y:329},u),"head.falling.towards":{frame:{x:29,y:291,...u}},"head.falling.right":{frame:{x:105,y:291,...u}},...m("bubbles.head",6,{x:4,y:215},u),...m("heels.walking.towards",3,{x:159,y:266},u),...m("heels.walking.right",3,{x:235,y:266},u),...m("heels.walking.left",3,{x:159,y:240},u),...m("heels.walking.away",3,{x:235,y:240},u),...m("bubbles.heels",6,{x:159,y:215},u)},ms=5e3,Ot=Math.round(ms/(ke*4))-3,Tr={frames:xs,animations:{...Tt("head"),...Tt("heels"),"head.idle.right":[...new Array(Ot).fill("head.walking.right.3"),"head.blinking.right","head.walking.right.3","head.blinking.right"],"head.idle.towards":[...new Array(Ot).fill("head.walking.towards.3"),"head.blinking.towards","head.walking.towards.3","head.blinking.towards"],"head.fadeOut":["bubbles.head.1","bubbles.head.2","bubbles.head.4","bubbles.head.3","bubbles.head.4","bubbles.head.6","bubbles.head.5","bubbles.head.6","bubbles.head.5"],"heels.fadeOut":["bubbles.heels.1","bubbles.heels.2","bubbles.heels.4","bubbles.heels.3","bubbles.heels.4","bubbles.heels.6","bubbles.heels.5","bubbles.heels.6","bubbles.heels.5"]}},L=(e,t,r)=>{function*n(s,o,i){const{walls:a}=Kr[s],{w:l,h:c}=F,d=l>>1,f=a.length;let p=0;for(;p<a.length;p++)yield[`${s}.wall.${a[p]}.left`,{frame:{x:o+l*p,y:i-d*p,...F}}],yield[`${s}.wall.${a[p]}.away`,{frame:{x:o+l*((f<<1)-p-1),y:i-d*p,...F}}];const g=p-1;yield[`${s}.floor`,{frame:{x:o+g*l,y:i-g*d+c+1,...le}}]}return Object.fromEntries(n(e,t,r))},bs={...L("blacktooth",487,335),...L("bookworld",356,23),...L("egyptus",435,23),...L("jail",455,351),...L("market",378,244),...L("moonbase",384,141),...L("penitentiary",513,23),...L("safari",482,244)},ws={frames:bs,animations:{}};let Je;try{Je=await Jr.load(Qr)}catch{Je=ae.EMPTY}const vs={"generic.edge.right":{frame:{x:536,y:392,w:8,h:9}},"generic.edge.towards":{frame:{x:527,y:392,w:8,h:9}},"generic.floor.overdraw":{frame:{x:193,y:37,w:F.w,h:le.h*2}},"generic.wall.overdraw":{frame:{x:210,y:37,w:F.w,h:le.h*2}},"generic.wall.overdraw.debug":{frame:{x:210,y:4,w:F.w,h:le.h*2}},"generic.floor.deadly":{frame:{x:422,y:407,...le}},"generic.door.legs.base":{frame:{x:314,y:60,w:F.w,h:9}},"generic.door.legs.pillar":{frame:{x:314,y:48,w:F.w,h:12}},"generic.door.front.y":{frame:{x:227,y:12,...B}},"generic.door.back.y":{frame:{x:244,y:5,...B}},"generic.door.legs.threshold.y":{frame:{x:331,y:30,w:F.w,h:18}},"generic.door.threshold.x":{frame:{x:270,y:70,w:26,h:19}},"generic.door.threshold.y":{frame:{x:241,y:70,w:26,h:19}},"generic.door.platform.towards":{frame:{x:270,y:144,w:32,h:32}},"generic.door.front.x":{frame:{x:287,y:12,...B}},"generic.door.back.x":{frame:{x:270,y:5,...B}},"generic.door.legs.threshold.x":{frame:{x:314,y:30,w:F.w,h:18}},"generic.door.platform.left":{frame:{x:235,y:114,w:32,h:28}},"moonbase.door.front.y":{frame:{x:344,y:160,...B}},"moonbase.door.back.y":{frame:{x:361,y:153,...B}},"moonbase.door.front.x":{frame:{x:529,y:160,...B}},"moonbase.door.back.x":{frame:{x:512,y:153,...B}},teleporter:{frame:{x:2,y:478,...z}},...m("teleporter.flashing",2,{x:35,y:478},z),"barrier.x":{frame:{x:27,y:349,w:24,h:24}},"barrier.y":{frame:{x:2,y:349,w:24,h:24}},"block.organic":{frame:{x:160,y:449,...z}},"block.organic.disappearing":{frame:{x:160,y:420,...z}},"block.artificial":{frame:{x:127,y:449,...z}},"block.artificial.disappearing":{frame:{x:127,y:449,...z}},"block.tower":{frame:{x:27,y:374,...u}},"block.tower.disappearing":{frame:{x:27,y:374,...u}},volcano:{frame:{x:193,y:420,...z}},toaster:{frame:{x:101,y:478,...z}},spikes:{frame:{x:422,y:378,...z}},"conveyor.x":{frame:{x:35,y:399,...z}},"conveyor.y":{frame:{x:68,y:399,...z}},bunny:{frame:{x:263,y:333,...u}},donuts:{frame:{x:263,y:308,...u}},crown:{frame:{x:367,y:358,...u}},hooter:{frame:{x:263,y:408,...u}},bag:{frame:{x:263,y:358,...u}},...m("fish",2,{x:238,y:383},u),"spring.compressed":{frame:{x:2,y:453,...u}},"spring.released":{frame:{x:27,y:453,...u}},...m("lift",4,{x:259,y:474},u),"lift.static":{frame:{x:359,y:474,...u}},...m("dalek",2,{x:4,y:4},u),"headless-base":{frame:{x:93,y:102,...u}},joystick:{frame:{x:2,y:374,...u}},anvil:{frame:{x:134,y:478,...z}},"book.x":{frame:{x:167,y:478,...z}},"book.y":{frame:{x:200,y:478,...z}},sandwich:{frame:{x:2,y:399,...z}},sticks:{frame:{x:2,y:428,...u}},cube:{frame:{x:27,y:428,...u}},drum:{frame:{x:52,y:428,...u}},"switch.off":{frame:{x:52,y:453,...u}},"switch.on":{frame:{x:77,y:453,...u}},...Y("american-football-head",{x:4,y:34},{w:24,h:32}),...Y("charles",{x:118,y:34},u),...Y("cyberman",{x:61,y:34},u),...Y("monkey",{x:118,y:90},u),...Y("elephant",{x:118,y:146},u),...Y("computer-bot",{x:173,y:146},u),...m("bubbles",3,{x:4,y:107},u),...m("bubbles.cold",2,{x:109,y:4},u),...m("bubbles.taupe",3,{x:288,y:308},u),...m("bubbles.white",3,{x:288,y:333},u),...m("bubbles.fish",3,{x:288,y:383},u),...m("turtle.left",2,{x:4,y:137},u),...m("turtle.away",2,{x:55,y:137},u),...m("turtle.towards",2,{x:4,y:163},u),...m("turtle.right",2,{x:55,y:163},u),...m("helicopter-bug",4,{x:4,y:188},u),"hush-puppy":{frame:{x:193,y:449,...z}},ball:{frame:{x:84,y:4,...u}},puck:{frame:{x:102,y:428,...u}},"puck.deadly":{frame:{x:102,y:453,...u}},...Tr.frames,...ws.frames},Cs={frames:vs,animations:{"teleporter.flashing":["teleporter.flashing.1","teleporter.flashing.2"],fish:["fish.1","fish.2"],lift:["lift.1","lift.2","lift.3","lift.4"],dalek:["dalek.1","dalek.2"],"turtle.left":["turtle.left.1","turtle.left.2"],"turtle.away":["turtle.away.1","turtle.away.2"],"turtle.towards":["turtle.towards.1","turtle.towards.2"],"turtle.right":["turtle.right.1","turtle.right.2"],"helicopter-bug":["helicopter-bug.1","helicopter-bug.2","helicopter-bug.3","helicopter-bug.4"],bubbles:["bubbles.1","bubbles.2"],"bubbles.cold":["bubbles.cold.1","bubbles.cold.2"],"bubbles.white":["bubbles.white.1","bubbles.white.2","bubbles.white.3"],"bubbles.taupe":["bubbles.taupe.1","bubbles.taupe.2","bubbles.taupe.3"],"bubbles.fish":["bubbles.fish.1","bubbles.fish.2","bubbles.fish.3"],"spring.bounce":["spring.released","spring.compressed","spring.released","spring.compressed","spring.released"],...Tr.animations},meta:{scale:1}},b=new en(Je,Cs);await b.parse();b.textureSource.scaleMode="nearest";const Or=.5,_s=1e3/25,zr=(e,t=Or)=>e*_s/t;zr(b.animations["bubbles.white"].length);const Se=zr(b.animations["head.fadeOut"].length),ks={x:.5,y:1},Ts=e=>typeof e!="string"&&Object.hasOwn(e,"frames"),h=e=>{if(typeof e=="string")return h({texture:e});{const{anchor:t,flipX:r,pivot:n,x:s,y:o}=e;let i;return Ts(e)?i=Os(e):i=new rt(b.textures[e.texture]),t===void 0&&n===void 0?i.anchor=ks:(t!==void 0&&(i.anchor=t),n!==void 0&&(i.pivot=n)),s!==void 0&&(i.x=s),o!==void 0&&(i.y=o),i.eventMode="static",r===!0&&(i.scale.x=-1),i}};function Os(e){const t=new Te(e.frames.map(r=>({texture:r,time:Wt})));return t.animationSpeed=e.animationSpeed||Or,t.play(),e.playOnce!==void 0&&(t.loop=!1,t.onComplete=()=>{t.stop(),e.playOnce==="and-destroy"&&t.destroy()}),t}const zs=(e,t,r)=>`${e}.wall.${t}.${r}`,As=(e,t,r)=>{const n=b.textures[`${e.planet}.door.front.${t}`]!==void 0;return r=="near"?n?`${e.planet}.door.front.${t}`:`generic.door.front.${t}`:n?`${e.planet}.door.back.${t}`:`generic.door.back.${t}`},Ar=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,Ps=`in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uOriginalColor;
uniform vec3 uTargetColor;
uniform float uTolerance;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);
    vec3 colorDiff = uOriginalColor - (c.rgb / max(c.a, 0.0000000001));
    float colorDistance = length(colorDiff);
    float doReplace = step(colorDistance, uTolerance);
    finalColor = vec4(mix(c.rgb, uTargetColor * c.a, doReplace), c.a);
}
`;class $e extends er{static DEFAULT_OPTIONS={originalColor:16711680,targetColor:0,tolerance:.4};uniforms;_originalColor;_targetColor;constructor(t){t={...$e.DEFAULT_OPTIONS,...t};const r=et.from({vertex:Ar,fragment:Ps,name:"palette-swap-filter"});super({glProgram:r,resources:{colorReplaceUniforms:{uOriginalColor:{value:new Float32Array(3),type:"vec3<f32>"},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"},uTolerance:{value:t.tolerance,type:"f32"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this._originalColor=new O,this._targetColor=new O,this.originalColor=t.originalColor??16711680,this.targetColor=t.targetColor??0,Object.assign(this,t)}get originalColor(){return this._originalColor.value}set originalColor(t){this._originalColor.setValue(t);const[r,n,s]=this._originalColor.toArray();this.uniforms.uOriginalColor[0]=r,this.uniforms.uOriginalColor[1]=n,this.uniforms.uOriginalColor[2]=s}get targetColor(){return this._targetColor.value}set targetColor(t){this._targetColor.setValue(t);const[r,n,s]=this._targetColor.toArray();this.uniforms.uTargetColor[0]=r,this.uniforms.uTargetColor[1]=n,this.uniforms.uTargetColor[2]=s}get tolerance(){return this.uniforms.uTolerance}set tolerance(t){this.uniforms.uTolerance=t}}const H={original:new O("rgb(255, 255, 255)"),basic:new O("rgb(210, 210, 210)"),dimmed:new O("rgb(120, 120, 120)")},X={original:new O("rgb(255, 255, 0)"),basic:new O("hsl(50,58%,70%)"),dimmed:N().redShadow},Z={original:new O("rgb(255, 0, 255)"),basic:N().pink,dimmed:new O("hsl(290,25%,40%)")},D={original:new O("rgb(0, 255, 255)"),basic:new O("hsl(183, 28%, 50%)"),dimmed:N().shadow},K={original:new O("rgb(0, 255, 0)"),basic:N().moss,dimmed:new O("hsl(73,35%,30%)")},Ss={white:H,yellow:X,magenta:Z,cyan:D,green:K},Ne={white:{main:H,edges:{towards:D,right:X},hud:{lives:X,dimmed:Z,icons:D}},yellow:{main:X,edges:{towards:K,right:H},hud:{lives:D,dimmed:Z,icons:K}},magenta:{main:Z,edges:{towards:K,right:D},hud:{lives:H,dimmed:D,icons:X}},cyan:{main:D,edges:{towards:Z,right:H},hud:{lives:H,dimmed:K,icons:X}},green:{main:K,edges:{towards:D,right:X},hud:{lives:H,dimmed:Z,icons:D}}},Pr=e=>[new $e({originalColor:N().replaceLight,targetColor:e.basic,tolerance:.1}),new $e({originalColor:N().replaceDark,targetColor:e.dimmed,tolerance:.1})],Qe=(e,t)=>Pr(Ne[e.color].edges[t]),$s=e=>Pr(Ne[e.color].main),Fs=[];function Sr(e,t){const r=t||new k;for(const n of e)r.addChild(n);return r}function*Ms({config:{direction:e,inHiddenWall:t,height:r}},n){const s=j(e),o=s==="y"?0:16;function*i(a){if(t){if(r!==0){const c=h({pivot:{x:s==="x"?18:8,y:12},texture:`generic.door.threshold.${s}`,...we(a,{y:-y.h*r})});c.filters=Qe(n,s==="x"?"towards":"right"),yield c}}else{yield h({pivot:{x:o,y:12},texture:"generic.door.legs.base",...we(a,{y:r})});for(let l=1;l<r;l++)yield h({pivot:{x:o,y:9},texture:"generic.door.legs.pillar",...we(a,{y:-l*y.h})});yield h({pivot:{x:o,y:y.h*r+15},texture:`generic.door.legs.threshold.${s}`,...a})}}yield*i(I({...yt,[s]:1})),yield*i(yt)}const Rs=(e,t)=>Sr(Ms(e,S(t)));function*Es({config:{direction:e,inHiddenWall:t,nearness:r},state:{position:n}},s){const o=j(e),{z:i}=n;if(!t&&i===0){const a=I({[Re(o)]:.5});r==="far"&&(yield h({anchor:{x:0,y:1},flipX:o==="x",texture:"generic.wall.overdraw",...a}))}yield h({texture:As(s,o,r),pivot:jn[r][o]})}const Ds=(e,t)=>Sr(Es(e,S(t))),zt=({type:e,state:{action:t,facing:r,teleporting:n}})=>{if(t==="death")return h({frames:b.animations[`${e}.fadeOut`]});if(n!==null){if(n.phase==="out")return h({frames:b.animations[`${e}.fadeOut`]});if(n.phase==="in")return h({frames:b.animations[`${e}.fadeOut`].toReversed()})}return h(t==="moving"?{frames:b.animations[`${e}.walking.${r}`]}:t==="falling"&&e==="head"&&(r==="towards"||r==="right")?`head.falling.${r}`:e==="head"&&(r==="towards"||r==="right")?{frames:b.animations[`head.idle.${r}`]}:`${e}.walking.${r}.2`)},Ue={frames:b.animations["bubbles.cold"],animationSpeed:.25},ie=(e,t="headless-base")=>{const r=new k;r.addChild(h(t));const n=h(e);return n.y=-12,r.addChild(n),r},Is={head:zt,heels:zt,doorFrame:Ds,doorLegs:Rs,portal(){throw new Error("these should always be non-rendering")},wall({config:{side:e,style:t}},r){return e==="right"||e==="towards"?new k:h({texture:zs(S(r).planet,t,e),pivot:e==="away"?{x:F.w,y:F.h-1}:{x:0,y:F.h-1}})},barrier({config:{axis:e},state:{expires:t}}){return h(t!==null?{frames:b.animations["bubbles.taupe"],playOnce:"and-destroy",pivot:gt[e]}:{texture:`barrier.${e}`,pivot:gt[e]})},"deadly-block":({config:{style:e}})=>h(e==="puck"?"puck.deadly":e),block({config:{style:e,disappearing:t},state:{expires:r}}){return h(r!==null?{frames:b.animations["bubbles.taupe"],playOnce:"and-destroy"}:`block.${e}${t?".disappearing":""}`)},conveyor({config:{direction:e,count:t}}){const r=new k,n=at(e);return r.addChild(...R(Sn(t,0,-1)).map(s=>h({texture:`conveyor.${n}`,...pr({[n]:(s-1)*y.w})}))),r},lift(){const e=new k,t={x:u.w/2,y:u.h-mr};return e.addChild(h({frames:b.animations.lift,pivot:t})),e.addChild(h({texture:"lift.static",pivot:t})),e},spring:(e,t)=>!e.state.stoodOn&&e.lastRenderedState?.stoodOn?h({frames:b.animations["spring.bounce"],playOnce:"and-stop"}):e.state.stoodOn?h("spring.compressed"):h("spring.released"),teleporter(e){if(e.state.stoodOn){const t=new k;return t.addChild(h("teleporter")),t.addChild(h({frames:b.animations["teleporter.flashing"]})),t}else return h("teleporter")},pickup({id:e,config:{gives:t}},r){const n=S(r).id,s=r.pickupsCollected[n][e]===!0,i={shield:"bunny",jumps:"bunny",fast:"bunny","extra-life":"bunny",bag:"bag",donuts:"donuts",hooter:"hooter",crown:"crown"}[t];return h(s?{frames:i==="donuts"?b.animations["bubbles.taupe"]:b.animations["bubbles.white"],playOnce:"and-destroy"}:i)},fish({id:e,config:{alive:t}},r){const n=S(r).id;return r.pickupsCollected[n][e]===!0?h({frames:b.animations["bubbles.fish"],playOnce:"and-destroy"}):h(t?{frames:b.animations.fish,animationSpeed:.25}:{texture:"fish.1"})},sceneryPlayer:({config:{which:e}})=>h(`${e}.walking.towards.2`),baddie({config:e}){switch(e.which){case"helicopter-bug":case"dalek":return h({frames:b.animations[e.which],animationSpeed:.5});case"headless-base":return h({texture:"headless-base"});case"american-football-head":return h({texture:`american-football-head.${e.startDirection}`});case"turtle":return h({frames:b.animations[`turtle.${e.startDirection}`],animationSpeed:.25});case"cyberman":return e.charging?h(`cyberman.${e.startDirection}`):ie("cyberman.towards",Ue);case"bubble-robot":return ie(Ue);case"flying-ball":return ie("ball",Ue);case"computer-bot":case"elephant":case"monkey":return ie(`${e.which}.towards`);case"elephant-head":return h("elephant.right");default:throw new Error(`unexpected baddie ${e}`)}},joystick:()=>h("joystick"),"movable-block":({config:{style:e}})=>h(e),book:({config:{slider:e}})=>h(`book.${e?"y":"x"}`),"portable-block":({config:{style:e}})=>h(e),charles:()=>ie("charles.towards"),switch:()=>h("switch.off"),"hush-puppy":()=>h("hush-puppy"),ball:()=>h("ball"),floor(){throw new Error("floor should not be rendered as an item")}},$r=(e,t)=>{tn(e);const r=Is[e.type];if(r===void 0)throw new Error(`item type "${e.type}" has no appearance - if it doesn't render, give it the .renders = false`);e.renderContainer.children.forEach(s=>s.destroy({children:!0,context:!0})),e.renderContainer.removeChildren();const n=r(e,t);e.renderContainer.addChild(n)},Fr=e=>{rn(e);const{state:{position:t},positionContainer:r}=e,n=fr(t);r.x=n.x,r.y=n.y},Mr=e=>{const t={},r=Object.values(e.items).filter(W("doorFrame"));for(const{config:{direction:n},state:{position:{x:s,y:o}}}of r)j(n)==="x"?o<0?t.towards=!0:o===e.size.y*y.d&&(t.away=!0):s<0?t.right=!0:s===e.size.x*y.w&&(t.left=!0);return t},Rr=e=>{const t=Mr(e),r=t.right?-.5:0,n=e.size.x+(t.left?.5:0),s=t.towards?-.5:0,o=e.size.y+(t.away?.5:0),i=I({x:r,y:o}),a=I({x:n,y:s}),l=I({x:r,y:s}),c=I({x:n,y:o}),d=c.y+F.h;return{blockXMin:r,blockXMax:n,blockYMin:s,blockYMax:o,rightSide:i,leftSide:a,frontSide:l,backSide:c,top:d}},Ns=e=>{const{towards:t,right:r}=Mr(e),{blockXMin:n,blockYMin:s,rightSide:o,leftSide:i,frontSide:a,backSide:l}=Rr(e),{floor:c}=e,d=new k,f=Object.fromEntries(e.floorSkip.map(({x:$,y:M})=>[`${$},${M}`,!0]));if(c!=="none"){const $=c==="deadly"?"generic.floor.deadly":`${c}.floor`,M=new k;for(let T=-1;T<=e.size.x;T++)for(let he=T%2-1;he<=e.size.y;he+=2)f[`${T},${he}`]||M.addChild(oe({x:T,y:he},h({anchor:{x:.5,y:1},texture:$})));for(let T=0;T<=e.size.x;T++)e.walls.away[T]!=="none"&&M.addChild(oe({x:T,y:e.size.y},h({anchor:{x:0,y:1},texture:"generic.floor.overdraw",flipX:!0})));for(let T=0;T<=e.size.y;T++)e.walls.left[T]!=="none"&&M.addChild(oe({x:e.size.x,y:T},h({anchor:{x:0,y:1},texture:"generic.floor.overdraw"})));const ne=new ee().poly([a,o,l,i],!0).fill(16711680).stroke({width:8});M.addChild(ne),M.mask=ne,d.addChild(M)}const p=new k;for(let $=n;$<=e.size.x;$+=.5)p.addChild(oe({x:$,y:t?-.5:0},h({pivot:{x:7,y:0},texture:"generic.edge.towards"})));p.filters=Qe(e,"towards");const g=new k;for(let $=s;$<=e.size.y;$+=.5)g.addChild(oe({x:r?-.5:0,y:$},h({pivot:{x:0,y:0},texture:"generic.edge.right"})));g.filters=Qe(e,"right");const x=I({x:0,y:e.size.y}),v=I({x:e.size.x,y:0}),re=new ee().poly([{x:a.x,y:a.y+16},{x:x.x,y:x.y+16},{x:x.x,y:-999},{x:v.x,y:-999},{x:v.x,y:v.y+16}],!0).fill(16776960);return d.addChild(re),d.addChild(p),d.addChild(g),d.mask=re,d},At=(e,t)=>new ee().poly([C({}),C({x:e.x}),C({x:e.x,y:e.y}),C({y:e.y})]).poly([C({}),C({z:e.z}),C({y:e.y,z:e.z}),C({y:e.y})]).poly([C({x:e.x}),C({x:e.x,z:e.z}),C(e),C({x:e.x,y:e.y})]).poly([C({z:e.z}),C({x:e.x,z:e.z}),C({x:e.x,y:e.y,z:e.z}),C({y:e.y,z:e.z})]).stroke({width:.5,color:t}),Bs={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)"},Ls=e=>{const t=Bs[e.type]??"rgba(255,255,255)",r=new k;if(W("portal")(e)){const n=C(e.config.relativePoint);r.addChild(new ee().circle(n.x,n.y,5).stroke(t)),r.addChild(new ee().circle(n.x,n.y,2).fill(t))}return r.addChild(new ee().circle(0,0,2).fill(t)),r.addChild(At(e.aabb,t)),e.renderAabb&&r.addChild(At(e.renderAabb,"rgba(184, 184, 255)")),r},Xs=e=>{const t=new k;return e.renderContainer!==void 0&&t.addChild(e.renderContainer),t.addChild(Ls(e)),t},Us=`precision mediump float;
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uSourceBlacks[2];
uniform vec3 uTargetColor;

// colours are floats so check if they're very close rather than exactly equal:
bool colorsEffectivelyEqual(vec3 color1, vec3 color2) {    
    
    return distance(color1, color2) < 0.05;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a == 0.0 ) {
        finalColor = c;
        return;
    }

    if ( colorsEffectivelyEqual(c.rgb, uSourceBlacks[0]) || colorsEffectivelyEqual(c.rgb, uSourceBlacks[1])) {
        finalColor = vec4(0,0,0, 1.0);
    } else {
        finalColor = vec4(uTargetColor, 1);    
    }
}
`,Pt=[N().pureBlack,N().lightBlack];class dt extends er{uniforms;constructor(t=X.basic){const r=et.from({vertex:Ar,fragment:Us,name:"revert-colourise-filter"});super({glProgram:r,resources:{colorReplaceUniforms:{uSourceBlacks:{value:new Float32Array(6),type:"vec3<f32>",size:6},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms;const[n,s,o]=Pt[0].toArray();this.uniforms.uSourceBlacks[0]=n,this.uniforms.uSourceBlacks[1]=s,this.uniforms.uSourceBlacks[2]=o;const[i,a,l]=Pt[1].toArray();this.uniforms.uSourceBlacks[3]=i,this.uniforms.uSourceBlacks[4]=a,this.uniforms.uSourceBlacks[5]=l,this.targetColor=t}set targetColor(t){const[r,n,s]=new O(t).toArray();this.uniforms.uTargetColor[0]=r,this.uniforms.uTargetColor[1]=n,this.uniforms.uTargetColor[2]=s}}const St=(e,t)=>{const r=C(e),n=C(_(e,{x:t.x,z:t.z})),s=C(_(e,{y:t.y,z:t.z}));return{bottomCentre:r,topLeft:n,topRight:s}},He=(e,t,r,n,s=1e-4)=>n-s>e&&r<t-s,Hs=(e,t,r,n)=>{const s=St(e,t),o=St(r,n),i=s.topLeft.x,a=s.topRight.x,l=o.topLeft.x,c=o.topRight.x,d=He(i,a,l,c),f=s.topRight.y-s.topRight.x/2,p=s.bottomCentre.y-s.bottomCentre.x/2;if(f>p)throw new Error(`aXAxisSlopeMinC ${f} > aXAxisSlopeMaxC ${p}`);const g=o.topRight.y-o.topRight.x/2,x=o.bottomCentre.y-o.bottomCentre.x/2;if(g>x)throw new Error("bXAxisSlopeMinC > bXAxisSlopeMaxC");const v=He(f,p,g,x),re=s.topLeft.y+s.topLeft.x/2,$=s.bottomCentre.y+s.bottomCentre.x/2;if(re>$)throw new Error("aYAxisSlopeMinC > aYAxisSlopeMaxC");const M=o.topLeft.y+o.topLeft.x/2,ne=o.bottomCentre.y+o.bottomCentre.x/2;if(M>ne)throw new Error("bYAxisSlopeMinC > bYAxisSlopeMaxC");const T=He(re,$,M,ne);return d&&v&&T},Ws=(e,t)=>{if(e.renders===!1||t.renders===!1)return 0;const r=e.state.position,n=e.renderAabb||e.aabb,s=t.state.position,o=t.renderAabb||t.aabb;if(!Hs(r,n,s,o))return 0;for(const i of ur){const a=e.state.position[i],l=a+n[i],c=t.state.position[i],d=c+o[i];if(l<=c)return 1*(i==="z"?-1:1);if(a>=d)return-1*(i==="z"?-1:1)}return $t(t)-$t(e)},$t=e=>e.state.position.x+e.state.position.y-e.state.position.z;class ve extends Error{constructor(t,r,n){super(t,n),this.cyclicDependency=r}}const Vs=e=>Gs(js(e),e),Gs=(e,t)=>{let r=e.length,n=r;const s=new Array(r),o={},i=Ys(t),a=qs(e);for(t.forEach(function(c){if(!a.has(c[0])||!a.has(c[1]))throw new Error("Unknown node. There is an unknown node in the supplied edges.")});n--;)o[n]||l(e[n],n,new Set);return s;function l(c,d,f){if(f.has(c))throw new ve("Cyclic dependency found - see .cyclicDependency of this error for details",[c]);if(!a.has(c))throw new Error("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(c));if(o[d])return;o[d]=!0;const p=i.get(c)||new Set,g=Array.from(p);if(d=g.length){f.add(c);do{const x=g[--d];try{l(x,a.get(x),f)}catch(v){throw v instanceof ve?new ve(v.message,[...v.cyclicDependency,c]):v}}while(d);f.delete(c)}s[--r]=c}};function js(e){const t=new Set;for(let r=0,n=e.length;r<n;r++){const s=e[r];t.add(s[0]),t.add(s[1])}return Array.from(t)}function Ys(e){const t=new Map;for(let r=0,n=e.length;r<n;r++){const s=e[r];t.has(s[0])||t.set(s[0],new Set),t.has(s[1])||t.set(s[1],new Set),t.get(s[0]).add(s[1])}return t}function qs(e){const t=new Map;for(let r=0,n=e.length;r<n;r++)t.set(e[r],r);return t}const Er=e=>{const t=[];for(const r of e)if(r.renders)for(const n of e){if(r===n)break;if(!n.renders)continue;const s=Ws(r,n);s!==0&&(s>0?t.push([n.id,r.id]):t.push([r.id,n.id]))}return t},Dr=(e,t)=>{let r;try{r=Vs(e)}catch(n){if(n instanceof ve){const s=n.cyclicDependency,o=i=>{const{state:{position:a},aabb:l}=t[i];return`${i} @${JSON.stringify(a)} bb:${JSON.stringify(l)}`};throw new Error(`found a cyclic dependency in the draw order - cyclic nodes are: 
	${s.map(o).join(` --in-front-of--> 
	`)}`,n)}else throw n}for(let n=0;n<r.length;n++)t[r[n]].positionContainer.zIndex=n},Zs=(e,t)=>{const{leftSide:r,rightSide:n,frontSide:s,top:o}=Rr(e),i=(n.x+r.x)/2,a=(o+s.y)/2;t.x=-i,t.y=-a},Ks=(e,t,r)=>{e.renderContainer!==void 0&&(t.onItemClick&&e.renderContainer!==void 0&&(e.renderContainer.eventMode="static",e.renderContainer.on("pointertap",()=>{t.onItemClick(e)})),e.renderContainer.on("pointerenter",()=>{e.renderContainer.filters=new dt(Ss[r.color].original)}),e.renderContainer.on("pointerleave",()=>{e.renderContainer.filters=[]}))},Js=(e,t)=>{const r=S(e),n=new k;n.addChild(Ns(r));const s=new k;for(const o of w(r.items)){const{renders:i}=o;if(i){const l=new k;o.renderContainer=l,$r(o,e)}const a=t.showBoundingBoxes==="all"||t.showBoundingBoxes==="non-wall"&&o.type!=="wall";o.positionContainer=a?Xs(o):o.renderContainer,t.showBoundingBoxes!=="none"&&o.renderContainer!==void 0&&(o.renderContainer.alpha=.2),Ks(o,t,r),o.positionContainer!==void 0&&(Fr(o),s.addChild(o.positionContainer))}return Dr(Er(w(r.items)),r.items),n.addChild(s),n.filters=$s(r),Zs(r,n),n},Qs=e=>{let t=1;return{get curUpscale(){return t},rescale(){if(e.renderer.width===0||e.renderer.height===0)return;const r=Math.floor(Math.min(e.renderer.width/G.width,e.renderer.height/G.height));t!==r&&(t=r,console.log("scale factor changed to:",r),e.stage.scale=r)}}},Ft=8,Ir=e=>e==="heels"?1:-1,Mt=(e,t)=>{const n=new Xn({style:{fill:"white",fontFamily:"Head over Heels",fontSize:Ft},resolution:8,x:(G.width>>1)+Ir(e)*24,y:G.height-Ft*2});return n.scale={x:1,y:2},n},Rt=e=>{const t=new rt(b.textures[`${e}.walking.${e==="head"?"right":"towards"}.2`]);return t.x=(G.width>>1)+Ir(e)*64+(e==="heels"?-u.w:0),t.y=G.height-u.h,t},eo=e=>{const t={head:{sprite:Rt("head"),livesText:Mt("head")},heels:{sprite:Rt("heels"),livesText:Mt("heels")}};e.addChild(t.head.livesText),e.addChild(t.head.sprite),e.addChild(t.heels.livesText),e.addChild(t.heels.sprite);const r=new dt;return n=>{const s=S(n),{hud:{dimmed:o,lives:i}}=Ne[s.color];for(const a of ls){const l=n.currentCharacterName===a,c=Hn(n,a);r.targetColor=o.dimmed,t[a].livesText.style.fill=i.basic,t[a].livesText.text=`${c?.state.lives??0}`,t[a].sprite.filters=l?Fs:r}}},to=(e,t,r)=>{const{state:{velZ:n}}=e,s=Zn[e.type==="head"?"head":"others"],o=Math.max(n-xr*r,s);return{positionDelta:{x:0,y:0,z:o*r},stateDelta:{velZ:o}}},be=e=>{const r=e/qn*Wt;return{velZ:(e+.5*xr*r**2)/r,tApex:r}},ro={head:be(ge.head),headOnSpring:be(ge.head+y.h),heels:be(ge.heels),heelsOnSpring:be(ge.heels+y.h)},no=(e,t)=>ro[`${e}${t?"OnSpring":""}`],so=(e,{inputState:{jump:t}},r)=>{const{type:n}=e;if(!t||e.state.standingOn===null||e.state.standingOn?.type==="teleporter")return{};const{velZ:s}=no(n,e.state.standingOn?.type==="spring");return{stateDelta:{action:"moving",velZ:s}}};function oo(e,t,r){return{stateDelta:{stoodOn:r.items.head?.state.standingOn===e||r.items.heels?.state.standingOn===e}}}function io(e,t,r){return{stateDelta:{stoodOn:R(w(r.items)).find(n=>V(n)&&n.state.standingOn===e)!==void 0}}}function ao(e,t,r){const{state:{teleporting:n}}=e,{inputState:{jump:s}}=t;if(n===null)return s&&e.state.standingOn?.type==="teleporter"?{stateDelta:{teleporting:{phase:"out",toRoom:e.state.standingOn.config.toRoom,timeRemaining:Se}}}:{};const o=Math.max(n.timeRemaining-r,0);switch(n.phase){case"out":if(o===0)return ct({gameState:t,toRoom:n.toRoom,changeType:"teleport"}),{stateDelta:{teleporting:{phase:"in",timeRemaining:Se}}};break;case"in":if(o===0)return{stateDelta:{teleporting:null}};break}return{stateDelta:{teleporting:{...n,timeRemaining:o}}}}const lo={},co=(e,{inputState:t},r)=>{const{type:n,state:{autoWalkDistance:s,standingOn:o,facing:i,teleporting:a}}=e,l=de.find(d=>t[d]===!0),c=yr[n]*r;if(s>0)return{positionDelta:Q(J[i],c),stateDelta:{autoWalkDistance:Math.max(s-c,0)}};if(a!==null)return{};if(o===null)switch(n){case"head":{const f=e.state.velZ>0?"moving":"falling";return l===void 0?{stateDelta:{action:f}}:{positionDelta:Q(J[l],c),stateDelta:{facing:l,action:f}}}case"heels":return l===i?{positionDelta:Q(J[i],c*.6)}:lo}return l!==void 0?{positionDelta:Q(J[l],c),stateDelta:{facing:l,action:"moving"}}:{stateDelta:{action:"idle"}}},uo=.5,Et=(e,t,r,n)=>{const s=r.x+n.x-e.x,o=r.y+n.y-e.y,i=r.z+n.z-e.z,a=e.x+t.x-r.x,l=e.y+t.y-r.y,c=e.z+t.z-r.z,d=Math.abs(s)<Math.abs(a)?s:-a,f=Math.abs(o)<Math.abs(l)?o:-l,p=Math.abs(i)<Math.abs(c)?i:-c,g=Math.abs(d),x=Math.abs(f),v=Math.abs(p)*uo;return g<x&&g<v?{x:d,y:0,z:0}:x<v?{x:0,y:f,z:0}:{x:0,y:0,z:p}},ho=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),fo=(e,t)=>[...R(t).map(n=>[hr(e,ho(e,n)),n])].sort(([n,s],[o,i])=>n-o);function We(e,t){return t.state.action="death",t.state.expires=e.gameTime+Se,!0}const Dt=(e,t,r)=>{const n=S(e).id;if(e.pickupsCollected[n][r.id]===!0)return;const s=e.pickupsCollected[n];if(s[r.id]=!0,Nr(e,t,r),r.type!=="fish")switch(r.config.gives){case"extra-life":t.state.lives+=2}},Nr=(e,t,r)=>{r.state.expires===null&&(r.state.expires=e.gameTime+Se)},po=(e,t,r,n)=>{const{config:{relativePoint:s,toRoom:o,direction:i},state:{position:a}}=r,l=J[i];return hr(l,n)<=0?!1:(ct({gameState:e,toRoom:o,positionRelativeToSourcePortal:dr(t.state.position,_(a,s)),sourcePortal:r,changeType:"portal"}),!0)},yo=(e,t,r)=>{const{config:{direction:n,nearness:s}}=r,o=j(n),i=s==="far"?{x:o==="x"?-Math.abs(t.y):0,y:o==="y"?-Math.abs(t.x):0,z:0}:{x:o==="x"?Math.abs(t.y):0,y:o==="y"?Math.abs(t.x):0,z:0};return e.state.position=_(e.state.position,i),!1},It=(e,t,r,n)=>{switch(t.type){case"baddie":case"deadly-block":if(We(n,e))return!0;case"floor":if(t.config.deadly&&We(n,e))return!0;break;case"portal":if(po(n,e,t,r))return!0;break;case"pickup":Dt(n,e,t);break;case"fish":if(t.config.alive)Dt(n,e,t);else if(We(n,e))return!0;break;case"doorFrame":yo(e,r,t);break;case"block":case"barrier":t.config.disappearing&&Nr(n,e,t);break}return!1},go=(e,t,r,n,s)=>{const{config:{direction:o}}=t,l=(W("heels")(e)&&e.state.action==="moving"&&e.state.facing===cr(o)?yr.heels:Yn)*s,c=Q(J[o],l);return ut({deltaMS:s,gameState:n,xyzDeltaPartial:c,subjectItem:e,pusher:t}),!1},xo=({movingItem:e,movementVector:t,touchee:r,gameState:n,deltaMS:s})=>te(e)&&It(e,r,t,n)||te(r)&&It(r,e,t,n)?!0:(r.type==="conveyor"&&V(e)&&go(e,r,t,n,s),!1),ut=({subjectItem:e,xyzDeltaPartial:t,gameState:r,pusher:n,deltaMS:s})=>{const o=_(U,t);if(Ee(o,U))return;const i=S(r),{state:{position:a}}=e;e.state.position=_(a,o);const l=fo(o,Ie(e,w(i.items)));let c=-1/0;for(const[d,f]of l){if(d>c&&!Cr(e,f))continue;if(c=d,n!==f&&xo({movingItem:e,touchee:f,movementVector:dr(e.state.position,a),gameState:r,deltaMS:s}))return;if(!_r(e,f,r.pickupsCollected[i.id]))continue;const p=Et(e.state.position,e.aabb,f.state.position,f.aabb);if(V(f)&&f!==n){const g=e.type==="lift"?-1:-.5,x=Q(p,g);e.state.position=_(e.state.position,p,x),ut({subjectItem:f,xyzDeltaPartial:x,gameState:r,pusher:e,deltaMS:s}),e.state.position=_(e.state.position,Et(e.state.position,e.aabb,f.state.position,f.aabb)),f.state.standingOn=Ae(f,w(i.items),r.pickupsCollected[i.id])}else e.state.position=_(e.state.position,p)}V(e)&&n===void 0&&(e.state.standingOn=Ae(e,w(i.items),r.pickupsCollected[i.id]))},Fe=y.h,mo=.01;function bo(e,t,r=0,n=1){const s=(t==="up"?n-e:e-r)/Fe,o=(t==="up"?e-r:n-e)/Fe,i=s<1?s:1,a=o<1?o:1;return Math.max(Kn*i*a,mo)*(t==="up"?1:-1)}function wo({config:{bottom:e,top:t},state:{direction:r,position:{z:n}}},s,o){const i=e*Fe,a=t*Fe,l=bo(n,r,i,a),c=n<=i?"up":n>=a?"down":r;return{positionDelta:{z:l*o},stateDelta:{direction:c}}}const vo=(e,t,r)=>{const n=S(t);let s=U;const o=V(e),i=({positionDelta:a,stateDelta:l})=>{a!==void 0&&(s=_(s,a)),l!==void 0&&(e.state={...e.state,...l})};te(e)&&e.type===t.currentCharacterName&&(i(ao(e,t,r)),i(co(e,t,r)),i(so(e,t))),o&&i(to(e,t,r)),W("teleporter")(e)&&i(oo(e,t,n)),W("spring")(e)&&i(io(e,t,n)),W("lift")(e)&&i(wo(e,t,r)),Ee(s,U)||ut({subjectItem:e,xyzDeltaPartial:s,gameState:t,deltaMS:r})},Co=e=>{e.currentCharacterName=lt(e.currentCharacterName)},_o=e=>{const{currentCharacterName:t}=e,{room:r,entryState:n}=e.characterRooms[t],s=r.items[t],o=lt(t),i=s.state,a=s.state.lives-1;if(a===0){s.state.lives=a,e.characterRooms[t]=void 0,e.currentCharacterName=o;return}const l=Pe(e.campaign.rooms[r.id],e.pickupsCollected);e.characterRooms[t].room=l,s.state={...i,...n,expires:null,lives:a},kr(s,l.items),l.items[t]=s},ko=20,To=(e,t)=>e.state.expires!==null&&e.state.expires<t.gameTime,Oo=(e,t)=>{t.positionContainer!==void 0&&t.positionContainer.destroy(),delete e.items[t.id];for(const r of R(w(e.items)))V(r)&&r.state.standingOn===t&&(r.state.standingOn=null)},zo=e=>{for(const t of w(e.items)){const r=t.lastRenderedState.position;Ee(r,t.state.position)&&!Vn(t.state.position)&&(console.log(`snapping item ${t.id} to pixel grid`),t.state.position=Gn(t.state.position))}},Ao=(e,t)=>{const r=Math.ceil(t/ko),n=t/r,{inputState:s}=e;if(s.swop){Co(e),s.swop=!1;return}const o=S(e);for(const i of w(o.items))i.lastRenderedState={...i.state};for(let i=0;i<r;i++){e.gameTime+=n;for(const a of w(o.items))if(To(a,e))if(te(a)){_o(e);return}else Oo(o,a);for(const a of w(o.items)){if(Un(e).state.action==="death")break;vo(a,e,n)}}zo(o)},Po=e=>{if(e.lastRenderedState===void 0)return!0;switch(e.type){case"head":case"heels":return e.state.facing!==e.lastRenderedState.facing||e.state.action!==e.lastRenderedState.action||e.state.teleporting?.phase!==e.lastRenderedState.teleporting?.phase;case"teleporter":case"spring":return e.state.stoodOn!==e.lastRenderedState.stoodOn;case"block":case"barrier":case"fish":case"pickup":return e.state.expires!==e.lastRenderedState.expires;default:return!1}},So=(e,t,r,n)=>{const s=S(e);if(s!==t){console.log("will render from scratch",s.id,"since we currently have",t?.id),r.removeChildren(),r.label="world";const o=Js(e,n);r.addChild(o)}else{let o=!1;for(const i of w(s.items))i.renders&&(Po(i)&&$r(i,e),(i.lastRenderedState===void 0||!Ee(i.lastRenderedState.position,i.state.position))&&(Fr(i),o=!0));o&&Dr(Er(w(s.items)),s.items)}},$o=(e,t)=>{let r,n;const s=new k;s.label="world",s.y=G.height*.7,e.stage.addChild(s);const o=new k;e.stage.addChild(o);const i=new dt(N().shadow),a=eo(o),l=Qs(e),c=({deltaMS:d})=>{l.rescale(),s.x=e.renderer.width/l.curUpscale/2;const{renderOptions:f}=t;n!==f&&(console.log(`render options changed!          
          renderOptions: ${n} -> ${f}`),r=void 0,n=f),t.inputState.windowFocus?(e.stage.filters=[],Ao(t,d),So(t,r,s,f),a(t)):(e.stage.filters=i,i.targetColor=Ne[S(t).color].main.basic),r=S(t)};return{start(){return e.ticker.add(c),this},stop(){e.stage.removeChild(s),e.ticker.remove(c)}}},Fo=async e=>{const t={showBoundingBoxes:"none"},r=new lr;await r.init({background:"#000000",resizeTo:window});const n=gs(e,t),s=us(n),o=$o(r,n).start();return{campaign:e,events:n.events,renderIn(i){i.appendChild(r.canvas)},changeRoom(i){ct({gameState:n,toRoom:i,changeType:"level-select"})},get currentRoom(){return S(n)},get gameState(){return n},set renderOptions(i){n.renderOptions=i},stop(){console.warn("tearing down game"),r.canvas.parentNode?.removeChild(r.canvas),o.stop(),s(),r.destroy()}}},Eo=Object.freeze(Object.defineProperty({__proto__:null,gameMain:Fo},Symbol.toStringTag,{value:"Module"}));export{sr as A,tr as C,er as F,Nn as R,Mn as S,or as V,Eo as g,Fn as u};
