import{A as ge,F as we,H as M,I as Ie,J as z,K as Y,L as v,N as d,O,Q as A,W as De,X as oe,Y as ve,Z as xe,_ as B,$ as $e,a0 as T,a1 as _e,a2 as Xe,a3 as re,a4 as ke,a5 as We,a6 as le}from"./App-Bxk-C50Q.js";import{g as Ye}from"./index-CktktMKX.js";var $={},_={},ce;function Ve(){if(ce)return _;ce=1;var e=ge(),t=e.iterableCurry,s=e.callReturn;function i(a,n){var r=a[Symbol.iterator](),h=r.next(),f=h.value,u=h.done;return u?n:(s(r),f)}_.__firstOr=i;var o=t(i,{reduces:!0});return _.firstOr=o,_}var de;function Ge(){if(de)return $;de=1;var e=ge(),t=e.iterableCurry,s=Ve(),i=s.__firstOr;function o(n){return i(n,void 0)}$.__first=o;var a=t(o,{reduces:!0});return $.first=a,$}var j,ue;function Le(){return ue||(ue=1,j=Ge().first),j}var qe=Le();const Ze=Ye(qe),Gt=e=>e.characterRooms[e.currentCharacterName],l={w:16,d:16,h:12},pe={x:16,y:16,z:12},Qe=["head","heels"],Ue=[...Qe,"headOverHeels"],R=e=>e==="head"?"heels":"head",g=(...e)=>t=>e.includes(t.type),Ke=g("bubbles","stopAutowalk","floorEdge","firedDoughnut"),Je=(e,t)=>Ke(e)||E(e)&&(t!==void 0&&ze(t)||e.config.direction.z!==0)||it(e)&&e.config.type==="none",V=(e,t)=>!Je(e,t),je=(e,t=!1)=>G(e)&&!(!t&&ze(e)&&e.state.autoWalk),me=["ball","slidingBlock","slidingDeadly"],et=g(...me),tt=["portableBlock","spring","sceneryPlayer"],Lt=g(...tt),ze=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function G(e){return Te.includes(e.type)}const Te=[...Ue,"monster","ball","charles","movableBlock","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer"],st=["monster","deadlyBlock","moveableDeadly","slidingDeadly"],qt=e=>g(...st)(e)||e.type==="floor"&&e.config.type==="deadly",E=g("portal"),Zt=g("teleporter"),Qt=g("heels","headOverHeels"),Ut=g("head","headOverHeels"),Kt=g("lift"),Jt=g("monster"),it=g("floor"),jt=g("movableBlock"),es=g("pickup"),ts=g("spring"),ot=g("joystick"),ss=g("monster","movableBlock"),Oe=g("head"),Ne=g("heels"),L=g("headOverHeels"),N=(e,t)=>e.characterRooms[t]?.items[t],is=e=>N(e,e.currentCharacterName),os=e=>{if(Oe(e))return e.state;if(L(e))return e.state.head},at=e=>{if(Ne(e))return e.state;if(L(e))return e.state.heels},nt=(e,t)=>{const s=N(e,e.currentCharacterName==="headOverHeels"?"headOverHeels":t);if(s!==void 0){if(t==="head"&&Oe(s)||t==="heels"&&Ne(s))return s.state;if(t==="head"&&L(s))return s.state.head;if(t==="heels"&&L(s))return s.state.heels}},as=nt,ns=(e,t)=>{const s=C(e);return t.x=s.x,t.y=s.y,t},rt=({x:e=0,y:t=0,z:s=0})=>({x:t-e,y:-(e+t)/2-s}),p=({x:e=0,y:t=0,z:s=0})=>({x:e*l.w,y:t*l.d,z:s*l.h}),C=e=>rt(p(e)),w=we/1e3,rs={head:15e-5,heels:15e-5},lt=2e-4,ct={head:l.h*2/1e3,others:l.h*6/1e3},ls=lt*.35,cs=ct.others*.5,ds=.8,us=.001,ps={head:w,heels:2*w,charles:w,dalek:Math.SQRT2*w,cyberman:1*w,skiHead:w,helicopterBug:w,homingBot:2*w,monkey:w,elephant:w,elephantHead:0,emperor:w,emperorsGuardian:Math.SQRT2*w,bubbleRobot:w,computerBot:w,turtle:w,ball:2*w,firedDoughnut:2*w,movableBlock:w},dt=(e=1)=>e*we/1e3,hs=dt(),fs=2,ys={head:l.h*2.6,heels:l.h},J=11,bs=6e4,gs=9999,he=8,ws=750,vs=2500,xs=150,k={x:12,y:12,z:l.h},ut={x:14,y:14,z:l.h},P={x:16,y:16,z:l.h},W={...k,z:l.h*2},Pe=50,q=1,Z={x:l.w,y:l.d*q,z:J*l.h},Be={x:Z.x,y:0,z:Pe},Q={x:l.w*q,y:l.d,z:J*l.h},Ae={x:0,y:Q.y,z:Pe},Me=e=>{switch(e.type){case"spring":case"portableBlock":case"moveableDeadly":case"slidingDeadly":case"firedDoughnut":return{aabb:k};case"slidingBlock":return e.config.style==="book"?{aabb:P}:{aabb:k};case"lift":return{aabb:{...k,z:k.z}};case"switch":return{aabb:{...k,z:k.z}};case"pickup":return e.config.gives==="scroll"?{aabb:{x:16,y:4,z:13}}:{aabb:k};case"charles":return{aabb:W};case"ball":return{aabb:{x:12,y:12,z:12}};case"movableBlock":return{aabb:P};case"block":switch(e.config.style){case"artificial":case"organic":case"book":return{aabb:P};case"tower":return{aabb:{x:11,y:11,z:l.h}};default:throw new Error("unknown block style")}case"monster":switch(e.config.which){case"skiHead":return{aabb:{...k,z:21}};case"bubbleRobot":case"cyberman":case"elephant":case"emperorsGuardian":case"monkey":case"computerBot":return{aabb:W};case"helicopterBug":case"dalek":return{aabb:k};default:return{aabb:P}}case"deadlyBlock":switch(e.config.style){case"toaster":return{aabb:{...P,y:P.y}};case"spikes":case"volcano":return{aabb:P}}break;case"bubbles":return{aabb:k};case"conveyor":case"hushPuppy":case"teleporter":return{aabb:P};case"barrier":return{aabb:e.config.axis==="y"?{x:3,y:15,z:l.h}:{x:15,y:3,z:l.h}};case"wall":return e.config.side==="left"||e.config.side==="right"?{aabb:Q,renderAabb:Ae}:{aabb:Z,renderAabb:Be};case"sceneryPlayer":return e.config.which==="headOverHeels"?{aabb:W}:{aabb:k};default:return{aabb:ut}}},pt=(e,t)=>{const s={x:1,y:1,z:1,...t},i=M(pe,e);return M(Ie(s,pe),i)},b={renders:!0,aabb:k};function*ht(e){for(let t=e.size.y-1;t>=0;t--){const s=e.walls.left[t];s!=="none"&&(yield{...b,type:"wall",id:`wall-left-${t}`,config:{side:"left",style:s},state:{position:{...p({x:e.size.x,y:t,z:0}),z:0},expires:null,stoodOnBy:z,disappear:null},aabb:Q,renderAabb:Ae}),Object.values(e.items).find(o=>o.type==="door"&&Y(o.config.direction)==="y"&&o.position.x===0&&(o.position.y===t||o.position.y+1===t))!==void 0||(yield{...b,type:"wall",id:`wall-right-${t}`,config:{side:"right",style:"none"},shadowCastTexture:"shadow.wall.y",state:{position:p({x:-q,y:t,z:0}),expires:null,stoodOnBy:z,disappear:null},aabb:Q,renders:!1})}for(let t=e.size.x-1;t>=0;t--){const s=e.walls.away[t];s!=="none"&&(yield{...b,type:"wall",id:`wall-away-${t}`,config:{side:"away",style:s},state:{position:{...p({x:t,y:e.size.y,z:0}),z:0},expires:null,stoodOnBy:z,disappear:null},aabb:Z,renderAabb:Be}),Object.values(e.items).find(o=>o.type==="door"&&Y(o.config.direction)==="x"&&(o.position.x===t||o.position.x+1===t)&&o.position.y===0)!==void 0||(yield{...b,type:"wall",id:`wall-towards-${t}`,config:{side:"towards",style:"none"},shadowCastTexture:{texture:"shadow.wall.y",flipX:!0},state:{position:p({x:t,y:-q,z:0}),expires:null,stoodOnBy:z,disappear:null},aabb:Z,renders:!1})}}const ft=({config:{direction:e},position:t})=>e==="right"&&t.x===0||e==="towards"&&t.y===0,ee=l.h*2,yt=4,X=l.h*4;function*bt(e,t){const{config:{direction:s},position:i}=e,o=Y(s),a=De(o),n=ft(e),r={...v,[a]:n?-.5:0},h=1,f={[a]:n?-h:0},u={[a]:h*l.w},x=9,c=8,y=8;yield{...e,...b,type:"doorFrame",id:`${t}/far`,config:{...e.config,inHiddenWall:n,part:"far"},state:{position:p(d(i,{[o]:1.5},r,f)),expires:null,stoodOnBy:z,disappear:null},aabb:d({[o]:c,[a]:y,z:X},u)},yield{...e,...b,type:"doorFrame",id:`${t}/near`,config:{...e.config,inHiddenWall:n,part:"near"},state:{position:p(d(i,r,f)),expires:null,stoodOnBy:z,disappear:null},aabb:d({[o]:x,[a]:y,z:X},u)},yield{...e,...b,type:"doorFrame",id:`${t}/top`,config:{...e.config,inHiddenWall:n,part:"top"},state:{position:d(p(d(i,r,f)),{[o]:x,z:ee}),expires:null,stoodOnBy:z,disappear:null},aabb:d({[o]:2*l.w-x-c,[a]:y,z:X-ee},u)},yield{...e,...b,id:`${t}/wall`,config:{style:"none",side:"away"},renders:!1,type:"wall",state:{position:d(p(d(i,r)),{z:X}),expires:null,stoodOnBy:z,disappear:null},aabb:p({[o]:2,[a]:.5,z:J-yt})},yield{...e,...b,type:"portal",id:`${t}/portal`,config:{...e.config,inHiddenWall:n,relativePoint:p({...v,[a]:n?.25:-.25}),direction:O[s]},renders:!1,state:{position:d(p(d(i,{[a]:n?-.5:.5})),{[o]:x}),expires:null,stoodOnBy:z,disappear:null},aabb:{[o]:2*l.w-x-c,[a]:0,z:ee}},i.z!==0&&(yield{...e,...b,type:"doorLegs",id:`${t}/legs`,config:{...e.config,inHiddenWall:n,style:"none",side:"away",height:i.z},renders:!0,shadowCastTexture:n?"shadow.door.floatingThreshold.double.y":void 0,shadowMask:{spriteOptions:{texture:n?"shadowMask.door.floatingThreshold.double.y":"shadowMask.door.legs.threshold.double.y",flipX:o==="x"},relativeTo:"top"},state:{position:{...p(d(i,r,f)),z:0},expires:null,stoodOnBy:new Set,disappear:null},aabb:d(p({[o]:2,[a]:.5,z:i.z}),u)}),yield{type:"stopAutowalk",id:`${t}/stopAutowalk`,renders:!1,aabb:p({[o]:2,[a]:0,z:2}),config:{},state:{position:p(M(i,A(O[s],.75))),expires:null,stoodOnBy:z,disappear:null}}}const se=e=>{const t=p(e.position),{aabb:s}=Me(e);if(s===void 0)throw new Error(`item type= ${e.type} config=${JSON.stringify(e.config)} has no bounding box`);return e.type==="wall"?t:d(t,{x:l.w-s.x>>1,y:l.d-s.y>>1})},F=()=>({expires:null,stoodOnBy:new Set,disappear:null}),S=()=>({standingOn:null,vels:{gravity:v,movingFloor:v},latentMovement:[]}),gt=e=>{const t=Te.includes(e.type);return{...F(),position:se(e),...t?{standingOn:null,vels:{gravity:v,movingFloor:v,...me.includes(e.type)?{sliding:v}:{},...(e.type==="monster"||e.type==="movableBlock")&&e.config.movement&&e.config.movement!=="free"?{walking:v}:{}},latentMovement:[]}:{},...e.type==="monster"?{activated:e.config.activated,timeOfLastDirectionChange:Number.NEGATIVE_INFINITY,...e.config.which==="skiHead"||e.config.which==="turtle"||e.config.which==="elephantHead"||e.config.which==="cyberman"?{facing:O[e.config.startDirection]}:{facing:O.towards}}:{},...e.type==="pickup"?{collected:!1,disappear:"onTouchByPlayer"}:{},...e.type==="movableBlock"&&e.config.movement!=="free"?{activated:e.config.activated===!0,facing:O[e.config.startDirection]}:{},...e.type==="switch"?{setting:"left",touchedOnProgression:-1}:{},...e.type==="block"?{disappear:e.config.disappearing??null}:{},...e.type==="conveyor"?{disappear:e.config.disappearing??null}:{},...e.type==="barrier"?{disappear:e.config.disappearing??null}:{},...e.type==="lift"?{direction:"up",vels:{lift:v}}:{},...e.type==="charles"?{facing:O.towards}:{}}},U={config:ve,shadowCastTexture:"shadow.smallRound",aabb:k},I=()=>({action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:O.towards,walkStartFacing:O.towards,walkDistance:0,vels:{walking:v,gravity:v,movingFloor:v},actedOnAt:Number.NEGATIVE_INFINITY}),wt=e=>{const{infiniteLivesPoke:t}=oe.getState().userSettings;return e.config.which==="head"?{id:"head",type:"head",...b,...U,state:{...F(),...S(),...I(),hasHooter:!1,gameWalkDistance:0,fastStepsStartedAtDistance:Number.NEGATIVE_INFINITY,lives:t?Number.POSITIVE_INFINITY:he,shieldCollectedAt:Number.NEGATIVE_INFINITY,doughnuts:0,doughnutLastFireTime:Number.NEGATIVE_INFINITY,switchedToAt:Number.NEGATIVE_INFINITY,position:se(e),lastDiedAt:Number.NEGATIVE_INFINITY,gameTime:0}}:{id:"heels",type:"heels",...b,...U,state:{...F(),...S(),...I(),carrying:null,hasBag:!1,bigJumps:0,lives:t?Number.POSITIVE_INFINITY:he,shieldCollectedAt:Number.NEGATIVE_INFINITY,switchedToAt:Number.NEGATIVE_INFINITY,position:se(e),lastDiedAt:Number.NEGATIVE_INFINITY,gameTime:0}}};function*Fe(e,t,s,i={}){if(!s[e]&&!(t.type==="pickup"&&t.config.gives==="scroll"&&i[t.config.page]))switch(t.type){case"door":return yield*bt(t,e);case"player":{yield wt(t);return}default:{const o=Me(t),a=t.config.times!==void 0?{aabb:pt(o.aabb,t.config.times),renderAabb:void 0}:o;yield{...t,...b,...a,renders:!(t.type==="wall"&&(t.config.side==="right"||t.config.side==="towards")),shadowMask:vt(t),shadowCastTexture:xt(t),id:e,config:t.config,state:gt(t)}}}}const vt=e=>{switch(e.type){case"lift":return{spriteOptions:"shadowMask.smallBlock",relativeTo:"origin"};case"conveyor":return{spriteOptions:{texture:"shadowMask.conveyor",flipX:xe(e.config.direction)==="x"},relativeTo:"origin"};case"barrier":return{spriteOptions:{texture:"shadowMask.barrier.y",flipX:e.config.axis==="x"},relativeTo:"origin"};case"spring":return{spriteOptions:"shadowMask.smallRound",relativeTo:"origin"};case"block":return{spriteOptions:e.config.style==="tower"?"shadowMask.tower":"shadowMask.fullBlock",relativeTo:"origin"};case"movableBlock":return{spriteOptions:e.config.style==="stepStool"?"shadowMask.stepStool":"shadowMask.fullBlock",relativeTo:"origin"};case"teleporter":return{spriteOptions:"shadowMask.teleporter",relativeTo:"origin"};case"hushPuppy":return{spriteOptions:"shadowMask.hushPuppy",relativeTo:"origin"};case"portableBlock":return{spriteOptions:e.config.style==="drum"?"shadowMask.smallRound":"shadowMask.smallBlock",relativeTo:"origin"};case"slidingBlock":return{spriteOptions:e.config.style==="book"?"shadowMask.fullBlock":"shadowMask.smallRound",relativeTo:"origin"};case"deadlyBlock":switch(e.config.style){case"volcano":return{spriteOptions:"shadowMask.volcano",relativeTo:"origin"};case"toaster":return{spriteOptions:"shadowMask.fullBlock",relativeTo:"origin"};case"spikes":return{spriteOptions:"shadowMask.spikes",relativeTo:"origin"};default:e.config.style}break;case"switch":return{spriteOptions:"shadowMask.switch",relativeTo:"origin"};case"pickup":return e.config.gives==="scroll"?{spriteOptions:"shadowMask.scroll",relativeTo:"origin"}:void 0;case"slidingDeadly":return{spriteOptions:"shadowMask.smallRound",relativeTo:"origin"};case"monster":switch(e.config.which){case"dalek":return{spriteOptions:"shadowMask.dalek",relativeTo:"origin"};default:return}case"joystick":return{spriteOptions:"shadowMask.joystick",relativeTo:"origin"}}},xt=e=>{switch(e.type){case"lift":return"shadow.smallBlock";case"conveyor":return{texture:"shadow.fullBlock",flipX:xe(e.config.direction)==="x"};case"barrier":return{texture:"shadow.barrier.y",flipX:e.config.axis==="x"};case"spring":return"shadow.smallRound";case"block":return e.config.style==="tower"?"shadow.smallRound":"shadow.fullBlock";case"movableBlock":case"hushPuppy":case"deadlyBlock":return"shadow.fullBlock";case"portableBlock":return e.config.style==="drum"?"shadow.smallRound":"shadow.smallBlock";case"pickup":return e.config.gives==="scroll"?"shadow.scroll":"shadow.smallRound";case"monster":return"shadow.smallRound"}},Ee=({aabb:e,state:{position:t}},{aabb:s,state:{position:i}})=>!(t.x+e.x<=i.x||t.x>=i.x+s.x)&&!(t.y+e.y<=i.y||t.y>=i.y+s.y)&&!(t.z+e.z<=i.z||t.z>=i.z+s.z),ae=(e,t)=>[...B(t).filter(s=>e.id!==s.id&&Ee(e,s))],kt=e=>{const t={},s=Object.values(e.items).filter(i=>i.type==="door");for(const{config:{direction:i},position:{x:o,y:a}}of s)Y(i)==="x"?a===0?t.towards=!0:a===e.size.y&&(t.away=!0):o===0?t.right=!0:o===e.size.x&&(t.left=!0);return t},Ce=e=>{const t=kt(e),s=t.right?-.5:0,i=e.size.x+(t.left?.5:0),o=t.towards?-.5:0,a=e.size.y+(t.away?.5:0);return{blockXMin:s,blockXMax:i,blockYMin:o,blockYMax:a,sidesWithDoors:t}},ks=e=>{const{blockXMax:t,blockXMin:s,blockYMax:i,blockYMin:o,sidesWithDoors:a}=Ce(e),n=C({x:e.size.x+(a.right?.5:0),y:-o}).x,r=C({x:-s,y:e.size.y+(a.towards?.5:0)}).x,h=C({x:e.size.x,y:e.size.y}).y,f=C({x:s,y:o}),u=C({x:t,y:i});return{blockXMin:s,blockXMax:t,blockYMin:o,blockYMax:i,edgeLeftX:n,edgeRightX:r,topEdgeY:h,frontSide:f,backSide:u,sidesWithDoors:a}};function*mt(e){const t=e.size.z??J,s=p({...e.size,z:1}),{blockXMax:i,blockXMin:o,blockYMax:a,blockYMin:n}=Ce(e),r=p({x:i-o,y:a-n,z:1}),h=p({...$e,z:-1}),f=p({x:o,y:n,z:-1});if(yield{id:"floorEdge",...b,type:"floorEdge",state:{...F(),position:{...f,z:0}},aabb:v,config:{},fixedZIndex:9999},e.floor==="none"&&e.roomBelow!==void 0?(yield{...b,type:"floor",id:"floor",config:{type:"none"},aabb:s,shadowMask:void 0,state:{position:f,expires:null,stoodOnBy:new Set,disappear:null},renders:!0,fixedZIndex:-1},yield{...b,type:"portal",id:"floor/portal",config:{toRoom:e.roomBelow,relativePoint:{x:s.x/2,y:s.y/2,z:s.z},direction:O.down},aabb:s,state:{position:h,expires:null,stoodOnBy:new Set,disappear:null},renders:!1}):yield{...b,type:"floor",id:"floor",config:{type:e.floor==="deadly"?"deadly":"standable"},aabb:r,shadowMask:{relativeTo:"origin"},state:{position:f,expires:null,stoodOnBy:new Set,disappear:null},renders:!0,fixedZIndex:-1},e.roomAbove!==void 0){const u=d(h,{z:l.h*t});yield{...b,type:"portal",id:"ceiling",config:{toRoom:e.roomAbove,relativePoint:{...e.ceilingRelativePoint!==void 0?p(e.ceilingRelativePoint):{x:s.x/2,y:s.y/2},z:-l.h},direction:O.up},aabb:s,state:{position:u,expires:null,stoodOnBy:new Set,disappear:null},renders:!1}}}function*zt(e,t,s){const{scrollsRead:i}=oe.getState(),o=_e(e.items);for(const[a,n]of o)n.type==="player"&&!s||(yield*Fe(a,n,t,i))}const te=e=>B(e).reduce((t,s)=>({...t,[s.id]:s}),{}),Tt=(e,t,s=!1)=>{const i={...te(mt(e)),...te(ht(e)),...te(zt(e,t,s))};for(const a of T(i)){const r=ae(a,T(i)).find(h=>V(a)&&V(h)&&!(a.type==="wall"&&h.type==="wall"));if(r!==void 0)throw new Error(`item ${a.id} @${JSON.stringify(a.state.position)} #${JSON.stringify(a.aabb)} is colliding with (solid item) ${r.id} @${JSON.stringify(r.state.position)} #${JSON.stringify(r.aabb)} on loading room ${e.id}`)}return{...e,roomJson:e,items:{...i},roomTime:0}},Ot=({state:{position:e,facing:t,autoWalk:s,action:i,vels:o}})=>({position:e,facing:t,autoWalk:s,action:i,vels:{...o}}),ie=e=>{e.state.standingOn!==null&&e.state.standingOn.state.stoodOnBy.delete(e),e.state.standingOn=null},Re=({above:e,below:t})=>{e.state.standingOn=t,t.state.stoodOnBy.add(e)},H=({room:e,item:t})=>{const s=typeof t=="string"?e.items[t]:t;typeof t=="string"?delete e.items[t]:delete e.items[s.id],G(s)&&ie(s);for(const i of s.state.stoodOnBy)ie(i)};let Nt=0;const Pt=({gameState:e,room:t,itemType:s,config:i,position:o})=>{const a={type:s,config:i,position:v},n=`${s}/${Nt++}`,r=Ze(Fe(n,a,e.pickupsCollected[t.id]));if(r===void 0)throw new Error("failed to generate any items");return r.state.position=o,K({room:t,item:r}),r},K=({room:e,item:t})=>(e.items[t.id]=t,t),Bt=1e3/25,He=e=>{const t=Xe.animations[e],s=t.length,{animationSpeed:i}=t;return s*Bt/i};He("bubbles.white");const At=He("head.fadeOut"),Mt=({touchedItem:e,room:t,gameState:s})=>{H({room:t,item:e});const i=Pt({itemType:"bubbles",config:{style:"white"},position:v,room:t,gameState:s}),o=d(e.state.position,A(e.aabb,.5));i.state.position=M(o,A(i.aabb,.5)),i.state.expires=t.roomTime+At},Ft=(e,t)=>{const s=B(T(e.items)).filter(g("hushPuppy"));for(const i of s)Mt({touchedItem:i,gameState:t,room:e})},Et=.5,fe=(e,t,s,i)=>{const o=s.x+i.x-e.x,a=s.y+i.y-e.y,n=s.z+i.z-e.z,r=e.x+t.x-s.x,h=e.y+t.y-s.y,f=e.z+t.z-s.z,u=Math.abs(o)<Math.abs(r)?o:-r,x=Math.abs(a)<Math.abs(h)?a:-h,c=Math.abs(n)<Math.abs(f)?n:-f,y=Math.abs(u),m=Math.abs(x),D=Math.abs(c)*Et;return y<m&&y<D?{x:u,y:0,z:0}:m<D?{x:0,y:x,z:0}:{x:0,y:0,z:c}},ye=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),be={stopAutowalk:0,portal:0,wall:0,doorLegs:0,sceneryPlayer:0,bubbles:0,switch:1,block:2,barrier:2,floor:2,floorEdge:2,hushPuppy:2,teleporter:2,doorFrame:2,lift:3,movableBlock:3,portableBlock:3,slidingBlock:3,spring:3,ball:4,joystick:4,charles:4,conveyor:4,head:5,heels:5,headOverHeels:5,pickup:8,firedDoughnut:9,slidingDeadly:10,moveableDeadly:10,deadlyBlock:10,monster:10},Ct=(e,t)=>be[e.type]-be[t.type],Rt=(e,t)=>t.toSorted((s,i)=>{const o=Ct(s,i);if(o!==0)return o;const a=re(e,ye(e,s)),n=re(e,ye(e,i));return Math.abs(a-n)<1e-4?s.id<i.id?-1:1:a-n}),Se=({subjectItem:e,posDelta:t,gameState:s,room:i,pusher:o,deltaMS:a,forceful:n=g("lift")(e)&&o===void 0,recursionDepth:r=0,onTouch:h})=>{if(ke(t,v))return;if(r>24)throw new Error("this probably means a non-terminating issue, or you're testing by adding an unreasonable number of items to a room");const{state:{position:f}}=e;e.state.position=d(f,t),G(e)&&(e.state.actedOnAt=i.roomTime);const u=Rt(t,ae(e,T(i.items)));let x=!1;for(const c of u){if(!Ee(e,c))continue;const y=ot(c);if(o!==c&&!(x&&y)&&h!==void 0&&(h({movingItem:e,touchedItem:c,movementVector:M(e.state.position,f),gameState:s,deltaMS:a,room:i}),x=x||y),i.items[e.id]===void 0)return;if(i.items[c.id]===void 0||!V(c,e)||!V(e))continue;const m=fe(e.state.position,e.aabb,c.state.position,c.aabb);if(je(c,n)&&c!==o){const D=n||et(c)?-1:-.5,ne=A(m,D);if(e.state.position=d(e.state.position,m,ne),Se({subjectItem:c,posDelta:ne,pusher:e,gameState:s,room:i,deltaMS:a,forceful:n,recursionDepth:r+1,onTouch:h}),i.items[c.id]===void 0)continue;e.state.position=d(e.state.position,fe(e.state.position,e.aabb,c.state.position,c.aabb))}else e.state.position=d(e.state.position,m);G(e)&&m.z>0&&(e.state.standingOn===null||!u.includes(e.state.standingOn))&&(ie(e),Re({above:e,below:c}))}},Ht=(e,t,{changeType:s,sourceItem:i})=>{switch(s){case"portal":return B(T(e.items)).find(o=>E(o)&&o.config.toRoom===t.id&&ke(A(i.config.direction,-1),o.config.direction));case"level-select":return B(T(e.items)).find(o=>E(o)&&o.config.toRoom===t.id&&o.config.direction.z===0)??B(T(e.items)).find(o=>E(o)&&o.config.direction.z===0)??B(T(e.items)).find(o=>E(o)&&o.config.direction.z>0)??B(T(e.items)).find(E)}},St=(e,t,s,i)=>{const o=1*l.w;e.state.position=d(e.state.position,A(t,o));for(let a=0;a<o;a++)Se({subjectItem:e,posDelta:A(t,-1),gameState:s,room:i,deltaMS:16,forceful:!0,onTouch:void 0})},ms=e=>{const{playableItem:t,gameState:s,toRoomId:i,changeType:o,sourceItem:a}=e,n=s.characterRooms[t.id];if(n===void 0)throw new Error(`${t.id} is not in a room on the gameState`);if(i===n.id)throw new Error(`Can't move ${t.id} to the same room "${i}""`);let r;switch(o){case"portal":{const{config:{relativePoint:y},state:{position:m}}=a;r=M(t.state.position,d(m,y));break}case"teleport":{const{state:{position:y}}=a;r=M(t.state.position,y);break}case"level-select":r={x:0,y:0,z:0};break;default:throw new Error}const h=t.type==="headOverHeels"?void 0:s.characterRooms[R(t.id)],f=s.campaign.rooms[i];if(f===void 0)throw new Error(`room ${i} does not exist in campaign`);const u=h?.id===i?h:Tt(f,s.pickupsCollected[i]);H({room:n,item:t});const x=at(t);if(x!==void 0&&(x.carrying=null),(t.type==="head"||t.type==="headOverHeels")&&Ft(u,s),H({room:u,item:t}),u.items[t.id]=t,s.characterRooms[t.id]=u,e.changeType==="teleport"){const{config:{toPosition:y}}=e.sourceItem;t.state.position=d(p(y),r)}else{const y=Ht(u,n,e);if(console.log("putting",t.id,"into",i,"at portal",y,"because",o,"sourceportal",a),y===void 0)if(e.changeType==="level-select")t.state.position=p({x:1,y:1,z:8});else throw new Error(`trying to move ${t.id} from ${n.id} --to-> ${i} but no destination portal found to locate with`);else{t.state.position=d(y.state.position,y.config.relativePoint,r,o==="portal"&&a.config.direction.z>0?{z:l.h}:{});const{config:{direction:m}}=y;m.z===0&&(t.state.autoWalk=!0,t.state.facing=A(m,-1),t.state.action==="idle"&&(t.state.action="moving"),St(t,m,s,u))}}const c=ae(t,T(u.items));c.length>0&&console.warn("on entering room",i,"character",t.id,"at",t.state.position,"collides with",c),s.entryState[t.id]=Ot(t),t.id==="headOverHeels"?(delete s.entryState.head,delete s.entryState.heels):(s.entryState[R(t.id)]||(s.entryState[R(t.id)]=s.entryState.headOverHeels),delete s.entryState.headOverHeels),oe.dispatch(We(i))},It=e=>{const t=N(e,"head"),s=N(e,"heels");return t!==void 0&&s!==void 0&&t.state.action==="idle"&&s.state.action==="idle"&&t.state.standingOn===s},Dt=e=>{const t={id:"head",type:"head",...b,...U,state:{...F(),...S(),...I(),...e.state.head,facing:e.state.facing,position:d(e.state.position,{z:l.h}),switchedToAt:Number.NEGATIVE_INFINITY,actedOnAt:e.state.actedOnAt}},s={id:"heels",type:"heels",...b,...U,state:{...F(),...S(),...I(),...e.state.heels,facing:e.state.facing,position:d(e.state.position),switchedToAt:Number.NEGATIVE_INFINITY,actedOnAt:e.state.actedOnAt}};return{head:t,heels:s}},$t=({head:e,heels:t})=>({type:"headOverHeels",id:"headOverHeels",...b,shadowCastTexture:t.shadowCastTexture,config:ve,aabb:W,state:{...F(),...S(),...I(),position:t.state.position,action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:t.state.facing,actedOnAt:Math.max(t.state.actedOnAt,t.state.actedOnAt),head:{...le(e.state,"hasHooter","doughnuts","doughnutLastFireTime","fastStepsStartedAtDistance","gameWalkDistance","lives","gameTime","shieldCollectedAt","lastDiedAt"),switchedToAt:Number.NEGATIVE_INFINITY},heels:{...le(t.state,"hasBag","bigJumps","carrying","lives","gameTime","shieldCollectedAt","lastDiedAt"),switchedToAt:Number.NEGATIVE_INFINITY}}}),_t=e=>{const t=e.characterRooms.head,s=N(e,"head"),i=N(e,"heels"),o=$t({head:s,heels:i});H({room:t,item:"head"}),H({room:t,item:"heels"}),K({room:t,item:o}),e.previousPlayable=e.currentCharacterName,e.currentCharacterName="headOverHeels",e.characterRooms={head:void 0,heels:void 0,headOverHeels:t}},Xt=e=>{const t=e.characterRooms.headOverHeels,s=N(e,"headOverHeels"),i=R(e.previousPlayable),{head:o,heels:a}=Dt(s);H({room:t,item:"headOverHeels"}),K({room:t,item:o}),K({room:t,item:a}),Re({above:o,below:a}),e.currentCharacterName=i,e.previousPlayable=void 0,e.characterRooms={head:t,heels:t,headOverHeels:void 0}},Wt=e=>{const t=N(e,e.currentCharacterName);t!==void 0&&(t.type==="headOverHeels"?(t.state.head.switchedToAt=t.state.head.gameTime,t.state.heels.switchedToAt=t.state.heels.gameTime):t.state.switchedToAt=t?.state.gameTime)},zs=e=>{if(It(e))_t(e);else if(e.currentCharacterName==="headOverHeels")Xt(e);else{if(N(e,R(e.currentCharacterName))===void 0)return;e.currentCharacterName=R(e.currentCharacterName)}Wt(e)};export{Qt as $,us as A,ps as B,ds as C,rs as D,jt as E,ls as F,cs as G,At as H,hs as I,vs as J,Jt as K,fe as L,Ee as M,Ct as N,at as O,os as P,qt as Q,Bt as R,Re as S,Mt as T,me as U,Lt as V,Se as W,H as X,ae as Y,b as Z,K as _,G as a,Ut as a0,Kt as a1,ss as a2,Dt as a3,$t as a4,Ft as a5,ie as a6,zs as a7,rt as a8,ws as a9,xs as aa,ns as ab,ks as ac,gs as ad,is as b,ms as c,_t as d,N as e,Pt as f,l as g,Ot as h,g as i,bs as j,Qe as k,Tt as l,as as m,It as n,R as o,C as p,V as q,lt as r,Gt as s,ct as t,ts as u,Zt as v,es as w,ze as x,ys as y,fs as z};
