const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-CGGLXk_j.js","assets/index-GaMJuGQ-.js","assets/index-DfM27KQC.css","assets/colorToUniform-CnW6i02l.js","assets/SharedSystems-Dcmlim_8.js","assets/Graphics-tdkYcaeU.js","assets/WebGLRenderer-wm6-WAhx.js"])))=>i.map(i=>d[i]);
import{u as sr,y as or,z as Ye,e as qe,E as oe,c as ir,C as g,d as we,v as ve,Y as x,D as Be,a4 as tt,K as xe,a as le,b as ce,U as ar,V as lr,a5 as cr,a6 as dr,a7 as ur,a8 as St,a9 as At,aa as hr,ab as Xe,ac as rt,ad as Ne,ae as U,af as fr,ag as m,ah as Ft,ai as pr,aj as N,ak as me,al as R,am as mr,an as Pe,ao as Me,ap as gr,aq as nt,ar as be,as as yr,at as q,au as wr,av as st,aw as ge,ax as vr,ay as xr,az as ne,aA as br,aB as C,aC as y,aD as ae,aE as Cr,aF as ot,aG as A,aH as Ee,aI as Tr,aJ as Le,aK as J,aL as Ie,aM as $,aN as _r,aO as Mt,aP as de,aQ as kr,aR as Oe,aS as I,aT as Pr,aU as Or,aV as Ce,aW as Se,aX as Z,aY as De,aZ as Te,a_ as Ue,a$ as Sr,b0 as Je,b1 as F,b2 as ie,b3 as Et,b4 as Ze,b5 as it,b6 as Ar,b7 as Dt,b8 as G,b9 as zt,ba as W,bb as Fr,bc as Mr,bd as Er,be as Rt,bf as Dr,bg as zr,bh as Rr,bi as $r,bj as K,bk as Br}from"./index-GaMJuGQ-.js";import{S as Xr,G as Y}from"./Graphics-tdkYcaeU.js";const $t=class Ve extends sr{constructor(t){t={...Ve.defaultOptions,...t},super(t),this.enabled=!0,this._state=Xr.for2d(),this.blendMode=t.blendMode,this.padding=t.padding,typeof t.antialias=="boolean"?this.antialias=t.antialias?"on":"off":this.antialias=t.antialias,this.resolution=t.resolution,this.blendRequired=t.blendRequired,this.addResource("uTexture",0,1)}apply(t,r,n,s){t.applyFilter(this,r,n,s)}get blendMode(){return this._state.blendMode}set blendMode(t){this._state.blendMode=t}static from(t){const{gpu:r,gl:n,...s}=t;let o,i;return r&&(o=or.from(r)),n&&(i=Ye.from(n)),new Ve({gpuProgram:o,glProgram:i,...s})}};$t.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1};let Bt=$t;const je=[];qe.handleByNamedList(oe.Environment,je);async function Nr(e){if(!e)for(let t=0;t<je.length;t++){const r=je[t];if(r.value.test()){await r.value.load();return}}}let Q;function Lr(){if(typeof Q=="boolean")return Q;try{Q=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{Q=!1}return Q}var Xt=(e=>(e[e.NONE=0]="NONE",e[e.COLOR=16384]="COLOR",e[e.STENCIL=1024]="STENCIL",e[e.DEPTH=256]="DEPTH",e[e.COLOR_DEPTH=16640]="COLOR_DEPTH",e[e.COLOR_STENCIL=17408]="COLOR_STENCIL",e[e.DEPTH_STENCIL=1280]="DEPTH_STENCIL",e[e.ALL=17664]="ALL",e))(Xt||{});class Ir{constructor(t){this.items=[],this._name=t}emit(t,r,n,s,o,i,a,c){const{name:l,items:u}=this;for(let h=0,f=u.length;h<f;h++)u[h][l](t,r,n,s,o,i,a,c);return this}add(t){return t[this._name]&&(this.remove(t),this.items.push(t)),this}remove(t){const r=this.items.indexOf(t);return r!==-1&&this.items.splice(r,1),this}contains(t){return this.items.indexOf(t)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const Ur=["init","destroy","contextChange","resolutionChange","reset","renderEnd","renderStart","render","update","postrender","prerender"],Nt=class Lt extends ir{constructor(t){super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=t.type,this.name=t.name,this.config=t;const r=[...Ur,...this.config.runners??[]];this._addRunners(...r),this._unsafeEvalCheck()}async init(t={}){const r=t.skipExtensionImports===!0?!0:t.manageImports===!1;await Nr(r),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const n in this._systemsHash)t={...this._systemsHash[n].constructor.defaultOptions,...t};t={...Lt.defaultOptions,...t},this._roundPixels=t.roundPixels?1:0;for(let n=0;n<this.runners.init.items.length;n++)await this.runners.init.items[n].init(t);this._initOptions=t}render(t,r){let n=t;if(n instanceof g&&(n={container:n},r&&(we(ve,"passing a second argument is deprecated, please use render options instead"),n.target=r.renderTexture)),n.target||(n.target=this.view.renderTarget),n.target===this.view.renderTarget&&(this._lastObjectRendered=n.container,n.clearColor=this.background.colorRgba),n.clearColor){const s=Array.isArray(n.clearColor)&&n.clearColor.length===4;n.clearColor=s?n.clearColor:x.shared.setValue(n.clearColor).toArray()}n.transform||(n.container.updateLocalTransform(),n.transform=n.container.localTransform),this.runners.prerender.emit(n),this.runners.renderStart.emit(n),this.runners.render.emit(n),this.runners.renderEnd.emit(n),this.runners.postrender.emit(n)}resize(t,r,n){const s=this.view.resolution;this.view.resize(t,r,n),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),n!==void 0&&n!==s&&this.runners.resolutionChange.emit(n)}clear(t={}){const r=this;t.target||(t.target=r.renderTarget.renderTarget),t.clearColor||(t.clearColor=this.background.colorRgba),t.clear??(t.clear=Xt.ALL);const{clear:n,clearColor:s,target:o}=t;x.shared.setValue(s??this.background.colorRgba),r.renderTarget.clear(o,n,x.shared.toArray())}get resolution(){return this.view.resolution}set resolution(t){this.view.resolution=t,this.runners.resolutionChange.emit(t)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...t){t.forEach(r=>{this.runners[r]=new Ir(r)})}_addSystems(t){let r;for(r in t){const n=t[r];this._addSystem(n.value,n.name)}}_addSystem(t,r){const n=new t(this);if(this[r])throw new Error(`Whoops! The name "${r}" is already in use`);this[r]=n,this._systemsHash[r]=n;for(const s in this.runners)this.runners[s].add(n);return this}_addPipes(t,r){const n=r.reduce((s,o)=>(s[o.name]=o.value,s),{});t.forEach(s=>{const o=s.value,i=s.name,a=n[i];this.renderPipes[i]=new o(this,a?new a:null)})}destroy(t=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(t),Object.values(this.runners).forEach(r=>{r.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(t){return this.textureGenerator.generateTexture(t)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!Lr())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}};Nt.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let It=Nt,ue;function Vr(e){return ue!==void 0||(ue=(()=>{const t={stencil:!0,failIfMajorPerformanceCaveat:e??It.defaultOptions.failIfMajorPerformanceCaveat};try{if(!Be.get().getWebGLRenderingContext())return!1;let n=Be.get().createCanvas().getContext("webgl",t);const s=!!n?.getContextAttributes()?.stencil;if(n){const o=n.getExtension("WEBGL_lose_context");o&&o.loseContext()}return n=null,s}catch{return!1}})()),ue}let he;async function jr(e={}){return he!==void 0||(he=await(async()=>{const t=Be.get().getNavigator().gpu;if(!t)return!1;try{return await(await t.requestAdapter(e)).requestDevice(),!0}catch{return!1}})()),he}const at=["webgl","webgpu","canvas"];async function Gr(e){let t=[];e.preference?(t.push(e.preference),at.forEach(o=>{o!==e.preference&&t.push(o)})):t=at.slice();let r,n={};for(let o=0;o<t.length;o++){const i=t[o];if(i==="webgpu"&&await jr()){const{WebGPURenderer:a}=await tt(async()=>{const{WebGPURenderer:c}=await import("./WebGPURenderer-CGGLXk_j.js");return{WebGPURenderer:c}},__vite__mapDeps([0,1,2,3,4,5]));r=a,n={...e,...e.webgpu};break}else if(i==="webgl"&&Vr(e.failIfMajorPerformanceCaveat??It.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:a}=await tt(async()=>{const{WebGLRenderer:c}=await import("./WebGLRenderer-wm6-WAhx.js");return{WebGLRenderer:c}},__vite__mapDeps([6,1,2,3,4,5]));r=a,n={...e,...e.webgl};break}else if(i==="canvas")throw n={...e},new Error("CanvasRenderer is not yet implemented")}if(delete n.webgpu,delete n.webgl,!r)throw new Error("No available renderer for the current environment");const s=new r;return await s.init(n),s}const Ut="8.4.1";class Vt{static init(){globalThis.__PIXI_APP_INIT__?.(this,Ut)}static destroy(){}}Vt.extension=oe.Application;class Wr{constructor(t){this._renderer=t}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,Ut)}destroy(){this._renderer=null}}Wr.extension={type:[oe.WebGLSystem,oe.WebGPUSystem],name:"initHook",priority:-10};const jt=class Ge{constructor(...t){this.stage=new g,t[0]!==void 0&&we(ve,"Application constructor options are deprecated, please use Application.init() instead.")}async init(t){t={...t},this.renderer=await Gr(t),Ge._plugins.forEach(r=>{r.init.call(this,t)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return we(ve,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(t=!1,r=!1){const n=Ge._plugins.slice(0);n.reverse(),n.forEach(s=>{s.destroy.call(this)}),this.stage.destroy(r),this.stage=null,this.renderer.destroy(t),this.renderer=null}};jt._plugins=[];let Gt=jt;qe.handleByList(oe.Application,Gt._plugins);qe.add(Vt);class _e extends xe{constructor(...t){let r=t[0];Array.isArray(t[0])&&(r={textures:t[0],autoUpdate:t[1]});const{textures:n,autoUpdate:s,...o}=r,[i]=n;super({...o,texture:i instanceof le?i:i.texture}),this._textures=null,this._durations=null,this._autoUpdate=s??!0,this._isConnectedToTicker=!1,this.animationSpeed=1,this.loop=!0,this.updateAnchor=!1,this.onComplete=null,this.onFrameChange=null,this.onLoop=null,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=n}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(ce.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(ce.shared.add(this.update,this,ar.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(t){this.stop(),this.currentFrame=t}gotoAndPlay(t){this.currentFrame=t,this.play()}update(t){if(!this._playing)return;const r=t.deltaTime,n=this.animationSpeed*r,s=this.currentFrame;if(this._durations!==null){let o=this._currentTime%1*this._durations[this.currentFrame];for(o+=n/60*1e3;o<0;)this._currentTime--,o+=this._durations[this.currentFrame];const i=Math.sign(this.animationSpeed*r);for(this._currentTime=Math.floor(this._currentTime);o>=this._durations[this.currentFrame];)o-=this._durations[this.currentFrame]*i,this._currentTime+=i;this._currentTime+=o/this._durations[this.currentFrame]}else this._currentTime+=n;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):s!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<s||this.animationSpeed<0&&this.currentFrame>s)&&this.onLoop(),this._updateTexture())}_updateTexture(){const t=this.currentFrame;this._previousFrame!==t&&(this._previousFrame=t,this.texture=this._textures[t],this.updateAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(){this.stop(),super.destroy(),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(t){const r=[];for(let n=0;n<t.length;++n)r.push(le.from(t[n]));return new _e(r)}static fromImages(t){const r=[];for(let n=0;n<t.length;++n)r.push(le.from(t[n]));return new _e(r)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(t){if(t[0]instanceof le)this._textures=t,this._durations=null;else{this._textures=[],this._durations=[];for(let r=0;r<t.length;r++)this._textures.push(t[r].texture),this._durations.push(t[r].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let t=Math.floor(this._currentTime)%this._textures.length;return t<0&&(t+=this._textures.length),t}set currentFrame(t){if(t<0||t>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${t}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const r=this.currentFrame;this._currentTime=t,r!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(t){t!==this._autoUpdate&&(this._autoUpdate=t,!this._autoUpdate&&this._isConnectedToTicker?(ce.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(ce.shared.add(this.update,this),this._isConnectedToTicker=!0))}}class Hr extends lr{constructor(t,r){const{text:n,resolution:s,style:o,anchor:i,width:a,height:c,roundPixels:l,...u}=t;super({...u}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=r,this.text=n??"",this.style=o,this.resolution=s??null,this.allowChildren=!1,this._anchor=new cr({_onUpdate:()=>{this.onViewUpdate()}}),i&&(this.anchor=i),this.roundPixels=l??!1,a!==void 0&&(this.width=a),c!==void 0&&(this.height=c)}get anchor(){return this._anchor}set anchor(t){typeof t=="number"?this._anchor.set(t):this._anchor.copyFrom(t)}set text(t){t=t.toString(),this._text!==t&&(this._text=t,this.onViewUpdate())}get text(){return this._text}set resolution(t){this._autoResolution=t===null,this._resolution=t,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(t){t=t||{},this._style?.off("update",this.onViewUpdate,this),t instanceof this._styleClass?this._style=t:this._style=new this._styleClass(t),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get bounds(){return this._boundsDirty&&(this._updateBounds(),this._boundsDirty=!1),this._bounds}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(t){this._setWidth(t,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(t){this._setHeight(t,this.bounds.height)}getSize(t){return t||(t={}),t.width=Math.abs(this.scale.x)*this.bounds.width,t.height=Math.abs(this.scale.y)*this.bounds.height,t}setSize(t,r){typeof t=="object"?(r=t.height??t.width,t=t.width):r??(r=t),t!==void 0&&this._setWidth(t,this.bounds.width),r!==void 0&&this._setHeight(r,this.bounds.height)}addBounds(t){const r=this.bounds;t.addFrame(r.minX,r.minY,r.maxX,r.maxY)}containsPoint(t){const r=this.bounds.width,n=this.bounds.height,s=-r*this.anchor.x;let o=0;return t.x>=s&&t.x<=s+r&&(o=-n*this.anchor.y,t.y>=o&&t.y<=o+n)}onViewUpdate(){if(this._didViewChangeTick++,this._boundsDirty=!0,this.didViewUpdate)return;this.didViewUpdate=!0,this._didTextUpdate=!0;const t=this.renderGroup||this.parentRenderGroup;t&&t.onChildViewUpdate(this)}_getKey(){return`${this.text}:${this._style.styleKey}:${this._resolution}`}destroy(t=!1){super.destroy(t),this.owner=null,this._bounds=null,this._anchor=null,(typeof t=="boolean"?t:t?.style)&&this._style.destroy(t),this._style=null,this._text=null}}function Yr(e,t){let r=e[0]??{};return(typeof r=="string"||e[1])&&(we(ve,`use new ${t}({ text: "hi!", style }) instead`),r={text:r,style:e[1]}),r}class qr extends Hr{constructor(...t){const r=Yr(t,"Text");super(r,dr),this.renderPipeId="text"}_updateBounds(){const t=this._bounds,r=this._anchor,n=ur.measureText(this._text,this._style),{width:s,height:o}=n;t.minX=-r._x*s,t.maxX=t.minX+s,t.minY=-r._y*o,t.maxY=t.minY+o}}const Jr=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Å","Ä","Ö","0","1","2","3","4","5","6","7","8","9","!","@","#","$","%","^","&","*","(",")","-","_","=","+","[","]","{","}",";",":","'",'"',",",".","/","<",">","?","\\","|"," ","Enter","Shift","Control","`","~","Tab","Backspace","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Numpad0","Numpad1","Numpad2","Numpad3","Numpad4","Numpad5","Numpad6","Numpad7","Numpad8","Numpad9","NumpadAdd","NumpadSubtract","NumpadMultiply","NumpadDivide","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"],lt=e=>Jr.includes(e),Wt=[...At,"jump","fire","carry","swop","pause"],Zr=()=>({...St(Wt.map(e=>[e,!1])),windowFocus:!0}),B={right:["P"],towards:["A"],left:["O"],away:["Q"],jump:[" ","M"],carry:["C","M"],fire:["N"],swop:["Enter","S"],pause:["H"]},Kr={right:["ArrowRight",...B.right],towards:["ArrowDown",...B.towards],left:["ArrowLeft",...B.left],away:["ArrowUp",...B.away],jump:B.jump,carry:["Shift",...B.carry],fire:["Control",...B.fire],swop:B.swop,pause:["F8",...B.pause]};function*ct(e,t){for(const[r,n]of hr(e))n.includes(t)&&(yield r)}const dt=e=>e.length===1?e.toUpperCase():e,Qr=({keyAssignment:e,inputState:t})=>{const r=({key:i})=>{const a=dt(i);if(!lt(a)){console.log("do not recognise key: ",a);return}for(const c of ct(e,a))t[c]=!0},n=({key:i})=>{const a=dt(i);if(lt(a))for(const c of ct(e,a))t[c]=!1},s=()=>{t.windowFocus=!0},o=()=>{t.windowFocus=!1;for(const i of Wt)t[i]=!1};return window.addEventListener("keydown",r,!1),window.addEventListener("keyup",n,!1),window.addEventListener("focus",s,!1),window.addEventListener("blur",o,!1),()=>{window.removeEventListener("keydown",r,!1),window.removeEventListener("keyup",n,!1),window.removeEventListener("focus",s,!1),window.removeEventListener("blur",o,!1)}};function en(e){return{all:e=e||new Map,on:function(t,r){var n=e.get(t);n?n.push(r):e.set(t,[r])},off:function(t,r){var n=e.get(t);n&&(r?n.splice(n.indexOf(r)>>>0,1):e.set(t,[]))},emit:function(t,r){var n=e.get(t);n&&n.slice().map(function(s){s(r)}),(n=e.get("*"))&&n.slice().map(function(s){s(t,r)})}}}const tn=e=>{const t={};for(const r of Object.values(e.rooms))for(const n of Object.values(r.items))if(n.type==="player"){const{which:s}=n.config;t[s]=r.id}if(t.head===void 0&&t.heels===void 0)throw new Error("couldn't find either head or heels in campaign");return t},rn=(e,t)=>{const r=tn(e),n=St(Object.keys(e.rooms).map(i=>[i,{}])),s=r.head&&Xe(e.rooms[r.head],n[r.head]),o=r.heels===r.head?s:r.heels&&Xe(e.rooms[r.heels],n[r.heels]);return{keyAssignment:Kr,currentCharacterName:r.head===void 0?"heels":"head",characterRooms:{head:s===void 0?void 0:{room:s,entryState:rt(s.items.head)},heels:o===void 0?void 0:{room:o,entryState:rt(o.items.heels)}},inputState:Zr(),renderOptions:t,campaign:e,events:en(),pickupsCollected:n,gameTime:0,progression:0}},nn=e=>{let t=1;return{get curUpscale(){return t},rescale(){if(e.renderer.width===0||e.renderer.height===0)throw new Error;const r=Math.floor(Math.min(e.renderer.width/Ne.width,e.renderer.height/Ne.height)),n={x:Math.round(e.renderer.width/r),y:Math.round(e.renderer.height/r)};return t===r||(t=r,console.log("scale factor changed to:",r),e.stage.scale=r),n}}},M={original:new x("rgb(255, 255, 255)"),basic:new x("rgb(210, 210, 210)"),dimmed:new x("rgb(120, 120, 120)")},E={original:new x("rgb(255, 255, 0)"),basic:new x("hsl(50,58%,70%)"),dimmed:U().redShadow},D={original:new x("rgb(255, 0, 255)"),basic:U().pink,dimmed:new x("hsl(290,25%,40%)")},v={original:new x("rgb(0, 255, 255)"),basic:new x("hsl(183, 28%, 50%)"),dimmed:new x("hsl(183, 28%,39%)")},z={original:new x("rgb(0, 255, 0)"),basic:U().moss,dimmed:new x("hsl(73,35%,35%)")},Ke={white:{basic:{main:M,edges:{towards:v,right:E},hud:{lives:E,dimmed:D,icons:v}},dimmed:{main:M,edges:{towards:z,right:v},hud:{lives:E,dimmed:D,icons:v}}},yellow:{basic:{main:E,edges:{towards:z,right:M},hud:{lives:v,dimmed:D,icons:z}},dimmed:{main:E,edges:{towards:v,right:v},hud:{lives:v,dimmed:D,icons:z}}},magenta:{basic:{main:D,edges:{towards:z,right:v},hud:{lives:M,dimmed:v,icons:E}},dimmed:{main:D,edges:{towards:z,right:v},hud:{lives:M,dimmed:v,icons:E}}},cyan:{basic:{main:v,edges:{towards:D,right:M},hud:{lives:M,dimmed:z,icons:E}},dimmed:{main:v,edges:{towards:D,right:M},hud:{lives:M,dimmed:z,icons:E}}},green:{basic:{main:z,edges:{towards:v,right:E},hud:{lives:M,dimmed:D,icons:v}},dimmed:{main:z,edges:{towards:v,right:E},hud:{lives:M,dimmed:D,icons:v}}}},Ht=e=>Ke[e.hue][e.shade],Yt=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,sn=`in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uOriginalColor;
uniform vec3 uTargetColor;
uniform float uTolerance;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);
    vec3 colorDiff = uOriginalColor - (c.rgb / max(c.a, 0.0000000001));
    float colorDistance = length(colorDiff);
    float doReplace = step(colorDistance, uTolerance);
    finalColor = vec4(mix(c.rgb, uTargetColor * c.a, doReplace), c.a);
}
`;class ke extends Bt{static DEFAULT_OPTIONS={originalColor:16711680,targetColor:0,tolerance:.4};uniforms;_originalColor;_targetColor;constructor(t){t={...ke.DEFAULT_OPTIONS,...t};const r=Ye.from({vertex:Yt,fragment:sn,name:"palette-swap-filter"});super({glProgram:r,resources:{colorReplaceUniforms:{uOriginalColor:{value:new Float32Array(3),type:"vec3<f32>"},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"},uTolerance:{value:t.tolerance,type:"f32"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this._originalColor=new x,this._targetColor=new x,this.originalColor=t.originalColor??16711680,this.targetColor=t.targetColor??0,Object.assign(this,t)}get originalColor(){return this._originalColor.value}set originalColor(t){this._originalColor.setValue(t);const[r,n,s]=this._originalColor.toArray();this.uniforms.uOriginalColor[0]=r,this.uniforms.uOriginalColor[1]=n,this.uniforms.uOriginalColor[2]=s}get targetColor(){return this._targetColor.value}set targetColor(t){this._targetColor.setValue(t);const[r,n,s]=this._targetColor.toArray();this.uniforms.uTargetColor[0]=r,this.uniforms.uTargetColor[1]=n,this.uniforms.uTargetColor[2]=s}get tolerance(){return this.uniforms.uTolerance}set tolerance(t){this.uniforms.uTolerance=t}}const qt=e=>[new ke({originalColor:U().replaceLight,targetColor:e.basic,tolerance:.1}),new ke({originalColor:U().replaceDark,targetColor:e.dimmed,tolerance:.1})],We=(e,t)=>qt(Ke[e.color.hue][e.color.shade].edges[t]),on=e=>qt(Ke[e.color.hue][e.color.shade].main),re=fr,an=`precision mediump float;
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uSourceBlacks[2];
uniform vec3 uTargetColor;

// colours are floats so check if they're very close rather than exactly equal:
bool colorsEffectivelyEqual(vec3 color1, vec3 color2) {    
    
    return distance(color1, color2) < 0.05;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a == 0.0 ) {
        finalColor = c;
        return;
    }

    if ( colorsEffectivelyEqual(c.rgb, uSourceBlacks[0]) || colorsEffectivelyEqual(c.rgb, uSourceBlacks[1])) {
        finalColor = vec4(0,0,0, 1.0);
    } else {
        finalColor = vec4(uTargetColor, 1);    
    }
}
`,ut=[U().pureBlack,U().lightBlack];class se extends Bt{uniforms;constructor(t="white"){const r=Ye.from({vertex:Yt,fragment:an,name:"revert-colourise-filter"});super({glProgram:r,resources:{colorReplaceUniforms:{uSourceBlacks:{value:new Float32Array(6),type:"vec3<f32>",size:6},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms;const[n,s,o]=ut[0].toArray();this.uniforms.uSourceBlacks[0]=n,this.uniforms.uSourceBlacks[1]=s,this.uniforms.uSourceBlacks[2]=o;const[i,a,c]=ut[1].toArray();this.uniforms.uSourceBlacks[3]=i,this.uniforms.uSourceBlacks[4]=a,this.uniforms.uSourceBlacks[5]=c,this.targetColor=t}set targetColor(t){const[r,n,s]=new x(t).toArray();this.uniforms.uTargetColor[0]=r,this.uniforms.uTargetColor[1]=n,this.uniforms.uTargetColor[2]=s}}const ln={x:.5,y:1},cn=e=>typeof e!="string"&&Object.hasOwn(e,"frames"),d=e=>{if(typeof e=="string")return d({texture:e});{const{anchor:t,flipX:r,pivot:n,x:s,y:o}=e;let i;return cn(e)?i=dn(e):i=new xe(m.textures[e.texture]),t===void 0&&n===void 0?i.anchor=ln:(t!==void 0&&(i.anchor=t),n!==void 0&&(i.pivot=n)),s!==void 0&&(i.x=s),o!==void 0&&(i.y=o),i.eventMode="static",r===!0&&(i.scale.x=-1),i}};function dn({frames:e,animationSpeed:t,reverse:r,playOnce:n}){const s=e.map(i=>({texture:i,time:Ft}));r&&s.reverse();const o=new _e(s);return o.animationSpeed=t||pr,o.play(),n!==void 0&&(o.loop=!1,o.onComplete=()=>{o.stop(),n==="and-destroy"&&(o.visible=!1)}),o}const un=(e,t,r,n)=>`${e}${n?".dark":""}.wall.${t}.${r}`,hn=(e,t,r)=>{const s=m.textures[`${e.planet}.door.front.${t}`]!==void 0?e.planet:"generic",o=e.color.shade==="dimmed"&&m.textures[`${s}.dark.door.front.${t}`]!==void 0;return`${s}${o?".dark":""}.door.${r=="near"?"front":"back"}.${t}`};function Jt(e,t){const r=t||new g;for(const n of e)r.addChild(n);return r}const ht=e=>()=>({container:d(e),renderProps:{}}),X=e=>({item:t,room:r,currentlyRenderedProps:n})=>{if(n===void 0)return e({item:t,room:r})};function*fn({config:{direction:e,inHiddenWall:t,height:r}},n){const s=Pe(e),o=s==="y"?0:16;function*i(a){if(t){if(r!==0){const l=d({pivot:{x:s==="x"?18:8,y:12},texture:`generic.door.floatingThreshold.${s}`,...Me(a,{y:-R.h*r})});l.filters=We(n,s==="x"?"towards":"right"),yield l}}else{yield d({pivot:{x:o,y:12},texture:"generic.door.legs.base",...Me(a,{y:r})});for(let c=1;c<r;c++)yield d({pivot:{x:o,y:9},texture:"generic.door.legs.pillar",...Me(a,{y:-c*R.h})})}}yield*i(N({...me,[s]:1})),yield*i(me),t||(yield d({pivot:{x:16,y:R.h*r+13},texture:`generic.door.legs.threshold.double.${s}`,...N({...me,[s]:1})}))}const pn=X(({item:e,room:t})=>({container:Jt(fn(e,t)),renderProps:{}}));function*mn({config:{direction:e,inHiddenWall:t,nearness:r},state:{position:n}},s){const o=Pe(e),{z:i}=n;if(!t&&i===0){const a=N({[gr(o)]:.5});r==="far"&&(yield d({anchor:{x:0,y:1},flipX:o==="x",texture:"generic.wall.overdraw",...a}))}yield d({texture:hn(s,o,r),pivot:mr[r][o]})}const gn=X(({item:e,room:t})=>({container:Jt(mn(e,t)),renderProps:{}})),ft=({item:{type:e,state:{action:t,facing:r,teleporting:n}},currentlyRenderedProps:s})=>s===void 0||s.action!==t||s.facingXy4!==r||s.teleportingPhase!==(n?.phase??null)?{container:(()=>{if(t==="death")return d({frames:m.animations[`${e}.fadeOut`]});if(n!==null){if(n.phase==="out")return d({frames:m.animations[`${e}.fadeOut`]});if(n.phase==="in")return d({frames:m.animations[`${e}.fadeOut`].toReversed()})}return d(t==="moving"?{frames:m.animations[`${e}.walking.${r}`]}:t==="falling"&&e==="head"&&(r==="towards"||r==="right")?`head.falling.${r}`:e==="head"&&(r==="towards"||r==="right")?{frames:m.animations[`head.idle.${r}`]}:`${e}.walking.${r}.2`)})(),renderProps:{action:t,facingXy4:r,teleportingPhase:n?.phase??null}}:void 0,ze={frames:m.animations["bubbles.cold"],animationSpeed:.25},ee=(e,t="headless-base")=>{const r=new g;r.addChild(d(t));const n=d(e);return n.y=-12,r.addChild(n),r},Re=X(({item:{config:{style:e}}})=>({container:d(e),renderProps:{}})),yn={head:ft,heels:ft,doorFrame:gn,doorLegs:pn,stopAutowalk(){throw new Error("these should always be non-rendering")},portal(){throw new Error("these should always be non-rendering")},wall:X(({item:{config:{side:e,style:t}},room:r})=>{if(e==="right"||e==="towards")throw new Error("this wall should be non-rendering");return{container:d({texture:un(r.planet,t,e,r.color.shade==="dimmed"),pivot:e==="away"?{x:ge.w,y:ge.h+1}:{x:0,y:ge.h+1}}),renderProps:{}}}),barrier({item:{config:{axis:e},state:{expires:t}},currentlyRenderedProps:r}){const n=t!==null;if(r===void 0||n!==r.bubbles)return{container:d(n?{frames:m.animations["bubbles.taupe"],playOnce:"and-destroy",pivot:nt[e]}:{texture:`barrier.${e}`,pivot:nt[e]}),renderProps:{bubbles:n}}},deadlyBlock:Re,slidingDeadly:Re,slidingBlock:Re,block({item:{config:{style:e},state:{expires:t,disappearing:r}},currentlyRenderedProps:n}){const s=t!==null;if(n===void 0||n.bubbles!==s||n.disappearing!==r)return{container:d(s?{frames:m.animations["bubbles.taupe"],playOnce:"and-destroy"}:`block.${e}${r?".disappearing":""}`),renderProps:{bubbles:s,disappearing:r}}},switch({item:{state:{setting:e}},currentlyRenderedProps:t}){if(t===void 0||e!==t.setting)return{container:d(`switch.${e}`),renderProps:{setting:e}}},conveyor({item:{config:{direction:e,count:t},state:{stoodOnBy:r}},currentlyRenderedProps:n}){const s=r.size>0;if(!(n===void 0||n.moving!==s))return;const i=new g,a=vr(e);return i.addChild(...be(yr(t,0,-1)).map(c=>{const l=xr({[a]:(c-1)*R.w});return d(s?{frames:m.animations[`conveyor.${a}`],reverse:e==="towards"||e==="right",animationSpeed:.5,...l}:{texture:`conveyor.${a}.6`,...l})})),{container:i,renderProps:{moving:s}}},lift:X(()=>{const e=new g,t={x:ne.w/2,y:ne.h-br};return e.addChild(d({frames:m.animations.lift,pivot:t})),e.addChild(d({texture:"lift.static",pivot:t})),{container:e,renderProps:{}}}),spring({item:{state:{stoodOnBy:e}},currentlyRenderedProps:t}){const r=e.size>0;if(!(t===void 0||r!==t.compressed))return;const s=t?.compressed??!1;return{container:d(!r&&s?{frames:m.animations["spring.bounce"],playOnce:"and-stop"}:r?"spring.compressed":"spring.released"),renderProps:{compressed:r}}},teleporter({item:{state:{stoodOnBy:e}},currentlyRenderedProps:t}){const r=be(e).find(q)!==void 0;return t===void 0||r!==t.flashing?{container:r?new g({children:[d("teleporter"),d({frames:m.animations["teleporter.flashing"]})]}):d("teleporter"),renderProps:{flashing:r}}:void 0},pickup({item:{config:{gives:e},state:{expires:t}},currentlyRenderedProps:r}){const n=t!==null;if(!(r===void 0||r.bubbles!==n))return;const i={shield:"bunny",jumps:"bunny",fast:"bunny","extra-life":"bunny",bag:"bag",donuts:"donuts",hooter:"hooter",crown:"crown",reincarnation:{frames:m.animations.fish,animationSpeed:.25}}[e];return{container:d(n?{frames:i==="donuts"?m.animations["bubbles.taupe"]:m.animations["bubbles.white"],playOnce:"and-destroy"}:i),renderProps:{bubbles:n}}},moveableDeadly:X(({item:{config:{style:e}}})=>({container:d(e==="deadFish"?"fish.1":"puck.deadly"),renderProps:{}})),sceneryPlayer:X(({item:{config:{which:e}}})=>({container:d(`${e}.walking.towards.2`),renderProps:{}})),charles({item:{state:{facing:e}},currentlyRenderedProps:t}){const r=st(e);if(t===void 0||r!==t.facingXy4)return{container:ee(`charles.${r}`),renderProps:{facingXy4:r}}},baddie({item:{config:e,state:t},currentlyRenderedProps:r}){let n;const{activated:s}=t;switch(e.which){case"american-football-head":case"turtle":case"cyberman":n=e.startDirection;case"computer-bot":case"elephant":case"monkey":{const o=wr(t.vels.walking,me)?n??"towards":st(t.vels.walking);if(!(r===void 0||s!==r.activated||o!==r.facingXy4))return;const a={facingXy4:o,activated:s};switch(e.which){case"american-football-head":return{container:d({texture:`${e.which}.${e.style}.${o}`}),renderProps:a};case"turtle":return{container:d(s?{frames:m.animations[`${e.which}.${o}`],animationSpeed:.25}:`${e.which}.${o}.1`),renderProps:a};case"cyberman":return{container:t.activated?ee(`${e.which}.${o}`,ze):d(`${e.which}.${o}`),renderProps:a};case"computer-bot":case"elephant":case"monkey":return{container:ee(`${e.which}.${o}`),renderProps:a}}break}case"helicopter-bug":case"dalek":case"headless-base":case"elephant-head":case"bubble-robot":case"flying-ball":{if(!(r===void 0||s!==r.activated))return;const i={activated:s};switch(e.which){case"helicopter-bug":case"dalek":return{container:d({frames:m.animations[e.which],animationSpeed:.5}),renderProps:i};case"headless-base":return{container:d(e.which),renderProps:i};case"elephant-head":return{container:d("elephant.towards"),renderProps:i};case"bubble-robot":return{container:ee(ze),renderProps:i};case"flying-ball":return{container:ee("ball",ze),renderProps:i}}break}default:throw new Error(`unexpected baddie ${e}`)}},joystick:ht("joystick"),movableBlock:X(({item:{config:{style:e}}})=>({container:d(e),renderProps:{}})),portableBlock({item:{id:e,config:{style:t}},room:r,currentlyRenderedProps:n}){const o=(r.items.heels?.state.carrying?.id??null)===e;if(n===void 0||o!==n.carried)return{container:o?new g:d(t),renderProps:{carried:o}}},book:X(({item:{config:{slider:e}}})=>({container:d(`book.${e?"y":"x"}`),renderProps:{}})),hushPuppy({item:{state:{expires:e}},currentlyRenderedProps:t}){const r=e!==null;if(t===void 0||t.bubbles!==r)return{container:d(r?{frames:m.animations["bubbles.taupe"],playOnce:"and-destroy"}:"hushPuppy"),renderProps:{bubbles:r}}},ball:ht("ball"),floor(){throw new Error("floor should not be rendered as an item")}},pt=(e,t)=>new Y().poly([y({}),y({x:e.x}),y({x:e.x,y:e.y}),y({y:e.y})]).poly([y({}),y({z:e.z}),y({y:e.y,z:e.z}),y({y:e.y})]).poly([y({x:e.x}),y({x:e.x,z:e.z}),y(e),y({x:e.x,y:e.y})]).poly([y({z:e.z}),y({x:e.x,z:e.z}),y({x:e.x,y:e.y,z:e.z}),y({y:e.y,z:e.z})]).stroke({width:1,color:t,alpha:.5}),wn={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",stopAutowalk:"rgba(255,128,128)"},vn=e=>{const t=wn[e.type]??"rgba(255,255,255)",r=new g;if(C("portal")(e)){const n=y(e.config.relativePoint);r.addChild(new Y().circle(n.x,n.y,5).stroke(t)),r.addChild(new Y().circle(n.x,n.y,2).fill(t))}return r.addChild(new Y().circle(0,0,2).fill(t)),r.addChild(pt(e.aabb,t)),e.renderAabb&&r.addChild(pt(e.renderAabb,"rgba(184, 184, 255)")),r},xn=(e,t,r)=>{t!==void 0&&(r.onItemClick&&t!==void 0&&(t.eventMode="static",t.on("pointertap",()=>{r.onItemClick(e,t)})),t.on("pointerenter",()=>{t.filters=new se("white")}),t.on("pointerleave",()=>{t.filters=[]}))},mt=({state:{position:e}},t)=>{const r=Cr(e);t.x=r.x,t.y=r.y},Zt=(e,t,r)=>{const n=new g;r.showBoundingBoxes!=="none"&&(n.alpha=.5);const s=new g({label:`item(${e.id})`});s.addChild(n),xn(e,n,r),(r.showBoundingBoxes==="all"||r.showBoundingBoxes==="non-wall"&&e.type!=="wall")&&(s.addChild(vn(e)),mt(e,s));let o,i;return{destroy(){s.destroy({children:!0}),n.destroy({children:!0})},tick(){if(!e.renders)return;const a=yn[e.type],c=a({item:e,room:t,currentlyRenderedProps:o});c!==void 0&&(o=c.renderProps,n.children.forEach(h=>h.destroy()),n.addChild(c.container));const{state:{position:l}}=e,u=i===void 0||!ae(i,l);return u&&(mt(e,s),i=l),u},container:s}},bn=8,Cn=24,Tn=56,_n=80,gt=112,te=e=>e==="heels"?1:-1,kn=e=>{const t=new se,r=new se,n=new se,s=(c=!1)=>{const l=c?2:1,u=new qr({style:{fill:"white",fontFamily:"Head over Heels",fontSize:bn,align:"center"},resolution:8,anchor:{x:.5,y:1}});return u.scale={x:1,y:l},u},o=c=>{const l=new xe(m.textures[`${c}.walking.${c==="head"?"right":"towards"}.2`]);return l.anchor={x:.5,y:0},l},i=(c,l=!1,u=!1)=>{const h=new g;h.pivot={x:4,y:16};const f=new xe({texture:m.textures[c],anchor:l?{x:.5,y:0}:{x:.5,y:1},filters:t,y:l?0:8});h.addChild(f);const p=s();return p.text="0",p.y=l?0:16,p.filters=r,p.x=f.x=Tr.w/2,h.addChild(p),u&&(p.visible=!1),{text:p,icon:f,container:h}},a={head:{sprite:o("head"),livesText:s(!0),shield:i("hud.shield"),extraSkill:i("hud.fastSteps"),donuts:i("donuts",!0),hooter:i("hooter",!0,!0)},heels:{sprite:o("heels"),livesText:s(!0),shield:i("hud.shield"),extraSkill:i("hud.bigJumps"),bag:i("bag",!0,!0),carrying:{container:new g,itemRenderer:void 0}}};for(const c of ot)e.addChild(a[c].livesText),e.addChild(a[c].sprite),e.addChild(a[c].shield.container),e.addChild(a[c].extraSkill.container);return e.addChild(a.head.donuts.container),e.addChild(a.head.hooter.container),e.addChild(a.heels.bag.container),e.addChild(a.heels.carrying.container),(c,l,u)=>{const h=A(c),{hud:{dimmed:f,lives:p,icons:O}}=Ht(h.color),k=b=>{const{type:_,state:{shieldCollectedAt:P}}=b,{text:Fe,container:Qe}=a[_].shield,{text:rr,container:et}=a[_].extraSkill;et.x=Qe.x=(l.x>>1)+te(_)*_n;const nr=P===null||c.gameTime>P+Le?0:100-Math.ceil((c.gameTime-P)/(Le/100));Fe.text=`${nr}`,Qe.y=l.y,rr.text=b.type==="head"?b.state.fastSteps:b.state.bigJumps,et.y=l.y-24},L=({type:b})=>{const _=c.currentCharacterName===b,P=a[b].sprite;P.filters=_?re:n,P.x=(l.x>>1)+te(b)*Tn,P.y=l.y-ne.h},V=({type:b,state:{lives:_}})=>{const P=a[b].livesText;P.x=(l.x>>1)+te(b)*Cn,P.y=l.y,P.style.fill=p.basic,P.text=`${_??0}`},T=b=>{const{itemRenderer:_,container:P}=a.heels.carrying;if(b===null&&_!==void 0&&(_.destroy(),a.heels.carrying.itemRenderer=void 0),b!==null&&_===void 0){const Fe=a.heels.carrying.itemRenderer=Zt(b,h,u);P.addChild(Fe.container)}};n.targetColor=f.dimmed,r.targetColor=f.basic,t.targetColor=O.basic;for(const b of ot){const _=Ee(c,b);_!==void 0&&(V(_),L(_),k(_))}a.head.hooter.container.x=a.head.donuts.container.x=(l.x>>1)+te("head")*gt,a.head.donuts.container.y=l.y-ne.h-8,a.heels.carrying.container.y=l.y-ne.h,a.heels.carrying.container.x=a.heels.bag.container.x=(l.x>>1)+te("heels")*gt,a.heels.bag.container.y=a.head.hooter.container.y=l.y-8;const{state:{hasHooter:S,donuts:j}}=Ee(c,"head");a.head.hooter.icon.filters=S?re:n,a.head.donuts.icon.filters=j!==0?re:n,a.head.donuts.text.text=`${j}`;const w=Ee(c,"heels"),H=w?.state.hasBag??!1;T(w?.state.carrying??null),a.heels.bag.icon.filters=H?re:n}},yt={movementType:"vel",vels:{gravity:$}},Pn=(e,t,r)=>{if(!J(e,t.progression))return yt;const{type:n,state:{vels:{gravity:{z:s}},standingOn:o}}=e,i=_r[n==="head"?"head":"others"];return o!==null?C("lift")(o)&&o.state.vels.lift.z<0?{movementType:"vel",vels:{gravity:{z:Math.max(s-Ie*r,-i)}}}:yt:{movementType:"vel",vels:{gravity:{z:Math.max(s-Ie*r,-i)}}}},fe=e=>{const r=e/kr*Ft;return(e+.5*Ie*r**2)/r},On={head:fe(de.head),headOnSpring:fe(de.head+R.h),heels:fe(de.heels),heelsOnSpring:fe(de.heels+R.h)},Sn=(e,t)=>On[`${e}${t?"OnSpring":""}`],An=({type:e,state:{standingOn:t}},r,n)=>{const{inputState:{jump:s}}=r,o=t!==null&&C("teleporter")(t);if(!(s&&t!==null&&!o))return t!==null?{movementType:"steady",stateDelta:{jumped:!1}}:Mt;const a=C("spring")(t);return{movementType:"vel",vels:{gravity:{z:Sn(e,a)}},stateDelta:{action:"moving",jumped:!0}}},wt={movementType:"vel",vels:{walking:$}},Fn=(e,{inputState:t},r)=>{const{type:n,state:{autoWalk:s,standingOn:o,facing:i,teleporting:a,vels:{walking:c,gravity:l}}}=e,u=s?i:At.find(p=>t[p]===!0),h=Se[n];if(a!==null)return wt;if(n==="heels"){if(o===null)return e.state.jumped?{movementType:"vel",vels:{walking:Oe(c,I(c,Pr*r))}}:wt;if(t.jump){const p=u??i;return{movementType:"vel",vels:{walking:I(Ce[p],h*Or)},stateDelta:{facing:p}}}}const f=o===null&&l.z<0?"falling":u===void 0?"idle":"moving";return u!==void 0?{movementType:"vel",vels:{walking:I(Ce[u],h)},stateDelta:{facing:u,action:f}}:{movementType:"vel",vels:{walking:$},stateDelta:{action:f}}},vt=R.h,pe=.001,Mn=({totalDistance:e,currentAltitude:t,direction:r})=>{const n=De**2/(2*Z);if(r==="up"){if(t<=n)return Math.max(pe,Math.sqrt(2*Z*Math.max(t,0)));if(t>=e-n){const s=Math.max(0,e-t);return Math.max(pe,Math.sqrt(2*Z*s))}else return De}else if(t>=e-n){const s=Math.max(0,e-t);return Math.min(-pe,-Math.sqrt(2*Z*s))}else return t<=n?Math.min(-pe,-Math.sqrt(2*Z*Math.max(t,0))):-De};function En({config:{bottom:e,top:t},state:{direction:r,position:{z:n}}},s,o){const i=e*vt,a=t*vt,c=Mn({currentAltitude:n-i,direction:r,totalDistance:a-i});if(Number.isNaN(c))throw new Error("velocity is NaN");const l=n<=i?"up":n>=a?"down":r;return{movementType:"vel",vels:{lift:{z:c}},stateDelta:{direction:l}}}const xt=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),bt={stopAutowalk:0,portal:0,wall:0,doorLegs:0,sceneryPlayer:0,block:1,barrier:1,floor:1,book:1,hushPuppy:1,teleporter:1,doorFrame:1,lift:2,movableBlock:2,portableBlock:2,slidingBlock:2,spring:2,ball:3,joystick:3,switch:3,charles:3,conveyor:3,head:3,heels:3,pickup:8,slidingDeadly:10,moveableDeadly:10,deadlyBlock:10,baddie:10},Dn=(e,t)=>t.toSorted((r,n)=>{const s=bt[r.type]<<8,o=bt[n.type]<<8;if(s!==o)return s-o;const i=Te(e,xt(e,r)),a=Te(e,xt(e,n));return i-a});function Ct(e,t){const{shieldCollectedAt:r}=t.state;return r!==null&&r+Le>e.gameTime?!1:(t.state.action="death",t.state.expires=e.gameTime+Ue,!0)}const zn=(e,t,r)=>{const n=A(e).id;if(e.pickupsCollected[n][r.id]===!0)return;const s=e.pickupsCollected[n];switch(s[r.id]=!0,He(e,t,r),r.config.gives){case"hooter":{if(t.type==="head"){t.state.hasHooter=!0;break}break}case"donuts":{if(t.type==="head"){t.state.donuts+=6;break}break}case"bag":{if(t.type==="heels"){t.state.hasBag=!0;break}break}case"shield":{t.state.shieldCollectedAt=e.gameTime;break}case"fast":{t.type==="head"&&(t.state.fastSteps=99);break}case"jumps":{t.type==="heels"&&(t.state.bigJumps=10);break}case"extra-life":t.state.lives+=2;break}},He=(e,t,r)=>{Sr(r,e)},Rn=(e,t,r,n)=>{const{config:{relativePoint:s,toRoom:o,direction:i},state:{position:a}}=r,c=Ce[i];return Te(c,n)<=0?!1:(Je({gameState:e,toRoomId:o,positionRelativeToSourcePortal:Oe(t.state.position,F(a,s)),sourcePortal:r,changeType:"portal"}),!0)},$n=(e,t,r)=>{const{config:{direction:n,nearness:s}}=r,o=Pe(n),i=s==="far"?{x:o==="x"?-Math.abs(t.y):0,y:o==="y"?-Math.abs(t.x):0,z:0}:{x:o==="x"?Math.abs(t.y):0,y:o==="y"?Math.abs(t.x):0,z:0};return e.state.position=F(e.state.position,i),!1};function Bn(e,t){return t.state.autoWalk=!1,!1}const Xn=(e,t,r,n)=>{const s=A(e),{config:{controls:o},state:{position:i},aabb:a}=r,c=ie(t.state.position,t.aabb,i,a);if(c.z!==0)return;const l=Et(c);for(const u of o){const h=s.items[u],f=I(l,-Se.charles*n);h.state.facing=f,Ae({subjectItem:h,posDelta:f,gameState:e,pusher:r,deltaMS:n})}},Tt=(e,t,r,n,s)=>{switch(t.type){case"stopAutowalk":Bn(n,e);break;case"baddie":case"deadlyBlock":case"moveableDeadly":case"slidingDeadly":if(Ct(n,e))return!0;break;case"floor":if(t.config.deadly&&Ct(n,e))return!0;break;case"portal":if(Rn(n,e,t,r))return!0;break;case"pickup":zn(n,e,t);break;case"doorFrame":$n(e,r,t);break;case"barrier":t.config.disappearing&&He(n,e,t);break;case"block":t.state.disappearing&&He(n,e,t);break;case"joystick":Xn(n,e,t,s);break}return!1},Nn=(e,t,r,n)=>{const s=A(n),{config:{activates:o},state:{setting:i,touchedOnProgression:a}}=e;if(e.state.touchedOnProgression=n.progression,n.progression===a+1)return;const c=e.state.setting=i==="left"?"right":"left";for(const[l,u]of Ze(o)){const h=s.items[l];h.state={...h.state,...u[c]}}},Ln=(e,t,r)=>{if(!J(t,r.progression))return;const{state:{position:n},aabb:s}=e,o=ie(t.state.position,t.aabb,n,s),i=Et(o),a=I(i,-Se.ball);e.state.vels.sliding=a},In=(e,t,r)=>{if(!J(t,r.progression))return;const n=e.state.vels.sliding;if(ae(n,$))return;const{state:{position:s},aabb:o}=e,i=ie(t.state.position,t.aabb,s,o);Te(i,e.state.vels.sliding)>0&&(e.state.vels.sliding=$)},Un=({movingItem:e,movementVector:t,touchee:r,gameState:n,deltaMS:s})=>!!(q(e)&&Tt(e,r,t,n,s)||q(r)&&Tt(r,e,t,n,s)||it(r)&&Ln(r,e,n)||it(e)&&In(e,r,n)||C("baddie")(e)&&Ar(e,r)||C("switch")(r)&&Nn(r,e,t,n)),Ae=({subjectItem:e,posDelta:t,gameState:r,pusher:n,deltaMS:s,forceful:o=C("lift")(e)&&n===void 0})=>{if(ae(t,$))return!1;const i=A(r),{state:{position:a}}=e;e.state.position=F(a,t);const c=Dn(t,Dt(e,G(i.items)));for(const l of c){if(!zt(e,l))continue;if(n!==l&&Un({movingItem:e,touchee:l,movementVector:Oe(e.state.position,a),gameState:r,deltaMS:s}))return!0;if(!J(l,r.progression)||!J(e,r.progression))continue;const u=ie(e.state.position,e.aabb,l.state.position,l.aabb);if(W(l)&&l!==n){const f=I(u,o?-1:-.5);if(e.state.position=F(e.state.position,u,f),Ae({subjectItem:l,posDelta:f,pusher:e,gameState:r,deltaMS:s,forceful:o}))return!0;e.state.position=F(e.state.position,ie(e.state.position,e.aabb,l.state.position,l.aabb))}else e.state.position=F(e.state.position,u);W(e)&&u.z>0&&(e.state.standingOn===null||!c.includes(e.state.standingOn))&&(Vn(e),jn(e,l))}return!1},Vn=e=>{e.state.standingOn!==null&&e.state.standingOn.state.stoodOnBy.delete(e),e.state.standingOn=null},jn=(e,t)=>{e.state.standingOn=t,t.state.stoodOnBy.add(e)};function Gn(e,t,r){const{state:{teleporting:n,standingOn:s}}=e,{inputState:{jump:o}}=t;if(n===null)return o&&s!==null&&C("teleporter")(s)?{movementType:"steady",stateDelta:{teleporting:{phase:"out",toRoom:s.config.toRoom,timeRemaining:Ue}}}:Mt;const i=Math.max(n.timeRemaining-r,0);switch(n.phase){case"out":if(i===0)return Je({gameState:t,toRoomId:n.toRoom,changeType:"teleport"}),{movementType:"endTick",stateDelta:{teleporting:{phase:"in",timeRemaining:Ue}}};break;case"in":if(i===0)return{movementType:"steady",stateDelta:{teleporting:null}};break}return{movementType:"steady",stateDelta:{teleporting:{...n,timeRemaining:i}}}}const _t={movementType:"vel",vels:{movingFloor:$},stateDelta:{activeConveyor:null}},Wn=(e,t,r)=>{if(q(e)&&e.state.teleporting!==null)return _t;const{state:{standingOn:n}}=e;if(n===null||!C("conveyor")(n))return _t;const{config:{direction:s}}=n,i=C("heels")(e)&&e.state.action==="moving"&&e.state.facing===Fr(s)?Se.heels:Mr;return{movementType:"vel",vels:{movingFloor:I(Ce[s],i)},stateDelta:{activeConveyor:n}}},Hn=(e,t,r,n)=>{const{inputState:s}=r,{state:{carrying:o,standingOn:i,position:a,hasBag:c}}=e;if(c&&s.carry)if(o===null){if(i===null||!C("portableBlock","spring")(i))return;i.state.unsolidAfterProgression=-1,e.state.carrying=i,e.state.standingOn=null;for(const l of i.state.stoodOnBy)l.state.standingOn=null;i.state.stoodOnBy.clear(),s.carry=!1}else{if(e.state.standingOn===null||!Kt(e,G(t.items)))return;o.state.position=a,o.state.unsolidAfterProgression=null,Ae({subjectItem:e,gameState:r,posDelta:{x:0,y:0,z:o.aabb.z},pusher:e,forceful:!0,deltaMS:n}),e.state.carrying=null,s.carry=!1}},Kt=(e,t)=>{const r={position:F(e.state.position,{z:R.h})},n=Dt({id:e.id,aabb:e.aabb,state:r},t);for(const s of n)if(!W(s)||!Kt(s,t))return!1;return!0};function*Yn(e,t,r){for(;(e.state.latentMovement.at(0)?.moveAtGameTime??Number.POSITIVE_INFINITY)<t.gameTime;){const{positionDelta:n}=e.state.latentMovement.shift();yield{movementType:"position",posDelta:n}}}function*qn(e,t,r,n){C("heels")(e)&&Hn(e,t,r,n),W(e)&&(yield Pn(e,r,n),yield Wn(e),yield*Yn(e,r)),q(e)&&e.type===r.currentCharacterName&&(yield Gn(e,r,n),yield Fn(e,r,n),yield An(e,r)),C("lift")(e)&&(yield En(e)),C("baddie")(e)&&(yield Er(e,t,r,n))}const Jn=(e,t,r,n)=>{let s=$;for(const o of qn(e,t,r,n)){if(o.movementType==="position"&&(s=F(s,o.posDelta)),o.movementType==="vel"&&(W(e)||C("lift")(e)))for(const[a,c]of Ze(o.vels)){const l={...$,...c};e.state.vels[a]=l}const i=o.stateDelta;if(i!==void 0&&(e.state={...e.state,...i}),o.movementType==="endTick")return!0}return(W(e)||C("lift")(e))&&(s=F(s,...be(G(e.state.vels)).map(o=>I(o,n)))),Ae({subjectItem:e,posDelta:s,gameState:r,deltaMS:n})},Zn=e=>{e.currentCharacterName=Rt(e.currentCharacterName)},Kn=e=>{const{currentCharacterName:t}=e,{room:r,entryState:n}=e.characterRooms[t],s=r.items[t],o=Rt(t),i=s.state,a=s.state.lives-1;if(a===0){s.state.lives=a,e.characterRooms[t]=void 0,e.currentCharacterName=o;return}s.state={...i,...n,expires:null,lives:a,standingOn:null};const c=Xe(e.campaign.rooms[r.id],e.pickupsCollected[r.id],{[t]:s});e.characterRooms[t].room=c},Qn=.001,es=(e,t,r)=>{if(!J(t,r))return!1;const{state:{position:n,vels:{gravity:{z:s}}},aabb:o,id:i}=e;if(s>0)return!1;const a=F(n,{z:-Qn});return zt({state:{position:a},aabb:o,id:i},t)},ts=20,rs=(e,t)=>e.state.expires!==null&&e.state.expires<t.gameTime,ns=(e,t)=>{delete e.items[t.id];for(const r of t.state.stoodOnBy)W(r)&&(r.state.standingOn=null)},ss=(e,t)=>{for(const r of G(e.items))ae(t[r.id],r.state.position)&&!Rr(r.state.position)&&(console.log(`snapping item ${r.id} to pixel grid`),r.state.position=$r(r.state.position))},os=(e,t)=>{const r={lift:-4,head:-3,heels:-3,baddie:-2,block:1,deadlyBlock:1},n=r[e.type]??0,s=r[t.type]??0;return n-s},is=(e,t)=>{const r=Math.ceil(t/ts),n=t/r,{inputState:s}=e;if(s.swop){Zn(e),s.swop=!1;return}const o=A(e),i=Object.fromEntries(be(Ze(o.items)).map(([a,c])=>[a,c.state.position]));for(let a=0;a<r;a++){for(const l of G(o.items))if(rs(l,e))if(q(l)){Kn(e);return}else ns(o,l);const c=Object.values(o.items).sort(os);for(const l of c){if(Dr(e).state.action==="death")break;if(o.items[l.id]===void 0)throw new Error(`item ${l.id} is not in room ${o.id}`);if(Jn(l,o,e,n))return}for(const l of c)for(const u of l.state.stoodOnBy)if(!es(u,l,e.progression))as(u);else{const f={...Oe(l.state.position,i[l.id]),z:0};ae(f,$)||u.state.latentMovement.push({moveAtGameTime:e.gameTime+2*zr,positionDelta:f})}if(e.progression++,e.gameTime+=n,o!==A(e))throw new Error(`room has changed during physics tick ${o.id} -> ${A(e).id} but did not return out of the tick`)}ss(o,i)},as=e=>{e.state.standingOn!==null&&e.state.standingOn.state.stoodOnBy.delete(e),e.state.standingOn=null},Qt=e=>{const t={},r=Object.values(e.items).filter(C("doorFrame"));for(const{config:{direction:n},state:{position:{x:s,y:o}}}of r)Pe(n)==="x"?o<0?t.towards=!0:o===e.size.y*R.d&&(t.away=!0):s<0?t.right=!0:s===e.size.x*R.w&&(t.left=!0);return t},er=e=>{const t=Qt(e),r=t.right?-.5:0,n=e.size.x+(t.left?.5:0),s=t.towards?-.5:0,o=e.size.y+(t.away?.5:0),i=N({x:r,y:o}),a=N({x:n,y:s}),c=N({x:r,y:s}),l=N({x:n,y:o}),u=l.y+ge.h;return{blockXMin:r,blockXMax:n,blockYMin:s,blockYMax:o,rightSide:i,leftSide:a,frontSide:c,backSide:l,top:u}},ls=e=>{const{towards:t,right:r}=Qt(e),{blockXMin:n,blockYMin:s,rightSide:o,leftSide:i,frontSide:a,backSide:c}=er(e),{floor:l,color:{shade:u}}=e,h=new g({label:`floor(${e.id})`}),f=Object.fromEntries(e.floorSkip.map(({x:T,y:S})=>[`${T},${S}`,!0]));if(l!=="none"){const T=l==="deadly"?`generic${u==="dimmed"?".dark":""}.floor.deadly`:`${l}${u==="dimmed"?".dark":""}.floor`,S=new g;for(let w=-1;w<=e.size.x;w++)for(let H=w%2-1;H<=e.size.y;H+=2)f[`${w},${H}`]||S.addChild(K({x:w,y:H},d({anchor:{x:.5,y:1},texture:T})));for(let w=0;w<=e.size.x;w++)e.walls.away[w]!=="none"&&S.addChild(K({x:w,y:e.size.y},d({anchor:{x:0,y:1},texture:"generic.floor.overdraw",flipX:!0})));for(let w=0;w<=e.size.y;w++)e.walls.left[w]!=="none"&&S.addChild(K({x:e.size.x,y:w},d({anchor:{x:0,y:1},texture:"generic.floor.overdraw"})));const j=new Y().poly([a,o,c,i],!0).fill(16711680).stroke({width:8});S.addChild(j),S.mask=j,h.addChild(S)}const p=new g;for(let T=n;T<=e.size.x;T+=.5)p.addChild(K({x:T,y:t?-.5:0},d({pivot:{x:7,y:0},texture:"generic.edge.towards"})));p.filters=We(e,"towards");const O=new g;for(let T=s;T<=e.size.y;T+=.5)O.addChild(K({x:r?-.5:0,y:T},d({pivot:{x:0,y:0},texture:"generic.edge.right"})));O.filters=We(e,"right");const k=N({x:0,y:e.size.y}),L=N({x:e.size.x,y:0}),V=new Y().poly([{x:a.x,y:a.y+16},{x:k.x,y:k.y+16},{x:k.x,y:-999},{x:L.x,y:-999},{x:L.x,y:L.y+16}],!0).fill(16776960);return h.addChild(V),h.addChild(p),h.addChild(O),h.mask=V,h},kt=(e,t)=>{const r=y(e),n=y(F(e,{x:t.x,z:t.z})),s=y(F(e,{y:t.y,z:t.z}));return{bottomCentre:r,topLeft:n,topRight:s}},$e=(e,t,r,n,s=1e-5)=>n-s>e&&r<t-s,cs=(e,t,r,n)=>{const s=kt(e,t),o=kt(r,n),i=s.topLeft.x,a=s.topRight.x,c=o.topLeft.x,l=o.topRight.x,u=$e(i,a,c,l),h=s.topRight.y-s.topRight.x/2,f=s.bottomCentre.y-s.bottomCentre.x/2;if(h>f)throw new Error(`aXAxisSlopeMinC ${h} > aXAxisSlopeMaxC ${f}`);const p=o.topRight.y-o.topRight.x/2,O=o.bottomCentre.y-o.bottomCentre.x/2;if(p>O)throw new Error("bXAxisSlopeMinC > bXAxisSlopeMaxC");const k=$e(h,f,p,O),L=s.topLeft.y+s.topLeft.x/2,V=s.bottomCentre.y+s.bottomCentre.x/2;if(L>V)throw new Error("aYAxisSlopeMinC > aYAxisSlopeMaxC");const T=o.topLeft.y+o.topLeft.x/2,S=o.bottomCentre.y+o.bottomCentre.x/2;if(T>S)throw new Error("bYAxisSlopeMinC > bYAxisSlopeMaxC");const j=$e(L,V,T,S);return u&&k&&j},ds=(e,t)=>{if(e.renders===!1||t.renders===!1)return 0;const r=e.state.position,n=e.renderAabb||e.aabb,s=t.state.position,o=t.renderAabb||t.aabb;if(!cs(r,n,s,o))return 0;for(const i of Br){const a=e.state.position[i],c=a+n[i],l=t.state.position[i],u=l+o[i];if(c<=l)return 1*(i==="z"?-1:1);if(a>=u)return-1*(i==="z"?-1:1)}return Pt(t)-Pt(e)},Pt=e=>e.state.position.x+e.state.position.y-e.state.position.z;class ye extends Error{constructor(t,r,n,s){super(t,s),this.cyclicDependency=r,this.hasClosedCycle=n}}const us=e=>hs(fs(e),e),hs=(e,t)=>{let r=e.length,n=r;const s=new Array(r),o={},i=ps(t),a=ms(e);for(t.forEach(function(l){if(!a.has(l[0])||!a.has(l[1]))throw new Error("Unknown node. There is an unknown node in the supplied edges.")});n--;)o[n]||c(e[n],n,new Set);return s;function c(l,u,h){if(h.has(l))throw new ye("Cyclic dependency found - see .cyclicDependency of this error for details",[l],!1);if(!a.has(l))throw new Error("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(l));if(o[u])return;o[u]=!0;const f=i.get(l)||new Set,p=Array.from(f);if(u=p.length){h.add(l);do{const O=p[--u];try{c(O,a.get(O),h)}catch(k){throw k instanceof ye?k.hasClosedCycle?k:new ye(k.message,[...k.cyclicDependency,l],k.cyclicDependency.includes(l)):k}}while(u);h.delete(l)}s[--r]=l}};function fs(e){const t=new Set;for(let r=0,n=e.length;r<n;r++){const s=e[r];t.add(s[0]),t.add(s[1])}return Array.from(t)}function ps(e){const t=new Map;for(let r=0,n=e.length;r<n;r++){const s=e[r];t.has(s[0])||t.set(s[0],new Set),t.has(s[1])||t.set(s[1],new Set),t.get(s[0]).add(s[1])}return t}function ms(e){const t=new Map;for(let r=0,n=e.length;r<n;r++)t.set(e[r],r);return t}const gs=e=>{const t=[];for(const r of e)if(r.renders)for(const n of e){if(r===n)break;if(!n.renders)continue;const s=ds(r,n);s!==0&&(s>0?t.push([n.id,r.id]):t.push([r.id,n.id]))}return t},tr=(e,t,r=3)=>{try{return{order:us(e),impossible:!1}}catch(n){if(n instanceof ye){const s=n.cyclicDependency,o=e.find(([i,a])=>s.includes(i)&&s.includes(a));if(o===void 0)throw new Error("could not find bad link");return{order:tr(e.filter(i=>i!==o),t,r-1).order,impossible:!0}}else throw n}},ys=(e,t)=>{const{leftSide:r,rightSide:n,frontSide:s,top:o}=er(e),i=(n.x+r.x)/2,a=(o+s.y)/2;t.x=-i,t.y=-a},Ot=(e,t)=>{const r=new g({label:`room(${e.id})`}),n=new g({label:`items(room(${e.id}))`});r.addChild(ls(e)),r.addChild(n),r.filters=on(e),ys(e,r);const s=new Map;return{get container(){return r},get room(){return e},tick(){let o=!1;for(const i of G(e.items)){let a=s.get(i.id);a===void 0&&(a=Zt(i,e,t),s.set(i.id,a),n.addChild(a.container)),o=a.tick()||o}if(o){const{order:i}=tr(gs(G(e.items)),e.items);for(let a=0;a<i.length;a++){const c=s.get(i[a]);if(c===void 0)throw new Error(`Item id=${i[a]} does not have a renderer - cannot assign a z-index`);c.container.zIndex=a}}},destroy(){r.destroy({children:!0}),s.forEach(o=>{o.destroy()})},get renderOptions(){return t}}},ws=4,vs=(e,t)=>{const r=new g;r.label="world",r.y=Ne.height*.7,e.stage.addChild(r);const n=new g;n.y=-ws,e.stage.addChild(n);const s=new se(U().shadow);let o=Ot(A(t),t.renderOptions);r.addChild(o.container);const i=kn(n),a=nn(e),c=({deltaMS:l})=>{const u=a.rescale();r.x=e.renderer.width/a.curUpscale/2;const{renderOptions:h,inputState:{windowFocus:f}}=t,p=!f;if(i(t,u,h),(o.room!==A(t)||o.renderOptions!==t.renderOptions)&&(o.destroy(),o=Ot(A(t),t.renderOptions),r.addChild(o.container)),!p)e.stage.filters=re,is(t,l),o.tick();else{e.stage.filters=s;const O=A(t).color;s.targetColor=Ht(O).main.original}};return{start(){return e.ticker.add(c),this},stop(){e.stage.removeChild(r),e.ticker.remove(c)}}},xs=async e=>{const t={showBoundingBoxes:"none"},r=new Gt;await r.init({background:"#000000",resizeTo:window});const n=rn(e,t),s=Qr(n),o=vs(r,n).start();return{campaign:e,events:n.events,renderIn(i){i.appendChild(r.canvas)},changeRoom(i){Je({gameState:n,toRoomId:i,changeType:"level-select"})},get currentRoom(){return A(n)},get gameState(){return n},set renderOptions(i){n.renderOptions=i},stop(){console.warn("tearing down game"),r.canvas.parentNode?.removeChild(r.canvas),o.stop(),s(),r.destroy()}}},Ts=Object.freeze(Object.defineProperty({__proto__:null,gameMain:xs},Symbol.toStringTag,{value:"Module"}));export{It as A,Xt as C,Bt as F,Wr as R,Ir as S,Ut as V,Ts as g,Lr as u};
