import{V as Ht,aa as Yt,d as Gt,v as Jt,ab as qt,ac as Zt,ad as gt,ae as xt,af as Kt,ag as Fe,ah as Ue,ai as De,a0 as T,aj as Y,b as vt,ak as Qt,C as w,al as ge,am as A,an as U,ao as de,N as We,ap as m,aq as eo,ar as $e,as as u,at as Q,au as g,av as _e,aw as V,ax as to,ay as wt,az as ue,aA as R,aB as oo,aC as no,aD as ee,aE as O,aF as D,aG as ro,aH as ve,aI as so,aJ as ie,aK as je,aL as we,aM as io,aN as ao,aO as He,aP as lo,aQ as te,aR as Te,aS as Be,aT as bt,aU as Ee,aV as be,aW as co,aX as Re,aY as le,aZ as Ct,a_ as ce,a$ as Ye,b0 as uo,b1 as kt,b2 as N,b3 as Tt,b4 as J,b5 as ho,b6 as Ce,b7 as fo,b8 as po,b9 as q,ba as Pt,bb as mo,bc as Mt,bd as yo,be as go,bf as St,bg as xo,bh as vo,bi as wo,bj as bo,bk as W,bl as pe,bm as oe,bn as Co,bo as x,bp as me,bq as ko,br as To,bs as Pe,bt as Ge,bu as Po,bv as Mo,bw as Je,bx as So,by as Ao,bz as Oo,bA as Io,bB as zo}from"./index-CpF1ZHjo.js";import{F as At}from"./Filter-BbHAhqpg.js";import{G as K}from"./Graphics-phvsw0TZ.js";import"./State-3sV0XrC-.js";class Fo extends Ht{constructor(t,o){const{text:n,resolution:r,style:s,anchor:i,width:a,height:c,roundPixels:l,...d}=t;super({...d}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=o,this.text=n??"",this.style=s,this.resolution=r??null,this.allowChildren=!1,this._anchor=new Yt({_onUpdate:()=>{this.onViewUpdate()}}),i&&(this.anchor=i),this.roundPixels=l??!1,a!==void 0&&(this.width=a),c!==void 0&&(this.height=c)}get anchor(){return this._anchor}set anchor(t){typeof t=="number"?this._anchor.set(t):this._anchor.copyFrom(t)}set text(t){t=t.toString(),this._text!==t&&(this._text=t,this.onViewUpdate())}get text(){return this._text}set resolution(t){this._autoResolution=t===null,this._resolution=t,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(t){t=t||{},this._style?.off("update",this.onViewUpdate,this),t instanceof this._styleClass?this._style=t:this._style=new this._styleClass(t),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get bounds(){return this._boundsDirty&&(this._updateBounds(),this._boundsDirty=!1),this._bounds}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(t){this._setWidth(t,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(t){this._setHeight(t,this.bounds.height)}getSize(t){return t||(t={}),t.width=Math.abs(this.scale.x)*this.bounds.width,t.height=Math.abs(this.scale.y)*this.bounds.height,t}setSize(t,o){typeof t=="object"?(o=t.height??t.width,t=t.width):o??(o=t),t!==void 0&&this._setWidth(t,this.bounds.width),o!==void 0&&this._setHeight(o,this.bounds.height)}addBounds(t){const o=this.bounds;t.addFrame(o.minX,o.minY,o.maxX,o.maxY)}containsPoint(t){const o=this.bounds.width,n=this.bounds.height,r=-o*this.anchor.x;let s=0;return t.x>=r&&t.x<=r+o&&(s=-n*this.anchor.y,t.y>=s&&t.y<=s+n)}onViewUpdate(){if(this._didViewChangeTick++,this._boundsDirty=!0,this.didViewUpdate)return;this.didViewUpdate=!0,this._didTextUpdate=!0;const t=this.renderGroup||this.parentRenderGroup;t&&t.onChildViewUpdate(this)}_getKey(){return`${this.text}:${this._style.styleKey}:${this._resolution}`}destroy(t=!1){super.destroy(t),this.owner=null,this._bounds=null,this._anchor=null,(typeof t=="boolean"?t:t?.style)&&this._style.destroy(t),this._style=null,this._text=null}}function Do(e,t){let o=e[0]??{};return(typeof o=="string"||e[1])&&(Gt(Jt,`use new ${t}({ text: "hi!", style }) instead`),o={text:o,style:e[1]}),o}class $o extends Fo{constructor(...t){const o=Do(t,"Text");super(o,qt),this.renderPipeId="text"}_updateBounds(){const t=this._bounds,o=this._anchor,n=Zt.measureText(this._text,this._style),{width:r,height:s}=n;t.minX=-o._x*r,t.maxX=t.minX+r,t.minY=-o._y*s,t.maxY=t.minY+s}}const _o=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Å","Ä","Ö","0","1","2","3","4","5","6","7","8","9","!","@","#","$","%","^","&","*","(",")","-","_","=","+","[","]","{","}",";",":","'",'"',",",".","/","<",">","?","\\","|"," ","Enter","Shift","Control","`","~","Tab","Backspace","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Numpad0","Numpad1","Numpad2","Numpad3","Numpad4","Numpad5","Numpad6","Numpad7","Numpad8","Numpad9","NumpadAdd","NumpadSubtract","NumpadMultiply","NumpadDivide","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"],qe=e=>_o.includes(e),Ot=[...xt,"jump","fire","carry","swop","pause"],Bo=()=>({...gt(Ot.map(e=>[e,!1])),windowFocus:!0}),L={right:["P"],towards:["A"],left:["O"],away:["Q"],jump:[" ","M"],carry:["C","M"],fire:["N"],swop:["Enter","S"],pause:["H"]},Xo={right:["ArrowRight",...L.right],towards:["ArrowDown",...L.towards],left:["ArrowLeft",...L.left],away:["ArrowUp",...L.away],jump:["`",...L.jump],carry:["Shift","`",...L.carry],fire:["Control",...L.fire],swop:L.swop,pause:["F8",...L.pause]};function*Ze(e,t){for(const[o,n]of Kt(e))n.includes(t)&&(yield o)}const Ke=e=>e.length===1?e.toUpperCase():e,Eo=({keyAssignment:e,inputState:t,onInputStateChange:o})=>{const n=({key:a})=>{const c=Ke(a);if(!qe(c)){console.log("do not recognise key: ",c);return}for(const l of Ze(e,c))t[l]=!0;o?.(t)},r=({key:a})=>{const c=Ke(a);if(qe(c)){for(const l of Ze(e,c))t[l]=!1;o?.(t)}},s=()=>{t.windowFocus=!0,o?.(t)},i=()=>{t.windowFocus=!1;for(const a of Ot)t[a]=!1;o?.(t)};return window.addEventListener("keydown",n,!1),window.addEventListener("keyup",r,!1),window.addEventListener("focus",s,!1),window.addEventListener("blur",i,!1),()=>{window.removeEventListener("keydown",n,!1),window.removeEventListener("keyup",r,!1),window.removeEventListener("focus",s,!1),window.removeEventListener("blur",i,!1)}};function Ro(e){return{all:e=e||new Map,on:function(t,o){var n=e.get(t);n?n.push(o):e.set(t,[o])},off:function(t,o){var n=e.get(t);n&&(o?n.splice(n.indexOf(o)>>>0,1):e.set(t,[]))},emit:function(t,o){var n=e.get(t);n&&n.slice().map(function(r){r(o)}),(n=e.get("*"))&&n.slice().map(function(r){r(t,o)})}}}const Vo=e=>{const t={};for(const o of Object.values(e.rooms))for(const n of Object.values(o.items))if(n.type==="player"){const{which:r}=n.config;t[r]=o.id}if(t.head===void 0&&t.heels===void 0)throw new Error("couldn't find either head or heels in campaign");return t},No=(e,t)=>{const o=Vo(e),n=gt(Object.keys(e.rooms).map(i=>[i,{}])),r=o.head&&Fe(e.rooms[o.head],n[o.head]),s=o.heels===o.head?r:o.heels&&Fe(e.rooms[o.heels],n[o.heels]);return{keyAssignment:Xo,currentCharacterName:o.head===void 0?"heels":"head",characterRooms:{head:r===void 0?void 0:{room:r,entryState:Ue(r.items.head)},heels:s===void 0?void 0:{room:s,entryState:Ue(s.items.heels)}},inputState:Bo(),renderOptions:t,campaign:e,events:Ro(),pickupsCollected:n,gameTime:0,progression:0}},Lo=e=>{let t=1;return{get curUpscale(){return t},rescale(){if(e.renderer.width===0||e.renderer.height===0)throw new Error;const o=Math.floor(Math.min(e.renderer.width/De.width,e.renderer.height/De.height)),n={x:Math.round(e.renderer.width/o),y:Math.round(e.renderer.height/o)};return t===o||(t=o,console.log("scale factor changed to:",o),e.stage.scale=o),n}}},$={original:new T("rgb(255, 255, 255)"),basic:new T("rgb(210, 210, 210)"),dimmed:new T("rgb(120, 120, 120)")},_={original:new T("rgb(255, 255, 0)"),basic:new T("hsl(50,58%,70%)"),dimmed:Y().redShadow},B={original:new T("rgb(255, 0, 255)"),basic:Y().pink,dimmed:new T("hsl(290,25%,40%)")},k={original:new T("rgb(0, 255, 255)"),basic:new T("hsl(183, 28%, 50%)"),dimmed:new T("hsl(183, 28%,39%)")},X={original:new T("rgb(0, 255, 0)"),basic:Y().moss,dimmed:new T("hsl(73,35%,35%)")},Ve={white:{basic:{main:$,edges:{towards:k,right:_},hud:{lives:_,dimmed:B,icons:k}},dimmed:{main:$,edges:{towards:X,right:k},hud:{lives:_,dimmed:B,icons:k}}},yellow:{basic:{main:_,edges:{towards:X,right:$},hud:{lives:k,dimmed:B,icons:X}},dimmed:{main:_,edges:{towards:k,right:k},hud:{lives:k,dimmed:B,icons:X}}},magenta:{basic:{main:B,edges:{towards:X,right:k},hud:{lives:$,dimmed:k,icons:_}},dimmed:{main:B,edges:{towards:X,right:k},hud:{lives:$,dimmed:k,icons:_}}},cyan:{basic:{main:k,edges:{towards:B,right:$},hud:{lives:$,dimmed:X,icons:_}},dimmed:{main:k,edges:{towards:B,right:$},hud:{lives:$,dimmed:X,icons:_}}},green:{basic:{main:X,edges:{towards:k,right:_},hud:{lives:$,dimmed:B,icons:k}},dimmed:{main:X,edges:{towards:k,right:_},hud:{lives:$,dimmed:B,icons:k}}}},It=e=>Ve[e.hue][e.shade],zt=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,Uo=`in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uOriginalColor;
uniform vec3 uTargetColor;
uniform float uTolerance;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);
    vec3 colorDiff = uOriginalColor - (c.rgb / max(c.a, 0.0000000001));
    float colorDistance = length(colorDiff);
    float doReplace = step(colorDistance, uTolerance);
    finalColor = vec4(mix(c.rgb, uTargetColor * c.a, doReplace), c.a);
}
`;class xe extends At{static DEFAULT_OPTIONS={originalColor:16711680,targetColor:0,tolerance:.4};uniforms;_originalColor;_targetColor;constructor(t){t={...xe.DEFAULT_OPTIONS,...t};const o=vt.from({vertex:zt,fragment:Uo,name:"palette-swap-filter"});super({glProgram:o,resources:{colorReplaceUniforms:{uOriginalColor:{value:new Float32Array(3),type:"vec3<f32>"},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"},uTolerance:{value:t.tolerance,type:"f32"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this._originalColor=new T,this._targetColor=new T,this.originalColor=t.originalColor??16711680,this.targetColor=t.targetColor??0,Object.assign(this,t)}get originalColor(){return this._originalColor.value}set originalColor(t){this._originalColor.setValue(t);const[o,n,r]=this._originalColor.toArray();this.uniforms.uOriginalColor[0]=o,this.uniforms.uOriginalColor[1]=n,this.uniforms.uOriginalColor[2]=r}get targetColor(){return this._targetColor.value}set targetColor(t){this._targetColor.setValue(t);const[o,n,r]=this._targetColor.toArray();this.uniforms.uTargetColor[0]=o,this.uniforms.uTargetColor[1]=n,this.uniforms.uTargetColor[2]=r}get tolerance(){return this.uniforms.uTolerance}set tolerance(t){this.uniforms.uTolerance=t}}const Ft=e=>[new xe({originalColor:Y().replaceLight,targetColor:e.basic,tolerance:.1}),new xe({originalColor:Y().replaceDark,targetColor:e.dimmed,tolerance:.1})],Xe=(e,t)=>Ft(Ve[e.color.hue][e.color.shade].edges[t]),Wo=e=>Ft(Ve[e.color.hue][e.color.shade].main),se=Qt,jo=`precision mediump float;
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uSourceBlacks[2];
uniform vec3 uTargetColor;

// colours are floats so check if they're very close rather than exactly equal:
bool colorsEffectivelyEqual(vec3 color1, vec3 color2) {    
    
    return distance(color1, color2) < 0.05;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a == 0.0 ) {
        finalColor = c;
        return;
    }

    if ( colorsEffectivelyEqual(c.rgb, uSourceBlacks[0]) || colorsEffectivelyEqual(c.rgb, uSourceBlacks[1])) {
        finalColor = vec4(0,0,0, 1.0);
    } else {
        finalColor = vec4(uTargetColor, 1);    
    }
}
`,Qe=[Y().pureBlack,Y().lightBlack];class ae extends At{uniforms;constructor(t="white"){const o=vt.from({vertex:zt,fragment:jo,name:"revert-colourise-filter"});super({glProgram:o,resources:{colorReplaceUniforms:{uSourceBlacks:{value:new Float32Array(6),type:"vec3<f32>",size:6},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms;const[n,r,s]=Qe[0].toArray();this.uniforms.uSourceBlacks[0]=n,this.uniforms.uSourceBlacks[1]=r,this.uniforms.uSourceBlacks[2]=s;const[i,a,c]=Qe[1].toArray();this.uniforms.uSourceBlacks[3]=i,this.uniforms.uSourceBlacks[4]=a,this.uniforms.uSourceBlacks[5]=c,this.targetColor=t}set targetColor(t){const[o,n,r]=new T(t).toArray();this.uniforms.uTargetColor[0]=o,this.uniforms.uTargetColor[1]=n,this.uniforms.uTargetColor[2]=r}}const Ho=8,Yo=24,Go=56,Jo=80,et=112,ne=e=>e==="heels"?1:-1,qo=e=>{const t=new ae,o=new ae,n=new ae,r=(c=!1)=>{const l=c?2:1,d=new $o({style:{fill:"white",fontFamily:"Head over Heels",fontSize:Ho,align:"center"},resolution:8,anchor:{x:.5,y:1}});return d.scale={x:1,y:l},d},s=c=>{const l=new We(m.textures[`${c}.walking.${c==="head"?"right":"towards"}.2`]);return l.anchor={x:.5,y:0},l},i=(c,l=!1,d=!1)=>{const h=new w;h.pivot={x:4,y:16};const f=new We({texture:m.textures[c],anchor:l?{x:.5,y:0}:{x:.5,y:1},filters:t,y:l?0:8});h.addChild(f);const p=r();return p.text="0",p.y=l?0:16,p.filters=o,p.x=f.x=eo.w/2,h.addChild(p),d&&(p.visible=!1),{text:p,icon:f,container:h}},a={head:{sprite:s("head"),livesText:r(!0),shield:i("hud.shield"),extraSkill:i("hud.fastSteps"),donuts:i("donuts",!0),hooter:i("hooter",!0,!0)},heels:{sprite:s("heels"),livesText:r(!0),shield:i("hud.shield"),extraSkill:i("hud.bigJumps"),bag:i("bag",!0,!0),carrying:{container:new w}}};for(const c of ge)e.addChild(a[c].livesText),e.addChild(a[c].sprite),e.addChild(a[c].shield.container),e.addChild(a[c].extraSkill.container);return e.addChild(a.head.donuts.container),e.addChild(a.head.hooter.container),e.addChild(a.heels.bag.container),e.addChild(a.heels.carrying.container),(c,l)=>{const d=A(c),{hud:{dimmed:h,lives:f,icons:p}}=It(d.color),P=y=>{const I=de(c,y),z=I?.state.shieldCollectedAt??null,{text:H,container:Ne}=a[y].shield,{text:Wt,container:Le}=a[y].extraSkill;Le.x=Ne.x=(l.x>>1)+ne(y)*Jo;const jt=z===null||c.gameTime>z+$e?0:100-Math.ceil((c.gameTime-z)/($e/100));H.text=`${jt}`,Ne.y=l.y,Wt.text=I===void 0?"0":I.type==="head"?I.state.fastSteps:I.state.bigJumps,Le.y=l.y-24},b=y=>{const I=c.currentCharacterName===y,z=a[y].sprite;z.filters=I?se:n,z.x=(l.x>>1)+ne(y)*Go,z.y=l.y-U.h},M=y=>{const z=de(c,y)?.state.lives??0,H=a[y].livesText;H.x=(l.x>>1)+ne(y)*Yo,H.y=l.y,H.style.fill=f.basic,H.text=`${z??0}`},j=y=>{const{container:I}=a.heels.carrying,z=I.children.length>0;if(y===null&&z)for(const H of I.children)H.destroy();y!==null&&!z&&I.addChild(u(y.type==="spring"?"spring.released":y.config.style))};n.targetColor=h.dimmed,o.targetColor=h.basic,t.targetColor=p.basic;for(const y of ge)M(y),b(y),P(y);a.head.hooter.container.x=a.head.donuts.container.x=(l.x>>1)+ne("head")*et,a.head.donuts.container.y=l.y-U.h-8,a.heels.carrying.container.y=l.y-U.h,a.heels.carrying.container.x=a.heels.bag.container.x=(l.x>>1)+ne("heels")*et,a.heels.bag.container.y=a.head.hooter.container.y=l.y-8;const v=de(c,"head"),S=v?.state.hasHooter??!1;a.head.hooter.icon.filters=S?se:n;const G=v?.state.donuts??0;a.head.donuts.icon.filters=G!==0?se:n,a.head.donuts.text.text=`${G}`;const C=de(c,"heels"),Z=C?.state.hasBag??!1;j(C?.state.carrying??null),a.heels.bag.icon.filters=Z?se:n}},tt={movementType:"vel",vels:{gravity:V}},Zo=(e,t,o)=>{if(!Q(e,t.progression))return tt;const{type:n,state:{vels:{gravity:{z:r}},standingOn:s}}=e,i=to[n==="head"?"head":"others"];return s!==null?g("lift")(s)&&s.state.vels.lift.z<0?{movementType:"vel",vels:{gravity:{z:Math.max(r-_e*o,-i)}}}:tt:{movementType:"vel",vels:{gravity:{z:Math.max(r-_e*o,-i)}}}},he=e=>{const o=e/no*oo;return(e+.5*_e*o**2)/o},Ko={head:he(ue.head),headOnSpring:he(ue.head+R.h),heels:he(ue.heels),heelsOnSpring:he(ue.heels+R.h)},Qo=(e,t)=>Ko[`${e}${t?"OnSpring":""}`],en=({type:e,state:{standingOn:t}},o,n)=>{const{inputState:{jump:r}}=o,s=t!==null&&g("teleporter")(t);if(!(r&&t!==null&&!s))return t!==null?{movementType:"steady",stateDelta:{jumped:!1}}:wt;const a=g("spring")(t);return{movementType:"vel",vels:{gravity:{z:Qo(e,a)}},stateDelta:{action:"moving",jumped:!0}}},tn=({vel:e,acc:t,unitD:o,maxSpeed:n,deltaMS:r,crossComponentFade:s=0,minVelocity:i=0})=>{const a=ee(e,o),c=Math.max(a+t*r,i),l=c>=n,d=ro(o),h=ee(e,d),f=h>=0?Math.max(h-s*r,0):Math.min(h+s*r,0);return O(D(o,l?n:c),D(d,f))},ot={movementType:"vel",vels:{walking:V}},on=(e,{inputState:t},o)=>{const{type:n,state:{autoWalk:r,standingOn:s,facing:i,teleporting:a,vels:{walking:c,gravity:l}}}=e,d=r?i:xt.find(M=>t[M]===!0),h=we[n];if(a!==null)return ot;if(n==="heels"){if(s===null)return e.state.jumped?{movementType:"vel",vels:{walking:ve(c,D(c,so*o))}}:ot;if(t.jump){const M=d??i,v=g("spring")(s)?1:io;return{movementType:"vel",vels:{walking:D(ie[M],h*v)},stateDelta:{facing:M}}}}const f=s===null&&l.z<0;if(d!==void 0)return f?{movementType:"vel",vels:{walking:D(ie[d],h)},stateDelta:{facing:d,action:"falling"}}:{movementType:"vel",vels:{walking:tn({vel:c,acc:ao[n],deltaMS:o,maxSpeed:h,unitD:ie[d],crossComponentFade:He[n],minVelocity:je[n]})},stateDelta:{facing:d,action:"moving"}};const p=lo(c),P=p===0?V:D(c,1/p),b=Math.max(p-He[n]*o,0);return{movementType:"vel",vels:{walking:D(P,b<je[n]?0:b)},stateDelta:{action:f?"falling":"idle"}}},nt=R.h,fe=.001,nn=({totalDistance:e,currentAltitude:t,direction:o})=>{const n=Te**2/(2*te);if(o==="up"){if(t<=n)return Math.max(fe,Math.sqrt(2*te*Math.max(t,0)));if(t>=e-n){const r=Math.max(0,e-t);return Math.max(fe,Math.sqrt(2*te*r))}else return Te}else if(t>=e-n){const r=Math.max(0,e-t);return Math.min(-fe,-Math.sqrt(2*te*r))}else return t<=n?Math.min(-fe,-Math.sqrt(2*te*Math.max(t,0))):-Te};function rn({config:{bottom:e,top:t},state:{direction:o,position:{z:n}}},r,s){const i=e*nt,a=t*nt,c=nn({currentAltitude:n-i,direction:o,totalDistance:a-i});if(Number.isNaN(c))throw new Error("velocity is NaN");const l=n<=i?"up":n>=a?"down":o;return{movementType:"vel",vels:{lift:{z:c}},stateDelta:{direction:l}}}const rt=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),st={stopAutowalk:0,portal:0,wall:0,doorLegs:0,sceneryPlayer:0,block:1,barrier:1,floor:1,book:1,hushPuppy:1,teleporter:1,doorFrame:1,lift:2,movableBlock:2,portableBlock:2,slidingBlock:2,spring:2,ball:3,joystick:3,switch:3,charles:3,conveyor:3,head:3,heels:3,pickup:8,scroll:8,slidingDeadly:10,moveableDeadly:10,deadlyBlock:10,baddie:10},Dt=(e,t)=>st[e.type]-st[t.type],sn=(e,t)=>t.toSorted((o,n)=>{const r=Dt(o,n);if(r!==0)return r;const s=ee(e,rt(e,o)),i=ee(e,rt(e,n));return s-i});function an({gameState:e,movingItem:t}){if(t.state.action==="death")return!1;const{shieldCollectedAt:o}=t.state;return o!==null&&o+$e>e.gameTime?!1:(t.state.action="death",t.state.expires=e.gameTime+Be,!0)}const Me=g("head"),it=g("heels"),ln=({gameState:e,movingItem:t,touchedItem:o})=>{const n=A(e).id;if(e.pickupsCollected[n][o.id]===!0)return;const r=e.pickupsCollected[n];switch(r[o.id]=!0,bt(o,e),o.config.gives){case"hooter":{if(Me(t)){t.state.hasHooter=!0;break}break}case"donuts":{if(Me(t)){t.state.donuts+=6;break}break}case"bag":{if(it(t)){t.state.hasBag=!0;break}break}case"shield":{t.state.shieldCollectedAt=e.gameTime;break}case"fast":{Me(t)&&(t.state.fastSteps=99);break}case"jumps":{it(t)&&(t.state.bigJumps=10);break}case"extra-life":t.state.lives+=2;break}},cn=({gameState:e,movingItem:t,touchedItem:o,movementVector:n})=>{const{config:{relativePoint:r,toRoom:s,direction:i},state:{position:a}}=o,c=ie[i];return ee(c,n)<=0?!1:(Ee({gameState:e,toRoomId:s,positionRelativeToSourcePortal:ve(t.state.position,O(a,r)),sourcePortal:o,changeType:"portal"}),!0)},dn=({movingItem:e,movementVector:t,touchedItem:o})=>{const{config:{direction:n,nearness:r}}=o,s=be(n),i=r==="far"?{x:s==="x"?-Math.abs(t.y):0,y:s==="y"?-Math.abs(t.x):0,z:0}:{x:s==="x"?Math.abs(t.y):0,y:s==="y"?Math.abs(t.x):0,z:0};return e.state.position=O(e.state.position,i),!1};function un({movingItem:e}){return e.state.autoWalk=!1,!1}const hn=({gameState:{events:e},touchedItem:t,gameState:{progression:o}})=>{const{config:n,state:{touchedOnProgression:r}}=t;t.state.touchedOnProgression=o,o!==r+1&&e.emit("scrollOpened",n)},F=(e,...t)=>g(...t)(e.touchedItem),Se=(e,...t)=>g(...t)(e.movingItem),at=e=>{switch(!0){case F(e,"stopAutowalk"):un(e);break;case(F(e,...co)||F(e,"floor")&&e.touchedItem.config.deadly):if(an(e))return!0;break;case F(e,"portal"):if(cn(e))return!0;break;case F(e,"pickup"):ln(e);break;case F(e,"doorFrame"):dn(e);break;case F(e,"block","barrier"):{(g("barrier")(e.touchedItem)&&e.touchedItem.config.disappearing||g("block")(e.touchedItem)&&e.touchedItem.state.disappearing)&&bt(e.touchedItem,e.gameState);break}case F(e,"scroll"):hn(e)}return!1},fn=({touchedItem:e,gameState:t})=>{const o=A(t),{config:{activates:n},state:{setting:r,touchedOnProgression:s}}=e;if(e.state.touchedOnProgression=t.progression,t.progression===s+1||t.progression===s)return;const i=e.state.setting=r==="left"?"right":"left";for(const[a,c]of Re(n)){const l=o.items[a];l.state={...l.state,...c[i]}}return!1},pn=({movingItem:e,touchedItem:t,gameState:o})=>{if(!Q(e,o.progression))return;const{state:{position:n},aabb:r}=t,s=le(e.state.position,e.aabb,n,r);if(s.x===0&&s.y===0)return;const i=Ct(s),a=D(i,-we.ball);return t.state.vels.sliding=a,!1},mn=({movingItem:e,touchedItem:t,gameState:o})=>{if(!Q(t,o.progression))return;const n=e.state.vels.sliding;if(ce(n,V))return;const{state:{position:r},aabb:s}=e,i=le(t.state.position,t.aabb,r,s);return ee(i,e.state.vels.sliding)>0&&(e.state.vels.sliding=V),!1},yn=({gameState:e,movingItem:t,touchedItem:o,deltaMS:n})=>{const r=A(e),{config:{controls:s},state:{position:i},aabb:a}=o,c=le(t.state.position,t.aabb,i,a);if(c.x===0&&c.y===0)return;const l=Ct(c);for(const d of s){const h=r.items[d],f=D(l,-we.charles*n);h.state.facing=f,ke({subjectItem:h,posDelta:f,gameState:e,pusher:o,deltaMS:n})}return!1},$t=e=>!!(Se(e,...ge)&&at(e)||F(e,...ge)&&at({...e,movingItem:e.touchedItem,touchedItem:e.movingItem})||F(e,...Ye)&&pn(e)||Se(e,...Ye)&&mn(e)||Se(e,"baddie")&&uo(e)||F(e,"switch")&&fn(e)||F(e,"joystick")&&yn(e)),_t=e=>{e.state.standingOn!==null&&e.state.standingOn.state.stoodOnBy.delete(e),e.state.standingOn=null},Bt=(e,t)=>{e.state.standingOn=t,t.state.stoodOnBy.add(e)},ke=({subjectItem:e,posDelta:t,gameState:o,pusher:n,deltaMS:r,forceful:s=g("lift")(e)&&n===void 0,recursionDepth:i=0})=>{if(ce(t,V))return!1;if(i>16)throw new Error("this probably means a non-terminating issue");const a=A(o),{state:{position:c}}=e;e.state.position=O(c,t);const l=sn(t,kt(e,N(a.items)));for(const d of l){if(!Tt(e,d))continue;if(n!==d&&$t({movingItem:e,touchedItem:d,movementVector:ve(e.state.position,c),gameState:o,deltaMS:r}))return!0;if(!Q(d,o.progression)||!Q(e,o.progression))continue;const h=le(e.state.position,e.aabb,d.state.position,d.aabb);if(J(d)&&d!==n){const f=s||ho(d)?-1:-.5,p=D(h,f);if(e.state.position=O(e.state.position,h,p),ke({subjectItem:d,posDelta:p,pusher:e,gameState:o,deltaMS:r,forceful:s,recursionDepth:i+1}))return!0;e.state.position=O(e.state.position,le(e.state.position,e.aabb,d.state.position,d.aabb))}else e.state.position=O(e.state.position,h);J(e)&&h.z>0&&(e.state.standingOn===null||!l.includes(e.state.standingOn))&&(_t(e),Bt(e,d))}return!1};function gn(e,t,o){const{state:{teleporting:n,standingOn:r}}=e,{inputState:{jump:s}}=t;if(n===null)return s&&r!==null&&g("teleporter")(r)?{movementType:"steady",stateDelta:{teleporting:{phase:"out",toRoom:r.config.toRoom,timeRemaining:Be}}}:wt;const i=Math.max(n.timeRemaining-o,0);switch(n.phase){case"out":if(i===0)return Ee({gameState:t,toRoomId:n.toRoom,changeType:"teleport"}),{movementType:"endTick",stateDelta:{teleporting:{phase:"in",timeRemaining:Be}}};break;case"in":if(i===0)return{movementType:"steady",stateDelta:{teleporting:null}};break}return{movementType:"steady",stateDelta:{teleporting:{...n,timeRemaining:i}}}}const lt={movementType:"vel",vels:{movingFloor:V},stateDelta:{activeConveyor:null}},xn=(e,t,o)=>{if(Ce(e)&&e.state.teleporting!==null)return lt;const{state:{standingOn:n}}=e;if(n===null||!g("conveyor")(n))return lt;const{config:{direction:r}}=n,i=g("heels")(e)&&e.state.action==="moving"&&e.state.facing===fo(r)?we.heels:po;return{movementType:"vel",vels:{movingFloor:D(ie[r],i)},stateDelta:{activeConveyor:n}}},vn=(e,t,o,n)=>{const r=Math.max(0,Math.min(e.x+t.x,o.x+n.x)-Math.max(e.x,o.x)),s=Math.max(0,Math.min(e.y+t.y,o.y+n.y)-Math.max(e.y,o.y));return r*s},ct=({state:{position:e},aabb:t},{state:{position:o},aabb:n})=>vn(e,t,o,n),wn=.001,Xt=(e,t,o)=>{if(!Q(t,o)||e.id===t.id)return!1;const{state:{position:n,vels:{gravity:{z:r}}},aabb:s,id:i}=e;if(r>0)return!1;const a=O(n,{z:-wn});return Tt({state:{position:a},aabb:s,id:i},t)},Et=(e,t,o)=>{const r=[...q(t).filter(i=>Xt(e,i,o))];return r.length===0?void 0:r.reduce((i,a)=>{const c=Dt(a,i);return c>0||c===0&&ct(e,a)>ct(e,i)?a:i})},bn=(e,t,o,n)=>{const{inputState:r}=o,{state:{carrying:s,position:i,hasBag:a}}=e;if(!a)return;const c=q(N(t.items)).filter(Pt),l=s===null?kn(e,t,o):void 0;for(const d of c)d.state.wouldPickUpNext=!1;if(l!==void 0&&(l.state.wouldPickUpNext=!0),r.carry){if(s===null){if(l===void 0){console.warn("nothing to pick up");return}Cn(t,e,l)}else{if(e.state.standingOn===null||!Rt(e,N(t.items)))return;const d=mo(o,t,s.type,s.config);d.state.position=i,ke({subjectItem:e,gameState:o,posDelta:{x:0,y:0,z:d.aabb.z},pusher:e,forceful:!0,deltaMS:n}),e.state.carrying=null}r.carry=!1}},Cn=(e,t,o)=>{const n={type:o.type,config:o.config};t.state.carrying=n,Mt(e,o)},kn=(e,t,o)=>Et(e,q(N(t.items)).filter(Pt),o.progression),Rt=(e,t)=>{const o={position:O(e.state.position,{z:R.h})},n=kt({id:e.id,aabb:e.aabb,state:o},t);for(const r of n)if(!J(r)||!Rt(r,t))return!1;return!0};function*Tn(e,t,o){for(;(e.state.latentMovement.at(0)?.moveAtGameTime??Number.POSITIVE_INFINITY)<t.gameTime;){const{positionDelta:n}=e.state.latentMovement.shift();yield{movementType:"position",posDelta:n}}}function*Pn(e,t,o,n){J(e)&&(yield Zo(e,o,n),yield xn(e),yield*Tn(e,o)),Ce(e)&&e.type===o.currentCharacterName&&(yield gn(e,o,n),yield on(e,o,n),yield en(e,o),g("heels")(e)&&bn(e,t,o,n)),g("lift")(e)&&(yield rn(e)),g("baddie")(e)&&(yield yo(e,t,o,n))}const Mn=(e,t,o,n)=>{let r=V;const s=[...Pn(e,t,o,n)];for(const i of s){if(i.movementType==="position"&&(r=O(r,i.posDelta)),i.movementType==="vel"&&(J(e)||g("lift")(e)))for(const[c,l]of Re(i.vels)){const d={...V,...l};e.state.vels[c]=d}const a=i.stateDelta;if(a!==void 0&&(e.state={...e.state,...a}),i.movementType==="endTick")return!0}return(J(e)||g("lift")(e))&&(r=O(r,...q(N(e.state.vels)).map(i=>D(i,n)))),ke({subjectItem:e,posDelta:r,gameState:o,deltaMS:n})},Sn=e=>{go(e)!==void 0&&(e.currentCharacterName=St(e.currentCharacterName))},An=e=>{const{currentCharacterName:t}=e,{room:o,entryState:n}=e.characterRooms[t],r=o.items[t],s=St(t),i=r.state,a=r.state.lives-1;if(a===0){r.state.lives=a,e.characterRooms[t]=void 0,e.currentCharacterName=s;return}r.state={...i,...n,expires:null,lives:a,standingOn:null};const c=Fe(e.campaign.rooms[o.id],e.pickupsCollected[o.id],{[t]:r});e.characterRooms[t].room=c},On=10,In=(e,t)=>e.state.expires!==null&&e.state.expires<t.gameTime,zn=(e,t)=>{for(const o of N(e.items)){const n=t[o.id];if(n===void 0)continue;ce(n,o.state.position)&&!wo(o.state.position)&&(console.log(`snapping item ${o.id} to pixel grid`),o.state.position=bo(o.state.position))}},Fn=(e,t)=>{const o={lift:-4,head:-3,heels:-3,baddie:-2,block:1,deadlyBlock:1},n=o[e.type]??0,r=o[t.type]??0;return n-r},Dn=(e,t)=>{const o=Math.ceil(t/On),n=t/o,{inputState:r}=e;if(r.swop){Sn(e),r.swop=!1;return}const s=A(e);for(let i=0;i<o;i++){const a=Object.fromEntries(q(Re(s.items)).map(([l,d])=>[l,d.state.position]));for(const l of N(s.items))if(In(l,e))if(Ce(l)){An(e);return}else Mt(s,l);const c=Object.values(s.items).sort(Fn);for(const l of c){if(xo(e).state.action==="death")break;if(s.items[l.id]!==void 0&&Mn(l,s,e,n))return}for(const l of c)for(const d of l.state.stoodOnBy)if(Xt(d,l,e.progression)){const f={...ve(l.state.position,a[l.id]),z:0};ce(f,V)||d.state.latentMovement.push({moveAtGameTime:e.gameTime+2*vo,positionDelta:f})}else{_t(d);const h=Et(d,N(s.items),e.progression);h!==void 0&&Bt(d,h)}for(const l of c)!J(l)||l.state.standingOn===null||$t({movingItem:l,touchedItem:l.state.standingOn,gameState:e,deltaMS:t,movementVector:{x:0,y:0,z:-1}});if(e.progression++,e.gameTime+=n,s!==A(e))throw new Error(`room has changed during physics tick ${s.id} -> ${A(e).id} but did not return out of the tick`);zn(s,a)}},Vt=e=>{const t={},o=Object.values(e.items).filter(g("doorFrame"));for(const{config:{direction:n},state:{position:{x:r,y:s}}}of o)be(n)==="x"?s<0?t.towards=!0:s===e.size.y*R.d&&(t.away=!0):r<0?t.right=!0:r===e.size.x*R.w&&(t.left=!0);return t},Nt=e=>{const t=Vt(e),o=t.right?-.5:0,n=e.size.x+(t.left?.5:0),r=t.towards?-.5:0,s=e.size.y+(t.away?.5:0),i=W({x:o,y:s}),a=W({x:n,y:r}),c=W({x:o,y:r}),l=W({x:n,y:s}),d=l.y+pe.h;return{blockXMin:o,blockXMax:n,blockYMin:r,blockYMax:s,rightSide:i,leftSide:a,frontSide:c,backSide:l,top:d}},$n=e=>{const{towards:t,right:o}=Vt(e),{blockXMin:n,blockYMin:r,rightSide:s,leftSide:i,frontSide:a,backSide:c}=Nt(e),{floor:l,color:{shade:d}}=e,h=new w({label:`floor(${e.id})`}),f=Object.fromEntries(e.floorSkip.map(({x:v,y:S})=>[`${v},${S}`,!0]));if(l!=="none"){const v=l==="deadly"?`generic${d==="dimmed"?".dark":""}.floor.deadly`:`${l}${d==="dimmed"?".dark":""}.floor`,S=new w;for(let C=-1;C<=e.size.x;C++)for(let Z=C%2-1;Z<=e.size.y;Z+=2)f[`${C},${Z}`]||S.addChild(oe({x:C,y:Z},u({anchor:{x:.5,y:1},texture:v})));for(let C=0;C<=e.size.x;C++)e.walls.away[C]!=="none"&&S.addChild(oe({x:C,y:e.size.y},u({anchor:{x:0,y:1},texture:"generic.floor.overdraw",flipX:!0})));for(let C=0;C<=e.size.y;C++)e.walls.left[C]!=="none"&&S.addChild(oe({x:e.size.x,y:C},u({anchor:{x:0,y:1},texture:"generic.floor.overdraw"})));const G=new K().poly([a,s,c,i],!0).fill(16711680).stroke({width:8});S.addChild(G),S.mask=G,h.addChild(S)}const p=new w;for(let v=n;v<=e.size.x;v+=.5)p.addChild(oe({x:v,y:t?-.5:0},u({pivot:{x:7,y:0},texture:"generic.edge.towards"})));p.filters=Xe(e,"towards");const P=new w;for(let v=r;v<=e.size.y;v+=.5)P.addChild(oe({x:o?-.5:0,y:v},u({pivot:{x:0,y:0},texture:"generic.edge.right"})));P.filters=Xe(e,"right");const b=W({x:0,y:e.size.y}),M=W({x:e.size.x,y:0}),j=new K().poly([{x:a.x,y:a.y+16},{x:b.x,y:b.y+16},{x:b.x,y:-999},{x:M.x,y:-999},{x:M.x,y:M.y+16}],!0).fill(16776960);return h.addChild(j),h.addChild(p),h.addChild(P),h.mask=j,h},dt=(e,t)=>{const o=x(e),n=x(O(e,{x:t.x,z:t.z})),r=x(O(e,{y:t.y,z:t.z}));return{bottomCentre:o,topLeft:n,topRight:r}},Ae=(e,t,o,n,r=1e-5)=>n-r>e&&o<t-r,_n=(e,t,o,n)=>{const r=dt(e,t),s=dt(o,n),i=r.topLeft.x,a=r.topRight.x,c=s.topLeft.x,l=s.topRight.x,d=Ae(i,a,c,l),h=r.topRight.y-r.topRight.x/2,f=r.bottomCentre.y-r.bottomCentre.x/2;if(h>f)throw new Error(`aXAxisSlopeMinC ${h} > aXAxisSlopeMaxC ${f}`);const p=s.topRight.y-s.topRight.x/2,P=s.bottomCentre.y-s.bottomCentre.x/2;if(p>P)throw new Error("bXAxisSlopeMinC > bXAxisSlopeMaxC");const b=Ae(h,f,p,P),M=r.topLeft.y+r.topLeft.x/2,j=r.bottomCentre.y+r.bottomCentre.x/2;if(M>j)throw new Error("aYAxisSlopeMinC > aYAxisSlopeMaxC");const v=s.topLeft.y+s.topLeft.x/2,S=s.bottomCentre.y+s.bottomCentre.x/2;if(v>S)throw new Error("bYAxisSlopeMinC > bYAxisSlopeMaxC");const G=Ae(M,j,v,S);return d&&b&&G},Bn=(e,t)=>{if(e.renders===!1||t.renders===!1)return 0;const o=e.state.position,n=e.renderAabb||e.aabb,r=t.state.position,s=t.renderAabb||t.aabb;if(!_n(o,n,r,s))return 0;for(const i of Co){const a=e.state.position[i],c=a+n[i],l=t.state.position[i],d=l+s[i];if(c<=l)return 1*(i==="z"?-1:1);if(a>=d)return-1*(i==="z"?-1:1)}return ut(t)-ut(e)},ut=e=>e.state.position.x+e.state.position.y-e.state.position.z;class ye extends Error{constructor(t,o,n,r){super(t,r),this.cyclicDependency=o,this.hasClosedCycle=n}}const Xn=e=>En(Rn(e),e),En=(e,t)=>{let o=e.length,n=o;const r=new Array(o),s={},i=Vn(t),a=Nn(e);for(t.forEach(function(l){if(!a.has(l[0])||!a.has(l[1]))throw new Error("Unknown node. There is an unknown node in the supplied edges.")});n--;)s[n]||c(e[n],n,new Set);return r;function c(l,d,h){if(h.has(l))throw new ye("Cyclic dependency found - see .cyclicDependency of this error for details",[l],!1);if(!a.has(l))throw new Error("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(l));if(s[d])return;s[d]=!0;const f=i.get(l)||new Set,p=Array.from(f);if(d=p.length){h.add(l);do{const P=p[--d];try{c(P,a.get(P),h)}catch(b){throw b instanceof ye?b.hasClosedCycle?b:new ye(b.message,[...b.cyclicDependency,l],b.cyclicDependency.includes(l)):b}}while(d);h.delete(l)}r[--o]=l}};function Rn(e){const t=new Set;for(let o=0,n=e.length;o<n;o++){const r=e[o];t.add(r[0]),t.add(r[1])}return Array.from(t)}function Vn(e){const t=new Map;for(let o=0,n=e.length;o<n;o++){const r=e[o];t.has(r[0])||t.set(r[0],new Set),t.has(r[1])||t.set(r[1],new Set),t.get(r[0]).add(r[1])}return t}function Nn(e){const t=new Map;for(let o=0,n=e.length;o<n;o++)t.set(e[o],o);return t}const Ln=e=>{const t=[];for(const o of e)if(o.renders)for(const n of e){if(o===n)break;if(!n.renders)continue;const r=Bn(o,n);r!==0&&(r>0?t.push([n.id,o.id]):t.push([o.id,n.id]))}return t},Lt=(e,t,o=3)=>{try{return{order:Xn(e),impossible:!1}}catch(n){if(n instanceof ye){const r=n.cyclicDependency,s=e.find(([i,a])=>r.includes(i)&&r.includes(a));if(s===void 0)throw new Error("could not find bad link");return{order:Lt(e.filter(i=>i!==s),t,o-1).order,impossible:!0}}else throw n}},Un=(e,t,o,n)=>`${e}${n?".dark":""}.wall.${t}.${o}`,Wn=(e,t,o)=>{const r=m.textures[`${e.planet}.door.front.${t}`]!==void 0?e.planet:"generic",s=e.color.shade==="dimmed"&&m.textures[`${r}.dark.door.front.${t}`]!==void 0;return`${r}${s?".dark":""}.door.${o=="near"?"front":"back"}.${t}`};function Ut(e,t){const o=new w;for(const n of e)o.addChild(n);return o}const ht=e=>()=>({container:u(e),renderProps:{}}),E=e=>({item:t,room:o,currentlyRenderedProps:n})=>{if(n===void 0)return e({item:t,room:o})};function*jn({config:{direction:e,inHiddenWall:t,height:o}},n){const r=be(e),s=r==="y"?0:16;function*i(a){if(t){if(o!==0){const l=u({pivot:{x:r==="x"?18:8,y:12},texture:`generic.door.floatingThreshold.${r}`,...Pe(a,{y:-R.h*o})});l.filters=Xe(n,r==="x"?"towards":"right"),yield l}}else{yield u({pivot:{x:s,y:12},texture:"generic.door.legs.base",...Pe(a,{y:o})});for(let c=1;c<o;c++)yield u({pivot:{x:s,y:9},texture:"generic.door.legs.pillar",...Pe(a,{y:-c*R.h})})}}yield*i(W({...me,[r]:1})),yield*i(me),t||(yield u({pivot:{x:16,y:R.h*o+13},texture:`generic.door.legs.threshold.double.${r}`,...W({...me,[r]:1})}))}const Hn=E(({item:e,room:t})=>({container:Ut(jn(e,t)),renderProps:{}}));function*Yn({config:{direction:e,inHiddenWall:t,nearness:o},state:{position:n}},r){const s=be(e),{z:i}=n;if(!t&&i===0){const a=W({[ko(s)]:.5});o==="far"&&(yield u({anchor:{x:0,y:1},flipX:s==="x",texture:"generic.wall.overdraw",...a}))}yield u({texture:Wn(r,s,o),pivot:To[o][s]})}const Gn=E(({item:e,room:t})=>({container:Ut(Yn(e,t)),renderProps:{}})),ft=({item:{type:e,state:{action:t,facing:o,teleporting:n}},currentlyRenderedProps:r})=>r===void 0||r.action!==t||r.facingXy4!==o||r.teleportingPhase!==(n?.phase??null)?{container:(()=>{if(t==="death")return u({frames:m.animations[`${e}.fadeOut`]});if(n!==null){if(n.phase==="out")return u({frames:m.animations[`${e}.fadeOut`]});if(n.phase==="in")return u({frames:m.animations[`${e}.fadeOut`].toReversed()})}return t==="moving"?u({frames:m.animations[`${e}.walking.${o}`]}):t==="falling"&&e==="head"&&(o==="towards"||o==="right")?u(`head.falling.${o}`):e==="head"&&(o==="towards"||o==="right")?u({frames:m.animations[`head.idle.${o}`]}):u(`${e}.walking.${o}.2`)})(),renderProps:{action:t,facingXy4:o,teleportingPhase:n?.phase??null}}:void 0,Oe={frames:m.animations["bubbles.cold"],animationSpeed:.25},re=(e,t="headless-base")=>{const o=new w;o.addChild(u(t));const n=u(e);return n.y=-12,o.addChild(n),o},Ie=(e,t)=>t?new w({children:[u({texture:e,pivot:{x:U.w/2,y:U.h}}),u({texture:`${e}.outline`,pivot:{x:U.w/2+1,y:U.h+1}})]}):u(e),ze=E(({item:{config:{style:e}}})=>({container:u(e),renderProps:{}})),Jn={head:ft,heels:ft,doorFrame:Gn,doorLegs:Hn,stopAutowalk(){throw new Error("these should always be non-rendering")},portal(){throw new Error("these should always be non-rendering")},wall:E(({item:{config:{side:e,style:t}},room:o})=>{if(e==="right"||e==="towards")throw new Error("this wall should be non-rendering");return{container:u({texture:Un(o.planet,t,e,o.color.shade==="dimmed"),pivot:e==="away"?{x:pe.w,y:pe.h+1}:{x:0,y:pe.h+1}}),renderProps:{}}}),barrier({item:{config:{axis:e},state:{expires:t}},currentlyRenderedProps:o}){const n=t!==null;if(o===void 0||n!==o.bubbles)return{container:n?u({frames:m.animations["bubbles.taupe"],playOnce:"and-destroy",pivot:Ge[e]}):u({texture:`barrier.${e}`,pivot:Ge[e]}),renderProps:{bubbles:n}}},deadlyBlock:ze,slidingDeadly:ze,slidingBlock:ze,block({item:{config:{style:e},state:{expires:t,disappearing:o}},currentlyRenderedProps:n}){const r=t!==null;if(n===void 0||n.bubbles!==r||n.disappearing!==o)return{container:r?u({frames:m.animations["bubbles.taupe"],playOnce:"and-destroy"}):u(`block.${e}${o?".disappearing":""}`),renderProps:{bubbles:r,disappearing:o}}},switch({item:{state:{setting:e}},currentlyRenderedProps:t}){if(t===void 0||e!==t.setting)return{container:u(`switch.${e}`),renderProps:{setting:e}}},conveyor({item:{config:{direction:e,count:t},state:{stoodOnBy:o}},currentlyRenderedProps:n}){const r=o.size>0;if(!(n===void 0||n.moving!==r))return;const i=new w,a=So(e);return i.addChild(...q(Po(t,0,-1)).map(c=>{const l=Ao({[a]:(c-1)*R.w});return u(r?{frames:m.animations[`conveyor.${a}`],reverse:e==="towards"||e==="right",animationSpeed:.5,...l}:{texture:`conveyor.${a}.6`,...l})})),{container:i,renderProps:{moving:r}}},lift:E(()=>{const e=new w,t={x:U.w/2,y:U.h-Oo};return e.addChild(u({frames:m.animations.lift,pivot:t})),e.addChild(u({texture:"lift.static",pivot:t})),{container:e,renderProps:{}}}),teleporter({item:{state:{stoodOnBy:e}},currentlyRenderedProps:t}){const o=q(e).find(Ce)!==void 0;return t===void 0||o!==t.flashing?{container:o?new w({children:[u("teleporter"),u({frames:m.animations["teleporter.flashing"]})]}):u("teleporter"),renderProps:{flashing:o}}:void 0},pickup({item:{config:{gives:e},state:{expires:t}},currentlyRenderedProps:o}){const n=t!==null;if(!(o===void 0||o.bubbles!==n))return;const i={shield:"bunny",jumps:"bunny",fast:"bunny","extra-life":"bunny",bag:"bag",donuts:"donuts",hooter:"hooter",crown:"crown",reincarnation:{frames:m.animations.fish,animationSpeed:.25}}[e];return{container:u(n?{frames:i==="donuts"?m.animations["bubbles.taupe"]:m.animations["bubbles.white"],playOnce:"and-destroy"}:i),renderProps:{bubbles:n}}},moveableDeadly:E(({item:{config:{style:e}}})=>({container:u(e==="deadFish"?"fish.1":"puck.deadly"),renderProps:{}})),sceneryPlayer:E(({item:{config:{which:e}}})=>({container:u(`${e}.walking.towards.2`),renderProps:{}})),charles({item:{state:{facing:e}},currentlyRenderedProps:t}){const o=Je(e);if(t===void 0||o!==t.facingXy4)return{container:re(`charles.${o}`),renderProps:{facingXy4:o}}},baddie({item:{config:e,state:t},currentlyRenderedProps:o}){let n;const{activated:r}=t;switch(e.which){case"american-football-head":case"turtle":case"cyberman":n=e.startDirection;case"computer-bot":case"elephant":case"monkey":{const s=Mo(t.vels.walking,me)?n??"towards":Je(t.vels.walking);if(!(o===void 0||r!==o.activated||s!==o.facingXy4))return;const a={facingXy4:s,activated:r};switch(e.which){case"american-football-head":return{container:u({texture:`${e.which}.${e.style}.${s}`}),renderProps:a};case"turtle":return{container:r?u({frames:m.animations[`${e.which}.${s}`],animationSpeed:.25}):u(`${e.which}.${s}.1`),renderProps:a};case"cyberman":return{container:t.activated?re(`${e.which}.${s}`,Oe):u(`${e.which}.${s}`),renderProps:a};case"computer-bot":case"elephant":case"monkey":return{container:re(`${e.which}.${s}`),renderProps:a}}break}case"helicopter-bug":case"dalek":case"headless-base":case"elephant-head":case"bubble-robot":case"flying-ball":{if(!(o===void 0||r!==o.activated))return;const i={activated:r};switch(e.which){case"helicopter-bug":case"dalek":return{container:u({frames:m.animations[e.which],animationSpeed:.5}),renderProps:i};case"headless-base":return{container:u(e.which),renderProps:i};case"elephant-head":return{container:u("elephant.towards"),renderProps:i};case"bubble-robot":return{container:re(Oe),renderProps:i};case"flying-ball":return{container:re("ball",Oe),renderProps:i}}break}default:throw new Error(`unexpected baddie ${e}`)}},joystick:ht("joystick"),movableBlock:E(({item:{config:{style:e}}})=>({container:u(e),renderProps:{}})),portableBlock({item:{config:{style:e},state:{wouldPickUpNext:t}},currentlyRenderedProps:o}){const n=t;if(o===void 0||n!==o.highlighted)return{container:Ie(e,n),renderProps:{highlighted:n}}},spring({item:{state:{stoodOnBy:e,wouldPickUpNext:t}},currentlyRenderedProps:o}){const n=e.size>0,r=t;if(!(o===void 0||r!==o.highlighted||n!==o.compressed))return;const i=o?.compressed??!1;return{container:!n&&i?u({frames:m.animations["spring.bounce"],playOnce:"and-stop"}):Ie(n?"spring.compressed":"spring.released",r),renderProps:{compressed:n,highlighted:r}}},book:E(({item:{config:{slider:e}}})=>({container:u(`book.${e?"y":"x"}`),renderProps:{}})),hushPuppy({item:{state:{expires:e}},currentlyRenderedProps:t}){const o=e!==null;if(t===void 0||t.bubbles!==o)return{container:o?u({frames:m.animations["bubbles.taupe"],playOnce:"and-destroy"}):u("hushPuppy"),renderProps:{bubbles:o}}},ball:ht("ball"),floor(){throw new Error("floor should not be rendered as an item")},scroll:E(()=>({renderProps:{},container:u({texture:"scroll",pivot:{x:17,y:24}})}))},pt=(e,t)=>new K().poly([x({}),x({x:e.x}),x({x:e.x,y:e.y}),x({y:e.y})]).poly([x({}),x({z:e.z}),x({y:e.y,z:e.z}),x({y:e.y})]).poly([x({x:e.x}),x({x:e.x,z:e.z}),x(e),x({x:e.x,y:e.y})]).poly([x({z:e.z}),x({x:e.x,z:e.z}),x({x:e.x,y:e.y,z:e.z}),x({y:e.y,z:e.z})]).stroke({width:1,color:t,alpha:.5}),qn={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",stopAutowalk:"rgba(255,128,128)"},Zn=e=>{const t=qn[e.type]??"rgba(255,255,255)",o=new w;if(g("portal")(e)){const n=x(e.config.relativePoint);o.addChild(new K().circle(n.x,n.y,5).stroke(t)),o.addChild(new K().circle(n.x,n.y,2).fill(t))}return o.addChild(new K().circle(0,0,2).fill(t)),o.addChild(pt(e.aabb,t)),e.renderAabb&&o.addChild(pt(e.renderAabb,"rgba(184, 184, 255)")),o},Kn=(e,t,o)=>{t!==void 0&&(o.onItemClick&&t!==void 0&&(t.eventMode="static",t.on("pointertap",()=>{o.onItemClick(e,t)})),t.on("pointerenter",()=>{t.filters=new ae("white")}),t.on("pointerleave",()=>{t.filters=[]}))},mt=({state:{position:e}},t)=>{const o=Io(e);t.x=o.x,t.y=o.y},Qn=(e,t,o)=>{const n=new w;o.showBoundingBoxes!=="none"&&(n.alpha=.5);const r=new w({label:`item(${e.id})`});r.addChild(n),Kn(e,n,o),(o.showBoundingBoxes==="all"||o.showBoundingBoxes==="non-wall"&&e.type!=="wall")&&(r.addChild(Zn(e)),mt(e,r));let s,i;return{get item(){return e},destroy(){r.destroy({children:!0}),n.destroy({children:!0})},tick(){if(!e.renders)return;const a=Jn[e.type],c=a({item:e,room:t,currentlyRenderedProps:s});c!==void 0&&(s=c.renderProps,n.children.forEach(h=>h.destroy()),c.container!==null&&n.addChild(c.container));const{state:{position:l}}=e,d=i===void 0||!ce(i,l);return d&&(mt(e,r),i=l),d},container:r}},er=(e,t)=>{const{leftSide:o,rightSide:n,frontSide:r,top:s}=Nt(e),i=(n.x+o.x)/2,a=(s+r.y)/2;t.x=-i,t.y=-a},yt=(e,t)=>{const o=new w({label:`room(${e.id})`}),n=new w({label:`items(room(${e.id}))`});o.addChild($n(e)),o.addChild(n),o.filters=Wo(e),er(e,o);const r=new Map;return{get container(){return o},get room(){return e},tick(){let s=!1;for(const i of N(e.items)){let a=r.get(i.id);a===void 0&&(a=Qn(i,e,t),r.set(i.id,a),n.addChild(a.container)),s=a.tick()||s}for(const i of r.values())e.items[i.item.id]||(r.delete(i.item.id),i.destroy());if(s){const{order:i}=Lt(Ln(N(e.items)),e.items);for(let a=0;a<i.length;a++){const c=r.get(i[a]);if(c===void 0)throw new Error(`Item id=${i[a]} does not have a renderer - cannot assign a z-index`);c.container.zIndex=a}}},destroy(){o.destroy({children:!0}),r.forEach(s=>{s.destroy()})},get renderOptions(){return t}}},tr=4,or=(e,t)=>{const o=new w;o.label="world",o.y=De.height*.7,e.stage.addChild(o);const n=new w;n.y=-tr,e.stage.addChild(n);const r=new ae(Y().shadow);let s=yt(A(t),t.renderOptions);o.addChild(s.container);const i=qo(n),a=Lo(e),c=({deltaMS:l})=>{const d=a.rescale();o.x=e.renderer.width/a.curUpscale/2;const{inputState:{windowFocus:h}}=t,f=!h;if(i(t,d),(s.room!==A(t)||s.renderOptions!==t.renderOptions)&&(s.destroy(),s=yt(A(t),t.renderOptions),o.addChild(s.container)),!f)e.stage.filters=se,Dn(t,l),s.tick();else{e.stage.filters=r;const p=A(t).color;r.targetColor=It(p).main.original}};return{start(){return e.ticker.add(c),this},stop(){e.stage.removeChild(o),e.ticker.remove(c)}}},ar=async e=>{const t={showBoundingBoxes:"none"},o=new zo;await o.init({background:"#000000",resizeTo:window});const n=No(e,t),r=Eo({keyAssignment:n.keyAssignment,inputState:n.inputState,onInputStateChange(i){n.events.emit("inputStateChanged",i)}}),s=or(o,n).start();return{campaign:e,events:n.events,renderIn(i){i.appendChild(o.canvas)},changeRoom(i){Ee({gameState:n,toRoomId:i,changeType:"level-select"})},get currentRoom(){return A(n)},get gameState(){return n},set renderOptions(i){n.renderOptions=i},stop(){console.warn("tearing down game"),o.canvas.parentNode?.removeChild(o.canvas),s.stop(),r(),o.destroy()}}};export{ar as gameMain};
