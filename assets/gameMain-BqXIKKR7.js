const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-B0luu-o4.js","assets/index-D68VIpYK.js","assets/index-DlE9jU_j.css","assets/colorToUniform-CUFmbtq3.js","assets/SharedSystems-4_5UpATs.js","assets/Graphics-BZZCqb9N.js","assets/WebGLRenderer-DY7Q2lgh.js"])))=>i.map(i=>d[i]);
import{u as ir,y as yn,z as Be,e as bt,E as pe,c as ar,C as g,d as ot,v as st,Y as I,D as it,a4 as Mt,l as lr,K as Me,a as be,b as we,U as cr,a5 as dr,a6 as ur,a7 as hr,a8 as w,a9 as vn,aa as fr,ab as xn,ac as bn,ad as pr,ae as at,af as Re,ag as mr,ah as y,ai as gr,aj as Z,ak as Rt,al as me,am as j,an as Ve,ao as wn,ap as lt,aq as yr,ar as ne,as as O,at as ct,au as L,av as vr,aw as Cn,ax as Ce,ay as X,az as xr,aA as se,aB as T,aC as z,aD as br,aE as ve,aF as Ne,aG as wr,aH as te,aI as Cr,aJ as Dt,aK as Et,aL as Tr,aM as kr,aN as ae,aO as qe,aP as dt,aQ as $t,aR as Je,aS as wt,aT as Ct,aU as K,aV as Or,aW as Tt,aX as ge,aY as Tn,aZ as xe,a_ as He,a$ as V,b0 as Y,b1 as Ue,b2 as kn,b3 as Bt,b4 as Pr,b5 as On,b6 as A,b7 as Ir,b8 as ut,b9 as _r,ba as Fr,bb as Pn,bc as Ar,bd as ye,be as De,bf as kt,bg as ie,bh as Sr,bi as zr,bj as Nt,bk as ht,bl as ft,bm as pt,bn as Mr,bo as Ee,bp as Ze,bq as Rr,br as In,bs as Dr,bt as Er,bu as $r,bv as b,bw as q,bx as fe,by as Ye,bz as Br,bA as _n,bB as le,bC as Nr,bD as Hr,bE as Ht,bF as Ke,bG as Ur,bH as Xr,bI as Lr,bJ as Wr,bK as Gr,bL as jr,bM as Vr,bN as qr}from"./index-D68VIpYK.js";import{S as Jr,G as oe}from"./Graphics-BZZCqb9N.js";const Fn=class mt extends ir{constructor(t){t={...mt.defaultOptions,...t},super(t),this.enabled=!0,this._state=Jr.for2d(),this.blendMode=t.blendMode,this.padding=t.padding,typeof t.antialias=="boolean"?this.antialias=t.antialias?"on":"off":this.antialias=t.antialias,this.resolution=t.resolution,this.blendRequired=t.blendRequired,this.addResource("uTexture",0,1)}apply(t,n,r,o){t.applyFilter(this,n,r,o)}get blendMode(){return this._state.blendMode}set blendMode(t){this._state.blendMode=t}static from(t){const{gpu:n,gl:r,...o}=t;let s,i;return n&&(s=yn.from(n)),r&&(i=Be.from(r)),new mt({gpuProgram:s,glProgram:i,...o})}};Fn.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1};let Ot=Fn;const gt=[];bt.handleByNamedList(pe.Environment,gt);async function Zr(e){if(!e)for(let t=0;t<gt.length;t++){const n=gt[t];if(n.value.test()){await n.value.load();return}}}let ce;function Yr(){if(typeof ce=="boolean")return ce;try{ce=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{ce=!1}return ce}var An=(e=>(e[e.NONE=0]="NONE",e[e.COLOR=16384]="COLOR",e[e.STENCIL=1024]="STENCIL",e[e.DEPTH=256]="DEPTH",e[e.COLOR_DEPTH=16640]="COLOR_DEPTH",e[e.COLOR_STENCIL=17408]="COLOR_STENCIL",e[e.DEPTH_STENCIL=1280]="DEPTH_STENCIL",e[e.ALL=17664]="ALL",e))(An||{});class Kr{constructor(t){this.items=[],this._name=t}emit(t,n,r,o,s,i,a,l){const{name:c,items:d}=this;for(let u=0,f=d.length;u<f;u++)d[u][c](t,n,r,o,s,i,a,l);return this}add(t){return t[this._name]&&(this.remove(t),this.items.push(t)),this}remove(t){const n=this.items.indexOf(t);return n!==-1&&this.items.splice(n,1),this}contains(t){return this.items.indexOf(t)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const Qr=["init","destroy","contextChange","resolutionChange","reset","renderEnd","renderStart","render","update","postrender","prerender"],Sn=class zn extends ar{constructor(t){super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=t.type,this.name=t.name,this.config=t;const n=[...Qr,...this.config.runners??[]];this._addRunners(...n),this._unsafeEvalCheck()}async init(t={}){const n=t.skipExtensionImports===!0?!0:t.manageImports===!1;await Zr(n),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const r in this._systemsHash)t={...this._systemsHash[r].constructor.defaultOptions,...t};t={...zn.defaultOptions,...t},this._roundPixels=t.roundPixels?1:0;for(let r=0;r<this.runners.init.items.length;r++)await this.runners.init.items[r].init(t);this._initOptions=t}render(t,n){let r=t;if(r instanceof g&&(r={container:r},n&&(ot(st,"passing a second argument is deprecated, please use render options instead"),r.target=n.renderTexture)),r.target||(r.target=this.view.renderTarget),r.target===this.view.renderTarget&&(this._lastObjectRendered=r.container,r.clearColor=this.background.colorRgba),r.clearColor){const o=Array.isArray(r.clearColor)&&r.clearColor.length===4;r.clearColor=o?r.clearColor:I.shared.setValue(r.clearColor).toArray()}r.transform||(r.container.updateLocalTransform(),r.transform=r.container.localTransform),this.runners.prerender.emit(r),this.runners.renderStart.emit(r),this.runners.render.emit(r),this.runners.renderEnd.emit(r),this.runners.postrender.emit(r)}resize(t,n,r){const o=this.view.resolution;this.view.resize(t,n,r),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),r!==void 0&&r!==o&&this.runners.resolutionChange.emit(r)}clear(t={}){const n=this;t.target||(t.target=n.renderTarget.renderTarget),t.clearColor||(t.clearColor=this.background.colorRgba),t.clear??(t.clear=An.ALL);const{clear:r,clearColor:o,target:s}=t;I.shared.setValue(o??this.background.colorRgba),n.renderTarget.clear(s,r,I.shared.toArray())}get resolution(){return this.view.resolution}set resolution(t){this.view.resolution=t,this.runners.resolutionChange.emit(t)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...t){t.forEach(n=>{this.runners[n]=new Kr(n)})}_addSystems(t){let n;for(n in t){const r=t[n];this._addSystem(r.value,r.name)}}_addSystem(t,n){const r=new t(this);if(this[n])throw new Error(`Whoops! The name "${n}" is already in use`);this[n]=r,this._systemsHash[n]=r;for(const o in this.runners)this.runners[o].add(r);return this}_addPipes(t,n){const r=n.reduce((o,s)=>(o[s.name]=s.value,o),{});t.forEach(o=>{const s=o.value,i=o.name,a=r[i];this.renderPipes[i]=new s(this,a?new a:null)})}destroy(t=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(t),Object.values(this.runners).forEach(n=>{n.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(t){return this.textureGenerator.generateTexture(t)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!Yr())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}};Sn.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let Mn=Sn,Te;function eo(e){return Te!==void 0||(Te=(()=>{const t={stencil:!0,failIfMajorPerformanceCaveat:e??Mn.defaultOptions.failIfMajorPerformanceCaveat};try{if(!it.get().getWebGLRenderingContext())return!1;let r=it.get().createCanvas().getContext("webgl",t);const o=!!r?.getContextAttributes()?.stencil;if(r){const s=r.getExtension("WEBGL_lose_context");s&&s.loseContext()}return r=null,o}catch{return!1}})()),Te}let ke;async function to(e={}){return ke!==void 0||(ke=await(async()=>{const t=it.get().getNavigator().gpu;if(!t)return!1;try{return await(await t.requestAdapter(e)).requestDevice(),!0}catch{return!1}})()),ke}const Ut=["webgl","webgpu","canvas"];async function no(e){let t=[];e.preference?(t.push(e.preference),Ut.forEach(s=>{s!==e.preference&&t.push(s)})):t=Ut.slice();let n,r={};for(let s=0;s<t.length;s++){const i=t[s];if(i==="webgpu"&&await to()){const{WebGPURenderer:a}=await Mt(async()=>{const{WebGPURenderer:l}=await import("./WebGPURenderer-B0luu-o4.js");return{WebGPURenderer:l}},__vite__mapDeps([0,1,2,3,4,5]));n=a,r={...e,...e.webgpu};break}else if(i==="webgl"&&eo(e.failIfMajorPerformanceCaveat??Mn.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:a}=await Mt(async()=>{const{WebGLRenderer:l}=await import("./WebGLRenderer-DY7Q2lgh.js");return{WebGLRenderer:l}},__vite__mapDeps([6,1,2,3,4,5]));n=a,r={...e,...e.webgl};break}else if(i==="canvas")throw r={...e},new Error("CanvasRenderer is not yet implemented")}if(delete r.webgpu,delete r.webgl,!n)throw new Error("No available renderer for the current environment");const o=new n;return await o.init(r),o}const Rn="8.4.1";class Dn{static init(){globalThis.__PIXI_APP_INIT__?.(this,Rn)}static destroy(){}}Dn.extension=pe.Application;class ro{constructor(t){this._renderer=t}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,Rn)}destroy(){this._renderer=null}}ro.extension={type:[pe.WebGLSystem,pe.WebGPUSystem],name:"initHook",priority:-10};const En=class yt{constructor(...t){this.stage=new g,t[0]!==void 0&&ot(st,"Application constructor options are deprecated, please use Application.init() instead.")}async init(t){t={...t},this.renderer=await no(t),yt._plugins.forEach(n=>{n.init.call(this,t)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return ot(st,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(t=!1,n=!1){const r=yt._plugins.slice(0);r.reverse(),r.forEach(o=>{o.destroy.call(this)}),this.stage.destroy(n),this.stage=null,this.renderer.destroy(t),this.renderer=null}};En._plugins=[];let $n=En;bt.handleByList(pe.Application,$n._plugins);bt.add(Dn);var oo=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,so=`
in vec2 vTextureCoord;

out vec4 finalColor;

uniform float uAlpha;
uniform sampler2D uTexture;

void main()
{
    finalColor =  texture(uTexture, vTextureCoord) * uAlpha;
}
`,Xt=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct AlphaUniforms {
  uAlpha:f32,
};

@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;

@group(1) @binding(0) var<uniform> alphaUniforms : AlphaUniforms;

struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>
  };

fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

fn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  
}

fn getSize() -> vec2<f32>
{
  return gfu.uGlobalFrame.zw;
}
  
@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition)
  );
}

@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
  @builtin(position) position: vec4<f32>
) -> @location(0) vec4<f32> {
 
    var sample = textureSample(uTexture, uSampler, uv);
    
    return sample * alphaUniforms.uAlpha;
}`;const Bn=class Nn extends Ot{constructor(t){t={...Nn.defaultOptions,...t};const n=yn.from({vertex:{source:Xt,entryPoint:"mainVertex"},fragment:{source:Xt,entryPoint:"mainFragment"}}),r=Be.from({vertex:oo,fragment:so,name:"alpha-filter"}),{alpha:o,...s}=t,i=new lr({uAlpha:{value:o,type:"f32"}});super({...s,gpuProgram:n,glProgram:r,resources:{alphaUniforms:i}})}get alpha(){return this.resources.alphaUniforms.uniforms.uAlpha}set alpha(t){this.resources.alphaUniforms.uniforms.uAlpha=t}};Bn.defaultOptions={alpha:1};let io=Bn;class $e extends Me{constructor(...t){let n=t[0];Array.isArray(t[0])&&(n={textures:t[0],autoUpdate:t[1]});const{textures:r,autoUpdate:o,...s}=n,[i]=r;super({...s,texture:i instanceof be?i:i.texture}),this._textures=null,this._durations=null,this._autoUpdate=o??!0,this._isConnectedToTicker=!1,this.animationSpeed=1,this.loop=!0,this.updateAnchor=!1,this.onComplete=null,this.onFrameChange=null,this.onLoop=null,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=r}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(we.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(we.shared.add(this.update,this,cr.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(t){this.stop(),this.currentFrame=t}gotoAndPlay(t){this.currentFrame=t,this.play()}update(t){if(!this._playing)return;const n=t.deltaTime,r=this.animationSpeed*n,o=this.currentFrame;if(this._durations!==null){let s=this._currentTime%1*this._durations[this.currentFrame];for(s+=r/60*1e3;s<0;)this._currentTime--,s+=this._durations[this.currentFrame];const i=Math.sign(this.animationSpeed*n);for(this._currentTime=Math.floor(this._currentTime);s>=this._durations[this.currentFrame];)s-=this._durations[this.currentFrame]*i,this._currentTime+=i;this._currentTime+=s/this._durations[this.currentFrame]}else this._currentTime+=r;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):o!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<o||this.animationSpeed<0&&this.currentFrame>o)&&this.onLoop(),this._updateTexture())}_updateTexture(){const t=this.currentFrame;this._previousFrame!==t&&(this._previousFrame=t,this.texture=this._textures[t],this.updateAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(){this.stop(),super.destroy(),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(t){const n=[];for(let r=0;r<t.length;++r)n.push(be.from(t[r]));return new $e(n)}static fromImages(t){const n=[];for(let r=0;r<t.length;++r)n.push(be.from(t[r]));return new $e(n)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(t){if(t[0]instanceof be)this._textures=t,this._durations=null;else{this._textures=[],this._durations=[];for(let n=0;n<t.length;n++)this._textures.push(t[n].texture),this._durations.push(t[n].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let t=Math.floor(this._currentTime)%this._textures.length;return t<0&&(t+=this._textures.length),t}set currentFrame(t){if(t<0||t>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${t}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const n=this.currentFrame;this._currentTime=t,n!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(t){t!==this._autoUpdate&&(this._autoUpdate=t,!this._autoUpdate&&this._isConnectedToTicker?(we.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(we.shared.add(this.update,this),this._isConnectedToTicker=!0))}}var Pt={},Hn=dr,ao=Hn.mark(It),Un=ur,lo=Un.wrapWithIterableIterator,co=Un.ensureIterable;function It(){var e,t,n,r,o,s,i=arguments;return Hn.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:for(e=i.length,t=new Array(e),n=0;n<e;n++)t[n]=i[n];r=0,o=t;case 2:if(!(r<o.length)){l.next=8;break}return s=o[r],l.delegateYield(co(s),"t0",5);case 5:r++,l.next=2;break;case 8:case"end":return l.stop()}},ao)}Pt.__concat=It;var uo=lo(It);Pt.concat=uo;var ho=Pt.concat;const Se=hr(ho),Lt={x:.5,y:1},Wt=e=>typeof e!="string"&&Object.hasOwn(e,"frames"),h=e=>{if(typeof e=="string")return h({texture:e});{const{anchor:t,flipX:n,pivot:r,x:o,y:s,filter:i}=e;let a;if(Wt(e)?a=fo(e):a=new Me(w.textures[e.texture]),t===void 0&&r===void 0)if(Wt(e))a.anchor=Lt;else{const l=w.data.frames[e.texture].frame;l.pivot!==void 0?a.pivot=l.pivot:a.anchor=Lt}else t!==void 0&&(a.anchor=t),r!==void 0&&(a.pivot=r);return o!==void 0&&(a.x=o),s!==void 0&&(a.y=s),i!==void 0&&(a.filters=i),a.eventMode="static",n===!0&&(a.scale.x=-1),a}};function fo({frames:e,animationSpeed:t,reverse:n,playOnce:r}){const o=e.map(i=>({texture:i,time:vn}));n&&o.reverse();const s=new $e(o);return s.animationSpeed=t||fr,s.play(),r!==void 0&&(s.loop=!1,s.onComplete=()=>{s.stop(),r==="and-destroy"&&(s.visible=!1)}),s}const po=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Å","Ä","Ö","0","1","2","3","4","5","6","7","8","9","!","@","#","$","%","^","&","*","(",")","-","_","=","+","[","]","{","}",";",":","'",'"',",",".","/","<",">","?","\\","|"," ","Enter","Shift","Control","`","~","Tab","Backspace","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Numpad0","Numpad1","Numpad2","Numpad3","Numpad4","Numpad5","Numpad6","Numpad7","Numpad8","Numpad9","NumpadAdd","NumpadSubtract","NumpadMultiply","NumpadDivide","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"],Gt=e=>po.includes(e),Xn=[...bn,"jump","fire","carry","swop","hold"],Ln=()=>({...xn(Xn.map(e=>[e,!1])),windowFocus:!0}),mo=Object.freeze(Ln()),G={right:["P"],towards:["A"],left:["O"],away:["Q"],jump:[" ","M"],carry:["C","M"],fire:["N"],swop:["Enter","S"],hold:["H"]},go={right:["ArrowRight",...G.right],towards:["ArrowDown",...G.towards],left:["ArrowLeft",...G.left],away:["ArrowUp",...G.away],jump:["`",...G.jump],carry:["Shift","`",...G.carry],fire:["D",...G.fire],swop:G.swop,hold:["F8",...G.hold]};function*jt(e,t){for(const[n,r]of pr(e))r.includes(t)&&(yield n)}const Vt=e=>e.length===1?e.toUpperCase():e,yo=({keyAssignment:e,inputState:t,onInputStateChange:n})=>{const r=({key:a,repeat:l})=>{if(l)return;const c=Vt(a);if(!Gt(c)){console.log("do not recognise key: ",c);return}for(const d of jt(e,c))t[d]=!0;n?.(t)},o=({key:a})=>{const l=Vt(a);if(Gt(l)){for(const c of jt(e,l))t[c]=!1;n?.(t)}},s=()=>{t.windowFocus=!0,n?.(t)},i=()=>{t.windowFocus=!1;for(const a of Xn)t[a]=!1;n?.(t)};return window.focus(),window.addEventListener("keydown",r,!1),window.addEventListener("keyup",o,!1),window.addEventListener("focus",s,!1),window.addEventListener("blur",i,!1),()=>{window.removeEventListener("keydown",r,!1),window.removeEventListener("keyup",o,!1),window.removeEventListener("focus",s,!1),window.removeEventListener("blur",i,!1)}};function vo(e){return{all:e=e||new Map,on:function(t,n){var r=e.get(t);r?r.push(n):e.set(t,[n])},off:function(t,n){var r=e.get(t);r&&(n?r.splice(r.indexOf(n)>>>0,1):e.set(t,[]))},emit:function(t,n){var r=e.get(t);r&&r.slice().map(function(o){o(n)}),(r=e.get("*"))&&r.slice().map(function(o){o(t,n)})}}}const xo=e=>{const t={};for(const n of Object.values(e.rooms))for(const r of Object.values(n.items))if(r.type==="player"){const{which:o}=r.config;t[o]=n.id}if(t.head===void 0&&t.heels===void 0)throw new Error("couldn't find either head or heels in campaign");return t},bo=({campaign:e,renderOptions:t})=>{const n=xo(e),r=xn(Object.keys(e.rooms).map(i=>[i,{}])),o=n.head&&at(e.rooms[n.head],r[n.head],!0),s=n.heels===n.head?o:n.heels&&at(e.rooms[n.heels],r[n.heels],!0);return{keyAssignment:go,currentCharacterName:n.head===void 0?"heels":"head",characterRooms:{head:o,heels:s},entryState:{head:o===void 0?void 0:Re(o.items.head),heels:s===void 0?void 0:Re(s.items.heels)},inputState:Ln(),renderOptions:t,campaign:e,events:vo(),pickupsCollected:r,gameTime:0,progression:0,gameSpeed:1}},qt=mr,wo=e=>{let t=1;return{get curUpscale(){return t},rescale(){if(e.renderer.width===0||e.renderer.height===0)throw new Error;const n=Math.floor(Math.min(e.renderer.width/qt.width,e.renderer.height/qt.height)),r={x:Math.round(e.renderer.width/n),y:Math.round(e.renderer.height/n)};return t===n||(t=n,console.log("scale factor changed to:",n),e.stage.scale=n),r}}},D={original:new I("rgb(255, 255, 255)"),basic:new I("rgb(210, 210, 210)"),dimmed:new I("rgb(120, 120, 120)")},E={original:new I("rgb(255, 255, 0)"),basic:new I("hsl(50,58%,70%)"),dimmed:y.redShadow},H={original:new I("rgb(255, 0, 255)"),basic:y.pink,dimmed:new I("hsl(290,25%,40%)")},k={original:new I("rgb(0, 255, 255)"),basic:new I("hsl(183, 28%, 50%)"),dimmed:new I("hsl(183, 28%,39%)")},U={original:new I("rgb(0, 255, 0)"),basic:y.moss,dimmed:new I("hsl(73,35%,35%)")},_t={white:{basic:{main:D,edges:{towards:k,right:E},hud:{lives:E,dimmed:H,icons:k}},dimmed:{main:D,edges:{towards:U,right:k},hud:{lives:E,dimmed:H,icons:k}}},yellow:{basic:{main:E,edges:{towards:U,right:D},hud:{lives:k,dimmed:H,icons:U}},dimmed:{main:E,edges:{towards:k,right:k},hud:{lives:k,dimmed:H,icons:U}}},magenta:{basic:{main:H,edges:{towards:U,right:k},hud:{lives:D,dimmed:k,icons:E}},dimmed:{main:H,edges:{towards:U,right:k},hud:{lives:D,dimmed:k,icons:E}}},cyan:{basic:{main:k,edges:{towards:H,right:D},hud:{lives:D,dimmed:U,icons:E}},dimmed:{main:k,edges:{towards:H,right:D},hud:{lives:D,dimmed:U,icons:E}}},green:{basic:{main:U,edges:{towards:k,right:E},hud:{lives:D,dimmed:H,icons:k}},dimmed:{main:U,edges:{towards:k,right:E},hud:{lives:D,dimmed:H,icons:k}}}},Wn=e=>_t[e.hue][e.shade],Gn=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,Co=`in vec2 vTextureCoord;
out vec4 finalColor;

const int SWOP_COUNT = \${SWOP_COUNT};

uniform sampler2D uTexture;
uniform vec3 uOriginal[SWOP_COUNT];
uniform vec3 uReplacement[SWOP_COUNT];

// colours are floats so check if they're very close rather than exactly equal:
bool colorsEffectivelyEqual(vec3 color1, vec3 color2) {       
    return distance(color1, color2) < 0.05;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a == 0.0 ) {
        finalColor = c;
        return;
    }
    
    for(int i = 0; i < SWOP_COUNT; i++) {
        if ( colorsEffectivelyEqual(c.rgb, uOriginal[i]) ) {
            finalColor = vec4(uReplacement[i], c.a);            
            return;
        }
    }    
    finalColor = vec4(c.rgb, c.a);
}
`;class Xe extends Ot{constructor(t){const n=Object.keys(t).length,r=Be.from({vertex:Gn,fragment:Co.replace(/\$\{SWOP_COUNT\}/g,n.toFixed(0)),name:"palette-swop-filter"});super({glProgram:r,resources:{colorReplaceUniforms:{uOriginal:{value:new Float32Array(3*n),type:"vec3<f32>",size:n},uReplacement:{value:new Float32Array(3*n),type:"vec3<f32>",size:n}}}});const o=this.resources.colorReplaceUniforms.uniforms;Object.entries(t).forEach(([s,i],a)=>{y[s].toArray().forEach((l,c)=>{o.uOriginal[a*3+c]=l}),i.toArray().forEach((l,c)=>{o.uReplacement[a*3+c]=l})})}}const jn=({basic:e,dimmed:t})=>({replaceLight:e,replaceDark:t}),Vn=e=>jn(_t[e.color.hue][e.color.shade].main),To=e=>new Xe({lightBeige:y.lightGrey,redShadow:y.shadow,pink:y.lightGrey,moss:y.lightGrey,midRed:y.midGrey,highlightBeige:y.lightGrey,white:y.lightGrey,...Vn(e)}),ko=new Xe({midGrey:y.midRed,lightGrey:y.lightBeige,white:y.highlightBeige,metallicBlue:y.redShadow,pink:y.midRed,moss:y.midRed,replaceDark:y.midRed,replaceLight:y.lightBeige}),vt=(e,t)=>new Xe(jn(_t[e.color.hue][e.color.shade].edges[t])),J=e=>new Xe(Vn(e)),ue=gr,Oo=`precision mediump float;
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uSourceBlacks[2];
uniform vec3 uTargetColor;

// colours are floats so check if they're very close rather than exactly equal:
bool colorsEffectivelyEqual(vec3 color1, vec3 color2) {    
    
    return distance(color1, color2) < 0.05;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a == 0.0 ) {
        finalColor = c;
        return;
    }

    if ( colorsEffectivelyEqual(c.rgb, uSourceBlacks[0]) || colorsEffectivelyEqual(c.rgb, uSourceBlacks[1])) {
        finalColor = vec4(0,0,0, 1.0);
    } else {
        finalColor = vec4(uTargetColor, 1);    
    }
}
`,Jt=[y.pureBlack,y.lightBlack];class he extends Ot{uniforms;constructor(t="white"){const n=Be.from({vertex:Gn,fragment:Oo,name:"revert-colourise-filter"});super({glProgram:n,resources:{colorReplaceUniforms:{uSourceBlacks:{value:new Float32Array(6),type:"vec3<f32>",size:6},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms;const[r,o,s]=Jt[0].toArray();this.uniforms.uSourceBlacks[0]=r,this.uniforms.uSourceBlacks[1]=o,this.uniforms.uSourceBlacks[2]=s;const[i,a,l]=Jt[1].toArray();this.uniforms.uSourceBlacks[3]=i,this.uniforms.uSourceBlacks[4]=a,this.uniforms.uSourceBlacks[5]=l,this.targetColor=t}set targetColor(t){const[n,r,o]=new I(t).toArray();this.uniforms.uTargetColor[0]=n,this.uniforms.uTargetColor[1]=r,this.uniforms.uTargetColor[2]=o}}function Ft(e,t){const n=t||new g;for(const r of e)n.addChild(r);return n}const qn=e=>{const t=Z(e,"head"),n=Z(e,"heels");return t!==void 0&&n!==void 0&&t.state.action==="idle"&&n.state.action==="idle"&&t.state.standingOn===n},Po=24,Io=56,_o=80,Zt=112,de=e=>e==="heels"?1:-1;function*Fo(e){const t=e.toString().split(""),n=t.length;for(let r=0;r<n;r++){const o=`hud.char.${t[r]}`;yr(o),yield h({texture:o,x:(r+.5-n/2)*wn.w})}}function Oe(e,t){for(const n of e.children)n.destroy();Ft(Fo(t),e)}const Ao=e=>{const t=new he,n=new he,r=new he,o=new he,s=(c=!1)=>{const d=c?2:1,u=new g;return u.scale={x:1,y:d},u},i=c=>{const d=new Me(w.textures[`${c}.walking.${c==="head"?"right":"towards"}.2`]);return d.anchor={x:.5,y:0},d},a=(c,d=!1,u=!1)=>{const f=new g;f.pivot={x:4,y:16};const m=new Me({texture:w.textures[c],anchor:d?{x:.5,y:0}:{x:.5,y:1},filters:t,y:d?0:8});f.addChild(m);const p=s();return p.y=d?0:16,p.filters=n,p.x=m.x=wn.w/2,f.addChild(p),u&&(p.visible=!1),{text:p,icon:m,container:f}},l={head:{sprite:i("head"),livesText:s(!0),shield:a("hud.shield"),extraSkill:a("hud.fastSteps"),donuts:a("donuts",!0),hooter:a("hooter",!0,!0)},heels:{sprite:i("heels"),livesText:s(!0),shield:a("hud.shield"),extraSkill:a("hud.bigJumps"),bag:a("bag",!0,!0),carrying:{container:new g}}};for(const c of Rt)e.addChild(l[c].livesText),e.addChild(l[c].sprite),e.addChild(l[c].shield.container),e.addChild(l[c].extraSkill.container);return e.addChild(l.head.donuts.container),e.addChild(l.head.hooter.container),e.addChild(l.heels.bag.container),e.addChild(l.heels.carrying.container),(c,d)=>{const u=me(c),{hud:{dimmed:f,lives:m,icons:p}}=Wn(u.color),C=x=>{const M=Z(c,x),N=M?.state.shieldCollectedAt??null,{text:S,container:je}=l[x].shield,{text:or,container:zt}=l[x].extraSkill;zt.x=je.x=(d.x>>1)+de(x)*_o;const sr=N===null||c.gameTime>N+lt?0:100-Math.ceil((c.gameTime-N)/(lt/100));Oe(S,sr),je.y=d.y,Oe(or,M===void 0?0:M.type==="head"?M.state.fastSteps:M.state.bigJumps),zt.y=d.y-24},B=x=>{const{currentCharacterName:M}=c,N=M===x||M==="headOverHeels",S=l[x].sprite;N?S.filters=ue:qn(c)?(o.targetColor=f.basic,S.filters=o):S.filters=r,S.x=(d.x>>1)+de(x)*Io,S.y=d.y-j.h},P=x=>{const N=Ve(c,x)?.lives??0,S=l[x].livesText;S.x=(d.x>>1)+de(x)*Po,S.y=d.y,S.tint=m.basic,Oe(S,N??0)},_=x=>{const{container:M}=l.heels.carrying,N=M.children.length>0;if(x===null&&N)for(const S of M.children)S.destroy();x!==null&&!N&&M.addChild(h(x.type==="spring"?"spring.released":x.config.style))};r.targetColor=f.dimmed,n.targetColor=f.basic,t.targetColor=p.basic;for(const x of Rt)P(x),B(x),C(x);l.head.hooter.container.x=l.head.donuts.container.x=(d.x>>1)+de("head")*Zt,l.head.donuts.container.y=d.y-j.h-8,l.heels.carrying.container.y=d.y-j.h,l.heels.carrying.container.x=l.heels.bag.container.x=(d.x>>1)+de("heels")*Zt,l.heels.bag.container.y=l.head.hooter.container.y=d.y-8;const W=Ve(c,"head"),v=W?.hasHooter??!1;l.head.hooter.icon.filters=v?ue:r;const R=W?.donuts??0;l.head.donuts.icon.filters=R!==0?ue:r,Oe(l.head.donuts.text,R);const We=Ve(c,"heels"),Ge=We?.hasBag??!1;_(We?.carrying??null),l.heels.bag.icon.filters=Ge?ue:r}},Yt={movementType:"vel",vels:{gravity:L}},So=(e,t,n)=>{if(!ne(e))return Yt;const{type:r,state:{vels:{gravity:{z:o}},standingOn:s}}=e,a=vr[(r==="headOverHeels"?"head":r)==="head"?"head":"others"];return s!==null?O("lift")(s)&&s.state.vels.lift.z<0?{movementType:"vel",vels:{gravity:{z:Math.max(o-ct*n,-a)}}}:Yt:{movementType:"vel",vels:{gravity:{z:Math.max(o-ct*n,-a)}}}},Pe=e=>{const n=e/xr*vn;return(e+.5*ct*n**2)/n},zo={head:Pe(Ce.head),headOnSpring:Pe(Ce.head+X.h),heels:Pe(Ce.heels),heelsOnSpring:Pe(Ce.heels+X.h)},Mo=(e,t)=>zo[`${e==="headOverHeels"?"head":e}${t?"OnSpring":""}`],Jn=({type:e,state:{standingOn:t}},n)=>{const{inputState:{jump:r}}=n,o=t!==null&&O("teleporter")(t);if(!(r&&t!==null&&!o))return t!==null?{movementType:"steady",stateDelta:{jumped:!1}}:Cn;const i=O("spring")(t);return{movementType:"vel",vels:{gravity:{z:Mo(e,i)}},stateDelta:{action:"moving",jumped:!0}}},Ro=({vel:e,acc:t,unitD:n,maxSpeed:r,deltaMS:o,crossComponentFade:s=0,minVelocity:i=0})=>{const a=se(e,n),l=Math.max(a+t*o,i),c=l>=r,d=br(n),u=se(e,d),f=u>=0?Math.max(u-s*o,0):Math.min(u+s*o,0);return T(z(n,c?r:l),z(d,f))},Kt={movementType:"vel",vels:{walking:L}},Zn=(e,{inputState:t,currentCharacterName:n},r)=>{const{type:o,state:{action:s,autoWalk:i,standingOn:a,facing:l,teleporting:c,vels:{walking:d,gravity:u}}}=e,m=n===e.id?t:mo,p=o==="headOverHeels"?"heels":o,C=i?l:bn.find(R=>m[R]===!0),B=ve[p];if(c!==null||s==="death")return Kt;if(o==="heels"){if(a===null)return e.state.jumped?{movementType:"vel",vels:{walking:Ne(d,z(d,wr*r))}}:Kt;if(m.jump){const R=C??l,Ge=O("spring")(a)?1:Tr;return{movementType:"vel",vels:{walking:z(te[R],B*Ge)},stateDelta:{facing:R}}}}const P=a===null&&u.z<0;if(C!==void 0)return P?{movementType:"vel",vels:{walking:z(te[C],B)},stateDelta:{facing:C,action:"falling"}}:{movementType:"vel",vels:{walking:Ro({vel:d,acc:Cr[p],deltaMS:r,maxSpeed:B,unitD:te[C],crossComponentFade:Dt[p],minVelocity:Et[p]})},stateDelta:{facing:C,action:"moving"}};const _=kr(d),W=_===0?L:z(d,1/_),v=Math.max(_-Dt[p]*r,0);return{movementType:"vel",vels:{walking:z(W,v<Et[p]?0:v)},stateDelta:{action:P?"falling":"idle"}}},Qt=X.h,Ie=.001,Do=({totalDistance:e,currentAltitude:t,direction:n})=>{const r=qe**2/(2*ae);if(n==="up"){if(t<=r)return Math.max(Ie,Math.sqrt(2*ae*Math.max(t,0)));if(t>=e-r){const o=Math.max(0,e-t);return Math.max(Ie,Math.sqrt(2*ae*o))}else return qe}else if(t>=e-r){const o=Math.max(0,e-t);return Math.min(-Ie,-Math.sqrt(2*ae*o))}else return t<=r?Math.min(-Ie,-Math.sqrt(2*ae*Math.max(t,0))):-qe};function Eo({config:{bottom:e,top:t},state:{direction:n,position:{z:r}}},o,s){const i=e*Qt,a=t*Qt,l=Do({currentAltitude:r-i,direction:n,totalDistance:a-i});if(Number.isNaN(l))throw new Error("velocity is NaN");const c=r<=i?"up":r>=a?"down":n;return{movementType:"vel",vels:{lift:{z:l}},stateDelta:{direction:c}}}const en=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),tn={stopAutowalk:0,portal:0,wall:0,doorLegs:0,sceneryPlayer:0,bubbles:0,block:1,barrier:1,floor:1,book:1,hushPuppy:1,teleporter:1,doorFrame:1,lift:2,movableBlock:2,portableBlock:2,slidingBlock:2,spring:2,ball:3,joystick:3,switch:3,charles:3,conveyor:3,head:4,heels:4,headOverHeels:4,pickup:8,firedDonut:9,slidingDeadly:10,moveableDeadly:10,deadlyBlock:10,baddie:10},Yn=(e,t)=>tn[e.type]-tn[t.type],$o=(e,t)=>t.toSorted((n,r)=>{const o=Yn(n,r);if(o!==0)return o;const s=se(e,en(e,n)),i=se(e,en(e,r));return s-i});function Kn({gameState:e,movingItem:t}){if(t.state.action==="death")return;const{shieldCollectedAt:n}=t.state;n!==null&&n+lt>e.gameTime||(t.state.action="death",t.state.expires=e.gameTime+dt)}const Bo=e=>{const{gameState:t,movingItem:n,touchedItem:r,room:{id:o}}=e;if(t.pickupsCollected[o][r.id]===!0)return;const s=t.pickupsCollected[o];switch(s[r.id]=!0,r.config.gives){case"hooter":{const i=Je(n);if(i!==void 0){i.hasHooter=!0;break}break}case"donuts":{const i=Je(n);i!==void 0&&(i.donuts+=6);break}case"bag":{const i=$t(n);if(i!==void 0){i.hasBag=!0;break}break}case"shield":{n.state.shieldCollectedAt=t.gameTime;break}case"fast":{const i=Je(n);i!==void 0&&(i.fastSteps=99);break}case"jumps":{const i=$t(n);i!==void 0&&(i.bigJumps+=10);break}case"extra-life":if(n.type==="headOverHeels"){n.state.head.lives+=2,n.state.heels.lives+=2;break}else n.state.lives+=2;break;case"scroll":t.inputState.jump=!1,t.events.emit("scrollOpened",{markdown:r.config.markdown});break;case"reincarnation":break;case"crown":break;default:r.config}},No=({gameState:e,movingItem:t,touchedItem:n,movementVector:r})=>{const{config:{relativePoint:o,toRoom:s,direction:i},state:{position:a}}=n,l=te[i];se(l,r)<=0||wt({playableItem:t,gameState:e,toRoomId:s,positionRelativeToSourcePortal:Ne(t.state.position,T(a,o)),sourcePortal:n,changeType:"portal"})},Ho=({movingItem:e,movementVector:t,touchedItem:n})=>{const{config:{direction:r,part:o}}=n,s=Ct(r);if(o==="top")return;const i=o==="far"?{x:s==="x"?-Math.abs(t.y):0,y:s==="y"?-Math.abs(t.x):0,z:0}:{x:s==="x"?Math.abs(t.y):0,y:s==="y"?Math.abs(t.x):0,z:0};e.state.position=T(e.state.position,i)};function Uo({movingItem:e}){e.state.autoWalk=!1}const $=(e,...t)=>O(...t)(e.touchedItem),_e=(e,...t)=>O(...t)(e.movingItem),Qn=e=>K(e.movingItem),Xo=e=>K(e.touchedItem),nn=e=>{switch(!0){case $(e,"stopAutowalk"):Uo(e);break;case($(e,...Or)||$(e,"floor")&&e.touchedItem.config.deadly):Kn(e);break;case $(e,"portal"):No(e);break;case $(e,"pickup"):Bo(e);break;case $(e,"doorFrame"):Ho(e);break}},Lo=({touchedItem:e,gameState:{progression:t},room:n})=>{const{config:{activates:r},state:{setting:o,touchedOnProgression:s}}=e;if(e.state.touchedOnProgression=t,t===s+1||t===s)return;const i=e.state.setting=o==="left"?"right":"left";for(const[a,l]of Tt(r)){const c=n.items[a];c!==void 0&&(c.state={...c.state,...l[i]})}return!1},Wo=({movingItem:e,touchedItem:t})=>{if(!ne(e))return;const{state:{position:n},aabb:r}=t,o=ge(e.state.position,e.aabb,n,r);if(o.x===0&&o.y===0)return;const s=Tn(o),i=z(s,-ve.ball);return t.state.vels.sliding=i,!1},Go=({movingItem:e,touchedItem:t})=>{if(!ne(t))return;const n=e.state.vels.sliding;if(xe(n,L))return;const{state:{position:r},aabb:o}=e,s=ge(t.state.position,t.aabb,r,o);return se(s,e.state.vels.sliding)>0&&(e.state.vels.sliding=L),!1},jo=({gameState:e,movingItem:t,room:n,touchedItem:r,deltaMS:o})=>{const{config:{controls:s},state:{position:i},aabb:a}=r,l=ge(t.state.position,t.aabb,i,a);if(l.x===0&&l.y===0)return;const c=Tn(l);for(const d of s){const u=n.items[d],f=z(c,-ve.charles*o);u.state.facing=f,Le({subjectItem:u,posDelta:f,gameState:e,room:n,pusher:r,deltaMS:o})}},Vo=(e,t,n,r)=>{const o=Math.max(0,Math.min(e.x+t.x,n.x+r.x)-Math.max(e.x,n.x)),s=Math.max(0,Math.min(e.y+t.y,n.y+r.y)-Math.max(e.y,n.y));return o*s},rn=({state:{position:e},aabb:t},{state:{position:n},aabb:r})=>Vo(e,t,n,r),on=.001,At=(e,t,n=.001)=>{if(!ne(t)||e.id===t.id)return!1;const{state:{vels:{gravity:{z:r}}}}=e;return r>0?!1:He({state:{position:T(e.state.position,{x:0,y:0,z:-on})},aabb:{...e.aabb,z:n+on},id:e.id},{state:{position:T(t.state.position,{x:0,y:0,z:t.aabb.z})},aabb:{...t.aabb,z:0},id:t.id})},er=(e,t)=>{const r=[...V(t).filter(s=>At(e,s))];return r.length===0?void 0:r.reduce((s,i)=>{const a=Yn(i,s);return a<0||a===0&&rn(e,i)>rn(e,s)?i:s})},sn=e=>{const t=Y(e.movingItem)&&At(e.movingItem,e.touchedItem,Math.abs(e.movementVector.z));if(e.touchedItem.state.disappear==="onTouch"||e.touchedItem.state.disappear==="onTouchByPlayer"&&K(e.movingItem)||e.touchedItem.state.disappear==="onStand"&&t){if(t&&Qn(e)){Ue({above:e.movingItem,below:e.touchedItem});const r=[Jn(e.movingItem,e.gameState),Zn(e.movingItem,e.gameState,e.deltaMS)];nr(e.movingItem,r)}kn(e)}};function qo(e){const t=e.movingItem.type==="baddie"?e.movingItem:e.touchedItem;t.state.busyLickingDoughnutsOffFace=!0}const Jo=e=>{Qn(e)&&nn(e),Xo(e)&&nn({...e,movingItem:e.touchedItem,touchedItem:e.movingItem}),$(e,...Bt)&&Wo(e),_e(e,...Bt)&&Go(e),(_e(e,"baddie")&&$(e,"firedDonut")||_e(e,"firedDonut")&&$(e,"baddie"))&&qo(e),_e(e,"baddie")&&Pr(e),$(e,"switch")&&Lo(e),$(e,"joystick")&&jo(e),e.touchedItem.state.disappear&&sn(e),e.movingItem.state.disappear&&ne(e.touchedItem)&&sn({...e,movingItem:e.touchedItem,touchedItem:e.movingItem})},Le=({subjectItem:e,posDelta:t,gameState:n,room:r,pusher:o,deltaMS:s,forceful:i=O("lift")(e)&&o===void 0,recursionDepth:a=0})=>{if(xe(t,L))return;if(a>16)throw new Error("this probably means a non-terminating issue");const{state:{position:l}}=e;e.state.position=T(l,t);const c=$o(t,On(e,A(r.items)));for(const d of c){if(!He(e,d))continue;if(o!==d&&Jo({movingItem:e,touchedItem:d,movementVector:Ne(e.state.position,l),gameState:n,deltaMS:s,room:r}),r.items[e.id]===void 0)return;if(r.items[d.id]===void 0||!ne(d)||!ne(e))continue;const u=ge(e.state.position,e.aabb,d.state.position,d.aabb);if(Y(d)&&d!==o){const f=i||Ir(d)?-1:-.5,m=z(u,f);if(e.state.position=T(e.state.position,u,m),Le({subjectItem:d,posDelta:m,pusher:e,gameState:n,room:r,deltaMS:s,forceful:i,recursionDepth:a+1}),r.items[d.id]===void 0)continue;e.state.position=T(e.state.position,ge(e.state.position,e.aabb,d.state.position,d.aabb))}else e.state.position=T(e.state.position,u);Y(e)&&u.z>0&&(e.state.standingOn===null||!c.includes(e.state.standingOn))&&(ut(e),Ue({above:e,below:d}))}};function Zo(e,t,n){const{state:{teleporting:r,standingOn:o}}=e,{inputState:{jump:s}}=t;if(r===null)return s&&o!==null&&O("teleporter")(o)?{movementType:"steady",stateDelta:{teleporting:{phase:"out",toRoom:o.config.toRoom,timeRemaining:dt}}}:Cn;const i=Math.max(r.timeRemaining-n,0);switch(r.phase){case"out":if(i===0)return wt({playableItem:e,gameState:t,toRoomId:r.toRoom,changeType:"teleport"}),{movementType:"steady",stateDelta:{teleporting:{phase:"in",timeRemaining:dt}}};break;case"in":if(i===0)return{movementType:"steady",stateDelta:{teleporting:null}};break}return{movementType:"steady",stateDelta:{teleporting:{...r,timeRemaining:i}}}}const an={movementType:"vel",vels:{movingFloor:L}},Yo=(e,t,n)=>{if(K(e)&&e.state.teleporting!==null)return an;const{state:{standingOn:r}}=e;if(r===null||!O("conveyor")(r))return an;const{config:{direction:o}}=r,i=O("heels")(e)&&e.state.action==="moving"&&e.state.facing===_r(o)?ve.heels:Fr;return{movementType:"vel",vels:{movingFloor:z(te[o],i)}}},Ko=(e,t,n,r)=>{const{inputState:o}=n,{state:{carrying:s,position:i,hasBag:a}}=e;if(!a)return;const l=V(A(t.items)).filter(Pn),c=s===null?es(e,t):void 0;for(const d of l)d.state.wouldPickUpNext=!1;if(c!==void 0&&(c.state.wouldPickUpNext=!0),o.carry){if(s===null){if(c===void 0){console.warn("nothing to pick up");return}Qo(t,e,c)}else{if(e.state.standingOn===null||!tr(e,A(t.items)))return;const d=Ar({gameState:n,room:t,itemType:s.type,config:s.config,position:i});Le({subjectItem:e,gameState:n,room:t,posDelta:{x:0,y:0,z:d.aabb.z},pusher:e,forceful:!0,deltaMS:r}),e.state.carrying=null}o.carry=!1}},Qo=(e,t,n)=>{const r={type:n.type,config:n.config};t.state.carrying=r,ye({room:e,item:n})},es=(e,t)=>er(e,V(A(t.items)).filter(Pn)),tr=(e,t)=>{const n={position:T(e.state.position,{z:X.h})},r=On({id:e.id,aabb:e.aabb,state:n},t);for(const o of r)if(!Y(o)||!tr(o,t))return!1;return!0};function*ts(e,t,n){for(;(e.state.latentMovement.at(0)?.moveAtGameTime??Number.POSITIVE_INFINITY)<t.gameTime;){const{positionDelta:r}=e.state.latentMovement.shift();yield{movementType:"position",posDelta:r}}}const ns=(e,t,n,r)=>{const{inputState:{fire:o}}=n,{state:{donuts:s,hasHooter:i,position:a,facing:l,donutLastFireTime:c}}=e;if(o&&i&&s>0&&c+500<n.gameTime){const u={type:"firedDonut",...De,config:kt,id:`firedDonut/${n.progression}`,shadowCastTexture:"shadow.smallRound",state:{position:T(a,z(te[l],X.w)),vels:{fired:z(te[l],ve.firedDonut)},disappear:"onTouch",expires:null,stoodOnBy:new Set}};ie({room:t,item:u}),e.state.donuts-=1,e.state.donutLastFireTime=n.gameTime,n.inputState.fire=!1}};function*rs(e,t,n,r){Y(e)&&(yield So(e,n,r),yield Yo(e),yield*ts(e,n)),K(e)&&(yield Zn(e,n,r),e.id===n.currentCharacterName&&(yield Zo(e,n,r),yield Jn(e,n),O("heels")(e)&&Ko(e,t,n,r),O("head")(e)&&ns(e,t,n))),O("lift")(e)&&(yield Eo(e)),O("baddie")(e)&&(yield zr(e,t,n,r))}const os=(e,t,n,r)=>{K(e)&&e.state.standingOn!==null&&Sr(e.state.standingOn)&&Kn({gameState:n,room:t,movingItem:e,touchedItem:e.state.standingOn,deltaMS:r,movementVector:{x:0,y:0,z:-1}});const o=[...rs(e,t,n,r)];Y(e)&&e.state.standingOn!==null&&e.state.standingOn.state.disappear==="onStand"&&kn({touchedItem:e.state.standingOn,gameState:n,room:t});let s=nr(e,o);(Y(e)||O("lift")(e)||O("firedDonut")(e))&&(s=T(s,...V(A(e.state.vels)).map(i=>z(i,r)))),Le({subjectItem:e,posDelta:s,gameState:n,room:t,deltaMS:r})},nr=(e,t)=>{let n=L;for(const r of t){if(r.movementType==="position"&&(n=T(n,r.posDelta)),r.movementType==="vel"&&(Y(e)||O("lift")(e)))for(const[s,i]of Tt(r.vels)){const a={...L,...i};e.state.vels[s]=a}const o=r.stateDelta;o!==void 0&&(e.state={...e.state,...o})}return n},ln=(e,...t)=>{const n={};for(const r of t)n[r]=e[r];return n},xt=e=>{const t={id:"head",type:"head",...De,...Nt,state:{...ht(),...ft(),...pt(),...e.state.head,facing:e.state.facing,shieldCollectedAt:e.state.shieldCollectedAt,position:T(e.state.position,{z:X.h})}},n={id:"heels",type:"heels",...De,...Nt,state:{...ht(),...ft(),...pt(),...e.state.heels,facing:e.state.facing,shieldCollectedAt:e.state.shieldCollectedAt,position:T(e.state.position)}};return{head:t,heels:n}},St=({head:e,heels:t})=>({type:"headOverHeels",id:"headOverHeels",...De,shadowCastTexture:t.shadowCastTexture,config:kt,aabb:Mr,state:{...ht(),...ft(),...pt(),position:t.state.position,action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:t.state.facing,head:ln(e.state,"hasHooter","donuts","donutLastFireTime","fastSteps","lives"),heels:ln(t.state,"hasBag","bigJumps","carrying","lives")}}),ss=e=>{const t=e.characterRooms.head,n=Z(e,"head"),r=Z(e,"heels"),o=St({head:n,heels:r});ye({room:t,item:"head"}),ye({room:t,item:"heels"}),ie({room:t,item:o}),e.previousPlayable=e.currentCharacterName,e.currentCharacterName="headOverHeels",e.characterRooms={head:void 0,heels:void 0,headOverHeels:t}},is=e=>{const t=e.characterRooms.headOverHeels,n=Z(e,"headOverHeels"),r=Ee(e.previousPlayable),{head:o,heels:s}=xt(n);r==="head"?o.state.position=T(o.state.position,{z:Ze}):(o.state.position=T(o.state.position,{z:Ze}),s.state.position=T(s.state.position,{z:Ze})),ye({room:t,item:"headOverHeels"}),ie({room:t,item:o}),ie({room:t,item:s}),Ue({above:o,below:s}),e.currentCharacterName=r,e.previousPlayable=void 0,e.characterRooms={head:t,heels:t,headOverHeels:void 0}},as=e=>{if(qn(e))ss(e);else if(e.currentCharacterName==="headOverHeels")is(e);else{if(Z(e,Ee(e.currentCharacterName))===void 0)return;e.currentCharacterName=Ee(e.currentCharacterName)}},ls=(e,t)=>{const n=e.characterRooms.headOverHeels;if(t.state.head.lives--,t.state.heels.lives--,t.state.head.lives+t.state.heels.lives===0){e.events.emit("gameOver");return}const o=t.state.head.lives>0,s=t.state.heels.lives>0;if(o&&!s||!o&&s){const c=o?"head":"heels";e.currentCharacterName=c,ee(e,t);const d=xt(t)[c],u=re({gameState:e,playableItems:[d],roomId:n.id});e.characterRooms={[c]:u},e.entryState={[c]:Re(d)};return}if(e.entryState.headOverHeels!==void 0){ee(e,t);const c=re({gameState:e,playableItems:[t],roomId:n.id});e.characterRooms={headOverHeels:c};return}else{const{head:c,heels:d}=xt(t);if(ee(e,c),ee(e,d),He(c,d)){const u=St({head:c,heels:d});ee(e,u,"heels");const f=re({gameState:e,playableItems:[u],roomId:n.id});e.characterRooms={headOverHeels:f},e.entryState={headOverHeels:Re(u)};return}else{const u=re({gameState:e,playableItems:[c,d],roomId:n.id});e.characterRooms={head:u,heels:u};return}}},re=({gameState:e,playableItems:t,roomId:n})=>{const{campaign:r}=e,o=at(r.rooms[n],e.pickupsCollected[n]);for(const s of t)ie({room:o,item:s});return o},ee=(e,t,n=t.id)=>{const r=e.entryState[n];t.state={...t.state,...r,expires:null,standingOn:null}},cs=(e,t)=>{const n=Z(e,Ee(t.type));if(t.state.lives--,t.type==="heels"&&(t.state.carrying=null),t.state.lives===0)if(delete e.characterRooms[t.id],n!==void 0){e.currentCharacterName=n.type;return}else{e.events.emit("gameOver");return}else{const r=e.characterRooms[t.type];ee(e,t);const o=n===void 0?void 0:e.characterRooms[n.type];if(r===o){if(e.entryState.headOverHeels!==void 0){const a=St({head:r.items.head,heels:r.items.heels});ee(e,a);const l=re({gameState:e,playableItems:[a],roomId:r.id});e.characterRooms={headOverHeels:l};return}ie({room:r,item:t});return}else{const i=re({gameState:e,playableItems:[t],roomId:r.id});e.characterRooms[t.id]=i;return}}},ds=(e,t)=>{t.type==="headOverHeels"?ls(e,t):cs(e,t)},us=e=>{for(const t of A(e.items))for(const n of t.state.stoodOnBy){if(!e.items[n.id]){ut(n);continue}if(!At(n,t)){ut(n);const r=er(n,A(e.items));r!==void 0&&Ue({above:n,below:r})}}},hs=(e,t,n)=>{for(const r of e){const o=n[r.id];if(o===void 0)continue;const i={...Ne(r.state.position,o),z:0};if(!xe(i,L))for(const a of r.state.stoodOnBy)a.state.latentMovement.push({moveAtGameTime:t.gameTime+2*Rr,positionDelta:i})}},fs=(e,t)=>e.state.expires!==null&&e.state.expires<t.gameTime,ps=(e,t,n)=>{for(const r of A(e.items)){const o=t[r.id];if(o===void 0)continue;xe(o,r.state.position)&&!Dr(r.state.position)&&(console.log(`snapping item ${r.id} to pixel grid`),r.state.position=Er(r.state.position),n.add(r))}},ms=(e,t)=>{const n={lift:-4,head:-3,heels:-3,baddie:-2,block:1,deadlyBlock:1},r=n[e.type]??0,o=n[t.type]??0;return r-o},gs=(e,t)=>{if(e.gameSpeed>1){let n=new Set;for(let r=0;r<e.gameSpeed;r++)n=new Set(Se(n,cn(e,t)));return n}return cn(e,t*e.gameSpeed)},cn=(e,t)=>{const{inputState:n}=e,r=me(e),o=Object.fromEntries(V(Tt(r.items)).map(([a,l])=>[a,l.state.position]));n.swop&&(as(e),n.swop=!1);for(const a of A(r.items))fs(a,e)&&(ye({room:r,item:a}),K(a)&&ds(e,a));const s=Object.values(r.items).sort(ms);for(const a of s){if(In(e).state.action==="death")break;r.items[a.id]!==void 0&&os(a,r,e,t)}us(r);const i=new Set(V(A(r.items)).filter(a=>o[a.id]===void 0||!xe(a.state.position,o[a.id])));return hs(i,e,o),ps(r,o,i),e.progression++,e.gameTime+=t,i},dn=(e,t)=>{const n=b(e),r=b(T(e,{x:t.x,z:t.z})),o=b(T(e,{y:t.y,z:t.z}));return{bottomCentre:n,topLeft:r,topRight:o}},Qe=(e,t,n,r,o=1e-5)=>r-o>e&&n<t-o,ys=(e,t,n,r)=>{const o=dn(e,t),s=dn(n,r),i=o.topLeft.x,a=o.topRight.x,l=s.topLeft.x,c=s.topRight.x,d=Qe(i,a,l,c),u=o.topRight.y-o.topRight.x/2,f=o.bottomCentre.y-o.bottomCentre.x/2,m=s.topRight.y-s.topRight.x/2,p=s.bottomCentre.y-s.bottomCentre.x/2,C=Qe(u,f,m,p),B=o.topLeft.y+o.topLeft.x/2,P=o.bottomCentre.y+o.bottomCentre.x/2,_=s.topLeft.y+s.topLeft.x/2,W=s.bottomCentre.y+s.bottomCentre.x/2,v=Qe(B,P,_,W);return d&&C&&v},vs=(e,t)=>{if(e.renders===!1||t.renders===!1||e.fixedZIndex!==void 0||t.fixedZIndex!==void 0)return 0;const n=e.state.position,r=e.renderAabb||e.aabb,o=t.state.position,s=t.renderAabb||t.aabb;if(!ys(n,r,o,s))return 0;for(const i of $r){const a=e.state.position[i],l=a+r[i],c=t.state.position[i],d=c+s[i];if(l<=c)return 1*(i==="z"?-1:1);if(a>=d)return-1*(i==="z"?-1:1)}return un(t)-un(e)},un=e=>e.state.position.x+e.state.position.y-e.state.position.z;class ze extends Error{constructor(t,n,r){super(`CyclicDependencyError: .cyclicDependency property of this error has nodes as an array. ${t.join(" -> ")}`,r),this.cyclicDependency=t,this.hasClosedCycle=n}}const xs=e=>{const t=bs(e);let n=t.length,r=n;const o=new Array(n),s={},i=ws(t);for(;r--;)s[r]||a(t[r],r,new Set);return o;function a(l,c,d){if(d.has(l))throw new ze([l],!1);if(s[c])return;s[c]=!0;const u=e.get(l)||new Set,f=Array.from(u);if(c=f.length){d.add(l);do{const m=f[--c];try{a(m,i.get(m),d)}catch(p){throw p instanceof ze?p.hasClosedCycle?p:new ze([l,...p.cyclicDependency],p.cyclicDependency.includes(l)):p}}while(c);d.delete(l)}o[--n]=l}};function bs(e){const t=new Set;for(const[n,r]of e.entries()){t.add(n);for(const o of r)t.add(o)}return Array.from(t)}function ws(e){const t=new Map;for(let n=0,r=e.length;n<r;n++)t.set(e[n],n);return t}const hn=(e,t,n)=>{e.has(t)||e.set(t,new Set),e.get(t).add(n)},Fe=(e,t,n)=>{const r=e.get(t);r!==void 0&&(r?.delete(n),r.size===0&&e.delete(t))},Cs=(e,t=new Set(A(e)),n=new Map)=>{const r=new Map;for(const[o,s]of n)if(!e[o])n.delete(o);else for(const i of s)e[i]||Fe(n,o,i);for(const o of t)if(o.renders)for(const s of A(e)){if(!s.renders||r.get(s)?.has(o)||o===s)continue;const i=vs(o,s);if(hn(r,o,s),i===0){Fe(n,o.id,s.id),Fe(n,s.id,o.id);continue}const a=i>0?o.id:s.id,l=i>0?s.id:o.id;hn(n,a,l),Fe(n,l,a)}return n},rr=(e,t,n=3)=>{try{return{order:xs(e),impossible:!1}}catch(r){if(r instanceof ze){const o=r.cyclicDependency;return e.get(o[0])?.delete(o[1]),{order:rr(e,t,n-1).order,impossible:!0}}else throw r}},Ts=(e,t,n,r)=>`${e}${r?".dark":""}.wall.${t}.${n}`,ks=(e,t,n)=>{const o=w.textures[`door.frame.${e.planet}.${t}.near`]!==void 0?e.planet:"generic",s=e.color.shade==="dimmed"&&w.textures[`door.frame.${o}.dark.${t}.${n}`]!==void 0;return`door.frame.${o}${s?".dark":""}.${t}.${n}`},Ae=e=>F(()=>h(e)),F=e=>({item:t,room:n,currentlyRenderedProps:r})=>{if(r===void 0)return{container:e({item:t,room:n}),renderProps:kt}};function*Os({config:{direction:e,inHiddenWall:t,height:n}},r){const o=Ct(e),s=o==="y"?0:16;function*i(a){if(t){if(n!==0){const c=h({pivot:{x:o==="x"?18:8,y:12},texture:`generic.door.floatingThreshold.${o}`,...Ye(a,{y:-X.h*n})});c.filters=vt(r,o==="x"?"towards":"right"),yield c}}else{yield h({pivot:{x:s,y:12},texture:"generic.door.legs.base",...Ye(a,{y:n})});for(let l=1;l<n;l++)yield h({pivot:{x:s,y:9},texture:"generic.door.legs.pillar",...Ye(a,{y:-l*X.h})})}}yield*i(q({...fe,[o]:1})),yield*i(fe),t||(yield h({pivot:{x:16,y:X.h*n+13},texture:`generic.door.legs.threshold.double.${o}`,...q({...fe,[o]:1})}))}const Ps=F(({item:e,room:t})=>Ft(Os(e,t),new g({filters:J(t)})));function*Is({config:{direction:e,inHiddenWall:t,part:n},state:{position:r}},o){const s=Ct(e),{z:i}=r;if(!t&&i===0){const a=q({[Br(s)]:.5});n==="far"&&(yield h({anchor:{x:0,y:1},flipX:s==="x",texture:"generic.wall.overdraw",...a}))}yield h({texture:ks(o,s,n),filter:J(o)})}const _s=F(({item:e,room:t})=>Ft(Is(e,t))),et={frames:w.animations["bubbles.cold"],animationSpeed:.25},Q=({top:e,bottom:t="headless-base",filter:n})=>{const r=new g({filters:n});r.addChild(h(t));const o=h(e);return o.y=-12,r.addChild(o),r},tt=(e,t,n,r)=>{if(t==="death")return{frames:w.animations[`${e}.fadeOut`]};if(r!==null){if(r.phase==="out")return{frames:w.animations[`${e}.fadeOut`]};if(r.phase==="in")return{frames:w.animations[`${e}.fadeOut`].toReversed()}}return t==="moving"?{frames:w.animations[`${e}.walking.${n}`]}:t==="falling"&&e==="head"&&(n==="towards"||n==="right")?`head.falling.${n}`:e==="head"&&(n==="towards"||n==="right")?{frames:w.animations[`head.idle.${n}`]}:`${e}.walking.${n}.2`},nt=({item:{type:e,state:{action:t,facing:n,teleporting:r}},currentlyRenderedProps:o})=>{if(o===void 0||o.action!==t||o.facingXy4!==n||o.teleportingPhase!==(r?.phase??null))return{container:e==="headOverHeels"?Q({top:tt("head",t,n,r),bottom:tt("heels",t,n,r)}):h(tt(e,t,n,r)),renderProps:{action:t,facingXy4:n,teleportingPhase:r?.phase??null}}},Fs=F(({item:e,room:t})=>{const{blockXMin:n,blockYMin:r,blockXMax:o,blockYMax:s,sidesWithDoors:i}=_n(t.roomJson),a=o-n,l=s-r,{floor:c,color:{shade:d}}=t,u=new g({label:`floor(${t.id})`});if(c!=="none"){const P=c==="deadly"?`generic${d==="dimmed"?".dark":""}.floor.deadly`:`${c}${d==="dimmed"?".dark":""}.floor`,_=new g;for(let v=-1;v<=o+2;v++)for(let R=v%2-1;R<=s+2;R+=2)_.addChild(le({x:v+(i.right?-.5:0),y:R+(i.towards?-.5:0)},h({texture:P})));for(let v=0;v<=t.size.x;v++)t.walls.away[v]!=="none"&&_.addChild(le({x:v-n,y:t.size.y+(i.towards?.5:0)},h({anchor:{x:0,y:1},texture:"generic.floor.overdraw",flipX:!0})));for(let v=0;v<=t.size.y;v++)t.walls.left[v]!=="none"&&_.addChild(le({x:t.size.x+(i.right?.5:0),y:v-r},h({anchor:{x:0,y:1},texture:"generic.floor.overdraw"})));const W=new oe().poly([fe,q({x:a,y:0}),q({x:a,y:l}),q({x:0,y:l})],!0).fill({color:16711680,alpha:.5}).stroke({width:8});_.addChild(W),_.filters=J(t),_.mask=W,u.addChild(_)}const f=new g;for(let P=0;P<=a;P+=.5)f.addChild(le({x:P,y:0},h({pivot:{x:7,y:0},texture:"generic.edge.towards"})));f.filters=vt(t,"towards");const m=new g;for(let P=0;P<=l;P+=.5)m.addChild(le({x:0,y:P},h({pivot:{x:0,y:0},texture:"generic.edge.right"})));m.filters=vt(t,"right");const p=q({x:t.size.x+(i.right?.5:0),y:-r}).x,C=q({x:-n,y:t.size.y+(i.towards?.5:0)}).x,B=new oe().poly([{x:p,y:16},{x:p,y:-999},{x:C,y:-999},{x:C,y:16}],!0).fill(16776960);return u.addChild(B),u.addChild(f),u.addChild(m),u.mask=B,u.y=-e.aabb.z,u}),As=(e,t,n)=>t==="organic"&&e?`block.organic.dark${n?".disappearing":""}`:`block.${t}${n?".disappearing":""}`,rt=(e,t)=>t?new g({children:[h({texture:e,pivot:{x:j.w/2,y:j.h}}),h({texture:`${e}.outline`,pivot:{x:j.w/2+1,y:j.h+1}})]}):h(e),fn=F(({item:{config:{style:e}}})=>h(e)),Ss={head:nt,heels:nt,headOverHeels:nt,doorFrame:_s,doorLegs:Ps,stopAutowalk(){throw new Error("these should always be non-rendering")},portal(){throw new Error("these should always be non-rendering")},wall:F(({item:{config:{side:e,style:t}},room:n})=>{if(e==="right"||e==="towards")throw new Error("this wall should be non-rendering");return h({texture:Ts(n.planet,t,e,n.color.shade==="dimmed"),y:2,pivot:e==="away"?{x:Ke.w,y:Ke.h+1}:{x:0,y:Ke.h+1},filter:J(n)})}),barrier:F(({item:{config:{axis:e}}})=>h({texture:`barrier.${e}`})),deadlyBlock:F(({item:{config:{style:e}},room:t})=>h({texture:e,filter:e==="volcano"?J(t):void 0})),slidingDeadly:fn,slidingBlock:fn,block({item:{config:{style:e},state:{disappear:t}},room:n,currentlyRenderedProps:r}){if(r===void 0||r.disappear!==t)return{container:h({texture:As(n.color.shade==="dimmed",e,t!==null),filter:e==="organic"?J(n):void 0}),renderProps:{disappear:t}}},switch({item:{state:{setting:e}},currentlyRenderedProps:t}){if(t===void 0||e!==t.setting)return{container:h(`switch.${e}`),renderProps:{setting:e}}},conveyor({item:{config:{direction:e,count:t},state:{stoodOnBy:n}},currentlyRenderedProps:r}){const o=n.size>0;if(!(r===void 0||r.moving!==o))return;const i=new g,a=Ur(e);return i.addChild(...V(Nr(t,0,-1)).map(l=>{const c=Xr({[a]:(l-1)*X.w});return h(o?{frames:w.animations[`conveyor.${a}`],reverse:e==="towards"||e==="right",animationSpeed:.5,...c}:{texture:`conveyor.${a}.6`,...c})})),{container:i,renderProps:{moving:o}}},lift:F(()=>{const e=new g,t={x:j.w/2,y:j.h-Lr};return e.addChild(h({frames:w.animations.lift,pivot:t})),e.addChild(h({texture:"lift.static",pivot:t})),e}),teleporter({item:{state:{stoodOnBy:e}},currentlyRenderedProps:t}){const n=V(e).find(K)!==void 0;return t===void 0||n!==t.flashing?{container:n?new g({children:[h("teleporter"),h({frames:w.animations["teleporter.flashing"]})]}):h("teleporter"),renderProps:{flashing:n}}:void 0},pickup:F(({item:{config:{gives:e}},room:t})=>{const r={shield:"bunny",jumps:"bunny",fast:"bunny","extra-life":"bunny",bag:"bag",donuts:"donuts",hooter:"hooter",crown:"crown",scroll:{texture:"scroll",filter:J(t)},reincarnation:{frames:w.animations.fish,animationSpeed:.25}}[e];return h(r)}),moveableDeadly:F(({item:{config:{style:e}}})=>h(e==="deadFish"?"fish.1":"puck.deadly")),sceneryPlayer:F(({item:{config:{which:e}}})=>e==="headOverHeels"?Q({top:"head.walking.towards.2",bottom:"heels.walking.towards.2"}):h(`${e}.walking.towards.2`)),charles({item:{state:{facing:e}},currentlyRenderedProps:t}){const n=Ht(e);if(t===void 0||n!==t.facingXy4)return{container:Q({top:`charles.${n}`}),renderProps:{facingXy4:n}}},baddie({item:{config:e,state:t},room:n,currentlyRenderedProps:r}){let o;const{activated:s,busyLickingDoughnutsOffFace:i}=t,a=i?ko:s?void 0:To(n);switch(e.which){case"american-football-head":case"turtle":case"cyberman":o=e.startDirection;case"computer-bot":case"elephant":case"monkey":{const l=Hr(t.vels.walking,fe)?o??"towards":Ht(t.vels.walking);if(!(r===void 0||s!==r.activated||i!==r.busyLickingDoughnutsOffFace||l!==r.facingXy4))return;const d={facingXy4:l,activated:s,busyLickingDoughnutsOffFace:i};switch(e.which){case"american-football-head":return{container:h({texture:`${e.which}.${e.style}.${l}`,filter:a}),renderProps:d};case"turtle":return{container:h(s&&!i?{frames:w.animations[`${e.which}.${l}`],animationSpeed:.25,filter:a}:{texture:`${e.which}.${l}.1`,filter:a}),renderProps:d};case"cyberman":return{container:t.activated||t.busyLickingDoughnutsOffFace?Q({top:{texture:`${e.which}.${l}`,filter:a||J(n)},bottom:et}):h({texture:`${e.which}.${l}`,filter:a}),renderProps:d};case"computer-bot":case"elephant":case"monkey":return{container:Q({top:`${e.which}.${l}`,filter:a}),renderProps:d}}break}case"helicopter-bug":case"dalek":case"headless-base":case"elephant-head":case"bubble-robot":case"flying-ball":{if(!(r===void 0||i!==r.busyLickingDoughnutsOffFace||s!==r.activated))return;const c={activated:s,busyLickingDoughnutsOffFace:i};switch(e.which){case"helicopter-bug":case"dalek":{const d=w.animations[e.which];return{container:h(s&&!i?{frames:d,animationSpeed:.5,filter:a}:{texture:`${e.which}.1`,filter:a}),renderProps:c}}case"headless-base":return{filter:a,container:h({texture:e.which,filter:a}),renderProps:c};case"elephant-head":return{container:h({texture:"elephant.towards",filter:a}),renderProps:c};case"bubble-robot":return{container:Q({top:et,filter:a}),renderProps:c};case"flying-ball":return{container:Q({top:"ball",bottom:et,filter:a}),renderProps:c}}break}default:throw new Error(`unexpected baddie ${e}`)}},joystick:Ae("joystick"),movableBlock:F(({item:{config:{style:e}}})=>h(e)),portableBlock({item:{config:{style:e},state:{wouldPickUpNext:t}},currentlyRenderedProps:n}){const r=t;if(n===void 0||r!==n.highlighted)return{container:rt(e,r),renderProps:{highlighted:r}}},spring({item:{state:{stoodOnBy:e,wouldPickUpNext:t}},currentlyRenderedProps:n}){const r=e.size>0,o=t;if(!(n===void 0||o!==n.highlighted||r!==n.compressed))return;const i=n?.compressed??!1;return{container:!r&&i?h({frames:w.animations["spring.bounce"],playOnce:"and-stop"}):rt(r?"spring.compressed":"spring.released",o),renderProps:{compressed:r,highlighted:o}}},book:F(({item:{config:{slider:e}}})=>h(`book.${e?"y":"x"}`)),hushPuppy:Ae("hushPuppy"),bubbles:F(({item:{config:{style:e}}})=>h({frames:w.animations[`bubbles.${e}`]})),firedDonut:Ae({frames:w.animations["bubbles.donut"]}),ball:Ae("ball"),floor:Fs},pn=(e,t)=>{const n=new oe().poly([b({}),b({x:e.x}),b({x:e.x,y:e.y}),b({y:e.y})]).poly([b({}),b({z:e.z}),b({y:e.y,z:e.z}),b({y:e.y})]).poly([b({x:e.x}),b({x:e.x,z:e.z}),b(e),b({x:e.x,y:e.y})]).poly([b({z:e.z}),b({x:e.x,z:e.z}),b({x:e.x,y:e.y,z:e.z}),b({y:e.y,z:e.z})]).stroke({width:.25,color:t,alpha:1});return n.eventMode="static",n.on("pointerenter",()=>{n.fill({color:t,alpha:.5})}),n.on("pointerleave",()=>{n.fill({color:"transparent"})}),n},zs={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",stopAutowalk:"rgba(255,128,128)"},Ms=e=>{const t=zs[e.type]??"rgba(255,255,255)",n=new g;if(O("portal")(e)){const r=b(e.config.relativePoint);n.addChild(new oe().circle(r.x,r.y,5).stroke(t)),n.addChild(new oe().circle(r.x,r.y,2).fill(t))}return n.addChild(new oe().circle(0,0,2).fill(t)),n.addChild(pn(e.aabb,t)),e.renderAabb&&n.addChild(pn(e.renderAabb,"rgba(184, 184, 255)")),n},Rs=(e,t,n)=>{if(e.shadowMask===void 0)return;const r=new g({label:"mainShadows"}),o=new g({label:"shadows"});if(n.showShadowMasks||(r.filters=new io({alpha:.5})),e.shadowMask.spriteOptions){const i=h(e.shadowMask.spriteOptions);e.shadowMask.relativeTo==="top"&&(i.y=-e.aabb.z),r.addChild(i),n.showShadowMasks||(r.mask=i)}const s={};return r.addChild(o),{get item(){return e},destroy(){r.destroy({children:!0})},tick({movedItems:i,progression:a}){const l=i.has(e),c=e.state.position.z+e.aabb.z,d=V(A(t.items)).filter(function(p){return p.shadowCastTexture!==void 0}),u={id:e.id,state:{position:{...e.state.position,z:c}},aabb:{...e.aabb,z:Wr}},f=Object.groupBy(d,m=>{const p=s[m.id]!==void 0,C=i.has(m);return!l&&!C?p?"keepUnchanged":"noShadow":He(u,m)?p?"update":"create":"noShadow"});for(const m of Se(f.keepUnchanged,f.update))s[m.id].renderedOnProgression=a;for(const m of Se(f.create)){const p=h(m.shadowCastTexture);p.label=m.id,o.addChild(p),s[m.id]={sprite:p,renderedOnProgression:a}}for(const m of Se(f.create,f.update)){const{sprite:p}=s[m.id],C=b({...Gr(m.state.position,e.state.position),z:e.aabb.z});p.x=C.x,p.y=C.y}for(const[m,{sprite:p,renderedOnProgression:C}]of jr(s))C!==a&&(p.destroy(),delete s[m]);r.visible=(f.keepUnchanged?.length??0)+(f.update?.length??0)+(f.create?.length??0)>0},container:r}},Ds=(e,t,n)=>{t!==void 0&&n.onItemClick&&t!==void 0&&(t.eventMode="static",t.on("pointertap",()=>{n.onItemClick(e,t)}))},mn=({state:{position:e}},t)=>{const n=Vr(e);t.x=n.x,t.y=n.y},Es=(e,t,n)=>{const r=n.showBoundingBoxes==="all"||n.showBoundingBoxes==="non-wall"&&e.type!=="wall";if(!e.renders&&!r)return;const o=new g({label:"render"});n.showBoundingBoxes!=="none"&&(o.alpha=.5);const s=new g({label:`item(${e.id})`});s.addChild(o),e.fixedZIndex!==void 0&&(s.zIndex=e.fixedZIndex),Ds(e,s,n),r&&(s.addChild(Ms(e)),mn(e,s));let i;const a=Ss[e.type],l=Rs(e,t,n);return l!==void 0&&s.addChild(l.container),{get item(){return e},destroy(){s.destroy({children:!0}),o.destroy({children:!0}),l&&l.destroy()},tick(c){const d=e.renders?a({item:e,room:t,currentlyRenderedProps:i}):void 0;d!==void 0&&(i=d.renderProps,o.children.forEach(f=>f.destroy()),d.container!==null&&o.addChild(d.container)),c.movedItems.has(e)&&mn(e,s),l&&l.tick(c)},container:s}},$s=(e,t)=>{const{leftSide:n,rightSide:r,frontSide:o,top:s}=_n(e.roomJson),i=(r.x+n.x)/2,a=(s+o.y)/2;t.x=-i,t.y=-a},gn=(e,t)=>{const n=new g({label:`room(${e.id})`}),r=new g({label:`items(room(${e.id}))`});let o=!0;const s=new Map;n.addChild(r),$s(e,n);const i=new Map;return{get container(){return n},get room(){return e},tick(a){const l=o?{movedItems:new Set(A(e.items)),progression:0}:a;for(const c of A(e.items)){let d=i.get(c.id);if(d!==null){if(d===void 0){if(d=Es(c,e,t),d===void 0){i.set(c.id,null);continue}i.set(c.id,d),r.addChild(d.container)}d.tick(l)}}for(const[c,d]of i.entries())e.items[c]===void 0&&(d!==null&&d.destroy(),i.delete(c));if(o||l.movedItems.size>0){const{order:c}=rr(Cs(e.items,l.movedItems,s),e.items);for(let d=0;d<c.length;d++){const u=i.get(c[d]);if(u===void 0)throw new Error(`Item id=${c[d]} does not have a renderer - cannot assign a z-index`);u.container.zIndex=c.length-d}}o=!1},destroy(){n.destroy({children:!0}),i.forEach(a=>{a!==null&&a.destroy()})},get renderOptions(){return t}}},Bs=4,Ns=(e,t)=>{const n=new g;n.label="world",n.y=qr.height*.7,e.stage.addChild(n);const r=new g;r.y=-Bs,e.stage.addChild(r);const o=new he(y.shadow);let s=gn(me(t),t.renderOptions);n.addChild(s.container);const i=Ao(r),a=wo(e),l=({deltaMS:c})=>{const d=a.rescale();n.x=e.renderer.width/a.curUpscale/2;const u=t.gameSpeed===0;i(t,d);const f=me(t);if((s.room!==f||s.renderOptions!==t.renderOptions)&&(s.destroy(),s=gn(f,t.renderOptions),n.addChild(s.container),t.events.emit("roomChange",f.id)),u){e.stage.filters=o;const m=f.color;o.targetColor=Wn(m).main.original}else{e.stage.filters=ue;const m=gs(t,c);s.tick({progression:t.progression,movedItems:m})}};return{start(){return e.ticker.add(l),this},stop(){e.stage.removeChild(n),e.ticker.remove(l)}}},Hs=async e=>{const t={showBoundingBoxes:"none",showShadowMasks:!1},n=new $n;await n.init({background:"#000000",resizeTo:window});const r=bo({campaign:e,renderOptions:t}),o=yo({keyAssignment:r.keyAssignment,inputState:r.inputState,onInputStateChange(i){r.events.emit("inputStateChanged",i)}}),s=Ns(n,r).start();return{campaign:e,events:r.events,renderIn(i){i.appendChild(n.canvas)},changeRoom(i){wt({playableItem:In(r),gameState:r,toRoomId:i,changeType:"level-select"})},get currentRoom(){return me(r)},get gameState(){return r},set renderOptions(i){r.renderOptions=i},stop(){console.warn("tearing down game"),n.canvas.parentNode?.removeChild(n.canvas),s.stop(),o(),n.destroy()}}},Ls=Object.freeze(Object.defineProperty({__proto__:null,gameMain:Hs},Symbol.toStringTag,{value:"Module"}));export{Mn as A,An as C,Ot as F,ro as R,Kr as S,Rn as V,Ls as g,Yr as u};
