const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-vo38Z-01.js","assets/index-BrlWWZSN.js","assets/index-BUyUKZ4B.css","assets/colorToUniform-Cpd6sprA.js","assets/SharedSystems-lUGB6-X8.js","assets/Graphics-2JRXXbBq.js","assets/WebGLRenderer-ClpBewh7.js"])))=>i.map(i=>d[i]);
import{u as _n,y as Cn,z as _t,e as Ct,E as ke,c as kn,C as R,d as We,v as Ue,Y as F,D as ft,a4 as jt,K as kt,a as be,b as Pe,U as Tn,V as On,a5 as An,a6 as zn,a7 as $n,a8 as je,a9 as cr,aa as ur,ab as dr,ac as Ae,ad as se,ae as hr,af as Pn,ag as Sn,ah as En,ai as Rn,aj as fr,ak as te,al as Fn,am as In,an as ae,ao as ie}from"./index-BrlWWZSN.js";import{S as Mn,G as Ge}from"./Graphics-2JRXXbBq.js";const pr=class pt extends _n{constructor(t){t={...pt.defaultOptions,...t},super(t),this.enabled=!0,this._state=Mn.for2d(),this.blendMode=t.blendMode,this.padding=t.padding,typeof t.antialias=="boolean"?this.antialias=t.antialias?"on":"off":this.antialias=t.antialias,this.resolution=t.resolution,this.blendRequired=t.blendRequired,this.addResource("uTexture",0,1)}apply(t,r,n,o){t.applyFilter(this,r,n,o)}get blendMode(){return this._state.blendMode}set blendMode(t){this._state.blendMode=t}static from(t){const{gpu:r,gl:n,...o}=t;let i,s;return r&&(i=Cn.from(r)),n&&(s=_t.from(n)),new pt({gpuProgram:i,glProgram:s,...o})}};pr.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1};let yr=pr;const yt=[];Ct.handleByNamedList(ke.Environment,yt);async function Ln(e){if(!e)for(let t=0;t<yt.length;t++){const r=yt[t];if(r.value.test()){await r.value.load();return}}}let me;function Nn(){if(typeof me=="boolean")return me;try{me=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{me=!1}return me}var gr=(e=>(e[e.NONE=0]="NONE",e[e.COLOR=16384]="COLOR",e[e.STENCIL=1024]="STENCIL",e[e.DEPTH=256]="DEPTH",e[e.COLOR_DEPTH=16640]="COLOR_DEPTH",e[e.COLOR_STENCIL=17408]="COLOR_STENCIL",e[e.DEPTH_STENCIL=1280]="DEPTH_STENCIL",e[e.ALL=17664]="ALL",e))(gr||{});class Dn{constructor(t){this.items=[],this._name=t}emit(t,r,n,o,i,s,a,c){const{name:h,items:f}=this;for(let _=0,y=f.length;_<y;_++)f[_][h](t,r,n,o,i,s,a,c);return this}add(t){return t[this._name]&&(this.remove(t),this.items.push(t)),this}remove(t){const r=this.items.indexOf(t);return r!==-1&&this.items.splice(r,1),this}contains(t){return this.items.indexOf(t)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const Bn=["init","destroy","contextChange","resolutionChange","reset","renderEnd","renderStart","render","update","postrender","prerender"],mr=class xr extends kn{constructor(t){super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=t.type,this.name=t.name,this.config=t;const r=[...Bn,...this.config.runners??[]];this._addRunners(...r),this._unsafeEvalCheck()}async init(t={}){const r=t.skipExtensionImports===!0?!0:t.manageImports===!1;await Ln(r),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const n in this._systemsHash)t={...this._systemsHash[n].constructor.defaultOptions,...t};t={...xr.defaultOptions,...t},this._roundPixels=t.roundPixels?1:0;for(let n=0;n<this.runners.init.items.length;n++)await this.runners.init.items[n].init(t);this._initOptions=t}render(t,r){let n=t;if(n instanceof R&&(n={container:n},r&&(We(Ue,"passing a second argument is deprecated, please use render options instead"),n.target=r.renderTexture)),n.target||(n.target=this.view.renderTarget),n.target===this.view.renderTarget&&(this._lastObjectRendered=n.container,n.clearColor=this.background.colorRgba),n.clearColor){const o=Array.isArray(n.clearColor)&&n.clearColor.length===4;n.clearColor=o?n.clearColor:F.shared.setValue(n.clearColor).toArray()}n.transform||(n.container.updateLocalTransform(),n.transform=n.container.localTransform),this.runners.prerender.emit(n),this.runners.renderStart.emit(n),this.runners.render.emit(n),this.runners.renderEnd.emit(n),this.runners.postrender.emit(n)}resize(t,r,n){const o=this.view.resolution;this.view.resize(t,r,n),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),n!==void 0&&n!==o&&this.runners.resolutionChange.emit(n)}clear(t={}){const r=this;t.target||(t.target=r.renderTarget.renderTarget),t.clearColor||(t.clearColor=this.background.colorRgba),t.clear??(t.clear=gr.ALL);const{clear:n,clearColor:o,target:i}=t;F.shared.setValue(o??this.background.colorRgba),r.renderTarget.clear(i,n,F.shared.toArray())}get resolution(){return this.view.resolution}set resolution(t){this.view.resolution=t,this.runners.resolutionChange.emit(t)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...t){t.forEach(r=>{this.runners[r]=new Dn(r)})}_addSystems(t){let r;for(r in t){const n=t[r];this._addSystem(n.value,n.name)}}_addSystem(t,r){const n=new t(this);if(this[r])throw new Error(`Whoops! The name "${r}" is already in use`);this[r]=n,this._systemsHash[r]=n;for(const o in this.runners)this.runners[o].add(n);return this}_addPipes(t,r){const n=r.reduce((o,i)=>(o[i.name]=i.value,o),{});t.forEach(o=>{const i=o.value,s=o.name,a=n[s];this.renderPipes[s]=new i(this,a?new a:null)})}destroy(t=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(t),Object.values(this.runners).forEach(r=>{r.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(t){return this.textureGenerator.generateTexture(t)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!Nn())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}};mr.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let br=mr,Se;function Wn(e){return Se!==void 0||(Se=(()=>{const t={stencil:!0,failIfMajorPerformanceCaveat:e??br.defaultOptions.failIfMajorPerformanceCaveat};try{if(!ft.get().getWebGLRenderingContext())return!1;let n=ft.get().createCanvas().getContext("webgl",t);const o=!!n?.getContextAttributes()?.stencil;if(n){const i=n.getExtension("WEBGL_lose_context");i&&i.loseContext()}return n=null,o}catch{return!1}})()),Se}let Ee;async function Un(e={}){return Ee!==void 0||(Ee=await(async()=>{const t=ft.get().getNavigator().gpu;if(!t)return!1;try{return await(await t.requestAdapter(e)).requestDevice(),!0}catch{return!1}})()),Ee}const Gt=["webgl","webgpu","canvas"];async function jn(e){let t=[];e.preference?(t.push(e.preference),Gt.forEach(i=>{i!==e.preference&&t.push(i)})):t=Gt.slice();let r,n={};for(let i=0;i<t.length;i++){const s=t[i];if(s==="webgpu"&&await Un()){const{WebGPURenderer:a}=await jt(async()=>{const{WebGPURenderer:c}=await import("./WebGPURenderer-vo38Z-01.js");return{WebGPURenderer:c}},__vite__mapDeps([0,1,2,3,4,5]));r=a,n={...e,...e.webgpu};break}else if(s==="webgl"&&Wn(e.failIfMajorPerformanceCaveat??br.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:a}=await jt(async()=>{const{WebGLRenderer:c}=await import("./WebGLRenderer-ClpBewh7.js");return{WebGLRenderer:c}},__vite__mapDeps([6,1,2,3,4,5]));r=a,n={...e,...e.webgl};break}else if(s==="canvas")throw n={...e},new Error("CanvasRenderer is not yet implemented")}if(delete n.webgpu,delete n.webgl,!r)throw new Error("No available renderer for the current environment");const o=new r;return await o.init(n),o}const wr="8.4.1";class vr{static init(){globalThis.__PIXI_APP_INIT__?.(this,wr)}static destroy(){}}vr.extension=ke.Application;class Gn{constructor(t){this._renderer=t}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,wr)}destroy(){this._renderer=null}}Gn.extension={type:[ke.WebGLSystem,ke.WebGPUSystem],name:"initHook",priority:-10};const _r=class gt{constructor(...t){this.stage=new R,t[0]!==void 0&&We(Ue,"Application constructor options are deprecated, please use Application.init() instead.")}async init(t){t={...t},this.renderer=await jn(t),gt._plugins.forEach(r=>{r.init.call(this,t)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return We(Ue,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(t=!1,r=!1){const n=gt._plugins.slice(0);n.reverse(),n.forEach(o=>{o.destroy.call(this)}),this.stage.destroy(r),this.stage=null,this.renderer.destroy(t),this.renderer=null}};_r._plugins=[];let Cr=_r;Ct.handleByList(ke.Application,Cr._plugins);Ct.add(vr);class Ve extends kt{constructor(...t){let r=t[0];Array.isArray(t[0])&&(r={textures:t[0],autoUpdate:t[1]});const{textures:n,autoUpdate:o,...i}=r,[s]=n;super({...i,texture:s instanceof be?s:s.texture}),this._textures=null,this._durations=null,this._autoUpdate=o??!0,this._isConnectedToTicker=!1,this.animationSpeed=1,this.loop=!0,this.updateAnchor=!1,this.onComplete=null,this.onFrameChange=null,this.onLoop=null,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=n}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(Pe.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(Pe.shared.add(this.update,this,Tn.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(t){this.stop(),this.currentFrame=t}gotoAndPlay(t){this.currentFrame=t,this.play()}update(t){if(!this._playing)return;const r=t.deltaTime,n=this.animationSpeed*r,o=this.currentFrame;if(this._durations!==null){let i=this._currentTime%1*this._durations[this.currentFrame];for(i+=n/60*1e3;i<0;)this._currentTime--,i+=this._durations[this.currentFrame];const s=Math.sign(this.animationSpeed*r);for(this._currentTime=Math.floor(this._currentTime);i>=this._durations[this.currentFrame];)i-=this._durations[this.currentFrame]*s,this._currentTime+=s;this._currentTime+=i/this._durations[this.currentFrame]}else this._currentTime+=n;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):o!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<o||this.animationSpeed<0&&this.currentFrame>o)&&this.onLoop(),this._updateTexture())}_updateTexture(){const t=this.currentFrame;this._previousFrame!==t&&(this._previousFrame=t,this.texture=this._textures[t],this.updateAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(){this.stop(),super.destroy(),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(t){const r=[];for(let n=0;n<t.length;++n)r.push(be.from(t[n]));return new Ve(r)}static fromImages(t){const r=[];for(let n=0;n<t.length;++n)r.push(be.from(t[n]));return new Ve(r)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(t){if(t[0]instanceof be)this._textures=t,this._durations=null;else{this._textures=[],this._durations=[];for(let r=0;r<t.length;r++)this._textures.push(t[r].texture),this._durations.push(t[r].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let t=Math.floor(this._currentTime)%this._textures.length;return t<0&&(t+=this._textures.length),t}set currentFrame(t){if(t<0||t>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${t}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const r=this.currentFrame;this._currentTime=t,r!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(t){t!==this._autoUpdate&&(this._autoUpdate=t,!this._autoUpdate&&this._isConnectedToTicker?(Pe.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(Pe.shared.add(this.update,this),this._isConnectedToTicker=!0))}}class Vn extends On{constructor(t,r){const{text:n,resolution:o,style:i,anchor:s,width:a,height:c,roundPixels:h,...f}=t;super({...f}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=r,this.text=n??"",this.style=i,this.resolution=o??null,this.allowChildren=!1,this._anchor=new An({_onUpdate:()=>{this.onViewUpdate()}}),s&&(this.anchor=s),this.roundPixels=h??!1,a!==void 0&&(this.width=a),c!==void 0&&(this.height=c)}get anchor(){return this._anchor}set anchor(t){typeof t=="number"?this._anchor.set(t):this._anchor.copyFrom(t)}set text(t){t=t.toString(),this._text!==t&&(this._text=t,this.onViewUpdate())}get text(){return this._text}set resolution(t){this._autoResolution=t===null,this._resolution=t,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(t){t=t||{},this._style?.off("update",this.onViewUpdate,this),t instanceof this._styleClass?this._style=t:this._style=new this._styleClass(t),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get bounds(){return this._boundsDirty&&(this._updateBounds(),this._boundsDirty=!1),this._bounds}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(t){this._setWidth(t,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(t){this._setHeight(t,this.bounds.height)}getSize(t){return t||(t={}),t.width=Math.abs(this.scale.x)*this.bounds.width,t.height=Math.abs(this.scale.y)*this.bounds.height,t}setSize(t,r){typeof t=="object"?(r=t.height??t.width,t=t.width):r??(r=t),t!==void 0&&this._setWidth(t,this.bounds.width),r!==void 0&&this._setHeight(r,this.bounds.height)}addBounds(t){const r=this.bounds;t.addFrame(r.minX,r.minY,r.maxX,r.maxY)}containsPoint(t){const r=this.bounds.width,n=this.bounds.height,o=-r*this.anchor.x;let i=0;return t.x>=o&&t.x<=o+r&&(i=-n*this.anchor.y,t.y>=i&&t.y<=i+n)}onViewUpdate(){if(this._didViewChangeTick++,this._boundsDirty=!0,this.didViewUpdate)return;this.didViewUpdate=!0,this._didTextUpdate=!0;const t=this.renderGroup||this.parentRenderGroup;t&&t.onChildViewUpdate(this)}_getKey(){return`${this.text}:${this._style.styleKey}:${this._resolution}`}destroy(t=!1){super.destroy(t),this.owner=null,this._bounds=null,this._anchor=null,(typeof t=="boolean"?t:t?.style)&&this._style.destroy(t),this._style=null,this._text=null}}function Hn(e,t){let r=e[0]??{};return(typeof r=="string"||e[1])&&(We(Ue,`use new ${t}({ text: "hi!", style }) instead`),r={text:r,style:e[1]}),r}class Xn extends Vn{constructor(...t){const r=Hn(t,"Text");super(r,zn),this.renderPipeId="text"}_updateBounds(){const t=this._bounds,r=this._anchor,n=$n.measureText(this._text,this._style),{width:o,height:i}=n;t.minX=-r._x*o,t.maxX=t.minX+o,t.minY=-r._y*i,t.maxY=t.minY+i}}const U=e=>e.characterRooms[e.currentCharacterName].room,Tt=(e,t,r)=>e.pickupsCollected[t][r]===!0,qn=e=>e.characterRooms[e.currentCharacterName].room.items[e.currentCharacterName],Yn=(e,t)=>e.characterRooms[t]?.room.items[t],D={renders:!0,falls:!1},Ot=["away","towards","left","right"],Kn=e=>e==="away"||e==="towards"?"y":"x",Zn=e=>e==="away"?"towards":e==="towards"?"away":e==="left"?"right":"left",le=e=>At(Kn(e)),we={away:{x:0,y:1,z:0},left:{x:1,y:0,z:0},right:{x:-1,y:0,z:0},towards:{x:0,y:-1,z:0},down:{x:0,y:0,z:-1},up:{x:0,y:0,z:1}},At=e=>e==="x"?"y":"x",Ne=(e,...t)=>t.reduce((r,n)=>({x:r.x+(n.x??0),y:r.y+(n.y??0)}),e),ye=(e,t)=>({x:e.x*t,y:e.y*t,z:e.z*t}),P=(e,...t)=>t.reduce((r,n)=>({x:r.x+(n.x??0),y:r.y+(n.y??0),z:r.z+(n.z??0)}),e),zt=(e,...t)=>t.reduce((r,n)=>({x:r.x-(n.x??0),y:r.y-(n.y??0),z:r.z-(n.z??0)}),e),He=({x:e,y:t,z:r},{x:n,y:o,z:i})=>e===n&&t===o&&r===i,ct=e=>Math.abs(e-Math.round(e))<.001,Jn=({x:e=0,y:t=0,z:r=0})=>ct(e)&&ct(t)&&ct(r),Qn=({x:e=0,y:t=0,z:r=0})=>Number.isInteger(e)&&Number.isInteger(t)&&Number.isInteger(r),eo=({x:e,y:t,z:r})=>({x:Math.round(e),y:Math.round(t),z:Math.round(r)}),Vt=Object.freeze({x:0,y:0}),ge=Object.freeze({x:0,y:0,z:0}),kr=["x","y","z"],Ht=(e,t)=>e.x*t.x+e.y*t.y+e.z*t.z,C={w:16,d:16,h:12},to={near:{x:{x:16,y:56},y:{x:8,y:56}},far:{x:{x:8,y:52},y:{x:16,y:52}}},ro={x:{x:8,y:24},y:{x:6,y:22}},ut=(e,t)=>{const r=K(e);return t.x=r.x,t.y=r.y,t},T=e=>{const t=Jn(e),{x:r=0,y:n=0,z:o=0}=e;return{x:n-r,y:t?-(r+n>>1)-o:-(r+n)/2-o}},N=({x:e=0,y:t=0,z:r=0})=>({x:e*C.w,y:t*C.d,z:r*C.h}),K=e=>T(N(e)),Tr={head:je/1e3,heels:2*je/1e3},no=je/1e3,oo=2,Re={head:C.h*2.5,heels:C.h},Or=2e-4,io={head:-(C.h*2)/1e3,others:-(C.h*6)/1e3},et=8,Fe={x:12,y:12,z:C.h},Xt={x:14,y:14,z:C.h},Ie={x:16,y:16,z:C.h},Ar=50,Xe={x:C.w,y:0,z:et*C.h},zr={...Xe,z:Ar},qe={x:0,y:C.d,z:et*C.h},$r={...qe,z:Ar},Ye=e=>{switch(e.type){case"spring":case"portable-block":case"lift":case"pickup":case"player":return{aabb:Fe};case"ball":case"switch":case"fish":return{aabb:Xt};case"block":switch(e.config.style){case"artificial":case"organic":return{aabb:Ie};case"tower":return{aabb:{x:11,y:11,z:C.h}};default:throw new Error("unknown block style")}case"baddie":switch(e.config.which){case"american-football-head":case"bubble-robot":return{aabb:{...Fe,z:C.h*2}};case"helicopter-bug":return{aabb:Fe};default:return{aabb:Ie}}case"deadly-block":switch(e.config.style){case"puck":return{aabb:Fe};default:return{aabb:Ie}}case"book":case"conveyor":case"hush-puppy":case"teleporter":return{aabb:Ie};case"barrier":return{aabb:e.config.axis==="y"?{x:3,y:15,z:C.h}:{x:15,y:3,z:C.h}};case"wall":return e.config.side==="left"||e.config.side==="right"?{aabb:qe,renderAabb:$r}:{aabb:Xe,renderAabb:zr};default:return console.warn("giving default aabb for item",e),{aabb:Xt}}};function*so(e){for(let t=e.size.y-1;t>=0;t--){const r=e.walls.left[t];r!=="none"&&(yield{...D,type:"wall",id:`wall-left-${t}`,config:{side:"left",style:r},state:{position:N({x:e.size.x,y:t,z:0}),expires:null},aabb:qe,renderAabb:$r}),Object.values(e.items).find(o=>o.type==="door"&&le(o.config.direction)==="y"&&o.position.x===0&&(o.position.y===t||o.position.y+1===t))!==void 0||(yield{...D,type:"wall",id:`wall-right-${t}`,config:{side:"left",style:"none"},state:{position:N({x:0,y:t,z:0}),expires:null},aabb:qe,renders:!1})}for(let t=e.size.x-1;t>=0;t--){const r=e.walls.away[t];r!=="none"&&(yield{...D,type:"wall",id:`wall-away-${t}`,config:{side:"away",style:r},state:{position:N({x:t,y:e.size.y,z:0}),expires:null},aabb:Xe,renderAabb:zr}),Object.values(e.items).find(o=>o.type==="door"&&le(o.config.direction)==="x"&&(o.position.x===t||o.position.x+1===t)&&o.position.y===0)!==void 0||(yield{...D,type:"wall",id:`wall-towards-${t}`,config:{side:"towards",style:"none"},state:{position:N({x:t,y:0,z:0}),expires:null},aabb:Xe,renders:!1})}}const ao=({config:{direction:e},position:t})=>e==="right"&&t.x===0||e==="towards"&&t.y===0,Me=C.h*2;function*lo(e,t){const{config:{direction:r},position:n}=e,o=le(r),i=At(o),s=ao(e),a={...ge,[i]:s?-.5:0};yield{...e,...D,id:`${t}/far`,config:{...e.config,inHiddenWall:s,nearness:"far"},type:"doorFrame",state:{position:N(P(n,{[o]:1.5},a)),expires:null},aabb:{x:8,y:8,z:Me}};const c=N(P(n,a));yield{...e,...D,id:`${t}/near`,config:{...e.config,inHiddenWall:s,nearness:"near"},type:"doorFrame",state:{position:c,expires:null},aabb:{x:8,y:8,z:Me}},yield{...e,...D,id:`${t}/portal`,config:{...e.config,inHiddenWall:s,relativePoint:c},type:"portal",renders:!1,state:{position:N(P(n,{[o]:.5},{[i]:s?-.5:.5})),expires:null},aabb:{[o]:C.w,[i]:0,z:Me}},yield{...e,...D,id:`${t}/wall`,config:{style:"none",side:"away"},renders:!1,type:"wall",state:{position:P(N(P(n,a)),{z:Me}),expires:null},aabb:N({[o]:2,[i]:.5,z:et-n.z-2})},n.z>0&&(yield{...e,...D,id:`${t}/legs`,config:{...e.config,inHiddenWall:s,style:"none",side:"away",height:n.z},renders:!0,type:"doorLegs",state:{position:P({...N(P(n,a)),z:0}),expires:null},aabb:{...N({[o]:2,[i]:.5,z:n.z})}})}const mt=e=>{const t=N(e.position),{aabb:r}=Ye(e);if(r===void 0)throw new Error(`item type= ${e.type} config=${JSON.stringify(e.config)} has no bounding box`);return e.type==="wall"?t:P(t,{x:C.w-r.x>>1,y:C.d-r.y>>1})},co=e=>e.config.which==="head"?{type:"head",config:{},...D,...Ye(e),id:"head",state:{facing:"towards",action:"idle",jumpEndTime:-1,hasHooter:!1,fast:0,shield:0,standingOn:null,velZ:0,lives:8,donuts:0,autoWalkDistance:0,teleporting:null,position:mt(e),expires:null},falls:!0}:{type:"heels",config:{},...D,...Ye(e),id:"heels",state:{facing:"towards",action:"idle",carrying:null,hasBag:!1,jumps:0,shield:0,standingOn:null,velZ:0,lives:8,autoWalkDistance:0,jumpEndTime:-1,teleporting:null,position:mt(e),expires:null},falls:!0};function*uo(e,t,{id:r},n){if(!(t.type==="pickup"&&n[r][e]))switch(t.type){case"door":return yield*lo(t,e);case"player":{yield co(t);return}default:{const o=cr.includes(t.type);yield{...t,...D,...Ye(t),id:e,config:t.config,state:ho(t),falls:o}}}}const ho=e=>{const t=cr.includes(e.type);return{position:mt(e),...t?{standingOn:null,velZ:0}:{},...e.type==="teleporter"?{flashing:!1}:{},...e.type==="pickup"?{collected:!1}:{}}},ce=e=>e[Symbol.iterator](),fo=({aabb:e,state:{position:t}},{aabb:r,state:{position:n}})=>{for(const o of kr)if(t[o]+e[o]<=n[o]||t[o]>=n[o]+r[o])return!1;return!0},$t=(e,t)=>[...ce(t).filter(r=>e.id!==r.id&&fo(e,r))];var Pr={exports:{}},Sr={exports:{}};(function(e){function t(r){"@babel/helpers - typeof";return e.exports=t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},e.exports.__esModule=!0,e.exports.default=e.exports,t(r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports})(Sr);var tt=Sr.exports;(function(e){var t=tt.default;function r(){e.exports=r=function(){return o},e.exports.__esModule=!0,e.exports.default=e.exports;var n,o={},i=Object.prototype,s=i.hasOwnProperty,a=Object.defineProperty||function(d,l,u){d[l]=u.value},c=typeof Symbol=="function"?Symbol:{},h=c.iterator||"@@iterator",f=c.asyncIterator||"@@asyncIterator",_=c.toStringTag||"@@toStringTag";function y(d,l,u){return Object.defineProperty(d,l,{value:u,enumerable:!0,configurable:!0,writable:!0}),d[l]}try{y({},"")}catch{y=function(u,g,w){return u[g]=w}}function b(d,l,u,g){var w=l&&l.prototype instanceof G?l:G,x=Object.create(w.prototype),z=new at(g||[]);return a(x,"_invoke",{value:wn(d,u,z)}),x}function v(d,l,u){try{return{type:"normal",arg:d.call(l,u)}}catch(g){return{type:"throw",arg:g}}}o.wrap=b;var O="suspendedStart",E="suspendedYield",A="executing",B="completed",S={};function G(){}function V(){}function X(){}var ot={};y(ot,h,function(){return this});var it=Object.getPrototypeOf,ze=it&&it(it(lt([])));ze&&ze!==i&&s.call(ze,h)&&(ot=ze);var ue=X.prototype=G.prototype=Object.create(ot);function Wt(d){["next","throw","return"].forEach(function(l){y(d,l,function(u){return this._invoke(l,u)})})}function $e(d,l){function u(w,x,z,M){var W=v(d[w],d,x);if(W.type!=="throw"){var re=W.arg,Z=re.value;return Z&&t(Z)=="object"&&s.call(Z,"__await")?l.resolve(Z.__await).then(function(ne){u("next",ne,z,M)},function(ne){u("throw",ne,z,M)}):l.resolve(Z).then(function(ne){re.value=ne,z(re)},function(ne){return u("throw",ne,z,M)})}M(W.arg)}var g;a(this,"_invoke",{value:function(x,z){function M(){return new l(function(W,re){u(x,z,W,re)})}return g=g?g.then(M,M):M()}})}function wn(d,l,u){var g=O;return function(w,x){if(g===A)throw Error("Generator is already running");if(g===B){if(w==="throw")throw x;return{value:n,done:!0}}for(u.method=w,u.arg=x;;){var z=u.delegate;if(z){var M=Ut(z,u);if(M){if(M===S)continue;return M}}if(u.method==="next")u.sent=u._sent=u.arg;else if(u.method==="throw"){if(g===O)throw g=B,u.arg;u.dispatchException(u.arg)}else u.method==="return"&&u.abrupt("return",u.arg);g=A;var W=v(d,l,u);if(W.type==="normal"){if(g=u.done?B:E,W.arg===S)continue;return{value:W.arg,done:u.done}}W.type==="throw"&&(g=B,u.method="throw",u.arg=W.arg)}}}function Ut(d,l){var u=l.method,g=d.iterator[u];if(g===n)return l.delegate=null,u==="throw"&&d.iterator.return&&(l.method="return",l.arg=n,Ut(d,l),l.method==="throw")||u!=="return"&&(l.method="throw",l.arg=new TypeError("The iterator does not provide a '"+u+"' method")),S;var w=v(g,d.iterator,l.arg);if(w.type==="throw")return l.method="throw",l.arg=w.arg,l.delegate=null,S;var x=w.arg;return x?x.done?(l[d.resultName]=x.value,l.next=d.nextLoc,l.method!=="return"&&(l.method="next",l.arg=n),l.delegate=null,S):x:(l.method="throw",l.arg=new TypeError("iterator result is not an object"),l.delegate=null,S)}function vn(d){var l={tryLoc:d[0]};1 in d&&(l.catchLoc=d[1]),2 in d&&(l.finallyLoc=d[2],l.afterLoc=d[3]),this.tryEntries.push(l)}function st(d){var l=d.completion||{};l.type="normal",delete l.arg,d.completion=l}function at(d){this.tryEntries=[{tryLoc:"root"}],d.forEach(vn,this),this.reset(!0)}function lt(d){if(d||d===""){var l=d[h];if(l)return l.call(d);if(typeof d.next=="function")return d;if(!isNaN(d.length)){var u=-1,g=function w(){for(;++u<d.length;)if(s.call(d,u))return w.value=d[u],w.done=!1,w;return w.value=n,w.done=!0,w};return g.next=g}}throw new TypeError(t(d)+" is not iterable")}return V.prototype=X,a(ue,"constructor",{value:X,configurable:!0}),a(X,"constructor",{value:V,configurable:!0}),V.displayName=y(X,_,"GeneratorFunction"),o.isGeneratorFunction=function(d){var l=typeof d=="function"&&d.constructor;return!!l&&(l===V||(l.displayName||l.name)==="GeneratorFunction")},o.mark=function(d){return Object.setPrototypeOf?Object.setPrototypeOf(d,X):(d.__proto__=X,y(d,_,"GeneratorFunction")),d.prototype=Object.create(ue),d},o.awrap=function(d){return{__await:d}},Wt($e.prototype),y($e.prototype,f,function(){return this}),o.AsyncIterator=$e,o.async=function(d,l,u,g,w){w===void 0&&(w=Promise);var x=new $e(b(d,l,u,g),w);return o.isGeneratorFunction(l)?x:x.next().then(function(z){return z.done?z.value:x.next()})},Wt(ue),y(ue,_,"Generator"),y(ue,h,function(){return this}),y(ue,"toString",function(){return"[object Generator]"}),o.keys=function(d){var l=Object(d),u=[];for(var g in l)u.push(g);return u.reverse(),function w(){for(;u.length;){var x=u.pop();if(x in l)return w.value=x,w.done=!1,w}return w.done=!0,w}},o.values=lt,at.prototype={constructor:at,reset:function(l){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(st),!l)for(var u in this)u.charAt(0)==="t"&&s.call(this,u)&&!isNaN(+u.slice(1))&&(this[u]=n)},stop:function(){this.done=!0;var l=this.tryEntries[0].completion;if(l.type==="throw")throw l.arg;return this.rval},dispatchException:function(l){if(this.done)throw l;var u=this;function g(re,Z){return z.type="throw",z.arg=l,u.next=re,Z&&(u.method="next",u.arg=n),!!Z}for(var w=this.tryEntries.length-1;w>=0;--w){var x=this.tryEntries[w],z=x.completion;if(x.tryLoc==="root")return g("end");if(x.tryLoc<=this.prev){var M=s.call(x,"catchLoc"),W=s.call(x,"finallyLoc");if(M&&W){if(this.prev<x.catchLoc)return g(x.catchLoc,!0);if(this.prev<x.finallyLoc)return g(x.finallyLoc)}else if(M){if(this.prev<x.catchLoc)return g(x.catchLoc,!0)}else{if(!W)throw Error("try statement without catch or finally");if(this.prev<x.finallyLoc)return g(x.finallyLoc)}}}},abrupt:function(l,u){for(var g=this.tryEntries.length-1;g>=0;--g){var w=this.tryEntries[g];if(w.tryLoc<=this.prev&&s.call(w,"finallyLoc")&&this.prev<w.finallyLoc){var x=w;break}}x&&(l==="break"||l==="continue")&&x.tryLoc<=u&&u<=x.finallyLoc&&(x=null);var z=x?x.completion:{};return z.type=l,z.arg=u,x?(this.method="next",this.next=x.finallyLoc,S):this.complete(z)},complete:function(l,u){if(l.type==="throw")throw l.arg;return l.type==="break"||l.type==="continue"?this.next=l.arg:l.type==="return"?(this.rval=this.arg=l.arg,this.method="return",this.next="end"):l.type==="normal"&&u&&(this.next=u),S},finish:function(l){for(var u=this.tryEntries.length-1;u>=0;--u){var g=this.tryEntries[u];if(g.finallyLoc===l)return this.complete(g.completion,g.afterLoc),st(g),S}},catch:function(l){for(var u=this.tryEntries.length-1;u>=0;--u){var g=this.tryEntries[u];if(g.tryLoc===l){var w=g.completion;if(w.type==="throw"){var x=w.arg;st(g)}return x}}throw Error("illegal catch attempt")},delegateYield:function(l,u,g){return this.delegate={iterator:lt(l),resultName:u,nextLoc:g},this.method==="next"&&(this.arg=n),S}},o}e.exports=r,e.exports.__esModule=!0,e.exports.default=e.exports})(Pr);var po=Pr.exports,De=po(),Er=De;try{regeneratorRuntime=De}catch{typeof globalThis=="object"?globalThis.regeneratorRuntime=De:Function("r","regeneratorRuntime = r")(De)}var j={},Rr={exports:{}},Fr={exports:{}},Ir={exports:{}};(function(e){var t=tt.default;function r(n,o){if(t(n)!="object"||!n)return n;var i=n[Symbol.toPrimitive];if(i!==void 0){var s=i.call(n,o||"default");if(t(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(o==="string"?String:Number)(n)}e.exports=r,e.exports.__esModule=!0,e.exports.default=e.exports})(Ir);var yo=Ir.exports;(function(e){var t=tt.default,r=yo;function n(o){var i=r(o,"string");return t(i)=="symbol"?i:i+""}e.exports=n,e.exports.__esModule=!0,e.exports.default=e.exports})(Fr);var go=Fr.exports;(function(e){var t=go;function r(n,o,i){return(o=t(o))in n?Object.defineProperty(n,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[o]=i,n}e.exports=r,e.exports.__esModule=!0,e.exports.default=e.exports})(Rr);var mo=Rr.exports,Mr={exports:{}},Lr={exports:{}},Nr={exports:{}};(function(e){function t(r,n){(n==null||n>r.length)&&(n=r.length);for(var o=0,i=Array(n);o<n;o++)i[o]=r[o];return i}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports})(Nr);var Dr=Nr.exports;(function(e){var t=Dr;function r(n){if(Array.isArray(n))return t(n)}e.exports=r,e.exports.__esModule=!0,e.exports.default=e.exports})(Lr);var xo=Lr.exports,Br={exports:{}};(function(e){function t(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports})(Br);var bo=Br.exports,Wr={exports:{}};(function(e){var t=Dr;function r(n,o){if(n){if(typeof n=="string")return t(n,o);var i={}.toString.call(n).slice(8,-1);return i==="Object"&&n.constructor&&(i=n.constructor.name),i==="Map"||i==="Set"?Array.from(n):i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?t(n,o):void 0}}e.exports=r,e.exports.__esModule=!0,e.exports.default=e.exports})(Wr);var wo=Wr.exports,Ur={exports:{}};(function(e){function t(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports})(Ur);var vo=Ur.exports;(function(e){var t=xo,r=bo,n=wo,o=vo;function i(s){return t(s)||r(s)||n(s)||o()}e.exports=i,e.exports.__esModule=!0,e.exports.default=e.exports})(Mr);var jr=Mr.exports,Pt={},St={};function _o(e){return typeof e<"u"}St.notUndefined=_o;var Co=St,ko=Co.notUndefined;function To(e){return e!=null&&ko(e[Symbol.iterator])}Pt.isIterable=To;var Gr={};Gr.isLoopable=Pt.isIterable;var Vr={},Oo=St,Ao=Oo.notUndefined;function zo(e){return e==null||Ao(e[Symbol.iterator])}Vr.isWrappable=zo;var Et={},rt=Er,$o=rt.mark(Hr),Po=rt.mark(Xr);function Hr(e){return rt.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.delegateYield(e,"t0",1);case 1:case"end":return r.stop()}},$o)}Et.wrap=Hr;function Xr(e){return rt.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(e==null){r.next=2;break}return r.delegateYield(e,"t0",2);case 2:case"end":return r.stop()}},Po)}Et.nullableWrap=Xr;var Rt={},Ke=jr;function qr(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:e.length,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];return function(){for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return t<=o.length?e.apply(void 0,Ke(r).concat(o)):qr(e,t-o.length,[].concat(Ke(r),o))}}Rt.curry=qr;function So(e,t){var r=e.fn,n=e.validateArgs,o=e.variadic,i=e.reduces,s=e.growRight,a=e.minArgs,c=e.maxArgs,h=e.isIterable,f=e.iterableType,_=e.applyOnIterableArgs,y=e.IterableClass;if(t.length>a){var b=!0,v=o?t.findIndex(function(V,X){return h(V)&&X>=a}):Math.min(c,t.length-1),O=o?t.length:v+1;if(o)for(var E=v;E<t.length;E++)b=b&&h(t[E]);else b=h(t[v]);if(t.length>c&&(v===-1||!b)){var A=o?"...".concat(f,"s"):f,B="".concat(r.name," takes up to ").concat(c," arguments, followed by ").concat(A,". ")+"You already passed ".concat(t.length," arguments");throw o?new Error("".concat(B," and the following arguments were not all ").concat(f,"s")):new Error("".concat(B," and the last argument was not ").concat(f))}if(v>=0&&b){for(var S=v;S<O;S++)t[S]=_(t[S]);var G=o?t.slice(v):t[v];return t.splice(v),s||t.reverse(),t.unshift(G),n(t),i?r.apply(void 0,Ke(t)):new y(r,t)}}return Yr(e,t)}function Yr(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];return function(){for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];if(n.length===0)throw new Error("Cannot make a partial application with no arguments");return n.unshift.apply(n,Ke(t)),So(e,n)}}Rt.variadicCurryWithValidation=Yr;var nt={},Eo=Symbol.for("_");nt._=Eo;var Ro=Symbol("__iterate");nt.__iterate=Ro;var Fo=Symbol("split");nt.split=Fo;var ve=mo,Kr=jr,de,Io=Pt,Zr=Io.isIterable,Mo=Gr,Lo=Mo.isLoopable,No=Vr,Ft=No.isWrappable,Do=Et,Jr=Do.nullableWrap,Bo=Rt,Wo=Bo.variadicCurryWithValidation,Qr=nt,_e=Qr._,Ce=Qr.__iterate;j.wrap=Jr;j.isIterable=Zr;j.isLoopable=Lo;j.isWrappable=Ft;function en(e){if(Ft(e))return Zr(e)?e:Jr(e);throw typeof e.next=="function"?new TypeError("iter-tools received a value that looked like an iterator but was not iterable. Get help fixing this: https://github.com/iter-tools/iter-tools/wiki/Making-iterators-iterable"):new TypeError("Expected an iterable, null, or undefined")}j.ensureIterable=en;function Uo(e){"return"in e&&e.return()}j.callReturn=Uo;function Te(e,t){this[_e]={fn:e,args:t,staticIterator:null}}j.BaseIterableIterator=Te;Object.assign(Te.prototype,(de={constructor:Te},ve(de,Ce,function(){var e=this[_e],t=e.fn,r=e.args;return t.apply(void 0,Kr(r))}),ve(de,"next",function(){var t=this[_e];return t.staticIterator=t.staticIterator||this[Ce](),t.staticIterator.next()}),ve(de,"return",function(t){var r=this[_e];return r.staticIterator=r.staticIterator||this[Ce](),r.staticIterator.return(t)}),ve(de,"throw",function(t){var r=this[_e];return r.staticIterator=r.staticIterator||this[Ce](),r.staticIterator.throw(t)}),de));function Oe(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];Te.apply(this,t)}j.IterableIterator=Oe;Oe.prototype=Object.assign(Object.create(Te.prototype),ve({constructor:Oe},Symbol.iterator,function(){return this[Ce]()}));function jo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=t.validateArgs,n=r===void 0?function(E){}:r,o=t.variadic,i=o===void 0?!1:o,s=t.reduces,a=s===void 0?!1:s,c=t.growRight,h=c===void 0?!1:c,f=t.minArgs,_=f===void 0?e.length-1:f,y=t.maxArgs,b=y===void 0?e.length-1:y,v=t.applyOnIterableArgs,O=v===void 0?en:v;return{fn:e,validateArgs:n,variadic:i,reduces:a,growRight:h,minArgs:_,maxArgs:b,isIterable:Ft,iterableType:"iterable",applyOnIterableArgs:O,IterableClass:Oe}}function Go(e){return Kr(e)}j.cache=Go;function Vo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=t.validateArgs,n=r===void 0?function(o){return o}:r;return function(){for(var o=arguments.length,i=new Array(o),s=0;s<o;s++)i[s]=arguments[s];return n(i),new Oe(e,i)}}j.wrapWithIterableIterator=Vo;var Ho=function(t,r){return Wo(jo(t,r))};j.iterableCurry=Ho;var It={},Xo=tt,xt=Er,qo=xt.mark(Mt),Yo=j,Ko=Yo.wrapWithIterableIterator,Zo=Object.prototype.hasOwnProperty;function Mt(e){var t;return xt.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(e!=null){n.next=2;break}return n.abrupt("return");case 2:n.t0=xt.keys(e);case 3:if((n.t1=n.t0()).done){n.next=10;break}if(t=n.t1.value,!Zo.call(e,t)){n.next=8;break}return n.next=8,e[t];case 8:n.next=3;break;case 10:case"end":return n.stop()}},qo)}It.__objectValues=Mt;var Jo=Ko(Mt,{validateArgs:function(t){if(!(t[0]==null||Xo(t[0])==="object"))throw new Error("obj argument to objectValues must be an object, null, or undefined")}});It.objectValues=Jo;var Qo=It.objectValues;const I=ur(Qo);function*ei(e){const t={...N(Ne(e.size,{x:2,y:2})),z:0},r=N({x:-1,y:-1,z:0});if(e.floor==="none"&&e.roomBelow!==void 0?yield{...D,type:"portal",id:"floor",config:{toRoom:e.roomBelow,relativePoint:r},aabb:t,state:{position:r,expires:null},renders:!1}:yield{...D,type:"floor",id:"floor",config:{deadly:e.floor==="deadly"},aabb:t,state:{position:r,expires:null},renders:!1},e.roomAbove!==void 0){const n=P(r,{z:C.h*et});yield{...D,type:"portal",id:"ceiling",config:{toRoom:e.roomAbove,relativePoint:zt(n,{z:C.h})},aabb:t,state:{position:n,expires:null},renders:!1}}}function*ti(e,t){const r=dr(e.items);for(const[n,o]of r)yield*uo(n,o,e,t)}const tn=({state:{position:e},aabb:t,id:r},n)=>{const o=P(e,{z:-1}),i=$t({state:{position:o},aabb:t,id:r},n);for(const s of i)if(s.state.position.z+s.aabb.z===e.z)return s;return null},rn=(e,t)=>{e.state.standingOn=tn(e,I(t))},ri=e=>{for(const t of I(e))Ae(t)&&rn(t,e)},dt=e=>ce(e).reduce((t,r)=>({...t,[r.id]:r}),{}),Ze=(e,t)=>{const r={...dt(ei(e)),...dt(so(e)),...dt(ti(e,t))};for(const n of I(r)){const o=$t(n,I(r));if(o.length>0)throw new Error(`item ${n.id} is colliding with ${o.map(i=>i.id)}`)}return ri(r),{...e,items:r}},bt=({state:{position:e,facing:t,autoWalkDistance:r,action:n}})=>({position:e,facing:t,autoWalkDistance:r,action:n}),ni=["head","heels"],Lt=e=>e==="head"?"heels":"head",Nt=(e,t,r=ge)=>{const{currentCharacterName:n}=e,o=e.characterRooms[n].room;if(t===o.id)throw new Error(`Can't move to the same room "${t}" from "${o.id}"`);const i=Lt(n),s=e.characterRooms[i]?.room,a=s?.id===t?s:Ze(e.campaign.rooms[t],e.pickupsCollected),c=o.items[n];if(c===void 0)throw new Error(`Couldn't find character ${n} in room ${o.id} - can't move them to new room ${t}`);delete o.items[n];const h=ce(I(a.items)).find(f=>se("portal")(f)&&f.config.toRoom===o.id);h!==void 0&&(c.state.position=P(h.config.relativePoint,r)),delete a.items[n],a.items[n]=c,c.state.standingOn=tn(c,I(a.items)),console.log("destinationRoom",a.id),e.characterRooms[n]={room:a,entryState:bt(c)},e.events.emit("roomChange",t)},oi=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","Å","Ä","Ö","0","1","2","3","4","5","6","7","8","9","!","@","#","$","%","^","&","*","(",")","-","_","=","+","[","]","{","}",";",":","'",'"',",",".","/","<",">","?","\\","|"," ","Enter","Shift","Control","`","~","Tab","Backspace","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Numpad0","Numpad1","Numpad2","Numpad3","Numpad4","Numpad5","Numpad6","Numpad7","Numpad8","Numpad9","NumpadAdd","NumpadSubtract","NumpadMultiply","NumpadDivide","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12"],qt=e=>oi.includes(e),q={right:["P"],towards:["A"],left:["O"],away:["Q"],jump:[" ","M"],carry:["C","M"],fire:["N"],swop:["Enter","S"],pause:["H"]},ii={right:["ArrowRight",...q.right],towards:["ArrowDown",...q.towards],left:["ArrowLeft",...q.left],away:["ArrowUp",...q.away],jump:q.jump,carry:["Shift",...q.carry],fire:["Control",...q.fire],swop:q.swop,pause:["F8",...q.pause]};function*Yt(e,t){for(const[r,n]of dr(e))n.includes(t)&&(yield r)}const Kt=e=>e.length===1?e.toUpperCase():e,si=({keyAssignment:e,inputState:t})=>{const r=({key:o})=>{const i=Kt(o);if(!qt(i)){console.log("do not recognise key: ",i);return}for(const s of Yt(e,i))t[s]=!0},n=({key:o})=>{const i=Kt(o);if(qt(i))for(const s of Yt(e,i))t[s]=!1};return window.addEventListener("keydown",r,!1),window.addEventListener("keyup",n,!1),()=>{console.log("removing listeners on keys"),window.removeEventListener("keydown",r,!1),window.removeEventListener("keyup",n,!1)}};function ai(e){return{all:e=e||new Map,on:function(t,r){var n=e.get(t);n?n.push(r):e.set(t,[r])},off:function(t,r){var n=e.get(t);n&&(r?n.splice(n.indexOf(r)>>>0,1):e.set(t,[]))},emit:function(t,r){var n=e.get(t);n&&n.slice().map(function(o){o(r)}),(n=e.get("*"))&&n.slice().map(function(o){o(t,r)})}}}const li=[...Ot,"jump","fire","carry","swop","pause"],ci=()=>hr(li.map(e=>[e,!1])),ui=e=>{const t={};for(const r of Object.values(e.rooms))for(const n of Object.values(r.items))if(n.type==="player"){const{which:o}=n.config;t[o]=r.id}if(t.head===void 0&&t.heels===void 0)throw new Error("couldn't find either head or heels in campaign");return t},di=(e,t)=>{const r=ui(e),n=hr(Object.keys(e.rooms).map(s=>[s,{}])),o=r.head&&Ze(e.rooms[r.head],n),i=r.heels&&Ze(e.rooms[r.heels],n);return{keyAssignment:ii,currentCharacterName:r.head===void 0?"heels":"head",characterRooms:{head:o===void 0?void 0:{room:o,entryState:bt(o.items.head)},heels:i===void 0?void 0:{room:i,entryState:bt(i.items.heels)}},inputState:ci(),renderOptions:t,campaign:e,events:ai(),pickupsCollected:n,gameTime:0}},he=(e,{x:t,y:r},n)=>{function*o(){yield[`${e}.left`,{frame:{x:t,y:r,...n}}],yield[`${e}.away`,{frame:{x:t+n.w+2,y:r,...n}}],yield[`${e}.towards`,{frame:{x:t,y:r+n.h+2,...n}}],yield[`${e}.right`,{frame:{x:t+n.w+2,y:r+n.h+2,...n}}]}return Object.fromEntries(o())},k=(e,t,{x:r,y:n},o)=>{function*i(){for(let s=0;s<t;s++)yield[`${e}.${s+1}`,{frame:{x:r+s*(o.w+1),y:n,...o}}]}return Object.fromEntries(i())},Be={w:32,h:16},H={w:16,h:55},J={w:24,h:56},L={w:32,h:28},p={w:24,h:24};function Zt(e){function*t(r,n){yield`${r}.walking.${n}.1`,yield`${r}.walking.${n}.2`,yield`${r}.walking.${n}.3`,yield`${r}.walking.${n}.2`}return Ot.reduce((r,n)=>({...r,[`${e}.walking.${n}`]:[...t(e,n)]}),{})}const hi={...k("head.walking.towards",3,{x:4,y:266},p),...k("head.walking.right",3,{x:80,y:266},p),...k("head.walking.left",3,{x:4,y:240},p),...k("head.walking.away",3,{x:80,y:240},p),"head.blinking.towards":{frame:{x:54,y:291,...p}},"head.blinking.right":{frame:{x:130,y:291,...p}},...k("head.idle.right",2,{x:4,y:329},p),"head.falling.towards":{frame:{x:29,y:291,...p}},"head.falling.right":{frame:{x:105,y:291,...p}},...k("bubbles.head",6,{x:4,y:215},p),...k("heels.walking.towards",3,{x:159,y:266},p),...k("heels.walking.right",3,{x:235,y:266},p),...k("heels.walking.left",3,{x:159,y:240},p),...k("heels.walking.away",3,{x:235,y:240},p),...k("bubbles.heels",6,{x:159,y:215},p)},fi=5e3,Jt=Math.round(fi/(je*4))-3,nn={frames:hi,animations:{...Zt("head"),...Zt("heels"),"head.idle.right":[...new Array(Jt).fill("head.walking.right.3"),"head.blinking.right","head.walking.right.3","head.blinking.right"],"head.idle.towards":[...new Array(Jt).fill("head.walking.towards.3"),"head.blinking.towards","head.walking.towards.3","head.blinking.towards"],"head.fadeOut":["bubbles.head.1","bubbles.head.2","bubbles.head.4","bubbles.head.3","bubbles.head.4","bubbles.head.6","bubbles.head.5","bubbles.head.6","bubbles.head.5"],"heels.fadeOut":["bubbles.heels.1","bubbles.heels.2","bubbles.heels.4","bubbles.heels.3","bubbles.heels.4","bubbles.heels.6","bubbles.heels.5","bubbles.heels.6","bubbles.heels.5"]}},Q=(e,t,r)=>{function*n(o,i,s){const{walls:a}=Pn[o],{w:c,h}=H,f=c>>1,_=a.length;let y=0;for(;y<a.length;y++)yield[`${o}.wall.${a[y]}.left`,{frame:{x:i+c*y,y:s-f*y,...H}}],yield[`${o}.wall.${a[y]}.away`,{frame:{x:i+c*((_<<1)-y-1),y:s-f*y,...H}}];const b=y-1;yield[`${o}.floor`,{frame:{x:i+b*c,y:s-b*f+h+1,...Be}}]}return Object.fromEntries(n(e,t,r))},pi={...Q("blacktooth",487,335),...Q("bookworld",356,23),...Q("egyptus",435,23),...Q("jail",455,351),...Q("market",378,244),...Q("moonbase",384,141),...Q("penitentiary",513,23),...Q("safari",482,244)},yi={frames:pi,animations:{}};let wt;try{wt=await Sn.load(En)}catch{wt=be.EMPTY}const gi={"generic.edge.right":{frame:{x:536,y:392,w:8,h:9}},"generic.edge.towards":{frame:{x:527,y:392,w:8,h:9}},"generic.wall.overdraw":{frame:{x:210,y:37,w:H.w,h:Be.h*2}},"generic.wall.overdraw.debug":{frame:{x:210,y:4,w:H.w,h:Be.h*2}},"generic.floor.deadly":{frame:{x:422,y:407,...Be}},"generic.door.legs.base":{frame:{x:314,y:60,w:H.w,h:9}},"generic.door.legs.pillar":{frame:{x:314,y:48,w:H.w,h:12}},"generic.door.front.y":{frame:{x:227,y:13,...J}},"generic.door.back.y":{frame:{x:243,y:5,...J}},"generic.door.legs.threshold.y":{frame:{x:331,y:30,w:H.w,h:18}},"generic.door.threshold.x":{frame:{x:270,y:70,w:26,h:19}},"generic.door.threshold.y":{frame:{x:241,y:70,w:26,h:19}},"generic.door.platform.towards":{frame:{x:270,y:144,w:32,h:32}},"generic.door.front.x":{frame:{x:286,y:13,...J}},"generic.door.back.x":{frame:{x:270,y:5,...J}},"generic.door.legs.threshold.x":{frame:{x:314,y:30,w:H.w,h:18}},"generic.door.platform.left":{frame:{x:235,y:114,w:32,h:28}},"moonbase.door.front.y":{frame:{x:344,y:161,...J}},"moonbase.door.back.y":{frame:{x:360,y:153,...J}},"moonbase.door.front.x":{frame:{x:528,y:161,...J}},"moonbase.door.back.x":{frame:{x:512,y:153,...J}},teleporter:{frame:{x:2,y:478,...L}},...k("teleporter.flashing",2,{x:35,y:478},L),"barrier.x":{frame:{x:27,y:349,w:24,h:24}},"barrier.y":{frame:{x:2,y:349,w:24,h:24}},"block.organic":{frame:{x:160,y:449,...L}},"block.organic.weak":{frame:{x:160,y:420,...L}},"block.artificial":{frame:{x:127,y:449,...L}},"block.tower":{frame:{x:27,y:374,...p}},volcano:{frame:{x:193,y:420,...L}},toaster:{frame:{x:101,y:479,...L}},spikes:{frame:{x:379,y:414,...L}},"conveyor.x":{frame:{x:35,y:399,...L}},"conveyor.y":{frame:{x:68,y:399,...L}},bunny:{frame:{x:263,y:333,...p}},donuts:{frame:{x:263,y:308,...p}},crown:{frame:{x:367,y:358,...p}},hooter:{frame:{x:286,y:358,...p}},bag:{frame:{x:263,y:358,...p}},...k("fish",2,{x:238,y:383},p),"spring.compressed":{frame:{x:2,y:453,...p}},"spring.released":{frame:{x:27,y:453,...p}},...k("lift",4,{x:259,y:474},p),"lift.static":{frame:{x:359,y:474,...p}},...k("dalek",2,{x:4,y:4},p),"headless-base":{frame:{x:57,y:4,...p}},joystick:{frame:{x:2,y:374,...p}},anvil:{frame:{x:134,y:478,...L}},"book.x":{frame:{x:184,y:450,...L}},"book.y":{frame:{x:222,y:450,...L}},sandwich:{frame:{x:4,y:356,...L}},sticks:{frame:{x:4,y:391,...p}},cube:{frame:{x:27,y:428,...p}},drum:{frame:{x:52,y:428,...p}},"switch.off":{frame:{x:52,y:453,...p}},"switch.on":{frame:{x:77,y:453,...p}},...he("american-football-head",{x:4,y:34},{w:24,h:32}),...he("charles",{x:118,y:34},p),...he("cyberman",{x:61,y:34},p),...he("monkey",{x:118,y:90},p),...he("elephant",{x:118,y:146},p),...he("computer-bot",{x:173,y:146},p),...k("bubbles",3,{x:4,y:107},p),...k("bubbles.cold",2,{x:109,y:4},p),...k("bubbles.pickup",3,{x:288,y:333},p),...k("turtle.left",2,{x:4,y:137},p),...k("turtle.away",2,{x:55,y:137},p),...k("turtle.towards",2,{x:4,y:163},p),...k("turtle.right",2,{x:55,y:163},p),...k("helicopter-bug",4,{x:4,y:188},p),"hush-puppy":{frame:{x:163,y:300,...L}},ball:{frame:{x:84,y:4,...p}},puck:{frame:{x:111,y:367,...p}},"puck.deadly":{frame:{x:111,y:392,...p}},...nn.frames,...yi.frames},mi={frames:gi,animations:{"teleporter.flashing":["teleporter.flashing.1","teleporter.flashing.2"],fish:["fish.1","fish.2"],lift:["lift.1","lift.2","lift.3","lift.4"],dalek:["dalek.1","dalek.2"],"turtle.left":["turtle.left.1","turtle.left.2"],"turtle.away":["turtle.away.1","turtle.away.2"],"turtle.towards":["turtle.towards.1","turtle.towards.2"],"turtle.right":["turtle.right.1","turtle.right.2"],"helicopter-bug":["helicopter-bug.1","helicopter-bug.2","helicopter-bug.3","helicopter-bug.4"],bubbles:["bubbles.1","bubbles.2"],"bubbles.cold":["bubbles.cold.1","bubbles.cold.2"],"bubbles.pickup":["bubbles.pickup.1","bubbles.pickup.2","bubbles.pickup.3"],"spring.bounce":["spring.released","spring.compressed","spring.released","spring.compressed","spring.released"],...nn.animations},meta:{scale:1}},$=new Rn(wt,mi);await $.parse();$.textureSource.scaleMode="nearest";const on=.5,xi=1e3/25,sn=(e,t=on)=>e*xi/t;sn($.animations["bubbles.pickup"].length);const Je=sn($.animations["head.fadeOut"].length),bi={x:.5,y:1},wi=e=>typeof e!="string"&&Object.hasOwn(e,"frames"),m=e=>{if(typeof e=="string")return m({texture:e});{const{anchor:t,flipX:r,pivot:n,x:o,y:i}=e;let s;return wi(e)?s=vi(e):s=new kt($.textures[e.texture]),t===void 0&&n===void 0?s.anchor=bi:(t!==void 0&&(s.anchor=t),n!==void 0&&(s.pivot=n)),o!==void 0&&(s.x=o),i!==void 0&&(s.y=i),s.eventMode="static",r===!0&&(s.scale.x=-1),s}};function vi(e){const t=new Ve(e.frames.map(r=>({texture:r,time:fr})));return t.animationSpeed=e.animationSpeed||on,t.play(),e.playOnce!==void 0&&(t.loop=!1,t.onComplete=()=>{t.stop(),e.playOnce==="and-destroy"&&t.destroy()}),t}const _i=(e,t,r)=>`${e}.wall.${t}.${r}`,Ci=(e,t,r)=>{const n=$.textures[`${e.planet}.door.front.${t}`]!==void 0;return r=="near"?n?`${e.planet}.door.front.${t}`:`generic.door.front.${t}`:n?`${e.planet}.door.back.${t}`:`generic.door.back.${t}`},an=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,ki=`in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uOriginalColor;
uniform vec3 uTargetColor;
uniform float uTolerance;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);
    vec3 colorDiff = uOriginalColor - (c.rgb / max(c.a, 0.0000000001));
    float colorDistance = length(colorDiff);
    float doReplace = step(colorDistance, uTolerance);
    finalColor = vec4(mix(c.rgb, uTargetColor * c.a, doReplace), c.a);
}
`;class Qe extends yr{static DEFAULT_OPTIONS={originalColor:16711680,targetColor:0,tolerance:.4};uniforms;_originalColor;_targetColor;constructor(t){t={...Qe.DEFAULT_OPTIONS,...t};const r=_t.from({vertex:an,fragment:ki,name:"palette-swap-filter"});super({glProgram:r,resources:{colorReplaceUniforms:{uOriginalColor:{value:new Float32Array(3),type:"vec3<f32>"},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"},uTolerance:{value:t.tolerance,type:"f32"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this._originalColor=new F,this._targetColor=new F,this.originalColor=t.originalColor??16711680,this.targetColor=t.targetColor??0,Object.assign(this,t)}get originalColor(){return this._originalColor.value}set originalColor(t){this._originalColor.setValue(t);const[r,n,o]=this._originalColor.toArray();this.uniforms.uOriginalColor[0]=r,this.uniforms.uOriginalColor[1]=n,this.uniforms.uOriginalColor[2]=o}get targetColor(){return this._targetColor.value}set targetColor(t){this._targetColor.setValue(t);const[r,n,o]=this._targetColor.toArray();this.uniforms.uTargetColor[0]=r,this.uniforms.uTargetColor[1]=n,this.uniforms.uTargetColor[2]=o}get tolerance(){return this.uniforms.uTolerance}set tolerance(t){this.uniforms.uTolerance=t}}const oe={original:new F("rgb(255, 255, 255)"),basic:new F("rgb(210, 210, 210)"),dimmed:new F("rgb(120, 120, 120)")},ee={original:new F("rgb(255, 255, 0)"),basic:new F("hsl(50,58%,70%)"),dimmed:te().redShadow},fe={original:new F("rgb(255, 0, 255)"),basic:te().pink,dimmed:new F("hsl(290,25%,40%)")},Y={original:new F("rgb(0, 255, 255)"),basic:new F("hsl(183, 28%, 50%)"),dimmed:te().shadow},pe={original:new F("rgb(0, 255, 0)"),basic:te().moss,dimmed:new F("hsl(73,35%,30%)")},Ti={white:oe,yellow:ee,magenta:fe,cyan:Y,green:pe},Dt={white:{main:oe,edges:{towards:Y,right:ee},hud:{lives:ee,dimmed:fe,icons:Y}},yellow:{main:ee,edges:{towards:pe,right:oe},hud:{lives:Y,dimmed:fe,icons:pe}},magenta:{main:fe,edges:{towards:pe,right:Y},hud:{lives:oe,dimmed:Y,icons:ee}},cyan:{main:Y,edges:{towards:fe,right:oe},hud:{lives:oe,dimmed:pe,icons:ee}},green:{main:pe,edges:{towards:Y,right:ee},hud:{lives:oe,dimmed:fe,icons:Y}}},ln=e=>[new Qe({originalColor:te().replaceLight,targetColor:e.basic,tolerance:.1}),new Qe({originalColor:te().replaceDark,targetColor:e.dimmed,tolerance:.1})],vt=(e,t)=>ln(Dt[e.color].edges[t]),Oi=e=>ln(Dt[e.color].main),Ai=[];function cn(e,t){const r=t||new R;for(const n of e)r.addChild(n);return r}function*zi({config:{direction:e,inHiddenWall:t,height:r}},n){const o=le(e),i=o==="y"?0:16;function*s(a){if(t){if(r!==0){const h=m({pivot:{x:o==="x"?18:8,y:12},texture:`generic.door.threshold.${o}`,...Ne(a,{y:-C.h*r})});h.filters=vt(n,o==="x"?"towards":"right"),yield h}}else{yield m({pivot:{x:i,y:12},texture:"generic.door.legs.base",...Ne(a,{y:r})});for(let c=1;c<r;c++)yield m({pivot:{x:i,y:9},texture:"generic.door.legs.pillar",...Ne(a,{y:-c*C.h})});yield m({pivot:{x:i,y:C.h*r+15},texture:`generic.door.legs.threshold.${o}`,...a})}}yield*s(K({...Vt,[o]:1})),yield*s(Vt)}const $i=(e,t)=>cn(zi(e,U(t)));function*Pi({config:{direction:e,inHiddenWall:t,nearness:r},state:{position:n}},o){const i=le(e),{z:s}=n;if(!t&&s===0){const a=K({[At(i)]:.5});r==="far"&&(yield m({anchor:{x:0,y:1},flipX:i==="x",texture:"generic.wall.overdraw",...a}))}yield m({texture:Ci(o,i,r),pivot:to[r][i]})}const Si=(e,t)=>cn(Pi(e,U(t))),Qt=({type:e,state:{action:t,facing:r,teleporting:n}})=>{if(t==="death")return m({frames:$.animations[`${e}.fadeOut`]});if(n!==null){if(n.phase==="out")return m({frames:$.animations[`${e}.fadeOut`]});if(n.phase==="in")return m({frames:$.animations[`${e}.fadeOut`].toReversed()})}return m(t==="moving"?{frames:$.animations[`${e}.walking.${r}`]}:t==="falling"&&e==="head"&&(r==="towards"||r==="right")?`head.falling.${r}`:e==="head"&&(r==="towards"||r==="right")?{frames:$.animations[`head.idle.${r}`]}:`${e}.walking.${r}.2`)},ht={frames:$.animations["bubbles.cold"],animationSpeed:.25},xe=(e,t="headless-base")=>{const r=new R;r.addChild(m(t));const n=m(e);return n.y=-12,r.addChild(n),r},Ei={head:Qt,heels:Qt,doorFrame:Si,doorLegs:$i,portal(){throw new Error("these should always be non-rendering")},wall({config:{side:e,style:t}},r){return e==="right"||e==="towards"?new R:m({texture:_i(U(r).planet,t,e),anchor:e==="away"?{x:1,y:1}:{x:0,y:1}})},barrier:({config:{axis:e}})=>m({texture:`barrier.${e}`,pivot:ro[e]}),"deadly-block":({config:{style:e}})=>m(e==="puck"?"puck.deadly":e),block:({config:{style:e}})=>m(`block.${e}`),conveyor:({config:{direction:e}})=>m(e==="left"||e==="right"?"conveyor.x":"conveyor.y"),fish:({config:{alive:e}})=>m(e?{frames:$.animations.fish,animationSpeed:.25}:{texture:"fish.1"}),lift(){const e=new R;return e.addChild(m({frames:$.animations.lift})),e.addChild(m("lift.static")),e},spring:(e,t)=>!e.state.stoodOn&&e.lastRenderedState?.stoodOn?m({frames:$.animations["spring.bounce"],playOnce:"and-stop"}):e.state.stoodOn?m("spring.compressed"):m("spring.released"),teleporter:e=>e.state.stoodOn?m({frames:$.animations["teleporter.flashing"]}):m("teleporter"),pickup({id:e,config:{gives:t}},r){const n=U(r).id;return Tt(r,n,e)?m({frames:$.animations["bubbles.pickup"],playOnce:"and-destroy"}):m({shield:"bunny",jumps:"bunny",fast:"bunny","extra-life":"bunny",bag:"bag",donuts:"donuts",hooter:"hooter",crown:"crown"}[t])},sceneryPlayer:({config:{which:e}})=>m(`${e}.walking.towards.2`),baddie({config:e}){switch(e.which){case"helicopter-bug":case"dalek":return m({frames:$.animations[e.which],animationSpeed:.5});case"headless-base":return m({texture:"headless-base"});case"american-football-head":return m({texture:`american-football-head.${e.startDirection}`});case"turtle":return m({frames:$.animations[`turtle.${e.startDirection}`],animationSpeed:.25});case"cyberman":return e.charging?m(`cyberman.${e.startDirection}`):xe("cyberman.towards",ht);case"bubble-robot":return xe(ht);case"flying-ball":return xe("ball",ht);case"computer-bot":case"elephant":case"monkey":return xe(`${e.which}.towards`);case"elephant-head":return m("elephant.right");default:throw new Error(`unexpected baddie ${e}`)}},joystick:()=>m("joystick"),"movable-block":({config:{style:e}})=>m(e),book:({config:{slider:e}})=>m(`book.${e?"y":"x"}`),"portable-block":({config:{style:e}})=>m(e),charles:()=>xe("charles.towards"),switch:()=>m("switch.off"),"hush-puppy":()=>m("hush-puppy"),ball:()=>m("ball"),floor(){throw new Error("floor should not be rendered as an item")}},un=(e,t)=>{Fn(e);const r=Ei[e.type];if(r===void 0)throw new Error(`item type "${e.type}" has no appearance - if it doesn't render, give it the .renders = false`);e.renderContainer.children.forEach(o=>o.destroy({children:!0,context:!0})),e.renderContainer.removeChildren();const n=r(e,t);e.renderContainer.addChild(n)},dn=e=>{In(e);const{state:{position:t},positionContainer:r}=e,n=T(t);r.x=n.x,r.y=n.y},Ri=(e,t)=>{if(e.renders===!1||t.renders===!1)return 0;const r=e.renderAabb||e.aabb,n=t.renderAabb||t.aabb,o=T(e.state.position),i=o.x-r.x,s=o.x+r.y,a=T(t.state.position),c=a.x-n.x,h=a.x+n.y;if(i>=h||c>=s)return 0;const f=T(P(e.state.position,r)).y,_=T(P(t.state.position,n)).y;if(o.y<=_||a.y<=f)return 0;for(const y of kr){const b=e.state.position[y],v=b+r[y],O=t.state.position[y],E=O+n[y];if(v<=O)return 1*(y==="z"?-1:1);if(b>=E)return-1*(y==="z"?-1:1)}return er(t)-er(e)},er=e=>e.state.position.x+e.state.position.y-e.state.position.z;var Bt={exports:{}};Bt.exports=function(e){return hn(Fi(e),e)};Bt.exports.array=hn;function hn(e,t){var r=e.length,n=new Array(r),o={},i=r,s=Ii(t),a=Mi(e);for(t.forEach(function(h){if(!a.has(h[0])||!a.has(h[1]))throw new Error("Unknown node. There is an unknown node in the supplied edges.")});i--;)o[i]||c(e[i],i,new Set);return n;function c(h,f,_){if(_.has(h)){var y;try{y=", node was:"+JSON.stringify(h)}catch{y=""}throw new Error("Cyclic dependency"+y)}if(!a.has(h))throw new Error("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(h));if(!o[f]){o[f]=!0;var b=s.get(h)||new Set;if(b=Array.from(b),f=b.length){_.add(h);do{var v=b[--f];c(v,a.get(v),_)}while(f);_.delete(h)}n[--r]=h}}}function Fi(e){for(var t=new Set,r=0,n=e.length;r<n;r++){var o=e[r];t.add(o[0]),t.add(o[1])}return Array.from(t)}function Ii(e){for(var t=new Map,r=0,n=e.length;r<n;r++){var o=e[r];t.has(o[0])||t.set(o[0],new Set),t.has(o[1])||t.set(o[1],new Set),t.get(o[0]).add(o[1])}return t}function Mi(e){for(var t=new Map,r=0,n=e.length;r<n;r++)t.set(e[r],r);return t}var Li=Bt.exports;const Ni=ur(Li),fn=e=>{const t=[];for(const n of e)if(n.renders)for(const o of e){if(n===o)break;if(!o.renders)continue;const i=Ri(n,o);i!==0&&(i>0?t.push([o,n]):t.push([n,o]))}let r;try{r=Ni(t)}catch(n){throw new Error(`found a cyclic dependency in the draw order pairs are:
	${t.map(([o,i])=>`${o.id} is behind ${i.id}`).join(`
	`)}`,n)}for(let n=0;n<r.length;n++)r[n].positionContainer.zIndex=n},pn=e=>{const t={},r=Object.values(e.items).filter(se("doorFrame"));for(const{config:{direction:n},state:{position:{x:o,y:i}}}of r)le(n)==="x"?i<0?t.towards=!0:i===e.size.y*C.d&&(t.away=!0):o<0?t.right=!0:o===e.size.x*C.w&&(t.left=!0);return t},yn=e=>{const t=pn(e),r=t.right?-.5:0,n=e.size.x+(t.left?.5:0),o=t.towards?-.5:0,i=e.size.y+(t.away?.5:0),s=K({x:r,y:i}),a=K({x:n,y:o}),c=K({x:r,y:o}),h=K({x:n,y:i}),f=h.y+H.h;return{blockXMin:r,blockXMax:n,blockYMin:o,blockYMax:i,rightSide:s,leftSide:a,frontSide:c,backSide:h,top:f}},Di=e=>{const{towards:t,right:r}=pn(e),{blockXMin:n,blockYMin:o,rightSide:i,leftSide:s,frontSide:a,backSide:c}=yn(e),{floor:h}=e,f=new R,_=Object.fromEntries(e.floorSkip.map(({x:A,y:B})=>[`${A},${B}`,!0]));if(h!=="none"){const A=h==="deadly"?"generic.floor.deadly":`${h}.floor`,B=new R;for(let G=-1;G<=e.size.x;G++)for(let V=G%2-1;V<=e.size.y;V+=2)_[`${G},${V}`]||B.addChild(ut({x:G,y:V},m({anchor:{x:.5,y:1},texture:A})));const S=new Ge().poly([a,i,c,s],!0).fill(16711680).stroke({width:8});B.addChild(S),B.mask=S,f.addChild(B)}const y=new R;for(let A=n;A<=e.size.x;A+=.5)y.addChild(ut({x:A,y:t?-.5:0},m({pivot:{x:7,y:1},texture:"generic.edge.towards"})));y.filters=vt(e,"towards");const b=new R;for(let A=o;A<=e.size.y;A+=.5)b.addChild(ut({x:r?-.5:0,y:A},m({pivot:{x:0,y:1},texture:"generic.edge.right"})));b.filters=vt(e,"right");const v=K({x:0,y:e.size.y}),O=K({x:e.size.x,y:0}),E=new Ge().poly([{x:a.x,y:a.y+16},{x:v.x,y:v.y+16},{x:v.x,y:-999},{x:O.x,y:-999},{x:O.x,y:O.y+16}],!0).fill(16776960);return f.addChild(E),f.addChild(y),f.addChild(b),f.mask=E,f},tr=(e,t)=>new Ge().poly([T({}),T({x:e.x}),T({x:e.x,y:e.y}),T({y:e.y})]).poly([T({}),T({z:e.z}),T({y:e.y,z:e.z}),T({y:e.y})]).poly([T({x:e.x}),T({x:e.x,z:e.z}),T(e),T({x:e.x,y:e.y})]).poly([T({z:e.z}),T({x:e.x,z:e.z}),T({x:e.x,y:e.y,z:e.z}),T({y:e.y,z:e.z})]).stroke({width:.5,color:t}),Bi={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)"},Wi=e=>{const t=Bi[e.type]??"rgba(255,255,255)",r=new R;return r.addChild(new Ge().circle(0,0,2).fill(t)),r.addChild(tr(e.aabb,t)),e.renderAabb&&r.addChild(tr(e.renderAabb,"rgba(184, 184, 255)")),r},Ui=e=>{const t=new R;return e.renderContainer!==void 0&&t.addChild(e.renderContainer),t.addChild(Wi(e)),t},ji=`precision mediump float;
in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uSourceBlacks[2];
uniform vec3 uTargetColor;

// colours are floats so check if they're very close rather than exactly equal:
bool colorsEffectivelyEqual(vec3 color1, vec3 color2) {    
    
    return distance(color1, color2) < 0.05;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    if( c.a == 0.0 ) {
        finalColor = c;
        return;
    }

    if ( colorsEffectivelyEqual(c.rgb, uSourceBlacks[0]) || colorsEffectivelyEqual(c.rgb, uSourceBlacks[1])) {
        finalColor = vec4(0,0,0, 1.0);
    } else {
        finalColor = vec4(uTargetColor, 1);    
    }
}
`,rr=[te().pureBlack,te().lightBlack];class gn extends yr{uniforms;constructor(t=ee.basic){const r=_t.from({vertex:an,fragment:ji,name:"revert-colourise-filter"});super({glProgram:r,resources:{colorReplaceUniforms:{uSourceBlacks:{value:new Float32Array(6),type:"vec3<f32>",size:6},uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms;const[n,o,i]=rr[0].toArray();this.uniforms.uSourceBlacks[0]=n,this.uniforms.uSourceBlacks[1]=o,this.uniforms.uSourceBlacks[2]=i;const[s,a,c]=rr[1].toArray();this.uniforms.uSourceBlacks[3]=s,this.uniforms.uSourceBlacks[4]=a,this.uniforms.uSourceBlacks[5]=c,this.targetColor=t}set targetColor(t){const[r,n,o]=new F(t).toArray();this.uniforms.uTargetColor[0]=r,this.uniforms.uTargetColor[1]=n,this.uniforms.uTargetColor[2]=o}}const Gi=(e,t)=>{const{leftSide:r,rightSide:n,frontSide:o,top:i}=yn(e),s=(n.x+r.x)/2,a=(i+o.y)/2;t.x=-s,t.y=-a},Vi=(e,t,r)=>{e.renderContainer!==void 0&&(t.onItemClick&&e.renderContainer!==void 0&&(e.renderContainer.eventMode="static",e.renderContainer.on("pointertap",()=>{t.onItemClick(e)})),e.renderContainer.on("pointerenter",()=>{e.renderContainer.filters=new gn(Ti[r.color].original)}),e.renderContainer.on("pointerleave",()=>{e.renderContainer.filters=[]}))},Hi=(e,t)=>{const r=U(e),n=new R;n.addChild(Di(r));const o=new R;for(const i of I(r.items)){const{renders:s}=i;if(s){const c=new R;i.renderContainer=c,un(i,e)}const a=t.showBoundingBoxes==="all"||t.showBoundingBoxes==="non-wall"&&i.type!=="wall";i.positionContainer=a?Ui(i):i.renderContainer,t.showBoundingBoxes!=="none"&&i.renderContainer!==void 0&&(i.renderContainer.alpha=.25),Vi(i,t,r),i.positionContainer!==void 0&&(dn(i),o.addChild(i.positionContainer))}return fn(I(r.items)),n.addChild(o),n.filters=Oi(r),Gi(r,n),n},Xi=e=>{let t=1;return{get curUpscale(){return t},rescale(){if(e.renderer.width===0||e.renderer.height===0)return;const r=Math.floor(Math.min(e.renderer.width/ae.width,e.renderer.height/ae.height));t!==r&&(t=r,console.log("scale factor changed to:",r),e.stage.scale=r)}}},nr=8,mn=e=>e==="heels"?1:-1,or=(e,t)=>{const n=new Xn({style:{fill:"white",fontFamily:"Head over Heels",fontSize:nr},resolution:8,x:(ae.width>>1)+mn(e)*24,y:ae.height-nr*2});return n.scale={x:1,y:2},n},ir=e=>{const t=new kt($.textures[`${e}.walking.${e==="head"?"right":"towards"}.2`]);return t.x=(ae.width>>1)+mn(e)*64+(e==="heels"?-p.w:0),t.y=ae.height-p.h,t},qi=e=>{const t={head:{sprite:ir("head"),livesText:or("head")},heels:{sprite:ir("heels"),livesText:or("heels")}};e.addChild(t.head.livesText),e.addChild(t.head.sprite),e.addChild(t.heels.livesText),e.addChild(t.heels.sprite);const r=new gn;return n=>{const o=U(n),{hud:{dimmed:i,lives:s}}=Dt[o.color];for(const a of ni){const c=n.currentCharacterName===a,h=Yn(n,a);r.targetColor=i.dimmed,t[a].livesText.style.fill=s.basic,t[a].livesText.text=`${h?.state.lives??0}`,t[a].sprite.filters=c?Ai:r}}},Yi=(e,t,r)=>{const{state:{velZ:n}}=e,o=io[e.type==="head"?"head":"others"],i=Math.max(n-Or*r,o);return{positionDelta:{x:0,y:0,z:i*r},stateDelta:{velZ:i}}},Le=e=>{const r=e/oo*fr;return{velZ:(e+.5*Or*r**2)/r,tApex:r}},Ki={head:Le(Re.head),headOnSpring:Le(Re.head+C.h),heels:Le(Re.heels),heelsOnSpring:Le(Re.heels+C.h)},Zi=(e,t)=>Ki[`${e}${t?"OnSpring":""}`],Ji=(e,{inputState:{jump:t}},r)=>{const{type:n}=e;if(!t||e.state.standingOn===null||e.state.standingOn?.type==="teleporter")return{};const{velZ:o}=Zi(n,e.state.standingOn?.type==="spring");return{stateDelta:{action:"moving",standingOn:null,velZ:o}}};function Qi(e,t,r){return{stateDelta:{stoodOn:r.items.head?.state.standingOn===e||r.items.heels?.state.standingOn===e}}}function es(e,t,r){return{stateDelta:{stoodOn:ce(I(r.items)).find(n=>Ae(n)&&n.state.standingOn===e)!==void 0}}}function ts(e,t,r){const{state:{teleporting:n}}=e,{inputState:{jump:o}}=t;if(n===null)return o&&e.state.standingOn?.type==="teleporter"?{stateDelta:{teleporting:{phase:"out",toRoom:e.state.standingOn.config.toRoom,timeRemaining:Je}}}:{};const i=Math.max(n.timeRemaining-r,0);switch(n.phase){case"out":if(i===0)return Nt(t,n.toRoom),{stateDelta:{teleporting:{phase:"in",timeRemaining:Je}}};break;case"in":if(i===0)return{stateDelta:{teleporting:null}};break}return{stateDelta:{teleporting:{...n,timeRemaining:i}}}}const xn={},rs=(e,{inputState:t},r)=>{const{type:n,state:{autoWalkDistance:o,standingOn:i,facing:s,teleporting:a}}=e,c=Ot.find(f=>t[f]===!0),h=Tr[n]*r;if(o>0)return{positionDelta:ye(we[s],h),stateDelta:{autoWalkDistance:Math.max(o-h,0)}};if(a!==null)return{};if(i===null)switch(n){case"head":{const _=e.state.velZ>0?"moving":"falling";return c===void 0?{stateDelta:{action:_}}:{positionDelta:ye(we[c],h),stateDelta:{facing:c,action:_}}}case"heels":return c===s?{positionDelta:ye(we[s],h*.6)}:xn}return c!==void 0?{positionDelta:ye(we[c],h),stateDelta:{facing:c,action:"moving"}}:{stateDelta:{action:"idle"}}},sr=(e,t,r)=>{const n=U(e).id;if(Tt(e,n,r.id))return;const o=e.pickupsCollected[n];switch(o[r.id]=!0,r.state.expires=e.gameTime+Je,r.config.gives){case"extra-life":t.state.lives+=2}},ns=(e,t,r)=>{Nt(e,r.config.toRoom,zt(t.state.position,r.config.relativePoint)),t.state.autoWalkDistance=C.w*.75},os=(e,t,r)=>{const n=U(r);return t.type!=="portal"&&!(t.type==="pickup"&&Tt(r,n.id,t.id))&&!(t.type==="pickup"&&ie(e))&&!(e.type==="pickup"&&ie(t))},is=.5,ar=(e,t,r,n)=>{const o=r.x+n.x-e.x,i=r.y+n.y-e.y,s=r.z+n.z-e.z,a=e.x+t.x-r.x,c=e.y+t.y-r.y,h=e.z+t.z-r.z,f=Math.abs(o)<Math.abs(a)?o:-a,_=Math.abs(i)<Math.abs(c)?i:-c,y=Math.abs(s)<Math.abs(h)?s:-h,b=Math.abs(y)*is;return Math.abs(f)<Math.abs(_)&&Math.abs(f)<b?{x:f,y:0,z:0}:Math.abs(_)<b?{x:0,y:_,z:0}:{x:0,y:0,z:y}},lr=(e,t)=>({x:e.x>0?t.state.position.x:t.state.position.x+t.aabb.x,y:e.y>0?t.state.position.y:t.state.position.y+t.aabb.y,z:e.z>0?t.state.position.z:t.state.position.z+t.aabb.z}),ss=(e,t)=>[...t].sort((r,n)=>{const o=Ht(e,lr(e,r)),i=Ht(e,lr(e,n));return o-i}),as=(e,t)=>{const r=ce(t).find(se("doorFrame"));if(r===void 0)return ge;const{config:{direction:n,nearness:o}}=r,i=le(n);return o==="far"?{x:i==="x"?-Math.abs(e.y):0,y:i==="y"?-Math.abs(e.x):0,z:0}:{x:i==="x"?Math.abs(e.y):0,y:i==="y"?Math.abs(e.x):0,z:0}},bn=(e,t,r,n)=>{const o=P(ge,t);if(He(o,ge))return;const i=U(r),{state:{position:s}}=e,a=P(s,o),c=$t({aabb:e.aabb,state:{position:a},id:e.id},I(i.items));if(ie(e)){const{portal:b=[],deadly:v=[],pickup:O=[]}=Object.groupBy(c,A=>{switch(A.type){case"baddie":case"deadly-block":return"deadly";case"floor":return A.config.deadly?"deadly":"other";case"portal":return"portal";case"pickup":return"pickup"}return"other"}),E=b.at(0);if(E!==void 0&&e.state.autoWalkDistance===0){ns(r,e,E);return}if(v?.length>0){e.state.action="death",e.state.expires=r.gameTime+Je;return}for(const A of O)sr(r,e,A)}if(se("pickup")(e)){const b=c.find(ie);b!==void 0&&sr(r,b,e)}const h=c.filter(b=>os(e,b,r));e.state.standingOn=h.find(b=>b===e.state.standingOn)||null;const f=ss(o,h),_=ce(f).reduce((b,v)=>{let O=ar(b,e.aabb,v.state.position,v.aabb);if(Ae(v)&&v!==n){const E=ye(O,-.5);bn(v,E,r,e),b=zt(b,E),O=ar(b,e.aabb,v.state.position,v.aabb)}return e.state.standingOn===null&&O.z>0&&(e.state.standingOn=v),P(b,O)},P(s,o)),y=ie(e)?P(_,as(o,h)):_;He(y,s)||(e.state.position=y)},ls=(e,t,r)=>{if(e.state.standingOn===null||e.state.standingOn.type!=="conveyor")return xn;const{config:{direction:n}}=e.state.standingOn,s=(se("heels")(e)&&e.state.action==="moving"&&e.state.facing===Zn(n)?Tr.heels:no)*r;return{positionDelta:ye(we[n],s)}},cs=(e,t,r)=>{const n=U(t);let o=ge;const i=Ae(e),s=({positionDelta:a,stateDelta:c})=>{a!==void 0&&(o=P(o,a)),c!==void 0&&(e.state={...e.state,...c})};ie(e)&&e.type===t.currentCharacterName&&(s(ts(e,t,r)),s(rs(e,t,r)),s(Ji(e,t))),i&&(s(Yi(e,t,r)),s(ls(e,t,r))),se("teleporter")(e)&&s(Qi(e,t,n)),se("spring")(e)&&s(es(e,t,n)),i&&bn(e,o,t)},us=e=>{e.currentCharacterName=Lt(e.currentCharacterName)},ds=e=>{const{currentCharacterName:t}=e,{room:r,entryState:n}=e.characterRooms[t],o=r.items[t],i=Lt(t),s=o.state,a=o.state.lives-1;if(a===0){o.state.lives=a,e.characterRooms[t]=void 0,e.currentCharacterName=i;return}const c=Ze(e.campaign.rooms[r.id],e.pickupsCollected);e.characterRooms[t].room=c,o.state={...s,...n,expires:null,lives:a},rn(o,c.items),c.items[t]=o},hs=2,fs=(e,t)=>e.state.expires!==null&&e.state.expires<t.gameTime,ps=(e,t)=>{t.positionContainer!==void 0&&t.positionContainer.destroy(),delete e.items[t.id];for(const r of ce(I(e.items)))Ae(r)&&r.state.standingOn===t&&(r.state.standingOn=null)},ys=e=>{for(const t of I(e.items)){const r=t.lastRenderedState.position,n=He(r,t.state.position),o=n&&!Qn(t.state.position);t.type==="heels"&&console.log(`item ${t.id} is stationary: ${n} and should snap to pixel grid: ${o}`),o&&(console.log(`snapping item ${t.id} to pixel grid`),t.state.position=eo(t.state.position))}},gs=(e,t)=>{const r=Math.ceil(t/hs),n=t/r,{inputState:o}=e;if(o.swop){us(e),o.swop=!1;return}const i=U(e);for(const s of I(i.items))s.lastRenderedState={...s.state};for(let s=0;s<r;s++){e.gameTime+=n;for(const a of I(i.items))if(fs(a,e))if(ie(a)){ds(e);return}else ps(i,a);for(const a of I(i.items)){if(qn(e).state.action==="death")break;cs(a,e,n)}}ys(i)},ms=e=>{if(e.lastRenderedState===void 0)return!0;switch(e.type){case"head":case"heels":return e.state.facing!==e.lastRenderedState.facing||e.state.action!==e.lastRenderedState.action||e.state.teleporting?.phase!==e.lastRenderedState.teleporting?.phase;case"teleporter":case"spring":return e.state.stoodOn!==e.lastRenderedState.stoodOn;case"pickup":return e.state.expires!==e.lastRenderedState.expires;default:return!1}},xs=(e,t,r,n)=>{const o=U(e);if(o!==t){console.log("will render from scratch",o.id,"since we currently have",t?.id),r.removeChildren(),r.label="world";const i=Hi(e,n);r.addChild(i)}else{let i=!1;for(const s of I(o.items))s.renders&&(ms(s)&&un(s,e),(s.lastRenderedState===void 0||!He(s.lastRenderedState.position,s.state.position))&&(dn(s),i=!0));i&&fn(I(o.items))}},bs=(e,t)=>{let r,n;const o=new R;o.label="world",o.y=ae.height*.7,e.stage.addChild(o);const i=new R;e.stage.addChild(i);const s=qi(i),a=Xi(e),c=({deltaMS:h})=>{a.rescale(),o.x=e.renderer.width/a.curUpscale/2;const{renderOptions:f}=t;n!==f&&(console.log(`render options changed!          
          renderOptions: ${n} -> ${f}`),r=void 0,n=f),gs(t,h),xs(t,r,o,f),s(t),r=U(t)};return{start(){return e.ticker.add(c),this},stop(){e.stage.removeChild(o),e.ticker.remove(c)}}},ws=async e=>{const t={showBoundingBoxes:"none"},r=new Cr;await r.init({background:"#000000",resizeTo:window});const n=di(e,t),o=si(n),i=bs(r,n).start();return{campaign:e,events:n.events,renderIn(s){s.appendChild(r.canvas)},changeRoom(s){Nt(n,s)},get currentRoom(){return U(n)},get gameState(){return n},set renderOptions(s){n.renderOptions=s},stop(){console.log("tearing down game"),r.canvas.parentNode?.removeChild(r.canvas),i.stop(),o(),r.destroy()}}},Cs=Object.freeze(Object.defineProperty({__proto__:null,gameMain:ws},Symbol.toStringTag,{value:"Module"}));export{br as A,gr as C,yr as F,Gn as R,Dn as S,wr as V,Cs as g,Nn as u};
