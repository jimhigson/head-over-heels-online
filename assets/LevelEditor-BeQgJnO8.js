import{j as e,r as x}from"./index-DMxw9keX.js";import{r as T,S as ee,aw as te,a7 as C,ax as se,B as f,C as oe,z as ge,f as ve,L as re,a8 as k,ay as M,a6 as F,az as je,aA as ne,P as D,aB as be,A as we,aC as ke,aD as Ce,Z as ae,aE as Ne,aF as A,c as Se,e as O,aG as Te,aH as Re,aI as Ie,R as ie,aJ as Pe,at as Be,aK as Ee,I as _,aL as $,ah as U,o as $e,aM as ze,am as Ae,aN as _e,aO as Le,aP as Me,aQ as He,aR as De}from"./App-DbJKx38b.js";import{B as le,g as Fe,h as Oe,i as Ue,j as ce,C as Ge,R as Je,S as Xe}from"./RoomSelect-CtEv9yqo.js";import{useAppSelectorWithLevelEditorSlice as j,changeGridResolution as Ze,selectTool as B,setTool as de,selectCurrentEditingRoomColour as We,changeRoomColour as G,selectCurrentEditingRoomScenery as Ke,changeRoomScenery as qe,selectCanUndo as Ve,selectCanRedo as Ye,undo as ue,redo as me,changeToRoom as Qe,selectCurrentEditingRoomJson as J,setSelectedItemInRoom as et,applyToolToRoomJson as tt,deleteSelected as st,selectSelectedJsonItemIds as ot}from"./levelEditorSlice-C7Ft4xna.js";import{c as rt,A as nt,s as at,a as it,R as lt,i as ct,z as dt,b as ut,p as pe}from"./stopAppAutoRendering-D96HnpT4.js";import"./Graphics-8-H4aqNN.js";import"./changeCharacterRoom-BVJq8aC4.js";const xe=t=>t,mt=()=>{const t=T();return e.jsx(ee,{className:"w-full",label:"res",value:j(s=>s.levelEditor.halfGridResolution),onClick:(s,o)=>{t(Ze(o))},falseLabel:"Blocks",trueLabel:"Halves"})},H="h-[calc(3*var(--block)-1px*var(--scale))] w-[calc(3*var(--block)-1px*var(--scale))]",E=({className:t,onClick:s,children:o,disabled:n=!1,isCurrentTool:a=!1})=>e.jsx(le,{disabled:n,"data-iscurrenttool":a,className:`active:pt-oneScaledPix ${H} gap-0 inline-flex overflow-hidden ${a?"bg-pastelBlue":""} ${n?"bg-midGrey text-lightGrey":""} ${t??""}`,onClick:s,children:o}),r=({itemTool:t,children:s,className:o})=>{const n=j(B),a=te(n?.type==="item"&&n.item,t);return e.jsx(E,{isCurrentTool:a,className:o,onClick:()=>C.dispatch(de({type:"item",item:t})),children:s})},R=({children:t})=>{const[s,o]=x.useState(!1),[n,a]=x.useState(0),l=t[n];return e.jsxs(Fe,{open:s,onOpenChange:o,children:[e.jsxs("div",{className:se(H,"relative",{"drop-shadow-oneBlock z-popups":s}),children:[l,e.jsx(Oe,{asChild:!0,children:e.jsx(le,{className:"absolute bottom-0 right-0 bg-metallicBlueHalfbrite",children:e.jsx(f,{className:"pl-oneScaledPix",children:s?"X":"â¬‡"})})})]}),e.jsx(Ue,{children:e.jsx(oe,{scaleFactor:2,children:e.jsx("div",{className:"flex flex-col gap-oneScaledPix py-oneScaledPix bg-metallicBlueHalfbrite",children:t.map((u,c)=>c===n?null:e.jsx("div",{className:H,onClick:()=>{a(c),o(!1)},children:u},c))})})})]})},pt=()=>{const s=j(B)?.type==="pointer";return e.jsx(E,{onClick:()=>C.dispatch(de({type:"pointer"})),isCurrentTool:s,children:e.jsx("span",{className:"sprite texture-hud.char.â†– relative"})})},X=t=>{const{main:s}=rt[t].basic;return{backgroundColor:s.basic.toHex(),borderColor:s.dimmed.toHex()}};function xt(){const t=T(),s=j(We);return e.jsxs(e.Fragment,{children:[e.jsx(ce,{value:s.hue,onSelect:o=>{t(G({hue:o}))},values:ge,disableCommandInput:!0,OptionCommandItem:({value:o,onSelect:n})=>e.jsx(Ge,{value:o,className:"border-l-3 h-2 w-full p-0",style:X(o),onSelect:n}),triggerButtonLabel:"colour",triggerButtonClassName:se("w-full",`${s.hue==="white"?"text-pureBlack":"text-white"}`),triggerButtonStyle:X(s.hue)}),e.jsx(ee,{className:"w-full",label:"shade",value:s.shade==="basic",onClick:(o,n)=>{t(G({shade:n?"basic":"dimmed"}))},falseLabel:"dim",trueLabel:"basic"})]})}function ht(){const t=T(),s=j(Ke);return e.jsx(ce,{value:s,onSelect:o=>{t(qe(o))},values:ve,disableCommandInput:!0,triggerButtonClassName:"w-full",triggerButtonLabel:s})}const Z="[button:not(:disabled):hover_&]:hidden mt-quarter",W="hidden [button:not(:disabled):hover_&]:inline mt-quarter",K="hidden [button:not(:disabled):hover_&]:inline",ft=()=>{const t=T(),s=j(Ve),o=j(Ye);return e.jsxs(e.Fragment,{children:[e.jsxs(E,{disabled:!s,className:"flex-col",onClick:()=>{t(ue())},children:[e.jsx(f,{className:Z,children:"â¬…"}),e.jsx(f,{className:W,children:"Un"}),e.jsx(f,{className:K,children:"do"})]}),e.jsxs(E,{disabled:!o,className:"flex-col",onClick:()=>{t(me())},children:[e.jsx(f,{className:Z,children:"âž¡"}),e.jsx(f,{className:W,children:"Re"}),e.jsx(f,{className:K,children:"do"})]})]})},i=xe("[button:not([data-iscurrenttool=true]):not(:hover)_&]:sprite-revert-to-two-tone"),v=xe("flex flex-wrap gap-oneScaledPix w-full"),w=({topClasses:t,bottomClasses:s="texture-headlessBase"})=>e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("span",{className:`sprite absolute top-[calc(9px*var(--scale))] left-0 ${s} ${i}`}),e.jsx("span",{className:`sprite absolute top-[calc(-3px*var(--scale))] left-0 ${t} ${i}`})]}),b=({iconClasses:t,text:s})=>e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("span",{className:`sprite absolute top-0 left-0 ${t} ${i}`}),e.jsx(f,{className:"bg-metallicBlueHalfbrite absolute top-0 right-0 pl-oneScaledPix block",children:s})]}),yt=()=>{const t=j(o=>o.levelEditor.campaignInProgress),s=T();return e.jsxs("div",{className:"flex fixed top-0 bottom-0 right-0 w-12 box-content text-white bg-metallicBlueHalfbrite p-half gap-1 flex-wrap justify-start overflow-auto",children:[e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Campaign"}),e.jsx(Je,{campaign:t,onRoomSelect:o=>{s(Qe(o))}})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Room"}),e.jsx(ht,{}),e.jsx(xt,{})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Edit"}),e.jsx(pt,{}),e.jsx(ft,{}),e.jsx(mt,{})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Monsters"}),e.jsx(r,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}},children:e.jsx("span",{className:`sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek" ${i}`})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"cyberman",activated:"on",movement:"towards-on-shortest-axis-xy4",startDirection:"towards"}},children:e.jsx(w,{topClasses:"texture-cyberman.towards [button:hover_&]:texture-cyberman.right",bottomClasses:"texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold"})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right ${i}`})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"helicopterBug",activated:"on",movement:"patrol-randomly-xy8"}},children:e.jsx("span",{className:`sprite texture-helicopterBug.1 [button:hover_&]:texture-animated-helicopterBug ${i}`})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right ${i}`})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"homingBot",activated:"on",movement:"towards-tripped-on-axis-xy4"}},children:e.jsx("span",{className:`sprite texture-headlessBase [button:hover_&]:texture-headlessBase.all ${i}`})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"computerBot",activated:"on",movement:"patrol-randomly-xy4-and-reverse"}},children:e.jsx(w,{topClasses:"texture-computerBot.towards [button:hover_&]:texture-computerBot.right"})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"monkey",activated:"on",movement:"patrol-randomly-xy4"}},children:e.jsx(w,{topClasses:"texture-monkey.towards [button:hover_&]:texture-monkey.right"})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"elephant",activated:"on",movement:"patrol-randomly-xy4"}},children:e.jsx(w,{topClasses:"texture-elephant.towards [button:hover_&]:texture-elephant.right"})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"turn-to-player",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-elephant.towards [button:hover_&]:texture-elephant.right ${i}`})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"emperorsGuardian",activated:"while-player-near",movement:"towards-analogue-unless-planet-crowns"}},className:"inline relative",children:e.jsx(w,{topClasses:"texture-ball",bottomClasses:"texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold"})}),e.jsx(r,{itemTool:{type:"monster",config:{which:"emperor",activated:"while-player-near",movement:"towards-analogue"}},children:e.jsx("span",{className:`sprite texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold ${i}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Blocks"}),e.jsx(r,{itemTool:{type:"block",config:{style:"artificial"}},children:e.jsx("span",{className:`sprite texture-block.artificial ${i}`})}),e.jsx(r,{itemTool:{type:"block",config:{style:"organic"}},children:e.jsx("span",{className:`sprite texture-block.organic ${i}`})}),e.jsx(r,{itemTool:{type:"block",config:{style:"tower"}},children:e.jsx("span",{className:`sprite texture-tower ${i}`})}),e.jsx(r,{itemTool:{type:"block",config:{style:"book"}},children:e.jsx("span",{className:`sprite texture-book.x ${i}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Pickups"}),e.jsxs(R,{children:[e.jsx(r,{itemTool:{type:"pickup",config:{gives:"extra-life"}},children:e.jsx(b,{iconClasses:"texture-whiteRabbit",text:"2"})}),e.jsx(r,{itemTool:{type:"pickup",config:{gives:"shield"}},children:e.jsx(b,{iconClasses:"texture-whiteRabbit",text:"ðŸ›¡"})}),e.jsx(r,{itemTool:{type:"pickup",config:{gives:"jumps"}},children:e.jsx(b,{iconClasses:"texture-whiteRabbit",text:"â™¨"})}),e.jsx(r,{itemTool:{type:"pickup",config:{gives:"fast"}},children:e.jsx(b,{iconClasses:"texture-whiteRabbit",text:"âš¡"})})]}),e.jsx(r,{itemTool:{type:"pickup",config:{gives:"bag"}},children:e.jsx("span",{className:`sprite texture-bag ${i}`})}),e.jsx(r,{itemTool:{type:"pickup",config:{gives:"hooter"}},children:e.jsx("span",{className:`sprite texture-hooter ${i}`})}),e.jsx(r,{itemTool:{type:"pickup",config:{gives:"doughnuts"}},children:e.jsx("span",{className:`sprite texture-doughnuts ${i}`})}),e.jsx(r,{itemTool:{type:"pickup",config:{gives:"crown",planet:"blacktooth"}},children:e.jsx("span",{className:`sprite texture-crown.blacktooth ${i}`})}),e.jsx(r,{itemTool:{type:"pickup",config:{gives:"scroll",page:"blacktooth"}},children:e.jsx("span",{className:`sprite texture-scroll ${i}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"misc."}),e.jsxs(r,{itemTool:{type:"lift",config:{top:11,bottom:0}},className:"inline relative",children:[e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.static ${i} [button:active_&]:top-oneScaledPix`}),e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.1 [button:hover_&]:texture-animated-lift ${i} [button:active_&]:top-oneScaledPix`})]}),e.jsxs(R,{children:[e.jsx(r,{itemTool:{type:"barrier",config:{axis:"x"}},children:e.jsx("span",{className:`sprite texture-barrier.x ${i}`})}),e.jsx(r,{itemTool:{type:"barrier",config:{axis:"y"}},children:e.jsx("span",{className:`sprite texture-barrier.y ${i}`})})]}),e.jsxs(R,{children:[e.jsx(r,{itemTool:{type:"conveyor",config:{direction:"away"}},children:e.jsx(b,{iconClasses:"texture-conveyor.y.1 [button:hover_&]:texture-animated-conveyor.y",text:"â†—"})}),e.jsx(r,{itemTool:{type:"conveyor",config:{direction:"towards"}},children:e.jsx(b,{iconClasses:"texture-conveyor.y.1 [button:hover_&]:texture-animated-reversed-conveyor.y",text:"â†™"})}),e.jsx(r,{itemTool:{type:"conveyor",config:{direction:"left"}},children:e.jsx(b,{iconClasses:"texture-conveyor.x.1 [button:hover_&]:texture-animated-conveyor.x",text:"â†–"})}),e.jsx(r,{itemTool:{type:"conveyor",config:{direction:"right"}},children:e.jsx(b,{iconClasses:"texture-conveyor.x.1 [button:hover_&]:texture-animated-reversed-conveyor.x",text:"â†˜"})})]}),e.jsx(r,{itemTool:{type:"teleporter",config:{toRoom:"(placeholder)",toPosition:re}},children:e.jsx("span",{className:`sprite texture-teleporter ${i}`})}),e.jsx(r,{itemTool:{type:"charles",config:k},children:e.jsx(w,{topClasses:"texture-charles.towards [button:hover_&]:texture-charles.right"})}),e.jsx(r,{itemTool:{type:"joystick",config:{controls:["(placeholder)"]}},children:e.jsx("span",{className:`sprite texture-joystick ${i}`})}),e.jsx(r,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:M}},children:e.jsx("span",{className:`sprite texture-switch.left [button:hover_&]:texture-switch.right ${i}`})}),e.jsx(r,{itemTool:{type:"ball",config:k},children:e.jsx("span",{className:`sprite texture-ball ${i}`})}),e.jsxs(R,{children:[e.jsx(r,{itemTool:{type:"portableBlock",config:{style:"cube"}},children:e.jsx("span",{className:`sprite texture-cube ${i}`})}),e.jsx(r,{itemTool:{type:"portableBlock",config:{style:"drum"}},children:e.jsx("span",{className:`sprite texture-drum ${i}`})}),e.jsx(r,{itemTool:{type:"portableBlock",config:{style:"sticks"}},children:e.jsx("span",{className:`sprite texture-sticks ${i}`})})]}),e.jsx(r,{itemTool:{type:"pushableBlock",config:{}},children:e.jsx("span",{className:`sprite texture-stepStool ${i}`})}),e.jsx(r,{itemTool:{type:"movingPlatform",config:{movement:"clockwise",activated:"on",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-sandwich ${i}`})}),e.jsx(r,{itemTool:{type:"spikes",config:k},children:e.jsx("span",{className:`sprite texture-spikes ${i}`})}),e.jsxs(R,{children:[e.jsx(r,{itemTool:{type:"deadlyBlock",config:{style:"volcano"}},children:e.jsx("span",{className:`sprite texture-volcano.1 [button:hover_&]:texture-animated-volcano ${i}`})}),e.jsx(r,{itemTool:{type:"deadlyBlock",config:{style:"toaster"}},children:e.jsx("span",{className:`sprite texture-toaster.off ${i}`})})]}),e.jsx(r,{itemTool:{type:"slidingBlock",config:{style:"puck"}},children:e.jsx("span",{className:`sprite texture-puck ${i}`})}),e.jsx(r,{itemTool:{type:"slidingDeadly",config:{style:"spikyBall",startingPhase:1}},children:e.jsx("span",{className:`sprite texture-spikyBall.1 [button:hover_&]:texture-spikyBall.2 ${i}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Structure"}),e.jsx(r,{itemTool:{type:"door",config:{direction:"away",toRoom:"(placeholder)"}},children:e.jsx("span",{className:`sprite texture-door.frame.generic.x.whole ${i}`})}),e.jsx(r,{itemTool:{type:"wall",config:{direction:"away",tiles:["plain"]}},children:e.jsx("span",{className:`sprite texture-blacktooth.wall.plain.away ${i}`})}),e.jsx(r,{itemTool:{type:"floor",config:{floorType:"standable",scenery:"blacktooth",times:{x:1,y:1}}},children:e.jsx("span",{className:`sprite texture-blacktooth.floor ${i}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"Player"}),e.jsx(r,{itemTool:{type:"player",config:{which:"head"}},children:e.jsx("span",{className:`sprite texture-head.walking.towards.2 [button:hover_&]:texture-animated-head.walking.right ${i}`})}),e.jsx(r,{itemTool:{type:"player",config:{which:"heels"}},children:e.jsx("span",{className:`sprite texture-heels.walking.towards.2 [button:hover_&]:texture-animated-heels.walking.right ${i}`})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"NPCâ€™s"}),e.jsx(r,{itemTool:{type:"sceneryPlayer",config:{which:"head",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-head.walking.towards.2 [button:hover_&]:texture-animated-head.walking.right ${i}`})}),e.jsx(r,{itemTool:{type:"sceneryPlayer",config:{which:"heels",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-heels.walking.towards.2 [button:hover_&]:texture-animated-heels.walking.right ${i}`})}),e.jsx(r,{itemTool:{type:"sceneryPlayer",config:{which:"headOverHeels",startDirection:"towards"}},children:e.jsx(w,{topClasses:"texture-head.walking.towards.2 [button:hover_&]:texture-animated-head.walking.right",bottomClasses:"texture-heels.walking.towards.2 [button:hover_&]:texture-animated-heels.walking.right"})})]}),e.jsxs("div",{className:v,children:[e.jsx(f,{className:"w-full",children:"debug"}),e.jsx(Xe,{})]})]})},he=x.createContext(null),gt=()=>{const[t,s]=x.useState(()=>F({roomJson:J(C.getState()),roomPickupsCollected:k,scrollsRead:k,isNewGame:!0})),o=j(J);return x.useEffect(()=>{const n=F({roomJson:o,roomPickupsCollected:k,scrollsRead:k,isNewGame:!0});s(n)},[o]),t},vt=({children:t})=>{const s=gt();return e.jsx(he,{value:s,children:t})},z=()=>{const t=x.useContext(he);if(t===null)throw new Error("no room state in context, or no context");return t},fe=x.createContext(null),jt=({children:t})=>{const[s,o]=x.useState(null);return x.useEffect(()=>{const n=new nt;return n.init({background:at.pureBlack,sharedTicker:!0}).then(()=>{it(n),o(n)}),()=>{}},[]),s===null?null:e.jsx(fe,{value:s,children:t})},N=()=>x.useContext(fe),bt=(t,s)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:s},soundSettings:{mute:!0},pixiRenderer:t,gameState:void 0,paused:!1,colourised:!0,upscale:ne(C.getState()),editor:!0}),q=(t,s,o)=>new lt({room:t,general:bt(s,o)}),wt=()=>{const{renderer:t}=N(),s=je();if(!t)throw new Error("this should never be falsey (typescript violation)");const o=z(),[n,a]=x.useState(()=>q(o,t,s));return x.useEffect(()=>{const l=q(o,t,s);return a(l),()=>{l.destroy()}},[o,t,s]),n},P="cursor",V=({room:t,pointingAt:s,valid:o,includeCursor:n,previewItems:a})=>{const{face:l,position:u}=s;for(const c of a)be({room:t,item:c});if(n){const c=we(P,t.items);c?(c.state.position=u,c.state.face=l,c.state.valid=o):t.items[P]={type:"cursor",id:P,state:{...Ce(),face:l,position:u,valid:o},config:{},aabb:ke}}else delete t.items[P]},L=t=>{for(const s of D(t.items))s.isCursorPreview&&delete t.items[s.id]};let kt=0;const ye=(t,s,o)=>{if(t.face==="up")return A(t.position);if(o.type==="door"){const a=s.items[t.itemId];if(a.type!=="wall")return;const{config:l,aabb:u,state:{position:c}}=a,p={x:1,y:1,...l.times},m=Se(O(l.direction)),d=O(l.direction);if(p[m]<2)return;const h=c[m],g=c[m]+u[m]-Te,y=c.z,S=c.z+u.z-Re,I={[m]:Math.max(Math.min(t.position[m],g),h),[d]:t.position[d],z:Math.max(Math.min(t.position.z,S),y)};return A(I)}const n=Ie[t.face];return ie(A(t.position),n)},Y=(t,s,o)=>{const n=[...D(s.items).filter(p=>ae(p)&&p.type!=="cursor"&&!p.isCursorPreview)],a=(p,m,d)=>{const h=Pe(`cursor/${kt++}`,{type:p,config:m,position:d},s.roomJson).toArray();return h.forEach(g=>{g.isCursorPreview=!0}),h},l=ye(t,s,o);if(l===void 0)return;if(o.type==="door"){const p=s.items[t.itemId];if(p.type!=="wall")return;const m=p.config.direction;return a("door",{...o.config,direction:m},l)}const u=a(o.type,o.config,l);return u.some(p=>{const m=Ne(p,n);return!ct(m)})?void 0:u},Ct=({x:t,y:s})=>o=>{const{bottomCentre:n,topLeft:a,topRight:l}=pe(o.state.position,o.aabb);return!(t<a.x||t>l.x||s<l.y-(l.x-t)/2||s<a.y-(t-a.x)/2||s>n.y-(t-n.x)/2||s>n.y-(n.x-t)/2)},Nt=(t,{x:s,y:o},n)=>{if(n.type==="item"&&n.item.type==="door"&&t.type==="wall")return Be(t.config.direction);const{bottomCentre:a,topLeft:l,topRight:u}=pe(t.state.position,t.aabb);return o<l.y-(l.x-s)/2?o<u.y-(s-u.x)/2?"up":"right":s<a.x?"towards":"right"},Q=t=>t.fixedZIndex!==void 0,St=t=>{if(t.every(Q))return t.toSorted((l,u)=>u.fixedZIndex-l.fixedZIndex).at(0);const s=t.filter(l=>!Q(l));if(s.length===0)return;if(s.length===1)return s[0];const o=Object.fromEntries(s.map(l=>[l.id,l])),n=dt(o),{order:a}=ut(n,o);return o[a[0]]},Tt=({state:{position:t},aabb:s},o,n,a,l)=>{let u=re,c;switch(o){case"up":u={z:s.z},c="xy";break;case"down":c="xy";break;case"towards":c="xz";break;case"away":u={y:s.y},c="xz";break;case"left":u={x:s.x},c="yz";break;case"right":c="yz";break;default:throw new Error('unexpected face "'+o+'"')}const p=Ee(n,ie(t,u),c),m=!l||a.type==="item"&&a.item.type==="door",d=m?_.w:_.w/2,h=_.h,g=m?0:d/2,y=h/2;return{x:c==="yz"?Math.round(p.x/d)*d:Math.floor((p.x-g)/d)*d,y:c==="xz"?Math.round(p.y/d)*d:Math.floor((p.y-g)/d)*d,z:c==="xy"?Math.round(p.z/h)*h:Math.floor((p.z+y)/h)*h}},Rt=t=>s=>{const o=ae(s)&&s.type!=="cursor"&&!s.isCursorPreview;return t.type==="item"&&t.item.type==="door"?o&&s.type==="wall":o},It=(t,s,o,n)=>{const a=St(Array.from(D(s.items).filter(Rt(o)).filter(Ct(t))));if(a){const l=Nt(a,t,o);return{itemId:a.id,face:l,position:Tt(a,l,t,o,n)}}else return},Pt=(t,s)=>{const o=t.cssUpscale*t.gameEngineUpscale;return{x:s.x/o-t.gameEngineScreenSize.x/2,y:s.y/o-t.gameEngineScreenSize.y+16}},Bt=t=>{const s=N(),o=$(ne),n=T(),a=z(),l=x.useRef(void 0);x.useEffect(()=>{if(s.stage.eventMode="none",t===null)return;const u=m=>{const d=Pt(o,m),h=C.getState(),g=B(h),y=It(d,a,g,h.levelEditor.halfGridResolution);if(!te(y,l.current))if(l.current=y,y!==void 0)switch(g.type){case"item":{const S=Y(y,a,g.item),I=S!==void 0;L(a),V({room:a,pointingAt:y,valid:I,includeCursor:!I,previewItems:S??M});break}case"pointer":{L(a),V({room:a,pointingAt:y,valid:!0,includeCursor:!0,previewItems:M});const S=a.items[y.itemId]?.jsonItemId;a.editor={...a.editor,hoveredJsonItemId:S};break}}else L(a)},c=m=>{const d=B(C.getState());switch(d.type){case"item":{const h=l.current;if(h===void 0||Y(h,a,d.item)===void 0)return;const y=a.items[h.itemId];n(tt({blockPosition:ye(h,a,d.item),pointedAtItem:{type:y.type,config:y.config,jsonItemId:y.jsonItemId}}));break}case"pointer":{const h=l.current;if(!h)return;const{jsonItemId:g}=a.items[h.itemId];n(et({jsonItemId:g,additive:m.ctrlKey||m.metaKey}));break}}},p=m=>{const d=m.key;(d==="Backspace"||d==="Delete")&&n(st()),(d==="z"||d==="Z")&&(m.ctrlKey||m.metaKey)&&C.dispatch(m.shiftKey?me():ue())};return t.addEventListener("mousemove",u),t.addEventListener("click",c),window.addEventListener("keyup",p),()=>{t.removeEventListener("mousemove",u),t.removeEventListener("click",c),window.removeEventListener("keyup",p)}},[s.stage,o,t,n,a])},Et=t=>{const s=z(),o=N();x.useEffect(()=>{let n=0;const a=({deltaMS:l})=>{if(t.destroyed)return;t.renderContext.room!==s&&console.warn("room renderer does not have the current room");const u=new Set($e(s.items));s.roomTime+=l,t.tick({deltaMS:l,movedItems:u,progression:n++}),o.render()};return U.shared.add(a),()=>{U.shared.remove(a)}},[t,s,o])},$t=t=>{const s=N();x.useEffect(()=>{if(t)return t.appendChild(s.canvas),()=>{t.removeChild(s.canvas)}},[t,s])},zt=()=>{const t=N(),s=$(o=>o.upscale.upscale.gameEngineUpscale);t.stage.scale=s},At=()=>{const t=N(),s=$(ze);x.useEffect(()=>{t.renderer?.resize(s.x,s.y)},[t.renderer,s])},_t=t=>{const s=N(),[o]=x.useState(()=>new Ae),n=$(_e);x.useEffect(()=>{if(t.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return o.addChild(t.output.graphics),s.stage.addChild(o),()=>{s.stage.removeChild(o),o.removeChild(t.output.graphics)}},[t,s,o]),x.useEffect(()=>{o.x=n.x/2,o.y=n.y-16},[o,n])},Lt=()=>{const t=z(),s=j(ot);x.useEffect(()=>{t.editor||(t.editor={}),t.editor.selectedJsonItemId=s},[t,s])};Me.defaultOptions.scaleMode="nearest";const Mt=()=>{const t=wt(),[s,o]=x.useState(null);At(),_t(t),Et(t),Bt(s),$t(s),zt(),Lt();const n=Le();return e.jsx("div",{style:n,ref:o})},Xt=()=>(He(),De(),e.jsxs(e.Fragment,{children:[e.jsx("title",{children:"Hoh Editor"}),e.jsx(jt,{children:e.jsx(vt,{children:e.jsx(Mt,{})})}),e.jsx(oe,{scaleFactor:2,children:e.jsx(yt,{})})]}));export{Xt as default};
