import{j as t,r as m}from"./index-ewCkaLYC.js";import{B as X,o as J,n as re,S as ie}from"./ShowBoundingBoxSelect-i3RjgBNs.js";import{at as Z,ad as y,H as I,z as ae,B as W,S as ce,l as le,U as G,ae as g,au as P,ac as z,av as ue,aw as V,Y as E,ax as de,M as pe,ay as me,az as xe,a3 as Y,aA as he,aB as T,b as fe,g as A,aC as ge,aD as ye,aE as ve,j as q,aF as be,aG as C,aH as je,aI as we,Q as R,an as _,o as Se,aJ as ke,as as Ce,aK as Te,aL as Re,aM as Ne,aN as Pe,aO as Ie,C as Ee}from"./App-B-ahQfHy.js";import{useAppSelectorWithLevelEditorSlice as j,selectTool as k,setTool as K,selectCurrentEditingRoomColour as Be,changeRoomColour as M,selectCurrentEditingRoomScenery as $e,changeRoomScenery as ze,selectCurrentEditingRoomJson as L,applyToolToRoomJson as Ae}from"./levelEditorSlice-CgdYWYJe.js";import{c as _e,A as Me,s as Le,R as He,i as De,z as Fe,a as Oe,p as Q}from"./roomRenderer-BQU4uqTX.js";import"./Graphics-D64dNher.js";import"./changeCharacterRoom-PqfUP3qe.js";const B=e=>e,c=({itemTool:e,children:o,className:s})=>{const n=j(k),r=Z(n?.type==="item"&&n.item,e);return t.jsx(X,{"data-iscurrenttool":r,className:`active:pt-oneScaledPix h-3 w-3 gap-0 inline-flex overflow-hidden ${r?"bg-pastelBlue":""} ${s??""}`,onClick:()=>y.dispatch(K({type:"item",item:e})),children:o})},Ue=()=>{const o=j(k)?.type==="pointer";return t.jsx(X,{className:`flex w-3 h-3 ${o?"bg-pastelBlue":""}`,onClick:()=>y.dispatch(K({type:"pointer"})),children:t.jsx("span",{className:"sprite texture-hud.char.â†– relative [button:active_&]:top-quarter"})})},H=e=>{const{main:o}=_e[e].basic;return{backgroundColor:o.basic.toHex(),borderColor:o.dimmed.toHex()}};function Xe(){const e=I(),o=j(Be);return t.jsxs(t.Fragment,{children:[t.jsx(J,{value:o.hue,onSelect:s=>{e(M({hue:s}))},values:ae,disableCommandInput:!0,OptionCommandItem:({value:s,onSelect:n})=>t.jsx(re,{value:s,className:"border-1 h-4 w-2",style:H(s),onSelect:n}),triggerButtonLabel:t.jsx(W,{children:"colour"}),triggerButtonClassName:B(`${o.hue==="white"?"text-pureBlack":"text-white"}`),triggerButtonStyle:H(o.hue)}),t.jsx(ce,{value:o.shade==="basic",onClick:(s,n)=>{e(M({shade:n?"basic":"dimmed"}))},falseLabel:"dimmed",trueLabel:"basic"})]})}function Je(){const e=I(),o=j($e);return t.jsx(J,{value:o,onSelect:s=>{e(ze(s))},values:le,disableCommandInput:!0,triggerButtonClassName:"w-18 text-white",triggerButtonLabel:t.jsx(W,{children:o})})}const a=B("[button:not([data-iscurrenttool=true]):not(:hover)_&]:sprite-revert-to-two-tone"),b=B("flex flex-wrap gap-oneScaledPix w-full"),Ze=()=>t.jsxs("div",{className:"flex fixed top-0 right-0 w-14 text-white bg-metallicBlueHalfbrite p-half gap-oneScaledPix flex-wrap justify-start",children:[t.jsx(Je,{}),t.jsx(Xe,{}),t.jsx("div",{className:b,children:t.jsx(Ue,{})}),t.jsxs("div",{className:b,children:[t.jsx(c,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}},children:t.jsx("span",{className:`sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek" ${a}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"cyberman",activated:"on",movement:"towards-on-shortest-axis-xy4",startDirection:"towards"}},children:t.jsx("span",{className:`sprite texture-cyberman.towards [button:hover_&]:texture-cyberman.right ${a}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}},children:t.jsx("span",{className:`sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right ${a}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"helicopterBug",activated:"on",movement:"patrol-randomly-xy8"}},children:t.jsx("span",{className:`sprite texture-helicopterBug.1 [button:hover_&]:texture-animated-helicopterBug ${a}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}},children:t.jsx("span",{className:`sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right ${a}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"homingBot",activated:"on",movement:"towards-tripped-on-axis-xy4"}},children:t.jsx("span",{className:`sprite texture-headlessBase [button:hover_&]:texture-headlessBase.all ${a}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"computerBot",activated:"on",movement:"patrol-randomly-xy4-and-reverse"}},children:t.jsx("span",{className:`sprite texture-computerBot.towards [button:hover_&]:texture-computerBot.right ${a}`})}),t.jsx(c,{itemTool:{type:"monster",config:{which:"monkey",activated:"on",movement:"patrol-randomly-xy4"}},children:t.jsx("span",{className:`sprite texture-monkey.towards [button:hover_&]:texture-monkey.right ${a}`})}),t.jsxs(c,{itemTool:{type:"monster",config:{which:"elephant",activated:"on",movement:"patrol-randomly-xy4"}},className:"inline relative",children:[t.jsx("span",{className:`sprite inline-block absolute left-0 texture-headlessBase ${a} [button:active_&]:top-oneScaledPix`}),t.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-elephant.towards [button:hover_&]:texture-elephant.right ${a} [button:active_&]:top-oneScaledPix`})]}),t.jsx(c,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"turn-to-player",startDirection:"towards"}},children:t.jsx("span",{className:`sprite texture-elephant.towards [button:hover_&]:texture-elephant.right ${a}`})}),t.jsxs(c,{itemTool:{type:"monster",config:{which:"emperorsGuardian",activated:"while-player-near",movement:"towards-analogue-unless-planet-crowns"}},className:"inline relative",children:[t.jsx("span",{className:`sprite inline-block absolute left-0 texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold ${a} [button:active_&]:top-oneScaledPix`}),t.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-ball [button:hover_&]:texture-ball ${a} [button:active_&]:top-oneScaledPix`})]}),t.jsx(c,{itemTool:{type:"monster",config:{which:"emperor",activated:"while-player-near",movement:"towards-analogue"}},children:t.jsx("span",{className:`sprite texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold ${a}`})})]}),t.jsxs("div",{className:b,children:[t.jsx(c,{itemTool:{type:"block",config:{style:"artificial"}},children:t.jsx("span",{className:`sprite texture-block.artificial ${a}`})}),t.jsx(c,{itemTool:{type:"block",config:{style:"organic"}},children:t.jsx("span",{className:`sprite texture-block.organic ${a}`})}),t.jsx(c,{itemTool:{type:"block",config:{style:"book"}},children:t.jsx("span",{className:`sprite texture-book.x ${a}`})})]}),t.jsxs("div",{className:b,children:[t.jsx(c,{itemTool:{type:"pickup",config:{gives:"extra-life"}},children:t.jsx("span",{className:`sprite texture-whiteRabbit ${a}`})}),t.jsx(c,{itemTool:{type:"pickup",config:{gives:"bag"}},children:t.jsx("span",{className:`sprite texture-bag ${a}`})}),t.jsx(c,{itemTool:{type:"pickup",config:{gives:"hooter"}},children:t.jsx("span",{className:`sprite texture-hooter ${a}`})}),t.jsx(c,{itemTool:{type:"pickup",config:{gives:"doughnuts"}},children:t.jsx("span",{className:`sprite texture-doughnuts ${a}`})}),t.jsx(c,{itemTool:{type:"pickup",config:{gives:"crown",planet:"blacktooth"}},children:t.jsx("span",{className:`sprite texture-crown.blacktooth ${a}`})})]}),t.jsxs("div",{className:b,children:[t.jsxs(c,{itemTool:{type:"lift",config:{top:11,bottom:0}},className:"inline relative",children:[t.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.static ${a} [button:active_&]:top-oneScaledPix`}),t.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.1 [button:hover_&]:texture-animated-lift ${a} [button:active_&]:top-oneScaledPix`})]}),t.jsx(c,{itemTool:{type:"barrier",config:{axis:"x"}},children:t.jsx("span",{className:`sprite texture-barrier.x ${a}`})}),t.jsx(c,{itemTool:{type:"conveyor",config:{direction:"away"}},children:t.jsx("span",{className:`sprite texture-conveyor.y.1 [button:hover_&]:texture-animated-conveyor.x ${a}`})}),t.jsx(c,{itemTool:{type:"teleporter",config:{toRoom:"(placeholder)",toPosition:G}},children:t.jsx("span",{className:`sprite texture-teleporter ${a}`})}),t.jsx(c,{itemTool:{type:"charles",config:g},children:t.jsx("span",{className:`sprite texture-charles.towards [button:hover_&]:texture-charles.right ${a}`})}),t.jsx(c,{itemTool:{type:"joystick",config:{controls:["(placeholder)"]}},children:t.jsx("span",{className:`sprite texture-joystick ${a}`})}),t.jsx(c,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:P}},children:t.jsx("span",{className:`sprite texture-switch.left [button:hover_&]:texture-switch.right ${a}`})}),t.jsx(c,{itemTool:{type:"ball",config:g},children:t.jsx("span",{className:`sprite texture-ball ${a}`})}),t.jsx(c,{itemTool:{type:"portableBlock",config:{style:"cube"}},children:t.jsx("span",{className:`sprite texture-cube ${a}`})}),t.jsx(c,{itemTool:{type:"pushableBlock",config:{style:"stepStool"}},children:t.jsx("span",{className:`sprite texture-stepStool ${a}`})}),t.jsx(c,{itemTool:{type:"movingPlatform",config:{style:"sandwich",movement:"clockwise",activated:"on",startDirection:"towards"}},children:t.jsx("span",{className:`sprite texture-sandwich ${a}`})}),t.jsx(c,{itemTool:{type:"spikes",config:g},children:t.jsx("span",{className:`sprite texture-spikes ${a}`})}),t.jsx(c,{itemTool:{type:"deadlyBlock",config:{style:"volcano"}},children:t.jsx("span",{className:`sprite texture-volcano.1 [button:hover_&]:texture-animated-volcano ${a}`})}),t.jsx(c,{itemTool:{type:"slidingDeadly",config:{style:"spikyBall",startingPhase:1}},children:t.jsx("span",{className:`sprite texture-spikyBall.1 [button:hover_&]:texture-spikyBall.2 ${a}`})}),t.jsx(c,{itemTool:{type:"door",config:{direction:"away",toRoom:"(placeholder)"}},children:t.jsx("span",{className:`sprite texture-door.frame.generic.x.whole ${a}`})})]}),t.jsx("div",{className:"flex flex-row gap-1",children:t.jsx(ie,{})})]}),ee=m.createContext(null),We=()=>{const[e,o]=m.useState(()=>z({roomJson:L(y.getState()),roomPickupsCollected:g,scrollsRead:g,isNewGame:!0})),s=j(L);return m.useEffect(()=>{const n=z({roomJson:s,roomPickupsCollected:g,scrollsRead:g,isNewGame:!0});o(n)},[s]),e},Ge=({children:e})=>{const o=We();return t.jsx(ee,{value:o,children:e})},$=()=>{const e=m.useContext(ee);if(e===null)throw new Error("no room state in context, or no context");return e},te=m.createContext(null),Ve=({children:e})=>{const[o,s]=m.useState(null);return m.useEffect(()=>{const n=new Me;return n.init({background:Le.pureBlack,sharedTicker:!0}).then(()=>{s(n)}),()=>{}},[]),o===null?null:t.jsx(te,{value:o,children:e})},v=()=>m.useContext(te),Ye=(e,o)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:o},soundSettings:{mute:!0},pixiRenderer:e,gameState:void 0,paused:!1,colourised:!0,upscale:V(y.getState())}),D=(e,o,s)=>new He({room:e,general:Ye(o,s)}),qe=()=>{const{renderer:e}=v(),o=ue();if(!e)throw new Error("this should never be falsey (typescript violation)");const s=$(),[n,r]=m.useState(()=>D(s,e,o));return m.useEffect(()=>{const i=D(s,e,o);return r(i),()=>{i.destroy()}},[s,e,o]),n},S="cursor",F=({room:e,pointingAt:o,valid:s,includeCursor:n,previewItems:r})=>{const{face:i,position:u}=o;for(const d of r)de({room:e,item:d});if(n){const d=pe(S,e.items);d?(d.state.position=u,d.state.face=i,d.state.valid=s):e.items[S]={type:"cursor",id:S,state:{...xe(),face:i,position:u,valid:s},config:{},aabb:me}}else delete e.items[S]},N=e=>{for(const o of E(e.items))o.isCursorPreview&&delete e.items[o.id]};let Ke=0;const oe=(e,o,s)=>{if(e.face==="up")return T(e.position);if(s.type==="door"){const r=o.items[e.itemId];if(r.type!=="wall")return;const{config:i,aabb:u,state:{position:d}}=r,x={x:1,y:1,...i.times},l=fe(A(i.direction)),p=A(i.direction);if(x[l]<2)return;const h=d[l],f=d[l]+u[l]-ge,w=d.z,se=d.z+u.z-ye,ne={[l]:Math.max(Math.min(e.position[l],f),h),[p]:e.position[p],z:Math.max(Math.min(e.position.z,se),w)};return T(ne)}const n=ve[e.face];return q(T(e.position),n)},O=(e,o,s)=>{const n=[...E(o.items).filter(x=>Y(x)&&x.type!=="cursor"&&!x.isCursorPreview)],r=(x,l,p)=>{const h=be(`cursor/${Ke++}`,{type:x,config:l,position:p},o.roomJson).toArray();return h.forEach(f=>{f.isCursorPreview=!0}),h},i=oe(e,o,s);if(i===void 0)return;if(s.type==="door"){const x=o.items[e.itemId];if(x.type!=="wall")return;const l=x.config.direction;return r("door",{...s.config,direction:l},i)}const u=r(s.type,s.config,i);return u.some(x=>{const l=he(x,n);return!De(l)})?void 0:u},Qe=({x:e,y:o})=>s=>{const{bottomCentre:n,topLeft:r,topRight:i}=Q(s.state.position,s.aabb);return!(e<r.x||e>i.x||o<i.y-(i.x-e)/2||o<r.y-(e-r.x)/2||o>n.y-(e-n.x)/2||o>n.y-(n.x-e)/2)},et=(e,{x:o,y:s},n)=>{if(n.type==="item"&&n.item.type==="door"&&e.type==="wall")return je(e.config.direction);const{bottomCentre:r,topLeft:i,topRight:u}=Q(e.state.position,e.aabb);return s<i.y-(i.x-o)/2?s<u.y-(o-u.x)/2?"up":"right":o<r.x?"towards":"right"},U=e=>e.fixedZIndex!==void 0,tt=e=>{if(e.every(U))return e.toSorted((i,u)=>u.fixedZIndex-i.fixedZIndex).at(0);const o=e.filter(i=>!U(i));if(o.length===0)return;if(o.length===1)return o[0];const s=Object.fromEntries(o.map(i=>[i.id,i])),n=Fe(s),{order:r}=Oe(n,s);return s[r[0]]},ot=({state:{position:e},aabb:o},s,n,r)=>{let i=G,u;switch(s){case"up":i={z:o.z},u="xy";break;case"down":u="xy";break;case"towards":u="xz";break;case"away":i={y:o.y},u="xz";break;case"left":i={x:o.x},u="yz";break;case"right":u="yz";break;default:throw new Error('unexpected face "'+s+'"')}const d=we(n,q(e,i),u),l=r.type==="item"&&r.item.type==="door"?R.w:R.w/2,p=R.h,h=l/2,f=p/2;return{x:u==="yz"?Math.round(d.x/l)*l:Math.floor((d.x-h)/l)*l,y:u==="xz"?Math.round(d.y/l)*l:Math.floor((d.y-h)/l)*l,z:u==="xy"?Math.round(d.z/p)*p:Math.floor((d.z+f)/p)*p}},st=e=>o=>{const s=Y(o)&&o.type!=="cursor"&&!o.isCursorPreview;return e.type==="item"&&e.item.type==="door"?s&&o.type==="wall":s},nt=(e,o,s)=>{const n=tt(Array.from(E(o.items).filter(st(s)).filter(Qe(e))));if(n){const r=et(n,e,s);return{itemId:n.id,face:r,position:ot(n,r,e,s)}}else return},rt=(e,o)=>{const s=e.cssUpscale*e.gameEngineUpscale;return{x:o.x/s-e.gameEngineScreenSize.x/2,y:o.y/s-e.gameEngineScreenSize.y+16}},it=e=>{const o=v(),s=C(V),n=I(),r=$(),i=m.useRef(void 0);m.useEffect(()=>{if(o.stage.eventMode="none",e===null)return;const u=x=>{const l=rt(s,x),p=k(y.getState()),h=nt(l,r,p);if(!Z(h,i.current))if(i.current=h,h!==void 0)switch(p.type){case"item":{const f=O(h,r,p.item),w=f!==void 0;N(r),F({room:r,pointingAt:h,valid:w,includeCursor:!w,previewItems:f??P});break}case"pointer":{N(r),F({room:r,pointingAt:h,valid:!0,includeCursor:!0,previewItems:P});break}}else N(r)},d=x=>{const l=k(y.getState());switch(l.type){case"item":{const p=i.current;if(p===void 0||O(p,r,l.item)===void 0)return;n(Ae({blockPosition:oe(p,r,l.item),pointedAtItem:r.items[p.itemId]}));break}}};return e.addEventListener("mousemove",u),e.addEventListener("click",d),()=>{e.removeEventListener("mousemove",u),e.removeEventListener("click",d)}},[o.stage,s,e,n,r])},at=e=>{const o=$();m.useEffect(()=>{let s=0;const n=({deltaMS:r})=>{if(e.destroyed)return;e.renderContext.room!==o&&console.warn("room renderer does not have the current room");const i=new Set(Se(o.items));e.tick({deltaMS:r,movedItems:i,progression:s++})};return _.shared.add(n),()=>{_.shared.remove(n)}},[e,o])},ct=e=>{const o=v();m.useEffect(()=>{if(e)return e.appendChild(o.canvas),()=>{e.removeChild(o.canvas)}},[e,o])},lt=()=>{const e=v(),o=C(s=>s.upscale.upscale.gameEngineUpscale);e.stage.scale=o},ut=()=>{const e=v(),o=C(ke);m.useEffect(()=>{e.renderer?.resize(o.x,o.y)},[e.renderer,o])},dt=e=>{const o=v(),[s]=m.useState(()=>new Ce),n=C(Te);m.useEffect(()=>{if(e.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return s.addChild(e.output.graphics),o.stage.addChild(s),()=>{o.stage.removeChild(s),s.removeChild(e.output.graphics)}},[e,o,s]),m.useEffect(()=>{s.x=n.x/2,s.y=n.y-16},[s,n])};Ne.defaultOptions.scaleMode="nearest";const pt=()=>{const e=qe(),[o,s]=m.useState(null);ut(),dt(e),at(e),it(o),ct(o),lt();const n=Re();return t.jsx("div",{style:n,ref:s})},bt=()=>(Pe(),Ie(),t.jsxs(t.Fragment,{children:[t.jsx("title",{children:"Hoh Editor"}),t.jsx(Ve,{children:t.jsx(Ge,{children:t.jsx(pt,{})})}),t.jsx(Ee,{scaleFactor:2,children:t.jsx(Ze,{})})]}));export{bt as default};
