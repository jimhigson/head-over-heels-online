import{j as n,r as c}from"./index-CPuMHXZc.js";import{B as U,g as Pe,h as Te,i as Be,C as Ae,j as Ne,k as Me,l as ze,m as Fe,n as ce,S as Le}from"./ShowBoundingBoxSwitches-CbzxcU8Q.js";import{ap as le,a9 as w,aa as y,B as P,C as Oe,w as Y,z as De,S as Xe,s as _e,N as He,aq as M,a8 as W,ar as ue,R as Z,as as Ue,F as Ye,at as Ze,au as $e,$ as de,av as We,aw as G,ax as Ge,U as Je,ay as qe,az as B,aA as Ve,K as pe,aj as J,o as Ke,aB as Qe,ao as et,aC as tt,aD as ot,aE as rt,aF as nt,aG as st}from"./App-l_VhA-SO.js";import{useAppSelectorWithLevelEditorSlice as S,selectTool as T,setTool as me,selectCurrentEditingRoomColour as it,changeRoomColour as q,selectCurrentEditingRoomScenery as at,changeRoomScenery as ct,selectCurrentEditingRoomJson as V,applyToolAtPosition as lt}from"./levelEditorSlice-7qU-jRtf.js";import{c as ut,A as dt,s as pt,R as mt,i as ft,z as ht,a as xt,p as fe}from"./roomRenderer-Bnfpco_8.js";import"./Graphics-CXTlf7cs.js";import"./changeCharacterRoom-8MRVH97e.js";const he=e=>e,A=he({door:"sprite texture-door.frame.generic.x.whole",ball:"sprite texture-ball",teleporter:"sprite texture-teleporter",conveyor:"sprite texture-conveyor.y.1 [button:hover_&]:texture-animated-conveyor.x",lift:"sprite texture-lift.static [button:hover_&]:texture-animated-lift",barrier:"sprite texture-barrier.x",pickup:"sprite texture-whiteRabbit","portableBlock[style=cube]":"sprite texture-cube","pushableBlock[style=stepStool]":"sprite texture-stepStool","movingPlatform[style=sandwich]":"sprite texture-sandwich",charles:"sprite texture-charles.towards [button:hover_&]:texture-charles.right",joystick:"sprite texture-joystick",switch:"sprite texture-switch.left [button:hover_&]:texture-switch.right",spikes:"sprite texture-spikes","deadlyBlock[style=volcano]":"sprite texture-volcano.1 [button:hover_&]:texture-animated-volcano",slidingDeadly:"sprite texture-spikyBall.1 [button:hover_&]:texture-spikyBall.2","monster[which=turtle]":"sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right","monster[which=dalek]":"sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek","monster[which=elephantHead]":"sprite texture-elephant.towards [button:hover_&]:texture-elephant.right","monster[which=skiHead]":"sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right","monster[which=cyberman]":"sprite texture-cyberman.towards [button:hover_&]:texture-cyberman.right","block[style=organic]":"sprite texture-block.organic","block[style=artificial]":"sprite texture-block.artificial","block[style=book]":"sprite texture-book.x"}),yt=e=>e.type==="monster"?A[`monster[which=${e.config.which}]`]:e.type==="block"||e.type==="portableBlock"||e.type==="deadlyBlock"||e.type==="movingPlatform"||e.type==="pushableBlock"?A[`${e.type}[style=${e.config.style}]`]:A[e.type],a=({itemTool:e})=>{const t=S(T),o=yt(e),r=le(t?.type==="item"&&t.item,e);return n.jsx(U,{className:`flex-1 h-min p-quarter grow-0 ${r?"bg-pastelBlue":""}`,onClick:()=>w.dispatch(me({type:"item",item:e})),children:n.jsx("span",{className:`${o} relative [button:active_&]:top-oneScaledPix`})})},gt=()=>{const t=S(T)?.type==="pointer";return n.jsx(U,{className:`flex-1 w-2 h-2 p-quarter ${t?"bg-pastelBlue":""}`,onClick:()=>w.dispatch(me({type:"pointer"})),children:n.jsx("span",{className:"sprite texture-hud.char.↖ relative [button:active_&]:top-quarter"})})};var K=!1,g,z,F,R,I,xe,E,L,O,D,ye,X,_,ge,ve;function d(){if(!K){K=!0;var e=navigator.userAgent,t=/(?:MSIE.(\d+\.\d+))|(?:(?:Firefox|GranParadiso|Iceweasel).(\d+\.\d+))|(?:Opera(?:.+Version.|.)(\d+\.\d+))|(?:AppleWebKit.(\d+(?:\.\d+)?))|(?:Trident\/\d+\.\d+.*rv:(\d+\.\d+))/.exec(e),o=/(Mac OS X)|(Windows)|(Linux)/.exec(e);if(X=/\b(iPhone|iP[ao]d)/.exec(e),_=/\b(iP[ao]d)/.exec(e),D=/Android/i.exec(e),ge=/FBAN\/\w+;/i.exec(e),ve=/Mobile/i.exec(e),ye=!!/Win64/.exec(e),t){g=t[1]?parseFloat(t[1]):t[5]?parseFloat(t[5]):NaN,g&&document&&document.documentMode&&(g=document.documentMode);var r=/(?:Trident\/(\d+.\d+))/.exec(e);xe=r?parseFloat(r[1])+4:g,z=t[2]?parseFloat(t[2]):NaN,F=t[3]?parseFloat(t[3]):NaN,R=t[4]?parseFloat(t[4]):NaN,R?(t=/(?:Chrome\/(\d+\.\d+))/.exec(e),I=t&&t[1]?parseFloat(t[1]):NaN):I=NaN}else g=z=F=I=R=NaN;if(o){if(o[1]){var s=/(?:Mac OS X (\d+(?:[._]\d+)?))/.exec(e);E=s?parseFloat(s[1].replace("_",".")):!0}else E=!1;L=!!o[2],O=!!o[3]}else E=L=O=!1}}var H={ie:function(){return d()||g},ieCompatibilityMode:function(){return d()||xe>g},ie64:function(){return H.ie()&&ye},firefox:function(){return d()||z},opera:function(){return d()||F},webkit:function(){return d()||R},safari:function(){return H.webkit()},chrome:function(){return d()||I},windows:function(){return d()||L},osx:function(){return d()||E},linux:function(){return d()||O},iphone:function(){return d()||X},mobile:function(){return d()||X||_||D||ve},nativeApp:function(){return d()||ge},android:function(){return d()||D},ipad:function(){return d()||_}},vt=H,wt=!!(typeof window<"u"&&window.document&&window.document.createElement),bt={canUseDOM:wt},we=bt,be;we.canUseDOM&&(be=document.implementation&&document.implementation.hasFeature&&document.implementation.hasFeature("","")!==!0);function Ct(e,t){if(!we.canUseDOM||t&&!("addEventListener"in document))return!1;var o="on"+e,r=o in document;if(!r){var s=document.createElement("div");s.setAttribute(o,"return;"),r=typeof s[o]=="function"}return!r&&be&&e==="wheel"&&(r=document.implementation.hasFeature("Events.wheel","3.0")),r}var St=Ct,Q=10,ee=40,te=800;function Ce(e){var t=0,o=0,r=0,s=0;return"detail"in e&&(o=e.detail),"wheelDelta"in e&&(o=-e.wheelDelta/120),"wheelDeltaY"in e&&(o=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),"axis"in e&&e.axis===e.HORIZONTAL_AXIS&&(t=o,o=0),r=t*Q,s=o*Q,"deltaY"in e&&(s=e.deltaY),"deltaX"in e&&(r=e.deltaX),(r||s)&&e.deltaMode&&(e.deltaMode==1?(r*=ee,s*=ee):(r*=te,s*=te)),r&&!t&&(t=r<1?-1:1),s&&!o&&(o=s<1?-1:1),{spinX:t,spinY:o,pixelX:r,pixelY:s}}Ce.getEventType=function(){return vt.firefox()?"DOMMouseScroll":St("wheel")?"wheel":"mousewheel"};var jt=Ce;/**
* Checks if an event is supported in the current execution environment.
*
* NOTE: This will not work correctly for non-generic events such as `change`,
* `reset`, `load`, `error`, and `select`.
*
* Borrows from Modernizr.
*
* @param {string} eventNameSuffix Event name, e.g. "click".
* @param {?boolean} capture Check if the capture phase is supported.
* @return {boolean} True if the event is supported.
* @internal
* @license Modernizr 3.0.0pre (Custom Build) | MIT
*/const Se=e=>{const{value:t,values:o,onSelect:r,triggerButtonClassName:s="",triggerButtonStyle:i=y,triggerButtonLabel:u="",OptionCommandItem:l}=e,[f,h]=c.useState(!1),p=c.useRef(0);return n.jsxs(Pe,{open:f,onOpenChange:h,children:[n.jsx(Te,{asChild:!0,children:n.jsxs(U,{className:`h-2 px-1 justify-between  ${s}`,style:i,onWheel:m=>{const v=jt(m.nativeEvent);if(p.current+=v.spinY,p.current>=1||p.current<=-1){const j=o.indexOf(t),Ie=(Math.round(j+p.current)+99*o.length)%o.length,Ee=o[Ie];r(Ee),p.current=0}},children:[u,n.jsx(P,{className:"ml-half shrink-0",children:f?"X":"⬇"})]})}),n.jsx(Be,{className:"p-0 z-dialog",children:n.jsx(Oe,{scaleFactor:1,children:n.jsxs(Ae,{className:"w-[--radix-popper-anchor-width]",children:[e.disableCommandInput===!0?null:n.jsx(Ne,{placeholder:e.placeholder}),n.jsxs(Me,{children:[n.jsx(ze,{children:"No room found"}),n.jsx(Fe,{children:o.map(m=>n.jsx(l,{value:m,onSelect:v=>{h(!1),r(v)}},m))})]})]})})})]})},oe=e=>{const{main:t}=ut[e].basic;return{backgroundColor:t.basic.toHex(),borderColor:t.dimmed.toHex()}};function kt(){const e=Y(),t=S(it);return n.jsxs(n.Fragment,{children:[n.jsx(Se,{value:t.hue,onSelect:o=>{e(q({hue:o}))},values:De,disableCommandInput:!0,OptionCommandItem:({value:o,onSelect:r})=>n.jsx(ce,{value:o,className:"border-1 h-4 w-2",style:oe(o),onSelect:r}),triggerButtonLabel:n.jsx(P,{children:"colour"}),triggerButtonClassName:he(`${t.hue==="white"?"text-pureBlack":"text-white"}`),triggerButtonStyle:oe(t.hue)}),n.jsx(Xe,{value:t.shade==="basic",onClick:(o,r)=>{e(q({shade:r?"basic":"dimmed"}))},falseLabel:"dimmed",trueLabel:"basic"})]})}function Rt(){const e=Y(),t=S(at);return n.jsx(Se,{value:t,onSelect:o=>{e(ct(o))},values:_e,disableCommandInput:!0,OptionCommandItem:({value:o,onSelect:r})=>n.jsx(ce,{value:o,onSelect:r,children:n.jsx(P,{children:o})}),triggerButtonClassName:"w-18 text-white",triggerButtonLabel:n.jsx(P,{children:t})})}const It=()=>n.jsxs("div",{className:"fixed flex top-1 right-1 bg-metallicBlueHalfbrite p-half gap-half w-24 flex-wrap justify-start",children:[n.jsx(Rt,{}),n.jsx(kt,{}),n.jsx(gt,{}),n.jsx(a,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}}}),n.jsx(a,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}}}),n.jsx(a,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"turn-to-player",startDirection:"towards"}}}),n.jsx(a,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}}}),n.jsx(a,{itemTool:{type:"monster",config:{which:"cyberman",activated:"on",movement:"towards-on-shortest-axis-xy4",startDirection:"towards"}}}),n.jsx(a,{itemTool:{type:"block",config:{style:"artificial"}}}),n.jsx(a,{itemTool:{type:"lift",config:{top:11,bottom:0}}}),n.jsx(a,{itemTool:{type:"barrier",config:{axis:"x"}}}),n.jsx(a,{itemTool:{type:"block",config:{style:"organic"}}}),n.jsx(a,{itemTool:{type:"block",config:{style:"book"}}}),n.jsx(a,{itemTool:{type:"pickup",config:{gives:"extra-life"}}}),n.jsx(a,{itemTool:{type:"conveyor",config:{direction:"away"}}}),n.jsx(a,{itemTool:{type:"teleporter",config:{toRoom:"(placeholder)",toPosition:He}}}),n.jsx(a,{itemTool:{type:"charles",config:y}}),n.jsx(a,{itemTool:{type:"joystick",config:{controls:["(placeholder)"]}}}),n.jsx(a,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:M}}}),n.jsx(a,{itemTool:{type:"ball",config:y}}),n.jsx(a,{itemTool:{type:"portableBlock",config:{style:"cube"}}}),n.jsx(a,{itemTool:{type:"pushableBlock",config:{style:"stepStool"}}}),n.jsx(a,{itemTool:{type:"movingPlatform",config:{style:"sandwich",movement:"clockwise",activated:"on",startDirection:"towards"}}}),n.jsx(a,{itemTool:{type:"spikes",config:y}}),n.jsx(a,{itemTool:{type:"deadlyBlock",config:{style:"volcano"}}}),n.jsx(a,{itemTool:{type:"slidingDeadly",config:{style:"spikyBall",startingPhase:1}}}),n.jsx(a,{itemTool:{type:"door",config:{direction:"away",toRoom:"(placeholder)"}}}),n.jsx(Le,{})]}),je=c.createContext(null),Et=()=>{const[e,t]=c.useState(()=>W({roomJson:V(w.getState()),roomPickupsCollected:y,scrollsRead:y,isNewGame:!0})),o=S(V);return c.useEffect(()=>{const r=W({roomJson:o,roomPickupsCollected:y,scrollsRead:y,isNewGame:!0});t(r)},[o]),e},Pt=({children:e})=>{const t=Et();return n.jsx(je,{value:t,children:e})},$=()=>{const e=c.useContext(je);if(e===null)throw new Error("no room state in context, or no context");return e},ke=c.createContext(null),Tt=({children:e})=>{const[t,o]=c.useState(null);return c.useEffect(()=>{const r=new dt;return r.init({background:pt.pureBlack,sharedTicker:!0}).then(()=>{o(r)}),()=>{}},[]),t===null?null:n.jsx(ke,{value:t,children:e})},b=()=>c.useContext(ke),Bt=e=>({displaySettings:{emulatedResolution:"amigaLowResPal"},soundSettings:{mute:!0},pixiRenderer:e,gameState:void 0,paused:!1,colourised:!0,upscale:ue(w.getState())}),re=(e,t)=>new mt({room:e,general:Bt(t)}),At=()=>{const{renderer:e}=b();if(!e)throw new Error("this should never be falsey (typescript violation)");const t=$(),[o,r]=c.useState(()=>re(t,e));return c.useEffect(()=>{const s=re(t,e);return r(s),()=>{s.destroy()}},[t,e]),o},k="cursor",ne=({room:e,pointingAt:t,valid:o,includeCursor:r,previewItems:s})=>{const{face:i,position:u}=t;for(const l of s)Ue({room:e,item:l});if(r){const l=Ye(k,e.items);l?(l.state.position=u,l.state.face=i,l.state.valid=o):e.items[k]={type:"cursor",id:k,state:{...$e(),face:i,position:u,valid:o},config:{},aabb:Ze}}else delete e.items[k]},N=e=>{for(const t of Z(e.items))t.isCursorPreview&&delete e.items[t.id]};let Nt=0;const Re=(e,t)=>{if(t.type==="door"||e.face==="top")return G(e.position);const o=Ge[e.face];return Je(G(e.position),o)},se=(e,t,o)=>{const r=[...Z(t.items).filter(i=>de(i)&&i.type!=="cursor"&&!i.isCursorPreview)],s=(i,u)=>{const l=Re(e,o),f=qe(`cursor/${Nt++}`,{type:i,config:u,position:l},t.roomJson).toArray();return f.forEach(h=>{h.isCursorPreview=!0}),f};if(o.type==="door"){const i=t.items[e.itemId];if(i.type!=="wall")return;const u=i.config.direction;return s("door",{...o.config,direction:u})}else{const i=s(o.type,o.config);return i.some(l=>{const f=We(l,r);return!ft(f)})?void 0:i}},x=pe.w/2,C=pe.h,ie=x/2,Mt=C/2,zt=({x:e,y:t})=>o=>{const{bottomCentre:r,topLeft:s,topRight:i}=fe(o.state.position,o.aabb);return!(e<s.x||e>i.x||t<i.y-(i.x-e)/2||t<s.y-(e-s.x)/2||t>r.y-(e-r.x)/2||t>r.y-(r.x-e)/2)},Ft=(e,{x:t,y:o})=>{const{bottomCentre:r,topLeft:s,topRight:i}=fe(e.state.position,e.aabb);return o<s.y-(s.x-t)/2?o<i.y-(t-i.x)/2?"top":"right":t<r.x?"towards":"right"},ae=e=>e.fixedZIndex!==void 0,Lt=e=>{if(e.every(ae))return e.toSorted((i,u)=>u.fixedZIndex-i.fixedZIndex).at(0);const t=e.filter(i=>!ae(i));if(t.length===0)return;if(t.length===1)return t[0];const o=Object.fromEntries(t.map(i=>[i.id,i])),r=ht(o),{order:s}=xt(r,o);return o[s[0]]},Ot=({state:{position:e},aabb:t},o,r)=>{const s=o==="top"?"xy":o==="towards"?"xz":"yz",i=Ve(r,e,t,s);return{x:s==="yz"?Math.round(i.x/x)*x:Math.floor((i.x-ie)/x)*x,y:s==="xz"?Math.round(i.y/x)*x:Math.floor((i.y-ie)/x)*x,z:s==="xy"?Math.round(i.z/C)*C:Math.floor((i.z+Mt)/C)*C}},Dt=e=>t=>{const o=de(t)&&t.type!=="cursor"&&!t.isCursorPreview;return e.type==="item"&&e.item.type==="door"?o&&t.type==="wall":o},Xt=(e,t,o)=>{const r=Lt(Array.from(Z(t.items).filter(Dt(o)).filter(zt(e))));if(r){const s=Ft(r,e);return{itemId:r.id,face:s,position:Ot(r,s,e)}}else return},_t=(e,t)=>{const o=e.cssUpscale*e.gameEngineUpscale;return{x:t.x/o-e.gameEngineScreenSize.x/2,y:t.y/o-e.gameEngineScreenSize.y+16}},Ht=e=>{const t=b(),o=B(ue),r=Y(),s=$(),i=c.useRef(void 0);c.useEffect(()=>{if(t.stage.eventMode="none",e===null)return;const u=f=>{const h=_t(o,f),p=T(w.getState()),m=Xt(h,s,p);if(!le(m,i.current))if(i.current=m,m!==void 0)switch(p.type){case"item":{const v=se(m,s,p.item),j=v!==void 0;N(s),ne({room:s,pointingAt:m,valid:j,includeCursor:!j,previewItems:v??M});break}case"pointer":{N(s),ne({room:s,pointingAt:m,valid:!0,includeCursor:!0,previewItems:M});break}}else N(s)},l=f=>{const h=T(w.getState());switch(h.type){case"item":{const p=i.current;if(p===void 0||se(p,s,h.item)===void 0)return;r(lt({blockPosition:Re(p,h.item)}));break}}};return e.addEventListener("mousemove",u),e.addEventListener("click",l),()=>{e.removeEventListener("mousemove",u),e.removeEventListener("click",l)}},[t.stage,o,e,r,s])},Ut=e=>{const t=$();c.useEffect(()=>{let o=0;const r=({deltaMS:s})=>{if(e.destroyed)return;e.renderContext.room!==t&&console.warn("room renderer does not have the current room");const i=new Set(Ke(t.items));e.tick({deltaMS:s,movedItems:i,progression:o++})};return J.shared.add(r),()=>{J.shared.remove(r)}},[e,t])},Yt=e=>{const t=b();c.useEffect(()=>{if(e)return e.appendChild(t.canvas),()=>{e.removeChild(t.canvas)}},[e,t])},Zt=()=>{const e=b(),t=B(o=>o.upscale.upscale.gameEngineUpscale);e.stage.scale=t},$t=()=>{const e=b(),t=B(Qe);c.useEffect(()=>{e.renderer?.resize(t.x,t.y)},[e.renderer,t])},Wt=e=>{const t=b(),[o]=c.useState(()=>new et),r=B(tt);c.useEffect(()=>{if(e.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return o.addChild(e.output.graphics),t.stage.addChild(o),()=>{t.stage.removeChild(o),o.removeChild(e.output.graphics)}},[e,t,o]),c.useEffect(()=>{o.x=r.x/2,o.y=r.y-16},[o,r])};rt.defaultOptions.scaleMode="nearest";const Gt=()=>{const e=At(),[t,o]=c.useState(null);$t(),Wt(e),Ut(e),Ht(t),Yt(t),Zt();const r=ot();return n.jsx("div",{style:r,ref:o})},oo=()=>(nt(),st(),n.jsxs("div",{children:[n.jsx("title",{children:"Hoh Editor"}),n.jsx(Tt,{children:n.jsx(Pt,{children:n.jsx(Gt,{})})}),n.jsx(It,{})]}));export{oo as default};
