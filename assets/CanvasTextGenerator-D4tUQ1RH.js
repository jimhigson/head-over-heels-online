import{D as M,E as nt,u as st,a as F,b as N,c as $,C as B,F as I,d as O,f as G,v as V,w as Z,T as at,M as j,n as Y,R}from"./App-BPnbVEwn.js";import{C as K}from"./CanvasPool-BGhAX_8W.js";class ot{constructor(t=0,e=0,i=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=t,this.resetTtl=i,this.size=0,this.ttl=e}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(t){if(this.has(t)){const e=this.items[t];delete this.items[t],this.size--,e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.first===e&&(this.first=e.next),this.last===e&&(this.last=e.prev)}return this}entries(t=this.keys()){return t.map(e=>[e,this.get(e)])}evict(t=!1){if(t||this.size>0){const e=this.first;delete this.items[e.key],--this.size===0?(this.first=null,this.last=null):(this.first=e.next,this.first.prev=null)}return this}expiresAt(t){let e;return this.has(t)&&(e=this.items[t].expiry),e}get(t){const e=this.items[t];if(e!==void 0){if(this.ttl>0&&e.expiry<=Date.now()){this.delete(t);return}return this.moveToEnd(e),e.value}}has(t){return t in this.items}moveToEnd(t){this.last!==t&&(t.prev!==null&&(t.prev.next=t.next),t.next!==null&&(t.next.prev=t.prev),this.first===t&&(this.first=t.next),t.prev=this.last,t.next=null,this.last!==null&&(this.last.next=t),this.last=t,this.first===null&&(this.first=t))}keys(){const t=[];let e=this.first;for(;e!==null;)t.push(e.key),e=e.next;return t}setWithEvicted(t,e,i=this.resetTtl){let r=null;if(this.has(t))this.set(t,e,!0,i);else{this.max>0&&this.size===this.max&&(r={...this.first},this.evict(!0));let n=this.items[t]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:t,prev:this.last,next:null,value:e};++this.size===1?this.first=n:this.last.next=n,this.last=n}return r}set(t,e,i=!1,r=this.resetTtl){let n=this.items[t];return i||n!==void 0?(n.value=e,i===!1&&r&&(n.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.moveToEnd(n)):(this.max>0&&this.size===this.max&&this.evict(!0),n=this.items[t]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:t,prev:this.last,next:null,value:e},++this.size===1?this.first=n:this.last.next=n,this.last=n),this}values(t=this.keys()){return t.map(e=>this.get(e))}}function lt(l=1e3,t=0,e=!1){if(isNaN(l)||l<0)throw new TypeError("Invalid max value");if(isNaN(t)||t<0)throw new TypeError("Invalid ttl value");if(typeof e!="boolean")throw new TypeError("Invalid resetTtl value");return new ot(l,t,e)}const ht=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];function tt(l){const t=typeof l.fontSize=="number"?`${l.fontSize}px`:l.fontSize;let e=l.fontFamily;Array.isArray(l.fontFamily)||(e=l.fontFamily.split(","));for(let i=e.length-1;i>=0;i--){let r=e[i].trim();!/([\"\'])[^\'\"]+\1/.test(r)&&!ht.includes(r)&&(r=`"${r}"`),e[i]=r}return`${l.fontStyle} ${l.fontVariant} ${l.fontWeight} ${t} ${e.join(",")}`}const A={willReadFrequently:!0},C=class a{static get experimentalLetterSpacingSupported(){let t=a._experimentalLetterSpacingSupported;if(t===void 0){const e=M.get().getCanvasRenderingContext2D().prototype;t=a._experimentalLetterSpacingSupported="letterSpacing"in e||"textLetterSpacing"in e}return t}constructor(t,e,i,r,n,o,s,d,h){this.text=t,this.style=e,this.width=i,this.height=r,this.lines=n,this.lineWidths=o,this.lineHeight=s,this.maxLineWidth=d,this.fontProperties=h}static measureText(t=" ",e,i=a._canvas,r=e.wordWrap){const n=`${t}-${e.styleKey}-wordWrap-${r}`;if(a._measurementCache.has(n))return a._measurementCache.get(n);const o=tt(e),s=a.measureFont(o);s.fontSize===0&&(s.fontSize=e.fontSize,s.ascent=e.fontSize);const d=a.__context;d.font=o;const c=(r?a._wordWrap(t,e,i):t).split(/(?:\r\n|\r|\n)/),f=new Array(c.length);let u=0;for(let W=0;W<c.length;W++){const x=a._measureText(c[W],e.letterSpacing,d);f[W]=x,u=Math.max(u,x)}const g=e._stroke?.width||0;let S=u+g;e.dropShadow&&(S+=e.dropShadow.distance);const _=e.lineHeight||s.fontSize;let w=Math.max(_,s.fontSize+g)+(c.length-1)*(_+e.leading);e.dropShadow&&(w+=e.dropShadow.distance);const p=new a(t,e,S,w,c,f,_+e.leading,u,s);return a._measurementCache.set(n,p),p}static _measureText(t,e,i){let r=!1;a.experimentalLetterSpacingSupported&&(a.experimentalLetterSpacing?(i.letterSpacing=`${e}px`,i.textLetterSpacing=`${e}px`,r=!0):(i.letterSpacing="0px",i.textLetterSpacing="0px"));const n=i.measureText(t);let o=n.width;const s=-n.actualBoundingBoxLeft;let h=n.actualBoundingBoxRight-s;if(o>0)if(r)o-=e,h-=e;else{const c=(a.graphemeSegmenter(t).length-1)*e;o+=c,h+=c}return Math.max(o,h)}static _wordWrap(t,e,i=a._canvas){const r=i.getContext("2d",A);let n=0,o="",s="";const d=Object.create(null),{letterSpacing:h,whiteSpace:c}=e,f=a._collapseSpaces(c),u=a._collapseNewlines(c);let g=!f;const S=e.wordWrapWidth+h,_=a._tokenize(t);for(let w=0;w<_.length;w++){let p=_[w];if(a._isNewline(p)){if(!u){s+=a._addLine(o),g=!f,o="",n=0;continue}p=" "}if(f){const x=a.isBreakingSpace(p),k=a.isBreakingSpace(o[o.length-1]);if(x&&k)continue}const W=a._getFromCache(p,h,d,r);if(W>S)if(o!==""&&(s+=a._addLine(o),o="",n=0),a.canBreakWords(p,e.breakWords)){const x=a.wordWrapSplit(p);for(let k=0;k<x.length;k++){let y=x[k],P=y,b=1;for(;x[k+b];){const m=x[k+b];if(!a.canBreakChars(P,m,p,k,e.breakWords))y+=m;else break;P=m,b++}k+=b-1;const z=a._getFromCache(y,h,d,r);z+n>S&&(s+=a._addLine(o),g=!1,o="",n=0),o+=y,n+=z}}else{o.length>0&&(s+=a._addLine(o),o="",n=0);const x=w===_.length-1;s+=a._addLine(p,!x),g=!1,o="",n=0}else W+n>S&&(g=!1,s+=a._addLine(o),o="",n=0),(o.length>0||!a.isBreakingSpace(p)||g)&&(o+=p,n+=W)}return s+=a._addLine(o,!1),s}static _addLine(t,e=!0){return t=a._trimRight(t),t=e?`${t}
`:t,t}static _getFromCache(t,e,i,r){let n=i[t];return typeof n!="number"&&(n=a._measureText(t,e,r)+e,i[t]=n),n}static _collapseSpaces(t){return t==="normal"||t==="pre-line"}static _collapseNewlines(t){return t==="normal"}static _trimRight(t){if(typeof t!="string")return"";for(let e=t.length-1;e>=0;e--){const i=t[e];if(!a.isBreakingSpace(i))break;t=t.slice(0,-1)}return t}static _isNewline(t){return typeof t!="string"?!1:a._newlines.includes(t.charCodeAt(0))}static isBreakingSpace(t,e){return typeof t!="string"?!1:a._breakingSpaces.includes(t.charCodeAt(0))}static _tokenize(t){const e=[];let i="";if(typeof t!="string")return e;for(let r=0;r<t.length;r++){const n=t[r],o=t[r+1];if(a.isBreakingSpace(n,o)||a._isNewline(n)){i!==""&&(e.push(i),i=""),n==="\r"&&o===`
`?(e.push(`\r
`),r++):e.push(n);continue}i+=n}return i!==""&&e.push(i),e}static canBreakWords(t,e){return e}static canBreakChars(t,e,i,r,n){return!0}static wordWrapSplit(t){return a.graphemeSegmenter(t)}static measureFont(t){if(a._fonts[t])return a._fonts[t];const e=a._context;e.font=t;const i=e.measureText(a.METRICS_STRING+a.BASELINE_SYMBOL),r={ascent:i.actualBoundingBoxAscent,descent:i.actualBoundingBoxDescent,fontSize:i.actualBoundingBoxAscent+i.actualBoundingBoxDescent};return a._fonts[t]=r,r}static clearMetrics(t=""){t?delete a._fonts[t]:a._fonts={}}static get _canvas(){if(!a.__canvas){let t;try{const e=new OffscreenCanvas(0,0);if(e.getContext("2d",A)?.measureText)return a.__canvas=e,e;t=M.get().createCanvas()}catch{t=M.get().createCanvas()}t.width=t.height=10,a.__canvas=t}return a.__canvas}static get _context(){return a.__context||(a.__context=a._canvas.getContext("2d",A)),a.__context}};C.METRICS_STRING="|ÉqÅ";C.BASELINE_SYMBOL="M";C.BASELINE_MULTIPLIER=1.4;C.HEIGHT_MULTIPLIER=2;C.graphemeSegmenter=(()=>{if(typeof Intl?.Segmenter=="function"){const l=new Intl.Segmenter;return t=>{const e=l.segment(t),i=[];let r=0;for(const n of e)i[r++]=n.segment;return i}}return l=>[...l]})();C.experimentalLetterSpacing=!1;C._fonts={};C._newlines=[10,13];C._breakingSpaces=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288];C._measurementCache=lt(1e3);let E=C;const H=class v extends nt{constructor(t={}){super(),this.uid=st("textStyle"),this._tick=0,ft(t);const e={...v.defaultTextStyle,...t};for(const i in e){const r=i;this[r]=e[i]}this.update(),this._tick=0}get align(){return this._align}set align(t){this._align!==t&&(this._align=t,this.update())}get breakWords(){return this._breakWords}set breakWords(t){this._breakWords!==t&&(this._breakWords=t,this.update())}get dropShadow(){return this._dropShadow}set dropShadow(t){this._dropShadow!==t&&(t!==null&&typeof t=="object"?this._dropShadow=this._createProxy({...v.defaultDropShadow,...t}):this._dropShadow=t?this._createProxy({...v.defaultDropShadow}):null,this.update())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this.update())}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(typeof t=="string"?this._fontSize=parseInt(t,10):this._fontSize=t,this.update())}get fontStyle(){return this._fontStyle}set fontStyle(t){this._fontStyle!==t&&(this._fontStyle=t.toLowerCase(),this.update())}get fontVariant(){return this._fontVariant}set fontVariant(t){this._fontVariant!==t&&(this._fontVariant=t,this.update())}get fontWeight(){return this._fontWeight}set fontWeight(t){this._fontWeight!==t&&(this._fontWeight=t,this.update())}get leading(){return this._leading}set leading(t){this._leading!==t&&(this._leading=t,this.update())}get letterSpacing(){return this._letterSpacing}set letterSpacing(t){this._letterSpacing!==t&&(this._letterSpacing=t,this.update())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.update())}get padding(){return this._padding}set padding(t){this._padding!==t&&(this._padding=t,this.update())}get filters(){return this._filters}set filters(t){this._filters!==t&&(this._filters=Object.freeze(t),this.update())}get trim(){return this._trim}set trim(t){this._trim!==t&&(this._trim=t,this.update())}get textBaseline(){return this._textBaseline}set textBaseline(t){this._textBaseline!==t&&(this._textBaseline=t,this.update())}get whiteSpace(){return this._whiteSpace}set whiteSpace(t){this._whiteSpace!==t&&(this._whiteSpace=t,this.update())}get wordWrap(){return this._wordWrap}set wordWrap(t){this._wordWrap!==t&&(this._wordWrap=t,this.update())}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(t){this._wordWrapWidth!==t&&(this._wordWrapWidth=t,this.update())}get fill(){return this._originalFill}set fill(t){t!==this._originalFill&&(this._originalFill=t,this._isFillStyle(t)&&(this._originalFill=this._createProxy({...F.defaultFillStyle,...t},()=>{this._fill=N({...this._originalFill},F.defaultFillStyle)})),this._fill=N(t===0?"black":t,F.defaultFillStyle),this.update())}get stroke(){return this._originalStroke}set stroke(t){t!==this._originalStroke&&(this._originalStroke=t,this._isFillStyle(t)&&(this._originalStroke=this._createProxy({...F.defaultStrokeStyle,...t},()=>{this._stroke=$({...this._originalStroke},F.defaultStrokeStyle)})),this._stroke=$(t,F.defaultStrokeStyle),this.update())}update(){this._tick++,this.emit("update",this)}reset(){const t=v.defaultTextStyle;for(const e in t)this[e]=t[e]}get styleKey(){return`${this.uid}-${this._tick}`}clone(){return new v({align:this.align,breakWords:this.breakWords,dropShadow:this._dropShadow?{...this._dropShadow}:null,fill:this._fill,fontFamily:this.fontFamily,fontSize:this.fontSize,fontStyle:this.fontStyle,fontVariant:this.fontVariant,fontWeight:this.fontWeight,leading:this.leading,letterSpacing:this.letterSpacing,lineHeight:this.lineHeight,padding:this.padding,stroke:this._stroke,textBaseline:this.textBaseline,whiteSpace:this.whiteSpace,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth,filters:this._filters?[...this._filters]:void 0})}_getFinalPadding(){let t=0;if(this._filters)for(let e=0;e<this._filters.length;e++)t+=this._filters[e].padding;return Math.max(this._padding,t)}destroy(t=!1){if(this.removeAllListeners(),typeof t=="boolean"?t:t?.texture){const i=typeof t=="boolean"?t:t?.textureSource;this._fill?.texture&&this._fill.texture.destroy(i),this._originalFill?.texture&&this._originalFill.texture.destroy(i),this._stroke?.texture&&this._stroke.texture.destroy(i),this._originalStroke?.texture&&this._originalStroke.texture.destroy(i)}this._fill=null,this._stroke=null,this.dropShadow=null,this._originalStroke=null,this._originalFill=null}_createProxy(t,e){return new Proxy(t,{set:(i,r,n)=>(i[r]===n||(i[r]=n,e?.(r,n),this.update()),!0)})}_isFillStyle(t){return(t??null)!==null&&!(B.isColorLike(t)||t instanceof I||t instanceof O)}};H.defaultDropShadow={alpha:1,angle:Math.PI/6,blur:0,color:"black",distance:5};H.defaultTextStyle={align:"left",breakWords:!1,dropShadow:null,fill:"black",fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",leading:0,letterSpacing:0,lineHeight:0,padding:0,stroke:null,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100};let ct=H;function ft(l){const t=l;if(typeof t.dropShadow=="boolean"&&t.dropShadow){const e=ct.defaultDropShadow;l.dropShadow={alpha:t.dropShadowAlpha??e.alpha,angle:t.dropShadowAngle??e.angle,blur:t.dropShadowBlur??e.blur,color:t.dropShadowColor??e.color,distance:t.dropShadowDistance??e.distance}}if(t.strokeThickness!==void 0){G(V,"strokeThickness is now a part of stroke");const e=t.stroke;let i={};if(B.isColorLike(e))i.color=e;else if(e instanceof I||e instanceof O)i.fill=e;else if(Object.hasOwnProperty.call(e,"color")||Object.hasOwnProperty.call(e,"fill"))i=e;else throw new Error("Invalid stroke value.");l.stroke={...i,width:t.strokeThickness}}if(Array.isArray(t.fillGradientStops)){if(G(V,"gradient fill is now a fill pattern: `new FillGradient(...)`"),!Array.isArray(t.fill)||t.fill.length===0)throw new Error("Invalid fill value. Expected an array of colors for gradient fill.");t.fill.length!==t.fillGradientStops.length&&Z("The number of fill colors must match the number of fill gradient stops.");const e=new I({start:{x:0,y:0},end:{x:0,y:1},textureSpace:"local"}),i=t.fillGradientStops.slice(),r=t.fill.map(n=>B.shared.setValue(n).toNumber());i.forEach((n,o)=>{e.addColorStop(n,r[o])}),l.fill={fill:e}}}const q=1e5;function U(l,t,e,i=0){if(l.texture===at.WHITE&&!l.fill)return B.shared.setValue(l.color).setAlpha(l.alpha??1).toHexa();if(l.fill){if(l.fill instanceof O){const r=l.fill,n=t.createPattern(r.texture.source.resource,"repeat"),o=r.transform.copyTo(j.shared);return o.scale(r.texture.frame.width,r.texture.frame.height),n.setTransform(o),n}else if(l.fill instanceof I){const r=l.fill,n=r.type==="linear",o=r.textureSpace==="local";let s=1,d=1;o&&e&&(s=e.width+i,d=e.height+i);let h,c=!1;if(n){const{start:f,end:u}=r;h=t.createLinearGradient(f.x*s,f.y*d,u.x*s,u.y*d),c=Math.abs(u.x-f.x)<Math.abs((u.y-f.y)*.1)}else{const{center:f,innerRadius:u,outerCenter:g,outerRadius:S}=r;h=t.createRadialGradient(f.x*s,f.y*d,u*s,g.x*s,g.y*d,S*s)}if(c&&o&&e){const f=e.lineHeight/d;for(let u=0;u<e.lines.length;u++){const g=(u*e.lineHeight+i/2)/d;r.colorStops.forEach(S=>{const _=g+S.offset*f;h.addColorStop(Math.floor(_*q)/q,B.shared.setValue(S.color).toHex())})}}else r.colorStops.forEach(f=>{h.addColorStop(f.offset,B.shared.setValue(f.color).toHex())});return h}}else{const r=t.createPattern(l.texture.source.resource,"repeat"),n=l.matrix.copyTo(j.shared);return n.scale(l.texture.frame.width,l.texture.frame.height),r.setTransform(n),r}return Z("FillStyle not recognised",l),"red"}let L=null,T=null;function dt(l,t){L||(L=M.get().createCanvas(256,128),T=L.getContext("2d",{willReadFrequently:!0}),T.globalCompositeOperation="copy",T.globalAlpha=1),(L.width<l||L.height<t)&&(L.width=Y(l),L.height=Y(t))}function X(l,t,e){for(let i=0,r=4*e*t;i<t;++i,r+=4)if(l[r+3]!==0)return!1;return!0}function J(l,t,e,i,r){const n=4*t;for(let o=i,s=i*n+4*e;o<=r;++o,s+=n)if(l[s+3]!==0)return!1;return!0}function ut(...l){let t=l[0];t.canvas||(t={canvas:l[0],resolution:l[1]});const{canvas:e}=t,i=Math.min(t.resolution??1,1),r=t.width??e.width,n=t.height??e.height;let o=t.output;if(dt(r,n),!T)throw new TypeError("Failed to get canvas 2D context");T.drawImage(e,0,0,r,n,0,0,r*i,n*i);const d=T.getImageData(0,0,r,n).data;let h=0,c=0,f=r-1,u=n-1;for(;c<n&&X(d,r,c);)++c;if(c===n)return R.EMPTY;for(;X(d,r,u);)--u;for(;J(d,r,h,c,u);)++h;for(;J(d,r,f,c,u);)--f;return++f,++u,T.globalCompositeOperation="source-over",T.strokeRect(h,c,f-h,u-c),T.globalCompositeOperation="copy",o??(o=new R),o.set(h/i,c/i,(f-h)/i,(u-c)/i),o}const Q=new R;class pt{getCanvasAndContext(t){const{text:e,style:i,resolution:r=1}=t,n=i._getFinalPadding(),o=E.measureText(e||" ",i),s=Math.ceil(Math.ceil(Math.max(1,o.width)+n*2)*r),d=Math.ceil(Math.ceil(Math.max(1,o.height)+n*2)*r),h=K.getOptimalCanvasAndContext(s,d);this._renderTextToCanvas(e,i,n,r,h);const c=i.trim?ut({canvas:h.canvas,width:s,height:d,resolution:1,output:Q}):Q.set(0,0,s,d);return{canvasAndContext:h,frame:c}}returnCanvasAndContext(t){K.returnCanvasAndContext(t)}_renderTextToCanvas(t,e,i,r,n){const{canvas:o,context:s}=n,d=tt(e),h=E.measureText(t||" ",e),c=h.lines,f=h.lineHeight,u=h.lineWidths,g=h.maxLineWidth,S=h.fontProperties,_=o.height;if(s.resetTransform(),s.scale(r,r),s.textBaseline=e.textBaseline,e._stroke?.width){const x=e._stroke;s.lineWidth=x.width,s.miterLimit=x.miterLimit,s.lineJoin=x.join,s.lineCap=x.cap}s.font=d;let w,p;const W=e.dropShadow?2:1;for(let x=0;x<W;++x){const k=e.dropShadow&&x===0,y=k?Math.ceil(Math.max(1,_)+i*2):0,P=y*r;if(k){s.fillStyle="black",s.strokeStyle="black";const m=e.dropShadow,et=m.color,it=m.alpha;s.shadowColor=B.shared.setValue(et).setAlpha(it).toRgbaString();const rt=m.blur*r,D=m.distance*r;s.shadowBlur=rt,s.shadowOffsetX=Math.cos(m.angle)*D,s.shadowOffsetY=Math.sin(m.angle)*D+P}else{if(s.fillStyle=e._fill?U(e._fill,s,h,i*2):null,e._stroke?.width){const m=e._stroke.width*.5+i*2;s.strokeStyle=U(e._stroke,s,h,m)}s.shadowColor="black"}let b=(f-S.fontSize)/2;f-S.fontSize<0&&(b=0);const z=e._stroke?.width??0;for(let m=0;m<c.length;m++)w=z/2,p=z/2+m*f+S.ascent+b,e.align==="right"?w+=g-u[m]:e.align==="center"&&(w+=(g-u[m])/2),e._stroke?.width&&this._drawLetterSpacing(c[m],e,n,w+i,p+i-y,!0),e._fill!==void 0&&this._drawLetterSpacing(c[m],e,n,w+i,p+i-y)}}_drawLetterSpacing(t,e,i,r,n,o=!1){const{context:s}=i,d=e.letterSpacing;let h=!1;if(E.experimentalLetterSpacingSupported&&(E.experimentalLetterSpacing?(s.letterSpacing=`${d}px`,s.textLetterSpacing=`${d}px`,h=!0):(s.letterSpacing="0px",s.textLetterSpacing="0px")),d===0||h){o?s.strokeText(t,r,n):s.fillText(t,r,n);return}let c=r;const f=E.graphemeSegmenter(t);let u=s.measureText(t).width,g=0;for(let S=0;S<f.length;++S){const _=f[S];o?s.strokeText(_,c,n):s.fillText(_,c,n);let w="";for(let p=S+1;p<f.length;++p)w+=f[p];g=s.measureText(w).width,c+=u-g+d,u=g}}}const xt=new pt;export{xt as C,ct as T,E as a,tt as f,U as g,lt as l};
