import{j as e,r as p}from"./index-DtOve7kp.js";import{au as Y,a7 as w,B as x,C as Q,r as N,z as xe,S as he,f as fe,L as ee,a8 as b,av as A,a6 as D,aw as ge,ax as te,P as M,ay as ye,A as je,az as ve,aA as be,Z as se,aB as we,aC as $,c as ke,e as H,aD as Ne,aE as Se,aF as Ce,R as oe,aG as Te,ai as Ie,aH as Re,I as B,aI as R,ao as F,o as Pe,aJ as $e,at as Be,aK as Ee,aL as ze,aM as Ae,aN as _e,aO as Me}from"./App-ClVSgBfp.js";import{B as ne,g as Le,h as De,i as He,j as re,C as Fe,R as Oe,S as Ue}from"./RoomSelect-DcnD5_nk.js";import{useAppSelectorWithLevelEditorSlice as v,selectTool as T,setTool as ae,selectCurrentEditingRoomColour as Je,changeRoomColour as O,selectCurrentEditingRoomScenery as Ze,changeRoomScenery as Xe,selectCanUndo as Ge,selectCanRedo as We,undo as ie,redo as ce,changeToRoom as Ke,selectCurrentEditingRoomJson as U,setSelectedItemInRoom as qe,applyToolToRoomJson as Ve,deleteSelected as Ye,selectSelectedJsonItemIds as Qe}from"./levelEditorSlice-BS8OixET.js";import{c as et,A as tt,s as st,R as ot,i as nt,z as rt,a as at,p as le}from"./roomRenderer-DjPxdclg.js";import"./Graphics-CXwOTiJQ.js";import"./changeCharacterRoom-BWSbIcxx.js";const L=t=>t,_="h-[calc(3*var(--block)-1px*var(--scale))] w-[calc(3*var(--block)-1px*var(--scale))]",I=({className:t,onClick:s,children:o,disabled:n=!1,isCurrentTool:a=!1})=>e.jsx(ne,{disabled:n,"data-iscurrenttool":a,className:`active:pt-oneScaledPix ${_} gap-0 inline-flex overflow-hidden ${a?"bg-pastelBlue":""} ${n?"bg-midGrey text-lightGrey":""} ${t??""}`,onClick:s,children:o}),i=({itemTool:t,children:s,className:o})=>{const n=v(T),a=Y(n?.type==="item"&&n.item,t);return e.jsx(I,{isCurrentTool:a,className:o,onClick:()=>w.dispatch(ae({type:"item",item:t})),children:s})},E=({children:t})=>{const[s,o]=p.useState(!1),[n,a]=p.useState(0),c=t[n];return e.jsxs(Le,{open:s,onOpenChange:o,children:[e.jsxs("div",{className:`${_} relative`,children:[c,e.jsx(De,{asChild:!0,children:e.jsx(ne,{className:"absolute bottom-0 right-0 bg-metallicBlueHalfbrite",children:e.jsx(x,{className:"pl-oneScaledPix",children:"⬇"})})})]}),e.jsx(He,{children:e.jsx(Q,{scaleFactor:2,children:e.jsx("div",{className:"flex flex-col gap-oneScaledPix py-oneScaledPix bg-metallicBlueHalfbrite",children:t.map((d,u)=>u===n?null:e.jsx("div",{className:_,onClick:()=>{a(u),o(!1)},children:d},u))})})})]})},it=()=>{const s=v(T)?.type==="pointer";return e.jsx(I,{onClick:()=>w.dispatch(ae({type:"pointer"})),isCurrentTool:s,children:e.jsx("span",{className:"sprite texture-hud.char.↖ relative"})})},J=t=>{const{main:s}=et[t].basic;return{backgroundColor:s.basic.toHex(),borderColor:s.dimmed.toHex()}};function ct(){const t=N(),s=v(Je);return e.jsxs(e.Fragment,{children:[e.jsx(re,{value:s.hue,onSelect:o=>{t(O({hue:o}))},values:xe,disableCommandInput:!0,OptionCommandItem:({value:o,onSelect:n})=>e.jsx(Fe,{value:o,className:"border-1 h-4 w-2",style:J(o),onSelect:n}),triggerButtonLabel:e.jsx(x,{children:"colour"}),triggerButtonClassName:L(`${s.hue==="white"?"text-pureBlack":"text-white"}`),triggerButtonStyle:J(s.hue)}),e.jsx(he,{value:s.shade==="basic",onClick:(o,n)=>{t(O({shade:n?"basic":"dimmed"}))},falseLabel:"dimmed",trueLabel:"basic"})]})}function lt(){const t=N(),s=v(Ze);return e.jsx(re,{value:s,onSelect:o=>{t(Xe(o))},values:fe,disableCommandInput:!0,triggerButtonClassName:"w-18 text-white",triggerButtonLabel:e.jsx(x,{children:s})})}const Z="[button:not(:disabled):hover_&]:hidden mt-quarter",X="hidden [button:not(:disabled):hover_&]:inline mt-quarter",G="hidden [button:not(:disabled):hover_&]:inline",dt=()=>{const t=N(),s=v(Ge),o=v(We);return e.jsxs(e.Fragment,{children:[e.jsxs(I,{disabled:!s,className:"flex-col",onClick:()=>{t(ie())},children:[e.jsx(x,{className:Z,children:"⬅"}),e.jsx(x,{className:X,children:"Un"}),e.jsx(x,{className:G,children:"do"})]}),e.jsxs(I,{disabled:!o,className:"flex-col",onClick:()=>{t(ce())},children:[e.jsx(x,{className:Z,children:"➡"}),e.jsx(x,{className:X,children:"Re"}),e.jsx(x,{className:G,children:"do"})]})]})},r=L("[button:not([data-iscurrenttool=true]):not(:hover)_&]:sprite-revert-to-two-tone"),y=L("flex flex-wrap gap-oneScaledPix w-full"),ut=()=>{const t=v(o=>o.levelEditor.campaignInProgress),s=N();return e.jsxs("div",{className:"flex fixed top-0 bottom-0 right-0 w-12 box-content text-white bg-metallicBlueHalfbrite p-half gap-1 flex-wrap justify-start overflow-auto",children:[e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"Campaign"}),e.jsx(Oe,{campaign:t,onRoomSelect:o=>{s(Ke(o))}})]}),e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"Room"}),e.jsx(lt,{}),e.jsx(ct,{})]}),e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"Edit"}),e.jsx(it,{}),e.jsx(dt,{})]}),e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"Monsters"}),e.jsx(i,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}},children:e.jsx("span",{className:`sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek" ${r}`})}),e.jsx(i,{itemTool:{type:"monster",config:{which:"cyberman",activated:"on",movement:"towards-on-shortest-axis-xy4",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-cyberman.towards [button:hover_&]:texture-cyberman.right ${r}`})}),e.jsx(i,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right ${r}`})}),e.jsx(i,{itemTool:{type:"monster",config:{which:"helicopterBug",activated:"on",movement:"patrol-randomly-xy8"}},children:e.jsx("span",{className:`sprite texture-helicopterBug.1 [button:hover_&]:texture-animated-helicopterBug ${r}`})}),e.jsx(i,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right ${r}`})}),e.jsx(i,{itemTool:{type:"monster",config:{which:"homingBot",activated:"on",movement:"towards-tripped-on-axis-xy4"}},children:e.jsx("span",{className:`sprite texture-headlessBase [button:hover_&]:texture-headlessBase.all ${r}`})}),e.jsx(i,{itemTool:{type:"monster",config:{which:"computerBot",activated:"on",movement:"patrol-randomly-xy4-and-reverse"}},children:e.jsx("span",{className:`sprite texture-computerBot.towards [button:hover_&]:texture-computerBot.right ${r}`})}),e.jsx(i,{itemTool:{type:"monster",config:{which:"monkey",activated:"on",movement:"patrol-randomly-xy4"}},children:e.jsx("span",{className:`sprite texture-monkey.towards [button:hover_&]:texture-monkey.right ${r}`})}),e.jsxs(i,{itemTool:{type:"monster",config:{which:"elephant",activated:"on",movement:"patrol-randomly-xy4"}},className:"inline relative",children:[e.jsx("span",{className:`sprite inline-block absolute left-0 texture-headlessBase ${r} [button:active_&]:top-oneScaledPix`}),e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-elephant.towards [button:hover_&]:texture-elephant.right ${r} [button:active_&]:top-oneScaledPix`})]}),e.jsx(i,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"turn-to-player",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-elephant.towards [button:hover_&]:texture-elephant.right ${r}`})}),e.jsxs(i,{itemTool:{type:"monster",config:{which:"emperorsGuardian",activated:"while-player-near",movement:"towards-analogue-unless-planet-crowns"}},className:"inline relative",children:[e.jsx("span",{className:`sprite inline-block absolute left-0 texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold ${r} [button:active_&]:top-oneScaledPix`}),e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-ball [button:hover_&]:texture-ball ${r} [button:active_&]:top-oneScaledPix`})]}),e.jsx(i,{itemTool:{type:"monster",config:{which:"emperor",activated:"while-player-near",movement:"towards-analogue"}},children:e.jsx("span",{className:`sprite texture-bubbles.cold.2 [button:hover_&]:texture-animated-bubbles.cold ${r}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"Blocks"}),e.jsx(i,{itemTool:{type:"block",config:{style:"artificial"}},children:e.jsx("span",{className:`sprite texture-block.artificial ${r}`})}),e.jsx(i,{itemTool:{type:"block",config:{style:"organic"}},children:e.jsx("span",{className:`sprite texture-block.organic ${r}`})}),e.jsx(i,{itemTool:{type:"block",config:{style:"tower"}},children:e.jsx("span",{className:`sprite texture-tower ${r}`})}),e.jsx(i,{itemTool:{type:"block",config:{style:"book"}},children:e.jsx("span",{className:`sprite texture-book.x ${r}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"Pickups"}),e.jsx(i,{itemTool:{type:"pickup",config:{gives:"extra-life"}},children:e.jsx("span",{className:`sprite texture-whiteRabbit ${r}`})}),e.jsx(i,{itemTool:{type:"pickup",config:{gives:"bag"}},children:e.jsx("span",{className:`sprite texture-bag ${r}`})}),e.jsx(i,{itemTool:{type:"pickup",config:{gives:"hooter"}},children:e.jsx("span",{className:`sprite texture-hooter ${r}`})}),e.jsx(i,{itemTool:{type:"pickup",config:{gives:"doughnuts"}},children:e.jsx("span",{className:`sprite texture-doughnuts ${r}`})}),e.jsx(i,{itemTool:{type:"pickup",config:{gives:"crown",planet:"blacktooth"}},children:e.jsx("span",{className:`sprite texture-crown.blacktooth ${r}`})}),e.jsx(i,{itemTool:{type:"pickup",config:{gives:"scroll",page:"blacktooth"}},children:e.jsx("span",{className:`sprite texture-scroll ${r}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"misc."}),e.jsxs(i,{itemTool:{type:"lift",config:{top:11,bottom:0}},className:"inline relative",children:[e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.static ${r} [button:active_&]:top-oneScaledPix`}),e.jsx("span",{className:`sprite inline-block absolute top-0 left-0 texture-lift.1 [button:hover_&]:texture-animated-lift ${r} [button:active_&]:top-oneScaledPix`})]}),e.jsxs(E,{children:[e.jsx(i,{itemTool:{type:"barrier",config:{axis:"x"}},children:e.jsx("span",{className:`sprite texture-barrier.x ${r}`})}),e.jsx(i,{itemTool:{type:"barrier",config:{axis:"y"}},children:e.jsx("span",{className:`sprite texture-barrier.y ${r}`})})]}),e.jsx(i,{itemTool:{type:"conveyor",config:{direction:"away"}},children:e.jsx("span",{className:`sprite texture-conveyor.y.1 [button:hover_&]:texture-animated-conveyor.x ${r}`})}),e.jsx(i,{itemTool:{type:"teleporter",config:{toRoom:"(placeholder)",toPosition:ee}},children:e.jsx("span",{className:`sprite texture-teleporter ${r}`})}),e.jsx(i,{itemTool:{type:"charles",config:b},children:e.jsx("span",{className:`sprite texture-charles.towards [button:hover_&]:texture-charles.right ${r}`})}),e.jsx(i,{itemTool:{type:"joystick",config:{controls:["(placeholder)"]}},children:e.jsx("span",{className:`sprite texture-joystick ${r}`})}),e.jsx(i,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:A}},children:e.jsx("span",{className:`sprite texture-switch.left [button:hover_&]:texture-switch.right ${r}`})}),e.jsx(i,{itemTool:{type:"ball",config:b},children:e.jsx("span",{className:`sprite texture-ball ${r}`})}),e.jsxs(E,{children:[e.jsx(i,{itemTool:{type:"portableBlock",config:{style:"cube"}},children:e.jsx("span",{className:`sprite texture-cube ${r}`})}),e.jsx(i,{itemTool:{type:"portableBlock",config:{style:"drum"}},children:e.jsx("span",{className:`sprite texture-drum ${r}`})}),e.jsx(i,{itemTool:{type:"portableBlock",config:{style:"sticks"}},children:e.jsx("span",{className:`sprite texture-sticks ${r}`})})]}),e.jsx(i,{itemTool:{type:"pushableBlock",config:{style:"stepStool"}},children:e.jsx("span",{className:`sprite texture-stepStool ${r}`})}),e.jsx(i,{itemTool:{type:"movingPlatform",config:{style:"sandwich",movement:"clockwise",activated:"on",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-sandwich ${r}`})}),e.jsx(i,{itemTool:{type:"spikes",config:b},children:e.jsx("span",{className:`sprite texture-spikes ${r}`})}),e.jsxs(E,{children:[e.jsx(i,{itemTool:{type:"deadlyBlock",config:{style:"volcano"}},children:e.jsx("span",{className:`sprite texture-volcano.1 [button:hover_&]:texture-animated-volcano ${r}`})}),e.jsx(i,{itemTool:{type:"deadlyBlock",config:{style:"toaster"}},children:e.jsx("span",{className:`sprite texture-toaster.off ${r}`})})]}),e.jsx(i,{itemTool:{type:"slidingBlock",config:{style:"puck"}},children:e.jsx("span",{className:`sprite texture-puck ${r}`})}),e.jsx(i,{itemTool:{type:"slidingDeadly",config:{style:"spikyBall",startingPhase:1}},children:e.jsx("span",{className:`sprite texture-spikyBall.1 [button:hover_&]:texture-spikyBall.2 ${r}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"Structure"}),e.jsx(i,{itemTool:{type:"door",config:{direction:"away",toRoom:"(placeholder)"}},children:e.jsx("span",{className:`sprite texture-door.frame.generic.x.whole ${r}`})}),e.jsx(i,{itemTool:{type:"wall",config:{direction:"away",tiles:["plain"]}},children:e.jsx("span",{className:`sprite texture-blacktooth.wall.plain.away ${r}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"Player"}),e.jsx(i,{itemTool:{type:"player",config:{which:"head"}},children:e.jsx("span",{className:`sprite texture-head.walking.towards.2 [button:hover_&]:texture-animated-head.walking.right ${r}`})}),e.jsx(i,{itemTool:{type:"player",config:{which:"heels"}},children:e.jsx("span",{className:`sprite texture-heels.walking.towards.2 [button:hover_&]:texture-animated-heels.walking.right ${r}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"NPC’s"}),e.jsx(i,{itemTool:{type:"sceneryPlayer",config:{which:"head",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-head.walking.towards.2 [button:hover_&]:texture-animated-head.walking.right ${r}`})}),e.jsx(i,{itemTool:{type:"sceneryPlayer",config:{which:"heels",startDirection:"towards"}},children:e.jsx("span",{className:`sprite texture-heels.walking.towards.2 [button:hover_&]:texture-animated-heels.walking.right ${r}`})})]}),e.jsxs("div",{className:y,children:[e.jsx(x,{className:"w-full",children:"debug"}),e.jsx(Ue,{})]})]})},de=p.createContext(null),mt=()=>{const[t,s]=p.useState(()=>D({roomJson:U(w.getState()),roomPickupsCollected:b,scrollsRead:b,isNewGame:!0})),o=v(U);return p.useEffect(()=>{const n=D({roomJson:o,roomPickupsCollected:b,scrollsRead:b,isNewGame:!0});s(n)},[o]),t},pt=({children:t})=>{const s=mt();return e.jsx(de,{value:s,children:t})},P=()=>{const t=p.useContext(de);if(t===null)throw new Error("no room state in context, or no context");return t},ue=p.createContext(null),xt=({children:t})=>{const[s,o]=p.useState(null);return p.useEffect(()=>{const n=new tt;return n.init({background:st.pureBlack,sharedTicker:!0}).then(()=>{o(n)}),()=>{}},[]),s===null?null:e.jsx(ue,{value:s,children:t})},k=()=>p.useContext(ue),ht=(t,s)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:s},soundSettings:{mute:!0},pixiRenderer:t,gameState:void 0,paused:!1,colourised:!0,upscale:te(w.getState()),editor:!0}),W=(t,s,o)=>new ot({room:t,general:ht(s,o)}),ft=()=>{const{renderer:t}=k(),s=ge();if(!t)throw new Error("this should never be falsey (typescript violation)");const o=P(),[n,a]=p.useState(()=>W(o,t,s));return p.useEffect(()=>{const c=W(o,t,s);return a(c),()=>{c.destroy()}},[o,t,s]),n},C="cursor",K=({room:t,pointingAt:s,valid:o,includeCursor:n,previewItems:a})=>{const{face:c,position:d}=s;for(const u of a)ye({room:t,item:u});if(n){const u=je(C,t.items);u?(u.state.position=d,u.state.face=c,u.state.valid=o):t.items[C]={type:"cursor",id:C,state:{...be(),face:c,position:d,valid:o},config:{},aabb:ve}}else delete t.items[C]},z=t=>{for(const s of M(t.items))s.isCursorPreview&&delete t.items[s.id]};let gt=0;const me=(t,s,o)=>{if(t.face==="up")return $(t.position);if(o.type==="door"){const a=s.items[t.itemId];if(a.type!=="wall")return;const{config:c,aabb:d,state:{position:u}}=a,f={x:1,y:1,...c.times},l=ke(H(c.direction)),m=H(c.direction);if(f[l]<2)return;const h=u[l],g=u[l]+d[l]-Ne,j=u.z,S=u.z+d.z-Se,pe={[l]:Math.max(Math.min(t.position[l],g),h),[m]:t.position[m],z:Math.max(Math.min(t.position.z,S),j)};return $(pe)}const n=Ce[t.face];return oe($(t.position),n)},q=(t,s,o)=>{const n=[...M(s.items).filter(f=>se(f)&&f.type!=="cursor"&&!f.isCursorPreview)],a=(f,l,m)=>{const h=Te(`cursor/${gt++}`,{type:f,config:l,position:m},s.roomJson).toArray();return h.forEach(g=>{g.isCursorPreview=!0}),h},c=me(t,s,o);if(c===void 0)return;if(o.type==="door"){const f=s.items[t.itemId];if(f.type!=="wall")return;const l=f.config.direction;return a("door",{...o.config,direction:l},c)}const d=a(o.type,o.config,c);return d.some(f=>{const l=we(f,n);return!nt(l)})?void 0:d},yt=({x:t,y:s})=>o=>{const{bottomCentre:n,topLeft:a,topRight:c}=le(o.state.position,o.aabb);return!(t<a.x||t>c.x||s<c.y-(c.x-t)/2||s<a.y-(t-a.x)/2||s>n.y-(t-n.x)/2||s>n.y-(n.x-t)/2)},jt=(t,{x:s,y:o},n)=>{if(n.type==="item"&&n.item.type==="door"&&t.type==="wall")return Ie(t.config.direction);const{bottomCentre:a,topLeft:c,topRight:d}=le(t.state.position,t.aabb);return o<c.y-(c.x-s)/2?o<d.y-(s-d.x)/2?"up":"right":s<a.x?"towards":"right"},V=t=>t.fixedZIndex!==void 0,vt=t=>{if(t.every(V))return t.toSorted((c,d)=>d.fixedZIndex-c.fixedZIndex).at(0);const s=t.filter(c=>!V(c));if(s.length===0)return;if(s.length===1)return s[0];const o=Object.fromEntries(s.map(c=>[c.id,c])),n=rt(o),{order:a}=at(n,o);return o[a[0]]},bt=({state:{position:t},aabb:s},o,n,a)=>{let c=ee,d;switch(o){case"up":c={z:s.z},d="xy";break;case"down":d="xy";break;case"towards":d="xz";break;case"away":c={y:s.y},d="xz";break;case"left":c={x:s.x},d="yz";break;case"right":d="yz";break;default:throw new Error('unexpected face "'+o+'"')}const u=Re(n,oe(t,c),d),l=a.type==="item"&&a.item.type==="door"?B.w:B.w/2,m=B.h,h=l/2,g=m/2;return{x:d==="yz"?Math.round(u.x/l)*l:Math.floor((u.x-h)/l)*l,y:d==="xz"?Math.round(u.y/l)*l:Math.floor((u.y-h)/l)*l,z:d==="xy"?Math.round(u.z/m)*m:Math.floor((u.z+g)/m)*m}},wt=t=>s=>{const o=se(s)&&s.type!=="cursor"&&!s.isCursorPreview;return t.type==="item"&&t.item.type==="door"?o&&s.type==="wall":o},kt=(t,s,o)=>{const n=vt(Array.from(M(s.items).filter(wt(o)).filter(yt(t))));if(n){const a=jt(n,t,o);return{itemId:n.id,face:a,position:bt(n,a,t,o)}}else return},Nt=(t,s)=>{const o=t.cssUpscale*t.gameEngineUpscale;return{x:s.x/o-t.gameEngineScreenSize.x/2,y:s.y/o-t.gameEngineScreenSize.y+16}},St=t=>{const s=k(),o=R(te),n=N(),a=P(),c=p.useRef(void 0);p.useEffect(()=>{if(s.stage.eventMode="none",t===null)return;const d=l=>{const m=Nt(o,l),h=T(w.getState()),g=kt(m,a,h);if(!Y(g,c.current))if(c.current=g,g!==void 0)switch(h.type){case"item":{const j=q(g,a,h.item),S=j!==void 0;z(a),K({room:a,pointingAt:g,valid:S,includeCursor:!S,previewItems:j??A});break}case"pointer":{z(a),K({room:a,pointingAt:g,valid:!0,includeCursor:!0,previewItems:A});const j=a.items[g.itemId]?.jsonItemId;a.editor={...a.editor,hoveredJsonItemId:j};break}}else z(a)},u=l=>{const m=T(w.getState());switch(m.type){case"item":{const h=c.current;if(h===void 0||q(h,a,m.item)===void 0)return;const j=a.items[h.itemId];n(Ve({blockPosition:me(h,a,m.item),pointedAtItem:{type:j.type,config:j.config,jsonItemId:j.jsonItemId}}));break}case"pointer":{const h=c.current;if(!h)return;const{jsonItemId:g}=a.items[h.itemId];n(qe({jsonItemId:g,additive:l.ctrlKey||l.metaKey}));break}}},f=l=>{const m=l.key;(m==="Backspace"||m==="Delete")&&n(Ye()),(m==="z"||m==="Z")&&(l.ctrlKey||l.metaKey)&&w.dispatch(l.shiftKey?ce():ie())};return t.addEventListener("mousemove",d),t.addEventListener("click",u),window.addEventListener("keyup",f),()=>{t.removeEventListener("mousemove",d),t.removeEventListener("click",u),window.removeEventListener("keyup",f)}},[s.stage,o,t,n,a])},Ct=t=>{const s=P();p.useEffect(()=>{let o=0;const n=({deltaMS:a})=>{if(t.destroyed)return;t.renderContext.room!==s&&console.warn("room renderer does not have the current room");const c=new Set(Pe(s.items));s.roomTime+=a,t.tick({deltaMS:a,movedItems:c,progression:o++})};return F.shared.add(n),()=>{F.shared.remove(n)}},[t,s])},Tt=t=>{const s=k();p.useEffect(()=>{if(t)return t.appendChild(s.canvas),()=>{t.removeChild(s.canvas)}},[t,s])},It=()=>{const t=k(),s=R(o=>o.upscale.upscale.gameEngineUpscale);t.stage.scale=s},Rt=()=>{const t=k(),s=R($e);p.useEffect(()=>{t.renderer?.resize(s.x,s.y)},[t.renderer,s])},Pt=t=>{const s=k(),[o]=p.useState(()=>new Be),n=R(Ee);p.useEffect(()=>{if(t.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return o.addChild(t.output.graphics),s.stage.addChild(o),()=>{s.stage.removeChild(o),o.removeChild(t.output.graphics)}},[t,s,o]),p.useEffect(()=>{o.x=n.x/2,o.y=n.y-16},[o,n])},$t=()=>{const t=P(),s=v(Qe);p.useEffect(()=>{t.editor||(t.editor={}),t.editor.selectedJsonItemId=s},[t,s])};Ae.defaultOptions.scaleMode="nearest";const Bt=()=>{const t=ft(),[s,o]=p.useState(null);Rt(),Pt(t),Ct(t),St(s),Tt(s),It(),$t();const n=ze();return e.jsx("div",{style:n,ref:o})},Ht=()=>(_e(),Me(),e.jsxs(e.Fragment,{children:[e.jsx("title",{children:"Hoh Editor"}),e.jsx(xt,{children:e.jsx(pt,{children:e.jsx(Bt,{})})}),e.jsx(Q,{scaleFactor:2,children:e.jsx(ut,{})})]}));export{Ht as default};
