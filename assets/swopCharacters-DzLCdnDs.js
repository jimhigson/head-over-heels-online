import{h as U,i as at,k as nt,j as k,l as rt,m as _,n as $,q as dt,t as u,u as v,x,y as O,A as K,B,D as Q,F as j,H as tt,I as ct,J as lt,K as E,L as ft,M as ht,N as ut,O as b,Q as pt,R as mt,S as N,W as H,X as yt,Y as vt,Z as gt,_ as w,$ as g,a0 as P,a1 as J,a2 as F,a3 as I,a4 as D,a5 as Ot,a6 as M,a7 as X}from"./App-D4EWYZoN.js";import{g as bt}from"./index-Bi2N_0XB.js";var z={},C={},L;function Tt(){if(L)return C;L=1;var t=U(),e=t.iterableCurry,i=t.callReturn;function s(n,r){var d=n[Symbol.iterator](),h=d.next(),p=h.value,l=h.done;return l?r:(i(d),p)}C.__firstOr=s;var o=e(s,{reduces:!0});return C.firstOr=o,C}var S;function wt(){if(S)return z;S=1;var t=U(),e=t.iterableCurry,i=Tt(),s=i.__firstOr;function o(r){return s(r,void 0)}z.__first=o;var n=e(o,{reduces:!0});return z.first=n,z}var R,V;function zt(){return V||(V=1,R=wt().first),R}var Ct=zt();const kt=bt(Ct),xt=(t,e)=>at(nt(t)).map(i=>e.items[i]);function et(t,e){return t===null?null:e.items[t]}const W=(t,e)=>{if(t.state.standingOnItemId!==null){const i=et(t.state.standingOnItemId,e);delete i.state.stoodOnBy[t.id],t.state.standingOnItemId=null}},it=({above:t,below:e})=>{t.state.standingOnItemId=e.id,e.state.stoodOnBy[t.id]=!0},T=({room:t,item:e})=>{const i=typeof e=="string"?t.items[e]:e;k(i)&&W(i,t);for(const s of xt(i.state.stoodOnBy,t))W(s,t);typeof e=="string"?delete t.items[e]:delete t.items[i.id]};let Pt=0;const At=({gameState:t,room:e,itemType:i,config:s,position:o})=>{const n={type:i,config:s,position:$},r=`${i}/${Pt++}`,d=kt(rt(r,n,e.roomJson,t.pickupsCollected[e.id]??_));if(d===void 0)throw console.error("failed to generate any items for json",r,n),new Error("failed to generate any items");return d.state.position=o,A({room:e,item:d}),d},A=({room:t,item:e})=>(t.items[e.id]=e,e),Rt=1e3/25,st=t=>{const e=dt.animations[t],i=e.length,{animationSpeed:s}=e;return i*Rt/s};st("bubbles.white");const Ft=st("head.fadeOut"),It=({touchedItem:t,room:e,gameState:i})=>{T({room:e,item:t});const s=At({itemType:"bubbles",config:{style:"white",was:t.type==="pickup"?{type:"pickup",gives:t.config.gives}:{type:"disappearing"}},position:$,room:e,gameState:i}),o=u(t.state.position,v(t.aabb,.5));s.state.position=x(o,v(s.aabb,.5)),s.state.expires=e.roomTime+Ft},Dt=(t,e)=>{const i=O(t.items).filter(K("hushPuppy"));for(const s of i)It({touchedItem:s,gameState:e,room:t})},Mt=.5,Y=(t,e,i,s)=>{const o=i.x+s.x-t.x,n=i.y+s.y-t.y,r=i.z+s.z-t.z,d=t.x+e.x-i.x,h=t.y+e.y-i.y,p=t.z+e.z-i.z,l=Math.abs(o)<Math.abs(d)?o:-d,m=Math.abs(n)<Math.abs(h)?n:-h,a=Math.abs(r)<Math.abs(p)?r:-p,c=Math.abs(l),f=Math.abs(m),y=Math.abs(a)*Mt;return c<f&&c<y?{x:l,y:0,z:0}:f<y?{x:0,y:m,z:0}:{x:0,y:0,z:a}},Z=(t,e)=>({x:t.x>0?e.state.position.x:e.state.position.x+e.aabb.x,y:t.y>0?e.state.position.y:e.state.position.y+e.aabb.y,z:t.z>0?e.state.position.z:e.state.position.z+e.aabb.z}),G={stopAutowalk:5,portal:5,wall:5,doorLegs:5,sceneryPlayer:5,bubbles:5,switch:10,doorFrame:15,ball:18,block:20,barrier:20,floor:20,floorEdge:20,hushPuppy:20,teleporter:20,lift:30,movingPlatform:30,pushableBlock:30,portableBlock:30,slidingBlock:30,spring:30,joystick:40,charles:40,conveyor:40,head:50,heels:50,headOverHeels:50,pickup:80,firedDoughnut:90,spikes:98,slidingDeadly:100,moveableDeadly:100,deadlyBlock:100,monster:100},Wt=(t,e)=>G[t.type]-G[e.type],_t=(t,e)=>e.toSorted((i,s)=>{const o=Wt(i,s);if(o!==0)return o;const n=B(t,Z(t,i)),r=B(t,Z(t,s));return Math.abs(n-r)<1e-4?i.id<s.id?-1:1:n-r}),ot=({subjectItem:t,posDelta:e,gameState:i,room:s,pusher:o,deltaMS:n,forceful:r=K("lift")(t)&&o===void 0,recursionDepth:d=0,onTouch:h})=>{if(Q(e,$))return;const{state:{position:p}}=t;if(t.state.position=u(p,e),k(t)){const{actedOnAt:a}=t.state;a.roomTime===s.roomTime?o&&(a.by[o.id]=!0):(a.by=o?{[o.id]:!0}:{},a.roomTime=s.roomTime)}const l=_t(e,j(t,tt(s.items)));let m=!1;for(const a of l){if(!ct(t,a))continue;if(k(t)){const{collidedWith:y}=t.state;y.roomTime===s.roomTime?o&&(y.by[a.id]=!0):(y.by={[a.id]:!0},y.roomTime=s.roomTime)}const c=lt(a);if(o!==a&&!(m&&c)&&h!==void 0&&(h({movingItem:t,touchedItem:a,movementVector:x(t.state.position,p),gameState:i,deltaMS:n,room:s}),m=m||c),s.items[t.id]===void 0)return;if(s.items[a.id]===void 0||!E(a,t)||!E(t))continue;const f=Y(t.state.position,t.aabb,a.state.position,a.aabb);if(ft(t,a,r)&&a!==o){const y=r||ut(a)?-1:-.5,q=v(f,y);if(t.state.position=u(t.state.position,f,q),d<ht&&ot({subjectItem:a,posDelta:q,pusher:t,gameState:i,room:s,deltaMS:n,forceful:r,recursionDepth:d+1,onTouch:h}),s.items[a.id]===void 0)continue;t.state.position=u(t.state.position,Y(t.state.position,t.aabb,a.state.position,a.aabb))}else t.state.position=u(t.state.position,f);k(t)&&f.z>0&&(t.state.standingOnItemId===null||!l.includes(et(t.state.standingOnItemId,s)))&&(W(t,s),it({above:t,below:a}))}},$t=(t,e,{changeType:i,sourceItem:s})=>{switch(i){case"portal":return O(t.items).find(o=>w(o)&&o.config.toRoom===e.id&&Q(v(s.config.direction,-1),o.config.direction));case"level-select":return O(t.items).find(o=>w(o)&&o.config.toRoom===e.id&&o.config.direction.z===0)??O(t.items).find(o=>w(o)&&o.config.direction.z===0)??O(t.items).find(o=>w(o)&&o.config.direction.z>0)??O(t.items).find(w)}},Ht=(t,e,i,s)=>{const o=1*H.w;t.state.position=u(t.state.position,v(e,o));for(let n=0;n<o;n++)ot({subjectItem:t,posDelta:v(e,-1),gameState:i,room:s,deltaMS:16,forceful:!0,onTouch:void 0})},Vt=t=>{const{playableItem:e,gameState:i,toRoomId:s,changeType:o,sourceItem:n}=t,r=i.characterRooms[e.id];if(r===void 0)throw new Error(`${e.id} is not in a room on the gameState`);if(s===r.id)throw new Error(`Can't move ${e.id} to the same room "${s}""`);let d;switch(o){case"portal":{const{config:{relativePoint:c},state:{position:f}}=n;d=x(e.state.position,u(f,c));break}case"teleport":{const{state:{position:c}}=n;d=x(e.state.position,c);break}case"level-select":d={x:0,y:0,z:0};break;default:throw new Error}const h=e.type==="headOverHeels"?void 0:i.characterRooms[b(e.id)],p=i.campaign.rooms[s];if(p===void 0)throw new Error(`room ${s} does not exist in campaign`);const l=h?.id===s?h:pt({roomJson:p,roomPickupsCollected:i.pickupsCollected[s]??_});T({room:r,item:e});const m=mt(e);if(m!==void 0&&(m.carrying=null),e.state.latentMovement=[],(e.type==="head"||e.type==="headOverHeels")&&Dt(l,i),T({room:l,item:e}),l.items[e.id]=e,i.characterRooms[e.id]=l,t.changeType==="teleport"){const{config:{toPosition:c}}=t.sourceItem;e.state.position=u(N(c),d)}else{const c=$t(l,r,t);if(console.log("putting",e.id,"into",s,"at portal",c,"because",o,"sourceportal",n),c===void 0)if(t.changeType==="level-select")e.state.position=N({x:1,y:1,z:8});else throw new Error(`trying to move ${e.id} from ${r.id} --to-> ${s} but no destination portal found to locate with`);else{e.state.position=u(c.state.position,c.config.relativePoint,d,o==="portal"&&n.config.direction.z>0?{z:H.h}:{});const{config:{direction:f}}=c;f.z===0&&(e.state.autoWalk=!0,e.state.facing=v(f,-1),e.state.action==="idle"&&(e.state.action="moving"),Ht(e,f,i,l))}}const a=j(e,tt(l.items));a.length>0&&console.warn("on entering room",s,"character",e.id,"at",e.state.position,"collides with",a),i.entryState[e.id]=yt(e),e.id==="headOverHeels"?(delete i.entryState.head,delete i.entryState.heels):(i.entryState[b(e.id)]||(i.entryState[b(e.id)]=i.entryState.headOverHeels),delete i.entryState.headOverHeels),vt.dispatch(gt(s))},qt=t=>{const e=g(t,"head"),i=g(t,"heels");return e!==void 0&&i!==void 0&&e.state.action==="idle"&&i.state.action==="idle"&&e.state.standingOnItemId==="heels"},Bt=t=>{const e={id:"head",type:"head",...M,...X,state:{...D(),...I(),...F(),...t.state.head,facing:t.state.facing,position:u(t.state.position,{z:H.h}),switchedToAt:P,actedOnAt:t.state.actedOnAt,collidedWith:t.state.collidedWith}},i={id:"heels",type:"heels",...M,...X,state:{...D(),...I(),...F(),...t.state.heels,facing:t.state.facing,position:u(t.state.position),switchedToAt:P,actedOnAt:t.state.actedOnAt,collidedWith:t.state.collidedWith}};return{head:e,heels:i}},Et=({head:t,heels:e})=>({id:"headOverHeels",type:"headOverHeels",...M,shadowCastTexture:e.shadowCastTexture,config:_,aabb:Ot,state:{...D(),...I(),...F(),position:e.state.position,action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:e.state.facing,actedOnAt:e.state.actedOnAt.roomTime>t.state.actedOnAt.roomTime?e.state.actedOnAt:t.state.actedOnAt,collidedWith:e.state.collidedWith.roomTime>t.state.collidedWith.roomTime?e.state.collidedWith:t.state.collidedWith,head:{...J(t.state,"hasHooter","doughnuts","doughnutLastFireTime","fastStepsStartedAtDistance","gameWalkDistance","lives","gameTime","shieldCollectedAt","lastDiedAt"),switchedToAt:P},heels:{...J(e.state,"hasBag","bigJumps","carrying","lives","gameTime","shieldCollectedAt","lastDiedAt"),switchedToAt:P}}}),Nt=t=>{const e=t.characterRooms.head,i=g(t,"head"),s=g(t,"heels"),o=Et({head:i,heels:s});T({room:e,item:"head"}),T({room:e,item:"heels"}),A({room:e,item:o}),t.previousPlayable=t.currentCharacterName,t.currentCharacterName="headOverHeels",t.characterRooms={head:void 0,heels:void 0,headOverHeels:e}},Jt=(t,e)=>{const i=t.characterRooms.headOverHeels,s=g(t,"headOverHeels"),o=e??b(t.previousPlayable),{head:n,heels:r}=Bt(s);T({room:i,item:"headOverHeels"}),A({room:i,item:n}),A({room:i,item:r}),it({above:n,below:r}),t.currentCharacterName=o,t.previousPlayable=void 0,t.characterRooms={head:i,heels:i,headOverHeels:void 0}},Xt=t=>{const e=g(t,t.currentCharacterName);e!==void 0&&(e.type==="headOverHeels"?(e.state.head.switchedToAt=e.state.head.gameTime,e.state.heels.switchedToAt=e.state.heels.gameTime):e.state.switchedToAt=e?.state.gameTime)},Yt=(t,e)=>{qt(t)&&(!e||e===t.currentCharacterName)?Nt(t):t.currentCharacterName==="headOverHeels"?Jt(t,e):(!e||e!==t.currentCharacterName)&&g(t,b(t.currentCharacterName))!==void 0&&(t.currentCharacterName=b(t.currentCharacterName)),Xt(t)};export{At as a,Wt as b,Vt as c,ot as d,et as e,Ft as f,it as g,It as h,T as i,A as j,xt as k,Et as l,Y as m,Dt as n,W as o,Rt as p,Yt as q,Tt as r,Nt as s,Bt as u};
