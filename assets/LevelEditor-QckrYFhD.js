import{j as n,r as a}from"./index-DaTcqSCl.js";import{X as y,Y as u,ad as L,W as S,ae as I,af as h,ag as W,x as O,C as R,ah as B,ai as H,aj as M,ak as U,al as Z,am as _,$ as D,a7 as w,o as F,an as J,ao as N,ac as G,ap as $,aq as q,ar as Y,as as V,at as K}from"./App-DG5Mu52L.js";import{B as Q}from"./button-B3lTEOi0.js";import{setTool as ee,selectCurrentEditingRoomJson as E,useAppSelectorWithLevelEditorSlice as te}from"./levelEditorSlice-CQh8bdsT.js";import{A as oe,s as se,R as re,z as ne,a as ie,p as T}from"./roomRenderer-B29fJpvj.js";import"./Graphics-CNj3iB4B.js";import"./changeCharacterRoom-B3bAF8ib.js";const ae=e=>e,ce=ae({door:"sprite texture-door.frame.generic.x.whole",ball:"sprite texture-ball",charles:"sprite texture-charles.towards [button:hover_&]:texture-charles.right",switch:"sprite texture-switch.left [button:hover_&]:texture-switch.right","monster[which=turtle]":"sprite texture-turtle.towards.1 [button:hover_&]:texture-animated-turtle.right","monster[which=dalek]":"sprite texture-dalek.1 [button:hover_&]:texture-animated-dalek","monster[which=elephantHead]":"sprite texture-elephant.towards [button:hover_&]:texture-elephant.right","monster[which=skiHead]":"sprite texture-skiHead.greenAndPink.towards [button:hover_&]:texture-skiHead.greenAndPink.right","block[style=organic]":"sprite texture-block.organic","block[style=artificial]":"sprite texture-block.artificial","block[style=book]":"sprite texture-book.x"}),c=({itemTool:e})=>{const t=ce[e.type==="monster"?`monster[which=${e.config.which}]`:e.type==="block"?`block[style=${e.config.style}]`:e.type];return n.jsx(Q,{className:"flex-1 h-min p-quarter grow-0",onClick:()=>y.dispatch(ee({type:"item",item:e})),children:n.jsx("span",{className:`${t} relative [button:active_&]:top-quarter`})})},le=()=>n.jsxs("div",{className:"fixed flex top-1 right-1 bg-metallicBlueHalfbrite p-half gap-half w-24 flex-wrap justify-start",children:[n.jsx(c,{itemTool:{type:"monster",config:{which:"dalek",movement:"patrol-randomly-diagonal",activated:"on"}}}),n.jsx(c,{itemTool:{type:"monster",config:{which:"turtle",activated:"on",movement:"clockwise",startDirection:"towards"}}}),n.jsx(c,{itemTool:{type:"monster",config:{which:"elephantHead",activated:"on",movement:"unmoving",startDirection:"towards"}}}),n.jsx(c,{itemTool:{type:"monster",config:{which:"skiHead",style:"greenAndPink",activated:"on",movement:"back-forth",startDirection:"towards"}}}),n.jsx(c,{itemTool:{type:"block",config:{style:"artificial"}}}),n.jsx(c,{itemTool:{type:"block",config:{style:"organic"}}}),n.jsx(c,{itemTool:{type:"block",config:{style:"book"}}}),n.jsx(c,{itemTool:{type:"charles",config:u}}),n.jsx(c,{itemTool:{type:"switch",config:{initialSetting:"left",type:"in-room",modifies:L}}}),n.jsx(c,{itemTool:{type:"ball",config:u}}),n.jsx(c,{itemTool:{type:"door",config:u}})]}),P=a.createContext(null),ue=()=>{const[e,t]=a.useState(()=>S({roomJson:E(y.getState()),roomPickupsCollected:u,scrollsRead:u,isNewGame:!0})),o=te(E);return a.useEffect(()=>{const s=S({roomJson:o,roomPickupsCollected:u,scrollsRead:u,isNewGame:!0});t(s)},[o]),e},de=({children:e})=>{const t=ue();return n.jsx(P,{value:t,children:e})},v=()=>{const e=a.useContext(P);if(e===null)throw new Error("no room state in context, or no context");return e},z=a.createContext(null),pe=({children:e})=>{const[t,o]=a.useState(null);return a.useEffect(()=>{const s=new oe;return s.init({background:se.redShadow,sharedTicker:!0}).then(()=>{o(s)}),()=>{}},[]),t===null?null:n.jsx(z,{value:t,children:e})},d=()=>a.useContext(z),me=e=>({displaySettings:{emulatedResolution:"amigaLowResPal"},soundSettings:{},pixiRenderer:e,gameState:void 0,paused:!1,colourised:!0,upscale:I(y.getState())}),k=(e,t)=>new re({room:e,general:me(t)}),fe=()=>{const{renderer:e}=d();if(!e)throw new Error("this should never be falsey (typescript violation)");const t=v(),[o,s]=a.useState(()=>k(t,e));return a.useEffect(()=>{const r=k(t,e);return s(r),()=>{r.destroy()}},[t,e]),o},g="cursor",m=D.w/2,C=m/2,ge=({x:e,y:t})=>o=>{const{bottomCentre:s,topLeft:r,topRight:i}=T(o.state.position,o.renderAabb??o.aabb);return!(e<r.x||e>i.x||t<i.y-(i.x-e)/2||t<r.y-(e-r.x)/2||t>s.y-(e-s.x)/2||t>s.y-(s.x-e)/2)},he=(e,{x:t,y:o})=>{const{bottomCentre:s,topLeft:r,topRight:i}=T(e.state.position,e.renderAabb??e.aabb);return o<r.y-(r.x-t)/2?o<i.y-(t-i.x)/2?"top":"right":t<s.x?"towards":"right"},j=e=>e.fixedZIndex!==void 0,xe=e=>{if(e.every(j))return e.toSorted((i,l)=>l.fixedZIndex-i.fixedZIndex).at(0);const t=e.filter(i=>!j(i));if(t.length===0)return;if(t.length===1)return t[0];const o=Object.fromEntries(t.map(i=>[i.id,i])),s=ne(o),{order:r}=ie(s,o);return o[r[0]]},ye=(e,t)=>{const o=R(e.state.position,{z:e.aabb.z}),s=B(o),r=H(t,s),i=M(r),l=R(o,i);return{x:Math.floor((l.x-C)/m)*m,y:Math.floor((l.y-C)/m)*m,z:l.z}},ve=(e,t)=>{console.log("moving cursor to",t);const{pointingToItemId:o,position:s}=t,r=U(g,e.items);r?(r.state.position=s,r.state.pointingToItemId=o):e.items[g]={type:"cursor",id:g,state:{..._(),position:s,pointingToItemId:o},config:{},aabb:Z}},A=e=>{delete e.items[g]},be=e=>{const t=d(),o=h(I),s=W(),r=v();a.useEffect(()=>{if(t.stage.eventMode="none",e===null)return;const i=l=>{const p=o.cssUpscale*o.gameEngineUpscale,x={x:l.x/p-o.gameEngineScreenSize.x/2,y:l.y/p-o.gameEngineScreenSize.y+16},f=xe(Array.from(O(r.items).filter(b=>b.type!=="cursor").filter(ge(x))));if(f)if(he(f,x)==="top"){const X=ye(f,x);ve(r,{position:X,pointingToItemId:f.id})}else A(r);else A(r)};return e.addEventListener("mousemove",i),()=>{e.removeEventListener("mousemove",i)}},[t.stage,o,e,s,r])},Se=e=>{const t=v();a.useEffect(()=>{const o=()=>{if(e.destroyed)return;e.renderContext.room!==t&&console.warn("room renderer does not have the current room");const s=new Set(F(t.items));e.tick({deltaMS:J,movedItems:s,progression:0})};return w.shared.add(o),()=>{w.shared.remove(o)}},[e,t])},Re=e=>{const t=d();a.useEffect(()=>{if(e)return e.appendChild(t.canvas),()=>{e.removeChild(t.canvas)}},[e,t])},we=()=>{const e=d(),t=h(o=>o.upscale.upscale.gameEngineUpscale);e.stage.scale=t},Ee=()=>{const e=d(),t=h(N);a.useEffect(()=>{e.renderer?.resize(t.x,t.y)},[e.renderer,t])},ke=e=>{const t=d(),[o]=a.useState(()=>new G),s=h($);a.useEffect(()=>{if(e.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return o.addChild(e.output.graphics),t.stage.addChild(o),()=>{t.stage.removeChild(o),o.removeChild(e.output.graphics)}},[e,t,o]),a.useEffect(()=>{o.x=s.x/2,o.y=s.y-16},[o,s])};Y.defaultOptions.scaleMode="nearest";const Ce=()=>{const e=fe(),[t,o]=a.useState(null);Ee(),ke(e),Se(e),be(t),Re(t),we();const s=q();return n.jsx("div",{style:s,ref:o})},Le=()=>(V(),K(),n.jsxs("div",{children:[n.jsx("title",{children:"Hoh Editor"}),n.jsx(pe,{children:n.jsx(de,{children:n.jsx(Ce,{})})}),n.jsx(le,{})]}));export{Le as default};
