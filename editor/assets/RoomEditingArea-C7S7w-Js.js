const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-DLB52Jln.js","assets/index-CqUEShwI.js","assets/index-CwN_hxQy.css","assets/colorToUniform-KTpA7KSL.js","assets/SharedSystems-ZUXiMjXL.js","assets/Graphics-D1q7VmkJ.js","assets/levelEditorSlice-C9rsr4wP.js","assets/RoomJson-CzBbw8EW.js","assets/LevelEditor-B41i93dt.js","assets/WebGLRenderer-O9NQHYfi.js"])))=>i.map(i=>d[i]);
import{a as Lo,b as br,g as Cr,A as Uo,I as qt,J as W,f as Zt,E as Re,e as Do,C as w,d as Pe,v as Me,a3 as P,D as Pt,aQ as mn,q as Sr,X as ie,F as X,T as ue,U as jo,M as Go,aR as de,V as Ir,aS as Ho,w as Mt,aT as Xo,aU as Vo,p as Wo,aV as kr,aW as R,av as C,aX as No,aY as qo,aZ as Zo,ab as tt,a_ as Yt,a$ as _t,ae as M,b0 as N,b1 as Yo,b2 as Jo,b3 as Jt,ad as Y,b4 as Ko,aq as Tr,ag as me,af as Qo,b5 as L,b6 as D,ah as es,at as _e,az as J,ay as ts,aN as At,aj as Ot,aL as Kt,b7 as zt,i as nt,ax as Qt,b8 as $e,b9 as Rr,ba as ns,ac as rt,bb as Pr,bc as en,bd as tn,be as ot,bf as K,bg as rs,bh as nn,ap as Ae,bi as os,aI as fe,as as rn,bj as Te,bk as ss,bl as Mr,bm as is,bn as as,aJ as cs,bo as ls,ao as Ve,bp as gn,o as us,bq as ds,br as hs,bs as ps,bt as fs,bu as ms}from"./index-CqUEShwI.js";import{p as b,u as gs,i as Z,a as xs,b as ys,c as _,s as _r,d as Ar,e as Or,f as on,g as We,h as vs,w as zr,j as ws,k as bs,r as Ft,l as xn,m as Cs,n as Fr,o as Br,q as Ss,t as Is,v as ut,x as $r,y as ks,z as Ts,A as Rs,B as Ps,C as Ee,D as dt,E as Ie,F as Ms,G as Er,H as Bt,I as _s,J as sn,K as Lr,L as As,M as Os,N as an,O as Ur,P as zs,Q as Ne,R as Fs,S as Bs,T as se,U as cn,V as st,W as $s,X as Es,Y as Ls,Z as Us,_ as yn,$ as Ds,a0 as vn,a1 as js,a2 as wn,a3 as Gs,a4 as Hs,a5 as Xs,a6 as Vs,a7 as Ws,a8 as Dr}from"./levelEditorSlice-C9rsr4wP.js";import{o as $t}from"./RoomJson-CzBbw8EW.js";import{s as g,a as Ns,i as qs,u as Zs,B as ht,T as bn,t as $,y as Ys,b as Js,c as jr,g as Ye,z as Gr,d as Ks,h as Cn,e as he,f as Hr,j as Qs,k as Xr,l as ei}from"./LevelEditor-B41i93dt.js";import{S as ti,G as V}from"./Graphics-D1q7VmkJ.js";var Le={},Sn;function ni(){if(Sn)return Le;Sn=1;var n=Lo(),e=n.mark(s),t=br(),r=t.wrapWithIterableIterator,o=t.ensureIterable;function s(){var a,c,l,u,p,h,d=arguments;return n.wrap(function(m){for(;;)switch(m.prev=m.next){case 0:for(a=d.length,c=new Array(a),l=0;l<a;l++)c[l]=d[l];u=0,p=c;case 2:if(!(u<p.length)){m.next=8;break}return h=p[u],m.delegateYield(o(h),"t0",5);case 5:u++,m.next=2;break;case 8:case"end":return m.stop()}},e)}Le.__concat=s;var i=r(s);return Le.concat=i,Le}var Ue={},In;function ri(){if(In)return Ue;In=1;function n(a,c){var l;if(typeof Symbol>"u"||a[Symbol.iterator]==null){if(Array.isArray(a)||(l=e(a))||c){l&&(a=l);var u=0,p=function(){};return{s:p,n:function(){return u>=a.length?{done:!0}:{done:!1,value:a[u++]}},e:function(v){throw v},f:p}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var h=!0,d=!1,f;return{s:function(){l=a[Symbol.iterator]()},n:function(){var v=l.next();return h=v.done,v},e:function(v){d=!0,f=v},f:function(){try{!h&&l.return!=null&&l.return()}finally{if(d)throw f}}}}function e(a,c){if(a){if(typeof a=="string")return t(a,c);var l=Object.prototype.toString.call(a).slice(8,-1);if(l==="Object"&&a.constructor&&(l=a.constructor.name),l==="Map"||l==="Set")return Array.from(a);if(l==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l))return t(a,c)}}function t(a,c){(c==null||c>a.length)&&(c=a.length);for(var l=0,u=new Array(c);l<c;l++)u[l]=a[l];return u}var r=br(),o=r.ensureIterable;function s(a){var c=o(a),l=0,u=n(c),p;try{for(u.s();!(p=u.n()).done;){var h=p.value;l++}}catch(d){u.e(d)}finally{u.f()}return l}Ue.__size=s;var i=s;return Ue.size=i,Ue}var pt,kn;function oi(){return kn||(kn=1,pt=ni().concat),pt}var si=oi();const Tn=Cr(si);var ft,Rn;function ii(){return Rn||(Rn=1,ft=ri().size),ft}var ai=ii();const Vr=Cr(ai),Wr=class Et extends Uo{constructor(e){e={...Et.defaultOptions,...e},super(e),this.enabled=!0,this._state=ti.for2d(),this.blendMode=e.blendMode,this.padding=e.padding,typeof e.antialias=="boolean"?this.antialias=e.antialias?"on":"off":this.antialias=e.antialias,this.resolution=e.resolution,this.blendRequired=e.blendRequired,this.clipToViewport=e.clipToViewport,this.addResource("uTexture",0,1)}apply(e,t,r,o){e.applyFilter(this,t,r,o)}get blendMode(){return this._state.blendMode}set blendMode(e){this._state.blendMode=e}static from(e){const{gpu:t,gl:r,...o}=e;let s,i;return t&&(s=qt.from(t)),r&&(i=W.from(r)),new Et({gpuProgram:s,glProgram:i,...o})}};Wr.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1,clipToViewport:!0};let Q=Wr;const Lt=[];Zt.handleByNamedList(Re.Environment,Lt);async function ci(n){if(!n)for(let e=0;e<Lt.length;e++){const t=Lt[e];if(t.value.test()){await t.value.load();return}}}let we;function li(){if(typeof we=="boolean")return we;try{we=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{we=!1}return we}var Nr=(n=>(n[n.NONE=0]="NONE",n[n.COLOR=16384]="COLOR",n[n.STENCIL=1024]="STENCIL",n[n.DEPTH=256]="DEPTH",n[n.COLOR_DEPTH=16640]="COLOR_DEPTH",n[n.COLOR_STENCIL=17408]="COLOR_STENCIL",n[n.DEPTH_STENCIL=1280]="DEPTH_STENCIL",n[n.ALL=17664]="ALL",n))(Nr||{});class ui{constructor(e){this.items=[],this._name=e}emit(e,t,r,o,s,i,a,c){const{name:l,items:u}=this;for(let p=0,h=u.length;p<h;p++)u[p][l](e,t,r,o,s,i,a,c);return this}add(e){return e[this._name]&&(this.remove(e),this.items.push(e)),this}remove(e){const t=this.items.indexOf(e);return t!==-1&&this.items.splice(t,1),this}contains(e){return this.items.indexOf(e)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const di=["init","destroy","contextChange","resolutionChange","resetState","renderEnd","renderStart","render","update","postrender","prerender"],qr=class Zr extends Do{constructor(e){super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=e.type,this.name=e.name,this.config=e;const t=[...di,...this.config.runners??[]];this._addRunners(...t),this._unsafeEvalCheck()}async init(e={}){const t=e.skipExtensionImports===!0?!0:e.manageImports===!1;await ci(t),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const r in this._systemsHash)e={...this._systemsHash[r].constructor.defaultOptions,...e};e={...Zr.defaultOptions,...e},this._roundPixels=e.roundPixels?1:0;for(let r=0;r<this.runners.init.items.length;r++)await this.runners.init.items[r].init(e);this._initOptions=e}render(e,t){let r=e;if(r instanceof w&&(r={container:r},t&&(Pe(Me,"passing a second argument is deprecated, please use render options instead"),r.target=t.renderTexture)),r.target||(r.target=this.view.renderTarget),r.target===this.view.renderTarget&&(this._lastObjectRendered=r.container,r.clearColor??(r.clearColor=this.background.colorRgba),r.clear??(r.clear=this.background.clearBeforeRender)),r.clearColor){const o=Array.isArray(r.clearColor)&&r.clearColor.length===4;r.clearColor=o?r.clearColor:P.shared.setValue(r.clearColor).toArray()}r.transform||(r.container.updateLocalTransform(),r.transform=r.container.localTransform),r.container.enableRenderGroup(),this.runners.prerender.emit(r),this.runners.renderStart.emit(r),this.runners.render.emit(r),this.runners.renderEnd.emit(r),this.runners.postrender.emit(r)}resize(e,t,r){const o=this.view.resolution;this.view.resize(e,t,r),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),r!==void 0&&r!==o&&this.runners.resolutionChange.emit(r)}clear(e={}){const t=this;e.target||(e.target=t.renderTarget.renderTarget),e.clearColor||(e.clearColor=this.background.colorRgba),e.clear??(e.clear=Nr.ALL);const{clear:r,clearColor:o,target:s}=e;P.shared.setValue(o??this.background.colorRgba),t.renderTarget.clear(s,r,P.shared.toArray())}get resolution(){return this.view.resolution}set resolution(e){this.view.resolution=e,this.runners.resolutionChange.emit(e)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...e){e.forEach(t=>{this.runners[t]=new ui(t)})}_addSystems(e){let t;for(t in e){const r=e[t];this._addSystem(r.value,r.name)}}_addSystem(e,t){const r=new e(this);if(this[t])throw new Error(`Whoops! The name "${t}" is already in use`);this[t]=r,this._systemsHash[t]=r;for(const o in this.runners)this.runners[o].add(r);return this}_addPipes(e,t){const r=t.reduce((o,s)=>(o[s.name]=s.value,o),{});e.forEach(o=>{const s=o.value,i=o.name,a=r[i];this.renderPipes[i]=new s(this,a?new a:null)})}destroy(e=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(e),Object.values(this.runners).forEach(t=>{t.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(e){return this.textureGenerator.generateTexture(e)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!li())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}resetState(){this.runners.resetState.emit()}};qr.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let Yr=qr,De;function hi(n){return De!==void 0||(De=(()=>{const e={stencil:!0,failIfMajorPerformanceCaveat:n??Yr.defaultOptions.failIfMajorPerformanceCaveat};try{if(!Pt.get().getWebGLRenderingContext())return!1;let r=Pt.get().createCanvas().getContext("webgl",e);const o=!!r?.getContextAttributes()?.stencil;if(r){const s=r.getExtension("WEBGL_lose_context");s&&s.loseContext()}return r=null,o}catch{return!1}})()),De}let je;async function pi(n={}){return je!==void 0||(je=await(async()=>{const e=Pt.get().getNavigator().gpu;if(!e)return!1;try{return await(await e.requestAdapter(n)).requestDevice(),!0}catch{return!1}})()),je}const Pn=["webgl","webgpu","canvas"];async function fi(n){let e=[];n.preference?(e.push(n.preference),Pn.forEach(s=>{s!==n.preference&&e.push(s)})):e=Pn.slice();let t,r={};for(let s=0;s<e.length;s++){const i=e[s];if(i==="webgpu"&&await pi()){const{WebGPURenderer:a}=await mn(async()=>{const{WebGPURenderer:c}=await import("./WebGPURenderer-DLB52Jln.js");return{WebGPURenderer:c}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));t=a,r={...n,...n.webgpu};break}else if(i==="webgl"&&hi(n.failIfMajorPerformanceCaveat??Yr.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:a}=await mn(async()=>{const{WebGLRenderer:c}=await import("./WebGLRenderer-O9NQHYfi.js");return{WebGLRenderer:c}},__vite__mapDeps([9,1,2,3,4,5,6,7,8]));t=a,r={...n,...n.webgl};break}else if(i==="canvas")throw r={...n},new Error("CanvasRenderer is not yet implemented")}if(delete r.webgpu,delete r.webgl,!t)throw new Error("No available renderer for the current environment");const o=new t;return await o.init(r),o}const Jr="8.8.1";class Kr{static init(){globalThis.__PIXI_APP_INIT__?.(this,Jr)}static destroy(){}}Kr.extension=Re.Application;class mi{constructor(e){this._renderer=e}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,Jr)}destroy(){this._renderer=null}}mi.extension={type:[Re.WebGLSystem,Re.WebGPUSystem],name:"initHook",priority:-10};const Qr=class Ut{constructor(...e){this.stage=new w,e[0]!==void 0&&Pe(Me,"Application constructor options are deprecated, please use Application.init() instead.")}async init(e){e={...e},this.renderer=await fi(e),Ut._plugins.forEach(t=>{t.init.call(this,e)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return Pe(Me,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(e=!1,t=!1){const r=Ut._plugins.slice(0);r.reverse(),r.forEach(o=>{o.destroy.call(this)}),this.stage.destroy(t),this.stage=null,this.renderer.destroy(e),this.renderer=null}};Qr._plugins=[];let eo=Qr;Zt.handleByList(Re.Application,eo._plugins);Zt.add(Kr);var to=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,gi=`
in vec2 vTextureCoord;

out vec4 finalColor;

uniform float uAlpha;
uniform sampler2D uTexture;

void main()
{
    finalColor =  texture(uTexture, vTextureCoord) * uAlpha;
}
`,Mn=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct AlphaUniforms {
  uAlpha:f32,
};

@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;

@group(1) @binding(0) var<uniform> alphaUniforms : AlphaUniforms;

struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>
  };

fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

fn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  
}

fn getSize() -> vec2<f32>
{
  return gfu.uGlobalFrame.zw;
}
  
@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition)
  );
}

@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
  @builtin(position) position: vec4<f32>
) -> @location(0) vec4<f32> {
 
    var sample = textureSample(uTexture, uSampler, uv);
    
    return sample * alphaUniforms.uAlpha;
}`;const no=class ro extends Q{constructor(e){e={...ro.defaultOptions,...e};const t=qt.from({vertex:{source:Mn,entryPoint:"mainVertex"},fragment:{source:Mn,entryPoint:"mainFragment"}}),r=W.from({vertex:to,fragment:gi,name:"alpha-filter"}),{alpha:o,...s}=e,i=new Sr({uAlpha:{value:o,type:"f32"}});super({...s,gpuProgram:t,glProgram:r,resources:{alphaUniforms:i}})}get alpha(){return this.resources.alphaUniforms.uniforms.uAlpha}set alpha(e){this.resources.alphaUniforms.uniforms.uAlpha=e}};no.defaultOptions={alpha:1};let xi=no;var yi=`
in vec2 vTextureCoord;
in vec4 vColor;

out vec4 finalColor;

uniform float uColorMatrix[20];
uniform float uAlpha;

uniform sampler2D uTexture;

float rand(vec2 co)
{
    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);
}

void main()
{
    vec4 color = texture(uTexture, vTextureCoord);
    float randomValue = rand(gl_FragCoord.xy * 0.2);
    float diff = (randomValue - 0.5) *  0.5;

    if (uAlpha == 0.0) {
        finalColor = color;
        return;
    }

    if (color.a > 0.0) {
        color.rgb /= color.a;
    }

    vec4 result;

    result.r = (uColorMatrix[0] * color.r);
        result.r += (uColorMatrix[1] * color.g);
        result.r += (uColorMatrix[2] * color.b);
        result.r += (uColorMatrix[3] * color.a);
        result.r += uColorMatrix[4];

    result.g = (uColorMatrix[5] * color.r);
        result.g += (uColorMatrix[6] * color.g);
        result.g += (uColorMatrix[7] * color.b);
        result.g += (uColorMatrix[8] * color.a);
        result.g += uColorMatrix[9];

    result.b = (uColorMatrix[10] * color.r);
       result.b += (uColorMatrix[11] * color.g);
       result.b += (uColorMatrix[12] * color.b);
       result.b += (uColorMatrix[13] * color.a);
       result.b += uColorMatrix[14];

    result.a = (uColorMatrix[15] * color.r);
       result.a += (uColorMatrix[16] * color.g);
       result.a += (uColorMatrix[17] * color.b);
       result.a += (uColorMatrix[18] * color.a);
       result.a += uColorMatrix[19];

    vec3 rgb = mix(color.rgb, result.rgb, uAlpha);

    // Premultiply alpha again.
    rgb *= result.a;

    finalColor = vec4(rgb, result.a);
}
`,_n=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct ColorMatrixUniforms {
  uColorMatrix:array<vec4<f32>, 5>,
  uAlpha:f32,
};


@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;
@group(1) @binding(0) var<uniform> colorMatrixUniforms : ColorMatrixUniforms;


struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>,
  };
  
fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition),
  );
}


@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
) -> @location(0) vec4<f32> {


  var c = textureSample(uTexture, uSampler, uv);
  
  if (colorMatrixUniforms.uAlpha == 0.0) {
    return c;
  }

 
    // Un-premultiply alpha before applying the color matrix. See issue #3539.
    if (c.a > 0.0) {
      c.r /= c.a;
      c.g /= c.a;
      c.b /= c.a;
    }

    var cm = colorMatrixUniforms.uColorMatrix;


    var result = vec4<f32>(0.);

    result.r = (cm[0][0] * c.r);
    result.r += (cm[0][1] * c.g);
    result.r += (cm[0][2] * c.b);
    result.r += (cm[0][3] * c.a);
    result.r += cm[1][0];

    result.g = (cm[1][1] * c.r);
    result.g += (cm[1][2] * c.g);
    result.g += (cm[1][3] * c.b);
    result.g += (cm[2][0] * c.a);
    result.g += cm[2][1];

    result.b = (cm[2][2] * c.r);
    result.b += (cm[2][3] * c.g);
    result.b += (cm[3][0] * c.b);
    result.b += (cm[3][1] * c.a);
    result.b += cm[3][2];

    result.a = (cm[3][3] * c.r);
    result.a += (cm[4][0] * c.g);
    result.a += (cm[4][1] * c.b);
    result.a += (cm[4][2] * c.a);
    result.a += cm[4][3];

    var rgb = mix(c.rgb, result.rgb, colorMatrixUniforms.uAlpha);

    rgb.r *= result.a;
    rgb.g *= result.a;
    rgb.b *= result.a;

    return vec4(rgb, result.a);
}`;class vi extends Q{constructor(e={}){const t=new Sr({uColorMatrix:{value:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],type:"f32",size:20},uAlpha:{value:1,type:"f32"}}),r=qt.from({vertex:{source:_n,entryPoint:"mainVertex"},fragment:{source:_n,entryPoint:"mainFragment"}}),o=W.from({vertex:to,fragment:yi,name:"color-matrix-filter"});super({...e,gpuProgram:r,glProgram:o,resources:{colorMatrixUniforms:t}}),this.alpha=1}_loadMatrix(e,t=!1){let r=e;t&&(this._multiply(r,this.matrix,e),r=this._colorMatrix(r)),this.resources.colorMatrixUniforms.uniforms.uColorMatrix=r,this.resources.colorMatrixUniforms.update()}_multiply(e,t,r){return e[0]=t[0]*r[0]+t[1]*r[5]+t[2]*r[10]+t[3]*r[15],e[1]=t[0]*r[1]+t[1]*r[6]+t[2]*r[11]+t[3]*r[16],e[2]=t[0]*r[2]+t[1]*r[7]+t[2]*r[12]+t[3]*r[17],e[3]=t[0]*r[3]+t[1]*r[8]+t[2]*r[13]+t[3]*r[18],e[4]=t[0]*r[4]+t[1]*r[9]+t[2]*r[14]+t[3]*r[19]+t[4],e[5]=t[5]*r[0]+t[6]*r[5]+t[7]*r[10]+t[8]*r[15],e[6]=t[5]*r[1]+t[6]*r[6]+t[7]*r[11]+t[8]*r[16],e[7]=t[5]*r[2]+t[6]*r[7]+t[7]*r[12]+t[8]*r[17],e[8]=t[5]*r[3]+t[6]*r[8]+t[7]*r[13]+t[8]*r[18],e[9]=t[5]*r[4]+t[6]*r[9]+t[7]*r[14]+t[8]*r[19]+t[9],e[10]=t[10]*r[0]+t[11]*r[5]+t[12]*r[10]+t[13]*r[15],e[11]=t[10]*r[1]+t[11]*r[6]+t[12]*r[11]+t[13]*r[16],e[12]=t[10]*r[2]+t[11]*r[7]+t[12]*r[12]+t[13]*r[17],e[13]=t[10]*r[3]+t[11]*r[8]+t[12]*r[13]+t[13]*r[18],e[14]=t[10]*r[4]+t[11]*r[9]+t[12]*r[14]+t[13]*r[19]+t[14],e[15]=t[15]*r[0]+t[16]*r[5]+t[17]*r[10]+t[18]*r[15],e[16]=t[15]*r[1]+t[16]*r[6]+t[17]*r[11]+t[18]*r[16],e[17]=t[15]*r[2]+t[16]*r[7]+t[17]*r[12]+t[18]*r[17],e[18]=t[15]*r[3]+t[16]*r[8]+t[17]*r[13]+t[18]*r[18],e[19]=t[15]*r[4]+t[16]*r[9]+t[17]*r[14]+t[18]*r[19]+t[19],e}_colorMatrix(e){const t=new Float32Array(e);return t[4]/=255,t[9]/=255,t[14]/=255,t[19]/=255,t}brightness(e,t){const r=[e,0,0,0,0,0,e,0,0,0,0,0,e,0,0,0,0,0,1,0];this._loadMatrix(r,t)}tint(e,t){const[r,o,s]=P.shared.setValue(e).toArray(),i=[r,0,0,0,0,0,o,0,0,0,0,0,s,0,0,0,0,0,1,0];this._loadMatrix(i,t)}greyscale(e,t){const r=[e,e,e,0,0,e,e,e,0,0,e,e,e,0,0,0,0,0,1,0];this._loadMatrix(r,t)}grayscale(e,t){this.greyscale(e,t)}blackAndWhite(e){const t=[.3,.6,.1,0,0,.3,.6,.1,0,0,.3,.6,.1,0,0,0,0,0,1,0];this._loadMatrix(t,e)}hue(e,t){e=(e||0)/180*Math.PI;const r=Math.cos(e),o=Math.sin(e),s=Math.sqrt,i=1/3,a=s(i),c=r+(1-r)*i,l=i*(1-r)-a*o,u=i*(1-r)+a*o,p=i*(1-r)+a*o,h=r+i*(1-r),d=i*(1-r)-a*o,f=i*(1-r)-a*o,m=i*(1-r)+a*o,v=r+i*(1-r),y=[c,l,u,0,0,p,h,d,0,0,f,m,v,0,0,0,0,0,1,0];this._loadMatrix(y,t)}contrast(e,t){const r=(e||0)+1,o=-.5*(r-1),s=[r,0,0,0,o,0,r,0,0,o,0,0,r,0,o,0,0,0,1,0];this._loadMatrix(s,t)}saturate(e=0,t){const r=e*2/3+1,o=(r-1)*-.5,s=[r,o,o,0,0,o,r,o,0,0,o,o,r,0,0,0,0,0,1,0];this._loadMatrix(s,t)}desaturate(){this.saturate(-1)}negative(e){const t=[-1,0,0,1,0,0,-1,0,1,0,0,0,-1,1,0,0,0,0,1,0];this._loadMatrix(t,e)}sepia(e){const t=[.393,.7689999,.18899999,0,0,.349,.6859999,.16799999,0,0,.272,.5339999,.13099999,0,0,0,0,0,1,0];this._loadMatrix(t,e)}technicolor(e){const t=[1.9125277891456083,-.8545344976951645,-.09155508482755585,0,11.793603434377337,-.3087833385928097,1.7658908555458428,-.10601743074722245,0,-70.35205161461398,-.231103377548616,-.7501899197440212,1.847597816108189,0,30.950940869491138,0,0,0,1,0];this._loadMatrix(t,e)}polaroid(e){const t=[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0];this._loadMatrix(t,e)}toBGR(e){const t=[0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0];this._loadMatrix(t,e)}kodachrome(e){const t=[1.1285582396593525,-.3967382283601348,-.03992559172921793,0,63.72958762196502,-.16404339962244616,1.0835251566291304,-.05498805115633132,0,24.732407896706203,-.16786010706155763,-.5603416277695248,1.6014850761964943,0,35.62982807460946,0,0,0,1,0];this._loadMatrix(t,e)}browni(e){const t=[.5997023498159715,.34553243048391263,-.2708298674538042,0,47.43192855600873,-.037703249837783157,.8609577587992641,.15059552388459913,0,-36.96841498319127,.24113635128153335,-.07441037908422492,.44972182064877153,0,-7.562075277591283,0,0,0,1,0];this._loadMatrix(t,e)}vintage(e){const t=[.6279345635605994,.3202183420819367,-.03965408211312453,0,9.651285835294123,.02578397704808868,.6441188644374771,.03259127616149294,0,7.462829176470591,.0466055556782719,-.0851232987247891,.5241648018700465,0,5.159190588235296,0,0,0,1,0];this._loadMatrix(t,e)}colorTone(e,t,r,o,s){e||(e=.2),t||(t=.15),r||(r=16770432),o||(o=3375104);const i=P.shared,[a,c,l]=i.setValue(r).toArray(),[u,p,h]=i.setValue(o).toArray(),d=[.3,.59,.11,0,0,a,c,l,e,0,u,p,h,t,0,a-u,c-p,l-h,0,0];this._loadMatrix(d,s)}night(e,t){e||(e=.1);const r=[e*-2,-e,0,0,0,-e,0,e,0,0,0,e,e*2,0,0,0,0,0,1,0];this._loadMatrix(r,t)}predator(e,t){const r=[11.224130630493164*e,-4.794486999511719*e,-2.8746118545532227*e,0*e,.40342438220977783*e,-3.6330697536468506*e,9.193157196044922*e,-2.951810836791992*e,0*e,-1.316135048866272*e,-3.2184197902679443*e,-4.2375030517578125*e,7.476448059082031*e,0*e,.8044459223747253*e,0,0,0,1,0];this._loadMatrix(r,t)}lsd(e){const t=[2,-.4,.5,0,0,-.5,2,-.4,0,0,-.4,-.5,3,0,0,0,0,0,1,0];this._loadMatrix(t,e)}reset(){const e=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0];this._loadMatrix(e,!1)}get matrix(){return this.resources.colorMatrixUniforms.uniforms.uColorMatrix}set matrix(e){this.resources.colorMatrixUniforms.uniforms.uColorMatrix=e}get alpha(){return this.resources.colorMatrixUniforms.uniforms.uAlpha}set alpha(e){this.resources.colorMatrixUniforms.uniforms.uAlpha=e}}class ge extends ie{constructor(...e){let t=e[0];Array.isArray(e[0])&&(t={textures:e[0],autoUpdate:e[1]});const{animationSpeed:r=1,autoPlay:o=!1,autoUpdate:s=!0,loop:i=!0,onComplete:a=null,onFrameChange:c=null,onLoop:l=null,textures:u,updateAnchor:p=!1,...h}=t,[d]=u;super({...h,texture:d instanceof X?d:d.texture}),this._textures=null,this._durations=null,this._autoUpdate=s,this._isConnectedToTicker=!1,this.animationSpeed=r,this.loop=i,this.updateAnchor=p,this.onComplete=a,this.onFrameChange=c,this.onLoop=l,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=u,o&&this.play()}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(ue.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(ue.shared.add(this.update,this,jo.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(e){this.stop(),this.currentFrame=e}gotoAndPlay(e){this.currentFrame=e,this.play()}update(e){if(!this._playing)return;const t=e.deltaTime,r=this.animationSpeed*t,o=this.currentFrame;if(this._durations!==null){let s=this._currentTime%1*this._durations[this.currentFrame];for(s+=r/60*1e3;s<0;)this._currentTime--,s+=this._durations[this.currentFrame];const i=Math.sign(this.animationSpeed*t);for(this._currentTime=Math.floor(this._currentTime);s>=this._durations[this.currentFrame];)s-=this._durations[this.currentFrame]*i,this._currentTime+=i;this._currentTime+=s/this._durations[this.currentFrame]}else this._currentTime+=r;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):o!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<o||this.animationSpeed<0&&this.currentFrame>o)&&this.onLoop(),this._updateTexture())}_updateTexture(){const e=this.currentFrame;this._previousFrame!==e&&(this._previousFrame=e,this.texture=this._textures[e],this.updateAnchor&&this.texture.defaultAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(){this.stop(),super.destroy(),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(e){const t=[];for(let r=0;r<e.length;++r)t.push(X.from(e[r]));return new ge(t)}static fromImages(e){const t=[];for(let r=0;r<e.length;++r)t.push(X.from(e[r]));return new ge(t)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(e){if(e[0]instanceof X)this._textures=e,this._durations=null;else{this._textures=[],this._durations=[];for(let t=0;t<e.length;t++)this._textures.push(e[t].texture),this._durations.push(e[t].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let e=Math.floor(this._currentTime)%this._textures.length;return e<0&&(e+=this._textures.length),e}set currentFrame(e){if(e<0||e>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${e}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const t=this.currentFrame;this._currentTime=e,t!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,!this._autoUpdate&&this._isConnectedToTicker?(ue.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(ue.shared.add(this.update,this),this._isConnectedToTicker=!0))}}class wi{constructor({matrix:e,observer:t}={}){this.dirty=!0,this._matrix=e??new Go,this.observer=t,this.position=new de(this,0,0),this.scale=new de(this,1,1),this.pivot=new de(this,0,0),this.skew=new de(this,0,0),this._rotation=0,this._cx=1,this._sx=0,this._cy=0,this._sy=1}get matrix(){const e=this._matrix;return this.dirty&&(e.a=this._cx*this.scale.x,e.b=this._sx*this.scale.x,e.c=this._cy*this.scale.y,e.d=this._sy*this.scale.y,e.tx=this.position.x-(this.pivot.x*e.a+this.pivot.y*e.c),e.ty=this.position.y-(this.pivot.x*e.b+this.pivot.y*e.d),this.dirty=!1),e}_onUpdate(e){this.dirty=!0,e===this.skew&&this.updateSkew(),this.observer?._onUpdate(this)}updateSkew(){this._cx=Math.cos(this._rotation+this.skew.y),this._sx=Math.sin(this._rotation+this.skew.y),this._cy=-Math.sin(this._rotation-this.skew.x),this._sy=Math.cos(this._rotation-this.skew.x),this.dirty=!0}toString(){return`[pixi.js/math:Transform position=(${this.position.x}, ${this.position.y}) rotation=${this.rotation} scale=(${this.scale.x}, ${this.scale.y}) skew=(${this.skew.x}, ${this.skew.y}) ]`}setFromMatrix(e){e.decompose(this),this.dirty=!0}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._onUpdate(this.skew))}}const oo=class qe extends Ir{constructor(...e){let t=e[0]||{};t instanceof X&&(t={texture:t}),e.length>1&&(Pe(Me,"use new TilingSprite({ texture, width:100, height:100 }) instead"),t.width=e[1],t.height=e[2]),t={...qe.defaultOptions,...t};const{texture:r,anchor:o,tilePosition:s,tileScale:i,tileRotation:a,width:c,height:l,applyAnchorToTexture:u,roundPixels:p,...h}=t??{};super({label:"TilingSprite",...h}),this.renderPipeId="tilingSprite",this.batched=!0,this.allowChildren=!1,this._anchor=new de({_onUpdate:()=>{this.onViewUpdate()}}),this.applyAnchorToTexture=u,this.texture=r,this._width=c??r.width,this._height=l??r.height,this._tileTransform=new wi({observer:{_onUpdate:()=>this.onViewUpdate()}}),o&&(this.anchor=o),this.tilePosition=s,this.tileScale=i,this.tileRotation=a,this.roundPixels=p??!1}static from(e,t={}){return typeof e=="string"?new qe({texture:Ho.get(e),...t}):new qe({texture:e,...t})}get uvRespectAnchor(){return Mt("uvRespectAnchor is deprecated, please use applyAnchorToTexture instead"),this.applyAnchorToTexture}set uvRespectAnchor(e){Mt("uvRespectAnchor is deprecated, please use applyAnchorToTexture instead"),this.applyAnchorToTexture=e}get clampMargin(){return this._texture.textureMatrix.clampMargin}set clampMargin(e){this._texture.textureMatrix.clampMargin=e}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}get tilePosition(){return this._tileTransform.position}set tilePosition(e){this._tileTransform.position.copyFrom(e)}get tileScale(){return this._tileTransform.scale}set tileScale(e){typeof e=="number"?this._tileTransform.scale.set(e):this._tileTransform.scale.copyFrom(e)}set tileRotation(e){this._tileTransform.rotation=e}get tileRotation(){return this._tileTransform.rotation}get tileTransform(){return this._tileTransform}set texture(e){e||(e=X.EMPTY);const t=this._texture;t!==e&&(t&&t.dynamic&&t.off("update",this.onViewUpdate,this),e.dynamic&&e.on("update",this.onViewUpdate,this),this._texture=e,this.onViewUpdate())}get texture(){return this._texture}set width(e){this._width=e,this.onViewUpdate()}get width(){return this._width}set height(e){this._height=e,this.onViewUpdate()}get height(){return this._height}setSize(e,t){typeof e=="object"&&(t=e.height??e.width,e=e.width),this._width=e,this._height=t??e,this.onViewUpdate()}getSize(e){return e||(e={}),e.width=this._width,e.height=this._height,e}updateBounds(){const e=this._bounds,t=this._anchor,r=this._width,o=this._height;e.minX=-t._x*r,e.maxX=e.minX+r,e.minY=-t._y*o,e.maxY=e.minY+o}containsPoint(e){const t=this._width,r=this._height,o=-t*this._anchor._x;let s=0;return e.x>=o&&e.x<=o+t&&(s=-r*this._anchor._y,e.y>=s&&e.y<=s+r)}destroy(e=!1){if(super.destroy(e),this._anchor=null,this._tileTransform=null,this._bounds=null,typeof e=="boolean"?e:e?.texture){const r=typeof e=="boolean"?e:e?.textureSource;this._texture.destroy(r)}this._texture=null}};oo.defaultOptions={texture:X.EMPTY,anchor:{x:0,y:0},tilePosition:{x:0,y:0},tileScale:{x:1,y:1},tileRotation:0,applyAnchorToTexture:!1};let bi=oo;class Ci extends Ir{constructor(e,t){const{text:r,resolution:o,style:s,anchor:i,width:a,height:c,roundPixels:l,...u}=e;super({...u}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=t,this.text=r??"",this.style=s,this.resolution=o??null,this.allowChildren=!1,this._anchor=new de({_onUpdate:()=>{this.onViewUpdate()}}),i&&(this.anchor=i),this.roundPixels=l??!1,a!==void 0&&(this.width=a),c!==void 0&&(this.height=c)}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}set text(e){e=e.toString(),this._text!==e&&(this._text=e,this.onViewUpdate())}get text(){return this._text}set resolution(e){this._autoResolution=e===null,this._resolution=e,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(e){e||(e={}),this._style?.off("update",this.onViewUpdate,this),e instanceof this._styleClass?this._style=e:this._style=new this._styleClass(e),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(e){this._setWidth(e,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(e){this._setHeight(e,this.bounds.height)}getSize(e){return e||(e={}),e.width=Math.abs(this.scale.x)*this.bounds.width,e.height=Math.abs(this.scale.y)*this.bounds.height,e}setSize(e,t){typeof e=="object"?(t=e.height??e.width,e=e.width):t??(t=e),e!==void 0&&this._setWidth(e,this.bounds.width),t!==void 0&&this._setHeight(t,this.bounds.height)}containsPoint(e){const t=this.bounds.width,r=this.bounds.height,o=-t*this.anchor.x;let s=0;return e.x>=o&&e.x<=o+t&&(s=-r*this.anchor.y,e.y>=s&&e.y<=s+r)}onViewUpdate(){this.didViewUpdate||(this._didTextUpdate=!0),super.onViewUpdate()}_getKey(){return`${this.text}:${this._style.styleKey}:${this._resolution}`}destroy(e=!1){super.destroy(e),this.owner=null,this._bounds=null,this._anchor=null,(typeof e=="boolean"?e:e?.style)&&this._style.destroy(e),this._style=null,this._text=null}}function Si(n,e){let t=n[0]??{};return(typeof t=="string"||n[1])&&(Pe(Me,`use new ${e}({ text: "hi!", style }) instead`),t={text:t,style:n[1]}),t}class Ii extends Ci{constructor(...e){const t=Si(e,"Text");super(t,Xo),this.renderPipeId="text"}updateBounds(){const e=this._bounds,t=this._anchor,r=Vo.measureText(this._text,this._style),{width:o,height:s}=r;e.minX=-t._x*o,e.maxX=e.minX+o,e.minY=-t._y*s,e.maxY=e.minY+s}}class it extends X{static create(e){return new it({source:new Wo(e)})}resize(e,t,r){return this.source.resize(e,t,r),this}}const so=class io extends w{constructor(e={}){e={...io.defaultOptions,...e},super(),this.renderLayerChildren=[],this.sortableChildren=e.sortableChildren,this.sortFunction=e.sortFunction}attach(...e){for(let t=0;t<e.length;t++){const r=e[t];if(r.parentRenderLayer){if(r.parentRenderLayer===this)continue;r.parentRenderLayer.detach(r)}this.renderLayerChildren.push(r),r.parentRenderLayer=this;const o=this.renderGroup||this.parentRenderGroup;o&&(o.structureDidChange=!0)}return e[0]}detach(...e){for(let t=0;t<e.length;t++){const r=e[t],o=this.renderLayerChildren.indexOf(r);o!==-1&&this.renderLayerChildren.splice(o,1),r.parentRenderLayer=null;const s=this.renderGroup||this.parentRenderGroup;s&&(s.structureDidChange=!0)}return e[0]}detachAll(){const e=this.renderLayerChildren;for(let t=0;t<e.length;t++)e[t].parentRenderLayer=null;this.renderLayerChildren.length=0}collectRenderables(e,t,r){const o=this.renderLayerChildren,s=o.length;this.sortableChildren&&this.sortRenderLayerChildren();for(let i=0;i<s;i++)o[i].parent||Mt("Container must be added to both layer and scene graph. Layers only handle render order - the scene graph is required for transforms (addChild)",o[i]),o[i].collectRenderables(e,t,this)}sortRenderLayerChildren(){this.renderLayerChildren.sort(this.sortFunction)}_getGlobalBoundsRecursive(e,t,r){if(!e)return;const o=this.renderLayerChildren;for(let s=0;s<o.length;s++)o[s]._getGlobalBoundsRecursive(!0,t,this)}};so.defaultOptions={sortableChildren:!1,sortFunction:(n,e)=>n.zIndex-e.zIndex};let ki=so;const An=ki,On=(n,e)=>{C.dispatch(No(qo(n??Zo(C.getState()),e)))},Ti=(n,e)=>{const t=kr();R.useLayoutEffect(()=>{On()},[]),R.useLayoutEffect(()=>{const r=()=>On(n,e);if(e){const o=new ResizeObserver(r);return o.observe(e),()=>o.disconnect()}else return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[t,e,n])},Ri=()=>{const{cssUpscale:n,canvasSize:e,rotate90:t}=tt(Yt);return t?`scale(${n}) rotate(90deg) translate(0, -${e.y}px)`:`scale(${n})`},Pi=(n,e=console.error)=>(...t)=>{try{return n(...t)}catch(r){e(r);return}},ao=n=>{for(const[,c]of n)for(const[l]of c)c.set(l,!1);const e=Array.from(Mi(n));let t=e.length,r=t;const o=new Array(t),s={},i=_i(e);for(;r--;)s[r]||a(e[r],r,new Set,null);return o;function a(c,l,u,p){if(u.has(c)){if(p!==null){const f=n.get(p);f?.has(c)&&f.set(c,!0)}return}if(s[l])return;s[l]=!0;const h=n.get(c),d=Array.from(h?.entries()??_t);if(l=d.length){u.add(c);do{const[f,m]=d[--l];m||a(f,i.get(f),u,c)}while(l);u.delete(c)}o[--t]=c}};function Mi(n){const e=new Set;for(const[t,r]of n.entries()){e.add(t);for(const o of r.keys())e.add(o)}return e}function _i(n){const e=new Map;for(let t=0,r=n.length;t<r;t++)e.set(n[t],t);return e}const Ai=(n,e,t,r)=>(n.has(e)||n.set(e,new Map),n.get(e).set(t,r),n),Ge=(n,e,t)=>{const r=n.get(e);return r!==void 0&&(r.delete(t),r.size===0&&n.delete(e)),n},xe=(n,e)=>({get bottomCentre(){return this.c000},get topLeft(){return this.c101},get topRight(){return this.c011},get c000(){return b(n)},get c001(){return b(M(n,{z:e.z}))},get c010(){return b(M(n,{y:e.y}))},get c011(){return b(M(n,{y:e.y,z:e.z}))},get c100(){return b(M(n,{x:e.x}))},get c101(){return b(M(n,{x:e.x,z:e.z}))},get c110(){return b(M(n,{x:e.x,y:e.y}))},get c111(){return b(M(n,e))},projectCorner(t){return b(M(n,{x:t.x*e.x,y:t.y*e.y,z:t.z*e.z}))}}),mt=1e-5,zn=-1,be=(n,e,t,r,o)=>r-o>n&&t<e-o,Oi=0,co=1,lo=2,uo=3,zi=(n,e,t,r)=>{const{topLeft:o,topRight:s,bottomCentre:i}=xe(n,e),{topLeft:a,topRight:c,bottomCentre:l}=xe(t,r),u=o.x,p=s.x,h=a.x,d=c.x,f=be(u,p,h,d,mt),m=s.y-s.x/2,v=i.y-i.x/2,y=c.y-c.x/2,S=l.y-l.x/2,k=be(m,v,y,S,mt),T=o.y+o.x/2,A=i.y+i.x/2,ne=a.y+a.x/2,U=l.y+l.x/2,Be=be(T,A,ne,U,mt);return k&&Be&&f?co:Be&&f&&be(m,v,y,S,zn)?lo:k&&f&&be(T,A,ne,U,zn)?uo:Oi},Fi=(n,e,t,r)=>{for(const o of Yo){const s=n[o],i=s+e[o],a=t[o],c=a+r[o];if(i<=a)return 1*(o==="z"?-1:1);if(s>=c)return-1*(o==="z"?-1:1)}return Fn(t)-Fn(n)},Bi=(n,e)=>{if(n.fixedZIndex!==void 0||e.fixedZIndex!==void 0)return 0;const t=n.renderAabb||n.aabb,r=e.renderAabb||e.aabb,o=n.renderAabbOffset?M(n.state.position,n.renderAabbOffset):n.state.position,s=e.renderAabbOffset?M(e.state.position,e.renderAabbOffset):e.state.position;switch(zi(o,t,s,r)){case co:return Fi(o,t,s,r);case lo:return N(o.y,s.y+r.y)&&N(o.z,s.z+r.z)?1:N(s.y,o.y+t.y)&&N(s.z,o.z+t.z)?-1:0;case uo:return N(o.x,s.x+r.x)&&N(o.z,s.z+r.z)?1:N(s.x,o.x+t.x)&&N(s.z,o.z+t.z)?-1:0;default:return 0}},Fn=n=>n.x+n.y-n.z,ho=(n,e=new Set($t(n)),t=new Map)=>{const r=new Map;for(const[o,s]of t)if(!n[o])t.delete(o);else for(const[i]of s)n[i]||Ge(t,o,i);for(const o of e)if(o.fixedZIndex===void 0)for(const s of $t(n)){if(s.fixedZIndex!==void 0||r.get(s)?.has(o)||o===s)continue;const i=Bi(o,s);if(r.has(o)||r.set(o,new Set),r.get(o).add(s),i===0){Ge(t,o.id,s.id),Ge(t,s.id,o.id);continue}const a=i>0?o.id:s.id,c=i>0?s.id:o.id;Ai(t,c,a,!1),Ge(t,a,c)}return t},Bn=n=>n.fixedZIndex!==void 0,$i=n=>{const t=n.some(([,a])=>a==="intersects-rendered")?n.filter(([,a])=>a==="intersects-rendered").map(([a])=>a):n.map(([a])=>a);if(t.every(Bn))return t.toSorted((a,c)=>c.fixedZIndex-a.fixedZIndex).at(0);const r=t.filter(a=>!Bn(a));if(r.length===0)return;if(r.length===1)return r[0];const o=Object.fromEntries(r.map(a=>[a.id,a])),s=ho(o),i=ao(s);return o[i.at(-1)]},Ei=3,Li=(n,{x:e,y:t},r)=>{const o=xe(n.state.position,n.aabb);return Jo.find(s=>{const i=o.projectCorner(s);return Jt(Y(i,{x:e,y:t}))<Ei})},ce=3,gt=1.5;function H({x:n,y:e},t,r){const o={x:n-t.x,y:e-t.y},s=o.x*r.y-o.y*r.x;return Math.abs(s)/Ko(Math.hypot(r.x,r.y))}const po={point:{x:-1,y:-1,z:0},normal:{x:0,y:0,z:1}},fo={point:{x:-1,y:0,z:1},normal:{x:0,y:1,z:0}},mo={point:{x:0,y:-1,z:1},normal:{x:1,y:0,z:0}},go={point:{x:0,y:1,z:1},normal:{x:1,y:0,z:0}},xo={point:{x:1,y:0,z:1},normal:{x:0,y:1,z:0}},yo={point:{x:1,y:-1,z:0},normal:{x:0,y:0,z:1}},vo={point:{x:0,y:-1,z:-1},normal:{x:1,y:0,z:0}},wo={point:{x:-1,y:1,z:0},normal:{x:0,y:0,z:1}},bo={point:{x:-1,y:0,z:-1},normal:{x:0,y:1,z:0}},Ui=(n,e,t,r)=>{const o=xe(n.state.position,n.aabb),s=t.x<0,i=t.y<0,a=t.z>0;if((s||i)&&H(e,o.bottomCentre,{x:0,y:-1})<gt)return po;if((s||a)&&H(e,o.topRight,{x:2,y:-1})<gt)return fo;if((i||a)&&H(e,o.topLeft,{x:2,y:1})<gt)return mo;switch(!0){case a:{const c=o.c111;if(H(e,c,{x:2,y:1})<ce)return go;if(H(e,c,{x:-2,y:1})<ce)return xo;break}case i:{const c=o.c100;if(H(e,c,{x:0,y:-1})<ce)return yo;if(H(e,c,{x:2,y:1})<ce)return vo;break}case s:{const c=o.c010;if(H(e,c,{x:0,y:-1})<ce)return wo;if(H(e,c,{x:-2,y:1})<ce)return bo;break}}},Di={z:1,x:0,y:0},ji={z:0,x:0,y:-1},$n={z:0,x:-1,y:0},Gi=(n,{x:e,y:t},r)=>{if(r.type==="item"&&r.item.type==="door"&&n.type==="wall"){const c=n.config.direction;return Tr(gs[c],-1)}const{bottomCentre:o,topLeft:s,topRight:i}=xe(n.state.position,n.aabb);return t<s.y-(s.x-e)/2?t<i.y-(e-i.x)/2?Di:$n:e<o.x?ji:$n},En=(n,e,t)=>t?{position:n.state.position,aabb:n.aabb}:{position:M(n.state.position,n.renderAabbOffset??me),aabb:n.renderAabb??n.aabb},Ln=({x:n,y:e},t,r)=>{const{bottomCentre:o,topLeft:s,topRight:i}=xe(t,r);return!(n<s.x||n>i.x||e<i.y-(i.x-n)/2||e<s.y-(n-s.x)/2||e>o.y-(n-o.x)/2||e>o.y-(o.x-n)/2)},Hi=(n,e,t)=>{const{position:r,aabb:o}=En(t,e,!1);if(Ln(n,r,o))return"intersects-rendered";if(e.type==="item"&&t.type==="wall"){const{position:i,aabb:a}=En(t,e,!0);if(Ln(n,i,a))return"intersects-unrendered"}return"non-intersecting"},Co=(n,e,t,r)=>{const o=t.type==="item"&&t.item.type==="door"?1:r,s=_.w*o,i=_.h,a=o===1?0:_.w/2,c=i/2,l=Qo(e);return{x:l==="yz"?Math.round(n.x/s)*s:Math.floor((n.x-a)/s)*s,y:l==="xz"?Math.round(n.y/s)*s:Math.floor((n.y-a)/s)*s,z:l==="xy"?Math.round(n.z/i)*i:Math.floor((n.z+c)/i)*i}},Xi=({state:{position:n},aabb:e},t,r,o,s)=>{const i={x:n.x+(t.x<0?0:e.x),y:n.y+(t.y<0?0:e.y),z:n.z+(t.z<0?0:e.z)},a=ys(i,t,r);return Co(a,t,o,s)},Vi=n=>e=>{const t=xs(e);return n.type==="item"&&n.item.type==="door"?t&&e.type==="wall":t},xt=(n,e,t,r)=>{const o=Z(e.items).filter(Vi(t)).map(a=>[a,Hi(n,t,a)]).filter(a=>a[1]!=="non-intersecting"),s=$i(Array.from(o)),i=e.id;if(s){const a=Gi(s,n,t);if(!(a.z>0&&!Object.isExtensible(s.state.stoodOnBy)))return{roomId:i,scrXy:n,world:{itemId:s.id,onItem:{face:a,corner:Li(s,n),edge:Ui(s,n,a)},position:Xi(s,a,n,t,r)}}}return{roomId:i,scrXy:n,world:void 0}},ye=40,Ze=(n,e,t)=>{const r=n.cssUpscale*n.gameEngineUpscale;if(t.target===null)throw new Error("Mouse event target is null");const o=t.target.getBoundingClientRect(),s=t.clientX-o.left,i=t.clientY-o.top;return{x:s/r+e.l-ye,y:i/r+e.t-ye}},Wi=(n,e)=>{const t=n.cssUpscale*n.gameEngineUpscale;if(e.target===null)throw new Error("Mouse event target is null");const r=e.movementX,o=e.movementY;return{x:r/t,y:o/t}},Ni=n=>{n.ticker.remove(n.render,n)},So=R.createContext(null),qi=({children:n})=>{const[e,t]=R.useState(null);return R.useEffect(()=>{const r=new eo;return r.init({background:g.pureBlack,sharedTicker:!0}).then(()=>{Ni(r),t(r)}),()=>{}},[]),e===null?null:L.jsx(So,{value:e,children:n})},ae=()=>R.useContext(So),Je=(n,...e)=>n.levelEditor.wallsFloorsLocked&&e.some(t=>t.type==="wall"||t.type==="floor"),Dt=(n,e)=>{const t=C.getState();let r;if(e.world){const o=e.world.itemId,s=o&&n.items[o],i=Je(t,s)?void 0:s.jsonItemId;r=i===void 0?void 0:{jsonItemId:i,pointingAtOnItem:e.world.onItem}}else r=void 0;D(_r(t),r)||C.dispatch(Ar(r))},Ke=({levelEditor:n},e,t)=>{const r=e.items[t]?.jsonItemId;if(r===void 0)return;const o=Or(n,r);if(o!==void 0)return[r,o]},{dispatch:Zi}=C;class Yi{handleMouseMove({roomState:e,pointingAt:t}){Dt(e,t)}handleMouseUp({roomState:e,pointingAt:t,storeState:r,isClick:o}){if(!o)return;const s=t.world?.itemId;if(s===void 0){console.warn("no itemId");return}const i=e.items[s];if(Je(r,i))return;const a=Ke(r,e,s);if(a===void 0)return;const[,c]=a;Zi(on({type:"item",item:{type:c.type,config:c.config}}))}handleMouseDown(e){}handleMouseLeave(e){}}const Un=(n,e,t)=>{const{world:{onItem:{face:r},position:o,itemId:s}}=n;if(r.z>es)return We(o);if(t.type==="door"){const i=e.items[s];if(i.type!=="wall")return;const{config:a,aabb:c,state:{position:l}}=i,u=vs(zr(a)),p=_e(J(a.direction)),h=J(a.direction);if(u[p]<2)return;const d=l[p],f=l[p]+c[p]-ws,m=l.z,v=l.z+c.z-bs,y={[p]:Math.max(Math.min(o[p],f),d),[h]:o[h],z:Math.max(Math.min(o.z,v),m)};return We(y)}return M(We(o),r)},{dispatch:Ce}=C;class Ji{handleMouseMove({pointingAtChanged:e,roomState:t,pointingAt:r,tool:o,storeState:s}){if(!e||(Ce(Ft()),r.world===void 0))return;const i=Ke(s,t,r.world.itemId);if(i===void 0)return;const[,a]=i,c=Un(r,t,o.item);if(c===void 0)return;const{item:l}=o,u=l.type==="door"?ts(l,h=>{const d=t.items[r.world.itemId];h.config.direction=d.config.direction}):o.item;Ns({roomState:t,blockPosition:c,itemTool:u})||Ce(xn({blockPosition:c,pointedAtItemJson:a,preview:!0}))}handleMouseUp({roomState:e,pointingAt:t,tool:r,storeState:o,isClick:s}){if(!s)return;if(t.world===void 0){Ce(on({type:"pointer"}));return}const i=Ke(o,e,t.world.itemId);if(i===void 0)return;const[,a]=i,c=Un(t,e,r.item);c!==void 0&&Ce(xn({blockPosition:c,pointedAtItemJson:a,preview:!1}))}handleMouseDown(e){}handleMouseLeave(e){Ce(Ft())}}const Ki=n=>Br(e=>e>0?e:e>-1?1:-e+1,n),Qi=({jsonItem:n,blockDragAccVec:e,resizeEdgeDirection:t})=>{const r=n.position,o=Cs(n),s=At(e,t,Fr(n)),i=M(o,s),a=Ki(i),c=Br((l,u,p,h,d)=>{const f=u<1;return l<0!==f?f?p-d+1:p+h-d:f?p+h-1:p},t,i,r,o,a);return{timesDelta:Ot(a,o),positionDelta:Ot(c,r)}},ea=5,{dispatch:Se}=C,ta=(n,e,t)=>{const r=t?.world?.itemId;if(r===void 0)return zt;const o=e.items[r].jsonItemId;if(o===void 0)return zt;const{selectedJsonItemIds:s}=n.levelEditor;return s.includes(o)?s:[o]},na=(n,e,t)=>{const r=n.world?.onItem.edge,o=At(...nt(t).map(i=>Fr(i))),s=At(r?.point??me,o);return Qt(s)>0?r.normal:e?{x:1,y:0,z:0}:{x:0,y:0,z:1}},ra=(n,e,t,r,o,s)=>{if(n===void 0)return;const i=Y(e,n.scrXy),a=Jt(i);if(!(o||a>ea))return;const l=na(n,r,s),u=Ps(l,t);return r?{x:0,y:0,z:u.z}:u},Dn=(n,e=!1)=>{const t=C.getState().levelEditor;return Co(n,{x:0,y:0,z:1},t.tool,e?1:t.gridResolution)};class oa{handleMouseMove({roomState:e,pointingAt:t,storeState:r,mouseDownPointingAtRef:o,mouseEvent:s,upscale:i,dragAccVec:a,roomRenderSize:c}){const l=Wi(i,s),u=ta(r,e,o.current);if(u.length===0){Dt(e,t);return}const p=u.map(U=>Ss(r,U));if(Je(r,...p))return;const d=t.roomId===o.current?.roomId?ra(o.current,Ze(i,c,s),l,s.metaKey||s.shiftKey,a.current!==void 0,p):void 0;if(!d){Dt(e,t);return}u.length===1&&!Is(r,u[0])&&C.dispatch(ut({jsonItemIds:u}));const f=o.current?.world?.onItem.edge,m=f&&p.every(U=>$r(U)),v=a.current??me,y=M(v,d),S=Dn(y,m);if(a.current=y,Kt(Dn(v,m),S))return;const k=We(S);let T,A;if(m){const[,U]=Ke(r,e,o.current.world.itemId);({timesDelta:A,positionDelta:T}=Qi({jsonItem:U,blockDragAccVec:k,resizeEdgeDirection:f.point}))}else T=k;qs({roomState:e,jsonItemIds:u,blockPositionDelta:T,timesDelta:A})||Se(ks({jsonItemIds:u,positionDelta:T,timesDelta:A}))}handleMouseUp({roomState:e,pointingAt:t,storeState:r,mouseEvent:o,isClick:s,isDragEnd:i}){if(s){const a=t.world===void 0?void 0:e.items[t.world.itemId];if(a?.jsonItemId===void 0||Je(r,a)){Se(ut({jsonItemIds:[]}));return}Se(o.ctrlKey||o.metaKey?Ts({jsonItemId:a.jsonItemId}):ut({jsonItemIds:[a.jsonItemId]}))}else i&&Se(Rs())}handleMouseDown(e){}handleMouseLeave(e){Se(Ar(void 0))}}const He={item:new Ji,pointer:new oa,eyeDropper:new Yi},sa=n=>{const e=ae(),t=tt(Yt),r=kr(),o=R.useRef(void 0),s=R.useRef(void 0),i=R.useRef(void 0);R.useEffect(()=>{if(n===null)return;const a=h=>{const d=C.getState(),f=Ee(d),m=dt(d),v=Ze(t,m,h),y=Ie(d),S=xt(v,f,y,d.levelEditor.gridResolution),k=!D(S.world,o.current?.world);He[y.type].handleMouseMove({pointingAtChanged:k,roomState:f,pointingAt:S,tool:y,storeState:d,mouseDownPointingAtRef:s,mouseEvent:h,upscale:t,dragAccVec:i,roomRenderSize:m}),o.current=S},c=h=>{const d=C.getState(),f=Ee(d);if(f.id!==d.levelEditor.currentlyEditingRoomId)return;const m=dt(d),v=Ze(t,m,h),y=Ie(C.getState()),S=xt(v,f,y,d.levelEditor.gridResolution),k=i.current!==void 0,T=!k&&S.roomId===s.current?.roomId&&S.world?.itemId===s.current?.world?.itemId,A=s.current;if(i.current=void 0,s.current=void 0,C.dispatch(Ms(!1)),!T&&!k){console.log("mouseUp - not a click or drag end - skipping");return}He[y.type].handleMouseUp({roomState:f,pointingAt:S,tool:y,storeState:d,mouseDownPointingAt:A,mouseEvent:h,upscale:t,isClick:T,isDragEnd:k})},l=h=>{const d=C.getState(),f=Ee(d),m=Ie(d);i.current=void 0,s.current=void 0,He[m.type].handleMouseLeave({roomState:f,tool:m,storeState:d,mouseEvent:h})},u=h=>{const d=C.getState(),f=Ee(d),m=dt(d),v=Ze(t,m,h),y=Ie(d),S=xt(v,f,y,d.levelEditor.gridResolution);console.log("setting mouseDownPointingAtRef to",S),s.current=S,He[y.type].handleMouseDown({roomState:f,pointingAt:S,tool:y,storeState:d,mouseEvent:h,upscale:t})},p=Pi(a);return n.addEventListener("mousemove",p),n.addEventListener("mouseup",c),n.addEventListener("mousedown",u),n.addEventListener("mouseleave",l),()=>{n.removeEventListener("mousemove",p),n.removeEventListener("mouseup",c),n.removeEventListener("mousedown",u),n.removeEventListener("mouseleave",l)}},[e.stage,t,n,r])},ia={amigaHiResPal:"Amiga Hi-Res PAL",classicMac:"Classic Mac",amigaLowResPal:"Amiga Low-Res PAL",zxSpectrum:"ZX Spectrum",handheld:"Handheld"},aa=({selectedResolution:n,onResolutionChange:e})=>{const t=$e.indexOf(n),r=t<$e.length-1,o=t>0,{justDone:s,doneNow:i}=Zs();return L.jsxs("div",{className:"absolute scale-editor top-0 right-1 z-slightlyAbove flex gap-0 leading-none text-white",children:[s>0&&L.jsx(ht,{className:"px-1 bg-moss items-center flex",children:ia[n]}),L.jsx(bn,{small:!0,disabled:!o,tooltipContent:`##zoom ⬇

makes things look *smaller* by *increasing* emulated resolution`,onClick:()=>{o&&(e($e[t-1]),i())},shortcutKeys:["-"],children:L.jsx(ht,{children:"-"})}),L.jsx(bn,{small:!0,disabled:!r,tooltipContent:`##zoom ⬆

makes things look *bigger* by *decreasing* emulated resolution`,onClick:()=>{r&&(e($e[t+1]),i())},shortcutKeys:["⇧+","="],children:L.jsx(ht,{children:"+"})})]})},ca=n=>{const e=ae();R.useEffect(()=>{if(n)return n.appendChild(e.canvas),()=>{n.removeChild(e.canvas)}},[n,e])},la=n=>{const e=ae(),[t]=R.useState(()=>new w({label:"editorPositioner"})),r=Er();R.useEffect(()=>{if(n.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return t.addChild(n.output.graphics),e.stage.addChild(t),()=>{e.stage.removeChild(t),t.removeChild(n.output.graphics)}},[n,e,t]),R.useEffect(()=>{t.x=-r.l+ye,t.y=-r.t+ye},[t,r])},ua=(n,e)=>{const t=R.useCallback(()=>{if(n===null)return;const r=Math.max(0,(n.scrollWidth-n.clientWidth)/2),o=Math.max(0,(n.scrollHeight-n.clientHeight)/2);n.scrollTo(r,o)},[n]);R.useEffect(()=>{if(n!==null)return Rr({actionCreator:Bt,effect(){setTimeout(t,0)}})},[t,n]),R.useEffect(()=>{if(n===null||e===null)return;if(e.querySelector("canvas"))setTimeout(t,0);else{const o=new MutationObserver(()=>{e.querySelector("canvas")&&(t(),o.disconnect())});return o.observe(e,{childList:!0,subtree:!0}),()=>o.disconnect()}},[n,e,t])},da=()=>{const n=ae(),e=tt(t=>t.upscale.upscale.gameEngineUpscale);n.stage.scale=e},ha=()=>{R.useEffect(()=>Rr({actionCreator:on,effect(n,{dispatch:e}){e(Ft())}}))},pa=()=>{const n=ae(),e=Er(),t=tt(r=>r.upscale.upscale);R.useEffect(()=>{const r=(2*ye+e.w)*t.gameEngineUpscale,o=(2*ye+e.h)*t.gameEngineUpscale;n.renderer?.resize(r,o)},[n.renderer,e,t])},fa=({levelEditor:n})=>{const{dragInProgress:e,clickableAnnotationHovered:t,hoveredItem:r,selectedJsonItemIds:o}=n;if(e)return $("cursor-grabbing");if(t)return $("cursor-pointer");if(r){const s=Or(n,r.jsonItemId);if(s!==void 0&&$r(s))if(r.pointingAtOnItem.corner){if(Kt(r.pointingAtOnItem.corner,{x:1,y:1,z:1}))return $("cursor-n-resize")}else{const{edge:i}=r.pointingAtOnItem;if(i){if(D(i,wo))return $("cursor-e-resize");if(D(i,po))return $("cursor-s-resize");if(D(i,yo))return $("cursor-w-resize");if(D(i,fo)||D(i,go))return $("cursor-ne-resize");if(D(i,mo)||D(i,xo))return $("cursor-nw-resize");if(D(i,bo))return $("cursor-se-resize");if(D(i,vo))return $("cursor-sw-resize")}}return o.includes(r.jsonItemId)?$("cursor-grab"):$("cursor-default")}return $("cursor-crosshair")},ma=()=>_s(fa),I=new window.AudioContext,ve=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,ga=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uTargetColor;

vec4 black = vec4(0.0, 0.0, 0.0, 1.0);

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    // 1 if black, 0 if non-black
    float isBlack = step(length(c.rgb), 0.01);

    // keep original if either:
    //      * black
    //      * transparent

    finalColor = mix(    
        vec4(uTargetColor, 1),    
        c, 
        max(isBlack, 1.0 - c.a)
    );
}
`;class B extends Q{uniforms;constructor(e="white"){const t=W.from({vertex:ve,fragment:ga,name:"revert-colourise-filter"});super({glProgram:t,resources:{colorReplaceUniforms:{uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this.targetColor=e}set targetColor(e){const[t,r,o]=new P(e).toArray();this.uniforms.uTargetColor[0]=t,this.uniforms.uTargetColor[1]=r,this.uniforms.uTargetColor[2]=o}}const xa={pureBlack:new P("#000000"),shadow:new P("#1B2D3B"),midGrey:new P("#505A55"),lightGrey:new P("#929981"),white:new P("#F8FEF8"),pastelBlue:new P("#4893FF"),metallicBlue:new P("#1D4E80"),pink:new P("#B973AF"),moss:new P("#6E7B00"),redShadow:new P("#513D40"),midRed:new P("#A7574B"),lightBeige:new P("#BF8E69"),highlightBeige:new P("#DBB269"),alpha:new P("#105A69"),replaceLight:new P("#048662"),replaceDark:new P("#052229")},ya=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    finalColor = vec4(c.rgb * 0.5, c.a);
}
`;class va extends Q{constructor(){const e=W.from({vertex:ve,fragment:ya,name:"halfbrite-filter"});super({glProgram:e,resources:{}})}}const wa=`#version 300 es
// some old/mid-spec Android devices (eg, Pixel 7a) need this to be high
// precision, or they 'miss' the locations on the LUT
precision highp float;

in vec2 vTextureCoord;
out vec4 finalColor;

// these must match the typescript
const float lutSize = 256.0;
const float smallPrime = 31.0;

uniform sampler2D uTexture;
uniform sampler2D uLut;

/** returns in [0, lutSize] range
this must match the TypeScript version of the hash function*/
float hashInputColour(vec3 color) {
    // Add 0.5 before flooring to ensure consistent rounding, ie if the value
    // is on the boundary between two integers
    vec3 c255 = floor(color * 255.0 + 0.5);
    
    float hash = mod(
        c255.r + c255.g * smallPrime + c255.b * smallPrime * smallPrime, 
        lutSize
    );
    return hash;
}

void main(void) {
    
    vec4 c = texture(uTexture, vTextureCoord);

    float h = hashInputColour(c.rgb);

    // use the hash to look up the replacement in the LUT:
    vec4 replacementColour = texture(
        uLut, 
        vec2(
            // normalise h to [0, 1] range, sampling from texel center
            (h + 0.5) / lutSize, 
            0.5
        )
    );
    
    // use original if either: 
    //      original alpha is 0 (because keep transparent)
    //      or lut alpha is 0 (signals nothing in this slot of the LUT)
    finalColor = mix(c, replacementColour, c.a * replacementColour.a);
}
`,ke=256,yt=31,jn=new Map;function ba(n){const e=Math.floor(n.red*255+.5),t=Math.floor(n.green*255+.5),r=Math.floor(n.blue*255+.5);return(e+t*yt+r*yt*yt)%ke}function Ca(n){const e=new Float32Array(ke*4);for(const[o,s]of ns(n)){const i=g[o],a=ba(i);if(e[a*4+3]>.5)throw new Error("LUT collision - mess with the hash function or lut size until this goes away");e[a*4+0]=s.red,e[a*4+1]=s.green,e[a*4+2]=s.blue,e[a*4+3]=1}const t=new Uint8Array(ke*4);for(let o=0;o<ke*4;o++)t[o]=Math.floor(e[o]*255);return X.from({resource:t,width:ke,height:1,scaleMode:"nearest",antialias:!1})}class Sa extends Q{#e;constructor(e){const t=Object.keys(e).length,r=W.from({vertex:ve,fragment:wa,name:"palette-swop-filter"}),o=Ca(e);super({glProgram:r,resources:{colorReplaceUniforms:{uOriginal:{value:new Float32Array(3*t),type:"vec3<f32>",size:t},uReplacement:{value:new Float32Array(3*t),type:"vec3<f32>",size:t}},uLut:o.source}}),this.#e=o;const s=this.resources.colorReplaceUniforms.uniforms;Object.entries(e).forEach(([i,a],c)=>{g[i].toArray().forEach((l,u)=>{s.uOriginal[c*3+u]=l}),a.toArray().forEach((l,u)=>{s.uReplacement[c*3+u]=l})})}destroy(e){this.#e?.destroy(!0),this.#e=null,super.destroy(e)}}const Ia=n=>Object.entries(n).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>`${e}:${t.toHex()}`).join("|"),ee=n=>{const e=Ia(n);let t=jn.get(e);return t||(t=new Sa(n),jn.set(e,t)),t},Io=({basic:n,dimmed:e})=>({replaceLight:n,replaceDark:e}),ko=({color:{hue:n,shade:e},planet:t})=>{const r=n==="yellow"?e==="dimmed"||t==="jail"?Ys:Js:jr[n][e].main;return Io(r)},ka=n=>ee({lightBeige:g.lightGrey,redShadow:g.shadow,pink:g.lightGrey,moss:g.lightGrey,midRed:g.midGrey,highlightBeige:g.lightGrey,...n&&ko(n)}),Ta=ee({midGrey:g.midRed,lightGrey:g.lightBeige,white:g.highlightBeige,metallicBlue:g.redShadow,pink:g.midRed,moss:g.midRed,replaceDark:g.midRed,replaceLight:g.lightBeige}),Gn=(n,e)=>{const t=Ye(n.color).edges[e],r=t.original;return t.dimInOriginal?Gr(r):r},To=(n,e,t)=>t?ee(Io(jr[n.color.hue][n.color.shade].edges[e])):new B(Ye(n.color).edges[e].original),j=n=>ee(ko(n)),Ra=n=>{switch(n.color.hue){case"white":return ee({replaceLight:g.lightGrey,replaceDark:g.midGrey});default:return j(n)}},Ro=n=>{switch(n.color.hue){case"white":return ee({replaceLight:g.lightBeige,replaceDark:g.midRed,shadow:g.redShadow});case"yellow":return j({planet:n.planet,color:{hue:"yellow",shade:"dimmed"}});default:return j(n)}};new va;const te=zt,Pa=ee(xa),jt=()=>{throw new Error(`sounds not loaded - only call this from inside code 
      (like in a render loop) that is protected and only executed once 
      loading has happened`)},z=n=>{const e=typeof n=="string"?{soundId:n}:n,{playbackRate:t=1,soundId:r,connectTo:o,loop:s=!1,varyPlaybackRate:i=!1,randomiseStartPoint:a=!1}=e,c=I.createBufferSource(),l=jt()[r];return c.buffer=l,c.loop=s,c.playbackRate.value=i?t-.05+Math.random()*.1:t,s&&a?c.start(0,l.duration*Math.random()):c.start(),o!==void 0&&c.connect(o),c},le=(n,e,t)=>{const r=I.createGain();return e!==void 0&&(r.gain.value=e),n.connect(r),r.connect(t),r},F=({start:n,change:e,loop:t,stop:r,startAndLoopTogether:o=!1,noStartOnFirstFrame:s=!0},i)=>{let a=!0,c,l;return u=>{if(!!u!=!!l)u?n!==void 0&&!(a&&s)?(c&&(c.onended=null,c.stop()),c=z({...n}),le(c,n.gain,i),t!==void 0&&(o?(c=z({...t,loop:!0}),le(c,t.gain,i)):c.onended=()=>{l&&(c&&(c.onended=null,c.stop()),c=z({...t,loop:!0}),le(c,t.gain,i))})):t!==void 0&&(c=z({...t,loop:!0}),le(c,t.gain,i)):(c&&c.loop&&(c.onended=null,c.stop()),r!==void 0&&(c=z({...r}),le(c,r.gain,i)));else if(l!==u&&e!==void 0){const h=z({...e});le(h,e.gain,i)}a=!1,l=u}};class Ma{constructor(e){this.renderContext=e,this.output.gain.value=4}output=I.createGain();#e=F({loop:{soundId:"rollingBallLoop",playbackRate:.5}},this.output);tick(){const{renderContext:{item:{state:{vels:{sliding:e},standingOnItemId:t}}}}=this,r=(e.x!==0||e.y!==0)&&t!==null;this.#e(r)}destroy(){}}class _a{constructor(e){this.renderContext=e;const{item:{config:{was:t}}}=e;switch(t.type){case"pickup":{t.gives!=="scroll"&&z({soundId:"bonus",connectTo:this.output});break}case"disappearing":{z({soundId:"destroy",connectTo:this.output});break}case"hushPuppy":{this.output.gain.value=.5,z({soundId:"hushPuppyVanish",connectTo:this.output});break}}}output=I.createGain();tick(){}destroy(){}}class Aa{constructor(e){this.renderContext=e,this.#e.connect(this.output)}output=I.createGain();#e=I.createGain();#t=void 0;tick(){const{renderContext:{item:{state:{pressed:e}}}}=this,t=this.#t?.pressed;t!==void 0&&t!==e&&z({soundId:"switchClick",playbackRate:e?.95:1.05,connectTo:this.#e}),this.#t={pressed:e}}destroy(){}}class ln{constructor(e,t,r=1){this.renderContext=e,this.#e=F({start:t},this.output),this.output.gain.value=r}output=I.createGain();#e;tick({lastRenderRoomTime:e}){const{renderContext:{item:t}}=this,{state:{collidedWith:{roomTime:r,by:o}}}=t,s=r>(e??sn)&&!Ks(rt(o));this.#e(s)}destroy(){}}class Oa{constructor(e){this.renderContext=e,this.#e.connect(this.output),this.#e.gain.value=.5,this.#n=new ln(e,{soundId:"metalHit"},.3),this.#n.output.connect(this.output)}output=I.createGain();#e=I.createGain();#t=F({start:{soundId:"servoStart",playbackRate:.5},loop:{soundId:"servoLoop",playbackRate:.5},stop:{soundId:"servoStop",playbackRate:.5}},this.#e);#n;tick(e){const{renderContext:{item:t,room:{roomTime:r,items:o}}}=this,{state:{actedOnAt:{roomTime:s,by:i}}}=t,a=r===s&&nt(rt(i)).some(c=>Lr(o[c]));this.#t(a),this.#n.tick(e)}destroy(){}}const Oe=n=>{for(const e in n)return!0;return!1},vt=2;class za{constructor(e){this.renderContext=e}output=I.createGain();#e=F({start:{soundId:"conveyorStart",playbackRate:vt},loop:{soundId:"conveyorLoop",playbackRate:vt},stop:{soundId:"conveyorEnd",playbackRate:vt}},this.output);tick(){const{renderContext:{item:{state:{stoodOnBy:e}}}}=this,t=Oe(e);this.#e(t)}destroy(){this.#e(!1)}}class Fa{constructor(e){this.renderContext=e,z({soundId:"hooter",connectTo:this.output})}output=I.createGain();tick(){}destroy(){}}const Ba=3;class $a{constructor(e){this.renderContext=e,this.output.gain.value=.7}output=I.createGain();#e=z({soundId:"helicopter",loop:!0,connectTo:this.output});tick(){const{renderContext:{item:{state:{vels:{lift:{z:e}}}}}}=this;this.#e.playbackRate.value=Math.max(.5,1+Ba*e)}destroy(){}}const Hn={skiHead:{soundId:"softBump"},turtle:{soundId:"softBump"},dalek:{soundId:"metalHit",gain:.1},homingBot:{soundId:"metalHit",gain:.2},computerBot:{soundId:"metalHit",gain:.2}},Xn={cyberman:{soundId:"jetpackTurnaround",gain:1.2},dalek:{soundId:"mojoTurn",gain:.3}},Vn={cyberman:{soundId:"jetpackLoop",gain:.7},emperorsGuardian:{soundId:"jetpackLoop"},dalek:{soundId:"mojoLoop"},bubbleRobot:{soundId:"bubbleRobotLoop"},helicopterBug:{soundId:"helicopter"}},Wn={homingBot:{start:{soundId:"detect"},loop:{soundId:"robotWhirLoop",gain:4},startAndLoopTogether:!0},computerBot:{loop:{soundId:"robotBeepingLoop",randomiseStartPoint:!0,varyPlaybackRate:!0}}};class Ea{constructor(e){this.renderContext=e,this.#e.connect(this.output),this.#t.connect(this.output),this.#t.gain.value=.66;const{item:{config:{which:t}}}=e;Hn[t]!==void 0&&(this.#o=new ln(e,Hn[t]),this.#o.output.connect(this.output)),Xn[t]!==void 0&&(this.#n=F({change:Xn[t]},this.#e)),Wn[t]!==void 0&&(this.#s=F(Wn[t],this.#e)),Vn[t]!==void 0&&(this.#r=F({loop:Vn[t]},this.#t))}output=I.createGain();#e=I.createGain();#t=I.createGain();#n;#r;#o;#s;tick(e){const{renderContext:{item:t}}=this,{state:{facing:r,activated:o,busyLickingDoughnutsOffFace:s,vels:{walking:i}}}=t;if(this.#n){const a=Pr(r);this.#n(a)}if(this.#o&&this.#o.tick(e),this.#r){const a=o&&!s;this.#r(a)}if(this.#s){const a=!Kt(i,me);this.#s(a)}}destroy(){}}const La=n=>{if(As(n))return n.state;if(Os(n))return n.state.heels},Ua=.8,Da=1.2,ja=.8;class wt{constructor(e){this.renderContext=e;const{general:{soundSettings:t},item:{type:r}}=e,{noFootsteps:o}={...en.soundSettings,...t};o||(this.#e=I.createGain(),this.#e.gain.value=Ua,this.#e.connect(this.output),this.#t=F({loop:{soundId:`${r==="headOverHeels"?"heels":r}Walk`}},this.#e)),this.#n.gain.value=ja,this.#n.connect(this.output),this.#a.gain.value=Da,this.#a.connect(this.output),this.#s.connect(this.output),this.#r=F({start:{soundId:`${r==="headOverHeels"?"head":r}Jump`}},this.#n),this.#o=F({loop:{soundId:`${r==="headOverHeels"?"head":r}Fall`}},this.#n)}output=I.createGain();#e;#t;#n=I.createGain();#r;#o;#s=I.createGain();#i=F({start:{soundId:"landing"},noStartOnFirstFrame:!0},this.#s);#a=I.createGain();#l=F({start:{soundId:"carry",playbackRate:.95},stop:{soundId:"carry",playbackRate:1.05}},this.#a);#c={teleportingPhase:null,positionZ:0};tick({lastRenderRoomTime:e}){const{renderContext:{item:t}}=this,{state:{action:r,teleporting:o,jumpStartZ:s,jumped:i,standingOnItemId:a,position:{z:c},vels:{gravity:{z:l}},collidedWith:{roomTime:u,by:p}}}=t,h=La(t),{teleportingPhase:d,positionZ:f}=this.#c,m=o?o.phase:null,v=i&&c>s&&c>f&&l>0,y=c<f&&l<0&&a===null;this.#o(y),this.#r(v),this.#t!==void 0&&this.#t(!v&&!y&&r==="moving"),h!==void 0&&this.#l(h.carrying!==null);const S=a!==null&&u>(e??sn)&&p[a];if(this.#i(S),m!==null&&m!==d)if(m==="in"){const k=jt().teleportIn,T=I.createBufferSource();T.buffer=k,T.connect(this.output),T.start()}else{const k=jt().teleportOut,T=I.createBufferSource();T.buffer=k,T.connect(this.output),T.start()}this.#c={teleportingPhase:m,positionZ:c}}destroy(){}}class Ga{constructor(e){this.renderContext=e}output=I.createGain();#e=void 0;tick(){const{renderContext:{item:{state:{stoodOnBy:e},config:{style:t}}}}=this;if(t!=="drum")return;const r=this.#e?.stoodOn??!1,o=Oe(e);!r&&o&&z({soundId:"drum",connectTo:this.output}),this.#e={stoodOn:o}}destroy(){}}class Ha{constructor(e){this.renderContext=e,this.scrapeBracketed=F({loop:{soundId:"stepStoolScraping"}},this.output),this.output.gain.value=.4}output=I.createGain();scrapeBracketed;tick({movedItems:e}){const{renderContext:{item:t,room:{roomTime:r}}}=this,{state:{actedOnAt:{roomTime:o},standingOnItemId:s}}=t,i=r===o&&s!==null&&e.has(t);this.scrapeBracketed(i)}destroy(){}}class Xa extends ln{constructor(e){super(e,{soundId:"glassClink",varyPlaybackRate:!0},.8),this.renderContext=e}}class Va{constructor(e){this.renderContext=e}output=I.createGain();tick({lastRenderRoomTime:e}){const{renderContext:{item:{state:{stoodOnBy:t,stoodOnUntilRoomTime:r}}}}=this,o=Oe(t);e!==void 0&&r>e&&!o&&z({soundId:"springBoing",connectTo:this.output})}destroy(){}}class Wa{constructor(e){this.renderContext=e,this.#e.connect(this.output)}output=I.createGain();#e=I.createGain();#t=void 0;tick(){const{renderContext:{item:{state:{setting:e},config:t}}}=this,r=t.type==="in-store"?tn(C.getState(),t.path)?"right":"left":e,o=this.#t?.setting;o!==void 0&&o!==r&&z({soundId:"switchClick",playbackRate:r==="right"?.95:1.05,connectTo:this.#e}),this.#t={setting:r}}destroy(){}}const ze=(n,e)=>nt(rt(n)).map(t=>{const r=e.items[t];if(r===void 0)throw new Error(`item in stoodOnBy "${t}" is not in the room`);return r}),Na=1e3/25,Po=n=>{const e=ot.animations[n],t=e.length,{animationSpeed:r}=e;return t*Na/r};Po("bubbles.white");Po("head.fadeOut");const un=({config:{activatedOnStoreValue:n}})=>n===void 0?!0:tn(C.getState(),n);class qa{constructor(e){this.renderContext=e}output=I.createGain();#e=F({loop:{soundId:"teleportWarningSiren"}},this.output);tick(){const{renderContext:{item:e,room:t}}=this;this.#e(un(e)&&ze(e.state.stoodOnBy,t).some(an))}destroy(){}}const Za=(n,e)=>Vr(ze(n.state.stoodOnBy,e).filter(Ur));class Ya{constructor(e){this.renderContext=e,this.output.gain.value=2}output=I.createGain();#e=void 0;tick(e){const{renderContext:{item:t,room:r}}=this,o=Za(t,r);this.#e!==void 0&&o<this.#e&&z({soundId:"toasterPopUpSoundUrl",connectTo:this.output}),this.#e=o}destroy(){}}const Ja={lift:$a,switch:Wa,button:Aa,bubbles:_a,head:wt,heels:wt,headOverHeels:wt,teleporter:qa,monster:Ea,conveyor:za,spring:Va,portableBlock:Ga,charles:Oa,ball:Ma,pushableBlock:Ha,firedDoughnut:Fa,slidingBlock:Xa},Ka=n=>{if(n.item.type==="deadlyBlock"&&n.item.config.style==="toaster")return new Ya(n);const e=Ja[n.item.type];if(e)return new e(n)},Nn=_.h*-1,qn=_.h*Fs,Qa=0,ec=_.w*16,bt=(n,e,t)=>(n-e)/(t-e)*2-1,tc=.5,nc=.3;class rc{constructor(e,t){this.renderContext=e,this.childRenderer=t,t.output.connect(this.output),this.output.rolloffFactor=2,this.output.maxDistance=5,this.output.distanceModel="exponential";const r=zs(e.room).floors;this.soundPositionMinX=r.edgeLeftX,this.soundPositionMaxX=r.edgeRightX}output=I.createPanner();soundPositionMinX;soundPositionMaxX;tick(e){this.childRenderer.tick(e);const{item:t}=this.renderContext,r=t.state,o=M(r.position,Tr(t.aabb,.5)),s=bt(Ne(o),this.soundPositionMinX,this.soundPositionMaxX),i=bt(o.z,Nn,qn);if(!Number.isFinite(i))throw new Error(`y position for sound rendering is not finite;
        positionY = numberInRangeToMinus1To1Range(
          itemCentrePosition = ${o.z},
          ${Nn},
          ${qn},
        );
        itemCentrePosition = addXyz(
          itemState.position = ${JSON.stringify(r.position)},
          scaleXyz(${JSON.stringify(t.aabb)}, 0.5),
        )`);const a=bt(o.x+o.y,Qa,ec);this.output.positionX.value=s*tc,this.output.positionY.value=i,this.output.positionZ.value=a*nc}destroy(){this.childRenderer.destroy()}}const Mo=n=>{let e=2166136261;const t=n.length;for(let r=Math.max(0,t-9);r<t;r++)e^=n.charCodeAt(r),e=Math.imul(e,1540483477),e^=e>>>15;return(e>>>0)/4294967295},Zn={x:.5,y:1},Yn=n=>typeof n!="string"&&Object.hasOwn(n,"animationId"),Gt=n=>{if(typeof n=="string")return Gt({textureId:n});{const{anchor:e,flipX:t,pivot:r,x:o,y:s,filter:i,times:a,label:c}=n;if(n.times){const u=Bs(a);if(Qt(u)>=2){const h=new w({label:c??"timesXyz"});for(let{x:d}=u;d>=1;d--)for(let{y:f}=u;f>=1;f--)for(let m=1;m<=u.z;m++){const v=n.textureId??n.textureIdCallback?.(d-1,f-1,m-1),y={...n,textureId:v,label:`(${d},${f},${m})`};"randomiseStartFrame"in y&&(y.randomiseStartFrame=`${y.randomiseStartFrame}${d},${f},${m}`),delete y.times;const S=Gt(y),k=se({x:d-1,y:f-1,z:m-1});S.x+=k.x,S.y+=+k.y,h.addChild(S)}return h}}let l;if(Yn(n))l=oc(n);else{const u=n.textureId??n.textureIdCallback?.(0,0,0);l=new ie(K().textures[u])}if(e===void 0&&r===void 0)if(Yn(n))l.anchor=Zn;else{const u=n.textureId??n.textureIdCallback?.(0,0,0),p=K().data.frames[u];if(p===void 0)throw new Error(`no spritesheet entry for textureId "${u}"`);const h=p.frame;h.pivot!==void 0?l.pivot=h.pivot:l.anchor=Zn}else e!==void 0&&(l.anchor=e),r!==void 0&&(l.pivot=r);return o!==void 0&&(l.x=o),s!==void 0&&(l.y=s),i!==void 0&&(l.filters=i),c!==void 0&&(l.label=c),l.eventMode="static",t===!0&&(l.scale.x=-1),l}},x=Gt;function oc({animationId:n,reverse:e,playOnce:t,paused:r,randomiseStartFrame:o,gameSpeed:s=1}){const a=K().animations[n].map(u=>({texture:u,time:rs}));e&&a.reverse();const c=new ge(a),l=r?0:s;return c.animationSpeed=ot.animations[n].animationSpeed*l,c.gotoAndPlay(o!==void 0?Math.floor(Mo(o)*a.length):0),t!==void 0&&(c.loop=!1,c.onComplete=()=>{c.stop(),t==="and-destroy"&&(c.visible=!1)}),c}const sc={Container:"📦",Sprite:"🖼️",UniqueTextureSprite:"✨",Graphics:"🎨",Text:"📝",AnimatedSprite:"🎬",TilingSprite:"🔲",BitmapText:"🔤",Mesh:"🔺",NineSliceSprite:"🔳"},Qe=(n,e="",t=!0,r=!0,o=[])=>{const s=[];r&&s.push("");const i=n.constructor.name,a=i.startsWith("_")?i.slice(1):i;let c=sc[a]||"📌";o.forEach((d,f)=>{d.mask===n&&(f===0?c+="😷":c+=`😷^${f+1}`)});const l=n.label&&n.label!==a?` "${n.label}"`:"",u=[];try{(n.x!==0||n.y!==0)&&u.push(`@(${n.x}, ${n.y})`)}catch{u.push("@(ERROR)")}if(n.children.length>2&&u.push(`children: ${n.children.length}`),n.visible||u.push("hidden"),n.alpha<1&&u.push(`alpha: ${n.alpha.toFixed(2)}`),n.mask&&u.push("😷 masked"),n instanceof ie){const d=n;if(d.texture===null||d.texture===void 0)u.push("texture: NO TEXTURE");else{const f=d.texture.label||"(anon texture)";u.push(`texture: "${f}"`)}}const p=r?"":e+(t?"└── ":"├── ");if(s.push(`${p}${c} ${a}${l}`),u.length>0){const d=n.children.length>0,f=r?d?"│  ":"   ":e+(t?"    ":"│   ")+(d?"│  ":"   ");u.forEach(m=>{s.push(`${f}→ ${m}`)})}const h=r?"":e+(t?"    ":"│   ");return n.children.forEach((d,f)=>{const m=f===n.children.length-1;s.push(Qe(d,h,m,!1,[n,...o]))}),s.join(`
`)+(r?`
`:"")};class ic extends ie{constructor(...e){const[t]=e;super(t)}destroy(e){const t=this.texture!==null;typeof e=="boolean"?super.destroy({texture:t,textureSource:e,children:e}):super.destroy({...e,texture:t})}}const ac=(n,e,t)=>{const r=e.getLocalBounds(),o=Math.ceil(r.maxX-r.minX),s=Math.ceil(r.maxY-r.minY),i=t!==void 0?t.width===o&&t.height===s:!1,a=i?t:it.create({width:o,height:s,antialias:!1,autoGenerateMipmaps:!1});a.label=`renderTexture of ${e.label??"(anon)"}`,t&&!i&&t.destroy();const{x:c,y:l}=e;e.x-=r.minX,e.y-=r.minY;try{n.render({container:e,target:a,clear:i})}catch(u){throw new Error(`renderContainerToTexture: failed to render to texture. Container:
 ${Qe(e)}`,{cause:u})}return e.x=c,e.y=l,a},oe=(n,e,t,r)=>{const o=e.getLocalBounds(),s=t?.texture&&t?.texture instanceof it?t.texture:void 0,i=ac(n,e,s),a=t||new ic;return a.texture=i,a.label=r??`sprite of container (${e.label})`,a.pivot={x:Math.floor(-o.minX),y:Math.floor(-o.minY)},a},Fe=(n,e)=>e instanceof ie?e:oe(n,e),cc=(n,e,t)=>e==="tower"?"tower":e==="book"?"book.x":e==="organic"&&n?`block.organic.dark${t?".disappearing":""}`:`block.${e}${t?".disappearing":""}`,lc=({renderContext:{general:{pixiRenderer:n},item:{config:{style:e,times:t},state:{disappearing:r}},room:o},currentRendering:s})=>{const i=s?.renderProps,a=r!==null;return i===void 0||i.isDissapearing!==a?{output:Fe(n,x({textureId:cc(o.color.shade==="dimmed",e,a),filter:e==="organic"?j(o):e==="book"?Ro(o):void 0,times:t})),renderProps:{isDissapearing:a}}:"no-update"},uc=({renderContext:{item:{state:{pressed:n}},room:e},currentRendering:t})=>{const r=t?.renderProps;return r===void 0||n!==r.pressed?{output:x({textureId:n?"buttonInGame.pressed":"buttonInGame",filter:j(e)}),renderProps:{pressed:n}}:"no-update"},Ct={animationId:"bubbles.cold"},pe=({top:n,bottom:e="headlessBase",filter:t})=>{const r=new w({filters:t}),o=x(e);r.addChild(o);const s=x(n);return s.y=-12,r.addChild(s),r[at]=s,r[dn]=o,r},at=Symbol(),dn=Symbol(),dc=({top:n,bottom:e})=>{const t=new w;return t.addChild(e),n.y=-12,t.addChild(n),t[at]=n,t[dn]=e,t},hc=({renderContext:{item:{state:{facing:n,actedOnAt:{roomTime:e,by:t}}},room:{roomTime:r,items:o}},currentRendering:s})=>{const i=s?.renderProps,a=nn(n)??"towards",c=r===e&&nt(rt(t)).some(u=>Lr(o[u]));return i===void 0||a!==i.facingXy4||c!==i.controlledByJoystick?{output:pe({top:`charles.${a}`,bottom:c?"headlessBase.all":"headlessBase"}),renderProps:{facingXy4:a,controlledByJoystick:c}}:"no-update"},ct=n=>n,Jn=500,pc=ot.animations["conveyor.x"].animationSpeed,Kn=ot.animations["conveyor.x"].length,fc=n=>1-(1-n)**2,mc=(n,e)=>{for(let t=0;t<n.children.length;t++){const r=n.children[t],o=t%Kn;r.gotoAndStop(e?Kn-o-1:o)}},gc=(n,e,t=1)=>{const r=J(n),o=x({animationId:`conveyor.${r}`,reverse:n==="towards"||n==="right",times:e,gameSpeed:t}),s=o instanceof ge?new w({children:[o]}):o;return mc(s,n==="towards"||n==="right"),s},xc=({renderContext:{item:{config:{times:n},state:{stoodOnBy:e,direction:t}},room:{roomTime:r},general:{gameState:o}},currentRendering:s})=>{const i=s?.renderProps,a=Oe(e),c=(!a&&i?.moving?r:i?.roomTimeStoppedMoving)??sn,l=a?0:Math.min(r-c,Jn),u=s?.output,h=!u||t!==i?.direction?gc(t,n,o?.gameSpeed):u,d=Math.max(0,1-l/Jn);for(const f of h.children)if(d===0)f.stop();else{const m=pc*fc(d);f.play(),f.animationSpeed=m}return{output:h,renderProps:{moving:a,roomTimeStoppedMoving:c,direction:t}}},yc=ct(xc);function _o(n,e){const t=e||new w;for(const r of n)t.addChild(r);return t}const lt=(n,e)=>{const t=e&&{x:e.x??1,y:e.y??1};return x({...typeof n=="string"?{textureId:n}:n,times:t})},re=n=>O(({renderContext:{item:e}})=>cn(e)?x({...typeof n=="string"?{textureId:n}:n,times:st(e)}):x(n)),vc=n=>O(({renderContext:{item:e,general:{gameState:t,paused:r}}})=>cn(e)?x({...n,times:st(e),paused:r,gameSpeed:t?.gameSpeed}):x({...n,paused:r,gameSpeed:t?.gameSpeed})),E=n=>O(({renderContext:{item:e,general:{pixiRenderer:t}}})=>{if(cn(e))return Fe(t,lt(n,st(e)));{const r=x(n);return r instanceof ie?r:oe(t,r)}}),O=n=>(({renderContext:e,currentRendering:t,tickContext:r})=>t===void 0?{output:n({renderContext:e,currentRendering:void 0,tickContext:r}),renderProps:Ae}:"no-update"),q=n=>(({renderContext:{general:{pixiRenderer:e},item:t},currentRendering:r})=>{if(r===void 0){const o=st(t),s={output:Fe(e,lt(n(t.config),o)),renderProps:Ae};return o&&(s.output.y-=((o.z??1)-1)*_.h),s}else return"no-update"}),wc=(n,e,t)=>{const o=K().textures[`door.frame.${n.planet}.${e}.near`]!==void 0?n.planet:"generic",s=n.color.shade==="dimmed"&&K().textures[`door.frame.${o}.dark.${e}.${t}`]!==void 0;return`door.frame.${o}${s?".dark":""}.${e}.${t}`};function*bc({config:{direction:n,inHiddenWall:e,height:t}},r){const o=rn(n),s=o==="y"?1:16;function*i(a){if(e){if(t!==0){const c=x({textureId:`generic.door.floatingThreshold.${o}`,...Te(a,{y:-12*t})});c.filters=To(r,o==="x"?"towards":"right",!0),yield c}}else{yield x({pivot:{x:s,y:9},textureId:`generic.door.legs.base.${o}`,...Te(a,{})});for(let c=1;c<t;c++)yield x({pivot:{x:s,y:9},textureId:`generic.door.legs.pillar.${o}`,...Te(a,{y:-c*_.h})})}}yield*i(se({...fe,[o]:1})),yield*i(fe),e||(yield x({pivot:{x:16,y:_.h*t+13},textureId:`generic.door.legs.threshold.double.${o}`,...se({...fe,[o]:1})}))}const Ao=(n,e)=>{const t=rn(n),r=_e(t),o=8;return n==="towards"||n==="right"?b({[r]:e[r]-o}):fe},Cc=O(({renderContext:{item:n,room:e}})=>_o(bc(n,e),new w({filters:j(e),...Ao(n.config.direction,n.aabb)}))),Sc=O(({renderContext:{item:{config:{direction:n,part:e,toRoom:t},aabb:r},room:o}})=>{const s=os(C.getState())??C.getState().levelEditor?.campaignInProgress,i=rn(n),a=s?.rooms[t]??o;return x({textureId:wc(o,i,e),filter:j(a),...Ao(n,r)})}),Ic=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform vec2 uTextureSize;
uniform sampler2D uTexture;
uniform vec3 uOutline;
uniform float uOutlineWidth;

void main(void) {
    vec2 scaledTexelSize = vec2(1.0f) / vec2(textureSize(uTexture, 0)) * uOutlineWidth;    
    
    // Calculate offset coordinates
    vec2 rightCoord = vec2(vTextureCoord.x + scaledTexelSize.x, vTextureCoord.y);
    vec2 leftCoord = vec2(vTextureCoord.x - scaledTexelSize.x, vTextureCoord.y);
    vec2 belowCoord = vec2(vTextureCoord.x, vTextureCoord.y + scaledTexelSize.y);
    vec2 aboveCoord = vec2(vTextureCoord.x, vTextureCoord.y - scaledTexelSize.y);
    
    // Create boundary masks (1.0 if within bounds, 0.0 if out of bounds)
    // seems to work fine without this, but could multiply colourToX by this to get zero'd out when OOB
    // float rightInBounds = step(rightCoord.x, 1.0);
    // float leftInBounds = step(0.0, leftCoord.x);
    // float belowInBounds = step(belowCoord.y, 1.0);
    // float aboveInBounds = step(0.0, aboveCoord.y);
    
    vec4 colourToRight = texture(uTexture, rightCoord);
    vec4 colourToLeft = texture(uTexture, leftCoord);
    vec4 colourBelow = texture(uTexture, belowCoord);
    vec4 colourAbove = texture(uTexture, aboveCoord);
    
    // Check if any neighbor is opaque (combine all alpha values)
    float hasOpaqueNeighbor = max(max(colourToRight.a, colourToLeft.a), 
                                  max(colourBelow.a, colourAbove.a));

    vec4 originalColour = texture(uTexture, vTextureCoord);
        
    finalColor = mix(
        originalColour, 
        vec4(uOutline, 1), 
        // 1 if: original colour is transparent and has an opaque neighbour - use outline colour
        // 0 if: original colour is opaque or has no opaque neighbour - use original colour (transparent or sprite)
        (1.0 - originalColour.a) * hasOpaqueNeighbor
    );
}
`;let Ht=Mr(C.getState());C.subscribe(()=>{Ht=Mr(C.getState())});class Xt extends Q{outlineWidth;constructor({color:e,width:t}){const r=W.from({vertex:ve,fragment:Ic,name:"outline-filter"}),o=t??Ht;super({glProgram:r,padding:o,resources:{colorReplaceUniforms:{uOutline:{value:new Float32Array(3),type:"vec3<f32>"},uOutlineWidth:{value:new Float32Array(1),type:"f32"}}}}),this.outlineWidth=t;const s=this.resources.colorReplaceUniforms.uniforms,[i,a,c]=e.toArray();s.uOutline[0]=i,s.uOutline[1]=a,s.uOutline[2]=c}apply(e,t,r,o){const s=this.resources.colorReplaceUniforms.uniforms,i=this.outlineWidth??Ht;this.padding=i,s.uOutlineWidth[0]=i,super.apply(e,t,r,o)}}const G={...ss(g,([n,e])=>[n,new Xt({color:e})]),black1pxFilter:new Xt({color:g.pureBlack,width:1})},Xe=G.pureBlack;new B;new B;new B;new B(g.moss);new B;new B(g[he.head]),new B(Cn(g[he.head])),new B(g[he.heels]),new B(Cn(g[he.heels]));function kc(n){const e=`hud.char.${is(n)}`;try{Hr(e)}catch(t){throw new Error(`no texture id for char "${n}": ${t.message}`,{cause:t})}return e}const Tc=(n,e)=>(n+.5-e/2)*as.w,Rc=n=>typeof n=="string"?n==="infinite"?"":n:n.toString(),Oo=(n,e)=>{const t=Rc(e),r=Vr(t),o=n.children.length,s=r!==o;try{let i=0;for(const a of t){const c=kc(a);let l;if(i<o){l=n.getChildAt(i);const u=K().textures[c];l.texture=u}else l=x(c),n.addChild(l);i++}}catch(i){throw console.error("invalid string is",t,"and on window as window.invalid"),console.error(i),window.invalid=e,new Error(`could not show text "${e}" in container because: "${i.message}"`,{cause:i})}if(s){r<o&&n.removeChildren(r);for(let i=0;i<r;i++){const a=n.getChildAt(i);a.x=Tc(n.getChildIndex(a),r)}}return n},Pc=$s.floatingText,Qn=12,er=_.h*3,tr=[g.shadow,g.midGrey,g.redShadow,g.metallicBlue,g.midRed,g.moss,g.pink,g.lightBeige,g.pastelBlue,g.lightGrey,g.highlightBeige],nr=[...tr,...new Array(20).fill(g.white),...tr.toReversed()],Mc=({renderContext:{item:{config:{textLines:n,appearanceRoomTime:e}},room:{roomTime:t},general:{displaySettings:{uncolourised:r}},frontLayer:o},currentRendering:s})=>{const i=s?.output;let a;const l=(t-e)*Pc;if(i===void 0){a=new w({filters:G.pureBlack}),o?.attach(a);for(let p=0;p<n.length;p++){const h=n[p],d=Oo(new w({label:h,y:p*Qn,filters:r?te:new B(g.pink)}),h.toUpperCase());a.addChild(d)}}else a=i;let u=!1;for(let p=0;p<n.length;p++){const h=a.children[p],[d]=h.filters,f=l+p*-Qn,m=f>0&&f<er;if(h.visible=m,u||=m,m&&d){const v=Math.floor(f/er*nr.length);d.targetColor=nr[v]}}return a.visible=u,a.y=-l,{output:a,renderProps:Ae}},rr=(n,e)=>e===0?n:Math.round(n/e)*e,or=n=>n-Math.floor(n),_c=(n,e,t,r)=>n<=r&&t<=e,Ac=`#version 300 es
precision lowp float;

out vec4 finalColor;

in vec2 vTextureCoord;
uniform sampler2D uBackBuffer;
uniform vec3 uTargetColor;
// do not use uTexture in this frag - for some reason it causes pixi's render pipeline
// to take away the backbuffer, which we rely on sampling from

void main() {
    vec3 bg = texture(uBackBuffer, vTextureCoord).rgb;

    float isBlack = step(length(bg), 0.001f); // 1 if black, 0 otherwise
    finalColor = mix(vec4(uTargetColor, 1.0f), vec4(0, 0, 0, 0), isBlack);


}`;class sr extends Q{uniforms;constructor(e="white"){const t=W.from({vertex:ve,fragment:Ac,name:"colour-clash-filter"});super({glProgram:t,resources:{colorReplaceUniforms:{uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}},blendRequired:!0}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this.targetColor=e}set targetColor(e){const[t,r,o]=new P(e).toArray();this.uniforms.uTargetColor[0]=t,this.uniforms.uTargetColor[1]=r,this.uniforms.uTargetColor[2]=o}}const Oc=({state:{position:n}},e)=>{const t=o=>o.config.direction==="away"||o.config.direction==="left";return _o(Z(e.items).filter(o=>o.type==="wall"||o.type==="doorLegs").filter(t).map(o=>{const{id:s,config:{direction:i},state:{position:a}}=o;return x({textureId:"floorOverdraw.cornerNearWall",label:s,...b(Ot(a,n)),times:o.type==="wall"?zr(o.config):{[_e(J(i))]:2},anchor:{x:0,y:1},flipX:i==="away"})}),new w({label:"floorOverdraws"}))},zc=(n,e)=>{const{config:{naturalFootprint:{aabb:t,position:r}},state:{position:o}}=e,s=Ne(Y(me,o)),{left:i,right:a}=Z(n.items).filter(Es).filter(c=>{const{state:{position:l},aabb:u}=c,p=c.config.direction,h=J(p),d=_e(h),f=p==="away"||p==="left",m=r[h]+(f?1:0)*t[h],v=l[h]+(f?0:1)*u[h];return m!==v?!1:_c(l[d],l[d]+u[d],r[d],r[d]+t[d])}).reduce((c,{aabb:l,renderAabb:u,renderAabbOffset:p,state:{position:h},fixedZIndex:d})=>{const f=d===Ls,m=f?l:u??l,v=M(h,p??me),y=Ne(M(v,{x:m.x,y:f?m.y:0}))+s,S=Ne(M(v,{x:f?m.x:0,y:m.y}))+s;return{left:Math.min(c.left,y),right:Math.max(c.right,S)}},{left:9999,right:-9999});if(a>i)return new V().rect(i,-500,a-i,500).fill("rgba(255, 0, 0)")},ir=({colourised:n,direction:e,room:t,times:r,position:o,colourSwap:s})=>x({label:`floorEdge(${e})`,textureId:`floorEdge.${e}`,times:r,filter:s?To(t,e,n):void 0,...b(o)}),Fc=({room:n,xSize:e,ySize:t,y:r})=>{const o=new w({label:"floorColourClash"}),s=Gn(n,"right");for(let a=0;a<=t;a++){const c=se({x:0,y:a,z:0}),l=new V().rect(c.x-(a===0?0:8),c.y,24,8).fill(s);l.filters=new sr(s),o.addChild(l)}const i=Gn(n,"towards");for(let a=0;a<=e;a++){const c=se({x:a,y:0,z:0}),l=new V().rect(c.x-16,c.y,8*(a===0?2:3),8).fill(i);l.filters=new sr(i),o.addChild(l)}return o.y=r,o},Bc=O(({renderContext:{room:n,item:e,general:{colourised:t,pixiRenderer:r},colourClashLayer:o}})=>{const{color:{shade:s}}=n,{config:i,state:{position:a},aabb:c}=e,{floorType:l,naturalFootprint:u}=i,p=new w({label:"floorAppearance"}),h=new w({label:"sprites"}),d=b({...c,y:0}),f=b({...c,x:0,y:0}),m=b({...c,x:0}),v=b(c);if(l!=="none"){const y=new w({label:"tiles"}),S=l==="deadly"?`generic${s==="dimmed"?".dark":""}.floor.deadly`:`${i.scenery}${s==="dimmed"?".dark":""}.floor`,k=K().textures[S];try{Hr(S)}catch(Eo){throw new Error(`no floor textureId for floorType: ${l}, shade: ${s}`,{cause:Eo})}const T=Y(u.position,a),A={x:or(T.x/_.w),y:or(T.y/_.w)},ne=8,U={x:d.x,y:v.y-ne,width:m.x-d.x,height:f.y-v.y+2*ne},Be=Y(se(Te(A,{x:.5,y:.5})),{y:c.z},U),$o=new bi({texture:k,tilePosition:Be,...U});y.addChild($o),y.addChild(Oc(e,n));const hn=new V().moveTo(v.x,v.y).lineTo(m.x,m.y).lineTo(m.x,m.y+3).lineTo(f.x,f.y+3).lineTo(d.x,d.y+3).lineTo(d.x,d.y).fill({color:16711680,alpha:1}),pn=oe(r,hn);hn.destroy(),y.addChild(pn),y.mask=pn,y.filters=[Ra(n)];const fn=new w({children:[y]});fn.filters=G.black1pxFilter,h.addChild(fn)}{const y=new w({label:"edges"});l==="none"&&y.addChild(new V().moveTo(m.x,m.y+8).lineTo(m.x,m.y+100).lineTo(d.x,d.y+100).lineTo(d.x,d.y+8).lineTo(f.x,f.y+8).fill(0));const S=Math.ceil(c.y/_.w);y.addChild(ir({colourised:t,direction:"right",room:n,times:{y:S},position:{z:c.z},colourSwap:t}));const k=Math.ceil(c.x/_.w);y.addChild(ir({colourised:t,direction:"towards",room:n,times:{x:k},position:{z:c.z},colourSwap:t})),h.addChild(y);const T=zc(n,e);if(T!==void 0){const A=oe(r,T);h.addChild(A),h.mask=A,T.destroy()}if(p.addChild(oe(r,h)),h.destroy({children:!0}),!t){const A=Fc({xSize:k,ySize:S,y:-c.z+1,room:n});p.addChild(A),o.attach(A)}}return p}),$c=["cyberman","dalek","skiHead","bubbleRobot","computerBot","turtle","homingBot"],Ec=200,Lc=1,Uc=(n,e)=>{const t=Mo(e);return Math.sin((n+t*2e4)/Ec)*Lc},ar=({id:n,config:{which:e},state:t},r,o)=>{if((e==="cyberman"||e==="bubbleRobot")&&t.activated||e==="emperorsGuardian"){const s=o;s[at].y=-12+Uc(r.roomTime,n)}},Dc=({renderContext:{item:n,room:e,general:{paused:t,gameState:r}},currentRendering:o})=>{const{config:s,state:i}=n,a=o?.renderProps,{activated:c,busyLickingDoughnutsOffFace:l}=i,u=l?Ta:c?void 0:$c.includes(s.which)?ka(e):void 0;switch(s.which){case"skiHead":case"turtle":case"cyberman":case"computerBot":case"elephant":case"elephantHead":case"monkey":{const p=nn(i.facing)??"towards";if(!(a===void 0||c!==a.activated||l!==a.busyLickingDoughnutsOffFace||p!==a.facingXy4))return ar(n,e,o.output),"no-update";const d={facingXy4:p,activated:c,busyLickingDoughnutsOffFace:l};switch(s.which){case"skiHead":return{output:x({textureId:`${s.which}.${s.style}.${p}`,filter:u}),renderProps:d};case"elephantHead":return{output:x({textureId:`elephant.${p}`,filter:u}),renderProps:d};case"turtle":return{output:x(c&&!l?{animationId:`${s.which}.${p}`,filter:u,paused:t,gameSpeed:r?.gameSpeed}:{textureId:`${s.which}.${p}.1`,filter:u}),renderProps:d};case"cyberman":return{output:i.activated||i.busyLickingDoughnutsOffFace?pe({top:{textureId:`${s.which}.${p}`,filter:u||j(e)},bottom:{...Ct,paused:t,gameSpeed:r?.gameSpeed}}):x({textureId:`${s.which}.${p}`,filter:u}),renderProps:d};case"computerBot":case"elephant":case"monkey":return{output:pe({top:`${s.which}.${p}`,bottom:{animationId:"headlessBase.flash",playOnce:"and-stop",gameSpeed:r?.gameSpeed},filter:u}),renderProps:d};default:throw new Error(`unexpected monster ${s}`)}break}case"homingBot":{const p=!cs(i.vels.walking,fe);return a===void 0||l!==a.busyLickingDoughnutsOffFace||c!==a.activated||p!==a.walking?{filter:u,output:x(c&&!l?{animationId:p?"headlessBase.flash":"headlessBase.scan",filter:u,gameSpeed:r?.gameSpeed}:{textureId:"headlessBase",filter:u,gameSpeed:r?.gameSpeed}),renderProps:{activated:c,busyLickingDoughnutsOffFace:l,walking:p}}:"no-update"}case"helicopterBug":case"emperor":case"dalek":case"bubbleRobot":case"emperorsGuardian":{if(!(a===void 0||l!==a.busyLickingDoughnutsOffFace||c!==a.activated))return ar(n,e,o.output),"no-update";const h={activated:c,busyLickingDoughnutsOffFace:l};switch(s.which){case"helicopterBug":case"dalek":return{output:x(c&&!l?{animationId:s.which,filter:u,paused:t,gameSpeed:r?.gameSpeed}:{textureId:`${s.which}.1`,filter:u}),renderProps:h};case"bubbleRobot":return{output:pe({top:{...Ct,paused:t,gameSpeed:r?.gameSpeed},filter:u}),renderProps:h};case"emperorsGuardian":return{output:pe({top:"ball",bottom:{...Ct,paused:t,gameSpeed:r?.gameSpeed},filter:u}),renderProps:h};case"emperor":return{output:x({animationId:"bubbles.cold",filter:u,paused:t,gameSpeed:r?.gameSpeed}),renderProps:h};default:throw new Error(`unexpected monster ${s}`)}break}default:throw new Error(`unexpected monster ${s}`)}},jc=n=>{const{gameTime:e,lastDiedAt:t}=n.type==="headOverHeels"?n.state.head:n.state;return e-t<Us},St=n=>{if(n===void 0)return 0;const{shieldCollectedAt:e,gameTime:t}=n;return e!==null&&e+yn>t?100-Math.ceil((t-e)/(yn/100)):0},Gc=n=>n.type==="headOverHeels"?St(n.state.head)>0||St(n.state.heels)>0:St(n.state)>0,Hc=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uColour;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    // we know c.a is either 0 or 1, so no need to do a step()

    finalColor = mix(c, vec4(uColour, 1), c.a);
}
`;class et extends Q{constructor(e){const t=W.from({vertex:ve,fragment:Hc,name:"oneColour-filter"});super({glProgram:t,resources:{colorReplaceUniforms:{uColour:{value:new Float32Array(3),type:"vec3<f32>"}}}});const r=this.resources.colorReplaceUniforms.uniforms,[o,s,i]=e.toArray();r.uColour[0]=o,r.uColour[1]=s,r.uColour[2]=i}}const Vt=.02,Xc=({name:n,action:e,facingXy8:t,teleportingPhase:r,gravityZ:o,paused:s,gameSpeed:i})=>{if(e==="death")return{animationId:`${n}.fadeOut`,paused:s,gameSpeed:i};if(r==="out")return{animationId:`${n}.fadeOut`,paused:s,gameSpeed:i};if(r==="in")return{animationId:`${n}.fadeOut`,paused:s,gameSpeed:i};if(e==="moving")return{animationId:`${n}.walking.${t}`,paused:s,gameSpeed:i};if(e==="jumping")return{textureId:o<Vt?`${n}.walking.${t}.2`:`${n}.walking.${t}.1`};if(e==="falling"){const c=`${n}.falling.${t}`;if(Qs(c))return{textureId:c}}const a=`${n}.idle.${t}`;return Xr(a)?{animationId:a,paused:s,gameSpeed:i}:{textureId:`${n}.walking.${t}.2`}},Wt=Symbol(),Nt=Symbol(),Vc=(n,e)=>{n[Wt].removeChildren(),n[Wt].addChild(x(Xc(e)))},zo=ee({pastelBlue:g.pink}),It=(n,e,t,r)=>{const o=new w,s=new w;o[Wt]=s,o.addChild(s);const i=x({animationId:e?`shine.${n}InSymbio`:"shine",paused:t,filter:n==="heels"?zo:te,flipX:n==="heels",gameSpeed:r??1});return o[Nt]=i,o},cr=({gameTime:n,switchedToAt:e},t,r)=>(t==="headOverHeels"||t===r)&&e+Ds>n,Wc=n=>{if(!jc(n))return!1;const{gameTime:e,lastDiedAt:t}=n.type==="headOverHeels"?n.state.head:n.state;return(e-t)%vn<vn*js},lr=(n,e)=>{n.filters?Array.isArray(n.filters)?n.filters=[...n.filters,e]:n.filters=[n.filters,e].flat():n.filters=e},ur=(n,e)=>{n.filters=Array.isArray(n.filters)?n.filters.filter(t=>!(t instanceof e)):n.filters instanceof e?te:[...n.filters]},Nc=(n,{highlighted:e,flashing:t},r,o)=>{const s=r?.highlighted??!1;e&&!s?lr(o,G[he[n]]):!e&&s&&ur(o,Xt);const i=r?.flashing??!1;t&&!i?lr(o,new et(g[he[n]])):!t&&i&&ur(o,et)},qc=(n,e,t)=>{e&&!t?n.addChild(n[Nt]):!e&&t&&n.removeChild(n[Nt])},kt=(n,e,t,r,o,s,i)=>{t&&Vc(e,{name:n,...r,gameSpeed:s,paused:o}),Nc(n,r,i,e),qc(e,r.shining,i?.shining??!1)},Zc=({renderContext:{item:n,general:{gameState:e,paused:t}},currentRendering:r})=>{const{type:o,state:{action:s,facing:i,teleporting:a,vels:{gravity:{z:c}}}}=n,l=r?.renderProps,u=r?.output,p=Pr(i)??"towards",h=e!==void 0&&(n.type==="headOverHeels"?cr(n.state.head,"headOverHeels","headOverHeels"):cr(n.state,n.type,e.currentCharacterName)),d=Wc(n),f=Gc(n),m=Qt(i),v=a?.phase??null,y={action:s,facingXy8:p,teleportingPhase:v,flashing:d,highlighted:h,shining:f,gravityZ:c},S=l===void 0||l.action!==s||l.facingXy8!==p||l.teleportingPhase!==v||l?.gravityZ>Vt!=c>Vt;let k;if(o==="headOverHeels"){k=u??dc({top:It("head",!0,t,e?.gameSpeed),bottom:It("heels",!0,t,e?.gameSpeed)});const T=k;kt("head",T[at],S,y,t,e?.gameSpeed,l),kt("heels",T[dn],S,y,t,e?.gameSpeed,l)}else k=u??It(o,!1,t,e?.gameSpeed),kt(o,k,S,y,t,e?.gameSpeed,l);return s==="moving"&&u instanceof ge&&(u.animationSpeed=m*ls),{output:k,renderProps:y}},Tt=ct(Zc),Yc=({renderContext:{item:{config:{which:n,startDirection:e}}},currentRendering:t})=>t?.renderProps===void 0?{output:n==="headOverHeels"?pe({top:{textureId:`head.walking.${e}.2`},bottom:{textureId:`heels.walking.${e}.2`}}):x({textureId:`${n}.walking.${e}.2`}),renderProps:Ae}:"no-update",Jc=({renderContext:{item:{state:{vels:{sliding:n}},config:{startingPhase:e}},general:{paused:t}},tickContext:{deltaMS:r},currentRendering:o})=>{const i=(o?.renderProps?.distanceTravelled??0)+Jt(n)*(t?0:r),c=o?.output??x("spikyBall.1"),u=(Math.floor(i*2/Ve.w)+e)%2+1;return c.texture=K().textures[`spikyBall.${u}`],{output:c,renderProps:{distanceTravelled:i}}},Kc=ct(Jc),Qc=({renderContext:{item:{state:{stoodOnBy:n,stoodOnUntilRoomTime:e}},general:{paused:t,gameState:r}},tickContext:{lastRenderRoomTime:o},currentRendering:s})=>{const i=s?.renderProps,a=Oe(n);let c;return s?.output?c=s?.output:(c=x({animationId:"spring.bounce",gameSpeed:r?.gameSpeed,paused:t}),c.loop=!1,c.gotoAndStop(0)),o!==void 0&&e>o&&!a&&!t?c.gotoAndPlay(0):a&&!(i?.compressed??!1)&&c.gotoAndStop(1),{output:c,renderProps:{compressed:a}}},el=ct(Qc),tl=({renderContext:{item:{state:{setting:n},config:e}},currentRendering:t})=>{const r=t?.renderProps,o=e.type==="in-store"?tn(C.getState(),e.path)?"right":"left":n;return r===void 0||o!==r.setting?{output:x(`switch.${o}`),renderProps:{setting:o}}:"no-update"},nl=({renderContext:{item:n,room:e,general:{paused:t,gameState:r}},currentRendering:o})=>{const{state:{stoodOnBy:s},config:{times:i}}=n,a=o?.renderProps,c=un(n),l=c&&ze(s,e).some(an);return a===void 0||c!==a.activated||l!==a.flashing?{output:l?new w({children:[x({textureId:"teleporter",times:i}),x({animationId:"teleporter.flashing",times:i,paused:t,gameSpeed:r?.gameSpeed})]}):x({textureId:c?"teleporter":"block.artificial",times:i}),renderProps:{flashing:l,activated:c}}:"no-update"},rl=({state:{stoodOnBy:n,position:e},config:{times:t}},r)=>{const o=new Array(t?.x??1).fill(null).map(()=>new Array(t?.y??1));return ze(n,r).filter(Ur).forEach(({id:s,state:{position:i}})=>{const a=Y(i,e),c={x:Math.floor(a.x/_.w),y:Math.floor(a.y/_.d)};c.x<0||c.x>=(t?.x??1)||c.y<0||c.y>=(t?.y??1)||(o[c.x][c.y]=s)}),o},ol=(n,e)=>{let t=0,r=1;for(const o of e)for(const s of o)s!==void 0&&n.items[s]?.state.activated&&(t|=r),r<<=1;return t},sl=({renderContext:{item:n,room:e},currentRendering:t})=>{const{config:{times:r}}=n,o=t===void 0?rl(n,e):t.renderProps.chargePositions,s=ol(e,o);return s!==t?.renderProps.cybermanActivationBitmask?{output:x({textureIdCallback(a,c){const l=o[a][c];return l===void 0||e.items[l]?.state.everActivated?"toaster.off":"toaster.on"},times:r??Ae}),renderProps:{chargePositions:o,cybermanActivationBitmask:s}}:"no-update"},il=(n,e,t,r)=>`${n}${r?".dark":""}.wall.${e}.${t}`,al=O(({renderContext:{general:{pixiRenderer:n,gameState:e},item:{id:t,config:r},room:o}})=>{if(r.direction==="right"||r.direction==="towards")throw new Error(`wall is near: ${t}`);const{direction:s,tiles:i}=r,a=_e(J(s)),c=new w({label:"wallTiles"}),l=new w({label:"wallAnimations"});for(let p=0;p<r.tiles.length;p++){const h=se({[a]:p});if(c.addChild(x({textureId:il(o.planet,i[p],s,o.color.shade==="dimmed"),...h,pivot:s==="away"?{x:Ve.w,y:Ve.h}:{x:0,y:Ve.h}})),o.planet==="moonbase"){const d=`moonbase.wall.screen.${i[p]}.away`;Xr(d)&&l.addChild(x({animationId:d,randomiseStartFrame:`${t}${p}`,flipX:s==="left",x:h.x+(s==="away"?-8:8),y:h.y-23,gameSpeed:e?.gameSpeed}))}}const u=new w({label:"wallAppearance"});return u.addChild(oe(n,c)),l.children.length>0&&u.addChild(l),u.filters=j(o),u}),cl={head:Tt,heels:Tt,headOverHeels:Tt,doorFrame:Sc,doorLegs:Cc,monster:Dc,floatingText:Mc,barrier:O(({renderContext:{item:{config:{axis:n,times:e}}}})=>x({textureId:`barrier.${n}`,times:e})),deadlyBlock:O(({renderContext:{item:{config:n,id:e},room:t,general:{paused:r,gameState:o}}})=>{switch(n.style){case"volcano":return x({animationId:"volcano",filter:j(t),times:n.times,randomiseStartFrame:e,paused:r,gameSpeed:o?.gameSpeed});case"toaster":throw new Error("use the special toaster appearance instead");default:throw n.style,new Error("unknown deadly block style")}}),spikes:re("spikes"),slidingDeadly:Kc,slidingBlock:O(({renderContext:{item:{config:{style:n}},room:e}})=>x(n==="book"?{textureId:"book.y",filter:Ro(e)}:n)),block:lc,switch:tl,button:uc,conveyor:yc,lift:O(({renderContext:{general:{paused:n,gameState:e}}})=>{const t=new w,r={x:gn.w/2,y:gn.h};return t.addChild(x({animationId:"lift",pivot:r,paused:n,gameSpeed:e?.gameSpeed})),t.addChild(x({textureId:"lift.static",pivot:r})),t}),teleporter:nl,sceneryCrown:O(({renderContext:{item:{config:{planet:n}}}})=>x({textureId:`crown.${n}`})),pickup:O(({renderContext:{item:{config:n},room:e,general:{paused:t,gameState:r}}})=>{if(n.gives==="crown")return x({textureId:`crown.${n.planet}`});const s={shield:"whiteRabbit",jumps:"whiteRabbit",fast:"whiteRabbit","extra-life":"whiteRabbit",bag:"bag",doughnuts:"doughnuts",hooter:"hooter",scroll:{textureId:"scroll",filter:j(e)},reincarnation:{animationId:"fish",paused:t,gameSpeed:r?.gameSpeed}}[n.gives];return x(s)}),moveableDeadly:re("fish.1"),charles:hc,joystick:re("joystick"),movingPlatform:re("sandwich"),pushableBlock:re("stepStool"),portableBlock:O(({renderContext:{item:{config:{style:n}}}})=>x(n)),spring:el,sceneryPlayer:Yc,hushPuppy:re("hushPuppy"),bubbles:O(({renderContext:{item:{config:{style:n}},general:{paused:e,gameState:t}}})=>x({animationId:`bubbles.${n}`,paused:e,gameSpeed:t?.gameSpeed})),firedDoughnut:vc({animationId:"bubbles.doughnut"}),ball:re("ball"),floor:Bc,particle:O(({renderContext:{item:{config:{forCharacter:n}},general:{paused:e,gameState:t}}})=>x({animationId:"particle.fade",anchor:{x:.5,y:.5},filter:n==="heels"?zo:te,paused:e,gameSpeed:t?.gameSpeed}))},ll=n=>{if(n.type==="wall"){const{direction:e}=n.config;return e==="right"||e==="towards"?void 0:al}return n.type==="deadlyBlock"&&n.config.style==="toaster"?sl:cl[n.type]},ul=g.pastelBlue,dr=G.highlightBeige,hr=G.midRed,dl=G.white,pr=new B(ul),fr={left:"↖",away:"↗",right:"↘",towards:"↙"},mr=n=>n.type==="switch"&&n.config.type==="in-room"||n.type==="button",gr=(n,e)=>{switch(n){case"back-forth":switch(e){case"left":return"↖↘";case"right":return"↘↖";case"away":return"↗↙";case"towards":return"↙↗";default:throw new Error("Unexpected startDirection")}case"forwards":switch(e){case"left":return"↖";case"right":return"↘";case"away":return"↗";case"towards":return"↙";default:throw new Error("Unexpected startDirection")}case"clockwise":switch(e){case"left":return"↖↗↘↙";case"right":return"↘↙↖↘";case"away":return"↗↘↙↖";case"towards":return"↙↖↗↘";default:throw new Error("Unexpected startDirection")}case"towards-analogue":return"➡.⬅"}return""};class hl{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output),this.#e()}output=new w({label:"EditorAnnotationsRenderer"});#e(){const e=this.renderContext.item;switch(e.type){case"pickup":if(e.config.gives==="shield"||e.config.gives==="extra-life"||e.config.gives==="jumps"||e.config.gives==="fast"){const t={shield:"🛡",jumps:"♨",fast:"⚡","extra-life":"+2"};this.#t({annotationText:t[e.config.gives],yAdj:-16})}break;case"doorFrame":if(e.config.part==="near"){const{rooms:t}=C.getState().levelEditor.campaignInProgress,{config:{toRoom:r,direction:o}}=e,s=!!t[r],i=r.toUpperCase(),a=fr[o],c=o==="away"||o==="right"?`${i}${a}`:`${a}${i}`;this.#t({annotationText:c,yAdj:o==="left"||o==="away"?-48:0,error:!s,clickDispatch:s?()=>Bt(r):void 0})}break;case"teleporter":{const{rooms:t}=C.getState().levelEditor.campaignInProgress,{config:{toRoom:r}}=e,o=!!t[r];this.#t({annotationText:`➡${r.toUpperCase()}`,yAdj:-12,error:!o,clickDispatch:o?()=>Bt(r):void 0})}break;case"conveyor":{const{config:{direction:t}}=e,r=fr[t];this.#t({annotationText:r,yAdj:-12})}break;case"movingPlatform":{const{config:{movement:t,startDirection:r}}=e;this.#t({annotationText:gr(t,r),yAdj:-12})}break;case"monster":{const{config:t}=e;(t.which==="turtle"||t.which==="skiHead")&&this.#t({annotationText:gr(t.movement,t.startDirection),yAdj:-12})}break}}#t({annotationText:e,yAdj:t=0,error:r=!1,clickDispatch:o}){const{renderContext:{frontLayer:s}}=this,i=new B(r?g.midRed:g.white),a=Oo(new w({label:"EditorAnnotationTextContainer",filters:[i,G.pureBlack]}),e);a.y=t,o!==void 0&&(a.eventMode="static",a.on("click",()=>{C.dispatch(o())}),a.on("mouseover",()=>{C.getState().levelEditor.tool.type==="pointer"&&(C.dispatch(wn(!0)),i.targetColor=g.pastelBlue)}),a.on("mouseout",()=>{C.dispatch(wn(!1)),i.targetColor=g.white}),a.cursor="pointer"),this.output.addChild(a),s.attach(a)}tick(e){this.#n(),this.childRenderer.tick(e)}#n(){const{renderContext:{item:e,room:t}}=this,{clickableAnnotationHovered:r}=C.getState().levelEditor,{jsonItemId:o}=e,s=C.getState(),i=_r(s),a=Gs(s),c=Ie(s),l=o&&i?.jsonItemId===o&&!r,u=o&&a.includes(o),p=()=>o!==void 0&&(Z(t.items).some(h=>h.jsonItemId===i?.jsonItemId&&mr(h)&&h.config.modifies.some(d=>d.expectType===e.type&&(d.targets===void 0||d.targets.includes(o))))||mr(e)&&Z(t.items).some(({jsonItemId:h,type:d})=>h!==void 0&&h===i?.jsonItemId&&e.config.modifies.some(f=>f.expectType===d&&(f.targets===void 0||f.targets.includes(h))))||e.type==="charles"&&Z(t.items).some(h=>h.jsonItemId===i?.jsonItemId&&h.type==="joystick"&&h.config.controls.some(d=>d===o))||e.type==="joystick"&&e.config.controls.some(h=>i?.jsonItemId===h));this.output.filters=l&&u?[pr,c.type==="eyeDropper"?hr:dr]:l?c.type==="eyeDropper"?hr:dr:u?pr:p()?dl:te}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const pl=(n,e,t)=>e.general.editor?new hl(e,t):t;class fl{constructor(e,t){this.renderContext=e,this.appearance=t,this.output=new w({label:"AppearanceRenderer"})}#e;output;destroy(){this.output.destroy({children:!0})}tick(e){const t=this.appearance({renderContext:this.renderContext,currentRendering:this.#e,tickContext:e});t!=="no-update"&&(this.output.children.at(0)!==t.output&&(this.#e?.output&&(this.output.removeChild(this.#e.output),this.#e.output.destroy({texture:!0,children:!0})),t.output!==void 0&&this.output.addChild(t.output)),this.#e=t)}}class Fo extends fl{}const xr=(n,e)=>{e.poly([b({}),b({x:n.x}),b({x:n.x,y:n.y}),b({y:n.y})]).poly([b({}),b({z:n.z}),b({y:n.y,z:n.z}),b({y:n.y})]).poly([b({x:n.x}),b({x:n.x,z:n.z}),b(n),b({x:n.x,y:n.y})]).poly([b({z:n.z}),b({x:n.x,z:n.z}),b({x:n.x,y:n.y,z:n.z}),b({y:n.y,z:n.z})])},yr=(n,e)=>{const t=new V;return xr(n,t),t.stroke({width:.5,color:e,alpha:1}),t.eventMode="static",t.on("pointerenter",()=>{t.fill({color:e,alpha:.5})}),t.on("pointerleave",()=>{t.clear(),xr(n,t),t.stroke({width:.5,color:e,alpha:1})}),t},ml={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",pickup:"rgba(0,196,255)",emitter:"rgba(0,255,255)",stopAutowalk:"rgba(255,128,128)",floatingText:"rgba(128,0,255)"};class gl{constructor(e){this.renderContext=e;const{item:t}=e,r=ml[t.type]??"rgba(255,255,255)";if(this.#e=new w({label:`ItemBoundingBoxRenderer ${t.id}`}),Hs("portal")(t)){const s=b(t.config.relativePoint);this.#e.addChild(new V().circle(s.x,s.y,5).stroke(r)),this.#e.addChild(new V().circle(s.x,s.y,2).fill(r))}if(this.#e.addChild(new V({label:"objectOrigin"}).circle(0,0,2).fill(r)),this.#e.addChild(yr(t.aabb,r)),t.renderAabb){const s="rgba(184, 184, 255)",i=yr(t.renderAabb,s);if(t.renderAabbOffset){const a=b(t.renderAabbOffset);i.position.set(a.x,a.y),i.circle(0,0,2).fill(s)}this.#e.addChild(i)}this.#e.eventMode="static";let o;this.#e.on("pointerenter",()=>{if(o!==void 0)return;const s=`${t.id} ${t.type}
@(${t.state.position.x}, ${t.state.position.y}, ${t.state.position.z})}
#(${t.aabb.x}, ${t.aabb.y}, ${t.aabb.z})}`;this.#e.addChild(o=new Ii({text:s,style:{fill:r,fontSize:6,fontFamily:"Menlo"}})),o.resolution=4}),this.#e.on("pointerleave",()=>{o!==void 0&&(this.#e.removeChild(o),o=void 0)}),e.frontLayer.attach(this.#e)}#e;tick(){}destroy(){this.#e.destroy({children:!0})}get output(){return this.#e}}const xl=[new et(g.midRed),G.pureBlack],yl=[new et(g.moss),G.pureBlack],vl=75;class wl{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output)}output=new w({label:"ItemFlashOnSwitchedRenderer"});tick(e){const{renderContext:{item:{state:{switchedAtRoomTime:t,switchedSetting:r}},room:{roomTime:o}}}=this;this.output.filters=o-t<vl?r==="left"?yl:xl:te,this.childRenderer.tick(e)}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const bl=(n,e,t,r)=>{const o=1/r;n.x=rr(e,o),n.y=rr(t,o)},Bo=new vi;Bo.matrix=[0,0,0,1,0,0,.3,0,0,0,0,0,.3,0,0,0,0,0,1,0];class Cl{constructor(e,t){this.renderContext=e,this.wrappedRenderer=t,this.output=new w({label:`ItemPositionRenderer ${e.item.id}`,children:[t.output]}),this.#t()}output;#e=new Map;#t(){const{general:{upscale:{gameEngineUpscale:e}}}=this.renderContext,t=b(this.renderContext.item.state.position);bl(this.output,t.x,t.y,e)}tick(e){this.wrappedRenderer?.tick(e),e.movedItems.has(this.renderContext.item)&&this.#t(),this.#s()}#n(){const e=this.renderContext.item.id,t=this.renderContext.zEdges.get(e);if(!t)return _t;let r;for(const[o,s]of t)s&&(r||(r=new Set),r.add(o));return r??_t}#r(e,t){const r=new w({label:`maskWith: ${e}`,children:[t,this.output.children[0]]});return this.output.addChild(r),r.setMask({mask:t,inverse:!0}),this.#e.set(e,r),r}#o(e,t){const[r,o]=t.children,s=t.parent;s.removeChild(t),s.addChild(o),t.mask=null,r.destroy(),t.destroy(),this.#e.delete(e)}#s(){const{pixiRenderer:e}=this.renderContext.general,t=this.#n();for(const r of this.#e.keys())if(!t.has(r)){const o=this.#e.get(r);if(o)try{this.#o(r,o)}catch(s){throw new Error(`error while destroying masking container ${Qe(o)} 
              for our rendering: ${Qe(this.output)}`,{cause:s})}}for(const r of t){const o=this.#e.get(r),s=o?.children[0],i=this.renderContext.getItemRenderPipeline(r)?.itemAppearanceRenderer?.output;if(i===void 0)throw new Error("nothing to use as a mask");const a=i.filters;i.filters=Bo;const c=oe(e,i,s,`red mask: ${r}`);i.filters=a,o===void 0&&this.#r(r,c);const l=this.renderContext.room.items[r],u=Y(b(l.state.position),b(this.renderContext.item.state.position));c.x=u.x,c.y=u.y}}destroy(){this.output.destroy({children:!0}),this.wrappedRenderer?.destroy()}}const Rt=(n,e=1)=>({renderContext:{item:{state:{facing:t}}},currentRendering:r})=>{const o=r?.renderProps,s=nn(t)??"towards";if(!(o===void 0||s!==o.facingXy4))return"no-update";const a=x(s==="left"||s==="away"?`shadowMask.${n}.away`:`shadowMask.${n}.right`);return a.y=-(_.h*(e-1)),a.scale.x=s==="away"||s==="right"?1:-1,{output:a,renderProps:{facingXy4:s}}},Sl=({renderContext:{general:{pixiRenderer:n},item:e,room:t},currentRendering:r})=>{const{state:{stoodOnBy:o},config:{times:s}}=e,i=r?.renderProps,a=un(e),c=a&&ze(o,t).find(an)!==void 0;return i===void 0||a!==i.activated||c!==i.flashing?{output:Fe(n,lt({textureId:c?"shadowMask.teleporter.flashing":a?"shadowMask.teleporter":"shadowMask.fullBlock"},s)),renderProps:{flashing:c,activated:a}}:"no-update"},vr={lift:E("shadowMask.smallBlock"),conveyor:q(({direction:n})=>({textureId:"shadowMask.conveyor",flipX:J(n)==="x"})),doorLegs:q(({direction:n})=>({textureId:n==="right"||n==="towards"?"shadowMask.door.floatingThreshold.double.y":"shadowMask.door.legs.threshold.double.y",flipX:J(n)==="y"})),teleporter:Sl,floor:"no-mask",barrier:q(({axis:n})=>({textureId:"shadowMask.barrier.y",flipX:n==="x"})),spring:E("shadowMask.smallRound"),block:q(({style:n})=>n==="tower"?"shadowMask.tower":"shadowMask.fullBlock"),pushableBlock:E("shadowMask.stepStool"),movingPlatform:E("shadowMask.fullBlock"),hushPuppy:E("shadowMask.hushPuppy"),portableBlock:q(({style:n})=>n==="drum"?"shadowMask.smallRound":"shadowMask.smallBlock"),slidingBlock:q(({style:n})=>n==="book"?"shadowMask.fullBlock":"shadowMask.smallRound"),deadlyBlock:q(({style:n})=>n==="volcano"?"shadowMask.volcano":"shadowMask.toaster"),spikes:E("shadowMask.spikes"),switch:E("shadowMask.switch"),button:E("shadowMask.buttonInGame"),pickup:q(({gives:n})=>{switch(n){case"scroll":return"shadowMask.scroll";case"doughnuts":return"shadowMask.doughnuts";case"fast":case"extra-life":case"jumps":case"shield":return"shadowMask.whiteRabbit";default:return"blank"}}),slidingDeadly:E("shadowMask.smallRound"),ball:E("shadowMask.ball"),"monster.dalek":E("shadowMask.dalek"),"monster.turtle":Rt("turtle"),"monster.skiHead":Rt("skiHead"),"monster.homingBot":E("shadowMask.smallRound"),joystick:E("shadowMask.joystick"),charles:Rt("charles",2)},Il=n=>{switch(n.type){case"monster":return vr[`monster.${n.config.which}`];case"floor":return n.config.floorType==="none"?void 0:"no-mask";default:return vr[n.type]}},kl=new xi({alpha:1-ei});class Tl{constructor(e,t){if(this.renderContext=e,this.#e.filters=kl,t!=="no-mask")if(this.#n=new Fo(e,t),e.item.shadowOffset===void 0)this.#e.addChild(this.#n.output);else{const r=new w({label:"shadowMaskOffset",...b(e.item.shadowOffset),children:[this.#n.output]});this.#e.addChild(r)}this.#e.addChild(this.#t)}#e=new w({label:"ItemShadowRenderer"});#t=new w({label:"shadows"});#n;#r={};get#o(){return C.getState().gameMenus.userSettings.displaySettings.showShadowMasks}#s(e){if(this.#n===void 0)return;const t=this.#n.output.children.at(0);this.#n.tick(e);const r=this.#n.output.children.at(0);if(r===void 0||!(r instanceof ie)){const{item:o}=this.renderContext;throw new Error(`ItemShadowRenderer: this.#shadowMaskRenderer didn't create a sprite for item "${o.id}" of type "${o.type}". Have got ${r}`)}t!==r&&(this.#o?this.renderContext.frontLayer.attach(r):this.#e.mask=r)}destroy(){this.#e.destroy(!0),this.#n?.destroy();for(const e of Object.values(this.#r))e.sprite.destroy()}tick(e){if(this.#t.parent===null)throw new Error("shadow container not in scene graph");const{movedItems:t,progression:r}=e,{item:o,general:{pixiRenderer:s},room:i}=this.renderContext,a=t.has(o),c=o.state.position.z+o.aabb.z,l=Z(i.items).filter(function(d){return d.shadowCastTexture!==void 0}),u=Object.groupBy(l,h=>{const d=this.#r[h.id]!==void 0,f=t.has(h);if(!a&&!f)return d?"keepUnchanged":"noShadow";if(h.castsShadowWhileStoodOn||h.state.position.z>o.state.position.z+o.aabb.z){const m={id:o.id,state:{position:{...o.state.position,z:c}},aabb:{...o.aabb,z:Vs}};if(Xs(m,h))return d?"update":"create"}return"noShadow"});for(const h of Tn(u.keepUnchanged,u.update))this.#r[h.id].renderedOnProgression=r;if(u.create)for(const h of u.create){const{times:d}=h.config,f=Fe(s,lt(h.shadowCastTexture,d));f.label=h.id,this.#t.addChild(f),this.#r[h.id]={sprite:f,renderedOnProgression:r}}for(const h of Tn(u.create,u.update)){const{sprite:d}=this.#r[h.id],f=b({...Te(Y(h.state.position,o.state.position),h.shadowOffset??fe),z:o.aabb.z});d.x=f.x,d.y=f.y}for(const[h,{sprite:d,renderedOnProgression:f}]of us(this.#r))f!==r&&(d.destroy(),delete this.#r[h]);const p=(u.keepUnchanged?.length??0)+(u.update?.length??0)+(u.create?.length??0)>0;this.#e.visible=p,p&&this.#s(e)}get output(){return this.#e}}const Rl=n=>{const e=Il(n.item);return e===void 0?void 0:new Tl(n,e)};class Pl{constructor(e,t){this.renderContext=e,this.componentRenderers=t,this.output={graphics:t.graphics?.output,sound:t.sound?.output}}output;tick(e){this.componentRenderers.graphics?.tick(e),this.componentRenderers.sound?.tick(e)}destroy(){this.componentRenderers.graphics?.destroy(),this.componentRenderers.sound?.destroy()}}const Ml=()=>G.moss;class _l{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output)}output=new w({label:"PortableItemPickUpNextHighlightRenderer"});#e=!1;tick(e){const{wouldPickUpNext:t}=this.renderContext.item.state;t!==!this.#e&&(this.output.filters=t?[Ml()]:te),this.#e=t,this.childRenderer.tick(e)}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const Al=(n,e,t)=>Ws(n)?new _l(e,t):t,Ol=(n,e)=>{e!==void 0&&C.getState().gameMenus.cheatsOn&&(e.eventMode="static",e.on("pointertap",()=>{C.dispatch(ps({item:n,pixiContainer:e}))}))},zl=n=>{const e=C.getState(),t=ds(e),r=!hs(e),{item:o}=n,s=t==="all"||t==="non-wall"&&n.item.type!=="wall",i=[],a=ll(o);let c;if(a!==void 0){c=new Fo(n,a);const d=new wl(n,c);i.push(pl(o,n,Al(o,n,d)))}if(r){const d=Rl(n);d!==void 0&&i.push(d)}s&&i.push(new gl(n));let l;if(i.length===0)l=void 0;else{const d=i.length===1?i[0]:new Fl(i,n);l=new Cl(n,d),Ol(o,l.output)}const u=n.general.soundSettings.mute??en.soundSettings.mute,p=n.general.paused||u?void 0:Ka(n),h=p===void 0?void 0:new rc(n,p);return{top:new Pl(n,{graphics:l,sound:h}),itemAppearanceRenderer:c}};class Fl{constructor(e,t){this.renderContext=t,this.#e=e,this.#t.addChild(...e.map(r=>r.output))}#e;#t=new w({label:"CompositeRenderer"});tick(e){for(const t of this.#e)t.tick(e)}destroy(){for(const e of this.#e)e.destroy()}get output(){return this.#t}}class Bl{constructor(e){this.renderContext=e;const{general:{colourised:t,soundSettings:r}}=e;this.initFilters(t,e.room.color);const s=r.mute??en.soundSettings.mute?void 0:I.createGain();this.output={sound:s,graphics:new w({label:`RoomRenderer(${e.room.id})`})},this.output.graphics.addChild(this.#t),t||(this.#n=new An({sortableChildren:!1}),this.output.graphics.addChild(this.#n)),this.output.graphics.addChild(this.#r)}#e=!1;#t=new w({label:"items"});#n;#r=new An({sortableChildren:!1});output;#o=void 0;#s=new Map;#i=new Map;initFilters(e,t){this.#t.filters=e?t.shade==="dimmed"?Pa:te:new B(t.shade==="dimmed"?Gr(Ye(t).main.original):Ye(t).main.original)}#a=e=>this.#i.get(e);#l(e,t){let r=this.#i.get(t.id);if(r===void 0){r=zl({...this.renderContext,colourClashLayer:this.#n,frontLayer:this.#r,item:t,zEdges:this.#s,getItemRenderPipeline:this.#a}),this.#i.set(t.id,r);const{graphics:o,sound:s}=r.top.output;if(o&&(this.#t.addChild(o),t.fixedZIndex&&(o.zIndex=t.fixedZIndex)),s){if(!this.output.sound)throw new Error("item renderer has sound, but room renderer does not - this probably means that they disagree on if the user has sound muted");s.connect(this.output.sound)}}try{r.top.tick(e)}catch(o){throw new Error(`RoomRenderer: error while ticking item "${t.id}"
in room "${this.renderContext.room.id}"
item in play object is:
           
${JSON.stringify(t,null,2)}`,{cause:o})}}#c(e){const{room:t}=this.renderContext,r={...e,lastRenderRoomTime:this.#o},o=new Set,s=a=>{if(o.has(a))return;const c=this.#s.get(a);if(c)for(const[l,u]of c.entries())u&&s(l);this.#l(r,t.items[a]),o.add(a)};for(const a in t.items)s(a);let i=!1;for(const[a,c]of this.#i.entries())t.items[a]===void 0&&(c.top.destroy(),this.#i.delete(a),i=!0);i&&this.#d()}#d(){if(this.#n)for(const e of this.#n.renderLayerChildren)e.parent===null&&this.#n.detach(e);for(const e of this.#r.renderLayerChildren)e.parent===null&&this.#r.detach(e)}#h(e){for(let t=0;t<e.length;t++){const r=this.#i.get(e[t]);if(r===void 0)throw new Error(`Item id=${e[t]} does not have a renderer - cannot assign a z-index`);const o=r.top.output.graphics;if(!o)throw new Error(`order ${e[t]} was given a z-order by sorting, but item has no graphics`);o.zIndex=t}}get#u(){return this.#o!==void 0}tick(e){const t=this.#u?e:{...e,movedItems:new Set(Z(this.renderContext.room.items))};ho(this.renderContext.room.items,t.movedItems,this.#s);const r=ao(this.#s);this.#c(t),(!this.#u||t.movedItems.size>0)&&this.#h(r),this.#o=this.renderContext.room.roomTime}destroy(){this.output.graphics.label=this.output.graphics.label+"DESTROYED",this.output.graphics.destroy({children:!0}),this.output.sound?.disconnect(),this.#i.forEach(e=>{e.top.destroy()}),this.#e=!0}get destroyed(){return this.#e}}const $l=(n,e)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:e},soundSettings:{mute:!0},pixiRenderer:n,gameState:void 0,paused:!1,colourised:!0,upscale:Yt(C.getState()),editor:!0}),wr=(n,e,t)=>new Bl({room:n,general:$l(e,t)}),El=()=>{const{renderer:n}=ae(),e=fs();if(!n)throw new Error("this should never be falsey (typescript violation)");const t=Dr(),[r,o]=R.useState(()=>wr(t,n,e));return R.useEffect(()=>{const s=wr(t,n,e);return o(s),()=>{s.destroy()}},[t,n,e]),r},Ll=n=>{const e=Dr(),t=ae();R.useEffect(()=>{let r=0;const o=({deltaMS:s})=>{if(n.destroyed)return;n.renderContext.room!==e&&console.warn("room renderer does not have the current room");const i=new Set($t(e.items));e.roomTime+=s,n.tick({deltaMS:s,movedItems:i,progression:r++}),t.render()};return ue.shared.add(o),()=>{ue.shared.remove(o)}},[n,e,t])};ms.defaultOptions.scaleMode="nearest";const Ul=()=>{const n=El(),[e,t]=R.useState(null),[r,o]=R.useState(null),[s,i]=R.useState("amigaLowResPal"),a=ma();return Ti(s,r??void 0),pa(),la(n),Ll(n),sa(e),ca(e),da(),ha(),ua(r,e),L.jsxs("div",{className:"w-full h-full relative",children:[L.jsx(aa,{selectedResolution:s,onResolutionChange:i}),L.jsx("div",{ref:o,className:`w-full h-full ${a} scale-editor bg-editor-checkerboard overflow-scroll scrollbar scrollbar-w-1 scrollbar-track-pureBlack scrollbar-thumb-metallicBlue`,children:L.jsx("div",{style:{transform:Ri(),transformOrigin:"center center"},ref:t,tabIndex:1,className:"focus-visible:outline-none"})})]})},Dl=()=>L.jsx(qi,{children:L.jsx(Ul,{})}),Wl=Object.freeze(Object.defineProperty({__proto__:null,default:Dl},Symbol.toStringTag,{value:"Module"}));export{Yr as A,Nr as C,Q as F,it as R,ui as S,Jr as V,mi as a,Wl as b,li as u};
