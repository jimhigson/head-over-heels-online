import{a5 as z,a6 as fe,a7 as V,a8 as Me,a9 as W,aa as R,ab as q,ac as Te,ad as je,ae as E,af as qe,ag as N,ah as se,ai as Ue,aj as Xe,ak as Ne,al as O,am as Ve,an as Ke,ao as ge,ap as F,aq as Qe,ar as Ye,as as Ze,at as De,au as eo,av as oo}from"./index-BOrjGEYY.js";var B={},J={},he;function to(){if(he)return J;he=1;function e(l,y){var i;if(typeof Symbol>"u"||l[Symbol.iterator]==null){if(Array.isArray(l)||(i=o(l))||y){i&&(l=i);var a=0,s=function(){};return{s,n:function(){return a>=l.length?{done:!0}:{done:!1,value:l[a++]}},e:function(u){throw u},f:s}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var d=!0,m=!1,p;return{s:function(){i=l[Symbol.iterator]()},n:function(){var u=i.next();return d=u.done,u},e:function(u){m=!0,p=u},f:function(){try{!d&&i.return!=null&&i.return()}finally{if(m)throw p}}}}function o(l,y){if(l){if(typeof l=="string")return t(l,y);var i=Object.prototype.toString.call(l).slice(8,-1);if(i==="Object"&&l.constructor&&(i=l.constructor.name),i==="Map"||i==="Set")return Array.from(l);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return t(l,y)}}function t(l,y){(y==null||y>l.length)&&(y=l.length);for(var i=0,a=new Array(y);i<y;i++)a[i]=l[i];return a}var r=z(),n=r.ensureIterable;function c(l){var y=[],i=e(l),a;try{for(i.s();!(a=i.n()).done;){var s=a.value;y.push(s)}}catch(d){i.e(d)}finally{i.f()}return y}J.__toArray=c;function f(l){return c(n(l))}return J.toArray=f,J}var ve;function ro(){if(ve)return B;ve=1;var e=fe(),o=e.mark(f),t=z(),r=t.iterableCurry,n=to(),c=n.__toArray;function f(y,i){var a;return e.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(a=Array.isArray(y)?y:c(y),a.length){d.next=3;break}return d.abrupt("return");case 3:if(!i--){d.next=7;break}return d.delegateYield(a,"t0",5);case 5:d.next=3;break;case 7:case"end":return d.stop()}},o)}B.__cycleTimes=f;var l=r(f);return B.cycleTimes=l,B}var H={},be;function no(){if(be)return H;be=1;var e=z(),o=e.iterableCurry,t=ro(),r=t.__cycleTimes;function n(f){return r(f,1/0)}H.__cycle=n;var c=o(n);return H.cycle=c,H}var G={},we;function io(){if(we)return G;we=1;var e=fe(),o=e.mark(l);function t(i,a){var s;if(typeof Symbol>"u"||i[Symbol.iterator]==null){if(Array.isArray(i)||(s=r(i))||a){s&&(i=s);var d=0,m=function(){};return{s:m,n:function(){return d>=i.length?{done:!0}:{done:!1,value:i[d++]}},e:function(v){throw v},f:m}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,h=!1,u;return{s:function(){s=i[Symbol.iterator]()},n:function(){var v=s.next();return p=v.done,v},e:function(v){h=!0,u=v},f:function(){try{!p&&s.return!=null&&s.return()}finally{if(h)throw u}}}}function r(i,a){if(i){if(typeof i=="string")return n(i,a);var s=Object.prototype.toString.call(i).slice(8,-1);if(s==="Object"&&i.constructor&&(s=i.constructor.name),s==="Map"||s==="Set")return Array.from(i);if(s==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return n(i,a)}}function n(i,a){(a==null||a>i.length)&&(a=i.length);for(var s=0,d=new Array(a);s<a;s++)d[s]=i[s];return d}var c=z(),f=c.iterableCurry;function l(i,a){var s,d,m,p;return e.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:s=0,d=t(i),u.prev=2,d.s();case 4:if((m=d.n()).done){u.next=11;break}if(p=m.value,!(s++>=a)){u.next=9;break}return u.next=9,p;case 9:u.next=4;break;case 11:u.next=16;break;case 13:u.prev=13,u.t0=u.catch(2),d.e(u.t0);case 16:return u.prev=16,d.f(),u.finish(16);case 19:case"end":return u.stop()}},o,null,[[2,13,16,19]])}G.__drop=l;var y=f(l);return G.drop=y,G}var L={},M={},Ie;function so(){if(Ie)return M;Ie=1;var e=z(),o=e.iterableCurry,t=e.callReturn;function r(c,f){var l=c[Symbol.iterator](),y=l.next(),i=y.value,a=y.done;return a?f:(t(l),i)}M.__firstOr=r;var n=o(r,{reduces:!0});return M.firstOr=n,M}var xe;function ao(){if(xe)return L;xe=1;var e=z(),o=e.iterableCurry,t=so(),r=t.__firstOr;function n(f){return r(f,void 0)}L.__first=n;var c=o(n,{reduces:!0});return L.first=c,L}var j={},Re;function co(){if(Re)return j;Re=1;var e=fe(),o=e.mark(l);function t(i,a){var s;if(typeof Symbol>"u"||i[Symbol.iterator]==null){if(Array.isArray(i)||(s=r(i))||a){s&&(i=s);var d=0,m=function(){};return{s:m,n:function(){return d>=i.length?{done:!0}:{done:!1,value:i[d++]}},e:function(v){throw v},f:m}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,h=!1,u;return{s:function(){s=i[Symbol.iterator]()},n:function(){var v=s.next();return p=v.done,v},e:function(v){h=!0,u=v},f:function(){try{!p&&s.return!=null&&s.return()}finally{if(h)throw u}}}}function r(i,a){if(i){if(typeof i=="string")return n(i,a);var s=Object.prototype.toString.call(i).slice(8,-1);if(s==="Object"&&i.constructor&&(s=i.constructor.name),s==="Map"||s==="Set")return Array.from(i);if(s==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return n(i,a)}}function n(i,a){(a==null||a>i.length)&&(a=i.length);for(var s=0,d=new Array(a);s<a;s++)d[s]=i[s];return d}var c=z(),f=c.iterableCurry;function l(i,a){var s,d,m,p;return e.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:if(a!==0){u.next=2;break}return u.abrupt("return");case 2:s=0,d=t(i),u.prev=4,d.s();case 6:if((m=d.n()).done){u.next=14;break}return p=m.value,u.next=10,p;case 10:if(++s!==a){u.next=12;break}return u.abrupt("break",14);case 12:u.next=6;break;case 14:u.next=19;break;case 16:u.prev=16,u.t0=u.catch(4),d.e(u.t0);case 19:return u.prev=19,d.f(),u.finish(19);case 22:case"end":return u.stop()}},o,null,[[4,16,19,22]])}j.__take=l;var y=f(l);return j.take=y,j}var Y,ke;function lo(){return ke||(ke=1,Y=no().cycle),Y}var fo=lo();const uo=V(fo);var Z,Ee;function yo(){return Ee||(Ee=1,Z=io().drop),Z}var mo=yo();const po=V(mo);var ee,ze;function go(){return ze||(ze=1,ee=ao().first),ee}var ho=go();const vo=V(ho);var oe,Ce;function bo(){return Ce||(Ce=1,oe=co().take),oe}var wo=bo();const Io=V(wo),xo={jail:["bars"],blacktooth:["plain","plain","armour","shield","shield","armour"],bookworld:["book","book","cowboy"],egyptus:["hieroglyphics","hieroglyphics","hieroglyphics","sarcophagus","sarcophagus"],market:["passage","more-fruits","fruits","more-fruits","fruits"],moonbase:["coil","window1","window2","window3"],penitentiary:["loop","loop","skeleton"],safari:["wall","shield","wall","window","window","wall","shield"]},D=(e,o,t=0)=>{const r=uo(xo[e]);return po(t,Io(o+t,r))},Ro=e=>({awayWall:{type:"wall",config:{direction:"away",tiles:Array.from(D("blacktooth",e.x))},position:{x:0,y:e.y,z:0}},leftWall:{type:"wall",config:{direction:"left",tiles:Array.from(D("blacktooth",e.y))},position:{x:e.x,y:0,z:0}},towardsWall:{type:"wall",config:{direction:"towards",times:{x:e.x}},position:{x:0,y:0,z:0}},rightWall:{type:"wall",config:{direction:"right",times:{y:e.y}},position:{x:0,y:0,z:0}}}),We=e=>({planet:"blacktooth",color:{hue:"cyan",shade:"basic"},size:e,items:{floor:{type:"floor",config:{floorType:"standable",scenery:"blacktooth",times:e},position:{x:0,y:0,z:0}},...Ro(e)}}),I=e=>e.campaignInProgress.rooms[e.currentlyEditingRoomId],ae=(e,o)=>e.campaignInProgress.rooms[o],Fe=(e,o,t)=>e.campaignInProgress.rooms[t??e.currentlyEditingRoomId]?.items[o],_=e=>{const o=structuredClone(Me(I(e))),{history:t}=e;t.redo=[],t.undo.push(o)},ko={undo(e){const o=e,{campaignInProgress:t,history:{undo:r,redo:n},currentlyEditingRoomId:c}=o;r.length!==0&&(n.push(t.rooms[c]),t.rooms[c]=r.pop())},redo(e){const o=e,{campaignInProgress:t,history:{redo:r,undo:n},currentlyEditingRoomId:c}=o;r.length!==0&&(n.push(t.rooms[c]),t.rooms[c]=r.pop())}},Eo={selectCanUndo:e=>e.history.undo.length>0,selectCanRedo:e=>e.history.redo.length>0},te={x:1,y:0,z:0},re={x:-1,y:0,z:0},ne={x:0,y:-1,z:0},ie={x:0,y:1,z:0},T={away:ie,left:te,right:re,towards:ne,down:{x:0,y:0,z:-1},up:{x:0,y:0,z:1},awayRight:W(R(ie,re)),towardsRight:W(R(ne,re)),towardsLeft:W(R(ne,te)),awayLeft:W(R(ie,te))},Nt={w:16,d:16,h:12},Ae={x:16,y:16,z:12},zo=(e,o,t)=>{if(o==="*")return!0;const r=t.meta.subRooms[o];return e.x>=r.physicalPosition.from.x&&e.y>=r.physicalPosition.from.y&&e.x<=r.physicalPosition.to.x&&e.y<=r.physicalPosition.to.y},Co=({position:e},o,t)=>zo(e,o,t),U=(e,o,t,r)=>o.some(n=>n.config.direction===e)?"doorway":t===void 0?"wall":Object.values(t).some(({gridPosition:n})=>se(T[e],Ue(n,r)))?"open":"wall";function*P(e){try{yield*Ao(e)}catch(o){const t=o;throw new Error(`
  error in recursion ${e.roomId}/${e.subRoomId??"*"} ---found--v 
 ${t.message}`,{cause:t})}}function*Ao({roomId:e,subRoomId:o="*",campaign:t,visited:r={},vectorFromPrevious:n,previousRoomGridPosition:c=E}){if(r[e]?.[o])return;r[e]===void 0&&(r[e]={}),r[e][o]=!0;const f=t.rooms[e];if(f===void 0)throw new Error(`no room in the campaign with id="${e}"`);const l=[...q(Te(f.items)).filter(m=>m.type==="door").filter(m=>Co(m,o,f))],y=R(c,n===void 0?je:n),i=f.meta?.subRooms;if(i){if(o==="*")throw new Error(`subRoomId '*' means 'all' and is not allowed for big rooms. Must be one of the sub-rooms in ${e}: ${Object.keys(i)}`);if(!i[o])throw new Error(`Sub-room ${o} not found in room ${e}. Available sub-rooms: ${Object.keys(i)}`)}const a=i?.[o].gridPosition,s={left:U("left",l,i,a),right:U("right",l,i,a),away:U("away",l,i,a),towards:U("towards",l,i,a)};if(yield{roomId:e,subRoomId:o,gridPosition:y,boundaries:s},i!==void 0){if(a===void 0)throw new Error(`Sub-room ${o} not found in room ${e}. Available sub-rooms: ${Object.keys(i)}`);for(const[m,{gridPosition:p}]of q(qe(i)))m!==o&&(yield*P({roomId:e,subRoomId:m,campaign:t,visited:r,vectorFromPrevious:N({...p,z:0},a),previousRoomGridPosition:y}))}if(f.roomAbove!==void 0){const{roomAbove:m,subRoomAbove:p}=f;yield*P({roomId:m,subRoomId:p,campaign:t,visited:r,vectorFromPrevious:T.up,previousRoomGridPosition:y})}if(f.roomBelow!==void 0){const{roomBelow:m,subRoomBelow:p}=f;yield*P({roomId:m,subRoomId:p,campaign:t,visited:r,vectorFromPrevious:T.down,previousRoomGridPosition:y})}for(const m of l){const{toRoom:p}=m.config;yield*P({roomId:p,campaign:t,visited:r,subRoomId:m.config.meta?.toSubRoom,vectorFromPrevious:T[m.config.direction],previousRoomGridPosition:y})}const d=f.meta?.nonContiguousRelationship;if(d!==void 0){const{with:{room:m},gridOffset:p}=d;yield*P({roomId:m,campaign:t,visited:r,subRoomId:"*",vectorFromPrevious:p,previousRoomGridPosition:y})}}const Be=(e,o)=>{e.planet=o;for(const t of Object.values(e.items))t.type==="floor"&&t.config.floorType==="standable"&&(t.config.scenery=o),t.type==="wall"&&(t.config.direction==="away"||t.config.direction==="left")&&(t.config.tiles=Array.from(D(o,t.config.tiles.length))),t.type==="pickup"&&t.config.gives==="crown"&&Xe.includes(o)&&(t.config.planet=o)},Je=(e,o,t)=>{const n=`room_${q(Ne({start:0})).find(f=>e.campaignInProgress.rooms[`room_${f}`]===void 0)}`,c={id:n,...structuredClone(We({x:8,y:8})),color:t};return Be(c,o),e.campaignInProgress.rooms[n]=c,c},ue=(e,o,t)=>{if(o.type==="player"){const{which:n}=o.config;return t?`preview-${n}`:n}const r=o.type==="monster"?o.config.which:o.type;for(let n=1;;n++){const c=n===1?r:`${r}_${n}`;if(!e.items[c])return c}},ce=(e,o,t,r)=>{const n=I(e),c=ue(n,o,r),f=He(e,r),l={type:o.type,config:o.config,position:t};return f[c]=l,[c,l]},He=(e,o,t=e.currentlyEditingRoomId)=>o?e.previewedEdits:e.campaignInProgress.rooms[t].items,So=["head","heels"],Po=[...So,"headOverHeels"],b=(...e)=>o=>e.includes(o.type),_o=b("bubbles","stopAutowalk","firedDoughnut","floatingText","emitter","particle"),$o=(e,o)=>_o(e)||Jo(e)&&(o!==void 0&&Do(o)||e.config.direction.z!==0)||Go(e)&&e.config.floorType==="none",Vt=(e,o)=>!$o(e,o),Oo=["ball","slidingBlock","slidingDeadly"];b(...Oo);const To=["portableBlock","spring","sceneryPlayer","sceneryCrown","monster","slidingBlock"],qo=["dalek","turtle","elephantHead","homingBot","helicopterBug"],Kt=e=>e.type==="slidingBlock"?e.config.style==="puck":e.type==="monster"?qo.includes(e.config.which):To.includes(e.type),Do=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function Qt(e){return Wo.includes(e.type)}const Wo=[...Po,"monster","ball","charles","pushableBlock","movingPlatform","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer","sceneryCrown"],Fo=["monster","deadlyBlock","moveableDeadly","slidingDeadly"];b(...Fo);const Bo=e=>e.config.times!==void 0,Jo=b("portal");b("teleporter");b("heels");b("head");b("heels","headOverHeels");b("head","headOverHeels");b("lift");b("emitter");const Ho=b("monster"),Go=b("floor");b("pickup");b("spring");const Yt=b("joystick");b("monster","movingPlatform");const Zt=e=>Ho(e)&&e.config.which==="cyberman"&&e.state.everActivated===!1,er=(e,o={})=>{const t=le(o),r=N(Ae,e);return N(Ve(t,Ae),r)},K=e=>({x:e.direction==="away"?e.tiles.length:e.direction==="towards"?e.times?.x:1,y:e.direction==="left"?e.tiles.length:e.direction==="right"?e.times?.y:1}),or=e=>e.type==="wall"?K(e.config):Bo(e)?e.config.times:void 0,le=(e=O)=>({x:e.x??1,y:e.y??1,z:e.z??1}),Lo=e=>({x:e.x??1,y:e.y??1});function*Mo(e,o,t){for(const r of qe(e)){const[n,c]=r;if(c.type!=="wall"||c.config.direction!==o)continue;const{position:f,config:l}=c,y=Lo(K(l)),i=Ke(ge(l.direction)),a=ge(l.direction),s=N(t,f);if(s[a]!==0||s[i]<-1||s[i]>y[i])continue;if(y[i]===2){console.log("yielding for for removal (complete replace) of ",n),yield[n,null];continue}const d=s[i]===0;if(d){const p=F(c,h=>{h.position=R(f,{[i]:2});const u=h.config;switch(u.direction){case"towards":case"right":u.times[i]=y[i]-2;break;default:u.tiles=u.tiles.slice(2)}});yield[n,p]}const m=s[i]===y[i]-2;if(m){const p=F(c,h=>{const u=h.config;switch(u.direction){case"towards":case"right":u.times[i]=y[i]-2;break;default:u.tiles=u.tiles.slice(0,-2)}});yield[n,p]}if(!d&&!m){const p=F(c,u=>{const g=u.config;switch(g.direction){case"towards":case"right":g.times[i]=s[i];break;default:g.tiles=g.tiles.slice(0,s[i])}});yield[`${n}/beforeDoor`,p];const h=F(c,u=>{u.position={...f,[i]:t[i]+2};const g=u.config;switch(g.direction){case"towards":case"right":g.times[i]=y[i]-s[i]-2;break;default:console.log("cutting tiles down in ",n),g.tiles=g.tiles.slice(s[i]+2)}});yield[`${n}/afterDoor`,h],console.log("yielding for removal (after splitting) of ",n),yield[n,null]}}}const Se=(e,o,t,r,n)=>{const c=ae(e,o);if(c===void 0)throw new Error("can't cut hole in walls for a room that does not exist");const f=He(e,n,o);for(const[l,y]of Mo(c.items,t,r))n?f[l]=y:y===null?delete f[l]:f[l]=y},jo=(e,o,t,r)=>{const n=e.campaignInProgress,c=q(P({campaign:n,roomId:o.id})).find(({gridPosition:f})=>Ye(f,T[t]));if(c)return n.rooms[c.roomId];if(!r)return Je(e,o.planet,o.color)},Uo=(e,o,t,r,n)=>{const c=I(e),f=t;Se(e,c.id,f,o,n);const l=jo(e,c,f,n),[y,i]=ce(e,{type:"door",config:{...r.config,toRoom:l?l.id:"(new)",direction:f}},o,n);if(!n){if(l===void 0)throw new Error("if not a preview, should have guaranteed a room to go to");const a=ue(l,r,n),s={x:f==="left"?0:f==="right"?l.size.x:o.x,y:f==="away"?0:f==="towards"?l.size.x:o.y,z:o.z},d=Qe(f),m={type:"door",config:{toRoom:c.id,direction:d},position:s};l.items[a]=m,m.config.toDoor=y,i.config.toDoor=a,Se(e,l.id,d,s,!1)}},Xo=e=>e.type==="door",No=e=>e.type==="monster"&&e.config.which==="cyberman",Vo={applyItemTool(e,{payload:{blockPosition:o,pointedAtItemJson:t,preview:r}}){const n=e,{tool:c}=n;if(c.type!=="item")throw new Error("applying item tool reducer while the current tool is not an item tool");switch(r||(_(n),n.previewedEdits={}),n.selectedJsonItemIds=[],!0){case Xo(c.item):{if(t.type!=="wall")throw new Error("doors can only be added on walls");Uo(n,o,t.config.direction,c.item,r);break}case(No(c.item)&&t.type==="deadlyBlock"&&t.config.style==="toaster"&&t.position.z+1===o.z):{ce(n,{...c.item,config:{...c.item.config,activated:"off"}},o,r);break}default:ce(n,c.item,o,r)}}},Ko={changeDragInProgress(e,{payload:o}){const t=e;t.dragInProgress=o}},Qo={changeGridResolution(e,{payload:o}){const t=e;t.halfGridResolution=o},changeWallsFloorsLocked(e,{payload:o}){const t=e;t.wallsFloorsLocked=o}},Yo={setSelectedItemInRoom(e,{payload:{jsonItemId:o,additive:t=!1}}){if(t)if(o===void 0)e.selectedJsonItemIds=[];else{const r=e.selectedJsonItemIds.indexOf(o);r===-1?e.selectedJsonItemIds.push(o):e.selectedJsonItemIds.splice(r,1)}else e.selectedJsonItemIds=o===void 0?[]:[o]},setHoveredItemInRoom(e,o){e.hoveredItem=o.payload},setClickableAnnotationHovered(e,o){e.clickableAnnotationHovered=o.payload}},Zo=e=>Te(e.items),Ge=e=>q(Zo(e)),Pe=(e,o,t)=>{const r=t-e.length;r>0?e.push(...D(o,r,e.length)):r<0&&e.splice(t)},et=(e,o,t,r)=>{Ge(e).filter(n=>n.type==="wall").forEach(n=>{if(n.position.z!==o.position.z)return;const c=K(n.config);switch(n.config.direction){case"towards":se(n.position,o.position)&&c.x===o.config.times.x&&(n.position=t,r&&(n.config.times={x:r.x}));break;case"right":se(n.position,o.position)&&c.y===o.config.times.y&&(n.position=t,r&&(n.config.times={y:r.y}));break;case"away":n.position.x===o.position.x&&n.position.y===o.position.y+o.config.times.y&&c.x===o.config.times.x&&(n.position=R(t,r?{y:r.y}:E),r&&Pe(n.config.tiles,e.planet,r.x));break;case"left":n.position.x===o.position.x+o.config.times.x&&n.position.y===o.position.y&&c.y===o.config.times.y&&(n.position=R(t,r?{x:r.x}:E),r&&Pe(n.config.tiles,e.planet,r.y));break;default:n.config;break}})},ot={moveOrResizeItem(e,{payload:{jsonItemId:o,newTimes:t,newPosition:r,startOfGesture:n}}){const c=e;n&&_(c);const f=Fe(c,o);if(f===void 0){console.warn("no json item found for resize",o);return}if(f.type==="floor"&&et(I(c),f,r,t),t!==void 0){const{config:l}=f;l.times={...t.x===1?{}:{x:t.x},...t.y===1?{}:{y:t.y},...t.z===1?{}:{z:t.z}}}r!==void 0&&(f.position=r)}},tt=e=>e==="towards"||e==="right";function _e(e){var o="";return t(e),o;function t(n){if(n===null||typeof n!="object"||n.toJSON!=null)o+=JSON.stringify(n);else if(Array.isArray(n)){o+="[";var c=!1;n.forEach(function(l){c&&(o+=","),c=!0,l===void 0&&(l=null),t(l)}),o+="]"}else{o+="{";var f=Object.keys(n).filter(function(l){return n[l]!==void 0}).sort();f.forEach(function(l,y){return r(n,l,y)}),o+="}"}}function r(n,c,f){f>0&&(o+=","),o+=JSON.stringify(c),o+=":",t(n[c])}}const tr=(e,...o)=>{const t={};for(const r of o)t[r]=e[r];return t},rt=(e,...o)=>{const t={...e};for(const r of o)delete t[r];return t},nt=e=>Ze(Le(e))>0,Le=e=>{switch(e.type){case"deadlyBlock":return O;case"conveyor":if(e.config.disappearing)return E;switch(e.config.direction){case"left":case"right":return{x:1,y:0,z:0};case"away":case"towards":return{x:0,y:1,z:0};default:throw e.config.direction,new Error}case"hushPuppy":return O;case"teleporter":return{x:1,y:1,z:0};case"floor":case"spikes":return{x:1,y:1,z:0};case"block":return e.config.disappearing?E:O;case"barrier":if(e.config.disappearing)return E;switch(e.config.axis){case"x":return{x:1,y:0,z:1};case"y":return{x:0,y:1,z:1};default:throw e.config.axis,new Error}case"wall":switch(e.config.direction){case"left":case"right":return{x:0,y:1,z:1};case"away":case"towards":return{x:1,y:0,z:1};default:throw e.config,new Error}default:return E}},$e=e=>{const o=t=>t.config.times!==void 0;return e.type==="wall"?le(K(e.config)):o(e)?le(e.config.times):O},k=e=>e.type==="wall"?`wall/${e.config.direction}`:e.type==="teleporter"?_e({type:e.type,config:rt(e.config,"toPosition")}):_e({type:e.type,config:e.config}),it=e=>nt(e[1]),st=e=>{const o=[];let t=0,r=0,n=0;for(const[,f]of e){const{x:l,y,z:i}=f.position,a=$e(f),s=a.x,d=a.y,m=a.z;t=Math.max(t,l+s-1),r=Math.max(r,y+d-1),n=Math.max(n,i+m-1)}const c=Array.from({length:t+1},()=>Array.from({length:r+1},()=>Array.from({length:n+1},()=>new Set)));for(const f of e)if(!it(f))o.push(f);else{const[,l]=f,{x:y,y:i,z:a}=l.position,s=$e(l),d=s.x,m=s.y,p=s.z;for(let h=0;h<d;h++)for(let u=0;u<m;u++)for(let g=0;g<p;g++){const v=y+h,w=i+u,x=a+g;v<c.length&&w<c[v].length&&x<c[v][w].length&&c[v][w][x].add(f)}}return{consolidatableGrid:c,nonConsolidatable:o}},at=e=>{const o=[],t=new Set;for(const r of e)for(const n of r)for(const c of n)for(const f of c){const[l]=f;t.has(l)||(t.add(l),o.push(f))}return o},ct=e=>{const{consolidatableGrid:o,nonConsolidatable:t}=st(e),r={x:o.length,y:o[0].length,z:o[0][0].length},n=new Map,c=new Map;for(let a=0;a<r.x;a++)for(let s=0;s<r.y;s++)for(let d=0;d<r.z;d++)for(const[,m]of o[a][s][d]){const p=k(m);c.has(p)||c.set(p,m)}for(const[a]of c)n.set(a,Array.from({length:r.x},()=>Array.from({length:r.y},()=>Array(r.z).fill(!1))));const f=({x:a,y:s,z:d},m)=>{const p=k(m);return!n.get(p)[a][s][d]&&Array.from(o[a][s][d]).some(([,h])=>k(h)===k(m))},l=(a,s)=>{const d={...a},m=Le(s);if(m.x>0)for(;d.x+1<r.x&&f({...d,x:d.x+1},s);)d.x++;if(m.y>0)for(let p=a.x;p<=d.x;p++)for(;d.y+1<r.y&&Array.from({length:d.x-a.x+1}).every((h,u)=>f({x:a.x+u,y:d.y+1,z:a.z},s));)d.y++;if(m.z>0)for(let p=a.x;p<=d.x;p++)for(let h=a.y;h<=d.y;h++)for(;d.z+1<r.z&&Array.from({length:d.x-a.x+1}).every((u,g)=>Array.from({length:d.y-a.y+1}).every((v,w)=>f({x:a.x+g,y:a.y+w,z:d.z+1},s)));)d.z++;return d},y=(a,s)=>{if(a.type==="wall"){if(s.type!=="wall")throw new Error("only walls can join walls");if(a.config.direction!==s.config.direction)throw new Error("walls must have the same direction to join");if(a.config.direction==="right"||a.config.direction==="towards")return;a.config.tiles=[...a.config.tiles,...s.config.tiles]}},i=({x:a,y:s,z:d},{x:m,y:p,z:h},u)=>{const[,g]=u,v=k(g),w=m-a+1,x=p-s+1,Q=h-d+1;if(w+x+Q>3)if(g.type==="wall")switch(g.config.direction){case"away":case"left":break;case"towards":w!==1&&(g.config.times={x:w});break;case"right":x!==1&&(g.config.times={y:x});break}else w!==1&&(g.config.times={...g.config.times,x:w}),x!==1&&(g.config.times={...g.config.times,y:x}),Q!==1&&(g.config.times={...g.config.times,z:Q});for(let C=a;C<=m;C++)for(let A=s;A<=p;A++)for(let S=d;S<=h;S++)if(n.get(v)[C][A][S]=!0,C!==a||A!==s||S!==d){const me=o[C][A][S];e:for(const pe of me){const[,$]=pe;if(k($)===v){$.position.x===C&&$.position.y===A&&$.position.z===S&&y(g,$),me.delete(pe);break e}}}};for(let a=0;a<r.x;a++)for(let s=0;s<r.y;s++)for(let d=0;d<r.z;d++)for(const m of o[a][s][d]){const[,p]=m;if(p.position.x===a&&p.position.y===s&&p.position.z===d){const h=k(p),u=n.get(h);if(u&&!u[a][s][d]){const g=l({x:a,y:s,z:d},p);i({x:a,y:s,z:d},g,m)}}}return[...at(o),...t]},lt=e=>Object.fromEntries(ct(Object.entries(e))),Oe=(e,o)=>{Ge(e).filter(t=>t.type==="floor").filter(t=>t.position.z===0).forEach(t=>{t.config={...t.config,floorType:o,scenery:o==="standable"?e.planet:void 0}})},dt=(e,o)=>{const t=e.items[o];if(t.type==="door"){const r={type:"wall",config:tt(t.config.direction)?t.config.direction==="towards"?{direction:t.config.direction,times:{x:2}}:{direction:t.config.direction,times:{y:2}}:{direction:t.config.direction,tiles:[...D(e.planet,2,t.position[t.config.direction==="away"?"x":"y"])]},position:{...t.position,z:0}},n=ue(e,r,!1);e.items[n]=r,e.items=lt(e.items)}delete e.items[o]},ft={changeRoomColour(e,{payload:o}){const t=e,r=t.campaignInProgress.rooms[t.currentlyEditingRoomId].color;_(t),Object.assign(r,o)},changeRoomScenery(e,{payload:o}){const t=e,r=I(t);_(t),Be(r,o)},roomJsonEdited(e,{payload:o}){const t=e;t.campaignInProgress.rooms[t.currentlyEditingRoomId]=o},deleteSelected(e){const o=e,t=I(o);_(o),o.selectedJsonItemIds.forEach(r=>{dt(t,r)}),o.selectedJsonItemIds=[]},clearRoom(e){const o=e,t=I(o);_(o);for(const r of De(t.items)){const n=t.items[r];n.type!=="floor"&&n.type!=="wall"&&n.type!=="door"&&(delete t.items[r],o.selectedJsonItemIds=o.selectedJsonItemIds.filter(c=>c!==r))}},setRoomAboveOrBelow(e,{payload:o}){const t=e,r=o.direction,n=r==="roomAbove"?"roomBelow":"roomAbove",c=I(t),f=o.createNew?Je(t,c.planet,c.color).id:o.roomId,l=c[r]&&ae(t,c[r]);l?.[n]===t.currentlyEditingRoomId&&(l[n]=void 0),c[r]=f;const y=f&&ae(t,f);y!==void 0&&(y[n]=c.id),y?Oe(r==="roomBelow"?c:y,"none"):Oe(r==="roomBelow"?c:l,"standable")}},ut={resetPreviewedEdits(e){e.previewedEdits={}}},de="room_0",yt={id:de,...We({x:8,y:8})},X={campaignInProgress:{name:"new campaign",rooms:{[de]:yt}},currentlyEditingRoomId:de,previewedEdits:{},tool:{type:"pointer"},hoveredItem:void 0,clickableAnnotationHovered:!1,selectedJsonItemIds:[],halfGridResolution:!1,wallsFloorsLocked:!0,dragInProgress:!1,history:{undo:[],redo:[]}},ye=eo({name:"levelEditor",initialState:X,reducers:{setTool(e,{payload:o}){const t=e;o.type==="item"&&(t.selectedJsonItemIds=[]),t.tool=o},changeToRoom(e,{payload:o}){const t=e;if(!t.campaignInProgress.rooms[o]){console.warn(`can't change to room ${o} - it doesn't exist`);return}t.currentlyEditingRoomId=o,t.clickableAnnotationHovered=!1,t.hoveredItem=void 0,t.selectedJsonItemIds=[],t.history=X.history},loadCampaign(e,{payload:{campaign:o}}){const t=e;t.campaignInProgress=o,t.hoveredItem=void 0,t.selectedJsonItemIds=[],t.clickableAnnotationHovered=!1,t.dragInProgress=!1,t.history=X.history;const r=vo(De(o.rooms));if(r===void 0)throw new Error("could not find any rooms in this campaign");t.currentlyEditingRoomId=r},injected(){},...Qo,...ko,...Vo,...Ko,...Yo,...ft,...ot,...ut},selectors:{selectCurrentCampaignInProgress:e=>e.campaignInProgress,selectCurrentEditingRoomJson:I,selectItem:Fe,selectCurrentEditingRoomColour:e=>I(e).color,selectCurrentEditingRoomScenery:e=>I(e).planet,selectTool:e=>e.tool,selectSelectedJsonItemIds:e=>e.selectedJsonItemIds,selectHoveredItem:e=>e.hoveredItem,...Eo}}),{applyItemTool:mt,changeDragInProgress:pt,changeGridResolution:gt,changeRoomColour:ht,changeRoomScenery:vt,changeToRoom:bt,changeWallsFloorsLocked:wt,clearRoom:It,deleteSelected:xt,injected:Rt,loadCampaign:kt,moveOrResizeItem:Et,redo:zt,resetPreviewedEdits:Ct,roomJsonEdited:At,setClickableAnnotationHovered:St,setHoveredItemInRoom:Pt,setRoomAboveOrBelow:_t,setSelectedItemInRoom:$t,setTool:Ot,undo:Tt}=ye.actions,{selectCanRedo:qt,selectCanUndo:Dt,selectCurrentCampaignInProgress:Wt,selectCurrentEditingRoomColour:Ft,selectCurrentEditingRoomJson:Bt,selectCurrentEditingRoomScenery:Jt,selectHoveredItem:Ht,selectItem:Gt,selectSelectedJsonItemIds:Lt,selectTool:Mt}=ye.selectors,jt=oo.withTypes(),rr=Object.freeze(Object.defineProperty({__proto__:null,applyItemTool:mt,changeDragInProgress:pt,changeGridResolution:gt,changeRoomColour:ht,changeRoomScenery:vt,changeToRoom:bt,changeWallsFloorsLocked:wt,clearRoom:It,deleteSelected:xt,initialLevelEditorSliceState:X,injected:Rt,levelEditorSlice:ye,loadCampaign:kt,moveOrResizeItem:Et,redo:zt,resetPreviewedEdits:Ct,roomJsonEdited:At,selectCanRedo:qt,selectCanUndo:Dt,selectCurrentCampaignInProgress:Wt,selectCurrentEditingRoomColour:Ft,selectCurrentEditingRoomJson:Bt,selectCurrentEditingRoomScenery:Jt,selectHoveredItem:Ht,selectItem:Gt,selectSelectedJsonItemIds:Lt,selectTool:Mt,setClickableAnnotationHovered:St,setHoveredItemInRoom:Pt,setRoomAboveOrBelow:_t,setSelectedItemInRoom:$t,setTool:Ot,undo:Tt,useAppSelectorWithLevelEditorSlice:jt},Symbol.toStringTag,{value:"Module"}));export{Et as $,or as A,Wo as B,T as C,Oo as D,tr as E,K as F,er as G,tt as H,Vt as I,Qt as J,Do as K,Yt as L,Zt as M,Kt as N,St as O,Ht as P,Lt as Q,Lo as R,Le as S,pt as T,Gt as U,$t as V,mt as W,Pt as X,Ct as Y,le as Z,nt as _,Ot as a,Fe as a0,At as a1,rr as a2,Ft as b,gt as c,xt as d,ht as e,Jt as f,vt as g,Dt as h,qt as i,Tt as j,zt as k,wt as l,Bt as m,D as n,It as o,I as p,_t as q,so as r,Mt as s,Wt as t,jt as u,kt as v,bt as w,Nt as x,b as y,Bo as z};
