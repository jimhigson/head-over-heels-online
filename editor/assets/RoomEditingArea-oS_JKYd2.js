const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-d8wY1etW.js","assets/index-CfogeVcu.js","assets/index-ByiQLgVx.css","assets/colorToUniform-KTpA7KSL.js","assets/SharedSystems-EoqjHcWk.js","assets/Graphics-D8fyMLYD.js","assets/levelEditorSlice-CICL2qtN.js","assets/LevelEditor-CmNQZYrK.js","assets/WebGLRenderer-uPJCpFT-.js"])))=>i.map(i=>d[i]);
import{a6 as zo,a5 as yn,a7 as vn,s as Fo,x as Zt,y as V,e as qt,E as Se,a as Bo,C as w,d as Re,v as _e,Z as _,D as _t,aO as pr,k as wn,K as se,t as N,T as le,U as Eo,M as $o,aP as ue,V as bn,aQ as Lo,w as Pt,aR as Uo,aS as Do,j as jo,ab as P,aT as X,aU as Go,as as Mt,aV as At,ac as te,at as Yt,aW as re,aX as Ho,aY as et,ah as Pe,ar as tt,aC as rt,aZ as Jt,an as C,a_ as Kt,av as ne,aw as Y,a$ as ke,aD as pe,aA as No,b0 as Cn,aJ as Qt,a9 as Me,b1 as er,ag as In,b2 as Vo,b3 as Ot,ak as tr,al as nt,b4 as Wo,b5 as Tn,b6 as Xo,aj as zt,aE as Zo,b7 as qo,b8 as Yo,b9 as rr,af as Ve,ba as fr,bb as Jo,bc as Ko,bd as Qo,be as S,bf as z,bg as es,bh as nr,bi as ts,bj as rs,ad as ns,ax as os,au as ss,aK as Ft,bk as U,a8 as ot,bl as kn,bm as is,bn as as,bo as cs,bp as Sn,bq as Ee,br as ls}from"./index-CfogeVcu.js";import{p as v,i as Ae,c as us,a as oe,b as Rn,d as or,e as M,f as sr,g as ds,v as hs,n as ir,h as _n,j as Pn,k as ps,l as fs,m as ms,o as gs,s as mr,q as xs,r as gr,t as ys,w as Mn,u as vs,x as ws,y as Bt,z as xr,A as An,B as bs,C as Ie,D as On,E as Cs,F as Is,G as Ts,H as We,I as ks,J as Ss,K as Rs,L as zn,M as Et,N as yr,O as ar,P as _s,Q as Fn,R as Bn,S as En,T as Ps,U as Ms,V as ut,W as $n,X as As,Y as Os,Z as zs,_ as Fs,$ as $e,a0 as dt,a1 as Bs,a2 as Ln,a3 as Es}from"./levelEditorSlice-CICL2qtN.js";import{S as $s,G as j}from"./Graphics-D8fyMLYD.js";import{a as Ls,i as Us,s as g,y as Ds,b as js,c as Un,g as qe,z as Dn,d as de,e as Gs,f as jn,h as Gn,j as vr,k as Hs,l as Ns,u as Vs,B as ht,T as wr,t as E}from"./LevelEditor-CmNQZYrK.js";var Le={},br;function Ws(){if(br)return Le;br=1;var r=zo(),e=r.mark(s),t=yn(),n=t.wrapWithIterableIterator,o=t.ensureIterable;function s(){var i,c,l,u,p,d,h=arguments;return r.wrap(function(m){for(;;)switch(m.prev=m.next){case 0:for(i=h.length,c=new Array(i),l=0;l<i;l++)c[l]=h[l];u=0,p=c;case 2:if(!(u<p.length)){m.next=8;break}return d=p[u],m.delegateYield(o(d),"t0",5);case 5:u++,m.next=2;break;case 8:case"end":return m.stop()}},e)}Le.__concat=s;var a=n(s);return Le.concat=a,Le}var Ue={},Cr;function Xs(){if(Cr)return Ue;Cr=1;function r(i,c){var l;if(typeof Symbol>"u"||i[Symbol.iterator]==null){if(Array.isArray(i)||(l=e(i))||c){l&&(i=l);var u=0,p=function(){};return{s:p,n:function(){return u>=i.length?{done:!0}:{done:!1,value:i[u++]}},e:function(y){throw y},f:p}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var d=!0,h=!1,f;return{s:function(){l=i[Symbol.iterator]()},n:function(){var y=l.next();return d=y.done,y},e:function(y){h=!0,f=y},f:function(){try{!d&&l.return!=null&&l.return()}finally{if(h)throw f}}}}function e(i,c){if(i){if(typeof i=="string")return t(i,c);var l=Object.prototype.toString.call(i).slice(8,-1);if(l==="Object"&&i.constructor&&(l=i.constructor.name),l==="Map"||l==="Set")return Array.from(i);if(l==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(l))return t(i,c)}}function t(i,c){(c==null||c>i.length)&&(c=i.length);for(var l=0,u=new Array(c);l<c;l++)u[l]=i[l];return u}var n=yn(),o=n.ensureIterable;function s(i){var c=o(i),l=0,u=r(c),p;try{for(u.s();!(p=u.n()).done;){var d=p.value;l++}}catch(h){u.e(h)}finally{u.f()}return l}Ue.__size=s;var a=s;return Ue.size=a,Ue}var pt,Ir;function Zs(){return Ir||(Ir=1,pt=Ws().concat),pt}var qs=Zs();const Tr=vn(qs);var ft,kr;function Ys(){return kr||(kr=1,ft=Xs().size),ft}var Js=Ys();const Hn=vn(Js),Nn=class $t extends Fo{constructor(e){e={...$t.defaultOptions,...e},super(e),this.enabled=!0,this._state=$s.for2d(),this.blendMode=e.blendMode,this.padding=e.padding,typeof e.antialias=="boolean"?this.antialias=e.antialias?"on":"off":this.antialias=e.antialias,this.resolution=e.resolution,this.blendRequired=e.blendRequired,this.clipToViewport=e.clipToViewport,this.addResource("uTexture",0,1)}apply(e,t,n,o){e.applyFilter(this,t,n,o)}get blendMode(){return this._state.blendMode}set blendMode(e){this._state.blendMode=e}static from(e){const{gpu:t,gl:n,...o}=e;let s,a;return t&&(s=Zt.from(t)),n&&(a=V.from(n)),new $t({gpuProgram:s,glProgram:a,...o})}};Nn.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1,clipToViewport:!0};let J=Nn;const Lt=[];qt.handleByNamedList(Se.Environment,Lt);async function Ks(r){if(!r)for(let e=0;e<Lt.length;e++){const t=Lt[e];if(t.value.test()){await t.value.load();return}}}let ve;function Qs(){if(typeof ve=="boolean")return ve;try{ve=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{ve=!1}return ve}var Vn=(r=>(r[r.NONE=0]="NONE",r[r.COLOR=16384]="COLOR",r[r.STENCIL=1024]="STENCIL",r[r.DEPTH=256]="DEPTH",r[r.COLOR_DEPTH=16640]="COLOR_DEPTH",r[r.COLOR_STENCIL=17408]="COLOR_STENCIL",r[r.DEPTH_STENCIL=1280]="DEPTH_STENCIL",r[r.ALL=17664]="ALL",r))(Vn||{});class ei{constructor(e){this.items=[],this._name=e}emit(e,t,n,o,s,a,i,c){const{name:l,items:u}=this;for(let p=0,d=u.length;p<d;p++)u[p][l](e,t,n,o,s,a,i,c);return this}add(e){return e[this._name]&&(this.remove(e),this.items.push(e)),this}remove(e){const t=this.items.indexOf(e);return t!==-1&&this.items.splice(t,1),this}contains(e){return this.items.indexOf(e)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const ti=["init","destroy","contextChange","resolutionChange","resetState","renderEnd","renderStart","render","update","postrender","prerender"],Wn=class Xn extends Bo{constructor(e){super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=e.type,this.name=e.name,this.config=e;const t=[...ti,...this.config.runners??[]];this._addRunners(...t),this._unsafeEvalCheck()}async init(e={}){const t=e.skipExtensionImports===!0?!0:e.manageImports===!1;await Ks(t),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const n in this._systemsHash)e={...this._systemsHash[n].constructor.defaultOptions,...e};e={...Xn.defaultOptions,...e},this._roundPixels=e.roundPixels?1:0;for(let n=0;n<this.runners.init.items.length;n++)await this.runners.init.items[n].init(e);this._initOptions=e}render(e,t){let n=e;if(n instanceof w&&(n={container:n},t&&(Re(_e,"passing a second argument is deprecated, please use render options instead"),n.target=t.renderTexture)),n.target||(n.target=this.view.renderTarget),n.target===this.view.renderTarget&&(this._lastObjectRendered=n.container,n.clearColor??(n.clearColor=this.background.colorRgba),n.clear??(n.clear=this.background.clearBeforeRender)),n.clearColor){const o=Array.isArray(n.clearColor)&&n.clearColor.length===4;n.clearColor=o?n.clearColor:_.shared.setValue(n.clearColor).toArray()}n.transform||(n.container.updateLocalTransform(),n.transform=n.container.localTransform),n.container.enableRenderGroup(),this.runners.prerender.emit(n),this.runners.renderStart.emit(n),this.runners.render.emit(n),this.runners.renderEnd.emit(n),this.runners.postrender.emit(n)}resize(e,t,n){const o=this.view.resolution;this.view.resize(e,t,n),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),n!==void 0&&n!==o&&this.runners.resolutionChange.emit(n)}clear(e={}){const t=this;e.target||(e.target=t.renderTarget.renderTarget),e.clearColor||(e.clearColor=this.background.colorRgba),e.clear??(e.clear=Vn.ALL);const{clear:n,clearColor:o,target:s}=e;_.shared.setValue(o??this.background.colorRgba),t.renderTarget.clear(s,n,_.shared.toArray())}get resolution(){return this.view.resolution}set resolution(e){this.view.resolution=e,this.runners.resolutionChange.emit(e)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...e){e.forEach(t=>{this.runners[t]=new ei(t)})}_addSystems(e){let t;for(t in e){const n=e[t];this._addSystem(n.value,n.name)}}_addSystem(e,t){const n=new e(this);if(this[t])throw new Error(`Whoops! The name "${t}" is already in use`);this[t]=n,this._systemsHash[t]=n;for(const o in this.runners)this.runners[o].add(n);return this}_addPipes(e,t){const n=t.reduce((o,s)=>(o[s.name]=s.value,o),{});e.forEach(o=>{const s=o.value,a=o.name,i=n[a];this.renderPipes[a]=new s(this,i?new i:null)})}destroy(e=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(e),Object.values(this.runners).forEach(t=>{t.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(e){return this.textureGenerator.generateTexture(e)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!Qs())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}resetState(){this.runners.resetState.emit()}};Wn.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let Zn=Wn,De;function ri(r){return De!==void 0||(De=(()=>{const e={stencil:!0,failIfMajorPerformanceCaveat:r??Zn.defaultOptions.failIfMajorPerformanceCaveat};try{if(!_t.get().getWebGLRenderingContext())return!1;let n=_t.get().createCanvas().getContext("webgl",e);const o=!!n?.getContextAttributes()?.stencil;if(n){const s=n.getExtension("WEBGL_lose_context");s&&s.loseContext()}return n=null,o}catch{return!1}})()),De}let je;async function ni(r={}){return je!==void 0||(je=await(async()=>{const e=_t.get().getNavigator().gpu;if(!e)return!1;try{return await(await e.requestAdapter(r)).requestDevice(),!0}catch{return!1}})()),je}const Sr=["webgl","webgpu","canvas"];async function oi(r){let e=[];r.preference?(e.push(r.preference),Sr.forEach(s=>{s!==r.preference&&e.push(s)})):e=Sr.slice();let t,n={};for(let s=0;s<e.length;s++){const a=e[s];if(a==="webgpu"&&await ni()){const{WebGPURenderer:i}=await pr(async()=>{const{WebGPURenderer:c}=await import("./WebGPURenderer-d8wY1etW.js");return{WebGPURenderer:c}},__vite__mapDeps([0,1,2,3,4,5,6,7]));t=i,n={...r,...r.webgpu};break}else if(a==="webgl"&&ri(r.failIfMajorPerformanceCaveat??Zn.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:i}=await pr(async()=>{const{WebGLRenderer:c}=await import("./WebGLRenderer-uPJCpFT-.js");return{WebGLRenderer:c}},__vite__mapDeps([8,1,2,3,4,5,6,7]));t=i,n={...r,...r.webgl};break}else if(a==="canvas")throw n={...r},new Error("CanvasRenderer is not yet implemented")}if(delete n.webgpu,delete n.webgl,!t)throw new Error("No available renderer for the current environment");const o=new t;return await o.init(n),o}const qn="8.8.1";class Yn{static init(){globalThis.__PIXI_APP_INIT__?.(this,qn)}static destroy(){}}Yn.extension=Se.Application;class si{constructor(e){this._renderer=e}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,qn)}destroy(){this._renderer=null}}si.extension={type:[Se.WebGLSystem,Se.WebGPUSystem],name:"initHook",priority:-10};const Jn=class Ut{constructor(...e){this.stage=new w,e[0]!==void 0&&Re(_e,"Application constructor options are deprecated, please use Application.init() instead.")}async init(e){e={...e},this.renderer=await oi(e),Ut._plugins.forEach(t=>{t.init.call(this,e)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return Re(_e,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(e=!1,t=!1){const n=Ut._plugins.slice(0);n.reverse(),n.forEach(o=>{o.destroy.call(this)}),this.stage.destroy(t),this.stage=null,this.renderer.destroy(e),this.renderer=null}};Jn._plugins=[];let Kn=Jn;qt.handleByList(Se.Application,Kn._plugins);qt.add(Yn);var Qn=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,ii=`
in vec2 vTextureCoord;

out vec4 finalColor;

uniform float uAlpha;
uniform sampler2D uTexture;

void main()
{
    finalColor =  texture(uTexture, vTextureCoord) * uAlpha;
}
`,Rr=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct AlphaUniforms {
  uAlpha:f32,
};

@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;

@group(1) @binding(0) var<uniform> alphaUniforms : AlphaUniforms;

struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>
  };

fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

fn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  
}

fn getSize() -> vec2<f32>
{
  return gfu.uGlobalFrame.zw;
}
  
@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition)
  );
}

@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
  @builtin(position) position: vec4<f32>
) -> @location(0) vec4<f32> {
 
    var sample = textureSample(uTexture, uSampler, uv);
    
    return sample * alphaUniforms.uAlpha;
}`;const eo=class to extends J{constructor(e){e={...to.defaultOptions,...e};const t=Zt.from({vertex:{source:Rr,entryPoint:"mainVertex"},fragment:{source:Rr,entryPoint:"mainFragment"}}),n=V.from({vertex:Qn,fragment:ii,name:"alpha-filter"}),{alpha:o,...s}=e,a=new wn({uAlpha:{value:o,type:"f32"}});super({...s,gpuProgram:t,glProgram:n,resources:{alphaUniforms:a}})}get alpha(){return this.resources.alphaUniforms.uniforms.uAlpha}set alpha(e){this.resources.alphaUniforms.uniforms.uAlpha=e}};eo.defaultOptions={alpha:1};let ai=eo;var ci=`
in vec2 vTextureCoord;
in vec4 vColor;

out vec4 finalColor;

uniform float uColorMatrix[20];
uniform float uAlpha;

uniform sampler2D uTexture;

float rand(vec2 co)
{
    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);
}

void main()
{
    vec4 color = texture(uTexture, vTextureCoord);
    float randomValue = rand(gl_FragCoord.xy * 0.2);
    float diff = (randomValue - 0.5) *  0.5;

    if (uAlpha == 0.0) {
        finalColor = color;
        return;
    }

    if (color.a > 0.0) {
        color.rgb /= color.a;
    }

    vec4 result;

    result.r = (uColorMatrix[0] * color.r);
        result.r += (uColorMatrix[1] * color.g);
        result.r += (uColorMatrix[2] * color.b);
        result.r += (uColorMatrix[3] * color.a);
        result.r += uColorMatrix[4];

    result.g = (uColorMatrix[5] * color.r);
        result.g += (uColorMatrix[6] * color.g);
        result.g += (uColorMatrix[7] * color.b);
        result.g += (uColorMatrix[8] * color.a);
        result.g += uColorMatrix[9];

    result.b = (uColorMatrix[10] * color.r);
       result.b += (uColorMatrix[11] * color.g);
       result.b += (uColorMatrix[12] * color.b);
       result.b += (uColorMatrix[13] * color.a);
       result.b += uColorMatrix[14];

    result.a = (uColorMatrix[15] * color.r);
       result.a += (uColorMatrix[16] * color.g);
       result.a += (uColorMatrix[17] * color.b);
       result.a += (uColorMatrix[18] * color.a);
       result.a += uColorMatrix[19];

    vec3 rgb = mix(color.rgb, result.rgb, uAlpha);

    // Premultiply alpha again.
    rgb *= result.a;

    finalColor = vec4(rgb, result.a);
}
`,_r=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct ColorMatrixUniforms {
  uColorMatrix:array<vec4<f32>, 5>,
  uAlpha:f32,
};


@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;
@group(1) @binding(0) var<uniform> colorMatrixUniforms : ColorMatrixUniforms;


struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>,
  };
  
fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition),
  );
}


@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
) -> @location(0) vec4<f32> {


  var c = textureSample(uTexture, uSampler, uv);
  
  if (colorMatrixUniforms.uAlpha == 0.0) {
    return c;
  }

 
    // Un-premultiply alpha before applying the color matrix. See issue #3539.
    if (c.a > 0.0) {
      c.r /= c.a;
      c.g /= c.a;
      c.b /= c.a;
    }

    var cm = colorMatrixUniforms.uColorMatrix;


    var result = vec4<f32>(0.);

    result.r = (cm[0][0] * c.r);
    result.r += (cm[0][1] * c.g);
    result.r += (cm[0][2] * c.b);
    result.r += (cm[0][3] * c.a);
    result.r += cm[1][0];

    result.g = (cm[1][1] * c.r);
    result.g += (cm[1][2] * c.g);
    result.g += (cm[1][3] * c.b);
    result.g += (cm[2][0] * c.a);
    result.g += cm[2][1];

    result.b = (cm[2][2] * c.r);
    result.b += (cm[2][3] * c.g);
    result.b += (cm[3][0] * c.b);
    result.b += (cm[3][1] * c.a);
    result.b += cm[3][2];

    result.a = (cm[3][3] * c.r);
    result.a += (cm[4][0] * c.g);
    result.a += (cm[4][1] * c.b);
    result.a += (cm[4][2] * c.a);
    result.a += cm[4][3];

    var rgb = mix(c.rgb, result.rgb, colorMatrixUniforms.uAlpha);

    rgb.r *= result.a;
    rgb.g *= result.a;
    rgb.b *= result.a;

    return vec4(rgb, result.a);
}`;class li extends J{constructor(e={}){const t=new wn({uColorMatrix:{value:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],type:"f32",size:20},uAlpha:{value:1,type:"f32"}}),n=Zt.from({vertex:{source:_r,entryPoint:"mainVertex"},fragment:{source:_r,entryPoint:"mainFragment"}}),o=V.from({vertex:Qn,fragment:ci,name:"color-matrix-filter"});super({...e,gpuProgram:n,glProgram:o,resources:{colorMatrixUniforms:t}}),this.alpha=1}_loadMatrix(e,t=!1){let n=e;t&&(this._multiply(n,this.matrix,e),n=this._colorMatrix(n)),this.resources.colorMatrixUniforms.uniforms.uColorMatrix=n,this.resources.colorMatrixUniforms.update()}_multiply(e,t,n){return e[0]=t[0]*n[0]+t[1]*n[5]+t[2]*n[10]+t[3]*n[15],e[1]=t[0]*n[1]+t[1]*n[6]+t[2]*n[11]+t[3]*n[16],e[2]=t[0]*n[2]+t[1]*n[7]+t[2]*n[12]+t[3]*n[17],e[3]=t[0]*n[3]+t[1]*n[8]+t[2]*n[13]+t[3]*n[18],e[4]=t[0]*n[4]+t[1]*n[9]+t[2]*n[14]+t[3]*n[19]+t[4],e[5]=t[5]*n[0]+t[6]*n[5]+t[7]*n[10]+t[8]*n[15],e[6]=t[5]*n[1]+t[6]*n[6]+t[7]*n[11]+t[8]*n[16],e[7]=t[5]*n[2]+t[6]*n[7]+t[7]*n[12]+t[8]*n[17],e[8]=t[5]*n[3]+t[6]*n[8]+t[7]*n[13]+t[8]*n[18],e[9]=t[5]*n[4]+t[6]*n[9]+t[7]*n[14]+t[8]*n[19]+t[9],e[10]=t[10]*n[0]+t[11]*n[5]+t[12]*n[10]+t[13]*n[15],e[11]=t[10]*n[1]+t[11]*n[6]+t[12]*n[11]+t[13]*n[16],e[12]=t[10]*n[2]+t[11]*n[7]+t[12]*n[12]+t[13]*n[17],e[13]=t[10]*n[3]+t[11]*n[8]+t[12]*n[13]+t[13]*n[18],e[14]=t[10]*n[4]+t[11]*n[9]+t[12]*n[14]+t[13]*n[19]+t[14],e[15]=t[15]*n[0]+t[16]*n[5]+t[17]*n[10]+t[18]*n[15],e[16]=t[15]*n[1]+t[16]*n[6]+t[17]*n[11]+t[18]*n[16],e[17]=t[15]*n[2]+t[16]*n[7]+t[17]*n[12]+t[18]*n[17],e[18]=t[15]*n[3]+t[16]*n[8]+t[17]*n[13]+t[18]*n[18],e[19]=t[15]*n[4]+t[16]*n[9]+t[17]*n[14]+t[18]*n[19]+t[19],e}_colorMatrix(e){const t=new Float32Array(e);return t[4]/=255,t[9]/=255,t[14]/=255,t[19]/=255,t}brightness(e,t){const n=[e,0,0,0,0,0,e,0,0,0,0,0,e,0,0,0,0,0,1,0];this._loadMatrix(n,t)}tint(e,t){const[n,o,s]=_.shared.setValue(e).toArray(),a=[n,0,0,0,0,0,o,0,0,0,0,0,s,0,0,0,0,0,1,0];this._loadMatrix(a,t)}greyscale(e,t){const n=[e,e,e,0,0,e,e,e,0,0,e,e,e,0,0,0,0,0,1,0];this._loadMatrix(n,t)}grayscale(e,t){this.greyscale(e,t)}blackAndWhite(e){const t=[.3,.6,.1,0,0,.3,.6,.1,0,0,.3,.6,.1,0,0,0,0,0,1,0];this._loadMatrix(t,e)}hue(e,t){e=(e||0)/180*Math.PI;const n=Math.cos(e),o=Math.sin(e),s=Math.sqrt,a=1/3,i=s(a),c=n+(1-n)*a,l=a*(1-n)-i*o,u=a*(1-n)+i*o,p=a*(1-n)+i*o,d=n+a*(1-n),h=a*(1-n)-i*o,f=a*(1-n)-i*o,m=a*(1-n)+i*o,y=n+a*(1-n),b=[c,l,u,0,0,p,d,h,0,0,f,m,y,0,0,0,0,0,1,0];this._loadMatrix(b,t)}contrast(e,t){const n=(e||0)+1,o=-.5*(n-1),s=[n,0,0,0,o,0,n,0,0,o,0,0,n,0,o,0,0,0,1,0];this._loadMatrix(s,t)}saturate(e=0,t){const n=e*2/3+1,o=(n-1)*-.5,s=[n,o,o,0,0,o,n,o,0,0,o,o,n,0,0,0,0,0,1,0];this._loadMatrix(s,t)}desaturate(){this.saturate(-1)}negative(e){const t=[-1,0,0,1,0,0,-1,0,1,0,0,0,-1,1,0,0,0,0,1,0];this._loadMatrix(t,e)}sepia(e){const t=[.393,.7689999,.18899999,0,0,.349,.6859999,.16799999,0,0,.272,.5339999,.13099999,0,0,0,0,0,1,0];this._loadMatrix(t,e)}technicolor(e){const t=[1.9125277891456083,-.8545344976951645,-.09155508482755585,0,11.793603434377337,-.3087833385928097,1.7658908555458428,-.10601743074722245,0,-70.35205161461398,-.231103377548616,-.7501899197440212,1.847597816108189,0,30.950940869491138,0,0,0,1,0];this._loadMatrix(t,e)}polaroid(e){const t=[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0];this._loadMatrix(t,e)}toBGR(e){const t=[0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0];this._loadMatrix(t,e)}kodachrome(e){const t=[1.1285582396593525,-.3967382283601348,-.03992559172921793,0,63.72958762196502,-.16404339962244616,1.0835251566291304,-.05498805115633132,0,24.732407896706203,-.16786010706155763,-.5603416277695248,1.6014850761964943,0,35.62982807460946,0,0,0,1,0];this._loadMatrix(t,e)}browni(e){const t=[.5997023498159715,.34553243048391263,-.2708298674538042,0,47.43192855600873,-.037703249837783157,.8609577587992641,.15059552388459913,0,-36.96841498319127,.24113635128153335,-.07441037908422492,.44972182064877153,0,-7.562075277591283,0,0,0,1,0];this._loadMatrix(t,e)}vintage(e){const t=[.6279345635605994,.3202183420819367,-.03965408211312453,0,9.651285835294123,.02578397704808868,.6441188644374771,.03259127616149294,0,7.462829176470591,.0466055556782719,-.0851232987247891,.5241648018700465,0,5.159190588235296,0,0,0,1,0];this._loadMatrix(t,e)}colorTone(e,t,n,o,s){e||(e=.2),t||(t=.15),n||(n=16770432),o||(o=3375104);const a=_.shared,[i,c,l]=a.setValue(n).toArray(),[u,p,d]=a.setValue(o).toArray(),h=[.3,.59,.11,0,0,i,c,l,e,0,u,p,d,t,0,i-u,c-p,l-d,0,0];this._loadMatrix(h,s)}night(e,t){e||(e=.1);const n=[e*-2,-e,0,0,0,-e,0,e,0,0,0,e,e*2,0,0,0,0,0,1,0];this._loadMatrix(n,t)}predator(e,t){const n=[11.224130630493164*e,-4.794486999511719*e,-2.8746118545532227*e,0*e,.40342438220977783*e,-3.6330697536468506*e,9.193157196044922*e,-2.951810836791992*e,0*e,-1.316135048866272*e,-3.2184197902679443*e,-4.2375030517578125*e,7.476448059082031*e,0*e,.8044459223747253*e,0,0,0,1,0];this._loadMatrix(n,t)}lsd(e){const t=[2,-.4,.5,0,0,-.5,2,-.4,0,0,-.4,-.5,3,0,0,0,0,0,1,0];this._loadMatrix(t,e)}reset(){const e=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0];this._loadMatrix(e,!1)}get matrix(){return this.resources.colorMatrixUniforms.uniforms.uColorMatrix}set matrix(e){this.resources.colorMatrixUniforms.uniforms.uColorMatrix=e}get alpha(){return this.resources.colorMatrixUniforms.uniforms.uAlpha}set alpha(e){this.resources.colorMatrixUniforms.uniforms.uAlpha=e}}class fe extends se{constructor(...e){let t=e[0];Array.isArray(e[0])&&(t={textures:e[0],autoUpdate:e[1]});const{animationSpeed:n=1,autoPlay:o=!1,autoUpdate:s=!0,loop:a=!0,onComplete:i=null,onFrameChange:c=null,onLoop:l=null,textures:u,updateAnchor:p=!1,...d}=t,[h]=u;super({...d,texture:h instanceof N?h:h.texture}),this._textures=null,this._durations=null,this._autoUpdate=s,this._isConnectedToTicker=!1,this.animationSpeed=n,this.loop=a,this.updateAnchor=p,this.onComplete=i,this.onFrameChange=c,this.onLoop=l,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=u,o&&this.play()}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(le.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(le.shared.add(this.update,this,Eo.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(e){this.stop(),this.currentFrame=e}gotoAndPlay(e){this.currentFrame=e,this.play()}update(e){if(!this._playing)return;const t=e.deltaTime,n=this.animationSpeed*t,o=this.currentFrame;if(this._durations!==null){let s=this._currentTime%1*this._durations[this.currentFrame];for(s+=n/60*1e3;s<0;)this._currentTime--,s+=this._durations[this.currentFrame];const a=Math.sign(this.animationSpeed*t);for(this._currentTime=Math.floor(this._currentTime);s>=this._durations[this.currentFrame];)s-=this._durations[this.currentFrame]*a,this._currentTime+=a;this._currentTime+=s/this._durations[this.currentFrame]}else this._currentTime+=n;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):o!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<o||this.animationSpeed<0&&this.currentFrame>o)&&this.onLoop(),this._updateTexture())}_updateTexture(){const e=this.currentFrame;this._previousFrame!==e&&(this._previousFrame=e,this.texture=this._textures[e],this.updateAnchor&&this.texture.defaultAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(){this.stop(),super.destroy(),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(e){const t=[];for(let n=0;n<e.length;++n)t.push(N.from(e[n]));return new fe(t)}static fromImages(e){const t=[];for(let n=0;n<e.length;++n)t.push(N.from(e[n]));return new fe(t)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(e){if(e[0]instanceof N)this._textures=e,this._durations=null;else{this._textures=[],this._durations=[];for(let t=0;t<e.length;t++)this._textures.push(e[t].texture),this._durations.push(e[t].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let e=Math.floor(this._currentTime)%this._textures.length;return e<0&&(e+=this._textures.length),e}set currentFrame(e){if(e<0||e>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${e}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const t=this.currentFrame;this._currentTime=e,t!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,!this._autoUpdate&&this._isConnectedToTicker?(le.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(le.shared.add(this.update,this),this._isConnectedToTicker=!0))}}class ui{constructor({matrix:e,observer:t}={}){this.dirty=!0,this._matrix=e??new $o,this.observer=t,this.position=new ue(this,0,0),this.scale=new ue(this,1,1),this.pivot=new ue(this,0,0),this.skew=new ue(this,0,0),this._rotation=0,this._cx=1,this._sx=0,this._cy=0,this._sy=1}get matrix(){const e=this._matrix;return this.dirty&&(e.a=this._cx*this.scale.x,e.b=this._sx*this.scale.x,e.c=this._cy*this.scale.y,e.d=this._sy*this.scale.y,e.tx=this.position.x-(this.pivot.x*e.a+this.pivot.y*e.c),e.ty=this.position.y-(this.pivot.x*e.b+this.pivot.y*e.d),this.dirty=!1),e}_onUpdate(e){this.dirty=!0,e===this.skew&&this.updateSkew(),this.observer?._onUpdate(this)}updateSkew(){this._cx=Math.cos(this._rotation+this.skew.y),this._sx=Math.sin(this._rotation+this.skew.y),this._cy=-Math.sin(this._rotation-this.skew.x),this._sy=Math.cos(this._rotation-this.skew.x),this.dirty=!0}toString(){return`[pixi.js/math:Transform position=(${this.position.x}, ${this.position.y}) rotation=${this.rotation} scale=(${this.scale.x}, ${this.scale.y}) skew=(${this.skew.x}, ${this.skew.y}) ]`}setFromMatrix(e){e.decompose(this),this.dirty=!0}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._onUpdate(this.skew))}}const ro=class Xe extends bn{constructor(...e){let t=e[0]||{};t instanceof N&&(t={texture:t}),e.length>1&&(Re(_e,"use new TilingSprite({ texture, width:100, height:100 }) instead"),t.width=e[1],t.height=e[2]),t={...Xe.defaultOptions,...t};const{texture:n,anchor:o,tilePosition:s,tileScale:a,tileRotation:i,width:c,height:l,applyAnchorToTexture:u,roundPixels:p,...d}=t??{};super({label:"TilingSprite",...d}),this.renderPipeId="tilingSprite",this.batched=!0,this.allowChildren=!1,this._anchor=new ue({_onUpdate:()=>{this.onViewUpdate()}}),this.applyAnchorToTexture=u,this.texture=n,this._width=c??n.width,this._height=l??n.height,this._tileTransform=new ui({observer:{_onUpdate:()=>this.onViewUpdate()}}),o&&(this.anchor=o),this.tilePosition=s,this.tileScale=a,this.tileRotation=i,this.roundPixels=p??!1}static from(e,t={}){return typeof e=="string"?new Xe({texture:Lo.get(e),...t}):new Xe({texture:e,...t})}get uvRespectAnchor(){return Pt("uvRespectAnchor is deprecated, please use applyAnchorToTexture instead"),this.applyAnchorToTexture}set uvRespectAnchor(e){Pt("uvRespectAnchor is deprecated, please use applyAnchorToTexture instead"),this.applyAnchorToTexture=e}get clampMargin(){return this._texture.textureMatrix.clampMargin}set clampMargin(e){this._texture.textureMatrix.clampMargin=e}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}get tilePosition(){return this._tileTransform.position}set tilePosition(e){this._tileTransform.position.copyFrom(e)}get tileScale(){return this._tileTransform.scale}set tileScale(e){typeof e=="number"?this._tileTransform.scale.set(e):this._tileTransform.scale.copyFrom(e)}set tileRotation(e){this._tileTransform.rotation=e}get tileRotation(){return this._tileTransform.rotation}get tileTransform(){return this._tileTransform}set texture(e){e||(e=N.EMPTY);const t=this._texture;t!==e&&(t&&t.dynamic&&t.off("update",this.onViewUpdate,this),e.dynamic&&e.on("update",this.onViewUpdate,this),this._texture=e,this.onViewUpdate())}get texture(){return this._texture}set width(e){this._width=e,this.onViewUpdate()}get width(){return this._width}set height(e){this._height=e,this.onViewUpdate()}get height(){return this._height}setSize(e,t){typeof e=="object"&&(t=e.height??e.width,e=e.width),this._width=e,this._height=t??e,this.onViewUpdate()}getSize(e){return e||(e={}),e.width=this._width,e.height=this._height,e}updateBounds(){const e=this._bounds,t=this._anchor,n=this._width,o=this._height;e.minX=-t._x*n,e.maxX=e.minX+n,e.minY=-t._y*o,e.maxY=e.minY+o}containsPoint(e){const t=this._width,n=this._height,o=-t*this._anchor._x;let s=0;return e.x>=o&&e.x<=o+t&&(s=-n*this._anchor._y,e.y>=s&&e.y<=s+n)}destroy(e=!1){if(super.destroy(e),this._anchor=null,this._tileTransform=null,this._bounds=null,typeof e=="boolean"?e:e?.texture){const n=typeof e=="boolean"?e:e?.textureSource;this._texture.destroy(n)}this._texture=null}};ro.defaultOptions={texture:N.EMPTY,anchor:{x:0,y:0},tilePosition:{x:0,y:0},tileScale:{x:1,y:1},tileRotation:0,applyAnchorToTexture:!1};let di=ro;class hi extends bn{constructor(e,t){const{text:n,resolution:o,style:s,anchor:a,width:i,height:c,roundPixels:l,...u}=e;super({...u}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=t,this.text=n??"",this.style=s,this.resolution=o??null,this.allowChildren=!1,this._anchor=new ue({_onUpdate:()=>{this.onViewUpdate()}}),a&&(this.anchor=a),this.roundPixels=l??!1,i!==void 0&&(this.width=i),c!==void 0&&(this.height=c)}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}set text(e){e=e.toString(),this._text!==e&&(this._text=e,this.onViewUpdate())}get text(){return this._text}set resolution(e){this._autoResolution=e===null,this._resolution=e,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(e){e||(e={}),this._style?.off("update",this.onViewUpdate,this),e instanceof this._styleClass?this._style=e:this._style=new this._styleClass(e),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(e){this._setWidth(e,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(e){this._setHeight(e,this.bounds.height)}getSize(e){return e||(e={}),e.width=Math.abs(this.scale.x)*this.bounds.width,e.height=Math.abs(this.scale.y)*this.bounds.height,e}setSize(e,t){typeof e=="object"?(t=e.height??e.width,e=e.width):t??(t=e),e!==void 0&&this._setWidth(e,this.bounds.width),t!==void 0&&this._setHeight(t,this.bounds.height)}containsPoint(e){const t=this.bounds.width,n=this.bounds.height,o=-t*this.anchor.x;let s=0;return e.x>=o&&e.x<=o+t&&(s=-n*this.anchor.y,e.y>=s&&e.y<=s+n)}onViewUpdate(){this.didViewUpdate||(this._didTextUpdate=!0),super.onViewUpdate()}_getKey(){return`${this.text}:${this._style.styleKey}:${this._resolution}`}destroy(e=!1){super.destroy(e),this.owner=null,this._bounds=null,this._anchor=null,(typeof e=="boolean"?e:e?.style)&&this._style.destroy(e),this._style=null,this._text=null}}function pi(r,e){let t=r[0]??{};return(typeof t=="string"||r[1])&&(Re(_e,`use new ${e}({ text: "hi!", style }) instead`),t={text:t,style:r[1]}),t}class fi extends hi{constructor(...e){const t=pi(e,"Text");super(t,Uo),this.renderPipeId="text"}updateBounds(){const e=this._bounds,t=this._anchor,n=Do.measureText(this._text,this._style),{width:o,height:s}=n;e.minX=-t._x*o,e.maxX=e.minX+o,e.minY=-t._y*s,e.maxY=e.minY+s}}class st extends N{static create(e){return new st({source:new jo(e)})}resize(e,t,n){return this.source.resize(e,t,n),this}}const no=class oo extends w{constructor(e={}){e={...oo.defaultOptions,...e},super(),this.renderLayerChildren=[],this.sortableChildren=e.sortableChildren,this.sortFunction=e.sortFunction}attach(...e){for(let t=0;t<e.length;t++){const n=e[t];if(n.parentRenderLayer){if(n.parentRenderLayer===this)continue;n.parentRenderLayer.detach(n)}this.renderLayerChildren.push(n),n.parentRenderLayer=this;const o=this.renderGroup||this.parentRenderGroup;o&&(o.structureDidChange=!0)}return e[0]}detach(...e){for(let t=0;t<e.length;t++){const n=e[t],o=this.renderLayerChildren.indexOf(n);o!==-1&&this.renderLayerChildren.splice(o,1),n.parentRenderLayer=null;const s=this.renderGroup||this.parentRenderGroup;s&&(s.structureDidChange=!0)}return e[0]}detachAll(){const e=this.renderLayerChildren;for(let t=0;t<e.length;t++)e[t].parentRenderLayer=null;this.renderLayerChildren.length=0}collectRenderables(e,t,n){const o=this.renderLayerChildren,s=o.length;this.sortableChildren&&this.sortRenderLayerChildren();for(let a=0;a<s;a++)o[a].parent||Pt("Container must be added to both layer and scene graph. Layers only handle render order - the scene graph is required for transforms (addChild)",o[a]),o[a].collectRenderables(e,t,this)}sortRenderLayerChildren(){this.renderLayerChildren.sort(this.sortFunction)}_getGlobalBoundsRecursive(e,t,n){if(!e)return;const o=this.renderLayerChildren;for(let s=0;s<o.length;s++)o[s]._getGlobalBoundsRecursive(!0,t,this)}};no.defaultOptions={sortableChildren:!1,sortFunction:(r,e)=>r.zIndex-e.zIndex};let mi=no;const Pr=mi,me=(r,e)=>({get bottomCentre(){return this.c000},get topLeft(){return this.c101},get topRight(){return this.c011},get c000(){return v(r)},get c001(){return v(P(r,{z:e.z}))},get c010(){return v(P(r,{y:e.y}))},get c011(){return v(P(r,{y:e.y,z:e.z}))},get c100(){return v(P(r,{x:e.x}))},get c101(){return v(P(r,{x:e.x,z:e.z}))},get c110(){return v(P(r,{x:e.x,y:e.y}))},get c111(){return v(P(r,e))},projectCorner(t){return v(P(r,{x:t.x*e.x,y:t.y*e.y,z:t.z*e.z}))}}),mt=1e-5,Mr=-1,we=(r,e,t,n,o)=>n-o>r&&t<e-o,gi=0,so=1,io=2,ao=3,xi=(r,e,t,n)=>{const{topLeft:o,topRight:s,bottomCentre:a}=me(r,e),{topLeft:i,topRight:c,bottomCentre:l}=me(t,n),u=o.x,p=s.x,d=i.x,h=c.x,f=we(u,p,d,h,mt),m=s.y-s.x/2,y=a.y-a.x/2,b=c.y-c.x/2,I=l.y-l.x/2,k=we(m,y,b,I,mt),R=o.y+o.x/2,L=a.y+a.x/2,ee=i.y+i.x/2,D=l.y+l.x/2,Be=we(R,L,ee,D,mt);return k&&Be&&f?so:Be&&f&&we(m,y,b,I,Mr)?io:k&&f&&we(R,L,ee,D,Mr)?ao:gi},yi=(r,e,t,n)=>{for(const o of Go){const s=r[o],a=s+e[o],i=t[o],c=i+n[o];if(a<=i)return 1*(o==="z"?-1:1);if(s>=c)return-1*(o==="z"?-1:1)}return Ar(t)-Ar(r)},vi=(r,e)=>{if(r.fixedZIndex!==void 0||e.fixedZIndex!==void 0)return 0;const t=r.renderAabb||r.aabb,n=e.renderAabb||e.aabb,o=r.renderAabbOffset?P(r.state.position,r.renderAabbOffset):r.state.position,s=e.renderAabbOffset?P(e.state.position,e.renderAabbOffset):e.state.position;switch(xi(o,t,s,n)){case so:return yi(o,t,s,n);case io:return X(o.y,s.y+n.y)&&X(o.z,s.z+n.z)?1:X(s.y,o.y+t.y)&&X(s.z,o.z+t.z)?-1:0;case ao:return X(o.x,s.x+n.x)&&X(o.z,s.z+n.z)?1:X(s.x,o.x+t.x)&&X(s.z,o.z+t.z)?-1:0;default:return 0}},Ar=r=>r.x+r.y-r.z,wi=(r,e,t,n)=>(r.has(e)||r.set(e,new Map),r.get(e).set(t,n),r),Ge=(r,e,t)=>{const n=r.get(e);return n!==void 0&&(n.delete(t),n.size===0&&r.delete(e)),r},co=(r,e=new Set(Mt(r)),t=new Map)=>{const n=new Map;for(const[o,s]of t)if(!r[o])t.delete(o);else for(const[a]of s)r[a]||Ge(t,o,a);for(const o of e)if(o.fixedZIndex===void 0)for(const s of Mt(r)){if(s.fixedZIndex!==void 0||n.get(s)?.has(o)||o===s)continue;const a=vi(o,s);if(n.has(o)||n.set(o,new Set),n.get(o).add(s),a===0){Ge(t,o.id,s.id),Ge(t,s.id,o.id);continue}const i=a>0?o.id:s.id,c=a>0?s.id:o.id;wi(t,c,i,!1),Ge(t,i,c)}return t},lo=r=>{for(const[,c]of r)for(const[l]of c)c.set(l,!1);const e=Array.from(bi(r));let t=e.length,n=t;const o=new Array(t),s={},a=Ci(e);for(;n--;)s[n]||i(e[n],n,new Set,null);return o;function i(c,l,u,p){if(u.has(c)){if(p!==null){const f=r.get(p);f?.has(c)&&f.set(c,!0)}return}if(s[l])return;s[l]=!0;const d=r.get(c),h=Array.from(d?.entries()??At);if(l=h.length){u.add(c);do{const[f,m]=h[--l];m||i(f,a.get(f),u,c)}while(l);u.delete(c)}o[--t]=c}};function bi(r){const e=new Set;for(const[t,n]of r.entries()){e.add(t);for(const o of n.keys())e.add(o)}return e}function Ci(r){const e=new Map;for(let t=0,n=r.length;t<n;t++)e.set(r[t],t);return e}class Ii{constructor(e,t){this.renderContext=e,this.appearance=t,this.output=new w({label:"AppearanceRenderer"})}#e;output;destroy(){this.output.destroy({children:!0})}tick(e){const t=this.appearance({renderContext:this.renderContext,currentRendering:this.#e,tickContext:e});t!=="no-update"&&(this.output.children.at(0)!==t.output&&(this.#e?.output&&(this.output.removeChild(this.#e.output),this.#e.output.destroy({texture:!0,children:!0})),t.output!==void 0&&this.output.addChild(t.output)),this.#e=t)}}class uo extends Ii{}const Or=(r,e)=>{e.poly([v({}),v({x:r.x}),v({x:r.x,y:r.y}),v({y:r.y})]).poly([v({}),v({z:r.z}),v({y:r.y,z:r.z}),v({y:r.y})]).poly([v({x:r.x}),v({x:r.x,z:r.z}),v(r),v({x:r.x,y:r.y})]).poly([v({z:r.z}),v({x:r.x,z:r.z}),v({x:r.x,y:r.y,z:r.z}),v({y:r.y,z:r.z})])},zr=(r,e)=>{const t=new j;return Or(r,t),t.stroke({width:.5,color:e,alpha:1}),t.eventMode="static",t.on("pointerenter",()=>{t.fill({color:e,alpha:.5})}),t.on("pointerleave",()=>{t.clear(),Or(r,t),t.stroke({width:.5,color:e,alpha:1})}),t},Ti={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",pickup:"rgba(0,196,255)",emitter:"rgba(0,255,255)",stopAutowalk:"rgba(255,128,128)",floatingText:"rgba(128,0,255)"};class ki{constructor(e){this.renderContext=e;const{item:t}=e,n=Ti[t.type]??"rgba(255,255,255)";if(this.#e=new w({label:`ItemBoundingBoxRenderer ${t.id}`}),Ae("portal")(t)){const s=v(t.config.relativePoint);this.#e.addChild(new j().circle(s.x,s.y,5).stroke(n)),this.#e.addChild(new j().circle(s.x,s.y,2).fill(n))}if(this.#e.addChild(new j({label:"objectOrigin"}).circle(0,0,2).fill(n)),this.#e.addChild(zr(t.aabb,n)),t.renderAabb){const s="rgba(184, 184, 255)",a=zr(t.renderAabb,s);if(t.renderAabbOffset){const i=v(t.renderAabbOffset);a.position.set(i.x,i.y),a.circle(0,0,2).fill(s)}this.#e.addChild(a)}this.#e.eventMode="static";let o;this.#e.on("pointerenter",()=>{if(o!==void 0)return;const s=`${t.id} ${t.type}
@(${t.state.position.x}, ${t.state.position.y}, ${t.state.position.z})}
#(${t.aabb.x}, ${t.aabb.y}, ${t.aabb.z})}`;this.#e.addChild(o=new fi({text:s,style:{fill:n,fontSize:6,fontFamily:"Menlo"}})),o.resolution=4}),this.#e.on("pointerleave",()=>{o!==void 0&&(this.#e.removeChild(o),o=void 0)}),e.frontLayer.attach(this.#e)}#e;tick(){}destroy(){this.#e.destroy({children:!0})}get output(){return this.#e}}class Si extends se{constructor(...e){const[t]=e;super(t)}destroy(e){const t=this.texture!==null;typeof e=="boolean"?super.destroy({texture:t,textureSource:e,children:e}):super.destroy({...e,texture:t})}}const Ri={Container:"📦",Sprite:"🖼️",UniqueTextureSprite:"✨",Graphics:"🎨",Text:"📝",AnimatedSprite:"🎬",TilingSprite:"🔲",BitmapText:"🔤",Mesh:"🔺",NineSliceSprite:"🔳"},Ye=(r,e="",t=!0,n=!0,o=[])=>{const s=[];n&&s.push("");const a=r.constructor.name,i=a.startsWith("_")?a.slice(1):a;let c=Ri[i]||"📌";o.forEach((h,f)=>{h.mask===r&&(f===0?c+="😷":c+=`😷^${f+1}`)});const l=r.label&&r.label!==i?` "${r.label}"`:"",u=[];try{(r.x!==0||r.y!==0)&&u.push(`@(${r.x}, ${r.y})`)}catch{u.push("@(ERROR)")}if(r.children.length>2&&u.push(`children: ${r.children.length}`),r.visible||u.push("hidden"),r.alpha<1&&u.push(`alpha: ${r.alpha.toFixed(2)}`),r.mask&&u.push("😷 masked"),r instanceof se){const h=r;if(h.texture===null||h.texture===void 0)u.push("texture: NO TEXTURE");else{const f=h.texture.label||"(anon texture)";u.push(`texture: "${f}"`)}}const p=n?"":e+(t?"└── ":"├── ");if(s.push(`${p}${c} ${i}${l}`),u.length>0){const h=r.children.length>0,f=n?h?"│  ":"   ":e+(t?"    ":"│   ")+(h?"│  ":"   ");u.forEach(m=>{s.push(`${f}→ ${m}`)})}const d=n?"":e+(t?"    ":"│   ");return r.children.forEach((h,f)=>{const m=f===r.children.length-1;s.push(Ye(h,d,m,!1,[r,...o]))}),s.join(`
`)+(n?`
`:"")},_i=(r,e,t)=>{const n=e.getLocalBounds(),o=Math.ceil(n.maxX-n.minX),s=Math.ceil(n.maxY-n.minY),a=t!==void 0?t.width===o&&t.height===s:!1,i=a?t:st.create({width:o,height:s,antialias:!1,autoGenerateMipmaps:!1});i.label=`renderTexture of ${e.label??"(anon)"}`,t&&!a&&t.destroy();const{x:c,y:l}=e;e.x-=n.minX,e.y-=n.minY;try{r.render({container:e,target:i,clear:a})}catch(u){throw new Error(`renderContainerToTexture: failed to render to texture. Container:
 ${Ye(e)}`,{cause:u})}return e.x=c,e.y=l,i},ge=(r,e,t,n)=>{const o=e.getLocalBounds(),s=t?.texture&&t?.texture instanceof st?t.texture:void 0,a=_i(r,e,s),i=t||new Si;return i.texture=a,i.label=n??`sprite of container (${e.label})`,i.pivot={x:Math.floor(-o.minX),y:Math.floor(-o.minY)},i},Oe=(r,e)=>e instanceof se?e:ge(r,e),ho=new li;ho.matrix=[0,0,0,1,0,0,.3,0,0,0,0,0,.3,0,0,0,0,0,1,0];class Pi{constructor(e,t){this.renderContext=e,this.wrappedRenderer=t,this.output=new w({label:`ItemPositionRenderer ${e.item.id}`,children:[t.output]}),this.#t()}output;#e=new Map;#t(){const e=v(this.renderContext.item.state.position);this.output.x=e.x,this.output.y=e.y}tick(e){this.wrappedRenderer?.tick(e),e.movedItems.has(this.renderContext.item)&&this.#t(),this.#s()}#r(){const e=this.renderContext.item.id,t=this.renderContext.zEdges.get(e);if(!t)return At;let n;for(const[o,s]of t)s&&(n||(n=new Set),n.add(o));return n??At}#n(e,t){const n=new w({label:`maskWith: ${e}`,children:[t,this.output.children[0]]});return this.output.addChild(n),n.setMask({mask:t,inverse:!0}),this.#e.set(e,n),n}#o(e,t){const[n,o]=t.children,s=t.parent;s.removeChild(t),s.addChild(o),t.mask=null,n.destroy(),t.destroy(),this.#e.delete(e)}#s(){const{pixiRenderer:e}=this.renderContext.general,t=this.#r();for(const n of this.#e.keys())if(!t.has(n)){const o=this.#e.get(n);if(o)try{this.#o(n,o)}catch(s){throw new Error(`error while destroying masking container ${Ye(o)} 
              for our rendering: ${Ye(this.output)}`,{cause:s})}}for(const n of t){const o=this.#e.get(n),s=o?.children[0],a=this.renderContext.getItemRenderPipeline(n)?.itemAppearanceRenderer?.output;if(a===void 0)throw new Error("nothing to use as a mask");const i=a.filters;a.filters=ho;const c=ge(e,a,s,`red mask: ${n}`);a.filters=i,o===void 0&&this.#n(n,c);const l=this.renderContext.room.items[n],u=te(v(l.state.position),v(this.renderContext.item.state.position));c.x=u.x,c.y=u.y}}destroy(){this.output.destroy({children:!0}),this.wrappedRenderer?.destroy()}}const Fr={x:.5,y:1},Br=r=>typeof r!="string"&&Object.hasOwn(r,"animationId"),Dt=r=>{if(typeof r=="string")return Dt({textureId:r});{const{anchor:e,flipX:t,pivot:n,x:o,y:s,filter:a,times:i,label:c}=r;if(r.times){const u=us(i);if(Yt(u)>=2){const d=new w({label:c??"timesXyz"});for(let{x:h}=u;h>=1;h--)for(let{y:f}=u;f>=1;f--)for(let m=1;m<=u.z;m++){const y={...r,textureId:r.textureId??r.textureIdCallback?.(h-1,f-1,m-1),label:`(${h},${f},${m})`};delete y.times;const b=Dt(y),I=oe({x:h-1,y:f-1,z:m-1});b.x+=I.x,b.y+=+I.y,d.addChild(b)}return d}}let l;if(Br(r))l=Mi(r);else{const u=r.textureId??r.textureIdCallback?.(0,0,0);l=new se(re().textures[u])}if(e===void 0&&n===void 0)if(Br(r))l.anchor=Fr;else{const u=r.textureId??r.textureIdCallback?.(0,0,0),p=re().data.frames[u];if(p===void 0)throw new Error(`no spritesheet entry for textureId "${u}"`);const d=p.frame;d.pivot!==void 0?l.pivot=d.pivot:l.anchor=Fr}else e!==void 0&&(l.anchor=e),n!==void 0&&(l.pivot=n);return o!==void 0&&(l.x=o),s!==void 0&&(l.y=s),a!==void 0&&(l.filters=a),c!==void 0&&(l.label=c),l.eventMode="static",t===!0&&(l.scale.x=-1),l}},x=Dt;function Mi({animationId:r,reverse:e,playOnce:t,paused:n,randomiseStartFrame:o}){const s=re().animations[r],i=(n?[s[0]]:s).map(l=>({texture:l,time:Ho}));e&&i.reverse();const c=new fe(i);return c.animationSpeed=et.animations[r].animationSpeed,c.gotoAndPlay(o?Math.floor(Math.random()*i.length):0),t!==void 0&&(c.loop=!1,c.onComplete=()=>{c.stop(),t==="and-destroy"&&(c.visible=!1)}),c}const it=(r,e)=>{const t=e&&{x:e.x??1,y:e.y??1};return x({...typeof r=="string"?{textureId:r}:r,times:t})},Z=r=>A(({renderContext:{item:e}})=>Rn(e)?x({...typeof r=="string"?{textureId:r}:r,times:or(e)}):x(r)),$=r=>A(({renderContext:{item:e,general:{pixiRenderer:t}}})=>{if(Rn(e))return Oe(t,it(r,or(e)));{const n=x(r);return n instanceof se?n:ge(t,n)}}),A=r=>({renderContext:e,currentRendering:t,tickContext:n})=>t===void 0?{output:r({renderContext:e,currentRendering:void 0,tickContext:n}),renderProps:Pe}:"no-update",q=r=>({renderContext:{general:{pixiRenderer:e},item:t},currentRendering:n})=>{if(n===void 0){const o=or(t),s={output:Oe(e,it(r(t.config),o)),renderProps:Pe};return o&&(s.output.y-=((o.z??1)-1)*M.h),s}else return"no-update"},ze=(r,e)=>tt(rt(r)).map(t=>{const n=e.items[t];if(n===void 0)throw new Error(`item in stoodOnBy "${t}" is not in the room`);return n});Ae("head");const Ai=Ae("heels"),Oi=Ae("headOverHeels"),zi=r=>{if(Ai(r))return r.state;if(Oi(r))return r.state.heels},Fi=1e3/25,po=r=>{const e=et.animations[r],t=e.length,{animationSpeed:n}=e;return t*Fi/n};po("bubbles.white");po("head.fadeOut");const cr=({config:{activatedOnStoreValue:r}})=>r===void 0?!0:Jt(C.getState(),r),Bi=({renderContext:{general:{pixiRenderer:r},item:e,room:t},currentRendering:n})=>{const{state:{stoodOnBy:o},config:{times:s}}=e,a=n?.renderProps,i=cr(e),c=i&&ze(o,t).find(sr)!==void 0;return a===void 0||i!==a.activated||c!==a.flashing?{output:Oe(r,it({textureId:c?"shadowMask.teleporter.flashing":i?"shadowMask.teleporter":"shadowMask.fullBlock"},s)),renderProps:{flashing:c,activated:i}}:"no-update"},gt=(r,e=1)=>({renderContext:{item:{state:{facing:t}}},currentRendering:n})=>{const o=n?.renderProps,s=Kt(t)??"towards";if(!(o===void 0||s!==o.facingXy4))return"no-update";const i=x(s==="left"||s==="away"?`shadowMask.${r}.away`:`shadowMask.${r}.right`);return i.y=-(M.h*(e-1)),i.scale.x=s==="away"||s==="right"?1:-1,{output:i,renderProps:{facingXy4:s}}},Er={lift:$("shadowMask.smallBlock"),conveyor:q(({direction:r})=>({textureId:"shadowMask.conveyor",flipX:ne(r)==="x"})),doorLegs:q(({direction:r})=>({textureId:r==="right"||r==="towards"?"shadowMask.door.floatingThreshold.double.y":"shadowMask.door.legs.threshold.double.y",flipX:ne(r)==="y"})),teleporter:Bi,floor:"no-mask",barrier:q(({axis:r})=>({textureId:"shadowMask.barrier.y",flipX:r==="x"})),spring:$("shadowMask.smallRound"),block:q(({style:r})=>r==="tower"?"shadowMask.tower":"shadowMask.fullBlock"),pushableBlock:$("shadowMask.stepStool"),movingPlatform:$("shadowMask.fullBlock"),hushPuppy:$("shadowMask.hushPuppy"),portableBlock:q(({style:r})=>r==="drum"?"shadowMask.smallRound":"shadowMask.smallBlock"),slidingBlock:q(({style:r})=>r==="book"?"shadowMask.fullBlock":"shadowMask.smallRound"),deadlyBlock:q(({style:r})=>r==="volcano"?"shadowMask.volcano":"shadowMask.toaster"),spikes:$("shadowMask.spikes"),switch:$("shadowMask.switch"),pickup:q(({gives:r})=>{switch(r){case"scroll":return"shadowMask.scroll";case"doughnuts":return"shadowMask.doughnuts";case"fast":case"extra-life":case"jumps":case"shield":return"shadowMask.whiteRabbit";default:return"blank"}}),slidingDeadly:$("shadowMask.smallRound"),ball:$("shadowMask.ball"),"monster.dalek":$("shadowMask.dalek"),"monster.turtle":gt("turtle"),"monster.skiHead":gt("skiHead"),"monster.homingBot":$("shadowMask.smallRound"),joystick:$("shadowMask.joystick"),charles:gt("charles",2)},Ei=r=>{switch(r.type){case"monster":return Er[`monster.${r.config.which}`];case"floor":return r.config.floorType==="none"?void 0:"no-mask";default:return Er[r.type]}},$i=new ai({alpha:1-Ls});class Li{constructor(e,t){if(this.renderContext=e,this.#e.filters=$i,t!=="no-mask")if(this.#r=new uo(e,t),e.item.shadowOffset===void 0)this.#e.addChild(this.#r.output);else{const n=new w({label:"shadowMaskOffset",...v(e.item.shadowOffset),children:[this.#r.output]});this.#e.addChild(n)}this.#e.addChild(this.#t)}#e=new w({label:"ItemShadowRenderer"});#t=new w({label:"shadows"});#r;#n={};get#o(){return C.getState().gameMenus.userSettings.displaySettings.showShadowMasks}#s(e){if(this.#r===void 0)return;const t=this.#r.output.children.at(0);this.#r.tick(e);const n=this.#r.output.children.at(0);if(n===void 0||!(n instanceof se)){const{item:o}=this.renderContext;throw new Error(`ItemShadowRenderer: this.#shadowMaskRenderer didn't create a sprite for item "${o.id}" of type "${o.type}". Have got ${n}`)}t!==n&&(this.#o?this.renderContext.frontLayer.attach(n):this.#e.mask=n)}destroy(){this.#e.destroy(!0),this.#r?.destroy();for(const e of Object.values(this.#n))e.sprite.destroy()}tick(e){if(this.#t.parent===null)throw new Error("shadow container not in scene graph");const{movedItems:t,progression:n}=e,{item:o,general:{pixiRenderer:s},room:a}=this.renderContext,i=t.has(o),c=o.state.position.z+o.aabb.z,l=Y(a.items).filter(function(h){return h.shadowCastTexture!==void 0}),u=Object.groupBy(l,d=>{const h=this.#n[d.id]!==void 0,f=t.has(d);if(!i&&!f)return h?"keepUnchanged":"noShadow";if(d.castsShadowWhileStoodOn||d.state.position.z>o.state.position.z+o.aabb.z){const m={id:o.id,state:{position:{...o.state.position,z:c}},aabb:{...o.aabb,z:hs}};if(ds(m,d))return h?"update":"create"}return"noShadow"});for(const d of Tr(u.keepUnchanged,u.update))this.#n[d.id].renderedOnProgression=n;if(u.create)for(const d of u.create){const{times:h}=d.config,f=Oe(s,it(d.shadowCastTexture,h));f.label=d.id,this.#t.addChild(f),this.#n[d.id]={sprite:f,renderedOnProgression:n}}for(const d of Tr(u.create,u.update)){const{sprite:h}=this.#n[d.id],f=v({...ke(te(d.state.position,o.state.position),d.shadowOffset??pe),z:o.aabb.z});h.x=f.x,h.y=f.y}for(const[d,{sprite:h,renderedOnProgression:f}]of No(this.#n))f!==n&&(h.destroy(),delete this.#n[d]);const p=(u.keepUnchanged?.length??0)+(u.update?.length??0)+(u.create?.length??0)>0;this.#e.visible=p,p&&this.#s(e)}get output(){return this.#e}}const Ui=r=>{const e=Ei(r.item);return e===void 0?void 0:new Li(r,e)};class Di{constructor(e,t){this.renderContext=e,this.componentRenderers=t,this.output={graphics:t.graphics?.output,sound:t.sound?.output}}output;tick(e){this.componentRenderers.graphics?.tick(e),this.componentRenderers.sound?.tick(e)}destroy(){this.componentRenderers.graphics?.destroy(),this.componentRenderers.sound?.destroy()}}const T=new window.AudioContext,jt=()=>{throw new Error(`sounds not loaded - only call this from inside code 
      (like in a render loop) that is protected and only executed once 
      loading has happened`)},O=r=>{const e=typeof r=="string"?{soundId:r}:r,{playbackRate:t=1,soundId:n,connectTo:o,loop:s=!1,varyPlaybackRate:a=!1,randomiseStartPoint:i=!1}=e,c=T.createBufferSource(),l=jt()[n];return c.buffer=l,c.loop=s,c.playbackRate.value=a?t-.05+Math.random()*.1:t,s&&i?c.start(0,l.duration*Math.random()):c.start(),o!==void 0&&c.connect(o),c},ae=(r,e,t)=>{const n=T.createGain();return e!==void 0&&(n.gain.value=e),r.connect(n),n.connect(t),n},F=({start:r,change:e,loop:t,stop:n,startAndLoopTogether:o=!1,noStartOnFirstFrame:s=!0},a)=>{let i=!0,c,l;return u=>{if(!!u!=!!l)u?r!==void 0&&!(i&&s)?(c?.stop(),c=O({...r}),ae(c,r.gain,a),t!==void 0&&(o?(c=O({...t,loop:!0}),ae(c,t.gain,a)):c.onended=()=>{l&&(c=O({...t,loop:!0}),ae(c,t.gain,a))})):t!==void 0&&(c=O({...t,loop:!0}),ae(c,t.gain,a)):(c&&c.loop&&(c.stop(),c.onended=null),n!==void 0&&(c=O({...n}),ae(c,n.gain,a)));else if(l!==u&&e!==void 0){const d=O({...e});ae(d,e.gain,a)}i=!1,l=u}};class ji{constructor(e){this.renderContext=e,this.output.gain.value=4}output=T.createGain();#e=F({loop:{soundId:"rollingBallLoop",playbackRate:.5}},this.output);tick(){const{renderContext:{item:{state:{vels:{sliding:e},standingOnItemId:t}}}}=this,n=(e.x!==0||e.y!==0)&&t!==null;this.#e(n)}destroy(){}}class Gi{constructor(e){this.renderContext=e;const{item:{config:{was:t}}}=e;switch(t.type){case"pickup":{t.gives!=="scroll"&&O({soundId:"bonus",connectTo:this.output});break}case"disappearing":{O({soundId:"destroy",connectTo:this.output});break}case"hushPuppy":{this.output.gain.value=.5,O({soundId:"hushPuppyVanish",connectTo:this.output});break}}}output=T.createGain();tick(){}destroy(){}}class lr{constructor(e,t,n=1){this.renderContext=e,this.#e=F({start:t},this.output),this.output.gain.value=n}output=T.createGain();#e;tick({lastRenderRoomTime:e}){const{renderContext:{item:t}}=this,{state:{collidedWith:{roomTime:n,by:o}}}=t,s=n>(e??ir)&&!Us(rt(o));this.#e(s)}destroy(){}}class Hi{constructor(e){this.renderContext=e,this.#e.connect(this.output),this.#e.gain.value=.5,this.#r=new lr(e,{soundId:"metalHit"},.3),this.#r.output.connect(this.output)}output=T.createGain();#e=T.createGain();#t=F({start:{soundId:"servoStart",playbackRate:.5},loop:{soundId:"servoLoop",playbackRate:.5},stop:{soundId:"servoStop",playbackRate:.5}},this.#e);#r;tick(e){const{renderContext:{item:t,room:{roomTime:n,items:o}}}=this,{state:{actedOnAt:{roomTime:s,by:a}}}=t,i=n===s&&tt(rt(a)).some(c=>_n(o[c]));this.#t(i),this.#r.tick(e)}destroy(){}}const Fe=r=>{for(const e in r)return!0;return!1},xt=2;class Ni{constructor(e){this.renderContext=e}output=T.createGain();#e=F({start:{soundId:"conveyorStart",playbackRate:xt},loop:{soundId:"conveyorLoop",playbackRate:xt},stop:{soundId:"conveyorEnd",playbackRate:xt}},this.output);tick(){const{renderContext:{item:{state:{stoodOnBy:e}}}}=this,t=Fe(e);this.#e(t)}destroy(){this.#e(!1)}}const Vi=3;class Wi{constructor(e){this.renderContext=e,this.output.gain.value=.7}output=T.createGain();#e=O({soundId:"helicopter",loop:!0,connectTo:this.output});tick(){const{renderContext:{item:{state:{vels:{lift:{z:e}}}}}}=this;this.#e.playbackRate.value=Math.max(.5,1+Vi*e)}destroy(){}}const $r={skiHead:{soundId:"softBump"},turtle:{soundId:"softBump"},dalek:{soundId:"metalHit"},homingBot:{soundId:"metalHit"},computerBot:{soundId:"metalHit"}},Lr={cyberman:{soundId:"jetpackTurnaround",gain:1.2},dalek:{soundId:"mojoTurn",gain:.3}},Ur={cyberman:{soundId:"jetpackLoop",gain:.7},emperorsGuardian:{soundId:"jetpackLoop"},dalek:{soundId:"mojoLoop"},bubbleRobot:{soundId:"bubbleRobotLoop"},helicopterBug:{soundId:"helicopter"}},Dr={homingBot:{start:{soundId:"detect"},loop:{soundId:"robotWhirLoop",gain:4},startAndLoopTogether:!0},computerBot:{loop:{soundId:"robotBeepingLoop",randomiseStartPoint:!0,varyPlaybackRate:!0}}};class Xi{constructor(e){this.renderContext=e,this.#e.connect(this.output),this.#t.connect(this.output),this.#t.gain.value=.66;const{item:{config:{which:t}}}=e;$r[t]!==void 0&&(this.#o=new lr(e,$r[t]),this.#o.output.connect(this.output)),Lr[t]!==void 0&&(this.#r=F({change:Lr[t]},this.#e)),Dr[t]!==void 0&&(this.#s=F(Dr[t],this.#e)),Ur[t]!==void 0&&(this.#n=F({loop:Ur[t]},this.#t))}output=T.createGain();#e=T.createGain();#t=T.createGain();#r;#n;#o;#s;tick(e){const{renderContext:{item:t}}=this,{state:{facing:n,activated:o,busyLickingDoughnutsOffFace:s,vels:{walking:a}}}=t;if(this.#r){const i=Cn(n);this.#r(i)}if(this.#o&&this.#o.tick(e),this.#n){const i=o&&!s;this.#n(i)}if(this.#s){const i=!Qt(a,Me);this.#s(i)}}destroy(){}}class yt{constructor(e){this.renderContext=e;const{general:{soundSettings:t},item:{type:n}}=e,{noFootsteps:o}={...er.soundSettings,...t};o||(this.#e=T.createGain(),this.#e.gain.value=2,this.#e.connect(this.output),this.#t=F({loop:{soundId:`${n==="headOverHeels"?"heels":n}Walk`}},this.#e)),this.#r.gain.value=.8,this.#r.connect(this.output),this.#i.gain.value=1.2,this.#i.connect(this.output),this.#s.connect(this.output),this.#n=F({start:{soundId:`${n==="headOverHeels"?"head":n}Jump`}},this.#r),this.#o=F({loop:{soundId:`${n==="headOverHeels"?"head":n}Fall`}},this.#r)}output=T.createGain();#e;#t;#r=T.createGain();#n;#o;#s=T.createGain();#a=F({start:{soundId:"landing"},noStartOnFirstFrame:!0},this.#s);#i=T.createGain();#l=F({start:{soundId:"carry",playbackRate:.95},stop:{soundId:"carry",playbackRate:1.05}},this.#i);#c={teleportingPhase:null,positionZ:0};tick({lastRenderRoomTime:e}){const{renderContext:{item:t}}=this,{state:{action:n,teleporting:o,jumpStartZ:s,jumped:a,standingOnItemId:i,position:{z:c},vels:{gravity:{z:l}},collidedWith:{roomTime:u,by:p}}}=t,d=zi(t),{teleportingPhase:h,positionZ:f}=this.#c,m=o?o.phase:null,y=a&&c>s&&c>f&&l>0,b=c<f&&l<0&&i===null;this.#o(b),this.#n(y),this.#t!==void 0&&this.#t(!y&&!b&&n==="moving"),d!==void 0&&this.#l(d.carrying!==null);const I=i!==null&&u>(e??ir)&&p[i];if(this.#a(I),m!==null&&m!==h)if(m==="in"){const k=jt().teleportIn,R=T.createBufferSource();R.buffer=k,R.connect(this.output),R.start()}else{const k=jt().teleportOut,R=T.createBufferSource();R.buffer=k,R.connect(this.output),R.start()}this.#c={teleportingPhase:m,positionZ:c}}destroy(){}}class Zi{constructor(e){this.renderContext=e}output=T.createGain();#e=void 0;tick(){const{renderContext:{item:{state:{stoodOnBy:e},config:{style:t}}}}=this;if(t!=="drum")return;const n=this.#e?.stoodOn??!1,o=Fe(e);!n&&o&&O({soundId:"drum",connectTo:this.output}),this.#e={stoodOn:o}}destroy(){}}class qi{constructor(e){this.renderContext=e,this.scrapeBracketed=F({loop:{soundId:"stepStoolScraping"}},this.output),this.output.gain.value=.4}output=T.createGain();scrapeBracketed;tick({movedItems:e}){const{renderContext:{item:t,room:{roomTime:n}}}=this,{state:{actedOnAt:{roomTime:o},standingOnItemId:s}}=t,a=n===o&&s!==null&&e.has(t);this.scrapeBracketed(a)}destroy(){}}class Yi{constructor(e){this.renderContext=e}output=T.createGain();tick({lastRenderRoomTime:e}){const{renderContext:{item:{state:{stoodOnBy:t,stoodOnUntilRoomTime:n}}}}=this,o=Fe(t);e!==void 0&&n>e&&!o&&O({soundId:"springBoing",connectTo:this.output})}destroy(){}}class Ji{constructor(e){this.renderContext=e,this.#e.connect(this.output)}output=T.createGain();#e=T.createGain();#t=void 0;tick(){const{renderContext:{item:{state:{setting:e},config:t}}}=this,n=t.type==="in-store"?Jt(C.getState(),t.path)?"right":"left":e,o=this.#t?.setting;o!==void 0&&o!==n&&O({soundId:"switchClick",playbackRate:n==="right"?.95:1.05,connectTo:this.#e}),this.#t={setting:n}}destroy(){}}class Ki{constructor(e){this.renderContext=e}output=T.createGain();#e=F({loop:{soundId:"teleportWarningSiren"}},this.output);tick(){const{renderContext:{item:e,room:t}}=this;this.#e(cr(e)&&ze(e.state.stoodOnBy,t).some(sr))}destroy(){}}class Qi{constructor(e){this.renderContext=e,O({soundId:"hooter",connectTo:this.output})}output=T.createGain();tick(){}destroy(){}}class ea extends lr{constructor(e){super(e,{soundId:"glassClink",varyPlaybackRate:!0},.8),this.renderContext=e}}const ta=(r,e)=>Hn(ze(r.state.stoodOnBy,e).filter(Pn));class ra{constructor(e){this.renderContext=e,this.output.gain.value=2}output=T.createGain();#e=void 0;tick(e){const{renderContext:{item:t,room:n}}=this,o=ta(t,n);this.#e!==void 0&&o<this.#e&&O({soundId:"toasterPopUpSoundUrl",connectTo:this.output}),this.#e=o}destroy(){}}const na={lift:Wi,switch:Ji,bubbles:Gi,head:yt,heels:yt,headOverHeels:yt,teleporter:Ki,monster:Xi,conveyor:Ni,spring:Yi,portableBlock:Zi,charles:Hi,ball:ji,pushableBlock:qi,firedDoughnut:Qi,slidingBlock:ea},oa=r=>{if(r.item.type==="deadlyBlock"&&r.item.config.style==="toaster")return new ra(r);const e=na[r.item.type];if(e)return new e(r)},jr=M.h*-1,Gr=M.h*ms,sa=0,ia=M.w*16,vt=(r,e,t)=>(r-e)/(t-e)*2-1;class aa{constructor(e,t){this.renderContext=e,this.childRenderer=t,t.output.connect(this.output),this.output.rolloffFactor=2,this.output.maxDistance=5,this.output.distanceModel="exponential";const n=ps(e.room).floors;this.soundPositionMinX=n.edgeLeftX,this.soundPositionMaxX=n.edgeRightX}output=T.createPanner();soundPositionMinX;soundPositionMaxX;tick(e){this.childRenderer.tick(e);const{item:t}=this.renderContext,n=t.state,o=P(n.position,In(t.aabb,.5)),s=vt(fs(o),this.soundPositionMaxX,this.soundPositionMinX),a=vt(o.z,jr,Gr);if(!Number.isFinite(a))throw new Error(`y position for sound rendering is not finite;
        positionY = numberInRangeToMinus1To1Range(
          itemCentrePosition = ${o.z},
          ${jr},
          ${Gr},
        );
        itemCentrePosition = addXyz(
          itemState.position = ${JSON.stringify(n.position)},
          scaleXyz(${JSON.stringify(t.aabb)}, 0.5),
        )`);const i=vt(o.x+o.y,sa,ia);this.output.positionX.value=s,this.output.positionY.value=a,this.output.positionZ.value=i}destroy(){this.childRenderer.destroy()}}const ye=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,ca=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uColour;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    // we know c.a is either 0 or 1, so no need to do a step()

    finalColor = mix(c, vec4(uColour, 1), c.a);
}
`;class Je extends J{constructor(e){const t=V.from({vertex:ye,fragment:ca,name:"oneColour-filter"});super({glProgram:t,resources:{colorReplaceUniforms:{uColour:{value:new Float32Array(3),type:"vec3<f32>"}}}});const n=this.resources.colorReplaceUniforms.uniforms,[o,s,a]=e.toArray();n.uColour[0]=o,n.uColour[1]=s,n.uColour[2]=a}}const la={pureBlack:new _("#000000"),shadow:new _("#1B2D3B"),midGrey:new _("#505A55"),lightGrey:new _("#929981"),white:new _("#F8FEF8"),pastelBlue:new _("#4893FF"),metallicBlue:new _("#1D4E80"),pink:new _("#B973AF"),moss:new _("#6E7B00"),redShadow:new _("#513D40"),midRed:new _("#A7574B"),lightBeige:new _("#BF8E69"),highlightBeige:new _("#DBB269"),alpha:new _("#105A69"),replaceLight:new _("#048662"),replaceDark:new _("#052229")},ua=`#version 300 es
// keep this one at mediump for the hash function's precision
precision mediump float;

in vec2 vTextureCoord;
out vec4 finalColor;

const float LUT_SIZE = 256.0;
const float magicNumber = 31.0; // Small prime number

uniform sampler2D uTexture;
uniform sampler2D uLut;

/** returns in [0, LUT_SIZE] range
this must match the TypeScript version of the hash function*/
float hashColor(vec3 color) {
    vec3 c255 = floor(color * 255.0);
    
    float hash = mod(
        c255.r + c255.g * magicNumber + c255.b * magicNumber * magicNumber, 
        LUT_SIZE
    );
    return hash;
}

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    float h = hashColor(c.rgb);

    // use the hash to look up the replacement in the LUT:
    vec4 replacementColour = texture(
        uLut, 
        vec2(
            // normalise h to [0, 1] range
            (h + 0.5) / LUT_SIZE, 
            0.5
        )
    );
    
    // use original if either: 
    //      original alpha is 0 (because keep transparent)
    //      or lut alpha is 0 (signals nothing in this slot of the LUT)
    finalColor = mix(c, replacementColour, c.a * replacementColour.a);
}
`,Te=256,wt=31,Hr=new Map;function da(r){const e=Math.floor(r.red*255),t=Math.floor(r.green*255),n=Math.floor(r.blue*255);return(e+t*wt+n*wt*wt)%Te}function ha(r){const e=new Float32Array(Te*4);for(const[o,s]of Vo(r)){const a=g[o],i=da(a);if(e[i*4+3]>.5)throw new Error("LUT collision - mess with the hash function or lut size until this goes away");e[i*4+0]=s.red,e[i*4+1]=s.green,e[i*4+2]=s.blue,e[i*4+3]=1}const t=new Uint8Array(Te*4);for(let o=0;o<Te*4;o++)t[o]=Math.floor(e[o]*255);return N.from({resource:t,width:Te,height:1,scaleMode:"nearest"})}class pa extends J{#e;constructor(e){const t=Object.keys(e).length,n=V.from({vertex:ye,fragment:ua,name:"palette-swop-filter"}),o=ha(e);super({glProgram:n,resources:{colorReplaceUniforms:{uOriginal:{value:new Float32Array(3*t),type:"vec3<f32>",size:t},uReplacement:{value:new Float32Array(3*t),type:"vec3<f32>",size:t}},uLut:o.source}}),this.#e=o;const s=this.resources.colorReplaceUniforms.uniforms;Object.entries(e).forEach(([a,i],c)=>{g[a].toArray().forEach((l,u)=>{s.uOriginal[c*3+u]=l}),i.toArray().forEach((l,u)=>{s.uReplacement[c*3+u]=l})})}destroy(e){this.#e?.destroy(!0),this.#e=null,super.destroy(e)}}const fa=r=>Object.entries(r).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>`${e}:${t.toHex()}`).join("|"),K=r=>{const e=fa(r);let t=Hr.get(e);return t||(t=new pa(r),Hr.set(e,t)),t},ma=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uTargetColor;

vec4 black = vec4(0.0, 0.0, 0.0, 1.0);

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    // 1 if black, 0 if non-black
    float isBlack = step(length(c.rgb), 0.01);

    // keep original if either:
    //      * black
    //      * transparent

    finalColor = mix(    
        vec4(uTargetColor, 1),    
        c, 
        max(isBlack, 1.0 - c.a)
    );
}
`;class B extends J{uniforms;constructor(e="white"){const t=V.from({vertex:ye,fragment:ma,name:"revert-colourise-filter"});super({glProgram:t,resources:{colorReplaceUniforms:{uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this.targetColor=e}set targetColor(e){const[t,n,o]=new _(e).toArray();this.uniforms.uTargetColor[0]=t,this.uniforms.uTargetColor[1]=n,this.uniforms.uTargetColor[2]=o}}const ga=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    finalColor = vec4(c.rgb * 0.5, c.a);
}
`;class xa extends J{constructor(){const e=V.from({vertex:ye,fragment:ga,name:"halfbrite-filter"});super({glProgram:e,resources:{}})}}const fo=({basic:r,dimmed:e})=>({replaceLight:r,replaceDark:e}),mo=({color:{hue:r,shade:e},planet:t})=>{const n=r==="yellow"?e==="dimmed"||t==="jail"?Ds:js:Un[r][e].main;return fo(n)},ya=r=>K({lightBeige:g.lightGrey,redShadow:g.shadow,pink:g.lightGrey,moss:g.lightGrey,midRed:g.midGrey,highlightBeige:g.lightGrey,...r&&mo(r)}),va=K({midGrey:g.midRed,lightGrey:g.lightBeige,white:g.highlightBeige,metallicBlue:g.redShadow,pink:g.midRed,moss:g.midRed,replaceDark:g.midRed,replaceLight:g.lightBeige}),Nr=(r,e)=>{const t=qe(r.color).edges[e],n=t.original;return t.dimInOriginal?Dn(n):n},go=(r,e,t)=>t?K(fo(Un[r.color.hue][r.color.shade].edges[e])):new B(qe(r.color).edges[e].original),G=r=>K(mo(r)),wa=r=>{switch(r.color.hue){case"white":return K({replaceLight:g.lightGrey,replaceDark:g.midGrey});default:return G(r)}},xo=r=>{switch(r.color.hue){case"white":return K({replaceLight:g.lightBeige,replaceDark:g.midRed,shadow:g.redShadow});case"yellow":return G({planet:r.planet,color:{hue:"yellow",shade:"dimmed"}});default:return G(r)}};new xa;const Q=Ot,ba=K(la),Ca=[new Je(g.midRed)],Ia=[new Je(g.moss)],Ta=75;class ka{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output)}output=new w({label:"ItemFlashOnSwitchedRenderer"});tick(e){const{renderContext:{item:{state:{switchedAtRoomTime:t,switchedSetting:n}},room:{roomTime:o}}}=this;this.output.filters=o-t<Ta?n==="left"?Ia:Ca:Q,this.childRenderer.tick(e)}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const Sa=(r,e,t)=>{const o=re().textures[`door.frame.${r.planet}.${e}.near`]!==void 0?r.planet:"generic",s=r.color.shade==="dimmed"&&re().textures[`door.frame.${o}.dark.${e}.${t}`]!==void 0;return`door.frame.${o}${s?".dark":""}.${e}.${t}`};function at(r,e){const t=e||new w;for(const n of r)t.addChild(n);return t}function*Ra({config:{direction:r,inHiddenWall:e,height:t}},n){const o=tr(r),s=o==="y"?1:16;function*a(i){if(e){if(t!==0){const c=x({textureId:`generic.door.floatingThreshold.${o}`,...ke(i,{y:-12*t})});c.filters=go(n,o==="x"?"towards":"right",!0),yield c}}else{yield x({pivot:{x:s,y:9},textureId:`generic.door.legs.base.${o}`,...ke(i,{})});for(let c=1;c<t;c++)yield x({pivot:{x:s,y:9},textureId:`generic.door.legs.pillar.${o}`,...ke(i,{y:-c*M.h})})}}yield*a(oe({...pe,[o]:1})),yield*a(pe),e||(yield x({pivot:{x:16,y:M.h*t+13},textureId:`generic.door.legs.threshold.double.${o}`,...oe({...pe,[o]:1})}))}const yo=(r,e)=>{const t=tr(r),n=nt(t),o=8;return r==="towards"||r==="right"?v({[n]:e[n]-o}):pe},_a=A(({renderContext:{item:r,room:e}})=>at(Ra(r,e),new w({filters:G(e),...yo(r.config.direction,r.aabb)}))),Pa=A(({renderContext:{item:{config:{direction:r,part:e,toRoom:t},aabb:n},room:o,general:{gameState:s}}})=>{const a=tr(r),i=s===void 0?o:s.campaign.rooms[t]??o;return x({textureId:Sa(o,a,e),filter:G(i),...yo(r,n)})}),bt={animationId:"bubbles.cold"},he=({top:r,bottom:e="headlessBase",filter:t})=>{const n=new w({filters:t}),o=x(e);n.addChild(o);const s=x(r);return s.y=-12,n.addChild(s),n[ct]=s,n[ur]=o,n},ct=Symbol(),ur=Symbol(),Ma=({top:r,bottom:e})=>{const t=new w;return t.addChild(e),r.y=-12,t.addChild(r),t[ct]=r,t[ur]=e,t},Aa=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform vec2 uTextureSize;
uniform sampler2D uTexture;
uniform vec3 uOutline;
uniform float uOutlineWidth;

void main(void) {
    vec2 scaledTexelSize = vec2(1.0f) / vec2(textureSize(uTexture, 0)) * uOutlineWidth;    
    
    // Calculate offset coordinates
    vec2 rightCoord = vec2(vTextureCoord.x + scaledTexelSize.x, vTextureCoord.y);
    vec2 leftCoord = vec2(vTextureCoord.x - scaledTexelSize.x, vTextureCoord.y);
    vec2 belowCoord = vec2(vTextureCoord.x, vTextureCoord.y + scaledTexelSize.y);
    vec2 aboveCoord = vec2(vTextureCoord.x, vTextureCoord.y - scaledTexelSize.y);
    
    // Create boundary masks (1.0 if within bounds, 0.0 if out of bounds)
    // seems to work fine without this, but could multiply colourToX by this to get zero'd out when OOB
    // float rightInBounds = step(rightCoord.x, 1.0);
    // float leftInBounds = step(0.0, leftCoord.x);
    // float belowInBounds = step(belowCoord.y, 1.0);
    // float aboveInBounds = step(0.0, aboveCoord.y);
    
    vec4 colourToRight = texture(uTexture, rightCoord);
    vec4 colourToLeft = texture(uTexture, leftCoord);
    vec4 colourBelow = texture(uTexture, belowCoord);
    vec4 colourAbove = texture(uTexture, aboveCoord);
    
    // Check if any neighbor is opaque (combine all alpha values)
    float hasOpaqueNeighbor = max(max(colourToRight.a, colourToLeft.a), 
                                  max(colourBelow.a, colourAbove.a));

    vec4 originalColour = texture(uTexture, vTextureCoord);
        
    finalColor = mix(
        originalColour, 
        vec4(uOutline, 1), 
        // 1 if: original colour is transparent and has an opaque neighbour - use outline colour
        // 0 if: original colour is opaque or has no opaque neighbour - use original colour (transparent or sprite)
        (1.0 - originalColour.a) * hasOpaqueNeighbor
    );
}
`;let Gt=Tn(C.getState());C.subscribe(()=>{Gt=Tn(C.getState())});class Ht extends J{outlineWidth;constructor({color:e,width:t}){const n=V.from({vertex:ye,fragment:Aa,name:"outline-filter"}),o=t??Gt;super({glProgram:n,padding:o,resources:{colorReplaceUniforms:{uOutline:{value:new Float32Array(3),type:"vec3<f32>"},uOutlineWidth:{value:new Float32Array(1),type:"f32"}}}}),this.outlineWidth=t;const s=this.resources.colorReplaceUniforms.uniforms,[a,i,c]=e.toArray();s.uOutline[0]=a,s.uOutline[1]=i,s.uOutline[2]=c}apply(e,t,n,o){const s=this.resources.colorReplaceUniforms.uniforms,a=this.outlineWidth??Gt;this.padding=a,s.uOutlineWidth[0]=a,super.apply(e,t,n,o)}}const W={...Wo(g,([r,e])=>[r,new Ht({color:e})]),black1pxFilter:new Ht({color:g.pureBlack,width:1})},Oa=r=>{const{gameTime:e,lastDiedAt:t}=r.type==="headOverHeels"?r.state.head:r.state;return e-t<gs},Ct=r=>{if(r===void 0)return 0;const{shieldCollectedAt:e,gameTime:t}=r;return e!==null&&e+mr>t?100-Math.ceil((t-e)/(mr/100)):0},za=r=>r.type==="headOverHeels"?Ct(r.state.head)>0||Ct(r.state.heels)>0:Ct(r.state)>0,lt=r=>r,Nt=.02,Fa=({name:r,action:e,facingXy8:t,teleportingPhase:n,gravityZ:o,paused:s})=>{if(e==="death")return{animationId:`${r}.fadeOut`,paused:s};if(n==="out")return{animationId:`${r}.fadeOut`,paused:s};if(n==="in")return{animationId:`${r}.fadeOut`,paused:s};if(e==="moving")return{animationId:`${r}.walking.${t}`,paused:s};if(e==="jumping")return{textureId:o<Nt?`${r}.walking.${t}.2`:`${r}.walking.${t}.1`};if(e==="falling"){const i=`${r}.falling.${t}`;if(Gs(i))return{textureId:i}}const a=`${r}.idle.${t}`;return jn(a)?{animationId:a,paused:s}:{textureId:`${r}.walking.${t}.2`}},Vt=Symbol(),Wt=Symbol(),Ba=(r,e)=>{r[Vt].removeChildren(),r[Vt].addChild(x(Fa(e)))},vo=K({pastelBlue:g.pink}),It=(r,e,t)=>{const n=new w,o=new w;n[Vt]=o,n.addChild(o);const s=x({animationId:e?`shine.${r}InSymbio`:"shine",paused:t,filter:r==="heels"?vo:Q,flipX:r==="heels"});return n[Wt]=s,n},Vr=({gameTime:r,switchedToAt:e},t,n)=>(t==="headOverHeels"||t===n)&&e+xs>r,Ea=r=>{if(!Oa(r))return!1;const{gameTime:e,lastDiedAt:t}=r.type==="headOverHeels"?r.state.head:r.state;return(e-t)%gr<gr*ys},Wr=(r,e)=>{r.filters?Array.isArray(r.filters)?r.filters=[...r.filters,e]:r.filters=[r.filters,e].flat():r.filters=e},Xr=(r,e)=>{r.filters=Array.isArray(r.filters)?r.filters.filter(t=>!(t instanceof e)):r.filters instanceof e?Q:[...r.filters]},$a=(r,{highlighted:e,flashing:t},n,o)=>{const s=n?.highlighted??!1;e&&!s?Wr(o,W[de[r]]):!e&&s&&Xr(o,Ht);const a=n?.flashing??!1;t&&!a?Wr(o,new Je(g[de[r]])):!t&&a&&Xr(o,Je)},La=(r,e,t)=>{e&&!t?r.addChild(r[Wt]):!e&&t&&r.removeChild(r[Wt])},Tt=(r,e,t,n,o,s)=>{t&&Ba(e,{name:r,...n,paused:o}),$a(r,n,s,e),La(e,n.shining,s?.shining??!1)},Ua=({renderContext:{item:r,general:{gameState:e,paused:t}},currentRendering:n})=>{const{type:o,state:{action:s,facing:a,teleporting:i,vels:{gravity:{z:c}}}}=r,l=n?.renderProps,u=n?.output,p=Cn(a)??"towards",d=e!==void 0&&(r.type==="headOverHeels"?Vr(r.state.head,"headOverHeels","headOverHeels"):Vr(r.state,r.type,e.currentCharacterName)),h=Ea(r),f=za(r),m=Yt(a),y=i?.phase??null,b={action:s,facingXy8:p,teleportingPhase:y,flashing:h,highlighted:d,shining:f,gravityZ:c},I=l===void 0||l.action!==s||l.facingXy8!==p||l.teleportingPhase!==y||l?.gravityZ>Nt!=c>Nt;let k;if(o==="headOverHeels"){k=u??Ma({top:It("head",!0,t),bottom:It("heels",!0,t)});const R=k;Tt("head",R[ct],I,b,t,l),Tt("heels",R[ur],I,b,t,l)}else k=u??It(o,!1,t),Tt(o,k,I,b,t,l);return s==="moving"&&u instanceof fe&&(u.animationSpeed=m*Xo),{output:k,renderProps:b}},kt=lt(Ua),Zr=r=>r-Math.floor(r),Da=({state:{position:r}},e)=>{const t=o=>o.config.direction==="away"||o.config.direction==="left";return at(Y(e.items).filter(o=>o.type==="wall"||o.type==="doorLegs").filter(t).map(o=>{const{id:s,config:{direction:a},state:{position:i}}=o;return x({textureId:"floorOverdraw.cornerNearWall",label:s,...v(zt(i,r)),times:o.type==="wall"?Mn(o.config):{[nt(ne(a))]:2},anchor:{x:0,y:1},flipX:a==="away"})}),new w({label:"floorOverdraws"}))},ja=`#version 300 es
precision lowp float;

out vec4 finalColor;

in vec2 vTextureCoord;
uniform sampler2D uBackBuffer;
uniform vec3 uTargetColor;
// do not use uTexture in this frag - for some reason it causes pixi's render pipeline
// to take away the backbuffer, which we rely on sampling from

void main() {
    vec3 bg = texture(uBackBuffer, vTextureCoord).rgb;

    float isBlack = step(length(bg), 0.001f); // 1 if black, 0 otherwise
    finalColor = mix(vec4(uTargetColor, 1.0f), vec4(0, 0, 0, 0), isBlack);


}`;class qr extends J{uniforms;constructor(e="white"){const t=V.from({vertex:ye,fragment:ja,name:"colour-clash-filter"});super({glProgram:t,resources:{colorReplaceUniforms:{uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}},blendRequired:!0}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this.targetColor=e}set targetColor(e){const[t,n,o]=new _(e).toArray();this.uniforms.uTargetColor[0]=t,this.uniforms.uTargetColor[1]=n,this.uniforms.uTargetColor[2]=o}}const Yr=({colourised:r,direction:e,room:t,times:n,position:o,colourSwap:s})=>x({label:`floorEdge(${e})`,textureId:`floorEdge.${e}`,times:n,filter:s?go(t,e,r):void 0,...v(o)}),Ga=({room:r,xSize:e,ySize:t,y:n})=>{const o=new w({label:"floorColourClash"}),s=Nr(r,"right");for(let i=0;i<=t;i++){const c=oe({x:0,y:i,z:0}),l=new j().rect(c.x-(i===0?0:8),c.y,8*3,8).fill(s);l.filters=new qr(s),o.addChild(l)}const a=Nr(r,"towards");for(let i=0;i<=e;i++){const c=oe({x:i,y:0,z:0}),l=new j().rect(c.x-16,c.y,8*(i===0?2:3),8).fill(a);l.filters=new qr(a),o.addChild(l)}return o.y=n,o},Ha=A(({renderContext:{room:r,item:e,general:{colourised:t,pixiRenderer:n},colourClashLayer:o}})=>{const{color:{shade:s}}=r,{config:a,state:{position:i},aabb:c}=e,{floorType:l,naturalFootprint:u}=a,p=new w({label:"floorAppearance"}),d=v({...c,y:0}),h=v({...c,x:0,y:0}),f=v({...c,x:0}),m=v(c);if(l!=="none"){const y=new w({label:"tiles"}),b=l==="deadly"?`generic${s==="dimmed"?".dark":""}.floor.deadly`:`${a.scenery}${s==="dimmed"?".dark":""}.floor`,I=re().textures[b];try{Gn(b)}catch(Oo){throw new Error(`no floor textureId for floorType: ${l}, shade: ${s}`,{cause:Oo})}const k=te(u.position,i),R={x:Zr(k.x/M.w),y:Zr(k.y/M.w)},L=8,ee={x:d.x,y:m.y-L,width:f.x-d.x,height:h.y-m.y+2*L},D=te(oe(ke(R,{x:.5,y:.5})),{y:c.z},ee),Be=new di({texture:I,tilePosition:D,...ee});y.addChild(Be),y.addChild(Da(e,r));const dr=new j().moveTo(m.x,m.y).lineTo(f.x,f.y).lineTo(f.x,f.y+3).lineTo(h.x,h.y+3).lineTo(d.x,d.y+3).lineTo(d.x,d.y).fill({color:16711680,alpha:.5});y.addChild(dr),y.mask=dr,y.filters=[wa(r)];const hr=new w({children:[y]});hr.filters=W.black1pxFilter,p.addChild(ge(n,hr))}{const y=new w({label:"edges"});l==="none"&&y.addChild(new j().moveTo(f.x,f.y+8).lineTo(f.x,f.y+100).lineTo(d.x,d.y+100).lineTo(d.x,d.y+8).lineTo(h.x,h.y+8).fill(0));const b=Math.ceil(c.y/M.w);y.addChild(Yr({colourised:t,direction:"right",room:r,times:{y:b},position:{z:c.z},colourSwap:t}));const I=Math.ceil(c.x/M.w);if(y.addChild(Yr({colourised:t,direction:"towards",room:r,times:{x:I},position:{z:c.z},colourSwap:t})),p.addChild(ge(n,y)),!t){const k=Ga({xSize:I,ySize:b,y:-c.z+1,room:r});p.addChild(k),o.attach(k)}}return p}),Na=["cyberman","dalek","skiHead","bubbleRobot","computerBot","turtle","homingBot"],Va=r=>{let e=2166136261;const t=r.length;for(let n=Math.max(0,t-9);n<t;n++)e^=r.charCodeAt(n),e=Math.imul(e,1540483477),e^=e>>>15;return(e>>>0)/4294967295},Wa=200,Xa=1,Za=(r,e)=>{const t=Va(e);return Math.sin((r+t*2e4)/Wa)*Xa},Jr=({id:r,config:{which:e},state:t},n,o)=>{if((e==="cyberman"||e==="bubbleRobot")&&t.activated||e==="emperorsGuardian"){const s=o;s[ct].y=-12+Za(n.roomTime,r)}},qa=({renderContext:{item:r,room:e,general:{paused:t}},currentRendering:n})=>{const{config:o,state:s}=r,a=n?.renderProps,{activated:i,busyLickingDoughnutsOffFace:c}=s,l=c?va:i?void 0:Na.includes(o.which)?ya(e):void 0;switch(o.which){case"skiHead":case"turtle":case"cyberman":case"computerBot":case"elephant":case"elephantHead":case"monkey":{const u=Kt(s.facing)??"towards";if(!(a===void 0||i!==a.activated||c!==a.busyLickingDoughnutsOffFace||u!==a.facingXy4))return Jr(r,e,n.output),"no-update";const d={facingXy4:u,activated:i,busyLickingDoughnutsOffFace:c};switch(o.which){case"skiHead":return{output:x({textureId:`${o.which}.${o.style}.${u}`,filter:l}),renderProps:d};case"elephantHead":return{output:x({textureId:`elephant.${u}`,filter:l}),renderProps:d};case"turtle":return{output:x(i&&!c?{animationId:`${o.which}.${u}`,filter:l,paused:t}:{textureId:`${o.which}.${u}.1`,filter:l}),renderProps:d};case"cyberman":return{output:s.activated||s.busyLickingDoughnutsOffFace?he({top:{textureId:`${o.which}.${u}`,filter:l||G(e)},bottom:{...bt,paused:t}}):x({textureId:`${o.which}.${u}`,filter:l}),renderProps:d};case"computerBot":case"elephant":case"monkey":return{output:he({top:`${o.which}.${u}`,bottom:{animationId:"headlessBase.flash",playOnce:"and-stop"},filter:l}),renderProps:d};default:throw new Error(`unexpected monster ${o}`)}break}case"homingBot":{const u=!Zo(s.vels.walking,pe);return a===void 0||c!==a.busyLickingDoughnutsOffFace||i!==a.activated||u!==a.walking?{filter:l,output:x(i&&!c?{animationId:u?"headlessBase.flash":"headlessBase.scan",filter:l}:{textureId:"headlessBase",filter:l}),renderProps:{activated:i,busyLickingDoughnutsOffFace:c,walking:u}}:"no-update"}case"helicopterBug":case"emperor":case"dalek":case"bubbleRobot":case"emperorsGuardian":{if(!(a===void 0||c!==a.busyLickingDoughnutsOffFace||i!==a.activated))return Jr(r,e,n.output),"no-update";const p={activated:i,busyLickingDoughnutsOffFace:c};switch(o.which){case"helicopterBug":case"dalek":return{output:x(i&&!c?{animationId:o.which,filter:l,paused:t}:{textureId:`${o.which}.1`,filter:l}),renderProps:p};case"bubbleRobot":return{output:he({top:{...bt,paused:t},filter:l}),renderProps:p};case"emperorsGuardian":return{output:he({top:"ball",bottom:{...bt,paused:t},filter:l}),renderProps:p};case"emperor":return{output:x({animationId:"bubbles.cold",filter:l,paused:t}),renderProps:p};default:throw new Error(`unexpected monster ${o}`)}break}default:throw new Error(`unexpected monster ${o}`)}},He=W.pureBlack;new B;new B;new B;new B(g.moss);new B;new B(g[de.head]),new B(vr(g[de.head])),new B(g[de.heels]),new B(vr(g[de.heels]));function*Ya(r){const e=typeof r=="string"?r==="infinite"?"":r:r.toString(),t=Hn(e);let n=0;for(const o of e){const s=`hud.char.${qo(o)}`;try{Gn(s)}catch(a){throw new Error(`no texture id for char "${o}": ${a.message}`,{cause:a})}yield x({textureId:s,x:(n+.5-t/2)*Yo.w}),n++}}const wo=(r,e)=>{r.removeChildren();try{at(Ya(e),r)}catch(t){throw console.error("invalid string is",e,"and on window as window.invalid"),console.error(t),window.invalid=e,new Error(`could not show text "${e}" in container because: "${t.message}"`,{cause:t})}return r},Ja=vs.floatingText,Ka=12,Kr=M.h*3,Qr=[g.shadow,g.midGrey,g.redShadow,g.metallicBlue,g.midRed,g.moss,g.pink,g.lightBeige,g.pastelBlue,g.lightGrey,g.highlightBeige],en=[...Qr,...new Array(20).fill(g.white),...Qr.toReversed()],Qa=({renderContext:{item:{config:{textLines:r,appearanceRoomTime:e}},room:{roomTime:t},general:{displaySettings:{uncolourised:n}},frontLayer:o},currentRendering:s})=>{const a=s?.output;let i;const l=(t-e)*Ja;if(a===void 0){i=new w({filters:W.pureBlack}),o?.attach(i);for(let p=0;p<r.length;p++){const d=r[p],h=wo(new w({label:d,y:p*Ka,filters:n?Q:new B(g.pink)}),d.toUpperCase());i.addChild(h)}}else i=a;let u=!1;for(let p=0;p<r.length;p++){const d=i.children[p],[h]=d.filters,f=l+p*-12,m=f>0&&f<Kr;if(d.visible=m,u||=m,m&&h){const y=Math.floor(f/Kr*en.length);h.targetColor=en[y]}}return i.visible=u,i.y=-l,{output:i,renderProps:Pe}},tn=500,ec=et.animations["conveyor.x"].animationSpeed,rn=et.animations["conveyor.x"].length,tc=r=>1-(1-r)**2,rc=(r,e)=>{for(let t=0;t<r.children.length;t++){const n=r.children[t],o=t%rn;n.gotoAndStop(e?rn-o-1:o)}},nc=(r,e)=>{const t=ne(r),n=x({animationId:`conveyor.${t}`,reverse:r==="towards"||r==="right",times:e}),o=n instanceof fe?new w({children:[n]}):n;return rc(o,r==="towards"||r==="right"),o},oc=({renderContext:{item:{config:{direction:r,times:e},state:{stoodOnBy:t}},room:{roomTime:n}},currentRendering:o})=>{const s=o?.renderProps,a=Fe(t),i=(!a&&s?.moving?n:s?.roomTimeStoppedMoving)??ir,c=o?.output??nc(r,e),l=a?0:Math.min(n-i,tn),u=Math.max(0,1-l/tn);for(const p of c.children)if(u===0)p.stop();else{const d=ec*tc(u);p.play(),p.animationSpeed=d}return{output:c,renderProps:{moving:a,roomTimeStoppedMoving:i}}},sc=lt(oc),ic=({renderContext:{item:r,room:e,general:{paused:t}},currentRendering:n})=>{const{state:{stoodOnBy:o},config:{times:s}}=r,a=n?.renderProps,i=cr(r),c=i&&ze(o,e).some(sr);return a===void 0||i!==a.activated||c!==a.flashing?{output:c?new w({children:[x({textureId:"teleporter",times:s}),x({animationId:"teleporter.flashing",times:s,paused:t})]}):x({textureId:i?"teleporter":"block.artificial",times:s}),renderProps:{flashing:c,activated:i}}:"no-update"},ac=({renderContext:{item:{state:{facing:r,actedOnAt:{roomTime:e,by:t}}},room:{roomTime:n,items:o}},currentRendering:s})=>{const a=s?.renderProps,i=Kt(r)??"towards",c=n===e&&tt(rt(t)).some(u=>_n(o[u]));return a===void 0||i!==a.facingXy4||c!==a.controlledByJoystick?{output:he({top:`charles.${i}`,bottom:c?"headlessBase.all":"headlessBase"}),renderProps:{facingXy4:i,controlledByJoystick:c}}:"no-update"},cc=({renderContext:{item:{state:{stoodOnBy:r,stoodOnUntilRoomTime:e}},general:{paused:t}},tickContext:{lastRenderRoomTime:n},currentRendering:o})=>{const s=o?.renderProps,a=Fe(r);let i;return o?.output?i=o?.output:(i=x({animationId:"spring.bounce"}),i.loop=!1,i.gotoAndStop(0)),n!==void 0&&e>n&&!a&&!t?i.gotoAndPlay(0):a&&!(s?.compressed??!1)&&i.gotoAndStop(1),{output:i,renderProps:{compressed:a}}},lc=lt(cc),uc=({renderContext:{item:{config:{which:r,startDirection:e}}},currentRendering:t})=>t?.renderProps===void 0?{output:r==="headOverHeels"?he({top:{textureId:`head.walking.${e}.2`},bottom:{textureId:`heels.walking.${e}.2`}}):x({textureId:`${r}.walking.${e}.2`}),renderProps:Pe}:"no-update",dc=({renderContext:{item:{state:{vels:{sliding:r}},config:{startingPhase:e}},general:{paused:t}},tickContext:{deltaMS:n},currentRendering:o})=>{const a=(o?.renderProps?.distanceTravelled??0)+rr(r)*(t?0:n),c=o?.output??x("spikyBall.1"),u=(Math.floor(a*2/Ve.w)+e)%2+1;return c.texture=re().textures[`spikyBall.${u}`],{output:c,renderProps:{distanceTravelled:a}}},hc=lt(dc),pc=(r,e,t,n)=>`${r}${n?".dark":""}.wall.${e}.${t}`,fc=A(({renderContext:{general:{pixiRenderer:r},item:{id:e,config:t},room:n}})=>{if(t.direction==="right"||t.direction==="towards")throw new Error(`wall is near: ${e}`);const{direction:o,tiles:s}=t,a=nt(ne(o)),i=new w({label:"wallTiles"}),c=new w({label:"wallAnimations"});for(let u=0;u<t.tiles.length;u++){const p=oe({[a]:u});if(i.addChild(x({textureId:pc(n.planet,s[u],o,n.color.shade==="dimmed"),...p,pivot:o==="away"?{x:Ve.w,y:Ve.h}:{x:0,y:Ve.h}})),n.planet==="moonbase"){const d=`moonbase.wall.screen.${s[u]}.away`;jn(d)&&c.addChild(x({animationId:d,randomiseStartFrame:!0,flipX:o==="left",x:p.x+(o==="away"?-8:8),y:p.y-23}))}}const l=new w({label:"wallAppearance"});return l.addChild(ge(r,i)),c.children.length>0&&l.addChild(c),l.filters=G(n),l}),mc=({renderContext:{item:{state:{setting:r},config:e}},currentRendering:t})=>{const n=t?.renderProps,o=e.type==="in-store"?Jt(C.getState(),e.path)?"right":"left":r;return n===void 0||o!==n.setting?{output:x(`switch.${o}`),renderProps:{setting:o}}:"no-update"},gc=(r,e,t)=>e==="tower"?"tower":e==="book"?"book.x":e==="organic"&&r?`block.organic.dark${t?".disappearing":""}`:`block.${e}${t?".disappearing":""}`,xc=({renderContext:{general:{pixiRenderer:r},item:{config:{style:e,times:t},state:{disappearing:n}},room:o},currentRendering:s})=>{const a=s?.renderProps,i=n!==null;return a===void 0||a.isDissapearing!==i?{output:Oe(r,x({textureId:gc(o.color.shade==="dimmed",e,i),filter:e==="organic"?G(o):e==="book"?xo(o):void 0,times:t})),renderProps:{isDissapearing:i}}:"no-update"},yc=({state:{stoodOnBy:r,position:e},config:{times:t}},n)=>{const o=new Array(t?.x??1).fill(null).map(()=>new Array(t?.y??1));return ze(r,n).filter(Pn).forEach(({id:s,state:{position:a}})=>{const i=te(a,e),c={x:Math.floor(i.x/M.w),y:Math.floor(i.y/M.d)};c.x<0||c.x>=(t?.x??1)||c.y<0||c.y>=(t?.y??1)||(o[c.x][c.y]=s)}),o},vc=(r,e)=>{let t=0,n=1;for(const o of e)for(const s of o)s!==void 0&&r.items[s]?.state.activated&&(t|=n),n<<=1;return t},wc=({renderContext:{item:r,room:e},currentRendering:t})=>{const{config:{times:n}}=r,o=t===void 0?yc(r,e):t.renderProps.chargePositions,s=vc(e,o);return s!==t?.renderProps.cybermanActivationBitmask?{output:x({textureIdCallback(i,c){const l=o[i][c];return l===void 0||e.items[l]?.state.everActivated?"toaster.off":"toaster.on"},times:n??Pe}),renderProps:{chargePositions:o,cybermanActivationBitmask:s}}:"no-update"},bc={head:kt,heels:kt,headOverHeels:kt,doorFrame:Pa,doorLegs:_a,monster:qa,floatingText:Qa,barrier:A(({renderContext:{item:{config:{axis:r,times:e}}}})=>x({textureId:`barrier.${r}`,times:e})),deadlyBlock:A(({renderContext:{item:{config:r},room:e}})=>{switch(r.style){case"volcano":return x({animationId:"volcano",filter:G(e),times:r.times,randomiseStartFrame:!0});case"toaster":throw new Error("use the special toaster appearance instead");default:throw r.style,new Error("unknown deadly block style")}}),spikes:Z("spikes"),slidingDeadly:hc,slidingBlock:A(({renderContext:{item:{config:{style:r}},room:e}})=>x(r==="book"?{textureId:"book.y",filter:xo(e)}:r)),block:xc,switch:mc,conveyor:sc,lift:A(({renderContext:{general:{paused:r}}})=>{const e=new w,t={x:fr.w/2,y:fr.h};return e.addChild(x({animationId:"lift",pivot:t,paused:r})),e.addChild(x({textureId:"lift.static",pivot:t})),e}),teleporter:ic,sceneryCrown:A(({renderContext:{item:{config:{planet:r}}}})=>x({textureId:`crown.${r}`})),pickup:A(({renderContext:{item:{config:r},room:e,general:{paused:t}}})=>{if(r.gives==="crown")return x({textureId:`crown.${r.planet}`});const o={shield:"whiteRabbit",jumps:"whiteRabbit",fast:"whiteRabbit","extra-life":"whiteRabbit",bag:"bag",doughnuts:"doughnuts",hooter:"hooter",scroll:{textureId:"scroll",filter:G(e)},reincarnation:{animationId:"fish",paused:t}}[r.gives];return x(o)}),moveableDeadly:Z("fish.1"),charles:ac,joystick:Z("joystick"),movingPlatform:Z("sandwich"),pushableBlock:Z("stepStool"),portableBlock:A(({renderContext:{item:{config:{style:r}}}})=>x(r)),spring:lc,sceneryPlayer:uc,hushPuppy:Z("hushPuppy"),bubbles:A(({renderContext:{item:{config:{style:r}},general:{paused:e}}})=>x({animationId:`bubbles.${r}`,paused:e})),firedDoughnut:Z({animationId:"bubbles.doughnut"}),ball:Z("ball"),floor:Ha,particle:A(({renderContext:{item:{config:{forCharacter:r}}}})=>x({animationId:"particle.fade",anchor:{x:.5,y:.5},filter:r==="heels"?vo:Q}))},Cc=r=>{if(r.type==="wall"){const{direction:e}=r.config;return e==="right"||e==="towards"?void 0:fc}return r.type==="deadlyBlock"&&r.config.style==="toaster"?wc:bc[r.type]},Ic=()=>W.moss;class Tc{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output)}output=new w({label:"PortableItemPickUpNextHighlightRenderer"});#e=!1;tick(e){const{wouldPickUpNext:t}=this.renderContext.item.state;t!==!this.#e&&(this.output.filters=t?[Ic()]:Q),this.#e=t,this.childRenderer.tick(e)}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const kc=(r,e,t)=>ws(r)?new Tc(e,t):t,Sc=g.pastelBlue,nn=W.highlightBeige,on=W.midRed,Rc=W.white,sn=new B(Sc),an={left:"↖",away:"↗",right:"↘",towards:"↙"},cn=(r,e)=>{switch(r){case"back-forth":switch(e){case"left":return"↖↘";case"right":return"↘↖";case"away":return"↗↙";case"towards":return"↙↗";default:throw new Error("Unexpected startDirection")}case"clockwise":switch(e){case"left":return"↖↗↘↙";case"right":return"↘↙↖↘";case"away":return"↗↘↙↖";case"towards":return"↙↖↗↘";default:throw new Error("Unexpected startDirection")}case"towards-analogue":return"➡.⬅"}return""};class _c{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output),this.#e()}output=new w({label:"EditorAnnotationsRenderer"});#e(){const e=this.renderContext.item;switch(e.type){case"pickup":if(e.config.gives==="shield"||e.config.gives==="extra-life"||e.config.gives==="jumps"||e.config.gives==="fast"){const t={shield:"🛡",jumps:"♨",fast:"⚡","extra-life":"+2"};this.#t({annotationText:t[e.config.gives],yAdj:-16})}break;case"doorFrame":if(e.config.part==="near"){const{rooms:t}=C.getState().levelEditor.campaignInProgress,{config:{toRoom:n,direction:o}}=e,s=!!t[n],a=n.toUpperCase(),i=an[o],c=o==="away"||o==="right"?`${a}${i}`:`${i}${a}`;this.#t({annotationText:c,yAdj:o==="left"||o==="away"?-48:0,error:!s,clickDispatch:s?()=>Bt(n):void 0})}break;case"teleporter":{const{rooms:t}=C.getState().levelEditor.campaignInProgress,{config:{toRoom:n}}=e,o=!!t[n];this.#t({annotationText:`➡${n.toUpperCase()}`,yAdj:-12,error:!o,clickDispatch:o?()=>Bt(n):void 0})}break;case"conveyor":{const{config:{direction:t}}=e,n=an[t];this.#t({annotationText:n,yAdj:-12})}break;case"movingPlatform":{const{config:{movement:t,startDirection:n}}=e;this.#t({annotationText:cn(t,n),yAdj:-12})}break;case"monster":{const{config:t}=e;(t.which==="turtle"||t.which==="skiHead")&&this.#t({annotationText:cn(t.movement,t.startDirection),yAdj:-12})}break}}#t({annotationText:e,yAdj:t=0,error:n=!1,clickDispatch:o}){const{renderContext:{frontLayer:s}}=this,a=new B(n?g.midRed:g.white),i=wo(new w({label:"EditorAnnotationTextContainer",filters:[a,W.pureBlack]}),e);i.y=t,o!==void 0&&(i.eventMode="static",i.on("click",()=>{C.dispatch(o())}),i.on("mouseover",()=>{C.getState().levelEditor.tool.type==="pointer"&&(C.dispatch(xr(!0)),a.targetColor=g.pastelBlue)}),i.on("mouseout",()=>{C.dispatch(xr(!1)),a.targetColor=g.white}),i.cursor="pointer"),this.output.addChild(i),s.attach(i)}tick(e){this.#r(),this.childRenderer.tick(e)}#r(){const{renderContext:{item:e,room:t}}=this,{clickableAnnotationHovered:n}=C.getState().levelEditor,{jsonItemId:o}=e,s=C.getState(),a=An(s),i=bs(s),c=Ie(s),l=o&&a?.jsonItemId===o&&!n,u=o&&i.includes(o),p=()=>o!==void 0&&(Y(t.items).some(d=>d.jsonItemId===a?.jsonItemId&&d.type==="switch"&&d.config.type==="in-room"&&d.config.modifies.some(h=>h.targets.includes(o)))||e.type==="switch"&&Y(t.items).some(({jsonItemId:d})=>d!==void 0&&d===a?.jsonItemId&&e.config.type==="in-room"&&e.config.modifies.some(h=>h.targets.includes(d)))||e.type==="charles"&&Y(t.items).some(d=>d.jsonItemId===a?.jsonItemId&&d.type==="joystick"&&d.config.controls.some(h=>h===o))||e.type==="joystick"&&e.config.controls.some(d=>a?.jsonItemId===d));this.output.filters=l&&u?[sn,c.type==="eyeDropper"?on:nn]:l?c.type==="eyeDropper"?on:nn:u?sn:p()?Rc:Q}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const Pc=(r,e,t)=>e.general.editor?new _c(e,t):t,Mc=(r,e)=>{e!==void 0&&C.getState().gameMenus.cheatsOn&&(e.eventMode="static",e.on("pointertap",()=>{C.dispatch(Qo({item:r,pixiContainer:e}))}))},Ac=r=>{const e=C.getState(),t=Jo(e),n=!Ko(e),{item:o}=r,s=t==="all"||t==="non-wall"&&r.item.type!=="wall",a=[],i=Cc(o);let c;if(i!==void 0){c=new uo(r,i);const h=new ka(r,c);a.push(Pc(o,r,kc(o,r,h)))}if(n){const h=Ui(r);h!==void 0&&a.push(h)}s&&a.push(new ki(r));let l;if(a.length===0)l=void 0;else{const h=a.length===1?a[0]:new Oc(a,r);l=new Pi(r,h),Mc(o,l.output)}const u=r.general.soundSettings.mute??er.soundSettings.mute,p=r.general.paused||u?void 0:oa(r),d=p===void 0?void 0:new aa(r,p);return{top:new Di(r,{graphics:l,sound:d}),itemAppearanceRenderer:c}};class Oc{constructor(e,t){this.renderContext=t,this.#e=e,this.#t.addChild(...e.map(n=>n.output))}#e;#t=new w({label:"CompositeRenderer"});tick(e){for(const t of this.#e)t.tick(e)}destroy(){for(const e of this.#e)e.destroy()}get output(){return this.#t}}const zc=Ae("wall","doorFrame"),ln=256;function*Fc(r){const{left:e,right:t}=Y(r.items).filter(zc).reduce((n,{aabb:o,renderAabb:s,renderAabbOffset:a,state:{position:i}})=>{const c=s??o,l=P(i,a??Me),u=v(P(l,{x:c.x})).x,p=v(P(l,{y:c.y})).x;return{left:Math.min(n.left,u),right:Math.max(n.right,p)}},{left:Number.POSITIVE_INFINITY,right:Number.NEGATIVE_INFINITY});e!==Number.POSITIVE_INFINITY&&(yield new j().rect(e-100,-256,100,ln).fill(0)),t!==Number.NEGATIVE_INFINITY&&(yield new j().rect(t,-256,100,ln).fill(0))}class Bc{constructor(e){this.renderContext=e;const{general:{colourised:t,soundSettings:n},room:o}=e;this.initFilters(t,e.room.color);const a=n.mute??er.soundSettings.mute?void 0:T.createGain();at(Fc(o),this.#o),this.output={sound:a,graphics:new w({label:`RoomRenderer(${e.room.id})`})},this.output.graphics.addChild(this.#t),t||(this.#r=new Pr({sortableChildren:!1}),this.output.graphics.addChild(this.#r)),this.output.graphics.addChild(this.#o),this.output.graphics.addChild(this.#n)}#e=!1;#t=new w({label:"items"});#r;#n=new Pr({sortableChildren:!1});#o=new w({label:"occlusion"});output;#s=void 0;#a=new Map;#i=new Map;initFilters(e,t){this.#t.filters=e?t.shade==="dimmed"?ba:Q:new B(t.shade==="dimmed"?Dn(qe(t).main.original):qe(t).main.original)}#l=e=>this.#i.get(e);#c(e,t){let n=this.#i.get(t.id);if(n===void 0){n=Ac({...this.renderContext,colourClashLayer:this.#r,frontLayer:this.#n,item:t,zEdges:this.#a,getItemRenderPipeline:this.#l}),this.#i.set(t.id,n);const{graphics:o,sound:s}=n.top.output;if(o&&(this.#t.addChild(o),t.fixedZIndex&&(o.zIndex=t.fixedZIndex)),s){if(!this.output.sound)throw new Error("item renderer has sound, but room renderer does not - this probably means that they disagree on if the user has sound muted");s.connect(this.output.sound)}}try{n.top.tick(e)}catch(o){throw new Error(`RoomRenderer: error while ticking item "${t.id}"
in room "${this.renderContext.room.id}"
item in play object is:
           
${JSON.stringify(t,null,2)}`,{cause:o})}}#d(e){const{room:t}=this.renderContext,n={...e,lastRenderRoomTime:this.#s},o=new Set,s=i=>{if(o.has(i))return;const c=this.#a.get(i);if(c)for(const[l,u]of c.entries())u&&s(l);this.#c(n,t.items[i]),o.add(i)};for(const i in t.items)s(i);let a=!1;for(const[i,c]of this.#i.entries())t.items[i]===void 0&&(c.top.destroy(),this.#i.delete(i),a=!0);a&&this.#h()}#h(){if(this.#r)for(const e of this.#r.renderLayerChildren)e.parent===null&&this.#r.detach(e);for(const e of this.#n.renderLayerChildren)e.parent===null&&this.#n.detach(e)}#p(e){for(let t=0;t<e.length;t++){const n=this.#i.get(e[t]);if(n===void 0)throw new Error(`Item id=${e[t]} does not have a renderer - cannot assign a z-index`);const o=n.top.output.graphics;if(!o)throw new Error(`order ${e[t]} was given a z-order by sorting, but item has no graphics`);o.zIndex=t}}get#u(){return this.#s!==void 0}tick(e){const t=this.#u?e:{...e,movedItems:new Set(Y(this.renderContext.room.items))};co(this.renderContext.room.items,t.movedItems,this.#a);const n=lo(this.#a);this.#d(t),(!this.#u||t.movedItems.size>0)&&this.#p(n),this.#s=this.renderContext.room.roomTime}destroy(){this.output.graphics.label=this.output.graphics.label+"DESTROYED",this.output.graphics.destroy({children:!0}),this.output.sound?.disconnect(),this.#i.forEach(e=>{e.top.destroy()}),this.#e=!0}get destroyed(){return this.#e}}const Ec=r=>{r.ticker.remove(r.render,r)},bo=S.createContext(null),$c=({children:r})=>{const[e,t]=S.useState(null);return S.useEffect(()=>{const n=new Kn;return n.init({background:g.pureBlack,sharedTicker:!0}).then(()=>{Ec(n),t(n)}),()=>{}},[]),e===null?null:z.jsx(bo,{value:e,children:r})},ie=()=>S.useContext(bo),Lc=(r,e)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:e},soundSettings:{mute:!0},pixiRenderer:r,gameState:void 0,paused:!1,colourised:!0,upscale:nr(C.getState()),editor:!0}),un=(r,e,t)=>new Bc({room:r,general:Lc(e,t)}),Uc=()=>{const{renderer:r}=ie(),e=es();if(!r)throw new Error("this should never be falsey (typescript violation)");const t=On(),[n,o]=S.useState(()=>un(t,r,e));return S.useEffect(()=>{const s=un(t,r,e);return o(s),()=>{s.destroy()}},[t,r,e]),n},Dc={z:1,x:0,y:0},jc={z:0,x:0,y:-1},dn={z:0,x:-1,y:0},Gc=(r,{x:e,y:t},n)=>{if(n.type==="item"&&n.item.type==="door"&&r.type==="wall"){const c=r.config.direction;return In(Cs[c],-1)}const{bottomCentre:o,topLeft:s,topRight:a}=me(r.state.position,r.aabb);return t<s.y-(s.x-e)/2?t<a.y-(e-a.x)/2?Dc:dn:e<o.x?jc:dn},Hc=3,Nc=(r,{x:e,y:t},n)=>{const o=me(r.state.position,r.aabb);return ts.find(s=>{const a=o.projectCorner(s);return rr(te(a,{x:e,y:t}))<Hc})},ce=3,St=1.5;function H({x:r,y:e},t,n){const o={x:r-t.x,y:e-t.y},s=o.x*n.y-o.y*n.x;return Math.abs(s)/rs(Math.hypot(n.x,n.y))}const Co={point:{x:-1,y:-1,z:0},normal:{x:0,y:0,z:1}},Io={point:{x:-1,y:0,z:1},normal:{x:0,y:1,z:0}},To={point:{x:0,y:-1,z:1},normal:{x:1,y:0,z:0}},ko={point:{x:0,y:1,z:1},normal:{x:1,y:0,z:0}},So={point:{x:1,y:0,z:1},normal:{x:0,y:1,z:0}},Ro={point:{x:1,y:-1,z:0},normal:{x:0,y:0,z:1}},_o={point:{x:0,y:-1,z:-1},normal:{x:1,y:0,z:0}},Po={point:{x:-1,y:1,z:0},normal:{x:0,y:0,z:1}},Mo={point:{x:-1,y:0,z:-1},normal:{x:0,y:1,z:0}},Vc=(r,e,t,n)=>{const o=me(r.state.position,r.aabb),s=t.x<0,a=t.y<0,i=t.z>0;if((s||a)&&H(e,o.bottomCentre,{x:0,y:-1})<St)return Co;if((s||i)&&H(e,o.topRight,{x:2,y:-1})<St)return Io;if((a||i)&&H(e,o.topLeft,{x:2,y:1})<St)return To;switch(!0){case i:{const c=o.c111;if(H(e,c,{x:2,y:1})<ce)return ko;if(H(e,c,{x:-2,y:1})<ce)return So;break}case a:{const c=o.c100;if(H(e,c,{x:0,y:-1})<ce)return Ro;if(H(e,c,{x:2,y:1})<ce)return _o;break}case s:{const c=o.c010;if(H(e,c,{x:0,y:-1})<ce)return Po;if(H(e,c,{x:-2,y:1})<ce)return Mo;break}}},hn=(r,e,t)=>t?{position:r.state.position,aabb:r.aabb}:{position:P(r.state.position,r.renderAabbOffset??Me),aabb:r.renderAabb??r.aabb},pn=({x:r,y:e},t,n)=>{const{bottomCentre:o,topLeft:s,topRight:a}=me(t,n);return!(r<s.x||r>a.x||e<a.y-(a.x-r)/2||e<s.y-(r-s.x)/2||e>o.y-(r-o.x)/2||e>o.y-(o.x-r)/2)},Wc=(r,e,t)=>{const{position:n,aabb:o}=hn(t,e,!1);if(pn(r,n,o))return"intersects-rendered";if(e.type==="item"&&t.type==="wall"){const{position:a,aabb:i}=hn(t,e,!0);if(pn(r,a,i))return"intersects-unrendered"}return"non-intersecting"},fn=r=>r.fixedZIndex!==void 0,Xc=r=>{const t=r.some(([,i])=>i==="intersects-rendered")?r.filter(([,i])=>i==="intersects-rendered").map(([i])=>i):r.map(([i])=>i);if(t.every(fn))return t.toSorted((i,c)=>c.fixedZIndex-i.fixedZIndex).at(0);const n=t.filter(i=>!fn(i));if(n.length===0)return;if(n.length===1)return n[0];const o=Object.fromEntries(n.map(i=>[i.id,i])),s=co(o),a=lo(s);return o[a.at(-1)]},Ao=(r,e,t,n)=>{const o=t.type==="item"&&t.item.type==="door"?1:n,s=M.w*o,a=M.h,i=o===1?0:M.w/2,c=a/2,l=ns(e);return{x:l==="yz"?Math.round(r.x/s)*s:Math.floor((r.x-i)/s)*s,y:l==="xz"?Math.round(r.y/s)*s:Math.floor((r.y-i)/s)*s,z:l==="xy"?Math.round(r.z/a)*a:Math.floor((r.z+c)/a)*a}},Zc=({state:{position:r},aabb:e},t,n,o,s)=>{const a={x:r.x+(t.x<0?0:e.x),y:r.y+(t.y<0?0:e.y),z:r.z+(t.z<0?0:e.z)},i=Ts(a,t,n);return Ao(i,t,o,s)},qc=r=>e=>{const t=Is(e);return r.type==="item"&&r.item.type==="door"?t&&e.type==="wall":t},Rt=(r,e,t,n)=>{const o=Y(e.items).filter(qc(t)).map(i=>[i,Wc(r,t,i)]).filter(i=>i[1]!=="non-intersecting"),s=Xc(Array.from(o)),a=e.id;if(s){const i=Gc(s,r,t);if(!(i.z>0&&!Object.isExtensible(s.state.stoodOnBy)))return{roomId:a,scrXy:r,world:{itemId:s.id,onItem:{face:i,corner:Nc(s,r),edge:Vc(s,r,i)},position:Zc(s,i,r,t,n)}}}return{roomId:a,scrXy:r,world:void 0}},Yc=(r,e=console.error)=>(...t)=>{try{return r(...t)}catch(n){e(n);return}},xe=40,Ze=(r,e,t)=>{const n=r.cssUpscale*r.gameEngineUpscale;if(t.target===null)throw new Error("Mouse event target is null");const o=t.target.getBoundingClientRect(),s=t.clientX-o.left,a=t.clientY-o.top;return{x:s/n+e.l-xe,y:a/n+e.t-xe}},Jc=(r,e)=>{const t=r.cssUpscale*r.gameEngineUpscale;if(e.target===null)throw new Error("Mouse event target is null");const n=e.movementX,o=e.movementY;return{x:n/t,y:o/t}},mn=(r,e,t)=>{const{world:{onItem:{face:n},position:o,itemId:s}}=r;if(n.z>os)return We(o);if(t.type==="door"){const a=e.items[s];if(a.type!=="wall")return;const{config:i,aabb:c,state:{position:l}}=a,u=ks(Mn(i)),p=nt(ne(i.direction)),d=ne(i.direction);if(u[p]<2)return;const h=l[p],f=l[p]+c[p]-Ss,m=l.z,y=l.z+c.z-Rs,b={[p]:Math.max(Math.min(o[p],f),h),[d]:o[d],z:Math.max(Math.min(o.z,y),m)};return We(b)}return P(We(o),n)},Ke=({levelEditor:r},e,t)=>{const n=e.items[t]?.jsonItemId;if(n===void 0)return;const o=zn(r,n);if(o!==void 0)return[n,o]},{dispatch:be}=C;class Kc{handleMouseMove({pointingAtChanged:e,roomState:t,pointingAt:n,tool:o,storeState:s}){if(!e||(be(Et()),n.world===void 0))return;const a=Ke(s,t,n.world.itemId);if(a===void 0)return;const[,i]=a,c=mn(n,t,o.item);if(c===void 0)return;const{item:l}=o,u=l.type==="door"?ss(l,d=>{const h=t.items[n.world.itemId];d.config.direction=h.config.direction}):o.item;Hs({roomState:t,blockPosition:c,itemTool:u})||be(yr({blockPosition:c,pointedAtItemJson:i,preview:!0}))}handleMouseUp({roomState:e,pointingAt:t,tool:n,storeState:o,isClick:s}){if(!s)return;if(t.world===void 0){be(ar({type:"pointer"}));return}const a=Ke(o,e,t.world.itemId);if(a===void 0)return;const[,i]=a,c=mn(t,e,n.item);c!==void 0&&be(yr({blockPosition:c,pointedAtItemJson:i,preview:!1}))}handleMouseDown(e){}handleMouseLeave(e){be(Et())}}const Qc=r=>Bn(e=>e>0?e:e>-1?1:-e+1,r),el=({jsonItem:r,blockDragAccVec:e,resizeEdgeDirection:t})=>{const n=r.position,o=_s(r),s=Ft(e,t,Fn(r)),a=P(o,s),i=Qc(a),c=Bn((l,u,p,d,h)=>{const f=u<1;return l<0!==f?f?p-h+1:p+d-h:f?p+d-1:p},t,a,n,o,i);return{timesDelta:zt(i,o),positionDelta:zt(c,n)}},Qe=(r,...e)=>r.levelEditor.wallsFloorsLocked&&e.some(t=>t.type==="wall"||t.type==="floor"),Xt=(r,e)=>{const t=C.getState();let n;if(e.world){const o=e.world.itemId,s=o&&r.items[o],a=Qe(t,s)?void 0:s.jsonItemId;n=a===void 0?void 0:{jsonItemId:a,pointingAtOnItem:e.world.onItem}}else n=void 0;U(An(t),n)||C.dispatch(En(n))},tl=5,{dispatch:Ce}=C,rl=(r,e,t)=>{const n=t?.world?.itemId;if(n===void 0)return Ot;const o=e.items[n].jsonItemId;if(o===void 0)return Ot;const{selectedJsonItemIds:s}=r.levelEditor;return s.includes(o)?s:[o]},nl=(r,e,t)=>{const n=r.world?.onItem.edge,o=Ft(...tt(t).map(a=>Fn(a))),s=Ft(n?.point??Me,o);return Yt(s)>0?n.normal:e?{x:1,y:0,z:0}:{x:0,y:0,z:1}},ol=(r,e,t,n,o,s)=>{if(r===void 0)return;const a=te(e,r.scrXy),i=rr(a);if(!(o||i>tl))return;const l=nl(r,n,s),u=Fs(l,t);return n?{x:0,y:0,z:u.z}:u},gn=(r,e=!1)=>{const t=C.getState().levelEditor;return Ao(r,{x:0,y:0,z:1},t.tool,e?1:t.gridResolution)};class sl{handleMouseMove({roomState:e,pointingAt:t,storeState:n,mouseDownPointingAtRef:o,mouseEvent:s,upscale:a,dragAccVec:i,roomRenderSize:c}){const l=Jc(a,s),u=rl(n,e,o.current);if(u.length===0){Xt(e,t);return}const p=u.map(D=>Ps(n,D));if(Qe(n,...p))return;const h=t.roomId===o.current?.roomId?ol(o.current,Ze(a,c,s),l,s.metaKey||s.shiftKey,i.current!==void 0,p):void 0;if(!h){Xt(e,t);return}u.length===1&&!Ms(n,u[0])&&C.dispatch(ut({jsonItemIds:u}));const f=o.current?.world?.onItem.edge,m=f&&p.every(D=>$n(D)),y=i.current??Me,b=P(y,h),I=gn(b,m);if(i.current=b,Qt(gn(y,m),I))return;const k=We(I);let R,L;if(m){const[,D]=Ke(n,e,o.current.world.itemId);({timesDelta:L,positionDelta:R}=el({jsonItem:D,blockDragAccVec:k,resizeEdgeDirection:f.point}))}else R=k;Ns({roomState:e,jsonItemIds:u,blockPositionDelta:R,timesDelta:L})||Ce(As({jsonItemIds:u,positionDelta:R,timesDelta:L}))}handleMouseUp({roomState:e,pointingAt:t,storeState:n,mouseEvent:o,isClick:s,isDragEnd:a}){if(s){const i=t.world===void 0?void 0:e.items[t.world.itemId];if(i?.jsonItemId===void 0||Qe(n,i)){Ce(ut({jsonItemIds:[]}));return}Ce(o.ctrlKey||o.metaKey?Os({jsonItemId:i.jsonItemId}):ut({jsonItemIds:[i.jsonItemId]}))}else a&&Ce(zs())}handleMouseDown(e){}handleMouseLeave(e){Ce(En(void 0))}}const{dispatch:il}=C;class al{handleMouseMove({roomState:e,pointingAt:t}){Xt(e,t)}handleMouseUp({roomState:e,pointingAt:t,storeState:n,isClick:o}){if(!o)return;const s=t.world?.itemId;if(s===void 0){console.warn("no itemId");return}const a=e.items[s];if(Qe(n,a))return;const i=Ke(n,e,s);if(i===void 0)return;const[,c]=i;il(ar({type:"item",item:{type:c.type,config:c.config}}))}handleMouseDown(e){}handleMouseLeave(e){}}const Ne={item:new Kc,pointer:new sl,eyeDropper:new al},cl=r=>{const e=ie(),t=ot(nr),n=kn(),o=S.useRef(void 0),s=S.useRef(void 0),a=S.useRef(void 0);S.useEffect(()=>{if(r===null)return;const i=d=>{const h=C.getState(),f=$e(h),m=dt(h),y=Ze(t,m,d),b=Ie(h),I=Rt(y,f,b,h.levelEditor.gridResolution),k=!U(I.world,o.current?.world);Ne[b.type].handleMouseMove({pointingAtChanged:k,roomState:f,pointingAt:I,tool:b,storeState:h,mouseDownPointingAtRef:s,mouseEvent:d,upscale:t,dragAccVec:a,roomRenderSize:m}),o.current=I},c=d=>{const h=C.getState(),f=$e(h);if(f.id!==h.levelEditor.currentlyEditingRoomId)return;const m=dt(h),y=Ze(t,m,d),b=Ie(C.getState()),I=Rt(y,f,b,h.levelEditor.gridResolution),k=a.current!==void 0,R=!k&&I.roomId===s.current?.roomId&&I.world?.itemId===s.current?.world?.itemId,L=s.current;if(a.current=void 0,s.current=void 0,C.dispatch(Bs(!1)),!R&&!k){console.log("mouseUp - not a click or drag end - skipping");return}Ne[b.type].handleMouseUp({roomState:f,pointingAt:I,tool:b,storeState:h,mouseDownPointingAt:L,mouseEvent:d,upscale:t,isClick:R,isDragEnd:k})},l=d=>{const h=C.getState(),f=$e(h),m=Ie(h);a.current=void 0,s.current=void 0,Ne[m.type].handleMouseLeave({roomState:f,tool:m,storeState:h,mouseEvent:d})},u=d=>{const h=C.getState(),f=$e(h),m=dt(h),y=Ze(t,m,d),b=Ie(h),I=Rt(y,f,b,h.levelEditor.gridResolution);console.log("setting mouseDownPointingAtRef to",I),s.current=I,Ne[b.type].handleMouseDown({roomState:f,pointingAt:I,tool:b,storeState:h,mouseEvent:d,upscale:t})},p=Yc(i);return r.addEventListener("mousemove",p),r.addEventListener("mouseup",c),r.addEventListener("mousedown",u),r.addEventListener("mouseleave",l),r.tabIndex=0,()=>{r.removeEventListener("mousemove",p),r.removeEventListener("mouseup",c),r.removeEventListener("mousedown",u),r.removeEventListener("mouseleave",l)}},[e.stage,t,r,n])},ll=()=>{const{cssUpscale:r,canvasSize:e,rotate90:t}=ot(nr);return t?`scale(${r}) rotate(90deg) translate(0, -${e.y}px)`:`scale(${r})`},ul=r=>{const e=On(),t=ie();S.useEffect(()=>{let n=0;const o=({deltaMS:s})=>{if(r.destroyed)return;r.renderContext.room!==e&&console.warn("room renderer does not have the current room");const a=new Set(Mt(e.items));e.roomTime+=s,r.tick({deltaMS:s,movedItems:a,progression:n++}),t.render()};return le.shared.add(o),()=>{le.shared.remove(o)}},[r,e,t])},dl=r=>{const e=ie();S.useEffect(()=>{if(r)return r.appendChild(e.canvas),()=>{r.removeChild(e.canvas)}},[r,e])},hl=()=>{const r=ie(),e=ot(t=>t.upscale.upscale.gameEngineUpscale);r.stage.scale=e},pl=()=>{const r=ie(),e=Ln(),t=ot(n=>n.upscale.upscale);S.useEffect(()=>{const n=(2*xe+e.w)*t.gameEngineUpscale,o=(2*xe+e.h)*t.gameEngineUpscale;r.renderer?.resize(n,o)},[r.renderer,e,t])},fl=r=>{const e=ie(),[t]=S.useState(()=>new w({label:"editorPositioner"})),n=Ln();S.useEffect(()=>{if(r.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return t.addChild(r.output.graphics),e.stage.addChild(t),()=>{e.stage.removeChild(t),t.removeChild(r.output.graphics)}},[r,e,t]),S.useEffect(()=>{t.x=-n.l+xe,t.y=-n.t+xe},[t,n])},xn=(r,e)=>{C.dispatch(is(as(r??cs(C.getState()),e)))},ml=(r,e)=>{const t=kn();S.useLayoutEffect(()=>{xn()},[]),S.useLayoutEffect(()=>{const n=()=>xn(r,e);if(e){const o=new ResizeObserver(n);return o.observe(e),()=>o.disconnect()}else return window.addEventListener("resize",n),()=>window.removeEventListener("resize",n)},[t,e,r])},gl=()=>{S.useEffect(()=>Sn({actionCreator:ar,effect(r,{dispatch:e}){e(Et())}}))},xl=(r,e)=>{const t=S.useCallback(()=>{if(r===null)return;const n=Math.max(0,(r.scrollWidth-r.clientWidth)/2),o=Math.max(0,(r.scrollHeight-r.clientHeight)/2);r.scrollTo(n,o)},[r]);S.useEffect(()=>{if(r!==null)return Sn({actionCreator:Bt,effect(){setTimeout(t,0)}})},[t,r]),S.useEffect(()=>{if(r===null||e===null)return;if(e.querySelector("canvas"))setTimeout(t,0);else{const o=new MutationObserver(()=>{e.querySelector("canvas")&&(t(),o.disconnect())});return o.observe(e,{childList:!0,subtree:!0}),()=>o.disconnect()}},[r,e,t])},yl={amigaHiResPal:"Amiga Hi-Res PAL",classicMac:"Classic Mac",amigaLowResPal:"Amiga Low-Res PAL",zxSpectrum:"ZX Spectrum",handheld:"Handheld"},vl=({selectedResolution:r,onResolutionChange:e})=>{const t=Ee.indexOf(r),n=t<Ee.length-1,o=t>0,{justDone:s,doneNow:a}=Vs();return z.jsxs("div",{className:"absolute top-0 right-0 z-popups flex gap-0 leading-none text-white",children:[s>0&&z.jsx(ht,{className:"px-1 bg-moss items-center flex",children:yl[r]}),z.jsx(wr,{small:!0,disabled:!o,tooltipContent:`##zoom ⬇

makes things look *smaller* by *increasing* emulated resolution`,onClick:()=>{o&&(e(Ee[t-1]),a())},shortcutKeys:["-"],children:z.jsx(ht,{children:"-"})}),z.jsx(wr,{small:!0,disabled:!n,tooltipContent:`##zoom ⬆

makes things look *bigger* by *decreasing* emulated resolution`,onClick:()=>{n&&(e(Ee[t+1]),a())},shortcutKeys:["⇧+","="],children:z.jsx(ht,{children:"+"})})]})},wl=({levelEditor:r})=>{const{dragInProgress:e,clickableAnnotationHovered:t,hoveredItem:n,selectedJsonItemIds:o}=r;if(e)return E("cursor-grabbing");if(t)return E("cursor-pointer");if(n){const s=zn(r,n.jsonItemId);if(s!==void 0&&$n(s))if(n.pointingAtOnItem.corner){if(Qt(n.pointingAtOnItem.corner,{x:1,y:1,z:1}))return E("cursor-n-resize")}else{const{edge:a}=n.pointingAtOnItem;if(a){if(U(a,Po))return E("cursor-e-resize");if(U(a,Co))return E("cursor-s-resize");if(U(a,Ro))return E("cursor-w-resize");if(U(a,Io)||U(a,ko))return E("cursor-ne-resize");if(U(a,To)||U(a,So))return E("cursor-nw-resize");if(U(a,Mo))return E("cursor-se-resize");if(U(a,_o))return E("cursor-sw-resize")}}return o.includes(n.jsonItemId)?E("cursor-grab"):E("cursor-default")}return E("cursor-crosshair")},bl=()=>Es(wl);ls.defaultOptions.scaleMode="nearest";const Cl=()=>{const r=Uc(),[e,t]=S.useState(null),[n,o]=S.useState(null),[s,a]=S.useState("amigaLowResPal"),i=bl();return ml(s,n??void 0),pl(),fl(r),ul(r),cl(e),dl(e),hl(),gl(),xl(n,e),z.jsxs("div",{className:`w-full h-full ${i} relative scale-editor`,children:[z.jsx(vl,{selectedResolution:s,onResolutionChange:a}),z.jsx("div",{className:`w-full h-full bg-editor-checkerboard overflow-scroll flex scrollbar scrollbar-w-1 scrollbar-track-pureBlack scrollbar-thumb-metallicBlue ${i}`,ref:o,children:z.jsx("div",{className:"flex justify-center items-center w-[500dvw] h-[500dvh]",children:z.jsx("div",{style:{transform:ll(),transformOrigin:"center center"},ref:t})})})]})},Il=()=>z.jsx($c,{children:z.jsx(Cl,{})}),_l=Object.freeze(Object.defineProperty({__proto__:null,default:Il},Symbol.toStringTag,{value:"Module"}));export{Zn as A,Vn as C,J as F,st as R,ei as S,qn as V,si as a,_l as b,Qs as u};
