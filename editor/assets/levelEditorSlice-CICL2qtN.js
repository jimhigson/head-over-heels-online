import{a5 as G,a6 as ke,a7 as ce,a8 as fo,a9 as A,aa as ue,ab as h,ac as Dt,ad as yo,ae as po,af as lt,ag as Je,ah as C,ai as K,aj as ie,ak as qt,al as Ge,am as mo,an as Ve,ao as go,ap as te,aq as ho,ar as D,as as Ee,at as Ue,au as ee,av as Me,aw as oe,ax as bo,ay as xo,az as Ze,aA as Ke,aB as L,aC as Qe,aD as vo,aE as wo,aF as Io,aG as Ro,aH as zo,aI as ko,aJ as Eo,aK as Ao,aL as To,aM as Po,aN as So}from"./index-CfogeVcu.js";function Oo(e,t=`expected a function, instead received ${typeof e}`){if(typeof e!="function")throw new TypeError(t)}function Co(e,t=`expected an object, instead received ${typeof e}`){if(typeof e!="object")throw new TypeError(t)}function Fo(e,t="expected all items to be functions, instead received the following types: "){if(!e.every(o=>typeof o=="function")){const o=e.map(r=>typeof r=="function"?`function ${r.name||"unnamed"}()`:typeof r).join(", ");throw new TypeError(`${t}[${o}]`)}}var dt=e=>Array.isArray(e)?e:[e];function No(e){const t=Array.isArray(e[0])?e[0]:e;return Fo(t,"createSelector expects all input-selectors to be functions, but received the following types: "),t}function $o(e,t){const o=[],{length:r}=e;for(let n=0;n<r;n++)o.push(e[n].apply(null,t));return o}var Wo=class{constructor(e){this.value=e}deref(){return this.value}},Bo=typeof WeakRef<"u"?WeakRef:Wo,Mo=0,ut=1;function fe(){return{s:Mo,v:void 0,o:null,p:null}}function Lt(e,t={}){let o=fe();const{resultEqualityCheck:r}=t;let n,i=0;function c(){let a=o;const{length:u}=arguments;for(let d=0,l=u;d<l;d++){const p=arguments[d];if(typeof p=="function"||typeof p=="object"&&p!==null){let y=a.o;y===null&&(a.o=y=new WeakMap);const m=y.get(p);m===void 0?(a=fe(),y.set(p,a)):a=m}else{let y=a.p;y===null&&(a.p=y=new Map);const m=y.get(p);m===void 0?(a=fe(),y.set(p,a)):a=m}}const s=a;let f;if(a.s===ut)f=a.v;else if(f=e.apply(null,arguments),i++,r){const d=n?.deref?.()??n;d!=null&&r(d,f)&&(f=d,i!==0&&i--),n=typeof f=="object"&&f!==null||typeof f=="function"?new Bo(f):f}return s.s=ut,s.v=f,f}return c.clearCache=()=>{o=fe(),c.resetResultsCount()},c.resultsCount=()=>i,c.resetResultsCount=()=>{i=0},c}function _o(e,...t){const o=typeof e=="function"?{memoize:e,memoizeOptions:t}:e,r=(...n)=>{let i=0,c=0,a,u={},s=n.pop();typeof s=="object"&&(u=s,s=n.pop()),Oo(s,`createSelector expects an output function after the inputs, but received: [${typeof s}]`);const f={...o,...u},{memoize:d,memoizeOptions:l=[],argsMemoize:p=Lt,argsMemoizeOptions:y=[]}=f,m=dt(l),g=dt(y),x=No(n),b=d(function(){return i++,s.apply(null,arguments)},...m),k=p(function(){c++;const I=$o(x,arguments);return a=b.apply(null,I),a},...g);return Object.assign(k,{resultFunc:s,memoizedResultFunc:b,dependencies:x,dependencyRecomputations:()=>c,resetDependencyRecomputations:()=>{c=0},lastResult:()=>a,recomputations:()=>i,resetRecomputations:()=>{i=0},memoize:d,argsMemoize:p})};return Object.assign(r,{withTypes:()=>r}),r}var le=_o(Lt),Ho=Object.assign((e,t=le)=>{Co(e,`createStructuredSelector expects first argument to be an object where each property is a selector, instead received a ${typeof e}`);const o=Object.keys(e),r=o.map(i=>e[i]);return t(r,(...i)=>i.reduce((c,a,u)=>(c[o[u]]=a,c),{}))},{withTypes:()=>Ho}),ye={},pe={},ft;function Xo(){if(ft)return pe;ft=1;function e(a,u){var s;if(typeof Symbol>"u"||a[Symbol.iterator]==null){if(Array.isArray(a)||(s=t(a))||u){s&&(a=s);var f=0,d=function(){};return{s:d,n:function(){return f>=a.length?{done:!0}:{done:!1,value:a[f++]}},e:function(g){throw g},f:d}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var l=!0,p=!1,y;return{s:function(){s=a[Symbol.iterator]()},n:function(){var g=s.next();return l=g.done,g},e:function(g){p=!0,y=g},f:function(){try{!l&&s.return!=null&&s.return()}finally{if(p)throw y}}}}function t(a,u){if(a){if(typeof a=="string")return o(a,u);var s=Object.prototype.toString.call(a).slice(8,-1);if(s==="Object"&&a.constructor&&(s=a.constructor.name),s==="Map"||s==="Set")return Array.from(a);if(s==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return o(a,u)}}function o(a,u){(u==null||u>a.length)&&(u=a.length);for(var s=0,f=new Array(u);s<u;s++)f[s]=a[s];return f}var r=G(),n=r.ensureIterable;function i(a){var u=[],s=e(a),f;try{for(s.s();!(f=s.n()).done;){var d=f.value;u.push(d)}}catch(l){s.e(l)}finally{s.f()}return u}pe.__toArray=i;function c(a){return i(n(a))}return pe.toArray=c,pe}var yt;function Do(){if(yt)return ye;yt=1;var e=ke(),t=e.mark(c),o=G(),r=o.iterableCurry,n=Xo(),i=n.__toArray;function c(u,s){var f;return e.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(f=Array.isArray(u)?u:i(u),f.length){l.next=3;break}return l.abrupt("return");case 3:if(!s--){l.next=7;break}return l.delegateYield(f,"t0",5);case 5:l.next=3;break;case 7:case"end":return l.stop()}},t)}ye.__cycleTimes=c;var a=r(c);return ye.cycleTimes=a,ye}var me={},pt;function qo(){if(pt)return me;pt=1;var e=ke(),t=e.mark(a);function o(s,f){var d;if(typeof Symbol>"u"||s[Symbol.iterator]==null){if(Array.isArray(s)||(d=r(s))||f){d&&(s=d);var l=0,p=function(){};return{s:p,n:function(){return l>=s.length?{done:!0}:{done:!1,value:s[l++]}},e:function(b){throw b},f:p}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var y=!0,m=!1,g;return{s:function(){d=s[Symbol.iterator]()},n:function(){var b=d.next();return y=b.done,b},e:function(b){m=!0,g=b},f:function(){try{!y&&d.return!=null&&d.return()}finally{if(m)throw g}}}}function r(s,f){if(s){if(typeof s=="string")return n(s,f);var d=Object.prototype.toString.call(s).slice(8,-1);if(d==="Object"&&s.constructor&&(d=s.constructor.name),d==="Map"||d==="Set")return Array.from(s);if(d==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(d))return n(s,f)}}function n(s,f){(f==null||f>s.length)&&(f=s.length);for(var d=0,l=new Array(f);d<f;d++)l[d]=s[d];return l}var i=G(),c=i.iterableCurry;function a(s,f){var d,l,p,y;return e.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:d=0,l=o(s),g.prev=2,l.s();case 4:if((p=l.n()).done){g.next=11;break}if(y=p.value,!f(y,d++)){g.next=9;break}return g.next=9,y;case 9:g.next=4;break;case 11:g.next=16;break;case 13:g.prev=13,g.t0=g.catch(2),l.e(g.t0);case 16:return g.prev=16,l.f(),g.finish(16);case 19:case"end":return g.stop()}},t,null,[[2,13,16,19]])}me.__filter=a;var u=c(a);return me.filter=u,me}var ge={},mt;function Lo(){if(mt)return ge;mt=1;var e=G(),t=e.iterableCurry,o=Do(),r=o.__cycleTimes;function n(c){return r(c,1/0)}ge.__cycle=n;var i=t(n);return ge.cycle=i,ge}var he={},gt;function Yo(){if(gt)return he;gt=1;var e=ke(),t=e.mark(a);function o(s,f){var d;if(typeof Symbol>"u"||s[Symbol.iterator]==null){if(Array.isArray(s)||(d=r(s))||f){d&&(s=d);var l=0,p=function(){};return{s:p,n:function(){return l>=s.length?{done:!0}:{done:!1,value:s[l++]}},e:function(b){throw b},f:p}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var y=!0,m=!1,g;return{s:function(){d=s[Symbol.iterator]()},n:function(){var b=d.next();return y=b.done,b},e:function(b){m=!0,g=b},f:function(){try{!y&&d.return!=null&&d.return()}finally{if(m)throw g}}}}function r(s,f){if(s){if(typeof s=="string")return n(s,f);var d=Object.prototype.toString.call(s).slice(8,-1);if(d==="Object"&&s.constructor&&(d=s.constructor.name),d==="Map"||d==="Set")return Array.from(s);if(d==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(d))return n(s,f)}}function n(s,f){(f==null||f>s.length)&&(f=s.length);for(var d=0,l=new Array(f);d<f;d++)l[d]=s[d];return l}var i=G(),c=i.iterableCurry;function a(s,f){var d,l,p,y;return e.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:d=0,l=o(s),g.prev=2,l.s();case 4:if((p=l.n()).done){g.next=11;break}if(y=p.value,!(d++>=f)){g.next=9;break}return g.next=9,y;case 9:g.next=4;break;case 11:g.next=16;break;case 13:g.prev=13,g.t0=g.catch(2),l.e(g.t0);case 16:return g.prev=16,l.f(),g.finish(16);case 19:case"end":return g.stop()}},t,null,[[2,13,16,19]])}he.__drop=a;var u=c(a);return he.drop=u,he}var be={},xe={},ht;function Jo(){if(ht)return xe;ht=1;var e=G(),t=e.iterableCurry,o=e.callReturn;function r(i,c){var a=i[Symbol.iterator](),u=a.next(),s=u.value,f=u.done;return f?c:(o(a),s)}xe.__firstOr=r;var n=t(r,{reduces:!0});return xe.firstOr=n,xe}var bt;function Go(){if(bt)return be;bt=1;var e=G(),t=e.iterableCurry,o=Jo(),r=o.__firstOr;function n(c){return r(c,void 0)}be.__first=n;var i=t(n,{reduces:!0});return be.first=i,be}var ve={},xt;function Vo(){if(xt)return ve;xt=1;var e=ke(),t=e.mark(a);function o(s,f){var d;if(typeof Symbol>"u"||s[Symbol.iterator]==null){if(Array.isArray(s)||(d=r(s))||f){d&&(s=d);var l=0,p=function(){};return{s:p,n:function(){return l>=s.length?{done:!0}:{done:!1,value:s[l++]}},e:function(b){throw b},f:p}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var y=!0,m=!1,g;return{s:function(){d=s[Symbol.iterator]()},n:function(){var b=d.next();return y=b.done,b},e:function(b){m=!0,g=b},f:function(){try{!y&&d.return!=null&&d.return()}finally{if(m)throw g}}}}function r(s,f){if(s){if(typeof s=="string")return n(s,f);var d=Object.prototype.toString.call(s).slice(8,-1);if(d==="Object"&&s.constructor&&(d=s.constructor.name),d==="Map"||d==="Set")return Array.from(s);if(d==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(d))return n(s,f)}}function n(s,f){(f==null||f>s.length)&&(f=s.length);for(var d=0,l=new Array(f);d<f;d++)l[d]=s[d];return l}var i=G(),c=i.iterableCurry;function a(s,f){var d,l,p,y;return e.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:if(f!==0){g.next=2;break}return g.abrupt("return");case 2:d=0,l=o(s),g.prev=4,l.s();case 6:if((p=l.n()).done){g.next=14;break}return y=p.value,g.next=10,y;case 10:if(++d!==f){g.next=12;break}return g.abrupt("break",14);case 12:g.next=6;break;case 14:g.next=19;break;case 16:g.prev=16,g.t0=g.catch(4),l.e(g.t0);case 19:return g.prev=19,l.f(),g.finish(19);case 22:case"end":return g.stop()}},t,null,[[4,16,19,22]])}ve.__take=a;var u=c(a);return ve.take=u,ve}var Ae,vt;function Uo(){return vt||(vt=1,Ae=Lo().cycle),Ae}var Zo=Uo();const Ko=ce(Zo);var Te,wt;function Qo(){return wt||(wt=1,Te=Yo().drop),Te}var jo=Qo();const er=ce(jo);var Pe,It;function tr(){return It||(It=1,Pe=qo().filter),Pe}var or=tr();const rr=ce(or);var Se,Rt;function nr(){return Rt||(Rt=1,Se=Go().first),Se}var ir=nr();const _e=ce(ir);var Oe,zt;function sr(){return zt||(zt=1,Oe=Vo().take),Oe}var ar=sr();const cr=ce(ar),Yt=e=>()=>fo(e),w={w:16,d:16,h:12},re={x:16,y:16,z:12},W={x:12,y:12,z:w.h},lr={x:14,y:14,z:w.h},V={x:16,y:16,z:w.h},Ce={...W,z:w.h*2},Jt=e=>{switch(e.type){case"spring":case"portableBlock":case"moveableDeadly":case"slidingDeadly":case"firedDoughnut":return{aabb:W};case"slidingBlock":return e.config.style==="book"?{aabb:V}:{aabb:W};case"lift":return{aabb:{...W,z:W.z}};case"switch":return{aabb:{...W,z:W.z}};case"pickup":return e.config.gives==="scroll"?{aabb:{x:16,y:4,z:13}}:{aabb:W};case"charles":return{aabb:Ce};case"ball":return{aabb:{x:12,y:12,z:12}};case"pushableBlock":case"movingPlatform":return{aabb:V};case"block":switch(e.config.style){case"artificial":case"organic":case"book":return{aabb:V};case"tower":return{aabb:{x:11,y:11,z:w.h}};default:throw new Error("unknown block style")}case"monster":switch(e.config.which){case"skiHead":return{aabb:{...W,z:21}};case"bubbleRobot":case"cyberman":case"elephant":case"emperorsGuardian":case"monkey":case"computerBot":return{aabb:Ce};case"helicopterBug":case"dalek":case"emperor":case"homingBot":case"elephantHead":return{aabb:W};case"turtle":return{aabb:W};default:throw e.config,new Error("unknown monster type")}case"deadlyBlock":case"spikes":return{aabb:V};case"bubbles":return{aabb:W};case"conveyor":case"hushPuppy":case"teleporter":return{aabb:V};case"barrier":return{aabb:e.config.axis==="y"?{x:3,y:15,z:w.h}:{x:15,y:3,z:w.h}};case"sceneryPlayer":return e.config.which==="headOverHeels"?{aabb:Ce}:{aabb:W};case"emitter":return{aabb:A};default:return{aabb:lr}}},H={aabb:W,castsShadowWhileStoodOn:!1},dr=({config:{direction:e},position:t})=>e==="right"&&t.x===0||e==="towards"&&t.y===0,Fe={x:1,y:0,z:0},Ne={x:-1,y:0,z:0},$e={x:0,y:-1,z:0},We={x:0,y:1,z:0},$={away:We,left:Fe,right:Ne,towards:$e,down:{x:0,y:0,z:-1},up:{x:0,y:0,z:1},awayRight:ue(h(We,Ne)),towardsRight:ue(h($e,Ne)),towardsLeft:ue(h($e,Fe)),awayLeft:ue(h(We,Fe))},Hi=({x:e=0,y:t=0})=>t-e,U=({x:e=0,y:t=0,z:o=0})=>({x:t-e,y:-(e+t)/2-o}),Xi=(e,t,o)=>{const r=U(e),n=Dt(o,r);return h(ur(t,n),e)},ur=(e,{x:t,y:o})=>{switch(yo(e)){case"xy":return{x:-t/2-o,y:t/2-o,z:0};case"xz":return{x:-t,y:0,z:t/2-o};case"yz":return{x:0,y:t,z:-t/2-o};default:throw new Error("only axis-aligned planes are supported for unprojection")}},S=({x:e=0,y:t=0,z:o=0})=>({x:e*w.w,y:t*w.d,z:o*w.h}),Di=({x:e=0,y:t=0,z:o=0})=>({x:e/w.w,y:t/w.d,z:o/w.h}),qi=e=>U(S(e)),fr=["head","heels"],yr=[...fr,"headOverHeels"],N=(...e)=>t=>e.includes(t.type),pr=N("bubbles","stopAutowalk","firedDoughnut","floatingText","emitter","particle"),mr=(e,t)=>pr(e)||Ir(e)&&(t!==void 0&&br(t)||e.config.direction.z!==0)||Xe(e)&&e.config.floorType==="none",He=(e,t)=>!mr(e,t),Gt=["ball","slidingBlock","slidingDeadly"];N(...Gt);const gr=["portableBlock","spring","sceneryPlayer","sceneryCrown","monster","slidingBlock"],hr=["dalek","turtle","elephantHead","homingBot","helicopterBug"],Li=e=>e.type==="slidingBlock"?e.config.style==="puck":e.type==="monster"?hr.includes(e.config.which):gr.includes(e.type),br=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function xr(e){return Vt.includes(e.type)}const Vt=[...yr,"monster","ball","charles","pushableBlock","movingPlatform","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer","sceneryCrown"],vr=["monster","deadlyBlock","moveableDeadly","slidingDeadly"];N(...vr);const wr=e=>e.config.times!==void 0,Ir=N("portal");N("teleporter");N("heels");N("head");N("heels","headOverHeels");N("head","headOverHeels");N("lift");N("emitter");const Rr=N("monster"),Xe=N("floor");N("pickup");N("spring");const Yi=N("joystick");N("monster","movingPlatform");const Ji=e=>Rr(e)&&e.config.which==="cyberman"&&e.state.everActivated===!1,De=e=>{const t=S(e.position),{aabb:o}=Jt(e);if(o===void 0)throw new Error(`item type= ${e.type} config=${JSON.stringify(e.config)} has no bounding box`);return e.type==="wall"?t:h(t,{x:w.w-o.x>>1,y:w.d-o.y>>1})},B=Number.MIN_SAFE_INTEGER,kt=po/1e3,zr={firedDoughnut:2*kt,floatingText:kt},kr=10,Gi=6e4,Er=8,Vi=750,Ui=2500,Zi=200,Ki=.15,Ar=lt.h-lt.w/2,Ut=Ar+2,je=9999,_=()=>({expires:null,stoodOnBy:{},disappearing:null,switchedAtRoomTime:B,stoodOnUntilRoomTime:B}),Et=()=>({standingOnItemId:null,vels:{gravity:A,movingFloor:A},latentMovement:[],actedOnAt:{roomTime:B,by:C},collidedWith:{roomTime:B,by:C}}),Tr=e=>{const t=Vt.includes(e.type);return{..._(),position:De(e),...t?{standingOnItemId:null,vels:{gravity:A,movingFloor:A,...Gt.includes(e.type)?{sliding:A}:{},...e.type==="monster"||e.type==="movingPlatform"?{walking:A}:{}},latentMovement:[],actedOnAt:{roomTime:B,by:C},collidedWith:{roomTime:B,by:C}}:{},...e.type==="monster"?{activated:e.config.activated==="on",everActivated:e.config.activated==="on",timeOfLastDirectionChange:Number.NEGATIVE_INFINITY,...e.config.which==="skiHead"||e.config.which==="turtle"||e.config.which==="elephantHead"||e.config.which==="cyberman"?{facing:$[e.config.startDirection]}:{facing:$.towards}}:{},...e.type==="pickup"?{disappearing:{on:"touch",byType:e.config.gives==="bag"||e.config.gives==="jumps"?["heels","headOverHeels"]:e.config.gives==="doughnuts"||e.config.gives==="hooter"||e.config.gives==="fast"?["head","headOverHeels"]:["head","heels","headOverHeels"]}}:{},...e.type==="movingPlatform"?{activated:e.config.activated==="on",everActivated:e.config.activated==="on",facing:$[e.config.startDirection]}:{},...e.type==="switch"?{setting:e.config.initialSetting,touchedOnProgression:-1}:{},...e.type==="block"?{disappearing:e.config.disappearing??null}:{},...e.type==="conveyor"?{disappearing:e.config.disappearing??null}:{},...e.type==="barrier"?{disappearing:e.config.disappearing??null}:{},...e.type==="lift"?{direction:"up",vels:{lift:A}}:{},...e.type==="charles"?{facing:$.towards}:{},...e.type==="emitter"?{lastEmittedAtRoomTime:B,quantityEmitted:0}:{},...e.type==="firedDoughnut"?{disappearing:{on:"touch"},vels:{fired:e.config.direction?Je($[e.config.direction],zr.firedDoughnut):A}}:{}}},Pr=(e,...t)=>{const o={};for(const r of t)o[r]=e[r];return o},At=(e,...t)=>{const o={...e};for(const r of t)delete o[r];return o},Be=w.h*2,Sr=4,we=w.h*Sr,Or=2,Qi=2*w.w,Cr=.5,Tt=2;function*Fr(e,t){const{config:{direction:o},position:r}=e,n=qt(o),i=Ge(n),c=dr(e),a={...A,[i]:c?-.5:0},u=1,s={[i]:c?-1:0},f=u*w.w,d={...A,[i]:f},l=9,p=8,y=8;{const m={[n]:p,[i]:y,z:we};yield{...e,...H,type:"doorFrame",id:`${t}/frameFar`,jsonItemId:t,config:{...e.config,inHiddenWall:c,part:"far"},state:{..._(),position:S(h(r,{[n]:1.5},a,s)),stoodOnBy:C},aabb:h(m,d),renderAabb:m,renderAabbOffset:c?d:void 0}}{const m={[n]:l,[i]:y,z:we};yield{...e,...H,type:"doorFrame",id:`${t}/frameNear`,jsonItemId:t,config:{...e.config,inHiddenWall:c,part:"near"},state:{..._(),position:S(h(r,a,s)),stoodOnBy:C},aabb:h(m,d),renderAabb:m,renderAabbOffset:c?d:void 0}}{const m={[n]:2*w.w-l-p,[i]:y,z:we-Be};yield{...e,...H,type:"doorFrame",id:`${t}/frameTop`,jsonItemId:t,config:{...e.config,inHiddenWall:c,part:"top"},state:{..._(),position:h(S(h(r,a,s)),{[n]:l,z:Be}),stoodOnBy:C},aabb:h(m,d),renderAabb:m,renderAabbOffset:c?d:void 0}}yield{...e,...H,type:"blocker",id:`${t}/blockerAbove`,jsonItemId:t,config:{},renders:!1,state:{..._(),position:h(S(h(r,a,s)),{z:we}),stoodOnBy:C},aabb:h(S({[n]:2,[i]:u,z:je}),{[i]:y}),renderAabb:A,fixedZIndex:K},yield{...e,...H,type:"portal",id:`${t}/portal`,jsonItemId:t,config:{...Pr(e.config,"toRoom","toDoor"),inHidden:c,relativePoint:S({...A,[i]:c?u+.25:-.25}),direction:$[o]},fixedZIndex:K,state:{..._(),position:h(S(h(r,{[i]:c?-.5-u:.5})),{[n]:l}),stoodOnBy:C},aabb:{[n]:Or*w.w-l-p,[i]:f,z:Be}},r.z!==0&&(yield{...e,...H,type:"doorLegs",id:`${t}/legs`,jsonItemId:t,config:{...e.config,inHiddenWall:c,style:"none",side:"away",height:r.z},renders:!0,shadowCastTexture:c?{textureId:"shadow.door.floatingThreshold.double.y",flipX:n==="x"}:void 0,castsShadowWhileStoodOn:c,state:{..._(),position:{...S(h(r,a,s)),z:0}},aabb:h(S({[n]:2,[i]:.5,z:r.z}),d),renderAabb:c?h(S({[n]:2,[i]:.5,z:.5})):void 0,renderAabbOffset:c?h({[n]:0,[i]:0,z:(r.z-.5)*w.h},{[i]:d[i]}):void 0,shadowOffset:{z:r.z*w.h,[i]:c?d[i]:void 0}}),yield{...H,type:"stopAutowalk",id:`${t}/stopAutowalk`,jsonItemId:t,aabb:S({[n]:2,[i]:Tt,z:2}),config:{},fixedZIndex:K,state:{..._(),position:S(ie(r,Je($[o],Cr),c?A:{[i]:Tt})),stoodOnBy:C}}}const Pt={config:C,shadowCastTexture:"shadow.smallRound",castsShadowWhileStoodOn:!0,aabb:W},St=()=>{const e=go(Ve.getState());return{action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:$.towards,walkStartFacing:$.towards,walkDistance:0,vels:{walking:A,gravity:A,movingFloor:A},switchedToAt:B,lastDiedAt:B,gameTime:0,jumpStartTime:B,lives:e?"infinite":Er,jumpStartZ:0}},Nr=(e,t)=>{const o=mo(Ve.getState());return e.config.which==="head"?{id:t,jsonItemId:t,type:"head",...H,...Pt,state:{..._(),...Et(),...St(),hasHooter:!1,gameWalkDistance:0,fastStepsStartedAtDistance:B,shieldCollectedAt:B,doughnuts:o?"infinite":0,position:De(e),stoodOnUntilRoomTime:B}}:{id:t,jsonItemId:t,type:"heels",...H,...Pt,state:{..._(),...Et(),...St(),carrying:null,hasBag:!1,bigJumps:0,isBigJump:!1,shieldCollectedAt:B,position:De(e),stoodOnUntilRoomTime:B}}},Zt=e=>e==="towards"||e==="right",de=e=>({x:e.direction==="away"?e.tiles.length:e.direction==="towards"?e.times?.x:1,y:e.direction==="left"?e.tiles.length:e.direction==="right"?e.times?.y:1}),ji=e=>e.type==="wall"?de(e.config):wr(e)?e.config.times:void 0,qe=(e=te)=>({x:e.x??1,y:e.y??1,z:e.z??1}),$r=e=>({x:e.x??1,y:e.y??1}),X=e=>{const t=o=>o.config.times!==void 0;return e.type==="wall"?qe(de(e.config)):t(e)?qe(e.config.times):te},Kt=e=>{const t={};let o=!1;return e.x!==1&&(t.x=e.x,o=!0),e.y!==1&&(t.y=e.y,o=!0),e.z!==1&&(t.z=e.z,o=!0),o?t:void 0},se=(e,t={})=>{const o=qe(t),r=ie(re,e);return ie(ho(o,re),r)},Qt=1,Wr={x:w.w,y:w.d*Qt,z:je},Br={x:w.w,y:0,z:Ut},Mr={x:w.w*Qt,y:w.d,z:je},_r={x:0,y:w.d,z:Ut},Hr=(e,t)=>{const{config:{direction:o},position:r}=t,n=de(t.config),i=qt(o),c=Ge(i),a=Zt(o),u={...A,[c]:a?-1:0};return{type:"wall",id:e,jsonItemId:e,config:t.config,aabb:se(i==="y"?Mr:Wr,n),renderAabb:a?A:se(i==="y"?_r:Br,n),fixedZIndex:a?K:void 0,state:{..._(),position:S(h(r,u)),stoodOnBy:C},shadowCastTexture:i==="y"?"shadow.wall.y":{textureId:"shadow.wall.y",flipX:!0},castsShadowWhileStoodOn:a}},Xr=3,Ot=10,Ct=.52,Ft=.5,Dr=(e,t,o)=>{const{config:{times:r},position:n}=t,i=h(n,{z:-3}),c={...r,z:Xr};let a=i,u=c;const s=D(Ee(o.items)).filter(l=>l.type==="door");if(n.z===0){const l={};for(const p of s){const{position:y,config:{direction:m}}=p;switch(m){case"towards":!l.towards&&y.y===i.y&&y.x>=i.x&&y.x<=i.x+r.x-2&&(u=h(u,{y:Ft}),a=h(a,{y:-.5}),l.towards=!0);break;case"away":!l.away&&y.y===i.y+r.y&&y.x>=i.x&&y.x<=i.x+r.x-2&&(u=h(u,{y:Ct}),l.away=!0);break;case"right":!l.right&&y.x===i.x&&y.y>=i.y&&y.y<=i.y+r.y-2&&(u=h(u,{x:Ft}),a=h(a,{x:-.5}),l.right=!0);break;case"left":!l.left&&y.x===i.x+r.x&&y.y>=i.y&&y.y<=i.y+r.y-2&&(u=h(u,{x:Ct}),l.left=!0);break}}}const f=S(a),d=se(V,u);return{...H,type:"floor",id:e,jsonItemId:e,config:{...t.config,naturalFootprint:{aabb:se(V,c),position:S(i)}},aabb:d,renderAabb:{...d,z:Ot},renderAabbOffset:{...A,z:d.z-Ot},shadowCastTexture:"shadow.fullBlock",state:{..._(),position:f}}};function*jt(e,t,o,r=C,n={},i=""){if(!r[e]&&!(t.type==="pickup"&&t.config.gives==="scroll"&&t.config.source==="manual"&&n[t.config.page]))switch(!0){case t.type==="door":return yield*Fr(t,e);case t.type==="player":{yield Nr(t,e);return}case t.type==="wall":{yield Hr(e,t);return}case t.type==="floor":{yield Dr(e,t,o);return}case(t.type==="block"&&t.config.disappearing!==void 0&&Ue(X(t))>=2):{const c=X(t);for(let a=0;a<c.x;a++)for(let u=0;u<c.y;u++)for(let s=0;s<c.z;s++){const f=ee(t,d=>{d.position={x:t.position.x+a,y:t.position.y+u,z:t.position.z+s},d.config.times=te});yield*jt(e,f,o,r,n,`${i}_${a}_${u}_${s}`)}break}case(t.type==="sceneryCrown"&&!Ve.getState().gameMenus.planetsLiberated[t.config.planet]):return;default:{const c=Jt(t),a=t.config.times!==void 0?{aabb:se(c.aabb,t.config.times),renderAabb:void 0}:c;let u;try{u=Tr(t)}catch(s){throw new Error(`loadItemFromJson: error creating initial state for jsonItem ${JSON.stringify(t,null,2)}`,{cause:s})}yield{...t,...H,...a,id:`${e}${i}`,jsonItemId:e,fixedZIndex:t.type==="emitter"?K:void 0,shadowCastTexture:qr(t),castsShadowWhileStoodOn:t.type==="monster"&&(t.config.which==="emperor"||t.config.which==="emperorsGuardian"||t.config.which==="turtle"||t.config.which==="helicopterBug")||t.type==="pickup"||t.type==="ball"||t.type==="lift"||t.type==="pushableBlock"||t.type==="sceneryPlayer"||t.type==="slidingDeadly"||t.type==="spring",config:t.config,state:u}}}}const qr=e=>{switch(e.type){case"lift":case"switch":return"shadow.smallBlock";case"conveyor":return{textureId:"shadow.fullBlock",flipX:Me(e.config.direction)==="x"};case"barrier":return{textureId:"shadow.barrier.y",flipX:e.config.axis==="x"};case"spring":case"firedDoughnut":case"slidingDeadly":return"shadow.smallRound";case"block":return e.config.style==="tower"?"shadow.smallRound":"shadow.fullBlock";case"pushableBlock":case"movingPlatform":case"hushPuppy":case"deadlyBlock":case"teleporter":case"spikes":return"shadow.fullBlock";case"portableBlock":return e.config.style==="drum"?"shadow.smallRound":"shadow.smallBlock";case"pickup":return e.config.gives==="scroll"?"shadow.scroll":"shadow.smallRound";case"ball":case"charles":case"monster":return"shadow.smallRound";case"slidingBlock":return e.config.style==="book"?"shadow.fullBlock":"shadow.smallRound"}},et=({aabb:e,state:{position:t}},{aabb:o,state:{position:r}})=>!(t.x+e.x<=r.x||t.x>=r.x+o.x)&&!(t.y+e.y<=r.y||t.y>=r.y+o.y)&&!(t.z+e.z<=r.z||t.z>=r.z+o.z),Lr=(e,t)=>[...D(t).filter(o=>e.id!==o.id&&et(e,o))];function*es(e,t){for(const o of t)e.id!==o.id&&et(e,o)&&(yield o)}function*Yr(e,t){if(e.roomBelow!==void 0)for(const o of oe(t).filter(Xe)){const{config:{naturalFootprint:r}}=o;yield{...H,type:"portal",id:"floor/portal",fixedZIndex:K,config:{toRoom:e.roomBelow,relativePoint:{x:r.aabb.x/2,y:r.aabb.y/2,z:r.aabb.z},direction:$.down},aabb:r.aabb,state:{..._(),position:r.position},renders:!1}}if(e.roomAbove!==void 0)for(const o of oe(t).filter(Xe)){const{config:{naturalFootprint:r}}=o;yield{...H,type:"portal",id:"ceilingPortal",fixedZIndex:K,config:{toRoom:e.roomAbove,relativePoint:{...e.ceilingRelativePoint!==void 0?S(e.ceilingRelativePoint):{x:r.aabb.x/2,y:r.aabb.y/2},z:-12},direction:$.up},aabb:{...r.aabb,z:w.h},state:{..._(),position:h(r.position,{z:r.aabb.z},{z:w.h*(e.height??kr)})}}}}const Jr=(e,t,o,r)=>{const n=Math.max(0,Math.min(e.x+t.x,o.x+r.x)-Math.max(e.x,o.x)),i=Math.max(0,Math.min(e.y+t.y,o.y+r.y)-Math.max(e.y,o.y));return n*i},Nt=({state:{position:e},aabb:t},{state:{position:o},aabb:r})=>Jr(e,t,o,r),$t={stopAutowalk:5,portal:5,wall:5,blocker:5,doorLegs:5,sceneryPlayer:5,bubbles:5,switch:10,doorFrame:15,ball:18,block:20,barrier:20,floor:20,hushPuppy:20,teleporter:20,lift:30,movingPlatform:30,pushableBlock:30,portableBlock:30,sceneryCrown:30,slidingBlock:30,spring:30,joystick:40,charles:40,conveyor:40,head:50,heels:50,headOverHeels:50,pickup:80,firedDoughnut:90,spikes:98,slidingDeadly:100,moveableDeadly:100,deadlyBlock:100,monster:100,floatingText:200,particle:200,emitter:200},Gr=(e,t)=>$t[e.type]-$t[t.type],Vr=(e,t,o=.001)=>{if(!He(t,e)||e.id===t.id)return!1;const{state:{vels:{gravity:{z:r}}}}=e;return r>0?!1:et({state:{position:h(e.state.position,{x:0,y:0,z:-1e-4})},aabb:{...e.aabb,z:o+bo},id:e.id},{state:{position:h(t.state.position,{x:0,y:0,z:t.aabb.z})},aabb:{...t.aabb,z:0},id:t.id})},Ur=(e,t)=>{const r=[...D(t).filter(i=>Vr(e,i))];return r.length===0?void 0:r.reduce((i,c)=>{const a=Gr(c,i);return a<0||a===0&&Nt(e,c)>Nt(e,i)?c:i})},Zr=({above:e,below:t})=>{const o=t.state.stoodOnBy;if(!Object.isExtensible(o))throw new Error(`${e.id} can't stand on ${t.id} - its standingOn is not extensible`);e.state.standingOnItemId=t.id,o[e.id]=!0};function*Kr(e,t,o,r){const n=Ze(e.items);for(const[i,c]of n)c.type==="player"&&!r||(yield*jt(i,c,e,t,o))}const Wt=e=>D(e).reduce((t,o)=>({...t,[o.id]:o}),{}),eo=({roomJson:e,roomPickupsCollected:t,scrollsRead:o,isNewGame:r=!1})=>{const n=Wt(Kr(e,t,o,r)),i={...Wt(Yr(e,n)),...n};for(const a of oe(i)){const s=Lr(a,xo(i)).find(f=>He(a)&&He(f)&&!(a.type==="wall"&&f.type==="wall"));s!==void 0&&console.error(`in room ${e.id} item ${a.id} @${JSON.stringify(a.state.position)} #${JSON.stringify(a.aabb)} is colliding with (solid item) ${s.id} @${JSON.stringify(s.state.position)} #${JSON.stringify(s.aabb)} on loading room ${e.id}`)}for(const a of oe(i).filter(xr)){const u=Ur(a,oe(i).filter(s=>s.id!==a.id));u!==void 0&&Zr({above:a,below:u})}return{...e,roomJson:e,items:i,roomTime:0}},Qr=e=>Ee(e.items),jr=e=>Ke(e),tt=e=>D(Qr(e)),J=(e,...t)=>{const o=D(jr(e));return t.length===0?o:o.filter(([,r])=>t.includes(r.type))},en={floors:{edgeLeftX:Number.POSITIVE_INFINITY,edgeRightX:Number.NEGATIVE_INFINITY,topEdgeY:Number.POSITIVE_INFINITY,bottomEdgeY:Number.NEGATIVE_INFINITY},allItems:{topEdgeY:Number.POSITIVE_INFINITY}},tn=e=>oe(e.items).reduce((t,o)=>{if(o.type==="floor"){const{config:{naturalFootprint:r},state:{position:n},renderAabb:i,renderAabbOffset:c,aabb:a}=o,u=U(h(r.position,{x:r.aabb.x,z:r.aabb.z})).x,s=U(h(r.position,{y:r.aabb.y,z:r.aabb.z})).x,f=U(h(r.position,r.aabb)).y,d=U(h(n,c??A,{z:(i??a).z})).y;return{allItems:t.allItems,floors:{edgeLeftX:Math.min(t.floors.edgeLeftX,u),edgeRightX:Math.max(t.floors.edgeRightX,s),topEdgeY:Math.min(t.floors.topEdgeY,f),bottomEdgeY:Math.max(t.floors.bottomEdgeY,d)}}}else{const r=U(h(o.state.position,o.renderAabb??o.aabb??A,o.renderAabbOffset??A)).y;return{allItems:{topEdgeY:Math.min(t.allItems.topEdgeY,r)},floors:t.floors}}},en),on={from:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY,z:Number.POSITIVE_INFINITY},to:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY,z:Number.NEGATIVE_INFINITY}},ts=e=>{const t=tt(e).filter(o=>o.type==="floor").reduce((o,r)=>{const{position:n,config:{times:i}}=r;return{from:{x:Math.min(o.from.x,n.x),y:Math.min(o.from.y,n.y),z:Math.min(o.from.z,n.z)},to:{x:Math.max(o.to.x,n.x+i.x),y:Math.max(o.to.y,n.y+i.y),z:Math.max(o.to.z,n.z)}}},on);if(isFinite(t.from.x))return t},rn=le([e=>F(e.levelEditor),e=>e.levelEditor.previewedEdits],(e,t)=>ee(e,o=>{const r=Ke(t);for(const[n,i]of r)i===null?delete o.items[n]:o.items[n]=i})),nn=le([e=>F(e.levelEditor)],e=>eo({roomJson:e,roomPickupsCollected:C,scrollsRead:C,isNewGame:!0})),sn=le([rn],e=>eo({roomJson:e,roomPickupsCollected:C,scrollsRead:C,isNewGame:!0})),an=le([nn],e=>{const{floors:{edgeLeftX:t,edgeRightX:o,bottomEdgeY:r},allItems:{topEdgeY:n}}=tn(e);return{l:t,r:o,w:o-t,b:r,t:n,h:r-n}}),os=Yt(sn),rs=Yt(an),F=e=>e.campaignInProgress.rooms[e.currentlyEditingRoomId],Le=(e,t)=>e.campaignInProgress.rooms[t],to=(e,t,o)=>e.campaignInProgress.rooms[o??e.currentlyEditingRoomId]?.items[t],cn=(e,t)=>e.selectedJsonItemIds.includes(t),Z=e=>{const t=structuredClone(L(F(e))),{history:o}=e;o.redo=[],o.undo.push(t)},ln={undo(e){const t=e,{campaignInProgress:o,history:{undo:r,redo:n},currentlyEditingRoomId:i}=t;r.length!==0&&(n.push(o.rooms[i]),o.rooms[i]=r.pop())},redo(e){const t=e,{campaignInProgress:o,history:{redo:r,undo:n},currentlyEditingRoomId:i}=t;r.length!==0&&(n.push(o.rooms[i]),o.rooms[i]=r.pop())}},dn={selectCanUndo:e=>e.history.undo.length>0,selectCanRedo:e=>e.history.redo.length>0},un=(e,t,o)=>{if(t==="*")return!0;const r=o.meta.subRooms[t];return e.x>=r.physicalPosition.from.x&&e.y>=r.physicalPosition.from.y&&e.x<=r.physicalPosition.to.x&&e.y<=r.physicalPosition.to.y},fn=({position:e},t,o)=>un(e,t,o),yn=(e,t,o)=>{if(t==="*")return 0;const r=o.meta.subRooms[t],{from:n,to:i}=r.physicalPosition;if(e.x>=n.x&&e.y>=n.y&&e.x<=i.x&&e.y<=i.y)return 0;let c=0,a=0;return e.x<n.x?c=n.x-e.x:e.x>i.x&&(c=e.x-i.x),e.y<n.y?a=n.y-e.y:e.y>i.y&&(a=e.y-i.y),c+a},pn=(e,t,o)=>{const r=o.meta?.subRooms;if(r===void 0)return"*";let n,i=1/0;const c=t==="fine"?{x:e.x/w.w,y:e.y/w.d}:e;for(const a of Qe(r)){const u=yn(c,a,o);if(u===0)return a;u<i&&(i=u,n=a)}if(n===void 0)throw new Error(`item not found in any subroom of ${o.id}
      item at 📍 ${JSON.stringify(c)}
      subrooms ${JSON.stringify(o.meta?.subRooms,null,2)}`);return n},Ie=(e,t,o,r)=>t.some(n=>n.config.direction===e)?"doorway":o===void 0?"wall":Object.values(o).some(({gridPosition:n})=>wo($[e],Dt(n,r)))?"open":"wall";function*j(e){try{yield*mn(e)}catch(t){const o=t;throw new Error(`
  error in recursion ${e.roomId}/${e.subRoomId??"*"}`,{cause:o})}}function*mn({roomId:e,subRoomId:t="*",campaign:o,visited:r={},vectorFromPrevious:n,previousRoomGridPosition:i=A}){if(e==="nowhere"||r[e]?.[t])return;r[e]===void 0&&(r[e]={}),r[e][t]=!0;const c=o.rooms[e];if(c===void 0)throw new Error(`no room in the campaign with id="${e}"`);const a=[...D(Ee(c.items)).filter(p=>p.type==="door").filter(p=>fn(p,t,c))],u=h(i,n===void 0?vo:n),s=c.meta?.subRooms;if(s){if(t==="*")throw new Error(`subRoomId '*' means 'all' and is not allowed for big rooms. Must be one of the sub-rooms in ${e}: ${Object.keys(s)}`);if(!s[t])throw new Error(`Sub-room ${t} not found in room ${e}. Available sub-rooms: ${Object.keys(s)}`)}const f=s?.[t].gridPosition,d={left:Ie("left",a,s,f),right:Ie("right",a,s,f),away:Ie("away",a,s,f),towards:Ie("towards",a,s,f)};if(yield{roomId:e,subRoomId:t,gridPosition:u,boundaries:d},s!==void 0){if(f===void 0)throw new Error(`Sub-room ${t} not found in room ${e}. Available sub-rooms: ${Object.keys(s)}`);for(const[p,{gridPosition:y}]of D(Ze(s)))p!==t&&(yield*j({roomId:e,subRoomId:p,campaign:o,visited:r,vectorFromPrevious:ie({...y,z:0},f),previousRoomGridPosition:u}))}if(c.roomAbove!==void 0){const{roomAbove:p,subRoomAbove:y}=c;yield*j({roomId:p,subRoomId:y,campaign:o,visited:r,vectorFromPrevious:$.up,previousRoomGridPosition:u})}if(c.roomBelow!==void 0){const{roomBelow:p,subRoomBelow:y}=c;yield*j({roomId:p,subRoomId:y,campaign:o,visited:r,vectorFromPrevious:$.down,previousRoomGridPosition:u})}for(const p of a){const{toRoom:y}=p.config;try{yield*j({roomId:y,campaign:o,visited:r,subRoomId:p.config.meta?.toSubRoom,vectorFromPrevious:$[p.config.direction],previousRoomGridPosition:u})}catch(m){throw new Error(`error while traversing door ${JSON.stringify(p,null,2)} in room ${e} to room ${y}`,{cause:m})}}const l=c.meta?.nonContiguousRelationship;if(l!==void 0){const{with:{room:p},gridOffset:y}=l;yield*j({roomId:p,campaign:o,visited:r,subRoomId:"*",vectorFromPrevious:y,previousRoomGridPosition:u})}}const gn={jail:["bars"],blacktooth:["plain","plain","armour","shield","shield","armour"],bookworld:["book","book","cowboy"],egyptus:["hieroglyphics","hieroglyphics","hieroglyphics","sarcophagus","sarcophagus"],market:["passage","more-fruits","fruits","more-fruits","fruits"],moonbase:["coil","window1","window2","window3"],penitentiary:["loop","loop","skeleton"],safari:["wall","shield","wall","window","window","wall","shield"]},ae=(e,t,o=0)=>{const r=Ko(gn[e]);return er(o,cr(t+o,r))},hn=e=>({awayWall:{type:"wall",config:{direction:"away",tiles:Array.from(ae("blacktooth",e.x))},position:{x:0,y:e.y,z:0}},leftWall:{type:"wall",config:{direction:"left",tiles:Array.from(ae("blacktooth",e.y))},position:{x:e.x,y:0,z:0}},towardsWall:{type:"wall",config:{direction:"towards",times:{x:e.x}},position:{x:0,y:0,z:0}},rightWall:{type:"wall",config:{direction:"right",times:{y:e.y}},position:{x:0,y:0,z:0}}}),oo=e=>({planet:"blacktooth",color:{hue:"cyan",shade:"basic"},items:{floor:{type:"floor",config:{floorType:"standable",scenery:"blacktooth",times:e},position:{x:0,y:0,z:0}},...hn(e)}}),ro=(e,t)=>{e.planet=t;for(const o of Object.values(e.items))o.type==="floor"&&o.config.floorType==="standable"&&(o.config.scenery=t),o.type==="wall"&&(o.config.direction==="away"||o.config.direction==="left")&&(o.config.tiles=Array.from(ae(t,o.config.tiles.length))),o.type==="pickup"&&o.config.gives==="crown"&&Io.includes(t)&&(o.config.planet=t)},bn=e=>e[Math.floor(Math.random()*e.length)],ot=(e,t,o)=>{const n=`room_${D(Ro({start:0})).find(a=>e.campaignInProgress.rooms[`room_${a}`]===void 0)}`,i=o??{hue:bn(zo),shade:Math.random()<.66?"basic":"dimmed"},c={id:n,...structuredClone(oo({x:8,y:8})),color:i};return ro(c,t),e.campaignInProgress.rooms[n]=c,c},rt=(e,t,o)=>{if(t.type==="player"){const{which:n}=t.config;return o?`preview-${n}`:n}const r=t.type==="monster"?t.config.which:t.type;for(let n=1;;n++){const i=n===1?r:`${r}_${n}`;if(!e.items[i])return i}},Ye=(e,t,o,r)=>{const n=F(e),i=rt(n,t,r),c=no(e,r),a={type:t.type,config:t.config,position:o};return c[i]=a,[i,a]},no=(e,t,o=e.currentlyEditingRoomId)=>t?e.previewedEdits:e.campaignInProgress.rooms[o].items;function*io(e,t,o){for(const r of Ze(e)){const[n,i]=r;if(i===null||i.type!=="wall"||i.config.direction!==t)continue;const{position:c,config:a}=i,u=$r(de(a)),s=Ge(Me(a.direction)),f=Me(a.direction),d=ie(o,c);if(d[f]!==0||d[s]<-1||d[s]>=u[s])continue;if(d[s]===0&&u[s]===2){yield[n,null];continue}const l=2+d[s];if(l===1||l===2){const b=ee(i,k=>{k.position=h(c,{[s]:l});const z=k.config;switch(z.direction){case"towards":case"right":z.times[s]=u[s]-l;break;default:z.tiles=z.tiles.slice(l)}});yield[n,b];continue}const y=u[s]-d[s];if(y===2||y===1){const b=ee(i,k=>{const z=k.config;switch(z.direction){case"towards":case"right":z.times[s]=u[s]-y;break;default:z.tiles=z.tiles.slice(0,-y)}});yield[n,b];continue}const g=ee(i,b=>{const k=b.config;switch(k.direction){case"towards":case"right":k.times[s]=d[s];break;default:k.tiles=k.tiles.slice(0,d[s])}});yield[`${n}/beforeDoor`,g];const x=ee(i,b=>{b.position={...c,[s]:o[s]+2};const k=b.config;switch(k.direction){case"towards":case"right":k.times[s]=u[s]-d[s]-2;break;default:k.tiles=k.tiles.slice(d[s]+2)}});yield[`${n}/afterDoor`,x],yield[n,null]}}const Bt=(e,t,o,r,n)=>{const i=Le(e,t);if(i===void 0)throw new Error("can't cut hole in walls for a room that does not exist");const c=no(e,n,t);for(const[a,u]of io(i.items,o,r))n?c[a]=u:u===null?delete c[a]:c[a]=u},xn=({state:e,fromRoomJson:t,subRoomId:o,direction:r,isPreview:n,autoAddRooms:i})=>{const c=e.campaignInProgress,a=j({campaign:c,roomId:t.id,subRoomId:o}),u=D(a).find(({gridPosition:s})=>Eo(s,$[r]));if(u)return c.rooms[u.roomId];if(!n)return i?ot(e,t.planet):void 0},vn=e=>J(e.items,"floor").reduce((t,[,o])=>{const r=o.position.y;return Math.min(t,r)},Number.POSITIVE_INFINITY),wn=e=>J(e.items,"floor").reduce((t,[,o])=>{const r=o.position.y+o.config.times.y;return Math.max(t,r)},Number.NEGATIVE_INFINITY),In=e=>J(e.items,"floor").reduce((t,[,o])=>{const r=o.position.x;return Math.min(t,r)},Number.POSITIVE_INFINITY),Rn=e=>J(e.items,"floor").reduce((t,[,o])=>{const r=o.position.x+o.config.times.x;return Math.max(t,r)},Number.NEGATIVE_INFINITY),zn=(e,t,o,r,n)=>{const i=F(e),c=o;Bt(e,i.id,c,t,n);const a=r.config.toRoom==="+",u=pn(t,"block",i),s=xn({state:e,fromRoomJson:i,subRoomId:u,direction:c,isPreview:n,autoAddRooms:a}),[f,d]=Ye(e,{type:"door",config:{...r.config,toRoom:s?s.id:r.config.toRoom,direction:c}},t,n);if(!n&&s){const l=rt(s,r,n),p={x:c==="left"?In(s):c==="right"?Rn(s):t.x,y:c==="away"?vn(s):c==="towards"?wn(s):t.y,z:t.z},y=ko(c),m={type:"door",config:{toRoom:i.id,direction:y,meta:u==="*"?void 0:{toSubRoom:u}},position:p};s.items[l]=m,m.config.toDoor=f,d.config.toDoor=l,Bt(e,s.id,y,p,!1)}};function Mt(e){var t="";return o(e),t;function o(n){if(n===null||typeof n!="object"||n.toJSON!=null)t+=JSON.stringify(n);else if(Array.isArray(n)){t+="[";var i=!1;n.forEach(function(a){i&&(t+=","),i=!0,a===void 0&&(a=null),o(a)}),t+="]"}else{t+="{";var c=Object.keys(n).filter(function(a){return n[a]!==void 0}).sort();c.forEach(function(a,u){return r(n,a,u)}),t+="}"}}function r(n,i,c){c>0&&(t+=","),t+=JSON.stringify(i),t+=":",o(n[i])}}const nt=e=>Ue(it(e))>0,it=e=>{switch(e.type){case"deadlyBlock":return te;case"conveyor":if(e.config.disappearing)return A;switch(e.config.direction){case"left":case"right":return{x:1,y:0,z:0};case"away":case"towards":return{x:0,y:1,z:0};default:throw e.config.direction,new Error}case"hushPuppy":return te;case"teleporter":return{x:1,y:1,z:0};case"floor":case"spikes":return{x:1,y:1,z:0};case"block":return te;case"barrier":if(e.config.disappearing)return A;switch(e.config.axis){case"x":return{x:1,y:0,z:1};case"y":return{x:0,y:1,z:1};default:throw e.config.axis,new Error}case"wall":switch(e.config.direction){case"left":case"right":return{x:0,y:1,z:1};case"away":case"towards":return{x:1,y:0,z:1};default:throw e.config,new Error}default:return A}};class ze{#o;#t;#e;constructor(t,o){this.#t={x:-t.x,y:-t.y,z:-t.z},this.#e={x:o.x-t.x+1,y:o.y-t.y+1,z:o.z-t.z+1},this.#o=Array.from({length:this.#e.x},()=>Array.from({length:this.#e.y},()=>Array.from({length:this.#e.z},()=>new Set)))}static fromItems(t){let o=1/0,r=1/0,n=1/0,i=-1/0,c=-1/0,a=-1/0;const u=[...t];for(const[,f]of u){const{x:d,y:l,z:p}=f.position,y=X(f);o=Math.min(o,d),r=Math.min(r,l),n=Math.min(n,p),i=Math.max(i,d+y.x-1),c=Math.max(c,l+y.y-1),a=Math.max(a,p+y.z-1)}if(u.length===0)return new ze({x:0,y:0,z:0},{x:0,y:0,z:0});const s=new ze({x:o,y:r,z:n},{x:i,y:c,z:a});for(const f of u){const[,d]=f,{x:l,y:p,z:y}=d.position,m=X(d);for(let g=0;g<m.x;g++)for(let x=0;x<m.y;x++)for(let b=0;b<m.z;b++)s.add({x:l+g,y:p+x,z:y+b},f)}return s}get(t){const o=t.x+this.#t.x,r=t.y+this.#t.y,n=t.z+this.#t.z;if(this.#r(o,r,n))return this.#o[o][r][n]}set(t,o){const r=t.x+this.#t.x,n=t.y+this.#t.y,i=t.z+this.#t.z;this.#r(r,n,i)&&(this.#o[r][n][i]=o)}add(t,o){const r=this.get(t);r&&r.add(o)}remove(t,o){const r=this.get(t);r&&r.delete(o)}get size(){return{...this.#e}}get minBounds(){return{x:-this.#t.x,y:-this.#t.y,z:-this.#t.z}}get maxBounds(){const t=this.minBounds;return{x:t.x+this.#e.x-1,y:t.y+this.#e.y-1,z:t.z+this.#e.z-1}}*iterate(){const{minBounds:t}=this;for(let o=0;o<this.#e.x;o++)for(let r=0;r<this.#e.y;r++)for(let n=0;n<this.#e.z;n++)yield[{x:o+t.x,y:r+t.y,z:n+t.z},this.#o[o][r][n]]}extractUniqueItems(){const t=new Set,o=[];for(const[,r]of this.iterate())for(const n of r)t.has(n)||(t.add(n),o.push(n));return o}#r(t,o,r){return t>=0&&t<this.#e.x&&o>=0&&o<this.#e.y&&r>=0&&r<this.#e.z}}const Y=e=>e.type==="wall"?`wall/${e.config.direction}`:e.type==="teleporter"?Mt({type:e.type,config:At(e.config,"toPosition","times")}):Mt({type:e.type,config:At(e.config,"times")}),kn=e=>nt(e[1]),En=e=>({x:Math.floor(e.x%1*re.x),y:Math.floor(e.y%1*re.y)}),An=(e,t)=>`${e},${t}`,Tn=(e,t)=>{let o=e,r=o.length;for(;;){const n=[...Sn(o,t)];if(n.length===r)return n;r=n.length,o=n}},Pn=(e,t=()=>!0)=>{const o=new Map,r=[];for(const i of e){const[,c]=i;if(!t(i))r.push(i);else if(nt(c)){const a=En(c.position),u=An(a.x,a.y);o.has(u)||o.set(u,[]),o.get(u).push(i)}else r.push(i)}const n=[];for(const[i,c]of o)if(c.length>0){const a=c.map(([p,y])=>[p,{...y,position:{x:Math.floor(y.position.x),y:Math.floor(y.position.y),z:y.position.z}}]),u=Tn(a,t),[s,f]=i.split(",").map(Number),d=s/re.x,l=f/re.y;for(const[p,y]of u)n.push([p,{...y,position:{x:y.position.x+d,y:y.position.y+l,z:y.position.z}}])}return[...n,...r]},Sn=(e,t=()=>!0)=>{const o=[],r=[];for(const l of e)t(l)&&kn(l)?o.push(l):r.push(l);const n=ze.fromItems(o),i=n.size,{minBounds:c}=n,a=new Map,u=new Map;for(const[,l]of n.iterate())for(const[,p]of l){const y=Y(p);u.has(y)||u.set(y,p)}for(const[l]of u)a.set(l,Array.from({length:i.x},()=>Array.from({length:i.y},()=>Array(i.z).fill(!1))));const s=(l,p)=>{const y=X(p),m={x:l.x+y.x-1,y:l.y+y.y-1,z:l.z+y.z-1},g=it(p),x=Y(p),b=new Set;b.add(p);const k=I=>{const P=new Set;let T=!1;for(let{x:v}=l;v<=I.x;v++)for(let{y:R}=l;R<=I.y;R++)for(let{z:E}=l;E<=I.z;E++){const M=n.get({x:v,y:R,z:E});let Q=!1,ne=!1;if(M)for(const[,q]of M)Y(q)===x?(Q=!0,P.add(q)):nt(q)&&q.type!=="wall"&&(ne=!0);ne&&!Q&&(T=!0),(!M||M.size===0)&&(T=!0),Q||(T=!0)}if(T)return!1;let O=!1;for(const v of P)b.has(v)||(O=!0,b.add(v));if(!O)return!1;for(const v of P){const R=X(v),E={x:v.position.x+R.x-1,y:v.position.y+R.y-1,z:v.position.z+R.z-1};if(v.position.x<l.x||v.position.y<l.y||v.position.z<l.z||E.x>I.x||E.y>I.y||E.z>I.z)return!1}return!0};let z=!0;for(;z;){if(z=!1,g.x>0&&m.x+1<c.x+i.x){let I=m.x;for(let{y:P}=l;P<=m.y;P++)for(let{z:T}=l;T<=m.z;T++){const O=n.get({x:m.x+1,y:P,z:T});if(O){for(const[,v]of O)if(Y(v)===x){const R=X(v),E=v.position.x+R.x-1;I=Math.max(I,E)}}}I>m.x&&k({...m,x:I})&&(m.x=I,z=!0)}if(g.y>0&&m.y+1<c.y+i.y){let I=m.y;for(let{x:P}=l;P<=m.x;P++)for(let{z:T}=l;T<=m.z;T++){const O=n.get({x:P,y:m.y+1,z:T});if(O){for(const[,v]of O)if(Y(v)===x){const R=X(v),E=v.position.y+R.y-1;I=Math.max(I,E)}}}I>m.y&&k({...m,y:I})&&(m.y=I,z=!0)}if(g.z>0&&m.z+1<c.z+i.z){let I=m.z;for(let{x:P}=l;P<=m.x;P++)for(let{y:T}=l;T<=m.y;T++){const O=n.get({x:P,y:T,z:m.z+1});if(O){for(const[,v]of O)if(Y(v)===x){const R=X(v),E=v.position.z+R.z-1;I=Math.max(I,E)}}}I>m.z&&k({...m,z:I})&&(m.z=I,z=!0)}}return m},f=(l,p)=>{if(l.type==="wall"){if(p.type!=="wall")throw new Error("only walls can join walls");if(l.config.direction!==p.config.direction)throw new Error("walls must have the same direction to join");return l.config.direction==="right"||l.config.direction==="towards"?l:{...l,config:{...l.config,tiles:[...l.config.tiles,...p.config.tiles]}}}return l},d=({x:l,y:p,z:y},{x:m,y:g,z:x},b)=>{const[k,z]=b,I=Y(z),P=m-l+1,T=g-p+1,O=x-y+1;let v=z;if(P+T+O>3){const R={...z.config};if(z.type==="wall")switch(z.config.direction){case"away":case"left":break;case"towards":P!==1&&(R.times={x:P});break;case"right":T!==1&&(R.times={y:T});break}else{const E={...Kt(X(z))};P!==1&&(E.x=P),T!==1&&(E.y=T),O!==1&&(E.z=O),R.times=E}v={...z,config:R}}for(let R=l;R<=m;R++)for(let E=p;E<=g;E++)for(let M=y;M<=x;M++)if(a.get(I)[R-c.x][E-c.y][M-c.z]=!0,R!==l||E!==p||M!==y){const Q=n.get({x:R,y:E,z:M});if(Q)e:for(const ne of Q){const[,q]=ne;if(Y(q)===I){q.position.x===R&&q.position.y===E&&q.position.z===M&&(v=f(v,q)),n.remove({x:R,y:E,z:M},ne);break e}}}return[k,v]};for(const[l,p]of n.iterate())for(const y of p){const[,m]=y;if(m.position.x===l.x&&m.position.y===l.y&&m.position.z===l.z){const g=Y(m),x=a.get(g),b=l.x-c.x,k=l.y-c.y,z=l.z-c.z;if(x&&!x[b][k][z]){const I=s(l,m),P=d(l,I,y);n.remove(l,y),n.add(l,P)}}}return[...n.extractUniqueItems(),...r]},so=(e,t)=>Object.fromEntries(Pn(Object.entries(e),t)),ao=(e,t)=>{const o=F(e);o.items=so(o.items,t);const r=e.selectedJsonItemIds.filter(n=>o.items[n]!==void 0);r.length!==e.selectedJsonItemIds.length&&(e.selectedJsonItemIds=r)},On=e=>e.type==="door",Cn=e=>e.type==="monster"&&e.config.which==="cyberman",Fn={applyItemTool(e,{payload:{blockPosition:t,pointedAtItemJson:o,preview:r}}){const n=e,{tool:i}=n;if(i.type!=="item")throw new Error("applying item tool reducer while the current tool is not an item tool");switch(r||(Z(n),n.previewedEdits={}),n.selectedJsonItemIds=[],!0){case On(i.item):{if(o.type!=="wall")throw new Error("doors can only be added on walls");zn(n,t,o.config.direction,i.item,r);break}case(Cn(i.item)&&o.type==="deadlyBlock"&&o.config.style==="toaster"&&o.position.z+1===t.z):{Ye(n,{...i.item,config:{...i.item.config,activated:"off"}},t,r);break}default:Ye(n,i.item,t,r)}r||ao(n,c=>c.type==="wall")}},Nn={changeDragInProgress(e,{payload:t}){const o=e;o.dragInProgress=t}},$n={changeGridResolution(e,{payload:t}){const o=e;o.gridResolution=t},changeWallsFloorsLocked(e,{payload:t}){const o=e;o.wallsFloorsLocked=t}},Wn={setSelectedItemsInRoom(e,{payload:{jsonItemIds:t}}){const o=F(e).items;t.forEach(r=>{if(!o[r])throw new Error(`Item with json item id "${r}" is not in the current room`)}),e.selectedJsonItemIds=t},toggleSelectedItemInRoom(e,{payload:{jsonItemId:t}}){const o=e.selectedJsonItemIds.indexOf(t);o===-1?e.selectedJsonItemIds.push(t):e.selectedJsonItemIds.splice(o,1)},setHoveredItemInRoom(e,t){e.hoveredItem=t.payload},setClickableAnnotationHovered(e,t){e.clickableAnnotationHovered=t.payload}},Bn=(e,...t)=>({x:e(...t.map(o=>o.x)),y:e(...t.map(o=>o.y)),z:e(...t.map(o=>o.z))}),_t=(e,t,o)=>{const r=o-e.length;r>0?e.push(...ae(t,r,e.length)):r<0&&e.splice(o)};function*co(e,t){const o={type:"wall",config:Zt(e.config.direction)?e.config.direction==="towards"?{direction:e.config.direction,times:{x:2}}:{direction:e.config.direction,times:{y:2}}:{direction:e.config.direction,tiles:[...ae(t.planet,2,e.position[e.config.direction==="away"?"x":"y"])]},position:{...e.position,z:0}};yield[rt(t,o,!1),o]}function lo(e,t){const o=de(e.config),r=h(t.position,t.config.times);switch(e.config.direction){case"towards":if(e.position.y===t.position.y&&e.position.x>=t.position.x&&e.position.x<r.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:o.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===t.position.x&&o.x===t.config.times.x,wallTouchesFloorEnd:e.position.x+(o.x??1)===r.x};break;case"right":if(e.position.x===t.position.x&&e.position.y>=t.position.y&&e.position.y<r.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:o.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===t.position.y&&o.y===t.config.times.y,wallTouchesFloorEnd:e.position.y+(o.y??1)===r.y};break;case"away":if(e.position.y===t.position.y+t.config.times.y&&e.position.x>=t.position.x&&e.position.x<r.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:o.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===t.position.x&&o.x===t.config.times.x,wallTouchesFloorEnd:e.position.x+(o.x??1)===r.x};break;case"left":if(e.position.x===t.position.x+t.config.times.x&&e.position.y>=t.position.y&&e.position.y<r.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:o.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===t.position.y&&o.y===t.config.times.y,wallTouchesFloorEnd:e.position.y+(o.y??1)===r.y};break}return null}function*uo(e,t,o,r,n){const i=h(t.position,r),c=t.config.times,a=n?h(c,n):t.config.times,u=h(t.position,c),s=h(i,a);for(const[f,d]of D(e)){if(d.type==="wall"&&d.position.z!==t.position.z)continue;if(d.type==="door"){const m=d.config;let g=!1,x={...L(d.position)};switch(m.direction){case"towards":d.position.y===t.position.y&&d.position.x>=t.position.x&&d.position.x<t.position.x+c.x&&(g=!0,x=h(d.position,r));break;case"right":d.position.x===t.position.x&&d.position.y>=t.position.y&&d.position.y<t.position.y+c.y&&(g=!0,x=h(d.position,r));break;case"away":d.position.y===t.position.y+c.y&&d.position.x>=t.position.x&&d.position.x<t.position.x+c.x&&(g=!0,x=h(d.position,{x:r.x,y:r.y+(n?.y??0),z:r.z}));break;case"left":d.position.x===t.position.x+c.x&&d.position.y>=t.position.y&&d.position.y<t.position.y+c.y&&(g=!0,x=h(d.position,{x:r.x+(n?.x??0),y:r.y,z:r.z}));break}if(g){const b=structuredClone(L(d));b.position=x,yield[f,b]}continue}const l=d,p=lo(l,t);if(!p||!p.isOnFloorEdge)continue;const y=structuredClone(L(l));switch(l.config.direction){case"towards":case"right":y.position=h(l.position,r);break;case"away":{const m=i.y+a.y;y.position={...l.position,x:l.position.x+r.x,y:m};break}case"left":{const m=i.x+a.x;y.position={...l.position,x:m,y:l.position.y+r.y};break}}if(p.wallFullySpansFloor){const m=a[p.tangentAxis];l.config.direction==="away"||l.config.direction==="left"?_t(y.config.tiles,o,m):y.config.times={[p.tangentAxis]:m},yield[f,y]}else{const m=t.position[p.tangentAxis],g=u[p.tangentAxis],x=i[p.tangentAxis],b=s[p.tangentAxis],k=y.position[p.tangentAxis];if(k>=b){yield[f,null];continue}const z=Math.max(p.wallStart,m),P=Math.min(p.wallStart+p.wallLength,g)-z;let T;if(l.config.direction==="away"||l.config.direction==="left"){const E=t.position[p.normalAxis]+c[p.normalAxis],M=i[p.normalAxis]+a[p.normalAxis];T=E!==M}else T=t.position[p.normalAxis]!==i[p.normalAxis];const O=Math.max(k,x);let v;p.wallTouchesFloorEnd&&!T?v=b:v=Math.min(k+P,b);const R=v-O;R<=0?yield[f,null]:(l.config.direction==="away"||l.config.direction==="left"?_t(y.config.tiles,o,R):y.config.times={[p.tangentAxis]:R},yield[f,y])}}}function*Mn(e,t,o,r){for(const[n,i]of J(e.items,"floor")){const c=lo(t,i);if(!c)continue;const a={x:0,y:0,z:0},u={x:0,y:0,z:0},s=o[c.normalAxis],f=o[c.tangentAxis],d=r?r[c.tangentAxis]:0;if(s!==0&&(t.config.direction==="towards"||t.config.direction==="right"?(a[c.normalAxis]=s,u[c.normalAxis]=-s):u[c.normalAxis]=s),f!==0&&(c.wallStart===i.position[c.tangentAxis]?(a[c.tangentAxis]=f,u[c.tangentAxis]=-f):c.wallTouchesFloorEnd&&(u[c.tangentAxis]=f)),d!==0&&c.wallTouchesFloorEnd&&(u[c.tangentAxis]=d),a.x!==0||a.y!==0||u.x!==0||u.y!==0){const l=h(i.config.times,u),p={...i,position:h(i.position,a),config:{...i.config,times:{x:l.x,y:l.y}}};yield[n,p]}yield*uo(J(e.items,"wall","door"),i,e.planet,a,u)}}const _n={moveOrResizeItemAsPreview(e,{payload:{jsonItemIds:t,timesDelta:o,positionDelta:r}}){const n=e,i=F(n);for(const c of t){const a=to(n,c);if(a===void 0)throw new Error(`no json item found for some of the ids in resize ${c}`);if(a.type==="wall"){for(const[s,f]of Mn(i,a,r,o))n.previewedEdits[s]=f;continue}if(a.type==="floor")for(const[s,f]of uo(J(i.items,"wall","door"),a,i.planet,r,o))n.previewedEdits[s]=f;if(a.type==="door"){console.log("before healing, room items are",L(i.items));for(const[s,f]of co(a,L(i)))console.log("healing",`"${s}"`,f),n.previewedEdits[s]=f}const u={...a,position:h(a.position,r),config:{...a.config}};if(n.previewedEdits[c]=u,Hn(u,o),a.type==="door"){console.log("before cutting room plus previews is",{...L(i.items),...L(n.previewedEdits)});for(const[s,f]of io({...L(i.items),...L(n.previewedEdits)},u.config.direction,u.position))console.log("cutting",`"${s}"`,f),n.previewedEdits[s]=f}}n.dragInProgress=!0}},Hn=(e,t)=>{if(t!==void 0){const o=X(e),r=it(e),n=Ao(t,r);if(Ue(n)>0){const i=Kt(Bn((c,a)=>Math.max(1,c+a),o,n));i===void 0?delete e.config.times:e.config.times=i}}},Xn=(e,t)=>{const o=e.items[t];if(o.type==="door"){for(const[r,n]of co(o,e))e.items[r]=n;e.items=so(e.items)}delete e.items[t]},Dn=(e,t)=>{const o=e.currentlyEditingRoomId,r=F(e);for(const n of Ee(e.campaignInProgress.rooms)){tt(n).filter(c=>c.type==="door"||c.type==="teleporter").filter(c=>c.config.toRoom===o).forEach(c=>{c.config.toRoom=t});const i=n.meta?.nonContiguousRelationship?.with;i?.room===o&&(i.room=t)}e.campaignInProgress.rooms[t]={...r,id:t},delete e.campaignInProgress.rooms[o],e.currentlyEditingRoomId=t},Ht=(e,t)=>{tt(e).filter(o=>o.type==="floor").filter(o=>o.position.z===0).forEach(o=>{o.config={...o.config,floorType:t,scenery:t==="standable"?e.planet:void 0}})},qn={changeRoomColour(e,{payload:t}){const o=e,r=o.campaignInProgress.rooms[o.currentlyEditingRoomId].color;Z(o),Object.assign(r,t)},changeRoomScenery(e,{payload:t}){const o=e,r=F(o);Z(o),ro(r,t)},roomJsonEdited(e,{payload:t}){const o=e;Z(o);const{rooms:r}=o.campaignInProgress,n=r[o.currentlyEditingRoomId];r[o.currentlyEditingRoomId]=t;const i=o.selectedJsonItemIds.filter(u=>t.items[u]!==void 0);i.length!==o.selectedJsonItemIds.length&&(o.selectedJsonItemIds=i),t.id!==o.currentlyEditingRoomId&&Dn(o,t.id);const c=n.meta?.nonContiguousRelationship,a=t.meta?.nonContiguousRelationship;if(a!==void 0){const u=r[a.with.room];u.meta={...u.meta,nonContiguousRelationship:{with:{room:t.id},gridOffset:Je(a.gridOffset,-1)}}}c!==void 0&&r[c.with.room]},deleteSelected(e){const t=e,o=F(t);Z(t),t.selectedJsonItemIds.forEach(r=>{Xn(o,r)}),t.selectedJsonItemIds=[]},clearRoom(e){const t=e,o=F(t);Z(t);for(const r of Qe(o.items)){const n=o.items[r];n.type!=="floor"&&n.type!=="wall"&&n.type!=="door"&&(delete o.items[r],t.selectedJsonItemIds=t.selectedJsonItemIds.filter(i=>i!==r))}},setRoomAboveOrBelow(e,{payload:t}){const o=e,r=t.direction==="above"?"roomAbove":"roomBelow",n=r==="roomAbove"?"roomBelow":"roomAbove",i=F(o),c=t.createNew?ot(o,i.planet,i.color).id:t.roomId,a=i[r]&&Le(o,i[r]);a?.[n]===o.currentlyEditingRoomId&&(a[n]=void 0),i[r]=c;const u=c&&Le(o,c);u!==void 0&&(u[n]=i.id),u?Ht(r==="roomBelow"?i:u,"none"):Ht(r==="roomBelow"?i:a,"standable")}},Ln=(e,t)=>{const o=Ke(t);for(const[r,n]of o)n===null?delete e.items[r]:e.items[r]=n},Yn={setAutoCoalesce(e,t){e.autoCoalesce=t.payload},resetPreviewedEdits(e){e.previewedEdits={}},commitCurrentPreviewedEdits(e){Z(e),Ln(F(e),e.previewedEdits),e.autoCoalesce&&ao(e),e.previewedEdits={}}},st="room_0",Jn={id:st,...oo({x:8,y:8})},Xt={name:"new campaign",rooms:{[st]:Jn}},at={campaignInProgress:Xt,savedCampaign:Xt,currentlyEditingRoomId:st,editingRoomIdHistory:{back:[],forward:[]},previewedEdits:{},tool:{type:"pointer"},hoveredItem:void 0,clickableAnnotationHovered:!1,selectedJsonItemIds:[],gridResolution:1,autoCoalesce:!0,wallsFloorsLocked:!0,dragInProgress:!1,history:{undo:[],redo:[]}},Gn={loadCampaign(e,{payload:{campaign:t}}){const o=e;o.savedCampaign=t,o.campaignInProgress=t,o.hoveredItem=void 0,o.selectedJsonItemIds=[],o.clickableAnnotationHovered=!1,o.dragInProgress=!1,o.history=at.history;const r=_e(Qe(t.rooms));if(r===void 0)throw new Error("could not find any rooms in this campaign");o.currentlyEditingRoomId=r},campaignSaved(e,{payload:{campaign:t}}){const o=e;o.savedCampaign=t}},Re=(e,t,o=!1)=>{if(!e.campaignInProgress.rooms[t]){console.warn(`can't change to room ${t} - it doesn't exist`);return}o||e.editingRoomIdHistory.back.push(e.currentlyEditingRoomId),e.currentlyEditingRoomId=t,e.clickableAnnotationHovered=!1,e.hoveredItem=void 0,e.selectedJsonItemIds=[],o||(e.history=at.history)},Vn={addRoom(e){const t=e.campaignInProgress.rooms[e.currentlyEditingRoomId],o=ot(e,t.planet);Re(e,o.id)},removeRoom(e){const t=e.campaignInProgress.rooms[e.currentlyEditingRoomId],r=_e(J(t.items,"door","teleporter"))?.[1].config.toRoom??_e(rr(n=>n!==e.currentlyEditingRoomId,To(e.campaignInProgress.rooms)));r!==void 0&&(delete e.campaignInProgress.rooms[e.currentlyEditingRoomId],e.currentlyEditingRoomId=r)}},Un={changeToRoom(e,{payload:t}){Re(e,t)},roomBack(e){const t=e,{editingRoomIdHistory:o}=t;if(o.back.length===0)return;const r=o.back.pop();Re(t,r,!0),o.forward.push(t.currentlyEditingRoomId)},roomForward(e){const t=e,{editingRoomIdHistory:o}=t;if(o.forward.length===0)return;const r=o.forward.pop();Re(t,r,!0),o.back.push(t.currentlyEditingRoomId)}},Zn=[1,.5,.125],ct=Po({name:"levelEditor",initialState:at,reducers:{setTool(e,{payload:t}){const o=e;t.type==="item"&&(o.selectedJsonItemIds=[]),o.tool=t},injected(){},...$n,...ln,...Fn,...Nn,...Wn,...qn,..._n,...Yn,...Gn,...Vn,...Un},selectors:{selectCurrentCampaignInProgress:e=>e.campaignInProgress,selectCurrentEditingRoomJson:F,selectItem:to,selectCurrentEditingRoomColour:e=>F(e).color,selectCurrentEditingRoomScenery:e=>F(e).planet,selectTool:e=>e.tool,selectSelectedJsonItemIds:e=>e.selectedJsonItemIds,selectHoveredItem:e=>e.hoveredItem,selectItemIsSelected:cn,...dn}}),{addRoom:Kn,applyItemTool:Qn,campaignSaved:jn,changeDragInProgress:ei,changeGridResolution:ti,changeRoomColour:oi,changeRoomScenery:ri,changeToRoom:ni,changeWallsFloorsLocked:ii,clearRoom:si,commitCurrentPreviewedEdits:ai,deleteSelected:ci,injected:li,loadCampaign:di,moveOrResizeItemAsPreview:ui,redo:fi,removeRoom:yi,resetPreviewedEdits:pi,roomBack:mi,roomJsonEdited:gi,setAutoCoalesce:hi,setClickableAnnotationHovered:bi,setHoveredItemInRoom:xi,setRoomAboveOrBelow:vi,setSelectedItemsInRoom:wi,setTool:Ii,toggleSelectedItemInRoom:Ri,undo:zi,roomForward:ki}=ct.actions,{selectCanRedo:Ei,selectCanUndo:Ai,selectCurrentCampaignInProgress:Ti,selectCurrentEditingRoomColour:Pi,selectCurrentEditingRoomJson:Si,selectCurrentEditingRoomScenery:Oi,selectHoveredItem:Ci,selectItem:Fi,selectItemIsSelected:Ni,selectSelectedJsonItemIds:$i,selectTool:Wi}=ct.selectors,Bi=So.withTypes(),ns=Object.freeze(Object.defineProperty({__proto__:null,addRoom:Kn,applyItemTool:Qn,campaignSaved:jn,changeDragInProgress:ei,changeGridResolution:ti,changeRoomColour:oi,changeRoomScenery:ri,changeToRoom:ni,changeWallsFloorsLocked:ii,clearRoom:si,commitCurrentPreviewedEdits:ai,deleteSelected:ci,gridResolutions:Zn,injected:li,levelEditorSlice:ct,loadCampaign:di,moveOrResizeItemAsPreview:ui,redo:fi,removeRoom:yi,resetPreviewedEdits:pi,roomBack:mi,roomForward:ki,roomJsonEdited:gi,selectCanRedo:Ei,selectCanUndo:Ai,selectCurrentCampaignInProgress:Ti,selectCurrentEditingRoomColour:Pi,selectCurrentEditingRoomJson:Si,selectCurrentEditingRoomScenery:Oi,selectHoveredItem:Ci,selectItem:Fi,selectItemIsSelected:Ni,selectSelectedJsonItemIds:$i,selectTool:Wi,setAutoCoalesce:hi,setClickableAnnotationHovered:bi,setHoveredItemInRoom:xi,setRoomAboveOrBelow:vi,setSelectedItemsInRoom:wi,setTool:Ii,toggleSelectedItemInRoom:Ri,undo:zi,useAppSelectorWithLevelEditorSlice:Bi},Symbol.toStringTag,{value:"Module"}));export{nn as $,Ci as A,$i as B,Wi as C,os as D,$ as E,He as F,Xi as G,Di as H,$r as I,Qi as J,we as K,to as L,pi as M,Qn as N,Ii as O,X as P,it as Q,Bn as R,xi as S,Fi as T,Ni as U,wi as V,nt as W,ui as X,Ri as Y,ai as Z,ur as _,qi as a,an as a0,ei as a1,rs as a2,Bi as a3,Xo as a4,Jo as a5,ci as a6,Zn as a7,ti as a8,Pi as a9,fn as aA,cr as aB,pn as aC,j as aD,gi as aE,ns as aF,oi as aa,Oi as ab,ri as ac,Ai as ad,Ei as ae,zi as af,fi as ag,ii as ah,Si as ai,ae as aj,si as ak,F as al,vi as am,Ti as an,jn as ao,di as ap,Kn as aq,yi as ar,Hn as as,jt as at,rr as au,es as av,mi as aw,ki as ax,hi as ay,ts as az,wr as b,qe as c,ji as d,w as e,br as f,et as g,Yi as h,N as i,Ji as j,tn as k,Hi as l,kr as m,B as n,Ui as o,U as p,Vi as q,Zi as r,Gi as s,Ki as t,zr as u,je as v,de as w,Li as x,ni as y,bi as z};
