import{a5 as T,a6 as ee,a7 as J,a8 as A,a9 as B,aa as x,ab as F,ac as Le,ad as ro,ae as q,af as Be,ag as Ge,ah as no,ai as io,aj as so,ak as ao,al as co,am as M,an as lo,ao as be,ap as G,aq as je,ar as uo,as as fo,at as De,au as yo,av as Xe,aw as mo,ax as po,ay as go}from"./index-CjUuaS1h.js";var j={},D={},Re;function ho(){if(Re)return D;Re=1;function e(d,y){var n;if(typeof Symbol>"u"||d[Symbol.iterator]==null){if(Array.isArray(d)||(n=o(d))||y){n&&(d=n);var s=0,i=function(){};return{s:i,n:function(){return s>=d.length?{done:!0}:{done:!1,value:d[s++]}},e:function(f){throw f},f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var c=!0,m=!1,p;return{s:function(){n=d[Symbol.iterator]()},n:function(){var f=n.next();return c=f.done,f},e:function(f){m=!0,p=f},f:function(){try{!c&&n.return!=null&&n.return()}finally{if(m)throw p}}}}function o(d,y){if(d){if(typeof d=="string")return t(d,y);var n=Object.prototype.toString.call(d).slice(8,-1);if(n==="Object"&&d.constructor&&(n=d.constructor.name),n==="Map"||n==="Set")return Array.from(d);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return t(d,y)}}function t(d,y){(y==null||y>d.length)&&(y=d.length);for(var n=0,s=new Array(y);n<y;n++)s[n]=d[n];return s}var r=T(),a=r.ensureIterable;function l(d){var y=[],n=e(d),s;try{for(n.s();!(s=n.n()).done;){var i=s.value;y.push(i)}}catch(c){n.e(c)}finally{n.f()}return y}D.__toArray=l;function u(d){return l(a(d))}return D.toArray=u,D}var Ee;function vo(){if(Ee)return j;Ee=1;var e=ee(),o=e.mark(u),t=T(),r=t.iterableCurry,a=ho(),l=a.__toArray;function u(y,n){var s;return e.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(s=Array.isArray(y)?y:l(y),s.length){c.next=3;break}return c.abrupt("return");case 3:if(!n--){c.next=7;break}return c.delegateYield(s,"t0",5);case 5:c.next=3;break;case 7:case"end":return c.stop()}},o)}j.__cycleTimes=u;var d=r(u);return j.cycleTimes=d,j}var X={},Ae;function wo(){if(Ae)return X;Ae=1;var e=ee(),o=e.mark(d);function t(n,s){var i;if(typeof Symbol>"u"||n[Symbol.iterator]==null){if(Array.isArray(n)||(i=r(n))||s){i&&(n=i);var c=0,m=function(){};return{s:m,n:function(){return c>=n.length?{done:!0}:{done:!1,value:n[c++]}},e:function(v){throw v},f:m}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,h=!1,f;return{s:function(){i=n[Symbol.iterator]()},n:function(){var v=i.next();return p=v.done,v},e:function(v){h=!0,f=v},f:function(){try{!p&&i.return!=null&&i.return()}finally{if(h)throw f}}}}function r(n,s){if(n){if(typeof n=="string")return a(n,s);var i=Object.prototype.toString.call(n).slice(8,-1);if(i==="Object"&&n.constructor&&(i=n.constructor.name),i==="Map"||i==="Set")return Array.from(n);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return a(n,s)}}function a(n,s){(s==null||s>n.length)&&(s=n.length);for(var i=0,c=new Array(s);i<s;i++)c[i]=n[i];return c}var l=T(),u=l.iterableCurry;function d(n,s){var i,c,m,p;return e.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:i=0,c=t(n),f.prev=2,c.s();case 4:if((m=c.n()).done){f.next=11;break}if(p=m.value,!s(p,i++)){f.next=9;break}return f.next=9,p;case 9:f.next=4;break;case 11:f.next=16;break;case 13:f.prev=13,f.t0=f.catch(2),c.e(f.t0);case 16:return f.prev=16,c.f(),f.finish(16);case 19:case"end":return f.stop()}},o,null,[[2,13,16,19]])}X.__filter=d;var y=u(d);return X.filter=y,X}var V={},ke;function Io(){if(ke)return V;ke=1;var e=T(),o=e.iterableCurry,t=vo(),r=t.__cycleTimes;function a(u){return r(u,1/0)}V.__cycle=a;var l=o(a);return V.cycle=l,V}var U={},Se;function xo(){if(Se)return U;Se=1;var e=ee(),o=e.mark(d);function t(n,s){var i;if(typeof Symbol>"u"||n[Symbol.iterator]==null){if(Array.isArray(n)||(i=r(n))||s){i&&(n=i);var c=0,m=function(){};return{s:m,n:function(){return c>=n.length?{done:!0}:{done:!1,value:n[c++]}},e:function(v){throw v},f:m}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,h=!1,f;return{s:function(){i=n[Symbol.iterator]()},n:function(){var v=i.next();return p=v.done,v},e:function(v){h=!0,f=v},f:function(){try{!p&&i.return!=null&&i.return()}finally{if(h)throw f}}}}function r(n,s){if(n){if(typeof n=="string")return a(n,s);var i=Object.prototype.toString.call(n).slice(8,-1);if(i==="Object"&&n.constructor&&(i=n.constructor.name),i==="Map"||i==="Set")return Array.from(n);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return a(n,s)}}function a(n,s){(s==null||s>n.length)&&(s=n.length);for(var i=0,c=new Array(s);i<s;i++)c[i]=n[i];return c}var l=T(),u=l.iterableCurry;function d(n,s){var i,c,m,p;return e.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:i=0,c=t(n),f.prev=2,c.s();case 4:if((m=c.n()).done){f.next=11;break}if(p=m.value,!(i++>=s)){f.next=9;break}return f.next=9,p;case 9:f.next=4;break;case 11:f.next=16;break;case 13:f.prev=13,f.t0=f.catch(2),c.e(f.t0);case 16:return f.prev=16,c.f(),f.finish(16);case 19:case"end":return f.stop()}},o,null,[[2,13,16,19]])}U.__drop=d;var y=u(d);return U.drop=y,U}var Y={},K={},Ce;function bo(){if(Ce)return K;Ce=1;var e=T(),o=e.iterableCurry,t=e.callReturn;function r(l,u){var d=l[Symbol.iterator](),y=d.next(),n=y.value,s=y.done;return s?u:(t(d),n)}K.__firstOr=r;var a=o(r,{reduces:!0});return K.firstOr=a,K}var Te;function Ro(){if(Te)return Y;Te=1;var e=T(),o=e.iterableCurry,t=bo(),r=t.__firstOr;function a(u){return r(u,void 0)}Y.__first=a;var l=o(a,{reduces:!0});return Y.first=l,Y}var Q={},Pe;function Eo(){if(Pe)return Q;Pe=1;var e=ee(),o=e.mark(d);function t(n,s){var i;if(typeof Symbol>"u"||n[Symbol.iterator]==null){if(Array.isArray(n)||(i=r(n))||s){i&&(n=i);var c=0,m=function(){};return{s:m,n:function(){return c>=n.length?{done:!0}:{done:!1,value:n[c++]}},e:function(v){throw v},f:m}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,h=!1,f;return{s:function(){i=n[Symbol.iterator]()},n:function(){var v=i.next();return p=v.done,v},e:function(v){h=!0,f=v},f:function(){try{!p&&i.return!=null&&i.return()}finally{if(h)throw f}}}}function r(n,s){if(n){if(typeof n=="string")return a(n,s);var i=Object.prototype.toString.call(n).slice(8,-1);if(i==="Object"&&n.constructor&&(i=n.constructor.name),i==="Map"||i==="Set")return Array.from(n);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return a(n,s)}}function a(n,s){(s==null||s>n.length)&&(s=n.length);for(var i=0,c=new Array(s);i<s;i++)c[i]=n[i];return c}var l=T(),u=l.iterableCurry;function d(n,s){var i,c,m,p;return e.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(s!==0){f.next=2;break}return f.abrupt("return");case 2:i=0,c=t(n),f.prev=4,c.s();case 6:if((m=c.n()).done){f.next=14;break}return p=m.value,f.next=10,p;case 10:if(++i!==s){f.next=12;break}return f.abrupt("break",14);case 12:f.next=6;break;case 14:f.next=19;break;case 16:f.prev=16,f.t0=f.catch(4),c.e(f.t0);case 19:return f.prev=19,c.f(),f.finish(19);case 22:case"end":return f.stop()}},o,null,[[4,16,19,22]])}Q.__take=d;var y=u(d);return Q.take=y,Q}var te,ze;function Ao(){return ze||(ze=1,te=Io().cycle),te}var ko=Ao();const So=J(ko);var re,Fe;function Co(){return Fe||(Fe=1,re=xo().drop),re}var To=Co();const Po=J(To);var ne,Oe;function zo(){return Oe||(Oe=1,ne=wo().filter),ne}var Fo=zo();const Oo=J(Fo);var ie,$e;function $o(){return $e||($e=1,ie=Ro().first),ie}var _o=$o();const ue=J(_o);var se,_e;function Wo(){return _e||(_e=1,se=Eo().take),se}var qo=Wo();const Mo=J(qo),R=e=>e.campaignInProgress.rooms[e.currentlyEditingRoomId],fe=(e,o)=>e.campaignInProgress.rooms[o],Ve=(e,o,t)=>e.campaignInProgress.rooms[t??e.currentlyEditingRoomId]?.items[o],Ho=(e,o)=>e.selectedJsonItemIds.includes(o),W=e=>{const o=structuredClone(A(R(e))),{history:t}=e;t.redo=[],t.undo.push(o)},No={undo(e){const o=e,{campaignInProgress:t,history:{undo:r,redo:a},currentlyEditingRoomId:l}=o;r.length!==0&&(a.push(t.rooms[l]),t.rooms[l]=r.pop())},redo(e){const o=e,{campaignInProgress:t,history:{redo:r,undo:a},currentlyEditingRoomId:l}=o;r.length!==0&&(a.push(t.rooms[l]),t.rooms[l]=r.pop())}},Jo={selectCanUndo:e=>e.history.undo.length>0,selectCanRedo:e=>e.history.redo.length>0},ae={x:1,y:0,z:0},ce={x:-1,y:0,z:0},le={x:0,y:-1,z:0},de={x:0,y:1,z:0},H={away:de,left:ae,right:ce,towards:le,down:{x:0,y:0,z:-1},up:{x:0,y:0,z:1},awayRight:B(x(de,ce)),towardsRight:B(x(le,ce)),towardsLeft:B(x(le,ae)),awayLeft:B(x(de,ae))},Lo=(e,o,t)=>{if(o==="*")return!0;const r=t.meta.subRooms[o];return e.x>=r.physicalPosition.from.x&&e.y>=r.physicalPosition.from.y&&e.x<=r.physicalPosition.to.x&&e.y<=r.physicalPosition.to.y},Bo=({position:e},o,t)=>Lo(e,o,t),Z=(e,o,t,r)=>o.some(a=>a.config.direction===e)?"doorway":t===void 0?"wall":Object.values(t).some(({gridPosition:a})=>no(H[e],io(a,r)))?"open":"wall";function*_(e){try{yield*Go(e)}catch(o){const t=o;throw new Error(`
  error in recursion ${e.roomId}/${e.subRoomId??"*"}`,{cause:t})}}function*Go({roomId:e,subRoomId:o="*",campaign:t,visited:r={},vectorFromPrevious:a,previousRoomGridPosition:l=q}){if(e==="nowhere"||r[e]?.[o])return;r[e]===void 0&&(r[e]={}),r[e][o]=!0;const u=t.rooms[e];if(u===void 0)throw new Error(`no room in the campaign with id="${e}"`);const d=[...F(Le(u.items)).filter(m=>m.type==="door").filter(m=>Bo(m,o,u))],y=x(l,a===void 0?ro:a),n=u.meta?.subRooms;if(n){if(o==="*")throw new Error(`subRoomId '*' means 'all' and is not allowed for big rooms. Must be one of the sub-rooms in ${e}: ${Object.keys(n)}`);if(!n[o])throw new Error(`Sub-room ${o} not found in room ${e}. Available sub-rooms: ${Object.keys(n)}`)}const s=n?.[o].gridPosition,i={left:Z("left",d,n,s),right:Z("right",d,n,s),away:Z("away",d,n,s),towards:Z("towards",d,n,s)};if(yield{roomId:e,subRoomId:o,gridPosition:y,boundaries:i},n!==void 0){if(s===void 0)throw new Error(`Sub-room ${o} not found in room ${e}. Available sub-rooms: ${Object.keys(n)}`);for(const[m,{gridPosition:p}]of F(Be(n)))m!==o&&(yield*_({roomId:e,subRoomId:m,campaign:t,visited:r,vectorFromPrevious:Ge({...p,z:0},s),previousRoomGridPosition:y}))}if(u.roomAbove!==void 0){const{roomAbove:m,subRoomAbove:p}=u;yield*_({roomId:m,subRoomId:p,campaign:t,visited:r,vectorFromPrevious:H.up,previousRoomGridPosition:y})}if(u.roomBelow!==void 0){const{roomBelow:m,subRoomBelow:p}=u;yield*_({roomId:m,subRoomId:p,campaign:t,visited:r,vectorFromPrevious:H.down,previousRoomGridPosition:y})}for(const m of d){const{toRoom:p}=m.config;yield*_({roomId:p,campaign:t,visited:r,subRoomId:m.config.meta?.toSubRoom,vectorFromPrevious:H[m.config.direction],previousRoomGridPosition:y})}const c=u.meta?.nonContiguousRelationship;if(c!==void 0){const{with:{room:m},gridOffset:p}=c;yield*_({roomId:m,campaign:t,visited:r,subRoomId:"*",vectorFromPrevious:p,previousRoomGridPosition:y})}}const jo={jail:["bars"],blacktooth:["plain","plain","armour","shield","shield","armour"],bookworld:["book","book","cowboy"],egyptus:["hieroglyphics","hieroglyphics","hieroglyphics","sarcophagus","sarcophagus"],market:["passage","more-fruits","fruits","more-fruits","fruits"],moonbase:["coil","window1","window2","window3"],penitentiary:["loop","loop","skeleton"],safari:["wall","shield","wall","window","window","wall","shield"]},N=(e,o,t=0)=>{const r=So(jo[e]);return Po(t,Mo(o+t,r))},Do=e=>({awayWall:{type:"wall",config:{direction:"away",tiles:Array.from(N("blacktooth",e.x))},position:{x:0,y:e.y,z:0}},leftWall:{type:"wall",config:{direction:"left",tiles:Array.from(N("blacktooth",e.y))},position:{x:e.x,y:0,z:0}},towardsWall:{type:"wall",config:{direction:"towards",times:{x:e.x}},position:{x:0,y:0,z:0}},rightWall:{type:"wall",config:{direction:"right",times:{y:e.y}},position:{x:0,y:0,z:0}}}),Ue=e=>({planet:"blacktooth",color:{hue:"cyan",shade:"basic"},items:{floor:{type:"floor",config:{floorType:"standable",scenery:"blacktooth",times:e},position:{x:0,y:0,z:0}},...Do(e)}}),Ye=(e,o)=>{e.planet=o;for(const t of Object.values(e.items))t.type==="floor"&&t.config.floorType==="standable"&&(t.config.scenery=o),t.type==="wall"&&(t.config.direction==="away"||t.config.direction==="left")&&(t.config.tiles=Array.from(N(o,t.config.tiles.length))),t.type==="pickup"&&t.config.gives==="crown"&&so.includes(o)&&(t.config.planet=o)},Xo=e=>e[Math.floor(Math.random()*e.length)],pe=(e,o,t)=>{const a=`room_${F(ao({start:0})).find(d=>e.campaignInProgress.rooms[`room_${d}`]===void 0)}`,l=t??{hue:Xo(co),shade:Math.random()<.66?"basic":"dimmed"},u={id:a,...structuredClone(Ue({x:8,y:8})),color:l};return Ye(u,o),e.campaignInProgress.rooms[a]=u,u},ge=(e,o,t)=>{if(o.type==="player"){const{which:a}=o.config;return t?`preview-${a}`:a}const r=o.type==="monster"?o.config.which:o.type;for(let a=1;;a++){const l=a===1?r:`${r}_${a}`;if(!e.items[l])return l}},ye=(e,o,t,r)=>{const a=R(e),l=ge(a,o,r),u=Ke(e,r),d={type:o.type,config:o.config,position:t};return u[l]=d,[l,d]},Ke=(e,o,t=e.currentlyEditingRoomId)=>o?e.previewedEdits:e.campaignInProgress.rooms[t].items,Vo=["head","heels"],Uo=[...Vo,"headOverHeels"],b=(...e)=>o=>e.includes(o.type),Yo=b("bubbles","stopAutowalk","firedDoughnut","floatingText","emitter","particle"),Ko=(e,o)=>Yo(e)||it(e)&&(o!==void 0&&ot(o)||e.config.direction.z!==0)||at(e)&&e.config.floorType==="none",Fr=(e,o)=>!Ko(e,o),Qo=["ball","slidingBlock","slidingDeadly"];b(...Qo);const Zo=["portableBlock","spring","sceneryPlayer","sceneryCrown","monster","slidingBlock"],et=["dalek","turtle","elephantHead","homingBot","helicopterBug"],Or=e=>e.type==="slidingBlock"?e.config.style==="puck":e.type==="monster"?et.includes(e.config.which):Zo.includes(e.type),ot=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function $r(e){return tt.includes(e.type)}const tt=[...Uo,"monster","ball","charles","pushableBlock","movingPlatform","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer","sceneryCrown"],rt=["monster","deadlyBlock","moveableDeadly","slidingDeadly"];b(...rt);const nt=e=>e.config.times!==void 0,it=b("portal");b("teleporter");b("heels");b("head");b("heels","headOverHeels");b("head","headOverHeels");b("lift");b("emitter");const st=b("monster"),at=b("floor");b("pickup");b("spring");const _r=b("joystick");b("monster","movingPlatform");const Wr=e=>st(e)&&e.config.which==="cyberman"&&e.state.everActivated===!1,oe=e=>({x:e.direction==="away"?e.tiles.length:e.direction==="towards"?e.times?.x:1,y:e.direction==="left"?e.tiles.length:e.direction==="right"?e.times?.y:1}),qr=e=>e.type==="wall"?oe(e.config):nt(e)?e.config.times:void 0,We=(e=M)=>({x:e.x??1,y:e.y??1,z:e.z??1}),ct=e=>({x:e.x??1,y:e.y??1}),me=e=>{const o=t=>t.config.times!==void 0;return e.type==="wall"?We(oe(e.config)):o(e)?We(e.config.times):M},lt=e=>{const o={};let t=!1;return e.x!==1&&(o.x=e.x,t=!0),e.y!==1&&(o.y=e.y,t=!0),e.z!==1&&(o.z=e.z,t=!0),t?o:void 0};function*Qe(e,o,t){for(const r of Be(e)){const[a,l]=r;if(l===null||l.type!=="wall"||l.config.direction!==o)continue;const{position:u,config:d}=l,y=ct(oe(d)),n=lo(be(d.direction)),s=be(d.direction),i=Ge(t,u);if(i[s]!==0||i[n]<-1||i[n]>=y[n])continue;if(i[n]===0&&y[n]===2){yield[a,null];continue}const c=2+i[n];if(c===1||c===2){const v=G(l,w=>{w.position=x(u,{[n]:c});const I=w.config;switch(I.direction){case"towards":case"right":I.times[n]=y[n]-c;break;default:I.tiles=I.tiles.slice(c)}});yield[a,v];continue}const p=y[n]-i[n];if(p===2||p===1){const v=G(l,w=>{const I=w.config;switch(I.direction){case"towards":case"right":I.times[n]=y[n]-p;break;default:I.tiles=I.tiles.slice(0,-p)}});yield[a,v];continue}const f=G(l,v=>{const w=v.config;switch(w.direction){case"towards":case"right":w.times[n]=i[n];break;default:w.tiles=w.tiles.slice(0,i[n])}});yield[`${a}/beforeDoor`,f];const g=G(l,v=>{v.position={...u,[n]:t[n]+2};const w=v.config;switch(w.direction){case"towards":case"right":w.times[n]=y[n]-i[n]-2;break;default:w.tiles=w.tiles.slice(i[n]+2)}});yield[`${a}/afterDoor`,g],yield[a,null]}}const qe=(e,o,t,r,a)=>{const l=fe(e,o);if(l===void 0)throw new Error("can't cut hole in walls for a room that does not exist");const u=Ke(e,a,o);for(const[d,y]of Qe(l.items,t,r))a?u[d]=y:y===null?delete u[d]:u[d]=y},dt=e=>Le(e.items),ut=e=>je(e),ft=e=>F(dt(e)),C=(e,...o)=>{const t=F(ut(e));return o.length===0?t:t.filter(([,r])=>o.includes(r.type))},yt=({state:e,fromRoomJson:o,direction:t,isPreview:r,autoAddRooms:a})=>{const l=e.campaignInProgress,u=F(_({campaign:l,roomId:o.id})).find(({gridPosition:d})=>fo(d,H[t]));if(u)return l.rooms[u.roomId];if(!r)return a?pe(e,o.planet):void 0},mt=e=>C(e.items,"floor").reduce((o,[,t])=>{const r=t.position.y;return Math.min(o,r)},Number.POSITIVE_INFINITY),pt=e=>C(e.items,"floor").reduce((o,[,t])=>{const r=t.position.y+t.config.times.y;return Math.max(o,r)},Number.NEGATIVE_INFINITY),gt=e=>C(e.items,"floor").reduce((o,[,t])=>{const r=t.position.x;return Math.min(o,r)},Number.POSITIVE_INFINITY),ht=e=>C(e.items,"floor").reduce((o,[,t])=>{const r=t.position.x+t.config.times.x;return Math.max(o,r)},Number.NEGATIVE_INFINITY),vt=(e,o,t,r,a)=>{const l=R(e),u=t;qe(e,l.id,u,o,a);const d=r.config.toRoom==="+";console.log("autoAddRooms:",d);const y=yt({state:e,fromRoomJson:l,direction:u,isPreview:a,autoAddRooms:d}),[n,s]=ye(e,{type:"door",config:{...r.config,toRoom:y?y.id:r.config.toRoom,direction:u}},o,a);if(!a&&y){const i=ge(y,r,a),c={x:u==="left"?gt(y):u==="right"?ht(y):o.x,y:u==="away"?mt(y):u==="towards"?pt(y):o.y,z:o.z},m=uo(u),p={type:"door",config:{toRoom:l.id,direction:m},position:c};y.items[i]=p,p.config.toDoor=n,s.config.toDoor=i,qe(e,y.id,m,c,!1)}},wt=e=>e.type==="door",It=e=>e.type==="monster"&&e.config.which==="cyberman",xt={applyItemTool(e,{payload:{blockPosition:o,pointedAtItemJson:t,preview:r}}){const a=e,{tool:l}=a;if(l.type!=="item")throw new Error("applying item tool reducer while the current tool is not an item tool");switch(r||(W(a),a.previewedEdits={}),a.selectedJsonItemIds=[],!0){case wt(l.item):{if(t.type!=="wall")throw new Error("doors can only be added on walls");vt(a,o,t.config.direction,l.item,r);break}case(It(l.item)&&t.type==="deadlyBlock"&&t.config.style==="toaster"&&t.position.z+1===o.z):{ye(a,{...l.item,config:{...l.item.config,activated:"off"}},o,r);break}default:ye(a,l.item,o,r)}}},bt={changeDragInProgress(e,{payload:o}){const t=e;t.dragInProgress=o}},Rt={changeGridResolution(e,{payload:o}){const t=e;t.halfGridResolution=o},changeWallsFloorsLocked(e,{payload:o}){const t=e;t.wallsFloorsLocked=o}},Et={setSelectedItemsInRoom(e,{payload:{jsonItemIds:o}}){e.selectedJsonItemIds=o},toggleSelectedItemInRoom(e,{payload:{jsonItemId:o}}){const t=e.selectedJsonItemIds.indexOf(o);t===-1?e.selectedJsonItemIds.push(o):e.selectedJsonItemIds.splice(t,1)},setHoveredItemInRoom(e,o){e.hoveredItem=o.payload},setClickableAnnotationHovered(e,o){e.clickableAnnotationHovered=o.payload}},At=e=>De(he(e))>0,he=e=>{switch(e.type){case"deadlyBlock":return M;case"conveyor":if(e.config.disappearing)return q;switch(e.config.direction){case"left":case"right":return{x:1,y:0,z:0};case"away":case"towards":return{x:0,y:1,z:0};default:throw e.config.direction,new Error}case"hushPuppy":return M;case"teleporter":return{x:1,y:1,z:0};case"floor":case"spikes":return{x:1,y:1,z:0};case"block":return e.config.disappearing?q:M;case"barrier":if(e.config.disappearing)return q;switch(e.config.axis){case"x":return{x:1,y:0,z:1};case"y":return{x:0,y:1,z:1};default:throw e.config.axis,new Error}case"wall":switch(e.config.direction){case"left":case"right":return{x:0,y:1,z:1};case"away":case"towards":return{x:1,y:0,z:1};default:throw e.config,new Error}default:return q}},kt=(e,...o)=>({x:e(...o.map(t=>t.x)),y:e(...o.map(t=>t.y)),z:e(...o.map(t=>t.z))}),Me=(e,o,t)=>{const r=t-e.length;r>0?e.push(...N(o,r,e.length)):r<0&&e.splice(t)},St=e=>e==="towards"||e==="right";function*Ze(e,o){const t={type:"wall",config:St(e.config.direction)?e.config.direction==="towards"?{direction:e.config.direction,times:{x:2}}:{direction:e.config.direction,times:{y:2}}:{direction:e.config.direction,tiles:[...N(o.planet,2,e.position[e.config.direction==="away"?"x":"y"])]},position:{...e.position,z:0}};yield[ge(o,t,!1),t]}function eo(e,o){const t=oe(e.config),r=x(o.position,o.config.times);switch(e.config.direction){case"towards":if(e.position.y===o.position.y&&e.position.x>=o.position.x&&e.position.x<r.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:t.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===o.position.x&&t.x===o.config.times.x,wallTouchesFloorEnd:e.position.x+(t.x??1)===r.x};break;case"right":if(e.position.x===o.position.x&&e.position.y>=o.position.y&&e.position.y<r.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:t.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===o.position.y&&t.y===o.config.times.y,wallTouchesFloorEnd:e.position.y+(t.y??1)===r.y};break;case"away":if(e.position.y===o.position.y+o.config.times.y&&e.position.x>=o.position.x&&e.position.x<r.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:t.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===o.position.x&&t.x===o.config.times.x,wallTouchesFloorEnd:e.position.x+(t.x??1)===r.x};break;case"left":if(e.position.x===o.position.x+o.config.times.x&&e.position.y>=o.position.y&&e.position.y<r.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:t.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===o.position.y&&t.y===o.config.times.y,wallTouchesFloorEnd:e.position.y+(t.y??1)===r.y};break}return null}function*oo(e,o,t,r,a){const l=x(o.position,r),u=o.config.times,d=a?x(u,a):o.config.times,y=x(o.position,u),n=x(l,d);for(const[s,i]of F(e)){if(i.type==="wall"&&i.position.z!==o.position.z)continue;if(i.type==="door"){const h=i.config;let f=!1,g={...A(i.position)};switch(h.direction){case"towards":i.position.y===o.position.y&&i.position.x>=o.position.x&&i.position.x<o.position.x+u.x&&(f=!0,g=x(i.position,r));break;case"right":i.position.x===o.position.x&&i.position.y>=o.position.y&&i.position.y<o.position.y+u.y&&(f=!0,g=x(i.position,r));break;case"away":i.position.y===o.position.y+u.y&&i.position.x>=o.position.x&&i.position.x<o.position.x+u.x&&(f=!0,g=x(i.position,{x:r.x,y:r.y+(a?.y??0),z:r.z}));break;case"left":i.position.x===o.position.x+u.x&&i.position.y>=o.position.y&&i.position.y<o.position.y+u.y&&(f=!0,g=x(i.position,{x:r.x+(a?.x??0),y:r.y,z:r.z}));break}if(f){const v=structuredClone(A(i));v.position=g,yield[s,v]}continue}const c=i,m=eo(c,o);if(!m||!m.isOnFloorEdge)continue;const p=structuredClone(A(c));switch(c.config.direction){case"towards":case"right":p.position=x(c.position,r);break;case"away":{const h=l.y+d.y;p.position={...c.position,x:c.position.x+r.x,y:h};break}case"left":{const h=l.x+d.x;p.position={...c.position,x:h,y:c.position.y+r.y};break}}if(m.wallFullySpansFloor){const h=d[m.tangentAxis];c.config.direction==="away"||c.config.direction==="left"?Me(p.config.tiles,t,h):p.config.times={[m.tangentAxis]:h},yield[s,p]}else{const h=o.position[m.tangentAxis],f=y[m.tangentAxis],g=l[m.tangentAxis],v=n[m.tangentAxis],w=p.position[m.tangentAxis];if(w>=v){yield[s,null];continue}const I=Math.max(m.wallStart,h),k=Math.min(m.wallStart+m.wallLength,f)-I;let E;if(c.config.direction==="away"||c.config.direction==="left"){const P=o.position[m.normalAxis]+u[m.normalAxis],xe=l[m.normalAxis]+d[m.normalAxis];E=P!==xe}else E=o.position[m.normalAxis]!==l[m.normalAxis];const S=Math.max(w,g);let O;m.wallTouchesFloorEnd&&!E?O=v:O=Math.min(w+k,v);const $=O-S;$<=0?yield[s,null]:(c.config.direction==="away"||c.config.direction==="left"?Me(p.config.tiles,t,$):p.config.times={[m.tangentAxis]:$},yield[s,p])}}}function*Ct(e,o,t,r){for(const[a,l]of C(e.items,"floor")){const u=eo(o,l);if(!u)continue;const d={x:0,y:0,z:0},y={x:0,y:0,z:0},n=t[u.normalAxis],s=t[u.tangentAxis],i=r?r[u.tangentAxis]:0;if(n!==0&&(o.config.direction==="towards"||o.config.direction==="right"?(d[u.normalAxis]=n,y[u.normalAxis]=-n):y[u.normalAxis]=n),s!==0&&(u.wallStart===l.position[u.tangentAxis]?(d[u.tangentAxis]=s,y[u.tangentAxis]=-s):u.wallTouchesFloorEnd&&(y[u.tangentAxis]=s)),i!==0&&u.wallTouchesFloorEnd&&(y[u.tangentAxis]=i),d.x!==0||d.y!==0||y.x!==0||y.y!==0){const c=x(l.config.times,y),m={...l,position:x(l.position,d),config:{...l.config,times:{x:c.x,y:c.y}}};yield[a,m]}yield*oo(C(e.items,"wall","door"),l,e.planet,d,y)}}const Tt={moveOrResizeItemAsPreview(e,{payload:{jsonItemIds:o,timesDelta:t,positionDelta:r}}){const a=e,l=R(a);for(const u of o){const d=Ve(a,u);if(d===void 0)throw new Error(`no json item found for some of the ids in resize ${u}`);if(d.type==="wall"){for(const[n,s]of Ct(l,d,r,t))a.previewedEdits[n]=s;continue}if(d.type==="floor")for(const[n,s]of oo(C(l.items,"wall","door"),d,l.planet,r,t))a.previewedEdits[n]=s;if(d.type==="door"){console.log("before healing, room items are",A(l.items));for(const[n,s]of Ze(d,A(l)))console.log("healing",`"${n}"`,s),a.previewedEdits[n]=s}const y={...d,position:x(d.position,r),config:{...d.config}};if(a.previewedEdits[u]=y,Pt(y,t),d.type==="door"){console.log("before cutting room plus previews is",{...A(l.items),...A(a.previewedEdits)});for(const[n,s]of Qe({...A(l.items),...A(a.previewedEdits)},y.config.direction,y.position))console.log("cutting",`"${n}"`,s),a.previewedEdits[n]=s}}a.dragInProgress=!0}},Pt=(e,o)=>{if(o!==void 0){const t=me(e),r=he(e),a=yo(o,r);if(De(a)>0){const l=lt(kt((u,d)=>Math.max(1,u+d),t,a));l===void 0?delete e.config.times:e.config.times=l}}};function He(e){var o="";return t(e),o;function t(a){if(a===null||typeof a!="object"||a.toJSON!=null)o+=JSON.stringify(a);else if(Array.isArray(a)){o+="[";var l=!1;a.forEach(function(d){l&&(o+=","),l=!0,d===void 0&&(d=null),t(d)}),o+="]"}else{o+="{";var u=Object.keys(a).filter(function(d){return a[d]!==void 0}).sort();u.forEach(function(d,y){return r(a,d,y)}),o+="}"}}function r(a,l,u){u>0&&(o+=","),o+=JSON.stringify(l),o+=":",t(a[l])}}const Mr=(e,...o)=>{const t={};for(const r of o)t[r]=e[r];return t},zt=(e,...o)=>{const t={...e};for(const r of o)delete t[r];return t},z=e=>e.type==="wall"?`wall/${e.config.direction}`:e.type==="teleporter"?He({type:e.type,config:zt(e.config,"toPosition")}):He({type:e.type,config:e.config}),Ft=e=>At(e[1]),Ot=e=>{const o=[];let t=0,r=0,a=0;for(const[,u]of e){const{x:d,y,z:n}=u.position,s=me(u),i=s.x,c=s.y,m=s.z;t=Math.max(t,d+i-1),r=Math.max(r,y+c-1),a=Math.max(a,n+m-1)}const l=Array.from({length:t+1},()=>Array.from({length:r+1},()=>Array.from({length:a+1},()=>new Set)));for(const u of e)if(!Ft(u))o.push(u);else{const[,d]=u,{x:y,y:n,z:s}=d.position,i=me(d),c=i.x,m=i.y,p=i.z;for(let h=0;h<c;h++)for(let f=0;f<m;f++)for(let g=0;g<p;g++){const v=y+h,w=n+f,I=s+g;v<l.length&&w<l[v].length&&I<l[v][w].length&&l[v][w][I].add(u)}}return{consolidatableGrid:l,nonConsolidatable:o}},$t=e=>{const o=[],t=new Set;for(const r of e)for(const a of r)for(const l of a)for(const u of l){const[d]=u;t.has(d)||(t.add(d),o.push(u))}return o},_t=e=>{const{consolidatableGrid:o,nonConsolidatable:t}=Ot(e),r={x:o.length,y:o[0].length,z:o[0][0].length},a=new Map,l=new Map;for(let s=0;s<r.x;s++)for(let i=0;i<r.y;i++)for(let c=0;c<r.z;c++)for(const[,m]of o[s][i][c]){const p=z(m);l.has(p)||l.set(p,m)}for(const[s]of l)a.set(s,Array.from({length:r.x},()=>Array.from({length:r.y},()=>Array(r.z).fill(!1))));const u=({x:s,y:i,z:c},m)=>{const p=z(m);return!a.get(p)[s][i][c]&&Array.from(o[s][i][c]).some(([,h])=>z(h)===z(m))},d=(s,i)=>{const c={...s},m=he(i);if(m.x>0)for(;c.x+1<r.x&&u({...c,x:c.x+1},i);)c.x++;if(m.y>0)for(let p=s.x;p<=c.x;p++)for(;c.y+1<r.y&&Array.from({length:c.x-s.x+1}).every((h,f)=>u({x:s.x+f,y:c.y+1,z:s.z},i));)c.y++;if(m.z>0)for(let p=s.x;p<=c.x;p++)for(let h=s.y;h<=c.y;h++)for(;c.z+1<r.z&&Array.from({length:c.x-s.x+1}).every((f,g)=>Array.from({length:c.y-s.y+1}).every((v,w)=>u({x:s.x+g,y:s.y+w,z:c.z+1},i)));)c.z++;return c},y=(s,i)=>{if(s.type==="wall"){if(i.type!=="wall")throw new Error("only walls can join walls");if(s.config.direction!==i.config.direction)throw new Error("walls must have the same direction to join");if(s.config.direction==="right"||s.config.direction==="towards")return;s.config.tiles=[...s.config.tiles,...i.config.tiles]}},n=({x:s,y:i,z:c},{x:m,y:p,z:h},f)=>{const[,g]=f,v=z(g),w=m-s+1,I=p-i+1,L=h-c+1;if(w+I+L>3)if(g.type==="wall")switch(g.config.direction){case"away":case"left":break;case"towards":w!==1&&(g.config.times={x:w});break;case"right":I!==1&&(g.config.times={y:I});break}else w!==1&&(g.config.times={...g.config.times,x:w}),I!==1&&(g.config.times={...g.config.times,y:I}),L!==1&&(g.config.times={...g.config.times,z:L});for(let k=s;k<=m;k++)for(let E=i;E<=p;E++)for(let S=c;S<=h;S++)if(a.get(v)[k][E][S]=!0,k!==s||E!==i||S!==c){const O=o[k][E][S];e:for(const $ of O){const[,P]=$;if(z(P)===v){P.position.x===k&&P.position.y===E&&P.position.z===S&&y(g,P),O.delete($);break e}}}};for(let s=0;s<r.x;s++)for(let i=0;i<r.y;i++)for(let c=0;c<r.z;c++)for(const m of o[s][i][c]){const[,p]=m;if(p.position.x===s&&p.position.y===i&&p.position.z===c){const h=z(p),f=a.get(h);if(f&&!f[s][i][c]){const g=d({x:s,y:i,z:c},p);n({x:s,y:i,z:c},g,m)}}}return[...$t(o),...t]},Wt=e=>Object.fromEntries(_t(Object.entries(e))),qt=(e,o)=>{const t=e.items[o];if(t.type==="door"){for(const[r,a]of Ze(t,e))e.items[r]=a;e.items=Wt(e.items)}delete e.items[o]},Ne=(e,o)=>{ft(e).filter(t=>t.type==="floor").filter(t=>t.position.z===0).forEach(t=>{t.config={...t.config,floorType:o,scenery:o==="standable"?e.planet:void 0}})},Mt={changeRoomColour(e,{payload:o}){const t=e,r=t.campaignInProgress.rooms[t.currentlyEditingRoomId].color;W(t),Object.assign(r,o)},changeRoomScenery(e,{payload:o}){const t=e,r=R(t);W(t),Ye(r,o)},roomJsonEdited(e,{payload:o}){const t=e;t.campaignInProgress.rooms[t.currentlyEditingRoomId]=o},deleteSelected(e){const o=e,t=R(o);W(o),o.selectedJsonItemIds.forEach(r=>{qt(t,r)}),o.selectedJsonItemIds=[]},clearRoom(e){const o=e,t=R(o);W(o);for(const r of Xe(t.items)){const a=t.items[r];a.type!=="floor"&&a.type!=="wall"&&a.type!=="door"&&(delete t.items[r],o.selectedJsonItemIds=o.selectedJsonItemIds.filter(l=>l!==r))}},setRoomAboveOrBelow(e,{payload:o}){const t=e,r=o.direction,a=r==="roomAbove"?"roomBelow":"roomAbove",l=R(t),u=o.createNew?pe(t,l.planet,l.color).id:o.roomId,d=l[r]&&fe(t,l[r]);d?.[a]===t.currentlyEditingRoomId&&(d[a]=void 0),l[r]=u;const y=u&&fe(t,u);y!==void 0&&(y[a]=l.id),y?Ne(r==="roomBelow"?l:y,"none"):Ne(r==="roomBelow"?l:d,"standable")}},Ht=(e,o)=>{const t=je(o);for(const[r,a]of t)a===null?delete e.items[r]:e.items[r]=a},Nt={resetPreviewedEdits(e){e.previewedEdits={}},commitCurrentPreviewedEdits(e){W(e),Ht(R(e),e.previewedEdits),e.previewedEdits={}}},ve="room_0",Jt={id:ve,...Ue({x:8,y:8})},Je={name:"new campaign",rooms:{[ve]:Jt}},we={campaignInProgress:Je,savedCampaign:Je,currentlyEditingRoomId:ve,editingRoomIdHistory:{back:[],forward:[]},previewedEdits:{},tool:{type:"pointer"},hoveredItem:void 0,clickableAnnotationHovered:!1,selectedJsonItemIds:[],halfGridResolution:!1,wallsFloorsLocked:!0,dragInProgress:!1,history:{undo:[],redo:[]}},Lt={loadCampaign(e,{payload:{campaign:o}}){const t=e;t.savedCampaign=o,t.campaignInProgress=o,t.hoveredItem=void 0,t.selectedJsonItemIds=[],t.clickableAnnotationHovered=!1,t.dragInProgress=!1,t.history=we.history;const r=ue(Xe(o.rooms));if(r===void 0)throw new Error("could not find any rooms in this campaign");t.currentlyEditingRoomId=r},campaignSaved(e,{payload:{campaign:o}}){const t=e;t.savedCampaign=o}},to=(e,o)=>{if(!e.campaignInProgress.rooms[o]){console.warn(`can't change to room ${o} - it doesn't exist`);return}e.editingRoomIdHistory.back.push(e.currentlyEditingRoomId),e.currentlyEditingRoomId=o,e.clickableAnnotationHovered=!1,e.hoveredItem=void 0,e.selectedJsonItemIds=[],e.history=we.history},Bt={changeToRoom(e,{payload:o}){to(e,o)},roomBack(e){const o=e,{editingRoomIdHistory:t}=o;if(t.back.length===0)return;const r=t.back.pop();t.forward.push(o.currentlyEditingRoomId),o.currentlyEditingRoomId=r},roomForward(e){const o=e,{editingRoomIdHistory:t}=o;if(t.forward.length===0)return;const r=t.forward.pop();t.back.push(o.currentlyEditingRoomId),o.currentlyEditingRoomId=r}},Gt={addRoom(e){const o=e.campaignInProgress.rooms[e.currentlyEditingRoomId],t=pe(e,o.planet);to(e,t.id)},removeRoom(e){const o=e.campaignInProgress.rooms[e.currentlyEditingRoomId],r=ue(C(o.items,"door","teleporter"))?.[1].config.toRoom??ue(Oo(a=>a!==e.currentlyEditingRoomId,mo(e.campaignInProgress.rooms)));r!==void 0&&(delete e.campaignInProgress.rooms[e.currentlyEditingRoomId],e.currentlyEditingRoomId=r)}},Ie=po({name:"levelEditor",initialState:we,reducers:{setTool(e,{payload:o}){const t=e;o.type==="item"&&(t.selectedJsonItemIds=[]),t.tool=o},injected(){},...Rt,...No,...xt,...bt,...Et,...Mt,...Tt,...Nt,...Lt,...Gt,...Bt},selectors:{selectCurrentCampaignInProgress:e=>e.campaignInProgress,selectCurrentEditingRoomJson:R,selectItem:Ve,selectCurrentEditingRoomColour:e=>R(e).color,selectCurrentEditingRoomScenery:e=>R(e).planet,selectTool:e=>e.tool,selectSelectedJsonItemIds:e=>e.selectedJsonItemIds,selectHoveredItem:e=>e.hoveredItem,selectItemIsSelected:Ho,...Jo}}),{addRoom:jt,applyItemTool:Dt,campaignSaved:Xt,changeDragInProgress:Vt,changeGridResolution:Ut,changeRoomColour:Yt,changeRoomScenery:Kt,changeToRoom:Qt,changeWallsFloorsLocked:Zt,clearRoom:er,commitCurrentPreviewedEdits:or,deleteSelected:tr,injected:rr,loadCampaign:nr,moveOrResizeItemAsPreview:ir,redo:sr,removeRoom:ar,resetPreviewedEdits:cr,roomJsonEdited:lr,setClickableAnnotationHovered:dr,setHoveredItemInRoom:ur,setRoomAboveOrBelow:fr,setSelectedItemsInRoom:yr,setTool:mr,toggleSelectedItemInRoom:pr,undo:gr,roomBack:hr,roomForward:vr}=Ie.actions,{selectCanRedo:wr,selectCanUndo:Ir,selectCurrentCampaignInProgress:xr,selectCurrentEditingRoomColour:br,selectCurrentEditingRoomJson:Rr,selectCurrentEditingRoomScenery:Er,selectHoveredItem:Ar,selectItem:kr,selectItemIsSelected:Sr,selectSelectedJsonItemIds:Cr,selectTool:Tr}=Ie.selectors,Pr=go.withTypes(),Hr=Object.freeze(Object.defineProperty({__proto__:null,addRoom:jt,applyItemTool:Dt,campaignSaved:Xt,changeDragInProgress:Vt,changeGridResolution:Ut,changeRoomColour:Yt,changeRoomScenery:Kt,changeToRoom:Qt,changeWallsFloorsLocked:Zt,clearRoom:er,commitCurrentPreviewedEdits:or,deleteSelected:tr,injected:rr,levelEditorSlice:Ie,loadCampaign:nr,moveOrResizeItemAsPreview:ir,redo:sr,removeRoom:ar,resetPreviewedEdits:cr,roomBack:hr,roomForward:vr,roomJsonEdited:lr,selectCanRedo:wr,selectCanUndo:Ir,selectCurrentCampaignInProgress:xr,selectCurrentEditingRoomColour:br,selectCurrentEditingRoomJson:Rr,selectCurrentEditingRoomScenery:Er,selectHoveredItem:Ar,selectItem:kr,selectItemIsSelected:Sr,selectSelectedJsonItemIds:Cr,selectTool:Tr,setClickableAnnotationHovered:dr,setHoveredItemInRoom:ur,setRoomAboveOrBelow:fr,setSelectedItemsInRoom:yr,setTool:mr,toggleSelectedItemInRoom:pr,undo:gr,useAppSelectorWithLevelEditorSlice:Pr},Symbol.toStringTag,{value:"Module"}));export{me as $,H as A,Qo as B,Mr as C,We as D,oe as E,St as F,at as G,Fr as H,$r as I,Pt as J,Oo as K,ir as L,or as M,hr as N,vr as O,Qt as P,b as Q,nt as R,qr as S,ot as T,_r as U,Wr as V,Or as W,dr as X,Ar as Y,Cr as Z,ct as _,mr as a,he as a0,kt as a1,Vt as a2,yr as a3,pr as a4,Dt as a5,ur as a6,cr as a7,Ve as a8,kr as a9,Sr as aa,At as ab,lr as ac,Hr as ad,br as b,Ut as c,tr as d,Yt as e,Er as f,Kt as g,Ir as h,wr as i,gr as j,sr as k,Zt as l,Rr as m,N as n,er as o,R as p,fr as q,bo as r,Tr as s,xr as t,Pr as u,Xt as v,nr as w,jt as x,ar as y,tt as z};
