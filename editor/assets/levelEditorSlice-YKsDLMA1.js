import{b as J,a as Ee,g as le,ab as po,i as X,ac as Ve,ad as Xt,ae as h,af as go,ag as E,ah as ft,ai as te,aj as Ae,ak as ho,al as bo,am as fe,an as xo,ao as ut,ap as N,aq as Ue,ar as wo,as as Dt,at as Ze,au as vo,av as Ke,aw as Io,ax as Qe,ay as ee,az as He,aA as je,aB as Pe,o as qt,aC as yt,aD as mt,aE as ko,aF as Ro,aG as zo,aH as Eo,aI as Ao,aJ as Po,aK as Yt,aL as To,aM as Y,aN as So,aO as Co,aP as Oo}from"./index-DoaPLPSh.js";import{o as oe,i as se,a as L}from"./RoomJson-8RsRkwvs.js";var ue={},ye={},pt;function Fo(){if(pt)return ye;pt=1;function e(c,f){var s;if(typeof Symbol>"u"||c[Symbol.iterator]==null){if(Array.isArray(c)||(s=t(c))||f){s&&(c=s);var u=0,d=function(){};return{s:d,n:function(){return u>=c.length?{done:!0}:{done:!1,value:c[u++]}},e:function(p){throw p},f:d}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var l=!0,y=!1,m;return{s:function(){s=c[Symbol.iterator]()},n:function(){var p=s.next();return l=p.done,p},e:function(p){y=!0,m=p},f:function(){try{!l&&s.return!=null&&s.return()}finally{if(y)throw m}}}}function t(c,f){if(c){if(typeof c=="string")return o(c,f);var s=Object.prototype.toString.call(c).slice(8,-1);if(s==="Object"&&c.constructor&&(s=c.constructor.name),s==="Map"||s==="Set")return Array.from(c);if(s==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return o(c,f)}}function o(c,f){(f==null||f>c.length)&&(f=c.length);for(var s=0,u=new Array(f);s<f;s++)u[s]=c[s];return u}var r=J(),i=r.ensureIterable;function n(c){var f=[],s=e(c),u;try{for(s.s();!(u=s.n()).done;){var d=u.value;f.push(d)}}catch(l){s.e(l)}finally{s.f()}return f}ye.__toArray=n;function a(c){return n(i(c))}return ye.toArray=a,ye}var gt;function No(){if(gt)return ue;gt=1;var e=Ee(),t=e.mark(a),o=J(),r=o.iterableCurry,i=Fo(),n=i.__toArray;function a(f,s){var u;return e.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(u=Array.isArray(f)?f:n(f),u.length){l.next=3;break}return l.abrupt("return");case 3:if(!s--){l.next=7;break}return l.delegateYield(u,"t0",5);case 5:l.next=3;break;case 7:case"end":return l.stop()}},t)}ue.__cycleTimes=a;var c=r(a);return ue.cycleTimes=c,ue}var me={},ht;function $o(){if(ht)return me;ht=1;var e=Ee(),t=e.mark(c);function o(s,u){var d;if(typeof Symbol>"u"||s[Symbol.iterator]==null){if(Array.isArray(s)||(d=r(s))||u){d&&(s=d);var l=0,y=function(){};return{s:y,n:function(){return l>=s.length?{done:!0}:{done:!1,value:s[l++]}},e:function(b){throw b},f:y}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var m=!0,g=!1,p;return{s:function(){d=s[Symbol.iterator]()},n:function(){var b=d.next();return m=b.done,b},e:function(b){g=!0,p=b},f:function(){try{!m&&d.return!=null&&d.return()}finally{if(g)throw p}}}}function r(s,u){if(s){if(typeof s=="string")return i(s,u);var d=Object.prototype.toString.call(s).slice(8,-1);if(d==="Object"&&s.constructor&&(d=s.constructor.name),d==="Map"||d==="Set")return Array.from(s);if(d==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(d))return i(s,u)}}function i(s,u){(u==null||u>s.length)&&(u=s.length);for(var d=0,l=new Array(u);d<u;d++)l[d]=s[d];return l}var n=J(),a=n.iterableCurry;function c(s,u){var d,l,y,m;return e.wrap(function(p){for(;;)switch(p.prev=p.next){case 0:d=0,l=o(s),p.prev=2,l.s();case 4:if((y=l.n()).done){p.next=11;break}if(m=y.value,!u(m,d++)){p.next=9;break}return p.next=9,m;case 9:p.next=4;break;case 11:p.next=16;break;case 13:p.prev=13,p.t0=p.catch(2),l.e(p.t0);case 16:return p.prev=16,l.f(),p.finish(16);case 19:case"end":return p.stop()}},t,null,[[2,13,16,19]])}me.__filter=c;var f=a(c);return me.filter=f,me}var pe={},bt;function Wo(){if(bt)return pe;bt=1;var e=J(),t=e.iterableCurry,o=No(),r=o.__cycleTimes;function i(a){return r(a,1/0)}pe.__cycle=i;var n=t(i);return pe.cycle=n,pe}var ge={},xt;function Bo(){if(xt)return ge;xt=1;var e=Ee(),t=e.mark(c);function o(s,u){var d;if(typeof Symbol>"u"||s[Symbol.iterator]==null){if(Array.isArray(s)||(d=r(s))||u){d&&(s=d);var l=0,y=function(){};return{s:y,n:function(){return l>=s.length?{done:!0}:{done:!1,value:s[l++]}},e:function(b){throw b},f:y}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var m=!0,g=!1,p;return{s:function(){d=s[Symbol.iterator]()},n:function(){var b=d.next();return m=b.done,b},e:function(b){g=!0,p=b},f:function(){try{!m&&d.return!=null&&d.return()}finally{if(g)throw p}}}}function r(s,u){if(s){if(typeof s=="string")return i(s,u);var d=Object.prototype.toString.call(s).slice(8,-1);if(d==="Object"&&s.constructor&&(d=s.constructor.name),d==="Map"||d==="Set")return Array.from(s);if(d==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(d))return i(s,u)}}function i(s,u){(u==null||u>s.length)&&(u=s.length);for(var d=0,l=new Array(u);d<u;d++)l[d]=s[d];return l}var n=J(),a=n.iterableCurry;function c(s,u){var d,l,y,m;return e.wrap(function(p){for(;;)switch(p.prev=p.next){case 0:d=0,l=o(s),p.prev=2,l.s();case 4:if((y=l.n()).done){p.next=11;break}if(m=y.value,!(d++>=u)){p.next=9;break}return p.next=9,m;case 9:p.next=4;break;case 11:p.next=16;break;case 13:p.prev=13,p.t0=p.catch(2),l.e(p.t0);case 16:return p.prev=16,l.f(),p.finish(16);case 19:case"end":return p.stop()}},t,null,[[2,13,16,19]])}ge.__drop=c;var f=a(c);return ge.drop=f,ge}var he={},be={},wt;function _o(){if(wt)return be;wt=1;var e=J(),t=e.iterableCurry,o=e.callReturn;function r(n,a){var c=n[Symbol.iterator](),f=c.next(),s=f.value,u=f.done;return u?a:(o(c),s)}be.__firstOr=r;var i=t(r,{reduces:!0});return be.firstOr=i,be}var vt;function Mo(){if(vt)return he;vt=1;var e=J(),t=e.iterableCurry,o=_o(),r=o.__firstOr;function i(a){return r(a,void 0)}he.__first=i;var n=t(i,{reduces:!0});return he.first=n,he}var xe={},It;function Ho(){if(It)return xe;It=1;var e=Ee(),t=e.mark(c);function o(s,u){var d;if(typeof Symbol>"u"||s[Symbol.iterator]==null){if(Array.isArray(s)||(d=r(s))||u){d&&(s=d);var l=0,y=function(){};return{s:y,n:function(){return l>=s.length?{done:!0}:{done:!1,value:s[l++]}},e:function(b){throw b},f:y}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var m=!0,g=!1,p;return{s:function(){d=s[Symbol.iterator]()},n:function(){var b=d.next();return m=b.done,b},e:function(b){g=!0,p=b},f:function(){try{!m&&d.return!=null&&d.return()}finally{if(g)throw p}}}}function r(s,u){if(s){if(typeof s=="string")return i(s,u);var d=Object.prototype.toString.call(s).slice(8,-1);if(d==="Object"&&s.constructor&&(d=s.constructor.name),d==="Map"||d==="Set")return Array.from(s);if(d==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(d))return i(s,u)}}function i(s,u){(u==null||u>s.length)&&(u=s.length);for(var d=0,l=new Array(u);d<u;d++)l[d]=s[d];return l}var n=J(),a=n.iterableCurry;function c(s,u){var d,l,y,m;return e.wrap(function(p){for(;;)switch(p.prev=p.next){case 0:if(u!==0){p.next=2;break}return p.abrupt("return");case 2:d=0,l=o(s),p.prev=4,l.s();case 6:if((y=l.n()).done){p.next=14;break}return m=y.value,p.next=10,m;case 10:if(++d!==u){p.next=12;break}return p.abrupt("break",14);case 12:p.next=6;break;case 14:p.next=19;break;case 16:p.prev=16,p.t0=p.catch(4),l.e(p.t0);case 19:return p.prev=19,l.f(),p.finish(19);case 22:case"end":return p.stop()}},t,null,[[4,16,19,22]])}xe.__take=c;var f=a(c);return xe.take=f,xe}var Te,kt;function Xo(){return kt||(kt=1,Te=Wo().cycle),Te}var Do=Xo();const qo=le(Do);var Se,Rt;function Yo(){return Rt||(Rt=1,Se=Bo().drop),Se}var Lo=Yo();const Go=le(Lo);var Ce,zt;function Jo(){return zt||(zt=1,Ce=$o().filter),Ce}var Vo=Jo();const Uo=le(Vo);var Oe,Et;function Zo(){return Et||(Et=1,Oe=Mo().first),Oe}var Ko=Zo();const Xe=le(Ko);var Fe,At;function Qo(){return At||(At=1,Fe=Ho().take),Fe}var jo=Qo();const er=le(jo),Lt=e=>()=>po(e),_n=(e,t)=>t?.[e],Gt=e=>oe(e),ne=e=>X(Gt(e)),v={w:16,d:16,h:12},re={x:16,y:16,z:12},tr=(e,t,o)=>{if(t==="*")return!0;const r=o.meta.subRooms[t];return e.x>=r.physicalPosition.from.x&&e.y>=r.physicalPosition.from.y&&e.x<=r.physicalPosition.to.x&&e.y<=r.physicalPosition.to.y},Mn=({position:e},t,o)=>tr(e,t,o),or=(e,t,o)=>{if(t==="*")return 0;const r=o.meta.subRooms[t],{from:i,to:n}=r.physicalPosition;if(e.x>=i.x&&e.y>=i.y&&e.x<=n.x&&e.y<=n.y)return 0;let a=0,c=0;return e.x<i.x?a=i.x-e.x:e.x>n.x&&(a=e.x-n.x),e.y<i.y?c=i.y-e.y:e.y>n.y&&(c=e.y-n.y),a+c},et=(e,t,o)=>{const r=o.meta?.subRooms;if(r===void 0)return"*";let i,n=1/0;const a=t==="fine"?{x:e.x/v.w,y:e.y/v.d}:e;for(const c of Ve(r)){const f=or(a,c,o);if(f===0)return c;f<n&&(n=f,i=c)}if(i===void 0)throw new Error(`item not found in any subroom of ${o.id}
      item at ðŸ“ ${JSON.stringify(a)}
      subrooms ${JSON.stringify(o.meta?.subRooms,null,2)}`);return i},rr=["head","heels"],ir=[...rr,"headOverHeels"],nr="@@original",sr="original",Hn={userId:nr,campaignName:sr,version:-1},Xn=({x:e=0,y:t=0})=>t-e,V=({x:e=0,y:t=0,z:o=0})=>({x:t-e,y:-(e+t)/2-o}),Dn=(e,t,o)=>{const r=V(e),i=Xt(o,r);return h(ar(t,i),e)},ar=(e,{x:t,y:o})=>{switch(go(e)){case"xy":return{x:-t/2-o,y:t/2-o,z:0};case"xz":return{x:-t,y:0,z:t/2-o};case"yz":return{x:0,y:t,z:-t/2-o};default:throw new Error("only axis-aligned planes are supported for unprojection")}},C=({x:e=0,y:t=0,z:o=0})=>({x:e*v.w,y:t*v.d,z:o*v.h}),qn=({x:e=0,y:t=0,z:o=0})=>({x:e/v.w,y:t/v.d,z:o/v.h}),Yn=e=>V(C(e)),cr={floors:{edgeLeftX:Number.POSITIVE_INFINITY,edgeRightX:Number.NEGATIVE_INFINITY,topEdgeY:Number.POSITIVE_INFINITY,bottomEdgeY:Number.NEGATIVE_INFINITY},allItems:{topEdgeY:Number.POSITIVE_INFINITY}},lr=e=>ne(e.items).reduce((t,o)=>{if(o.type==="floor"){const{config:{naturalFootprint:r},state:{position:i},renderAabb:n,renderAabbOffset:a,aabb:c}=o,f=V(h(r.position,{x:r.aabb.x,z:r.aabb.z})).x,s=V(h(r.position,{y:r.aabb.y,z:r.aabb.z})).x,u=V(h(r.position,r.aabb)).y,d=V(h(i,a??E,{z:(n??c).z})).y;return{allItems:t.allItems,floors:{edgeLeftX:Math.min(t.floors.edgeLeftX,f),edgeRightX:Math.max(t.floors.edgeRightX,s),topEdgeY:Math.min(t.floors.topEdgeY,u),bottomEdgeY:Math.max(t.floors.bottomEdgeY,d)}}}else{const r=V(h(o.state.position,o.renderAabb??o.aabb??E,o.renderAabbOffset??E)).y;return{allItems:{topEdgeY:Math.min(t.allItems.topEdgeY,r)},floors:t.floors}}},cr),dr={from:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY,z:Number.POSITIVE_INFINITY},to:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY,z:Number.NEGATIVE_INFINITY}},Ln=e=>{const t=se(e).filter(o=>o.type==="floor").reduce((o,r)=>{const{position:i,config:{times:n}}=r;return{from:{x:Math.min(o.from.x,i.x),y:Math.min(o.from.y,i.y),z:Math.min(o.from.z,i.z)},to:{x:Math.max(o.to.x,i.x+n.x),y:Math.max(o.to.y,i.y+n.y),z:Math.max(o.to.z,i.z)}}},dr);if(isFinite(t.from.x))return t},fr={jail:["bars"],blacktooth:["plain","plain","armour","shield","shield","armour"],bookworld:["book","book","cowboy"],egyptus:["hieroglyphics","hieroglyphics","hieroglyphics","sarcophagus","sarcophagus"],market:["passage","more-fruits","fruits","more-fruits","fruits"],moonbase:["coil","window1","window2","window3"],penitentiary:["loop","loop","skeleton"],safari:["wall","shield","wall","window","window","wall","shield"]},ae=(e,t,o=0)=>{const r=qo(fr[e]);return Go(o,er(t+o,r))},ur=e=>({awayWall:{type:"wall",config:{direction:"away",tiles:Array.from(ae("blacktooth",e.x))},position:{x:0,y:e.y,z:0}},leftWall:{type:"wall",config:{direction:"left",tiles:Array.from(ae("blacktooth",e.y))},position:{x:e.x,y:0,z:0}},towardsWall:{type:"wall",config:{direction:"towards",times:{x:e.x}},position:{x:0,y:0,z:0}},rightWall:{type:"wall",config:{direction:"right",times:{y:e.y}},position:{x:0,y:0,z:0}}}),Jt=e=>({planet:"blacktooth",color:{hue:"cyan",shade:"basic"},items:{floor:{type:"floor",config:{floorType:"standable",scenery:"blacktooth",times:e},position:{x:0,y:0,z:0}},...ur(e)}}),tt="room_0",yr={id:tt,...Jt({x:8,y:8})},mr={meta:{published:!1},locator:{campaignName:void 0,userId:"anon",version:0},rooms:{[tt]:yr}},ot={campaignInProgress:mr,remoteCampaign:void 0,currentlyEditingRoomId:tt,editingRoomIdHistory:{back:[],forward:[]},previewedEdits:{},tool:{type:"pointer"},hoveredItem:void 0,clickableAnnotationHovered:!1,selectedJsonItemIds:[],gridResolution:1,autoCoalesce:!0,wallsFloorsLocked:!0,dragInProgress:!1,history:{undo:[],redo:[]}},rt=({aabb:e,state:{position:t}},{aabb:o,state:{position:r}})=>!(t.x+e.x<=r.x||t.x>=r.x+o.x)&&!(t.y+e.y<=r.y||t.y>=r.y+o.y)&&!(t.z+e.z<=r.z||t.z>=r.z+o.z),pr=(e,t)=>[...X(t).filter(o=>e.id!==o.id&&rt(e,o))];function*Gn(e,t){for(const o of t)e.id!==o.id&&rt(e,o)&&(yield o)}const Pt={stopAutowalk:5,portal:5,wall:5,blocker:5,doorLegs:5,sceneryPlayer:5,bubbles:5,switch:10,button:10,doorFrame:15,ball:18,block:20,barrier:20,floor:20,hushPuppy:20,teleporter:20,lift:30,movingPlatform:30,pushableBlock:30,portableBlock:30,sceneryCrown:30,slidingBlock:30,spring:30,joystick:40,charles:40,conveyor:40,head:50,heels:50,headOverHeels:50,pickup:80,firedDoughnut:90,spikes:98,slidingDeadly:100,moveableDeadly:100,deadlyBlock:100,monster:100,floatingText:200,particle:200,emitter:200},gr=(e,t)=>Pt[e.type]-Pt[t.type],S=(...e)=>{if(e.length===1){const[t]=e;return o=>o.type===t}return t=>e.includes(t.type)},hr=S("bubbles","stopAutowalk","firedDoughnut","floatingText","emitter","particle"),br=(e,t)=>hr(e)||zr(e)&&(t!==void 0&&vr(t)||e.config.direction.z!==0)||Zt(e)&&e.config.floorType==="none",De=(e,t)=>!br(e,t),Vt=["ball","slidingBlock","slidingDeadly"];S(...Vt);const xr=["portableBlock","spring","sceneryPlayer","sceneryCrown","monster","slidingBlock"],wr=["dalek","turtle","elephantHead","homingBot","helicopterBug"],Jn=e=>e.type==="slidingBlock"?e.config.style==="puck":e.type==="monster"?wr.includes(e.config.which):xr.includes(e.type),vr=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function Ir(e){return Ut.includes(e.type)}const Ut=[...ir,"monster","ball","charles","pushableBlock","movingPlatform","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer","sceneryCrown"],kr=["monster","deadlyBlock","moveableDeadly","slidingDeadly"];S(...kr);const Rr=e=>e.config.times!==void 0,zr=S("portal");S("teleporter");const Vn=S("heels");S("head");const Un=S("headOverHeels");S("heels","headOverHeels");S("head","headOverHeels");S("lift");S("button");S("emitter");const Er=S("monster"),Zt=S("floor");S("pickup");S("spring");const Zn=S("joystick");S("conveyor");S("hushPuppy");S("firedDoughnut");const Kn=S("wall","doorFrame");S("monster","movingPlatform");const Qn=e=>Er(e)&&e.config.which==="cyberman"&&e.state.everActivated===!1,Ar=(e,t,o,r)=>{const i=Math.max(0,Math.min(e.x+t.x,o.x+r.x)-Math.max(e.x,o.x)),n=Math.max(0,Math.min(e.y+t.y,o.y+r.y)-Math.max(e.y,o.y));return i*n},Tt=({state:{position:e},aabb:t},{state:{position:o},aabb:r})=>Ar(e,t,o,r),Pr=(e,t,o=.001)=>{if(!De(t,e)||e.id===t.id)return!1;const{state:{vels:{gravity:{z:r}}}}=e;return r>0?!1:rt({state:{position:h(e.state.position,{x:0,y:0,z:-ft})},aabb:{...e.aabb,z:o+ft},id:e.id},{state:{position:h(t.state.position,{x:0,y:0,z:t.aabb.z})},aabb:{...t.aabb,z:0},id:t.id})},Tr=(e,t)=>{const r=[...X(t).filter(n=>Pr(e,n))];return r.length===0?void 0:r.reduce((n,a)=>{const c=gr(a,n);return c<0||c===0&&Tt(e,a)>Tt(e,n)?a:n})},Sr=({above:e,below:t})=>{const o=t.state.stoodOnBy;if(!Object.isExtensible(o))throw new Error(`${e.id} can't stand on ${t.id} - its standingOn is not extensible`);e.state.standingOnItemId=t.id,o[e.id]=!0},W={x:12,y:12,z:v.h},Cr={x:14,y:14,z:v.h},U={x:16,y:16,z:v.h},Ne={...W,z:v.h*2},Kt=e=>{switch(e.type){case"spring":case"portableBlock":case"moveableDeadly":case"slidingDeadly":case"firedDoughnut":return{aabb:W};case"slidingBlock":return e.config.style==="book"?{aabb:U}:{aabb:W};case"lift":return{aabb:{...W,z:W.z}};case"switch":return{aabb:{...W,z:W.z}};case"button":return{aabb:{x:15,y:15,z:2}};case"pickup":return e.config.gives==="scroll"?{aabb:{x:16,y:4,z:13}}:{aabb:W};case"charles":return{aabb:Ne};case"ball":return{aabb:{x:12,y:12,z:12}};case"pushableBlock":case"movingPlatform":return{aabb:U};case"block":switch(e.config.style){case"artificial":case"organic":case"book":return{aabb:U};case"tower":return{aabb:{x:11,y:11,z:v.h}};default:throw new Error("unknown block style")}case"monster":switch(e.config.which){case"skiHead":return{aabb:{...W,z:21}};case"bubbleRobot":case"cyberman":case"elephant":case"emperorsGuardian":case"monkey":case"computerBot":return{aabb:Ne};case"helicopterBug":case"dalek":case"emperor":case"homingBot":case"elephantHead":return{aabb:W};case"turtle":return{aabb:W};default:throw e.config,new Error("unknown monster type")}case"deadlyBlock":case"spikes":return{aabb:U};case"bubbles":return{aabb:W};case"conveyor":case"hushPuppy":case"teleporter":return{aabb:U};case"barrier":return{aabb:e.config.axis==="y"?{x:3,y:15,z:v.h}:{x:15,y:3,z:v.h}};case"sceneryPlayer":return e.config.which==="headOverHeels"?{aabb:Ne}:{aabb:W};case"emitter":return{aabb:E};default:return{aabb:Cr}}},H={aabb:W,castsShadowWhileStoodOn:!1},de=e=>({x:e.direction==="away"?e.tiles.length:e.direction==="towards"?e.times?.x:1,y:e.direction==="left"?e.tiles.length:e.direction==="right"?e.times?.y:1}),jn=e=>e.type==="wall"?de(e.config):Rr(e)?e.config.times:void 0,qe=(e=te)=>({x:e.x??1,y:e.y??1,z:e.z??1}),Or=e=>({x:e.x??1,y:e.y??1}),D=e=>{const t=o=>o.config.times!==void 0;return e.type==="wall"?qe(de(e.config)):t(e)?qe(e.config.times):te},Qt=e=>{const t={};let o=!1;return e.x!==1&&(t.x=e.x,o=!0),e.y!==1&&(t.y=e.y,o=!0),e.z!==1&&(t.z=e.z,o=!0),o?t:void 0},ce=(e,t={})=>{const o=qe(t),r=Ae(re,e);return ho(bo(o,re),r)},K=-2,B=Number.MIN_SAFE_INTEGER,$e={x:1,y:0,z:0},We={x:-1,y:0,z:0},Be={x:0,y:-1,z:0},_e={x:0,y:1,z:0},$={away:_e,left:$e,right:We,towards:Be,down:{x:0,y:0,z:-1},up:{x:0,y:0,z:1},awayRight:fe(h(_e,We)),towardsRight:fe(h(Be,We)),towardsLeft:fe(h(Be,$e)),awayLeft:fe(h(_e,$e))},St=xo/1e3,Fr={firedDoughnut:2*St,floatingText:St},Nr=10,es=6e4,$r=8,ts=750,os=1500,rs=200,is=.15,Wr=ut.h-ut.w/2,jt=Wr+2,it=9999,Ye=e=>{const t=C(e.position),{aabb:o}=Kt(e);if(o===void 0)throw new Error(`item type= ${e.type} config=${JSON.stringify(e.config)} has no bounding box`);return e.type==="wall"?t:h(t,{x:v.w-o.x>>1,y:v.d-o.y>>1})},M=()=>({expires:null,stoodOnBy:{},disappearing:null,switchedAtRoomTime:B,stoodOnUntilRoomTime:B,actedOnAt:{roomTime:B,by:N}}),Ct=()=>({standingOnItemId:null,vels:{gravity:E,movingFloor:E},latentMovement:[],collidedWith:{roomTime:B,by:N},controlledWithJoystickAtRoomTime:B}),Br=e=>{const t=Ut.includes(e.type);return{...M(),position:Ye(e),...t?{standingOnItemId:null,vels:{gravity:E,movingFloor:E,...Vt.includes(e.type)?{sliding:E}:{},...e.type==="monster"||e.type==="movingPlatform"?{walking:E}:{}},latentMovement:[],collidedWith:{roomTime:B,by:N}}:{},...e.type==="joystick"||e.type==="emitter"||e.type==="lift"||e.type==="conveyor"||e.type==="teleporter"?{...structuredClone(e.config)}:{},...e.type==="monster"?{activated:e.config.activated==="on",everActivated:e.config.activated==="on",timeOfLastDirectionChange:Number.NEGATIVE_INFINITY,...e.config.which==="skiHead"||e.config.which==="turtle"||e.config.which==="elephantHead"||e.config.which==="cyberman"?{facing:$[e.config.startDirection]}:{facing:$.towards}}:{},...e.type==="pickup"?{disappearing:{on:"touch",byType:e.config.gives==="bag"||e.config.gives==="jumps"?["heels","headOverHeels"]:e.config.gives==="doughnuts"||e.config.gives==="hooter"||e.config.gives==="fast"?["head","headOverHeels"]:["head","heels","headOverHeels"]}}:{},...e.type==="movingPlatform"?{activated:e.config.activated==="on",everActivated:e.config.activated==="on",facing:$[e.config.startDirection]}:{},...e.type==="switch"?{setting:e.config.initialSetting,touchedOnProgression:-1}:{},...e.type==="button"?{pressed:!1}:{},...e.type==="block"?{disappearing:e.config.disappearing??null}:{},...e.type==="conveyor"?{disappearing:e.config.disappearing??null}:{},...e.type==="barrier"?{disappearing:e.config.disappearing??null}:{},...e.type==="lift"?{direction:"up",vels:{lift:E}}:{},...e.type==="charles"?{facing:$.towards}:{},...e.type==="emitter"?{lastEmittedAtRoomTime:B,quantityEmitted:0}:{},...e.type==="firedDoughnut"?{disappearing:{on:"touch"},vels:{fired:e.config.direction?Ue($[e.config.direction],Fr.firedDoughnut):E}}:{}}},_r=({config:{direction:e},position:t})=>e==="right"&&t.x===0||e==="towards"&&t.y===0,Me=v.h*2,Mr=4,we=v.h*Mr,Hr=2,ns=2*v.w,Xr=.5,Ot=2;function*Dr(e,t){const{config:{direction:o},position:r}=e,i=Dt(o),n=Ze(i),a=_r(e),c={...E,[n]:a?-.5:0},f=1,s={[n]:a?-f:0},u=f*v.w,d={...E,[n]:u},l=9,y=8,m=8;{const g={[i]:y,[n]:m,z:we};yield{...e,...H,type:"doorFrame",id:`${t}/frameFar`,jsonItemId:t,config:{...e.config,inHiddenWall:a,part:"far"},state:{...M(),position:C(h(r,{[i]:1.5},c,s)),stoodOnBy:N},aabb:h(g,d),renderAabb:g,renderAabbOffset:a?d:void 0}}{const g={[i]:l,[n]:m,z:we};yield{...e,...H,type:"doorFrame",id:`${t}/frameNear`,jsonItemId:t,config:{...e.config,inHiddenWall:a,part:"near"},state:{...M(),position:C(h(r,c,s)),stoodOnBy:N},aabb:h(g,d),renderAabb:g,renderAabbOffset:a?d:void 0}}{const g={[i]:2*v.w-l-y,[n]:m,z:we-Me};yield{...e,...H,type:"doorFrame",id:`${t}/frameTop`,jsonItemId:t,config:{...e.config,inHiddenWall:a,part:"top"},state:{...M(),position:h(C(h(r,c,s)),{[i]:l,z:Me}),stoodOnBy:N},aabb:h(g,d),renderAabb:g,renderAabbOffset:a?d:void 0}}yield{...e,...H,type:"blocker",id:`${t}/blockerAbove`,jsonItemId:t,config:{},renders:!1,state:{...M(),position:h(C(h(r,c,s)),{z:we}),stoodOnBy:N},aabb:h(C({[i]:2,[n]:f,z:it}),{[n]:m}),renderAabb:E,fixedZIndex:K},yield{...e,...H,type:"portal",id:`${t}/portal`,jsonItemId:t,config:{...wo(e.config,"toRoom","toDoor"),inHidden:a,relativePoint:C({...E,[n]:a?f+.25:-.25}),direction:$[o]},fixedZIndex:K,state:{...M(),position:h(C(h(r,{[n]:a?-.5-f:.5})),{[i]:l}),stoodOnBy:N},aabb:{[i]:Hr*v.w-l-y,[n]:u,z:Me}},r.z!==0&&(yield{...e,...H,type:"doorLegs",id:`${t}/legs`,jsonItemId:t,config:{...e.config,inHiddenWall:a,style:"none",side:"away",height:r.z},renders:!0,shadowCastTexture:a?{textureId:"shadow.door.floatingThreshold.double.y",flipX:i==="x"}:void 0,castsShadowWhileStoodOn:a,state:{...M(),position:{...C(h(r,c,s)),z:0}},aabb:h(C({[i]:2,[n]:.5,z:r.z}),d),renderAabb:a?h(C({[i]:2,[n]:.5,z:.5})):void 0,renderAabbOffset:a?h({[i]:0,[n]:0,z:(r.z-.5)*v.h},{[n]:d[n]}):void 0,shadowOffset:{z:r.z*v.h,[n]:a?d[n]:void 0}}),yield{...H,type:"stopAutowalk",id:`${t}/stopAutowalk`,jsonItemId:t,aabb:C({[i]:2,[n]:Ot,z:2}),config:{},fixedZIndex:K,state:{...M(),position:C(Ae(r,Ue($[o],Xr),a?E:{[n]:Ot})),stoodOnBy:N}}}const Ft=3,Nt=10,$t=.52,ve=.5,qr=(e,t,o)=>{const{config:{times:r},position:i}=t,n=h(i,{z:-Ft}),a={...r,z:Ft};let c=n,f=a;const s=X(oe(o.items)).filter(l=>l.type==="door");if(i.z===0){const l={};for(const y of s){const{position:m,config:{direction:g}}=y;switch(g){case"towards":!l.towards&&m.y===n.y&&m.x>=n.x&&m.x<=n.x+r.x-2&&(f=h(f,{y:ve}),c=h(c,{y:-ve}),l.towards=!0);break;case"away":!l.away&&m.y===n.y+r.y&&m.x>=n.x&&m.x<=n.x+r.x-2&&(f=h(f,{y:$t}),l.away=!0);break;case"right":!l.right&&m.x===n.x&&m.y>=n.y&&m.y<=n.y+r.y-2&&(f=h(f,{x:ve}),c=h(c,{x:-ve}),l.right=!0);break;case"left":!l.left&&m.x===n.x+r.x&&m.y>=n.y&&m.y<=n.y+r.y-2&&(f=h(f,{x:$t}),l.left=!0);break}}}const u=C(c),d=ce(U,f);return{...H,type:"floor",id:e,jsonItemId:e,config:{...t.config,naturalFootprint:{aabb:ce(U,a),position:C(n)}},aabb:d,renderAabb:{...d,z:Nt},renderAabbOffset:{...E,z:d.z-Nt},shadowCastTexture:"shadow.fullBlock",state:{...M(),position:u}}},Wt={config:N,shadowCastTexture:"shadow.smallRound",castsShadowWhileStoodOn:!0,aabb:W},Bt=()=>{const e=Io(Ke.getState());return{action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:$.towards,walkStartFacing:$.towards,walkDistance:0,vels:{walking:E,gravity:E,movingFloor:E},switchedToAt:B,lastDiedAt:B,gameTime:0,jumpStartTime:B,lives:e?"infinite":$r,jumpStartZ:0}},Yr=(e,t)=>{const o=vo(Ke.getState());return e.config.which==="head"?{id:t,jsonItemId:t,type:"head",...H,...Wt,state:{...M(),...Ct(),...Bt(),hasHooter:!1,gameWalkDistance:0,fastStepsStartedAtDistance:B,shieldCollectedAt:B,doughnuts:o?"infinite":0,position:Ye(e),stoodOnUntilRoomTime:B}}:{id:t,jsonItemId:t,type:"heels",...H,...Wt,state:{...M(),...Ct(),...Bt(),carrying:null,hasBag:!1,bigJumps:0,isBigJump:!1,shieldCollectedAt:B,position:Ye(e),stoodOnUntilRoomTime:B}}},eo=e=>e==="towards"||e==="right",nt=1,Lr={x:v.w,y:v.d*nt,z:it},Gr={x:v.w,y:0,z:jt},Jr={x:v.w*nt,y:v.d,z:it},Vr={x:0,y:v.d,z:jt},Ur=(e,t)=>{const{config:{direction:o},position:r}=t,i=de(t.config),n=Dt(o),a=Ze(n),c=eo(o),f={...E,[a]:c?-nt:0};return{type:"wall",id:e,jsonItemId:e,config:t.config,aabb:ce(n==="y"?Jr:Lr,i),renderAabb:c?E:ce(n==="y"?Vr:Gr,i),fixedZIndex:c?K:void 0,state:{...M(),position:C(h(r,f)),stoodOnBy:N},shadowCastTexture:n==="y"?"shadow.wall.y":{textureId:"shadow.wall.y",flipX:!0},castsShadowWhileStoodOn:c}};function*to(e,t,o,r=N,i={},n=""){if(!r[e]&&!(t.type==="pickup"&&t.config.gives==="scroll"&&t.config.source==="manual"&&i[t.config.page]))switch(!0){case t.type==="door":return yield*Dr(t,e);case t.type==="player":{yield Yr(t,e);return}case t.type==="wall":{yield Ur(e,t);return}case t.type==="floor":{yield qr(e,t,o);return}case(t.type==="block"&&t.config.disappearing!==void 0&&Qe(D(t))>=2):{const a=D(t);for(let c=0;c<a.x;c++)for(let f=0;f<a.y;f++)for(let s=0;s<a.z;s++){const u=ee(t,d=>{d.position={x:t.position.x+c,y:t.position.y+f,z:t.position.z+s},d.config.times=te});yield*to(e,u,o,r,i,`${n}_${c}_${f}_${s}`)}break}case(t.type==="sceneryCrown"&&!Ke.getState().gameMenus.gameInPlay.planetsLiberated[t.config.planet]):return;default:{const a=Kt(t),c=t.config.times!==void 0?{aabb:ce(a.aabb,t.config.times),renderAabb:void 0}:a;let f;try{f=Br(t)}catch(s){throw new Error(`loadItemFromJson: error creating initial state for jsonItem ${JSON.stringify(t,null,2)}`,{cause:s})}yield{...t,...H,...c,id:`${e}${n}`,jsonItemId:e,fixedZIndex:t.type==="emitter"?K:void 0,shadowCastTexture:Zr(t),castsShadowWhileStoodOn:t.type==="monster"&&(t.config.which==="emperor"||t.config.which==="emperorsGuardian"||t.config.which==="turtle"||t.config.which==="helicopterBug")||t.type==="pickup"||t.type==="ball"||t.type==="lift"||t.type==="pushableBlock"||t.type==="sceneryPlayer"||t.type==="slidingDeadly"||t.type==="spring",config:t.config,state:f}}}}const Zr=e=>{switch(e.type){case"lift":case"switch":return"shadow.smallBlock";case"conveyor":return{textureId:"shadow.fullBlock",flipX:He(e.config.direction)==="x"};case"barrier":return{textureId:"shadow.barrier.y",flipX:e.config.axis==="x"};case"spring":case"firedDoughnut":case"slidingDeadly":return"shadow.smallRound";case"block":return e.config.style==="tower"?"shadow.smallRound":"shadow.fullBlock";case"pushableBlock":case"movingPlatform":case"hushPuppy":case"deadlyBlock":case"teleporter":case"spikes":return"shadow.fullBlock";case"portableBlock":return e.config.style==="drum"?"shadow.smallRound":"shadow.smallBlock";case"pickup":return e.config.gives==="scroll"?"shadow.scroll":"shadow.smallRound";case"ball":case"charles":case"monster":return"shadow.smallRound";case"slidingBlock":return e.config.style==="book"?"shadow.fullBlock":"shadow.smallRound"}},Ie=v.h,Kr=-12,Qr=e=>{const t=ne(e).filter(Zt).reduce((o,{config:{naturalFootprint:{position:{x:r,y:i},aabb:{x:n,y:a}}}})=>{const c=r+n,f=i+a;return{minX:Math.min(o.minX,r),maxX:Math.max(o.maxX,c),minY:Math.min(o.minY,i),maxY:Math.max(o.maxY,f)}},{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0});if(!(t.minX>t.maxY))return t};function*jr(e,t){const o=Qr(t);if(o===void 0)return;const{minX:r,maxX:i,minY:n,maxY:a}=o;e.roomBelow!==void 0&&(yield{...H,type:"portal",id:"portal/toRoomBelow",fixedZIndex:K,config:{toRoom:e.roomBelow,relativePoint:{x:(r+i)/2,y:(n+a)/2,z:Ie+v.h},direction:$.down},aabb:{x:i-r,y:a-n,z:Ie},state:{...M(),position:{x:r,y:n,z:Kr-Ie}},renders:!1}),e.roomAbove!==void 0&&(yield{...H,type:"portal",id:"portal/toRoomAbove",fixedZIndex:K,config:{toRoom:e.roomAbove,relativePoint:{...e.ceilingRelativePoint!==void 0?C(e.ceilingRelativePoint):{x:(r+i)/2,y:(n+a)/2},z:-12},direction:$.up},aabb:{x:i-r,y:a-n,z:Ie},state:{...M(),position:h({x:r,y:n},{z:v.h*(e.height??Nr)})}})}function*ei(e,t,o,r){const i=je(e.items);for(const[n,a]of i)a.type==="player"&&!r||(yield*to(n,a,e,t,o))}const _t=e=>X(e).reduce((t,o)=>({...t,[o.id]:o}),{}),oo=({roomJson:e,roomPickupsCollected:t,scrollsRead:o,isNewGame:r=!1})=>{const i=_t(ei(e,t,o,r)),n={..._t(jr(e,i)),...i};for(const c of ne(n)){const s=pr(c,Gt(n)).find(u=>De(c)&&De(u)&&!(c.type==="wall"&&u.type==="wall"));s!==void 0&&console.error(`in room ${e.id} item ${c.id} @${JSON.stringify(c.state.position)} #${JSON.stringify(c.aabb)} is colliding with (solid item) ${s.id} @${JSON.stringify(s.state.position)} #${JSON.stringify(s.aabb)} on loading room ${e.id}`)}for(const c of ne(n).filter(Ir)){const f=Tr(c,ne(n).filter(s=>s.id!==c.id));f!==void 0&&Sr({above:c,below:f})}return{...e,roomJson:e,items:n,roomTime:0}},ti=Pe([e=>O(e.levelEditor),e=>e.levelEditor.previewedEdits],(e,t)=>ee(e,o=>{const r=qt(t);for(const[i,n]of r)n===null?delete o.items[i]:o.items[i]=n})),oi=Pe([e=>O(e.levelEditor)],e=>oo({roomJson:e,roomPickupsCollected:N,scrollsRead:N,isNewGame:!0})),ri=Pe([ti],e=>oo({roomJson:e,roomPickupsCollected:N,scrollsRead:N,isNewGame:!0})),ii=Pe([oi],e=>{const{floors:{edgeLeftX:t,edgeRightX:o,bottomEdgeY:r},allItems:{topEdgeY:i}}=lr(e);return{l:t,r:o,w:o-t,b:r,t:i,h:r-i}}),ss=Lt(ri),as=Lt(ii),O=e=>e.campaignInProgress.rooms[e.currentlyEditingRoomId],Le=(e,t)=>e.campaignInProgress.rooms[t],ro=(e,t,o)=>e.campaignInProgress.rooms[o??e.currentlyEditingRoomId]?.items[t],ni=(e,t)=>e.selectedJsonItemIds.includes(t),st=e=>Qe(at(e))>0,at=e=>{switch(e.type){case"deadlyBlock":return te;case"conveyor":if(e.config.disappearing)return E;switch(e.config.direction){case"left":case"right":return{x:1,y:0,z:0};case"away":case"towards":return{x:0,y:1,z:0};default:throw e.config.direction,new Error}case"hushPuppy":return te;case"teleporter":return{x:1,y:1,z:0};case"floor":case"spikes":return{x:1,y:1,z:0};case"block":return te;case"barrier":if(e.config.disappearing)return E;switch(e.config.axis){case"x":return{x:1,y:0,z:1};case"y":return{x:0,y:1,z:1};default:throw e.config.axis,new Error}case"wall":switch(e.config.direction){case"left":case"right":return{x:0,y:1,z:1};case"away":case"towards":return{x:1,y:0,z:1};default:throw e.config,new Error}default:return E}};class ze{#o;#t;#e;constructor(t,o){this.#t={x:-t.x,y:-t.y,z:-t.z},this.#e={x:o.x-t.x+1,y:o.y-t.y+1,z:o.z-t.z+1},this.#o=Array.from({length:this.#e.x},()=>Array.from({length:this.#e.y},()=>Array.from({length:this.#e.z},()=>new Set)))}static fromItems(t){let o=1/0,r=1/0,i=1/0,n=-1/0,a=-1/0,c=-1/0;const f=[...t];for(const[,u]of f){const{x:d,y:l,z:y}=u.position,m=D(u);o=Math.min(o,d),r=Math.min(r,l),i=Math.min(i,y),n=Math.max(n,d+m.x-1),a=Math.max(a,l+m.y-1),c=Math.max(c,y+m.z-1)}if(f.length===0)return new ze({x:0,y:0,z:0},{x:0,y:0,z:0});const s=new ze({x:o,y:r,z:i},{x:n,y:a,z:c});for(const u of f){const[,d]=u,{x:l,y,z:m}=d.position,g=D(d);for(let p=0;p<g.x;p++)for(let x=0;x<g.y;x++)for(let b=0;b<g.z;b++)s.add({x:l+p,y:y+x,z:m+b},u)}return s}get(t){const o=t.x+this.#t.x,r=t.y+this.#t.y,i=t.z+this.#t.z;if(this.#r(o,r,i))return this.#o[o][r][i]}set(t,o){const r=t.x+this.#t.x,i=t.y+this.#t.y,n=t.z+this.#t.z;this.#r(r,i,n)&&(this.#o[r][i][n]=o)}add(t,o){const r=this.get(t);r&&r.add(o)}remove(t,o){const r=this.get(t);r&&r.delete(o)}get size(){return{...this.#e}}get minBounds(){return{x:-this.#t.x,y:-this.#t.y,z:-this.#t.z}}get maxBounds(){const t=this.minBounds;return{x:t.x+this.#e.x-1,y:t.y+this.#e.y-1,z:t.z+this.#e.z-1}}*iterate(){const{minBounds:t}=this;for(let o=0;o<this.#e.x;o++)for(let r=0;r<this.#e.y;r++)for(let i=0;i<this.#e.z;i++)yield[{x:o+t.x,y:r+t.y,z:i+t.z},this.#o[o][r][i]]}extractUniqueItems(){const t=new Set,o=[];for(const[,r]of this.iterate())for(const i of r)t.has(i)||(t.add(i),o.push(i));return o}#r(t,o,r){return t>=0&&t<this.#e.x&&o>=0&&o<this.#e.y&&r>=0&&r<this.#e.z}}const G=e=>e.type==="wall"?`wall/${e.config.direction}`:e.type==="teleporter"?yt({type:e.type,config:mt(e.config,"toPosition","times")}):yt({type:e.type,config:mt(e.config,"times")}),si=e=>st(e[1]),ai=e=>({x:Math.floor(e.x%1*re.x),y:Math.floor(e.y%1*re.y)}),ci=(e,t)=>`${e},${t}`,li=(e,t)=>{let o=e,r=o.length;for(;;){const i=[...fi(o,t)];if(i.length===r)return i;r=i.length,o=i}},di=(e,t=()=>!0)=>{const o=new Map,r=[];for(const n of e){const[,a]=n;if(!t(n))r.push(n);else if(st(a)){const c=ai(a.position),f=ci(c.x,c.y);o.has(f)||o.set(f,[]),o.get(f).push(n)}else r.push(n)}const i=[];for(const[n,a]of o)if(a.length>0){const c=a.map(([y,m])=>[y,{...m,position:{x:Math.floor(m.position.x),y:Math.floor(m.position.y),z:m.position.z}}]),f=li(c,t),[s,u]=n.split(",").map(Number),d=s/re.x,l=u/re.y;for(const[y,m]of f)i.push([y,{...m,position:{x:m.position.x+d,y:m.position.y+l,z:m.position.z}}])}return[...i,...r]},fi=(e,t=()=>!0)=>{const o=[],r=[];for(const l of e)t(l)&&si(l)?o.push(l):r.push(l);const i=ze.fromItems(o),n=i.size,{minBounds:a}=i,c=new Map,f=new Map;for(const[,l]of i.iterate())for(const[,y]of l){const m=G(y);f.has(m)||f.set(m,y)}for(const[l]of f)c.set(l,Array.from({length:n.x},()=>Array.from({length:n.y},()=>Array(n.z).fill(!1))));const s=(l,y)=>{const m=D(y),g={x:l.x+m.x-1,y:l.y+m.y-1,z:l.z+m.z-1},p=at(y),x=G(y),b=new Set;b.add(y);const A=I=>{const T=new Set;let P=!1;for(let{x:w}=l;w<=I.x;w++)for(let{y:k}=l;k<=I.y;k++)for(let{z:R}=l;R<=I.z;R++){const _=i.get({x:w,y:k,z:R});let Q=!1,ie=!1;if(_)for(const[,q]of _)G(q)===x?(Q=!0,T.add(q)):st(q)&&q.type!=="wall"&&(ie=!0);ie&&!Q&&(P=!0),(!_||_.size===0)&&(P=!0),Q||(P=!0)}if(P)return!1;let F=!1;for(const w of T)b.has(w)||(F=!0,b.add(w));if(!F)return!1;for(const w of T){const k=D(w),R={x:w.position.x+k.x-1,y:w.position.y+k.y-1,z:w.position.z+k.z-1};if(w.position.x<l.x||w.position.y<l.y||w.position.z<l.z||R.x>I.x||R.y>I.y||R.z>I.z)return!1}return!0};let z=!0;for(;z;){if(z=!1,p.x>0&&g.x+1<a.x+n.x){let I=g.x;for(let{y:T}=l;T<=g.y;T++)for(let{z:P}=l;P<=g.z;P++){const F=i.get({x:g.x+1,y:T,z:P});if(F){for(const[,w]of F)if(G(w)===x){const k=D(w),R=w.position.x+k.x-1;I=Math.max(I,R)}}}I>g.x&&A({...g,x:I})&&(g.x=I,z=!0)}if(p.y>0&&g.y+1<a.y+n.y){let I=g.y;for(let{x:T}=l;T<=g.x;T++)for(let{z:P}=l;P<=g.z;P++){const F=i.get({x:T,y:g.y+1,z:P});if(F){for(const[,w]of F)if(G(w)===x){const k=D(w),R=w.position.y+k.y-1;I=Math.max(I,R)}}}I>g.y&&A({...g,y:I})&&(g.y=I,z=!0)}if(p.z>0&&g.z+1<a.z+n.z){let I=g.z;for(let{x:T}=l;T<=g.x;T++)for(let{y:P}=l;P<=g.y;P++){const F=i.get({x:T,y:P,z:g.z+1});if(F){for(const[,w]of F)if(G(w)===x){const k=D(w),R=w.position.z+k.z-1;I=Math.max(I,R)}}}I>g.z&&A({...g,z:I})&&(g.z=I,z=!0)}}return g},u=(l,y)=>{if(l.type==="wall"){if(y.type!=="wall")throw new Error("only walls can join walls");if(l.config.direction!==y.config.direction)throw new Error("walls must have the same direction to join");return l.config.direction==="right"||l.config.direction==="towards"?l:{...l,config:{...l.config,tiles:[...l.config.tiles,...y.config.tiles]}}}return l},d=({x:l,y,z:m},{x:g,y:p,z:x},b)=>{const[A,z]=b,I=G(z),T=g-l+1,P=p-y+1,F=x-m+1;let w=z;if(T+P+F>3){const k={...z.config};if(z.type==="wall")switch(z.config.direction){case"away":case"left":break;case"towards":T!==1&&(k.times={x:T});break;case"right":P!==1&&(k.times={y:P});break}else{const R={...Qt(D(z))};T!==1&&(R.x=T),P!==1&&(R.y=P),F!==1&&(R.z=F),k.times=R}w={...z,config:k}}for(let k=l;k<=g;k++)for(let R=y;R<=p;R++)for(let _=m;_<=x;_++)if(c.get(I)[k-a.x][R-a.y][_-a.z]=!0,k!==l||R!==y||_!==m){const Q=i.get({x:k,y:R,z:_});if(Q)e:for(const ie of Q){const[,q]=ie;if(G(q)===I){q.position.x===k&&q.position.y===R&&q.position.z===_&&(w=u(w,q)),i.remove({x:k,y:R,z:_},ie);break e}}}return[A,w]};for(const[l,y]of i.iterate())for(const m of y){const[,g]=m;if(g.position.x===l.x&&g.position.y===l.y&&g.position.z===l.z){const p=G(g),x=c.get(p),b=l.x-a.x,A=l.y-a.y,z=l.z-a.z;if(x&&!x[b][A][z]){const I=s(l,g),T=d(l,I,m);i.remove(l,m),i.add(l,T)}}}return[...i.extractUniqueItems(),...r]},ct=(e,t)=>Object.fromEntries(di(Object.entries(e),t)),ui=e=>e[Math.floor(Math.random()*e.length)],io=(e,t)=>{e.planet=t;for(const o of Object.values(e.items))o.type==="floor"&&o.config.floorType==="standable"&&(o.config.scenery=t),o.type==="wall"&&(o.config.direction==="away"||o.config.direction==="left")&&(o.config.tiles=Array.from(ae(t,o.config.tiles.length))),o.type==="pickup"&&o.config.gives==="crown"&&ko.includes(t)&&(o.config.planet=t)},yi={x:8,y:8},mi=(e,t,o,r,i)=>{const n={};for(const u of i){const d={x:u.x*t.x,y:u.y*t.y},l=Jt(t);for(const[y,m]of Object.entries(l.items)){const g=`${y}_${u.x}_${u.y}`;n[g]={...m,position:{x:m.position.x+d.x,y:m.position.y+d.y,z:m.position.z}}}}const a=new Set;for(const u of i){const d=i.some(y=>y.x===u.x+1&&y.y===u.y),l=i.some(y=>y.x===u.x&&y.y===u.y+1);d&&(a.add(`leftWall_${u.x}_${u.y}`),a.add(`rightWall_${u.x+1}_${u.y}`)),l&&(a.add(`awayWall_${u.x}_${u.y}`),a.add(`towardsWall_${u.x}_${u.y+1}`))}for(const u of a)delete n[u];const c=ct(n),f=i.length>1?Object.fromEntries(i.map((u,d)=>[d.toString(),{gridPosition:u,physicalPosition:{from:{x:u.x*t.x,y:u.y*t.y},to:{x:(u.x+1)*t.x-1,y:(u.y+1)*t.y-1}}}])):void 0,s={id:e,planet:"blacktooth",color:o,items:c,...f&&{meta:{subRooms:f}}};return io(s,r),s},lt=({state:e,scenery:t,maybeColour:o,roomSize:r=yi,gridPositions:i=[{x:0,y:0}]})=>{const a=`room_${X(Ro({start:0})).find(s=>e.campaignInProgress.rooms[`room_${s}`]===void 0)}`,c=o??{hue:ui(zo),shade:Math.random()<.66?"basic":"dimmed"},f=mi(a,r,c,t,i);return e.campaignInProgress.rooms[a]=f,f},Re=(e,t,o=!1)=>{if(!e.campaignInProgress.rooms[t]){console.warn(`can't change to room ${t} - it doesn't exist`);return}o||e.editingRoomIdHistory.back.push(e.currentlyEditingRoomId),e.currentlyEditingRoomId=t,e.clickableAnnotationHovered=!1,e.hoveredItem=void 0,e.selectedJsonItemIds=[],o||(e.history=ot.history)},pi={addRoom(e,{payload:{roomSize:t,gridPositions:o=[{x:0,y:0}]}}){const{planet:r}=O(e),i=lt({state:e,scenery:r,roomSize:t,gridPositions:o});Re(e,i.id)},removeRoom(e){const t=e.campaignInProgress.rooms[e.currentlyEditingRoomId],r=Xe(L(t.items,"door","teleporter"))?.[1].config.toRoom??Xe(Uo(i=>i!==e.currentlyEditingRoomId,Eo(e.campaignInProgress.rooms)));r!==void 0&&(delete e.campaignInProgress.rooms[e.currentlyEditingRoomId],e.currentlyEditingRoomId=r)}},ke=(e,t,o,r)=>t.some(i=>i.config.direction===e)?"doorway":o===void 0?"wall":Object.values(o).some(({gridPosition:i})=>Po($[e],Xt(i,r)))?"open":"wall";function*j(e){try{yield*gi(e)}catch(t){const o=t;throw new Error(`
  error in recursion ${e.roomId}/${e.subRoomId??"*"}`,{cause:o})}}function*gi({roomId:e,subRoomId:t="*",campaign:o,visited:r={},vectorFromPrevious:i,previousRoomGridPosition:n=E}){if(e==="nowhere"||r[e]?.[t])return;r[e]===void 0&&(r[e]={}),r[e][t]=!0;const a=o.rooms[e];if(a===void 0)throw new Error(`no room in the campaign with id="${e}"`);const c=[...X(oe(a.items)).filter(y=>y.type==="door").filter(y=>et(y.position,"block",a)===t)],f=h(n,i===void 0?Ao:i),s=a.meta?.subRooms;if(s){if(t==="*")throw new Error(`subRoomId '*' means 'all' and is not allowed for big rooms. Must be one of the sub-rooms in ${e}: ${Object.keys(s)}`);if(!s[t])throw new Error(`Sub-room ${t} not found in room ${e}. Available sub-rooms: ${Object.keys(s)}`)}const u=s?.[t].gridPosition,d={left:ke("left",c,s,u),right:ke("right",c,s,u),away:ke("away",c,s,u),towards:ke("towards",c,s,u)};if(yield{roomId:e,subRoomId:t,gridPosition:f,boundaries:d},s!==void 0){if(u===void 0)throw new Error(`Sub-room ${t} not found in room ${e}. Available sub-rooms: ${Object.keys(s)}`);for(const[y,{gridPosition:m}]of X(je(s)))y!==t&&(yield*j({roomId:e,subRoomId:y,campaign:o,visited:r,vectorFromPrevious:Ae({...m,z:0},u),previousRoomGridPosition:f}))}if(a.roomAbove!==void 0){const{roomAbove:y,subRoomAbove:m}=a;yield*j({roomId:y,subRoomId:m,campaign:o,visited:r,vectorFromPrevious:$.up,previousRoomGridPosition:f})}if(a.roomBelow!==void 0){const{roomBelow:y,subRoomBelow:m}=a;yield*j({roomId:y,subRoomId:m,campaign:o,visited:r,vectorFromPrevious:$.down,previousRoomGridPosition:f})}for(const y of c){const{toRoom:m}=y.config;try{yield*j({roomId:m,campaign:o,visited:r,subRoomId:y.config.meta?.toSubRoom,vectorFromPrevious:$[y.config.direction],previousRoomGridPosition:f})}catch(g){throw new Error(`error while traversing door ${JSON.stringify(y,null,2)} in room ${e} to room ${m}`,{cause:g})}}const l=a.meta?.nonContiguousRelationship;if(l!==void 0){const{with:{room:y},gridOffset:m}=l;yield*j({roomId:y,campaign:o,visited:r,subRoomId:"*",vectorFromPrevious:m,previousRoomGridPosition:f})}}const no=(e,t)=>{for(let o=1;;o++){const r=o===1?t:`${t}_${o}`;if(!e.items[r])return r}},so=(e,t,o)=>{if(t.type==="player"){const{which:i}=t.config;return o?`preview-${i}`:i}const r=t.type==="monster"?t.config.which:t.type;return no(e,r)},Ge=(e,t,o,r)=>{const i=O(e),n=so(i,t,r),a=ao(e,r),c={type:t.type,config:t.config,position:o};return a[n]=c,[n,c]},ao=(e,t,o=e.currentlyEditingRoomId)=>t?e.previewedEdits:e.campaignInProgress.rooms[o].items;function*co(e,t,o){for(const r of je(e)){const[i,n]=r;if(n===null||n.type!=="wall"||n.config.direction!==t)continue;const{position:a,config:c}=n,f=Or(de(c)),s=Ze(He(c.direction)),u=He(c.direction),d=Ae(o,a);if(d[u]!==0||d[s]<-1||d[s]>=f[s])continue;if(d[s]===0&&f[s]===2){yield[i,null];continue}const l=2+d[s];if(l===1||l===2){const b=ee(n,A=>{A.position=h(a,{[s]:l});const z=A.config;switch(z.direction){case"towards":case"right":z.times[s]=f[s]-l;break;default:z.tiles=z.tiles.slice(l)}});yield[i,b];continue}const m=f[s]-d[s];if(m===2||m===1){const b=ee(n,A=>{const z=A.config;switch(z.direction){case"towards":case"right":z.times[s]=f[s]-m;break;default:z.tiles=z.tiles.slice(0,-m)}});yield[i,b];continue}const p=ee(n,b=>{const A=b.config;switch(A.direction){case"towards":case"right":A.times[s]=d[s];break;default:A.tiles=A.tiles.slice(0,d[s])}});yield[`${i}/beforeDoor`,p];const x=ee(n,b=>{b.position={...a,[s]:o[s]+2};const A=b.config;switch(A.direction){case"towards":case"right":A.times[s]=f[s]-d[s]-2;break;default:A.tiles=A.tiles.slice(d[s]+2)}});yield[`${i}/afterDoor`,x],yield[i,null]}}const lo=(e,t,o,r,i)=>{const n=Le(e,t);if(n===void 0)throw new Error("can't cut hole in walls for a room that does not exist");const a=ao(e,i,t);for(const[c,f]of co(n.items,o,r))i?a[c]=f:f===null?delete a[c]:a[c]=f},hi=({state:e,fromRoomJson:t,subRoomId:o,direction:r,isPreview:i,autoAddRooms:n})=>{const a=e.campaignInProgress,c=j({campaign:a,roomId:t.id,subRoomId:o}),f=X(c).find(({gridPosition:s})=>To(s,$[r]));if(f)return a.rooms[f.roomId];if(!i)return n?lt({state:e,scenery:t.planet}):void 0},bi=e=>L(e.items,"floor").reduce((t,[,o])=>{const r=o.position.y;return Math.min(t,r)},Number.POSITIVE_INFINITY),xi=e=>L(e.items,"floor").reduce((t,[,o])=>{const r=o.position.y+o.config.times.y;return Math.max(t,r)},Number.NEGATIVE_INFINITY),wi=e=>L(e.items,"floor").reduce((t,[,o])=>{const r=o.position.x;return Math.min(t,r)},Number.POSITIVE_INFINITY),vi=e=>L(e.items,"floor").reduce((t,[,o])=>{const r=o.position.x+o.config.times.x;return Math.max(t,r)},Number.NEGATIVE_INFINITY),fo=({state:e,fromRoomJson:t,toRoomJson:o,outgoingDoorEntry:[r,i]})=>{const n=i.config.direction,a=i.position,c=et(i.position,"block",t),f=no(o,"door"),s={x:n==="left"?wi(o):n==="right"?vi(o):a.x,y:n==="away"?bi(o):n==="towards"?xi(o):a.y,z:a.z},u=Yt(n),d={type:"door",config:{toRoom:t.id,direction:u,meta:c==="*"?void 0:{toSubRoom:c}},position:s};o.items[f]=d,d.config.toDoor=r,i.config.toDoor=f,lo(e,o.id,u,s,!1)},Ii=(e,t,o,r,i)=>{const n=O(e),a=o;lo(e,n.id,a,t,i);const c=r.config.toRoom==="+",f=et(t,"block",n),s=hi({state:e,fromRoomJson:n,subRoomId:f,direction:a,isPreview:i,autoAddRooms:c}),[u,d]=Ge(e,{type:"door",config:{...r.config,toRoom:s?s.id:r.config.toRoom,direction:a}},t,i);!i&&s&&fo({state:e,fromRoomJson:n,toRoomJson:s,outgoingDoorEntry:[u,d]})},Je=(e,t)=>{const o=O(e);o.items=ct(o.items,t);const r=e.selectedJsonItemIds.filter(i=>o.items[i]!==void 0);r.length!==e.selectedJsonItemIds.length&&(e.selectedJsonItemIds=r)},Z=e=>{const t=structuredClone(Y(O(e))),{history:o}=e;o.redo=[],o.undo.push(t)},ki={undo(e){const t=e,{campaignInProgress:o,history:{undo:r,redo:i},currentlyEditingRoomId:n}=t;r.length!==0&&(i.push(o.rooms[n]),o.rooms[n]=r.pop())},redo(e){const t=e,{campaignInProgress:o,history:{redo:r,undo:i},currentlyEditingRoomId:n}=t;r.length!==0&&(i.push(o.rooms[n]),o.rooms[n]=r.pop())}},Ri={selectCanUndo:e=>e.history.undo.length>0,selectCanRedo:e=>e.history.redo.length>0},zi=e=>e.type==="door",Ei=e=>e.type==="monster"&&e.config.which==="cyberman",Ai={applyItemTool(e,{payload:{blockPosition:t,pointedAtItemJson:o,preview:r}}){const i=e,{tool:n}=i;if(n.type!=="item")throw new Error("applying item tool reducer while the current tool is not an item tool");switch(r||(Z(i),i.previewedEdits={}),i.selectedJsonItemIds=[],!0){case zi(n.item):{if(o.type!=="wall")throw new Error("doors can only be added on walls");Ii(i,t,o.config.direction,n.item,r);break}case(Ei(n.item)&&o.type==="deadlyBlock"&&o.config.style==="toaster"&&o.position.z+1===t.z):{Ge(i,{...n.item,config:{...n.item.config,activated:"off"}},t,r);break}default:Ge(i,n.item,t,r)}r||(i.autoCoalesce?Je(i):Je(i,a=>a.type==="wall"))}},Pi={setCampaignName(e,{payload:t}){const o=e;o.campaignInProgress.locator.campaignName=t},setCampaignUserId(e,{payload:t}){const o=e;o.campaignInProgress.locator.userId=t},setCampaignPublished(e,{payload:t}){const o=e;o.campaignInProgress.meta===void 0?o.campaignInProgress.meta={published:!1}:o.campaignInProgress.meta.published=t}},Ti={changeToRoom(e,{payload:t}){Re(e,t)},roomBack(e){const t=e,{editingRoomIdHistory:o}=t;if(o.back.length===0)return;const r=o.back.pop();o.forward.push(t.currentlyEditingRoomId),Re(t,r,!0)},roomForward(e){const t=e,{editingRoomIdHistory:o}=t;if(o.forward.length===0)return;const r=o.forward.pop();o.back.push(t.currentlyEditingRoomId),Re(t,r,!0)}},Si={changeDragInProgress(e,{payload:t}){const o=e;o.dragInProgress=t}},Ci={changeGridResolution(e,{payload:t}){const o=e;o.gridResolution=t},changeWallsFloorsLocked(e,{payload:t}){const o=e;o.wallsFloorsLocked=t}},Oi=(e,t)=>{const o=e.currentlyEditingRoomId,r=O(e);for(const i of oe(e.campaignInProgress.rooms)){se(i).filter(a=>a.type==="door"||a.type==="teleporter").filter(a=>a.config.toRoom===o).forEach(a=>{a.config.toRoom=t});const n=i.meta?.nonContiguousRelationship?.with;n?.room===o&&(n.room=t)}e.campaignInProgress.rooms[t]={...r,id:t},delete e.campaignInProgress.rooms[o],e.currentlyEditingRoomId=t};function*uo(e,t){const o={type:"wall",config:eo(e.config.direction)?e.config.direction==="towards"?{direction:e.config.direction,times:{x:2}}:{direction:e.config.direction,times:{y:2}}:{direction:e.config.direction,tiles:[...ae(t.planet,2,e.position[e.config.direction==="away"?"x":"y"])]},position:{...e.position,z:0}};yield[so(t,o,!1),o]}const Fi=(e,t)=>{const o=e.items[t];if(o.type==="door"){for(const[r,i]of uo(o,e))e.items[r]=i;e.items=ct(e.items)}delete e.items[t]},Mt=(e,t)=>{se(e).filter(o=>o.type==="floor").filter(o=>o.position.z===0).forEach(o=>{o.config={...o.config,floorType:t,scenery:t==="standable"?e.planet:void 0}})},Ni={changeRoomColour(e,{payload:t}){const o=e,r=o.campaignInProgress.rooms[o.currentlyEditingRoomId].color;Z(o),Object.assign(r,t)},changeRoomScenery(e,{payload:t}){const o=e,r=O(o);Z(o),io(r,t)},roomJsonEdited(e,{payload:t}){const o=e;Z(o);const{rooms:r}=o.campaignInProgress,i=r[o.currentlyEditingRoomId];r[o.currentlyEditingRoomId]=t;const n=o.selectedJsonItemIds.filter(f=>t.items[f]!==void 0);n.length!==o.selectedJsonItemIds.length&&(o.selectedJsonItemIds=n),t.id!==o.currentlyEditingRoomId&&Oi(o,t.id),L(t.items,"door").filter(([f,s])=>i.items[f]?.type==="door").filter(([,f])=>r[f.config.toRoom]!==void 0).forEach(([f,s])=>{const u=r[s.config.toRoom],d=Yt(s.config.direction),l=L(u.items,"door").filter(([,y])=>y.config.direction===d).toArray();switch(l.length){case 0:fo({state:o,outgoingDoorEntry:[f,s],fromRoomJson:t,toRoomJson:u});break;case 1:{const[[,y]]=l;y.config.toRoom=t.id,y.config.toDoor=f;break}}});const a=i.meta?.nonContiguousRelationship,c=t.meta?.nonContiguousRelationship;if(c!==void 0){const f=r[c.with.room];f.meta={...f.meta,nonContiguousRelationship:{with:{room:t.id},gridOffset:Ue(c.gridOffset,-1)}}}if(a?.with.room!==void 0&&c?.with.room!==a.with.room){const f=r[a.with.room];f.meta?.nonContiguousRelationship?.with.room===o.currentlyEditingRoomId&&delete f.meta.nonContiguousRelationship}},deleteSelected(e){const t=e,o=O(t);Z(t),t.selectedJsonItemIds.forEach(r=>{Fi(o,r)}),t.selectedJsonItemIds=[]},clearRoom(e){const t=e,o=O(t);Z(t);for(const r of Ve(o.items)){const i=o.items[r];i.type!=="floor"&&i.type!=="wall"&&i.type!=="door"&&(delete o.items[r],t.selectedJsonItemIds=t.selectedJsonItemIds.filter(n=>n!==r))}},setRoomAboveOrBelow(e,{payload:t}){const o=e,r=t.direction==="above"?"roomAbove":"roomBelow",i=r==="roomAbove"?"roomBelow":"roomAbove",n=O(o),a=t.createNew?lt({state:o,scenery:n.planet,maybeColour:n.color}).id:t.roomId,c=n[r]&&Le(o,n[r]);c?.[i]===o.currentlyEditingRoomId&&(c[i]=void 0),n[r]=a;const f=a&&Le(o,a);f!==void 0&&(f[i]=n.id),f?Mt(r==="roomBelow"?n:f,"none"):Mt(r==="roomBelow"?n:c,"standable")}},$i=(e,t)=>{const o=qt(t);for(const[r,i]of o)i===null?delete e.items[r]:e.items[r]=i},Wi={setAutoCoalesce(e,t){e.autoCoalesce=t.payload},resetPreviewedEdits(e){e.previewedEdits={}},commitCurrentPreviewedEdits(e){Z(e),$i(O(e),e.previewedEdits),e.autoCoalesce&&Je(e),e.previewedEdits={}}},Bi=(e,...t)=>({x:e(...t.map(o=>o.x)),y:e(...t.map(o=>o.y)),z:e(...t.map(o=>o.z))}),Ht=(e,t,o)=>{const r=o-e.length;r>0?e.push(...ae(t,r,e.length)):r<0&&e.splice(o)};function yo(e,t){const o=de(e.config),r=h(t.position,t.config.times);switch(e.config.direction){case"towards":if(e.position.y===t.position.y&&e.position.x>=t.position.x&&e.position.x<r.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:o.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===t.position.x&&o.x===t.config.times.x,wallTouchesFloorEnd:e.position.x+(o.x??1)===r.x};break;case"right":if(e.position.x===t.position.x&&e.position.y>=t.position.y&&e.position.y<r.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:o.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===t.position.y&&o.y===t.config.times.y,wallTouchesFloorEnd:e.position.y+(o.y??1)===r.y};break;case"away":if(e.position.y===t.position.y+t.config.times.y&&e.position.x>=t.position.x&&e.position.x<r.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:o.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===t.position.x&&o.x===t.config.times.x,wallTouchesFloorEnd:e.position.x+(o.x??1)===r.x};break;case"left":if(e.position.x===t.position.x+t.config.times.x&&e.position.y>=t.position.y&&e.position.y<r.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:o.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===t.position.y&&o.y===t.config.times.y,wallTouchesFloorEnd:e.position.y+(o.y??1)===r.y};break}return null}function*mo(e,t,o,r,i){const n=h(t.position,r),a=t.config.times,c=i?h(a,i):t.config.times,f=h(t.position,a),s=h(n,c);for(const[u,d]of X(e)){if(d.type==="wall"&&d.position.z!==t.position.z)continue;if(d.type==="door"){const g=d.config;let p=!1,x={...Y(d.position)};switch(g.direction){case"towards":d.position.y===t.position.y&&d.position.x>=t.position.x&&d.position.x<t.position.x+a.x&&(p=!0,x=h(d.position,r));break;case"right":d.position.x===t.position.x&&d.position.y>=t.position.y&&d.position.y<t.position.y+a.y&&(p=!0,x=h(d.position,r));break;case"away":d.position.y===t.position.y+a.y&&d.position.x>=t.position.x&&d.position.x<t.position.x+a.x&&(p=!0,x=h(d.position,{x:r.x,y:r.y+(i?.y??0),z:r.z}));break;case"left":d.position.x===t.position.x+a.x&&d.position.y>=t.position.y&&d.position.y<t.position.y+a.y&&(p=!0,x=h(d.position,{x:r.x+(i?.x??0),y:r.y,z:r.z}));break}if(p){const b=structuredClone(Y(d));b.position=x,yield[u,b]}continue}const l=d,y=yo(l,t);if(!y||!y.isOnFloorEdge)continue;const m=structuredClone(Y(l));switch(l.config.direction){case"towards":case"right":m.position=h(l.position,r);break;case"away":{const g=n.y+c.y;m.position={...l.position,x:l.position.x+r.x,y:g};break}case"left":{const g=n.x+c.x;m.position={...l.position,x:g,y:l.position.y+r.y};break}}if(y.wallFullySpansFloor){const g=c[y.tangentAxis];l.config.direction==="away"||l.config.direction==="left"?Ht(m.config.tiles,o,g):m.config.times={[y.tangentAxis]:g},yield[u,m]}else{const g=t.position[y.tangentAxis],p=f[y.tangentAxis],x=n[y.tangentAxis],b=s[y.tangentAxis],A=m.position[y.tangentAxis];if(A>=b){yield[u,null];continue}const z=Math.max(y.wallStart,g),T=Math.min(y.wallStart+y.wallLength,p)-z;let P;if(l.config.direction==="away"||l.config.direction==="left"){const R=t.position[y.normalAxis]+a[y.normalAxis],_=n[y.normalAxis]+c[y.normalAxis];P=R!==_}else P=t.position[y.normalAxis]!==n[y.normalAxis];const F=Math.max(A,x);let w;y.wallTouchesFloorEnd&&!P?w=b:w=Math.min(A+T,b);const k=w-F;k<=0?yield[u,null]:(l.config.direction==="away"||l.config.direction==="left"?Ht(m.config.tiles,o,k):m.config.times={[y.tangentAxis]:k},yield[u,m])}}}function*_i(e,t,o,r){for(const[i,n]of L(e.items,"floor")){const a=yo(t,n);if(!a)continue;const c={x:0,y:0,z:0},f={x:0,y:0,z:0},s=o[a.normalAxis],u=o[a.tangentAxis],d=r?r[a.tangentAxis]:0;if(s!==0&&(t.config.direction==="towards"||t.config.direction==="right"?(c[a.normalAxis]=s,f[a.normalAxis]=-s):f[a.normalAxis]=s),u!==0&&(a.wallStart===n.position[a.tangentAxis]?(c[a.tangentAxis]=u,f[a.tangentAxis]=-u):a.wallTouchesFloorEnd&&(f[a.tangentAxis]=u)),d!==0&&a.wallTouchesFloorEnd&&(f[a.tangentAxis]=d),c.x!==0||c.y!==0||f.x!==0||f.y!==0){const l=h(n.config.times,f),y={...n,position:h(n.position,c),config:{...n.config,times:{x:l.x,y:l.y}}};yield[i,y]}yield*mo(L(e.items,"wall","door"),n,e.planet,c,f)}}const Mi={moveOrResizeItemAsPreview(e,{payload:{jsonItemIds:t,timesDelta:o,positionDelta:r}}){const i=e,n=O(i);for(const a of t){const c=ro(i,a);if(c===void 0)throw new Error(`no json item found for some of the ids in resize ${a}`);if(c.type==="wall"){for(const[s,u]of _i(n,c,r,o))i.previewedEdits[s]=u;continue}if(c.type==="floor")for(const[s,u]of mo(L(n.items,"wall","door"),c,n.planet,r,o))i.previewedEdits[s]=u;if(c.type==="door"){console.log("before healing, room items are",Y(n.items));for(const[s,u]of uo(c,Y(n)))console.log("healing",`"${s}"`,u),i.previewedEdits[s]=u}const f={...c,position:h(c.position,r),config:{...c.config}};if(i.previewedEdits[a]=f,Hi(f,o),c.type==="door"){console.log("before cutting room plus previews is",{...Y(n.items),...Y(i.previewedEdits)});for(const[s,u]of co({...Y(n.items),...Y(i.previewedEdits)},f.config.direction,f.position))console.log("cutting",`"${s}"`,u),i.previewedEdits[s]=u}}i.dragInProgress=!0}},Hi=(e,t)=>{if(t!==void 0){const o=D(e),r=at(e),i=So(t,r);if(Qe(i)>0){const n=Qt(Bi((a,c)=>Math.max(1,a+c),o,i));n===void 0?delete e.config.times:e.config.times=n}}},Xi={loadCampaign(e,{payload:{campaign:t}}){const o=e;o.remoteCampaign=t,o.campaignInProgress=t,o.hoveredItem=void 0,o.selectedJsonItemIds=[],o.clickableAnnotationHovered=!1,o.dragInProgress=!1,o.history=ot.history;const r=X(oe(t.rooms)).find(i=>se(i).some(n=>n.type==="player"&&n.config.which==="head"))?.id??X(oe(t.rooms)).find(i=>se(i).some(n=>n.type==="player"&&n.config.which==="heels"))?.id??Xe(Ve(t.rooms));if(r===void 0)throw new Error("could not find any rooms in this campaign");o.currentlyEditingRoomId=r},setRemoteCampaign(e,{payload:{campaign:t}}){const o=e;o.remoteCampaign=t}},Di={setSelectedItemsInRoom(e,{payload:{jsonItemIds:t}}){const o=O(e).items;t.forEach(r=>{if(!o[r])throw new Error(`Item with json item id "${r}" is not in the current room`)}),e.selectedJsonItemIds=t},toggleSelectedItemInRoom(e,{payload:{jsonItemId:t}}){const o=e.selectedJsonItemIds.indexOf(t);o===-1?e.selectedJsonItemIds.push(t):e.selectedJsonItemIds.splice(o,1)},setHoveredItemInRoom(e,t){e.hoveredItem=t.payload},setClickableAnnotationHovered(e,t){e.clickableAnnotationHovered=t.payload}},qi=[1,.5,.125],dt=Co({name:"levelEditor",initialState:ot,reducers:{setTool(e,{payload:t}){const o=e;t.type==="item"&&(o.selectedJsonItemIds=[],o.hoveredItem=void 0),o.tool=t},injected(){},...Ci,...ki,...Ai,...Si,...Di,...Ni,...Mi,...Wi,...Xi,...pi,...Ti,...Pi},selectors:{selectCurrentCampaignInProgress:e=>e.campaignInProgress,selectCurrentEditingRoomJson:O,selectItem:ro,selectCurrentEditingRoomColour:e=>O(e).color,selectCurrentEditingRoomScenery:e=>O(e).planet,selectTool:e=>e.tool,selectSelectedJsonItemIds:e=>e.selectedJsonItemIds,selectHoveredItem:e=>e.hoveredItem,selectItemIsSelected:ni,...Ri}}),{addRoom:Yi,applyItemTool:Li,changeDragInProgress:Gi,changeGridResolution:Ji,changeRoomColour:Vi,changeRoomScenery:Ui,changeToRoom:Zi,changeWallsFloorsLocked:Ki,clearRoom:Qi,commitCurrentPreviewedEdits:ji,deleteSelected:en,injected:tn,loadCampaign:on,moveOrResizeItemAsPreview:rn,redo:nn,removeRoom:sn,resetPreviewedEdits:an,roomBack:cn,roomForward:ln,roomJsonEdited:dn,setAutoCoalesce:fn,setCampaignName:un,setCampaignPublished:yn,setCampaignUserId:mn,setClickableAnnotationHovered:pn,setHoveredItemInRoom:gn,setRemoteCampaign:hn,setRoomAboveOrBelow:bn,setSelectedItemsInRoom:xn,setTool:wn,toggleSelectedItemInRoom:vn,undo:In}=dt.actions,{selectCanRedo:kn,selectCanUndo:Rn,selectCurrentCampaignInProgress:zn,selectCurrentEditingRoomColour:En,selectCurrentEditingRoomJson:An,selectCurrentEditingRoomScenery:Pn,selectHoveredItem:Tn,selectItem:Sn,selectItemIsSelected:Cn,selectSelectedJsonItemIds:On,selectTool:Fn}=dt.selectors,Nn=Oo.withTypes(),cs=Object.freeze(Object.defineProperty({__proto__:null,addRoom:Yi,applyItemTool:Li,changeDragInProgress:Gi,changeGridResolution:Ji,changeRoomColour:Vi,changeRoomScenery:Ui,changeToRoom:Zi,changeWallsFloorsLocked:Ki,clearRoom:Qi,commitCurrentPreviewedEdits:ji,deleteSelected:en,gridResolutions:qi,injected:tn,levelEditorSlice:dt,loadCampaign:on,moveOrResizeItemAsPreview:rn,redo:nn,removeRoom:sn,resetPreviewedEdits:an,roomBack:cn,roomForward:ln,roomJsonEdited:dn,selectCanRedo:kn,selectCanUndo:Rn,selectCurrentCampaignInProgress:zn,selectCurrentEditingRoomColour:En,selectCurrentEditingRoomJson:An,selectCurrentEditingRoomScenery:Pn,selectHoveredItem:Tn,selectItem:Sn,selectItemIsSelected:Cn,selectSelectedJsonItemIds:On,selectTool:Fn,setAutoCoalesce:fn,setCampaignName:un,setCampaignPublished:yn,setCampaignUserId:mn,setClickableAnnotationHovered:pn,setHoveredItemInRoom:gn,setRemoteCampaign:hn,setRoomAboveOrBelow:bn,setSelectedItemsInRoom:xn,setTool:wn,toggleSelectedItemInRoom:vn,undo:In,useAppSelectorWithLevelEditorSlice:Nn},Symbol.toStringTag,{value:"Module"}));export{ts as $,ji as A,ar as B,oi as C,ii as D,Fn as E,Gi as F,as as G,Zi as H,Nn as I,B as J,Zn as K,Vn as L,Un as M,vr as N,Qn as O,lr as P,Xn as Q,Nr as R,qe as S,Yn as T,Rr as U,jn as V,Fr as W,Kn as X,K as Y,os as Z,es as _,De as a,rs as a0,is as a1,pn as a2,On as a3,S as a4,rt as a5,it as a6,Jn as a7,ss as a8,Fo as a9,Vi as aA,bn as aB,Pn as aC,Ui as aD,Lt as aE,sr as aF,Hn as aG,un as aH,yn as aI,mn as aJ,hn as aK,on as aL,Rn as aM,kn as aN,In as aO,nn as aP,Ki as aQ,ae as aR,cs as aS,_o as aa,nr as ab,Ln as ac,Mn as ad,er as ae,_n as af,et as ag,An as ah,j as ai,Yi as aj,sn as ak,fn as al,cn as am,ln as an,Qi as ao,O as ap,dn as aq,en as ar,qi as as,Ji as at,Hi as au,to as av,Uo as aw,Gn as ax,zn as ay,En as az,Dn as b,v as c,gn as d,ro as e,wn as f,qn as g,Or as h,ne as i,ns as j,we as k,Li as l,D as m,at as n,Bi as o,V as p,Sn as q,an as r,Tn as s,Cn as t,$ as u,xn as v,de as w,st as x,rn as y,vn as z};
