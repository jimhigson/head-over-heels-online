import{a5 as M,a6 as ae,a7 as D,a8 as O,a9 as G,aa as A,ab as N,ac as we,ad as po,ae as ne,af as Ve,ag as Ke,ah as go,ai as ho,aj as Io,ak as vo,al as xo,am as L,an as wo,ao as Ce,ap as U,aq as Ze,ar as bo,as as Ro,at as Qe,au as Eo,av as eo,aw as zo,ax as ko,ay as Ao}from"./index-ck1mDU6s.js";var Y={},V={},Pe;function So(){if(Pe)return V;Pe=1;function e(d,u){var i;if(typeof Symbol>"u"||d[Symbol.iterator]==null){if(Array.isArray(d)||(i=o(d))||u){i&&(d=i);var f=0,c=function(){};return{s:c,n:function(){return f>=d.length?{done:!0}:{done:!1,value:d[f++]}},e:function(y){throw y},f:c}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var s=!0,m=!1,p;return{s:function(){i=d[Symbol.iterator]()},n:function(){var y=i.next();return s=y.done,y},e:function(y){m=!0,p=y},f:function(){try{!s&&i.return!=null&&i.return()}finally{if(m)throw p}}}}function o(d,u){if(d){if(typeof d=="string")return t(d,u);var i=Object.prototype.toString.call(d).slice(8,-1);if(i==="Object"&&d.constructor&&(i=d.constructor.name),i==="Map"||i==="Set")return Array.from(d);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return t(d,u)}}function t(d,u){(u==null||u>d.length)&&(u=d.length);for(var i=0,f=new Array(u);i<u;i++)f[i]=d[i];return f}var r=M(),n=r.ensureIterable;function a(d){var u=[],i=e(d),f;try{for(i.s();!(f=i.n()).done;){var c=f.value;u.push(c)}}catch(s){i.e(s)}finally{i.f()}return u}V.__toArray=a;function l(d){return a(n(d))}return V.toArray=l,V}var Te;function Co(){if(Te)return Y;Te=1;var e=ae(),o=e.mark(l),t=M(),r=t.iterableCurry,n=So(),a=n.__toArray;function l(u,i){var f;return e.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(f=Array.isArray(u)?u:a(u),f.length){s.next=3;break}return s.abrupt("return");case 3:if(!i--){s.next=7;break}return s.delegateYield(f,"t0",5);case 5:s.next=3;break;case 7:case"end":return s.stop()}},o)}Y.__cycleTimes=l;var d=r(l);return Y.cycleTimes=d,Y}var K={},Fe;function Po(){if(Fe)return K;Fe=1;var e=ae(),o=e.mark(d);function t(i,f){var c;if(typeof Symbol>"u"||i[Symbol.iterator]==null){if(Array.isArray(i)||(c=r(i))||f){c&&(i=c);var s=0,m=function(){};return{s:m,n:function(){return s>=i.length?{done:!0}:{done:!1,value:i[s++]}},e:function(h){throw h},f:m}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,g=!1,y;return{s:function(){c=i[Symbol.iterator]()},n:function(){var h=c.next();return p=h.done,h},e:function(h){g=!0,y=h},f:function(){try{!p&&c.return!=null&&c.return()}finally{if(g)throw y}}}}function r(i,f){if(i){if(typeof i=="string")return n(i,f);var c=Object.prototype.toString.call(i).slice(8,-1);if(c==="Object"&&i.constructor&&(c=i.constructor.name),c==="Map"||c==="Set")return Array.from(i);if(c==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return n(i,f)}}function n(i,f){(f==null||f>i.length)&&(f=i.length);for(var c=0,s=new Array(f);c<f;c++)s[c]=i[c];return s}var a=M(),l=a.iterableCurry;function d(i,f){var c,s,m,p;return e.wrap(function(y){for(;;)switch(y.prev=y.next){case 0:c=0,s=t(i),y.prev=2,s.s();case 4:if((m=s.n()).done){y.next=11;break}if(p=m.value,!f(p,c++)){y.next=9;break}return y.next=9,p;case 9:y.next=4;break;case 11:y.next=16;break;case 13:y.prev=13,y.t0=y.catch(2),s.e(y.t0);case 16:return y.prev=16,s.f(),y.finish(16);case 19:case"end":return y.stop()}},o,null,[[2,13,16,19]])}K.__filter=d;var u=l(d);return K.filter=u,K}var Z={},Oe;function To(){if(Oe)return Z;Oe=1;var e=M(),o=e.iterableCurry,t=Co(),r=t.__cycleTimes;function n(l){return r(l,1/0)}Z.__cycle=n;var a=o(n);return Z.cycle=a,Z}var Q={},$e;function Fo(){if($e)return Q;$e=1;var e=ae(),o=e.mark(d);function t(i,f){var c;if(typeof Symbol>"u"||i[Symbol.iterator]==null){if(Array.isArray(i)||(c=r(i))||f){c&&(i=c);var s=0,m=function(){};return{s:m,n:function(){return s>=i.length?{done:!0}:{done:!1,value:i[s++]}},e:function(h){throw h},f:m}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,g=!1,y;return{s:function(){c=i[Symbol.iterator]()},n:function(){var h=c.next();return p=h.done,h},e:function(h){g=!0,y=h},f:function(){try{!p&&c.return!=null&&c.return()}finally{if(g)throw y}}}}function r(i,f){if(i){if(typeof i=="string")return n(i,f);var c=Object.prototype.toString.call(i).slice(8,-1);if(c==="Object"&&i.constructor&&(c=i.constructor.name),c==="Map"||c==="Set")return Array.from(i);if(c==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return n(i,f)}}function n(i,f){(f==null||f>i.length)&&(f=i.length);for(var c=0,s=new Array(f);c<f;c++)s[c]=i[c];return s}var a=M(),l=a.iterableCurry;function d(i,f){var c,s,m,p;return e.wrap(function(y){for(;;)switch(y.prev=y.next){case 0:c=0,s=t(i),y.prev=2,s.s();case 4:if((m=s.n()).done){y.next=11;break}if(p=m.value,!(c++>=f)){y.next=9;break}return y.next=9,p;case 9:y.next=4;break;case 11:y.next=16;break;case 13:y.prev=13,y.t0=y.catch(2),s.e(y.t0);case 16:return y.prev=16,s.f(),y.finish(16);case 19:case"end":return y.stop()}},o,null,[[2,13,16,19]])}Q.__drop=d;var u=l(d);return Q.drop=u,Q}var ee={},oe={},We;function Oo(){if(We)return oe;We=1;var e=M(),o=e.iterableCurry,t=e.callReturn;function r(a,l){var d=a[Symbol.iterator](),u=d.next(),i=u.value,f=u.done;return f?l:(t(d),i)}oe.__firstOr=r;var n=o(r,{reduces:!0});return oe.firstOr=n,oe}var _e;function $o(){if(_e)return ee;_e=1;var e=M(),o=e.iterableCurry,t=Oo(),r=t.__firstOr;function n(l){return r(l,void 0)}ee.__first=n;var a=o(n,{reduces:!0});return ee.first=a,ee}var te={},Me;function Wo(){if(Me)return te;Me=1;var e=ae(),o=e.mark(d);function t(i,f){var c;if(typeof Symbol>"u"||i[Symbol.iterator]==null){if(Array.isArray(i)||(c=r(i))||f){c&&(i=c);var s=0,m=function(){};return{s:m,n:function(){return s>=i.length?{done:!0}:{done:!1,value:i[s++]}},e:function(h){throw h},f:m}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,g=!1,y;return{s:function(){c=i[Symbol.iterator]()},n:function(){var h=c.next();return p=h.done,h},e:function(h){g=!0,y=h},f:function(){try{!p&&c.return!=null&&c.return()}finally{if(g)throw y}}}}function r(i,f){if(i){if(typeof i=="string")return n(i,f);var c=Object.prototype.toString.call(i).slice(8,-1);if(c==="Object"&&i.constructor&&(c=i.constructor.name),c==="Map"||c==="Set")return Array.from(i);if(c==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return n(i,f)}}function n(i,f){(f==null||f>i.length)&&(f=i.length);for(var c=0,s=new Array(f);c<f;c++)s[c]=i[c];return s}var a=M(),l=a.iterableCurry;function d(i,f){var c,s,m,p;return e.wrap(function(y){for(;;)switch(y.prev=y.next){case 0:if(f!==0){y.next=2;break}return y.abrupt("return");case 2:c=0,s=t(i),y.prev=4,s.s();case 6:if((m=s.n()).done){y.next=14;break}return p=m.value,y.next=10,p;case 10:if(++c!==f){y.next=12;break}return y.abrupt("break",14);case 12:y.next=6;break;case 14:y.next=19;break;case 16:y.prev=16,y.t0=y.catch(4),s.e(y.t0);case 19:return y.prev=19,s.f(),y.finish(19);case 22:case"end":return y.stop()}},o,null,[[4,16,19,22]])}te.__take=d;var u=l(d);return te.take=u,te}var le,qe;function _o(){return qe||(qe=1,le=To().cycle),le}var Mo=_o();const qo=D(Mo);var de,Ne;function No(){return Ne||(Ne=1,de=Fo().drop),de}var Bo=No();const Jo=D(Bo);var fe,Be;function Ho(){return Be||(Be=1,fe=Po().filter),fe}var Lo=Ho();const Xo=D(Lo);var ue,Je;function jo(){return Je||(Je=1,ue=$o().first),ue}var Do=jo();const Ie=D(Do);var me,He;function Go(){return He||(He=1,me=Wo().take),me}var Uo=Go();const Yo=D(Uo),P=e=>e.campaignInProgress.rooms[e.currentlyEditingRoomId],ve=(e,o)=>e.campaignInProgress.rooms[o],oo=(e,o,t)=>e.campaignInProgress.rooms[t??e.currentlyEditingRoomId]?.items[o],Vo=(e,o)=>e.selectedJsonItemIds.includes(o),q=e=>{const o=structuredClone(O(P(e))),{history:t}=e;t.redo=[],t.undo.push(o)},Ko={undo(e){const o=e,{campaignInProgress:t,history:{undo:r,redo:n},currentlyEditingRoomId:a}=o;r.length!==0&&(n.push(t.rooms[a]),t.rooms[a]=r.pop())},redo(e){const o=e,{campaignInProgress:t,history:{redo:r,undo:n},currentlyEditingRoomId:a}=o;r.length!==0&&(n.push(t.rooms[a]),t.rooms[a]=r.pop())}},Zo={selectCanUndo:e=>e.history.undo.length>0,selectCanRedo:e=>e.history.redo.length>0},ye={x:1,y:0,z:0},pe={x:-1,y:0,z:0},ge={x:0,y:-1,z:0},he={x:0,y:1,z:0},X={away:he,left:ye,right:pe,towards:ge,down:{x:0,y:0,z:-1},up:{x:0,y:0,z:1},awayRight:G(A(he,pe)),towardsRight:G(A(ge,pe)),towardsLeft:G(A(ge,ye)),awayLeft:G(A(he,ye))},Xr={w:16,d:16,h:12},ie={x:16,y:16,z:12},Qo=(e,o,t)=>{if(o==="*")return!0;const r=t.meta.subRooms[o];return e.x>=r.physicalPosition.from.x&&e.y>=r.physicalPosition.from.y&&e.x<=r.physicalPosition.to.x&&e.y<=r.physicalPosition.to.y},et=({position:e},o,t)=>Qo(e,o,t),re=(e,o,t,r)=>o.some(n=>n.config.direction===e)?"doorway":t===void 0?"wall":Object.values(t).some(({gridPosition:n})=>go(X[e],ho(n,r)))?"open":"wall";function*J(e){try{yield*ot(e)}catch(o){const t=o;throw new Error(`
  error in recursion ${e.roomId}/${e.subRoomId??"*"}`,{cause:t})}}function*ot({roomId:e,subRoomId:o="*",campaign:t,visited:r={},vectorFromPrevious:n,previousRoomGridPosition:a=ne}){if(e==="nowhere"||r[e]?.[o])return;r[e]===void 0&&(r[e]={}),r[e][o]=!0;const l=t.rooms[e];if(l===void 0)throw new Error(`no room in the campaign with id="${e}"`);const d=[...N(we(l.items)).filter(m=>m.type==="door").filter(m=>et(m,o,l))],u=A(a,n===void 0?po:n),i=l.meta?.subRooms;if(i){if(o==="*")throw new Error(`subRoomId '*' means 'all' and is not allowed for big rooms. Must be one of the sub-rooms in ${e}: ${Object.keys(i)}`);if(!i[o])throw new Error(`Sub-room ${o} not found in room ${e}. Available sub-rooms: ${Object.keys(i)}`)}const f=i?.[o].gridPosition,c={left:re("left",d,i,f),right:re("right",d,i,f),away:re("away",d,i,f),towards:re("towards",d,i,f)};if(yield{roomId:e,subRoomId:o,gridPosition:u,boundaries:c},i!==void 0){if(f===void 0)throw new Error(`Sub-room ${o} not found in room ${e}. Available sub-rooms: ${Object.keys(i)}`);for(const[m,{gridPosition:p}]of N(Ve(i)))m!==o&&(yield*J({roomId:e,subRoomId:m,campaign:t,visited:r,vectorFromPrevious:Ke({...p,z:0},f),previousRoomGridPosition:u}))}if(l.roomAbove!==void 0){const{roomAbove:m,subRoomAbove:p}=l;yield*J({roomId:m,subRoomId:p,campaign:t,visited:r,vectorFromPrevious:X.up,previousRoomGridPosition:u})}if(l.roomBelow!==void 0){const{roomBelow:m,subRoomBelow:p}=l;yield*J({roomId:m,subRoomId:p,campaign:t,visited:r,vectorFromPrevious:X.down,previousRoomGridPosition:u})}for(const m of d){const{toRoom:p}=m.config;yield*J({roomId:p,campaign:t,visited:r,subRoomId:m.config.meta?.toSubRoom,vectorFromPrevious:X[m.config.direction],previousRoomGridPosition:u})}const s=l.meta?.nonContiguousRelationship;if(s!==void 0){const{with:{room:m},gridOffset:p}=s;yield*J({roomId:m,campaign:t,visited:r,subRoomId:"*",vectorFromPrevious:p,previousRoomGridPosition:u})}}const tt={jail:["bars"],blacktooth:["plain","plain","armour","shield","shield","armour"],bookworld:["book","book","cowboy"],egyptus:["hieroglyphics","hieroglyphics","hieroglyphics","sarcophagus","sarcophagus"],market:["passage","more-fruits","fruits","more-fruits","fruits"],moonbase:["coil","window1","window2","window3"],penitentiary:["loop","loop","skeleton"],safari:["wall","shield","wall","window","window","wall","shield"]},j=(e,o,t=0)=>{const r=qo(tt[e]);return Jo(t,Yo(o+t,r))},rt=e=>({awayWall:{type:"wall",config:{direction:"away",tiles:Array.from(j("blacktooth",e.x))},position:{x:0,y:e.y,z:0}},leftWall:{type:"wall",config:{direction:"left",tiles:Array.from(j("blacktooth",e.y))},position:{x:e.x,y:0,z:0}},towardsWall:{type:"wall",config:{direction:"towards",times:{x:e.x}},position:{x:0,y:0,z:0}},rightWall:{type:"wall",config:{direction:"right",times:{y:e.y}},position:{x:0,y:0,z:0}}}),to=e=>({planet:"blacktooth",color:{hue:"cyan",shade:"basic"},items:{floor:{type:"floor",config:{floorType:"standable",scenery:"blacktooth",times:e},position:{x:0,y:0,z:0}},...rt(e)}}),ro=(e,o)=>{e.planet=o;for(const t of Object.values(e.items))t.type==="floor"&&t.config.floorType==="standable"&&(t.config.scenery=o),t.type==="wall"&&(t.config.direction==="away"||t.config.direction==="left")&&(t.config.tiles=Array.from(j(o,t.config.tiles.length))),t.type==="pickup"&&t.config.gives==="crown"&&Io.includes(o)&&(t.config.planet=o)},nt=e=>e[Math.floor(Math.random()*e.length)],be=(e,o,t)=>{const n=`room_${N(vo({start:0})).find(d=>e.campaignInProgress.rooms[`room_${d}`]===void 0)}`,a=t??{hue:nt(xo),shade:Math.random()<.66?"basic":"dimmed"},l={id:n,...structuredClone(to({x:8,y:8})),color:a};return ro(l,o),e.campaignInProgress.rooms[n]=l,l},Re=(e,o,t)=>{if(o.type==="player"){const{which:n}=o.config;return t?`preview-${n}`:n}const r=o.type==="monster"?o.config.which:o.type;for(let n=1;;n++){const a=n===1?r:`${r}_${n}`;if(!e.items[a])return a}},xe=(e,o,t,r)=>{const n=P(e),a=Re(n,o,r),l=no(e,r),d={type:o.type,config:o.config,position:t};return l[a]=d,[a,d]},no=(e,o,t=e.currentlyEditingRoomId)=>o?e.previewedEdits:e.campaignInProgress.rooms[t].items,it=["head","heels"],st=[...it,"headOverHeels"],C=(...e)=>o=>e.includes(o.type),at=C("bubbles","stopAutowalk","firedDoughnut","floatingText","emitter","particle"),ct=(e,o)=>at(e)||gt(e)&&(o!==void 0&&ut(o)||e.config.direction.z!==0)||It(e)&&e.config.floorType==="none",jr=(e,o)=>!ct(e,o),lt=["ball","slidingBlock","slidingDeadly"];C(...lt);const dt=["portableBlock","spring","sceneryPlayer","sceneryCrown","monster","slidingBlock"],ft=["dalek","turtle","elephantHead","homingBot","helicopterBug"],Dr=e=>e.type==="slidingBlock"?e.config.style==="puck":e.type==="monster"?ft.includes(e.config.which):dt.includes(e.type),ut=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function Gr(e){return mt.includes(e.type)}const mt=[...st,"monster","ball","charles","pushableBlock","movingPlatform","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer","sceneryCrown"],yt=["monster","deadlyBlock","moveableDeadly","slidingDeadly"];C(...yt);const pt=e=>e.config.times!==void 0,gt=C("portal");C("teleporter");C("heels");C("head");C("heels","headOverHeels");C("head","headOverHeels");C("lift");C("emitter");const ht=C("monster"),It=C("floor");C("pickup");C("spring");const Ur=C("joystick");C("monster","movingPlatform");const Yr=e=>ht(e)&&e.config.which==="cyberman"&&e.state.everActivated===!1,ce=e=>({x:e.direction==="away"?e.tiles.length:e.direction==="towards"?e.times?.x:1,y:e.direction==="left"?e.tiles.length:e.direction==="right"?e.times?.y:1}),Vr=e=>e.type==="wall"?ce(e.config):pt(e)?e.config.times:void 0,Le=(e=L)=>({x:e.x??1,y:e.y??1,z:e.z??1}),vt=e=>({x:e.x??1,y:e.y??1}),W=e=>{const o=t=>t.config.times!==void 0;return e.type==="wall"?Le(ce(e.config)):o(e)?Le(e.config.times):L},io=e=>{const o={};let t=!1;return e.x!==1&&(o.x=e.x,t=!0),e.y!==1&&(o.y=e.y,t=!0),e.z!==1&&(o.z=e.z,t=!0),t?o:void 0};function*so(e,o,t){for(const r of Ve(e)){const[n,a]=r;if(a===null||a.type!=="wall"||a.config.direction!==o)continue;const{position:l,config:d}=a,u=vt(ce(d)),i=wo(Ce(d.direction)),f=Ce(d.direction),c=Ke(t,l);if(c[f]!==0||c[i]<-1||c[i]>=u[i])continue;if(c[i]===0&&u[i]===2){yield[n,null];continue}const s=2+c[i];if(s===1||s===2){const h=U(a,E=>{E.position=A(l,{[i]:s});const R=E.config;switch(R.direction){case"towards":case"right":R.times[i]=u[i]-s;break;default:R.tiles=R.tiles.slice(s)}});yield[n,h];continue}const p=u[i]-c[i];if(p===2||p===1){const h=U(a,E=>{const R=E.config;switch(R.direction){case"towards":case"right":R.times[i]=u[i]-p;break;default:R.tiles=R.tiles.slice(0,-p)}});yield[n,h];continue}const y=U(a,h=>{const E=h.config;switch(E.direction){case"towards":case"right":E.times[i]=c[i];break;default:E.tiles=E.tiles.slice(0,c[i])}});yield[`${n}/beforeDoor`,y];const I=U(a,h=>{h.position={...l,[i]:t[i]+2};const E=h.config;switch(E.direction){case"towards":case"right":E.times[i]=u[i]-c[i]-2;break;default:E.tiles=E.tiles.slice(c[i]+2)}});yield[`${n}/afterDoor`,I],yield[n,null]}}const Xe=(e,o,t,r,n)=>{const a=ve(e,o);if(a===void 0)throw new Error("can't cut hole in walls for a room that does not exist");const l=no(e,n,o);for(const[d,u]of so(a.items,t,r))n?l[d]=u:u===null?delete l[d]:l[d]=u},xt=e=>we(e.items),wt=e=>Ze(e),ao=e=>N(xt(e)),_=(e,...o)=>{const t=N(wt(e));return o.length===0?t:t.filter(([,r])=>o.includes(r.type))},bt=({state:e,fromRoomJson:o,direction:t,isPreview:r,autoAddRooms:n})=>{const a=e.campaignInProgress,l=N(J({campaign:a,roomId:o.id})).find(({gridPosition:d})=>Ro(d,X[t]));if(l)return a.rooms[l.roomId];if(!r)return n?be(e,o.planet):void 0},Rt=e=>_(e.items,"floor").reduce((o,[,t])=>{const r=t.position.y;return Math.min(o,r)},Number.POSITIVE_INFINITY),Et=e=>_(e.items,"floor").reduce((o,[,t])=>{const r=t.position.y+t.config.times.y;return Math.max(o,r)},Number.NEGATIVE_INFINITY),zt=e=>_(e.items,"floor").reduce((o,[,t])=>{const r=t.position.x;return Math.min(o,r)},Number.POSITIVE_INFINITY),kt=e=>_(e.items,"floor").reduce((o,[,t])=>{const r=t.position.x+t.config.times.x;return Math.max(o,r)},Number.NEGATIVE_INFINITY),At=(e,o,t,r,n)=>{const a=P(e),l=t;Xe(e,a.id,l,o,n);const d=r.config.toRoom==="+",u=bt({state:e,fromRoomJson:a,direction:l,isPreview:n,autoAddRooms:d}),[i,f]=xe(e,{type:"door",config:{...r.config,toRoom:u?u.id:r.config.toRoom,direction:l}},o,n);if(!n&&u){const c=Re(u,r,n),s={x:l==="left"?zt(u):l==="right"?kt(u):o.x,y:l==="away"?Rt(u):l==="towards"?Et(u):o.y,z:o.z},m=bo(l),p={type:"door",config:{toRoom:a.id,direction:m},position:s};u.items[c]=p,p.config.toDoor=i,f.config.toDoor=c,Xe(e,u.id,m,s,!1)}};function je(e){var o="";return t(e),o;function t(n){if(n===null||typeof n!="object"||n.toJSON!=null)o+=JSON.stringify(n);else if(Array.isArray(n)){o+="[";var a=!1;n.forEach(function(d){a&&(o+=","),a=!0,d===void 0&&(d=null),t(d)}),o+="]"}else{o+="{";var l=Object.keys(n).filter(function(d){return n[d]!==void 0}).sort();l.forEach(function(d,u){return r(n,d,u)}),o+="}"}}function r(n,a,l){l>0&&(o+=","),o+=JSON.stringify(a),o+=":",t(n[a])}}const Kr=(e,...o)=>{const t={};for(const r of o)t[r]=e[r];return t},De=(e,...o)=>{const t={...e};for(const r of o)delete t[r];return t},Ee=e=>Qe(ze(e))>0,ze=e=>{switch(e.type){case"deadlyBlock":return L;case"conveyor":if(e.config.disappearing)return ne;switch(e.config.direction){case"left":case"right":return{x:1,y:0,z:0};case"away":case"towards":return{x:0,y:1,z:0};default:throw e.config.direction,new Error}case"hushPuppy":return L;case"teleporter":return{x:1,y:1,z:0};case"floor":case"spikes":return{x:1,y:1,z:0};case"block":return L;case"barrier":if(e.config.disappearing)return ne;switch(e.config.axis){case"x":return{x:1,y:0,z:1};case"y":return{x:0,y:1,z:1};default:throw e.config.axis,new Error}case"wall":switch(e.config.direction){case"left":case"right":return{x:0,y:1,z:1};case"away":case"towards":return{x:1,y:0,z:1};default:throw e.config,new Error}default:return ne}};class se{#t;#o;#e;constructor(o,t){this.#o={x:-o.x,y:-o.y,z:-o.z},this.#e={x:t.x-o.x+1,y:t.y-o.y+1,z:t.z-o.z+1},this.#t=Array.from({length:this.#e.x},()=>Array.from({length:this.#e.y},()=>Array.from({length:this.#e.z},()=>new Set)))}static fromItems(o){let t=1/0,r=1/0,n=1/0,a=-1/0,l=-1/0,d=-1/0;const u=[...o];for(const[,f]of u){const{x:c,y:s,z:m}=f.position,p=W(f);t=Math.min(t,c),r=Math.min(r,s),n=Math.min(n,m),a=Math.max(a,c+p.x-1),l=Math.max(l,s+p.y-1),d=Math.max(d,m+p.z-1)}if(u.length===0)return new se({x:0,y:0,z:0},{x:0,y:0,z:0});const i=new se({x:t,y:r,z:n},{x:a,y:l,z:d});for(const f of u){const[,c]=f,{x:s,y:m,z:p}=c.position,g=W(c);for(let y=0;y<g.x;y++)for(let I=0;I<g.y;I++)for(let h=0;h<g.z;h++)i.add({x:s+y,y:m+I,z:p+h},f)}return i}get(o){const t=o.x+this.#o.x,r=o.y+this.#o.y,n=o.z+this.#o.z;if(this.#r(t,r,n))return this.#t[t][r][n]}set(o,t){const r=o.x+this.#o.x,n=o.y+this.#o.y,a=o.z+this.#o.z;this.#r(r,n,a)&&(this.#t[r][n][a]=t)}add(o,t){const r=this.get(o);r&&r.add(t)}remove(o,t){const r=this.get(o);r&&r.delete(t)}get size(){return{...this.#e}}get minBounds(){return{x:-this.#o.x,y:-this.#o.y,z:-this.#o.z}}get maxBounds(){const o=this.minBounds;return{x:o.x+this.#e.x-1,y:o.y+this.#e.y-1,z:o.z+this.#e.z-1}}*iterate(){const{minBounds:o}=this;for(let t=0;t<this.#e.x;t++)for(let r=0;r<this.#e.y;r++)for(let n=0;n<this.#e.z;n++)yield[{x:t+o.x,y:r+o.y,z:n+o.z},this.#t[t][r][n]]}extractUniqueItems(){const o=new Set,t=[];for(const[,r]of this.iterate())for(const n of r)o.has(n)||(o.add(n),t.push(n));return t}#r(o,t,r){return o>=0&&o<this.#e.x&&t>=0&&t<this.#e.y&&r>=0&&r<this.#e.z}}const $=e=>e.type==="wall"?`wall/${e.config.direction}`:e.type==="teleporter"?je({type:e.type,config:De(e.config,"toPosition","times")}):je({type:e.type,config:De(e.config,"times")}),St=e=>Ee(e[1]),Ct=e=>({x:Math.floor(e.x%1*ie.x),y:Math.floor(e.y%1*ie.y)}),Pt=(e,o)=>`${e},${o}`,Tt=(e,o)=>{let t=e,r=t.length;for(;;){const n=[...Ot(t,o)];if(n.length===r)return n;r=n.length,t=n}},Ft=(e,o=()=>!0)=>{const t=new Map,r=[];for(const a of e){const[,l]=a;if(!o(a))r.push(a);else if(Ee(l)){const d=Ct(l.position),u=Pt(d.x,d.y);t.has(u)||t.set(u,[]),t.get(u).push(a)}else r.push(a)}const n=[];for(const[a,l]of t)if(l.length>0){const d=l.map(([m,p])=>[m,{...p,position:{x:Math.floor(p.position.x),y:Math.floor(p.position.y),z:p.position.z}}]),u=Tt(d,o),[i,f]=a.split(",").map(Number),c=i/ie.x,s=f/ie.y;for(const[m,p]of u)n.push([m,{...p,position:{x:p.position.x+c,y:p.position.y+s,z:p.position.z}}])}return[...n,...r]},Ot=(e,o=()=>!0)=>{const t=[],r=[];for(const s of e)o(s)&&St(s)?t.push(s):r.push(s);const n=se.fromItems(t),a=n.size,{minBounds:l}=n,d=new Map,u=new Map;for(const[,s]of n.iterate())for(const[,m]of s){const p=$(m);u.has(p)||u.set(p,m)}for(const[s]of u)d.set(s,Array.from({length:a.x},()=>Array.from({length:a.y},()=>Array(a.z).fill(!1))));const i=(s,m)=>{const p=W(m),g={x:s.x+p.x-1,y:s.y+p.y-1,z:s.z+p.z-1},y=ze(m),I=$(m),h=new Set;h.add(m);const E=x=>{const k=new Set;let z=!1;for(let{x:v}=s;v<=x.x;v++)for(let{y:w}=s;w<=x.y;w++)for(let{z:b}=s;b<=x.z;b++){const T=n.get({x:v,y:w,z:b});let B=!1,H=!1;if(T)for(const[,F]of T)$(F)===I?(B=!0,k.add(F)):Ee(F)&&F.type!=="wall"&&(H=!0);H&&!B&&(z=!0),(!T||T.size===0)&&(z=!0),B||(z=!0)}if(z)return!1;let S=!1;for(const v of k)h.has(v)||(S=!0,h.add(v));if(!S)return!1;for(const v of k){const w=W(v),b={x:v.position.x+w.x-1,y:v.position.y+w.y-1,z:v.position.z+w.z-1};if(v.position.x<s.x||v.position.y<s.y||v.position.z<s.z||b.x>x.x||b.y>x.y||b.z>x.z)return!1}return!0};let R=!0;for(;R;){if(R=!1,y.x>0&&g.x+1<l.x+a.x){let x=g.x;for(let{y:k}=s;k<=g.y;k++)for(let{z}=s;z<=g.z;z++){const S=n.get({x:g.x+1,y:k,z});if(S){for(const[,v]of S)if($(v)===I){const w=W(v),b=v.position.x+w.x-1;x=Math.max(x,b)}}}x>g.x&&E({...g,x})&&(g.x=x,R=!0)}if(y.y>0&&g.y+1<l.y+a.y){let x=g.y;for(let{x:k}=s;k<=g.x;k++)for(let{z}=s;z<=g.z;z++){const S=n.get({x:k,y:g.y+1,z});if(S){for(const[,v]of S)if($(v)===I){const w=W(v),b=v.position.y+w.y-1;x=Math.max(x,b)}}}x>g.y&&E({...g,y:x})&&(g.y=x,R=!0)}if(y.z>0&&g.z+1<l.z+a.z){let x=g.z;for(let{x:k}=s;k<=g.x;k++)for(let{y:z}=s;z<=g.y;z++){const S=n.get({x:k,y:z,z:g.z+1});if(S){for(const[,v]of S)if($(v)===I){const w=W(v),b=v.position.z+w.z-1;x=Math.max(x,b)}}}x>g.z&&E({...g,z:x})&&(g.z=x,R=!0)}}return g},f=(s,m)=>{if(s.type==="wall"){if(m.type!=="wall")throw new Error("only walls can join walls");if(s.config.direction!==m.config.direction)throw new Error("walls must have the same direction to join");return s.config.direction==="right"||s.config.direction==="towards"?s:{...s,config:{...s.config,tiles:[...s.config.tiles,...m.config.tiles]}}}return s},c=({x:s,y:m,z:p},{x:g,y,z:I},h)=>{const[E,R]=h,x=$(R),k=g-s+1,z=y-m+1,S=I-p+1;let v=R;if(k+z+S>3){const w={...R.config};if(R.type==="wall")switch(R.config.direction){case"away":case"left":break;case"towards":k!==1&&(w.times={x:k});break;case"right":z!==1&&(w.times={y:z});break}else{const b={...io(W(R))};k!==1&&(b.x=k),z!==1&&(b.y=z),S!==1&&(b.z=S),w.times=b}v={...R,config:w}}for(let w=s;w<=g;w++)for(let b=m;b<=y;b++)for(let T=p;T<=I;T++)if(d.get(x)[w-l.x][b-l.y][T-l.z]=!0,w!==s||b!==m||T!==p){const B=n.get({x:w,y:b,z:T});if(B)e:for(const H of B){const[,F]=H;if($(F)===x){F.position.x===w&&F.position.y===b&&F.position.z===T&&(v=f(v,F)),n.remove({x:w,y:b,z:T},H);break e}}}return[E,v]};for(const[s,m]of n.iterate())for(const p of m){const[,g]=p;if(g.position.x===s.x&&g.position.y===s.y&&g.position.z===s.z){const y=$(g),I=d.get(y),h=s.x-l.x,E=s.y-l.y,R=s.z-l.z;if(I&&!I[h][E][R]){const x=i(s,g),k=c(s,x,p);n.remove(s,p),n.add(s,k)}}}return[...n.extractUniqueItems(),...r]},co=(e,o)=>Object.fromEntries(Ft(Object.entries(e),o)),lo=(e,o)=>{const t=P(e);t.items=co(t.items,o);const r=e.selectedJsonItemIds.filter(n=>t.items[n]!==void 0);r.length!==e.selectedJsonItemIds.length&&(e.selectedJsonItemIds=r)},$t=e=>e.type==="door",Wt=e=>e.type==="monster"&&e.config.which==="cyberman",_t={applyItemTool(e,{payload:{blockPosition:o,pointedAtItemJson:t,preview:r}}){const n=e,{tool:a}=n;if(a.type!=="item")throw new Error("applying item tool reducer while the current tool is not an item tool");switch(r||(q(n),n.previewedEdits={}),n.selectedJsonItemIds=[],!0){case $t(a.item):{if(t.type!=="wall")throw new Error("doors can only be added on walls");At(n,o,t.config.direction,a.item,r);break}case(Wt(a.item)&&t.type==="deadlyBlock"&&t.config.style==="toaster"&&t.position.z+1===o.z):{xe(n,{...a.item,config:{...a.item.config,activated:"off"}},o,r);break}default:xe(n,a.item,o,r)}r||lo(n,l=>l.type==="wall")}},Mt={changeDragInProgress(e,{payload:o}){const t=e;t.dragInProgress=o}},qt={changeGridResolution(e,{payload:o}){const t=e;t.gridResolution=o},changeWallsFloorsLocked(e,{payload:o}){const t=e;t.wallsFloorsLocked=o}},Nt={setSelectedItemsInRoom(e,{payload:{jsonItemIds:o}}){const t=P(e).items;o.forEach(r=>{if(!t[r])throw new Error(`Item with json item id "${r}" is not in the current room`)}),e.selectedJsonItemIds=o},toggleSelectedItemInRoom(e,{payload:{jsonItemId:o}}){const t=e.selectedJsonItemIds.indexOf(o);t===-1?e.selectedJsonItemIds.push(o):e.selectedJsonItemIds.splice(t,1)},setHoveredItemInRoom(e,o){e.hoveredItem=o.payload},setClickableAnnotationHovered(e,o){e.clickableAnnotationHovered=o.payload}},Bt=(e,...o)=>({x:e(...o.map(t=>t.x)),y:e(...o.map(t=>t.y)),z:e(...o.map(t=>t.z))}),Ge=(e,o,t)=>{const r=t-e.length;r>0?e.push(...j(o,r,e.length)):r<0&&e.splice(t)},Jt=e=>e==="towards"||e==="right";function*fo(e,o){const t={type:"wall",config:Jt(e.config.direction)?e.config.direction==="towards"?{direction:e.config.direction,times:{x:2}}:{direction:e.config.direction,times:{y:2}}:{direction:e.config.direction,tiles:[...j(o.planet,2,e.position[e.config.direction==="away"?"x":"y"])]},position:{...e.position,z:0}};yield[Re(o,t,!1),t]}function uo(e,o){const t=ce(e.config),r=A(o.position,o.config.times);switch(e.config.direction){case"towards":if(e.position.y===o.position.y&&e.position.x>=o.position.x&&e.position.x<r.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:t.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===o.position.x&&t.x===o.config.times.x,wallTouchesFloorEnd:e.position.x+(t.x??1)===r.x};break;case"right":if(e.position.x===o.position.x&&e.position.y>=o.position.y&&e.position.y<r.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:t.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===o.position.y&&t.y===o.config.times.y,wallTouchesFloorEnd:e.position.y+(t.y??1)===r.y};break;case"away":if(e.position.y===o.position.y+o.config.times.y&&e.position.x>=o.position.x&&e.position.x<r.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:t.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===o.position.x&&t.x===o.config.times.x,wallTouchesFloorEnd:e.position.x+(t.x??1)===r.x};break;case"left":if(e.position.x===o.position.x+o.config.times.x&&e.position.y>=o.position.y&&e.position.y<r.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:t.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===o.position.y&&t.y===o.config.times.y,wallTouchesFloorEnd:e.position.y+(t.y??1)===r.y};break}return null}function*mo(e,o,t,r,n){const a=A(o.position,r),l=o.config.times,d=n?A(l,n):o.config.times,u=A(o.position,l),i=A(a,d);for(const[f,c]of N(e)){if(c.type==="wall"&&c.position.z!==o.position.z)continue;if(c.type==="door"){const g=c.config;let y=!1,I={...O(c.position)};switch(g.direction){case"towards":c.position.y===o.position.y&&c.position.x>=o.position.x&&c.position.x<o.position.x+l.x&&(y=!0,I=A(c.position,r));break;case"right":c.position.x===o.position.x&&c.position.y>=o.position.y&&c.position.y<o.position.y+l.y&&(y=!0,I=A(c.position,r));break;case"away":c.position.y===o.position.y+l.y&&c.position.x>=o.position.x&&c.position.x<o.position.x+l.x&&(y=!0,I=A(c.position,{x:r.x,y:r.y+(n?.y??0),z:r.z}));break;case"left":c.position.x===o.position.x+l.x&&c.position.y>=o.position.y&&c.position.y<o.position.y+l.y&&(y=!0,I=A(c.position,{x:r.x+(n?.x??0),y:r.y,z:r.z}));break}if(y){const h=structuredClone(O(c));h.position=I,yield[f,h]}continue}const s=c,m=uo(s,o);if(!m||!m.isOnFloorEdge)continue;const p=structuredClone(O(s));switch(s.config.direction){case"towards":case"right":p.position=A(s.position,r);break;case"away":{const g=a.y+d.y;p.position={...s.position,x:s.position.x+r.x,y:g};break}case"left":{const g=a.x+d.x;p.position={...s.position,x:g,y:s.position.y+r.y};break}}if(m.wallFullySpansFloor){const g=d[m.tangentAxis];s.config.direction==="away"||s.config.direction==="left"?Ge(p.config.tiles,t,g):p.config.times={[m.tangentAxis]:g},yield[f,p]}else{const g=o.position[m.tangentAxis],y=u[m.tangentAxis],I=a[m.tangentAxis],h=i[m.tangentAxis],E=p.position[m.tangentAxis];if(E>=h){yield[f,null];continue}const R=Math.max(m.wallStart,g),k=Math.min(m.wallStart+m.wallLength,y)-R;let z;if(s.config.direction==="away"||s.config.direction==="left"){const b=o.position[m.normalAxis]+l[m.normalAxis],T=a[m.normalAxis]+d[m.normalAxis];z=b!==T}else z=o.position[m.normalAxis]!==a[m.normalAxis];const S=Math.max(E,I);let v;m.wallTouchesFloorEnd&&!z?v=h:v=Math.min(E+k,h);const w=v-S;w<=0?yield[f,null]:(s.config.direction==="away"||s.config.direction==="left"?Ge(p.config.tiles,t,w):p.config.times={[m.tangentAxis]:w},yield[f,p])}}}function*Ht(e,o,t,r){for(const[n,a]of _(e.items,"floor")){const l=uo(o,a);if(!l)continue;const d={x:0,y:0,z:0},u={x:0,y:0,z:0},i=t[l.normalAxis],f=t[l.tangentAxis],c=r?r[l.tangentAxis]:0;if(i!==0&&(o.config.direction==="towards"||o.config.direction==="right"?(d[l.normalAxis]=i,u[l.normalAxis]=-i):u[l.normalAxis]=i),f!==0&&(l.wallStart===a.position[l.tangentAxis]?(d[l.tangentAxis]=f,u[l.tangentAxis]=-f):l.wallTouchesFloorEnd&&(u[l.tangentAxis]=f)),c!==0&&l.wallTouchesFloorEnd&&(u[l.tangentAxis]=c),d.x!==0||d.y!==0||u.x!==0||u.y!==0){const s=A(a.config.times,u),m={...a,position:A(a.position,d),config:{...a.config,times:{x:s.x,y:s.y}}};yield[n,m]}yield*mo(_(e.items,"wall","door"),a,e.planet,d,u)}}const Lt={moveOrResizeItemAsPreview(e,{payload:{jsonItemIds:o,timesDelta:t,positionDelta:r}}){const n=e,a=P(n);for(const l of o){const d=oo(n,l);if(d===void 0)throw new Error(`no json item found for some of the ids in resize ${l}`);if(d.type==="wall"){for(const[i,f]of Ht(a,d,r,t))n.previewedEdits[i]=f;continue}if(d.type==="floor")for(const[i,f]of mo(_(a.items,"wall","door"),d,a.planet,r,t))n.previewedEdits[i]=f;if(d.type==="door"){console.log("before healing, room items are",O(a.items));for(const[i,f]of fo(d,O(a)))console.log("healing",`"${i}"`,f),n.previewedEdits[i]=f}const u={...d,position:A(d.position,r),config:{...d.config}};if(n.previewedEdits[l]=u,Xt(u,t),d.type==="door"){console.log("before cutting room plus previews is",{...O(a.items),...O(n.previewedEdits)});for(const[i,f]of so({...O(a.items),...O(n.previewedEdits)},u.config.direction,u.position))console.log("cutting",`"${i}"`,f),n.previewedEdits[i]=f}}n.dragInProgress=!0}},Xt=(e,o)=>{if(o!==void 0){const t=W(e),r=ze(e),n=Eo(o,r);if(Qe(n)>0){const a=io(Bt((l,d)=>Math.max(1,l+d),t,n));a===void 0?delete e.config.times:e.config.times=a}}},jt=(e,o)=>{const t=e.items[o];if(t.type==="door"){for(const[r,n]of fo(t,e))e.items[r]=n;e.items=co(e.items)}delete e.items[o]},Dt=(e,o)=>{const t=e.currentlyEditingRoomId,r=P(e);for(const n of we(e.campaignInProgress.rooms)){ao(n).filter(l=>l.type==="door"||l.type==="teleporter").filter(l=>l.config.toRoom===t).forEach(l=>{l.config.toRoom=o});const a=n.meta?.nonContiguousRelationship?.with;a?.room===t&&(a.room=o)}e.campaignInProgress.rooms[o]={...r,id:o},delete e.campaignInProgress.rooms[t],e.currentlyEditingRoomId=o},Ue=(e,o)=>{ao(e).filter(t=>t.type==="floor").filter(t=>t.position.z===0).forEach(t=>{t.config={...t.config,floorType:o,scenery:o==="standable"?e.planet:void 0}})},Gt={changeRoomColour(e,{payload:o}){const t=e,r=t.campaignInProgress.rooms[t.currentlyEditingRoomId].color;q(t),Object.assign(r,o)},changeRoomScenery(e,{payload:o}){const t=e,r=P(t);q(t),ro(r,o)},roomJsonEdited(e,{payload:o}){const t=e;q(t),t.campaignInProgress.rooms[t.currentlyEditingRoomId]=o;const r=t.selectedJsonItemIds.filter(n=>o.items[n]!==void 0);r.length!==t.selectedJsonItemIds.length&&(t.selectedJsonItemIds=r),o.id!==t.currentlyEditingRoomId&&Dt(t,o.id)},deleteSelected(e){const o=e,t=P(o);q(o),o.selectedJsonItemIds.forEach(r=>{jt(t,r)}),o.selectedJsonItemIds=[]},clearRoom(e){const o=e,t=P(o);q(o);for(const r of eo(t.items)){const n=t.items[r];n.type!=="floor"&&n.type!=="wall"&&n.type!=="door"&&(delete t.items[r],o.selectedJsonItemIds=o.selectedJsonItemIds.filter(a=>a!==r))}},setRoomAboveOrBelow(e,{payload:o}){const t=e,r=o.direction==="above"?"roomAbove":"roomBelow",n=r==="roomAbove"?"roomBelow":"roomAbove",a=P(t),l=o.createNew?be(t,a.planet,a.color).id:o.roomId,d=a[r]&&ve(t,a[r]);d?.[n]===t.currentlyEditingRoomId&&(d[n]=void 0),a[r]=l;const u=l&&ve(t,l);u!==void 0&&(u[n]=a.id),u?Ue(r==="roomBelow"?a:u,"none"):Ue(r==="roomBelow"?a:d,"standable")}},Ut=(e,o)=>{const t=Ze(o);for(const[r,n]of t)n===null?delete e.items[r]:e.items[r]=n},Yt={setAutoCoalesce(e,o){e.autoCoalesce=o.payload},resetPreviewedEdits(e){e.previewedEdits={}},commitCurrentPreviewedEdits(e){q(e),Ut(P(e),e.previewedEdits),e.autoCoalesce&&lo(e),e.previewedEdits={}}},ke="room_0",Vt={id:ke,...to({x:8,y:8})},Ye={name:"new campaign",rooms:{[ke]:Vt}},Ae={campaignInProgress:Ye,savedCampaign:Ye,currentlyEditingRoomId:ke,editingRoomIdHistory:{back:[],forward:[]},previewedEdits:{},tool:{type:"pointer"},hoveredItem:void 0,clickableAnnotationHovered:!1,selectedJsonItemIds:[],gridResolution:1,autoCoalesce:!0,wallsFloorsLocked:!0,dragInProgress:!1,history:{undo:[],redo:[]}},Kt={loadCampaign(e,{payload:{campaign:o}}){const t=e;t.savedCampaign=o,t.campaignInProgress=o,t.hoveredItem=void 0,t.selectedJsonItemIds=[],t.clickableAnnotationHovered=!1,t.dragInProgress=!1,t.history=Ae.history;const r=Ie(eo(o.rooms));if(r===void 0)throw new Error("could not find any rooms in this campaign");t.currentlyEditingRoomId=r},campaignSaved(e,{payload:{campaign:o}}){const t=e;t.savedCampaign=o}},yo=(e,o)=>{if(!e.campaignInProgress.rooms[o]){console.warn(`can't change to room ${o} - it doesn't exist`);return}e.editingRoomIdHistory.back.push(e.currentlyEditingRoomId),e.currentlyEditingRoomId=o,e.clickableAnnotationHovered=!1,e.hoveredItem=void 0,e.selectedJsonItemIds=[],e.history=Ae.history},Zt={changeToRoom(e,{payload:o}){yo(e,o)},roomBack(e){const o=e,{editingRoomIdHistory:t}=o;if(t.back.length===0)return;const r=t.back.pop();t.forward.push(o.currentlyEditingRoomId),o.currentlyEditingRoomId=r},roomForward(e){const o=e,{editingRoomIdHistory:t}=o;if(t.forward.length===0)return;const r=t.forward.pop();t.back.push(o.currentlyEditingRoomId),o.currentlyEditingRoomId=r}},Qt={addRoom(e){const o=e.campaignInProgress.rooms[e.currentlyEditingRoomId],t=be(e,o.planet);yo(e,t.id)},removeRoom(e){const o=e.campaignInProgress.rooms[e.currentlyEditingRoomId],r=Ie(_(o.items,"door","teleporter"))?.[1].config.toRoom??Ie(Xo(n=>n!==e.currentlyEditingRoomId,zo(e.campaignInProgress.rooms)));r!==void 0&&(delete e.campaignInProgress.rooms[e.currentlyEditingRoomId],e.currentlyEditingRoomId=r)}},er=[1,.5,.125],Se=ko({name:"levelEditor",initialState:Ae,reducers:{setTool(e,{payload:o}){const t=e;o.type==="item"&&(t.selectedJsonItemIds=[]),t.tool=o},injected(){},...qt,...Ko,..._t,...Mt,...Nt,...Gt,...Lt,...Yt,...Kt,...Qt,...Zt},selectors:{selectCurrentCampaignInProgress:e=>e.campaignInProgress,selectCurrentEditingRoomJson:P,selectItem:oo,selectCurrentEditingRoomColour:e=>P(e).color,selectCurrentEditingRoomScenery:e=>P(e).planet,selectTool:e=>e.tool,selectSelectedJsonItemIds:e=>e.selectedJsonItemIds,selectHoveredItem:e=>e.hoveredItem,selectItemIsSelected:Vo,...Zo}}),{addRoom:or,applyItemTool:tr,campaignSaved:rr,changeDragInProgress:nr,changeGridResolution:ir,changeRoomColour:sr,changeRoomScenery:ar,changeToRoom:cr,changeWallsFloorsLocked:lr,clearRoom:dr,commitCurrentPreviewedEdits:fr,deleteSelected:ur,injected:mr,loadCampaign:yr,moveOrResizeItemAsPreview:pr,redo:gr,removeRoom:hr,resetPreviewedEdits:Ir,roomBack:vr,roomJsonEdited:xr,setAutoCoalesce:wr,setClickableAnnotationHovered:br,setHoveredItemInRoom:Rr,setRoomAboveOrBelow:Er,setSelectedItemsInRoom:zr,setTool:kr,toggleSelectedItemInRoom:Ar,undo:Sr,roomForward:Cr}=Se.actions,{selectCanRedo:Pr,selectCanUndo:Tr,selectCurrentCampaignInProgress:Fr,selectCurrentEditingRoomColour:Or,selectCurrentEditingRoomJson:$r,selectCurrentEditingRoomScenery:Wr,selectHoveredItem:_r,selectItem:Mr,selectItemIsSelected:qr,selectSelectedJsonItemIds:Nr,selectTool:Br}=Se.selectors,Jr=Ao.withTypes(),Zr=Object.freeze(Object.defineProperty({__proto__:null,addRoom:or,applyItemTool:tr,campaignSaved:rr,changeDragInProgress:nr,changeGridResolution:ir,changeRoomColour:sr,changeRoomScenery:ar,changeToRoom:cr,changeWallsFloorsLocked:lr,clearRoom:dr,commitCurrentPreviewedEdits:fr,deleteSelected:ur,gridResolutions:er,injected:mr,levelEditorSlice:Se,loadCampaign:yr,moveOrResizeItemAsPreview:pr,redo:gr,removeRoom:hr,resetPreviewedEdits:Ir,roomBack:vr,roomForward:Cr,roomJsonEdited:xr,selectCanRedo:Pr,selectCanUndo:Tr,selectCurrentCampaignInProgress:Fr,selectCurrentEditingRoomColour:Or,selectCurrentEditingRoomJson:$r,selectCurrentEditingRoomScenery:Wr,selectHoveredItem:_r,selectItem:Mr,selectItemIsSelected:qr,selectSelectedJsonItemIds:Nr,selectTool:Br,setAutoCoalesce:wr,setClickableAnnotationHovered:br,setHoveredItemInRoom:Rr,setRoomAboveOrBelow:Er,setSelectedItemsInRoom:zr,setTool:kr,toggleSelectedItemInRoom:Ar,undo:Sr,useAppSelectorWithLevelEditorSlice:Jr},Symbol.toStringTag,{value:"Module"}));export{Yr as $,hr as A,Xr as B,mt as C,X as D,lt as E,Kr as F,Le as G,ie as H,ce as I,Jt as J,W as K,It as L,jr as M,Gr as N,Xt as O,Xo as P,ze as Q,pr as R,fr as S,vr as T,Cr as U,wr as V,C as W,pt as X,Vr as Y,ut as Z,Ur as _,kr as a,Dr as a0,br as a1,_r as a2,Nr as a3,vt as a4,oo as a5,Ir as a6,tr as a7,Bt as a8,Rr as a9,Mr as aa,qr as ab,zr as ac,Ee as ad,Ar as ae,nr as af,xr as ag,Zr as ah,Or as b,ir as c,ur as d,sr as e,Wr as f,er as g,ar as h,Tr as i,Pr as j,Sr as k,gr as l,lr as m,$r as n,j as o,dr as p,P as q,Oo as r,Br as s,cr as t,Jr as u,Er as v,Fr as w,rr as x,yr as y,or as z};
