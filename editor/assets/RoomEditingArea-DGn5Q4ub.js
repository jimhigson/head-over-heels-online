const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-C9TApW2p.js","assets/index-sV0QTyoB.js","assets/index-CBwAl3sp.css","assets/colorToUniform-KTpA7KSL.js","assets/SharedSystems-7RcwYpUa.js","assets/Graphics-DMwiHtZH.js","assets/levelEditorSlice-B7PH2ea4.js","assets/RoomJson-KJbYwvlR.js","assets/LevelEditor-gAKeqIxP.js","assets/WebGLRenderer-cnHhkYgU.js"])))=>i.map(i=>d[i]);
import{r as Vr,g as Xr,y as Nr,F as Zt,H as Z,e as qt,E as Ae,b as Zr,C as w,d as _e,v as Oe,a1 as T,D as Tt,aP as wn,n as Io,Q as ae,z as V,T as he,U as qr,M as Yr,aQ as pe,V as To,aR as Jr,w as Pt,aS as Kr,aT as Qr,m as es,aU as Po,aV as P,aW as bn,au as C,a9 as Qe,aX as Yt,aY as Mt,ac as X,aZ as q,a_ as ts,a$ as ns,b0 as Jt,ab as Q,b1 as os,ap as rs,ae as ge,ad as ss,b2 as L,b3 as G,af as is,as as Be,ay as ee,ax as as,aM as Rt,ah as At,aK as Kt,b4 as _t,i as et,aw as Qt,b5 as $e,b6 as Mo,b7 as cs,al as Ro,o as ls,ao as se,aC as Ao,aa as tt,b8 as _o,b9 as en,ba as Oo,bb as nt,bc as ds,bd as us,be as hs,bf as te,bg as ps,bh as tn,bi as fs,aH as me,ar as nn,bj as Pe,bk as Bo,bl as ms,bm as gs,aI as xs,bn as ys,an as He,bo as Cn,bp as vs,bq as ws,br as bs,bs as Cs,bt as ks}from"./index-sV0QTyoB.js";import{G as Ss,p as Is,a as on,b as rn,c as sn,d as Ts,e as Ps,f as Ms,u as Rs,i as K,g as As,h as _s,j as R,s as zo,k as Fo,l as $o,m as an,n as We,o as Os,w as Eo,q as Bs,r as zs,t as Ot,v as kn,x as Fs,y as Lo,z as Do,A as $s,B as Es,C as ct,D as jo,E as Ls,F as Ds,H as js,I as Us,J as Ee,K as lt,L as Te,M as Gs,N as Uo,O as Bt,P as Hs,Q as cn,R as Go,S as Ws,T as Vs,U as ln,V as Ho,W as Xs,X as Ve,Y as Ns,Z as Zs,_ as ie,$ as dn,a0 as ot,a1 as S,a2 as qs,a3 as Ys,a4 as Js,a5 as Ks,a6 as Sn,a7 as Qs,a8 as In,a9 as ei,aa as ti,ab as Tn,ac as ni,ad as oi,ae as ri,af as si,ag as Wo,ah as ii,ai,aj as Vo}from"./levelEditorSlice-B7PH2ea4.js";import{o as zt}from"./RoomJson-KJbYwvlR.js";import{s as m,a as ci,i as li,u as di,B as dt,T as Pn,t as $,b as Xo,h as W,z as No,g as Ze,y as ui,c as hi,d as Zo,e as pi,f as Me,j as qo,k as fi,l as un,m as mi}from"./LevelEditor-gAKeqIxP.js";import{S as gi,G as N}from"./Graphics-DMwiHtZH.js";var Le={},Mn;function xi(){if(Mn)return Le;Mn=1;const{ensureIterable:n}=Vr();function e(o){const r=n(o);let s=0;for(const i of r)s++;return s}Le.__size=e;const t=e;return Le.size=t,Le}var ut,Rn;function yi(){return Rn||(Rn=1,ut=xi().size),ut}var vi=yi();const Yo=Xr(vi),Jo=class Ft extends Nr{constructor(e){e={...Ft.defaultOptions,...e},super(e),this.enabled=!0,this._state=gi.for2d(),this.blendMode=e.blendMode,this.padding=e.padding,typeof e.antialias=="boolean"?this.antialias=e.antialias?"on":"off":this.antialias=e.antialias,this.resolution=e.resolution,this.blendRequired=e.blendRequired,this.clipToViewport=e.clipToViewport,this.addResource("uTexture",0,1)}apply(e,t,o,r){e.applyFilter(this,t,o,r)}get blendMode(){return this._state.blendMode}set blendMode(e){this._state.blendMode=e}static from(e){const{gpu:t,gl:o,...r}=e;let s,i;return t&&(s=Zt.from(t)),o&&(i=Z.from(o)),new Ft({gpuProgram:s,glProgram:i,...r})}};Jo.defaultOptions={blendMode:"normal",resolution:1,padding:0,antialias:"off",blendRequired:!1,clipToViewport:!0};let ne=Jo;const $t=[];qt.handleByNamedList(Ae.Environment,$t);async function wi(n){if(!n)for(let e=0;e<$t.length;e++){const t=$t[e];if(t.value.test()){await t.value.load();return}}}let be;function bi(){if(typeof be=="boolean")return be;try{be=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{be=!1}return be}var Ko=(n=>(n[n.NONE=0]="NONE",n[n.COLOR=16384]="COLOR",n[n.STENCIL=1024]="STENCIL",n[n.DEPTH=256]="DEPTH",n[n.COLOR_DEPTH=16640]="COLOR_DEPTH",n[n.COLOR_STENCIL=17408]="COLOR_STENCIL",n[n.DEPTH_STENCIL=1280]="DEPTH_STENCIL",n[n.ALL=17664]="ALL",n))(Ko||{});class Ci{constructor(e){this.items=[],this._name=e}emit(e,t,o,r,s,i,c,a){const{name:l,items:d}=this;for(let h=0,p=d.length;h<p;h++)d[h][l](e,t,o,r,s,i,c,a);return this}add(e){return e[this._name]&&(this.remove(e),this.items.push(e)),this}remove(e){const t=this.items.indexOf(e);return t!==-1&&this.items.splice(t,1),this}contains(e){return this.items.indexOf(e)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const ki=["init","destroy","contextChange","resolutionChange","resetState","renderEnd","renderStart","render","update","postrender","prerender"],Qo=class er extends Zr{constructor(e){super(),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=e.type,this.name=e.name,this.config=e;const t=[...ki,...this.config.runners??[]];this._addRunners(...t),this._unsafeEvalCheck()}async init(e={}){const t=e.skipExtensionImports===!0?!0:e.manageImports===!1;await wi(t),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const o in this._systemsHash)e={...this._systemsHash[o].constructor.defaultOptions,...e};e={...er.defaultOptions,...e},this._roundPixels=e.roundPixels?1:0;for(let o=0;o<this.runners.init.items.length;o++)await this.runners.init.items[o].init(e);this._initOptions=e}render(e,t){let o=e;if(o instanceof w&&(o={container:o},t&&(_e(Oe,"passing a second argument is deprecated, please use render options instead"),o.target=t.renderTexture)),o.target||(o.target=this.view.renderTarget),o.target===this.view.renderTarget&&(this._lastObjectRendered=o.container,o.clearColor??(o.clearColor=this.background.colorRgba),o.clear??(o.clear=this.background.clearBeforeRender)),o.clearColor){const r=Array.isArray(o.clearColor)&&o.clearColor.length===4;o.clearColor=r?o.clearColor:T.shared.setValue(o.clearColor).toArray()}o.transform||(o.container.updateLocalTransform(),o.transform=o.container.localTransform),o.container.enableRenderGroup(),this.runners.prerender.emit(o),this.runners.renderStart.emit(o),this.runners.render.emit(o),this.runners.renderEnd.emit(o),this.runners.postrender.emit(o)}resize(e,t,o){const r=this.view.resolution;this.view.resize(e,t,o),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),o!==void 0&&o!==r&&this.runners.resolutionChange.emit(o)}clear(e={}){const t=this;e.target||(e.target=t.renderTarget.renderTarget),e.clearColor||(e.clearColor=this.background.colorRgba),e.clear??(e.clear=Ko.ALL);const{clear:o,clearColor:r,target:s}=e;T.shared.setValue(r??this.background.colorRgba),t.renderTarget.clear(s,o,T.shared.toArray())}get resolution(){return this.view.resolution}set resolution(e){this.view.resolution=e,this.runners.resolutionChange.emit(e)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...e){e.forEach(t=>{this.runners[t]=new Ci(t)})}_addSystems(e){let t;for(t in e){const o=e[t];this._addSystem(o.value,o.name)}}_addSystem(e,t){const o=new e(this);if(this[t])throw new Error(`Whoops! The name "${t}" is already in use`);this[t]=o,this._systemsHash[t]=o;for(const r in this.runners)this.runners[r].add(o);return this}_addPipes(e,t){const o=t.reduce((r,s)=>(r[s.name]=s.value,r),{});e.forEach(r=>{const s=r.value,i=r.name,c=o[i];this.renderPipes[i]=new s(this,c?new c:null)})}destroy(e=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(e),Object.values(this.runners).forEach(t=>{t.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(e){return this.textureGenerator.generateTexture(e)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!bi())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}resetState(){this.runners.resetState.emit()}};Qo.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let tr=Qo,De;function Si(n){return De!==void 0||(De=(()=>{const e={stencil:!0,failIfMajorPerformanceCaveat:n??tr.defaultOptions.failIfMajorPerformanceCaveat};try{if(!Tt.get().getWebGLRenderingContext())return!1;let o=Tt.get().createCanvas().getContext("webgl",e);const r=!!o?.getContextAttributes()?.stencil;if(o){const s=o.getExtension("WEBGL_lose_context");s&&s.loseContext()}return o=null,r}catch{return!1}})()),De}let je;async function Ii(n={}){return je!==void 0||(je=await(async()=>{const e=Tt.get().getNavigator().gpu;if(!e)return!1;try{return await(await e.requestAdapter(n)).requestDevice(),!0}catch{return!1}})()),je}const An=["webgl","webgpu","canvas"];async function Ti(n){let e=[];n.preference?(e.push(n.preference),An.forEach(s=>{s!==n.preference&&e.push(s)})):e=An.slice();let t,o={};for(let s=0;s<e.length;s++){const i=e[s];if(i==="webgpu"&&await Ii()){const{WebGPURenderer:c}=await wn(async()=>{const{WebGPURenderer:a}=await import("./WebGPURenderer-C9TApW2p.js");return{WebGPURenderer:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));t=c,o={...n,...n.webgpu};break}else if(i==="webgl"&&Si(n.failIfMajorPerformanceCaveat??tr.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:c}=await wn(async()=>{const{WebGLRenderer:a}=await import("./WebGLRenderer-cnHhkYgU.js");return{WebGLRenderer:a}},__vite__mapDeps([9,1,2,3,4,5,6,7,8]));t=c,o={...n,...n.webgl};break}else if(i==="canvas")throw o={...n},new Error("CanvasRenderer is not yet implemented")}if(delete o.webgpu,delete o.webgl,!t)throw new Error("No available renderer for the current environment");const r=new t;return await r.init(o),r}const nr="8.8.1";class or{static init(){globalThis.__PIXI_APP_INIT__?.(this,nr)}static destroy(){}}or.extension=Ae.Application;class Pi{constructor(e){this._renderer=e}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,nr)}destroy(){this._renderer=null}}Pi.extension={type:[Ae.WebGLSystem,Ae.WebGPUSystem],name:"initHook",priority:-10};const rr=class Et{constructor(...e){this.stage=new w,e[0]!==void 0&&_e(Oe,"Application constructor options are deprecated, please use Application.init() instead.")}async init(e){e={...e},this.renderer=await Ti(e),Et._plugins.forEach(t=>{t.init.call(this,e)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return _e(Oe,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(e=!1,t=!1){const o=Et._plugins.slice(0);o.reverse(),o.forEach(r=>{r.destroy.call(this)}),this.stage.destroy(t),this.stage=null,this.renderer.destroy(e),this.renderer=null}};rr._plugins=[];let sr=rr;qt.handleByList(Ae.Application,sr._plugins);qt.add(or);var ir=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,Mi=`
in vec2 vTextureCoord;

out vec4 finalColor;

uniform float uAlpha;
uniform sampler2D uTexture;

void main()
{
    finalColor =  texture(uTexture, vTextureCoord) * uAlpha;
}
`,_n=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct AlphaUniforms {
  uAlpha:f32,
};

@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;

@group(1) @binding(0) var<uniform> alphaUniforms : AlphaUniforms;

struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>
  };

fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

fn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  
}

fn getSize() -> vec2<f32>
{
  return gfu.uGlobalFrame.zw;
}
  
@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition)
  );
}

@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
  @builtin(position) position: vec4<f32>
) -> @location(0) vec4<f32> {
 
    var sample = textureSample(uTexture, uSampler, uv);
    
    return sample * alphaUniforms.uAlpha;
}`;const ar=class cr extends ne{constructor(e){e={...cr.defaultOptions,...e};const t=Zt.from({vertex:{source:_n,entryPoint:"mainVertex"},fragment:{source:_n,entryPoint:"mainFragment"}}),o=Z.from({vertex:ir,fragment:Mi,name:"alpha-filter"}),{alpha:r,...s}=e,i=new Io({uAlpha:{value:r,type:"f32"}});super({...s,gpuProgram:t,glProgram:o,resources:{alphaUniforms:i}})}get alpha(){return this.resources.alphaUniforms.uniforms.uAlpha}set alpha(e){this.resources.alphaUniforms.uniforms.uAlpha=e}};ar.defaultOptions={alpha:1};let Ri=ar;var Ai=`
in vec2 vTextureCoord;
in vec4 vColor;

out vec4 finalColor;

uniform float uColorMatrix[20];
uniform float uAlpha;

uniform sampler2D uTexture;

float rand(vec2 co)
{
    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);
}

void main()
{
    vec4 color = texture(uTexture, vTextureCoord);
    float randomValue = rand(gl_FragCoord.xy * 0.2);
    float diff = (randomValue - 0.5) *  0.5;

    if (uAlpha == 0.0) {
        finalColor = color;
        return;
    }

    if (color.a > 0.0) {
        color.rgb /= color.a;
    }

    vec4 result;

    result.r = (uColorMatrix[0] * color.r);
        result.r += (uColorMatrix[1] * color.g);
        result.r += (uColorMatrix[2] * color.b);
        result.r += (uColorMatrix[3] * color.a);
        result.r += uColorMatrix[4];

    result.g = (uColorMatrix[5] * color.r);
        result.g += (uColorMatrix[6] * color.g);
        result.g += (uColorMatrix[7] * color.b);
        result.g += (uColorMatrix[8] * color.a);
        result.g += uColorMatrix[9];

    result.b = (uColorMatrix[10] * color.r);
       result.b += (uColorMatrix[11] * color.g);
       result.b += (uColorMatrix[12] * color.b);
       result.b += (uColorMatrix[13] * color.a);
       result.b += uColorMatrix[14];

    result.a = (uColorMatrix[15] * color.r);
       result.a += (uColorMatrix[16] * color.g);
       result.a += (uColorMatrix[17] * color.b);
       result.a += (uColorMatrix[18] * color.a);
       result.a += uColorMatrix[19];

    vec3 rgb = mix(color.rgb, result.rgb, uAlpha);

    // Premultiply alpha again.
    rgb *= result.a;

    finalColor = vec4(rgb, result.a);
}
`,On=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct ColorMatrixUniforms {
  uColorMatrix:array<vec4<f32>, 5>,
  uAlpha:f32,
};


@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;
@group(1) @binding(0) var<uniform> colorMatrixUniforms : ColorMatrixUniforms;


struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>,
  };
  
fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition),
  );
}


@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
) -> @location(0) vec4<f32> {


  var c = textureSample(uTexture, uSampler, uv);
  
  if (colorMatrixUniforms.uAlpha == 0.0) {
    return c;
  }

 
    // Un-premultiply alpha before applying the color matrix. See issue #3539.
    if (c.a > 0.0) {
      c.r /= c.a;
      c.g /= c.a;
      c.b /= c.a;
    }

    var cm = colorMatrixUniforms.uColorMatrix;


    var result = vec4<f32>(0.);

    result.r = (cm[0][0] * c.r);
    result.r += (cm[0][1] * c.g);
    result.r += (cm[0][2] * c.b);
    result.r += (cm[0][3] * c.a);
    result.r += cm[1][0];

    result.g = (cm[1][1] * c.r);
    result.g += (cm[1][2] * c.g);
    result.g += (cm[1][3] * c.b);
    result.g += (cm[2][0] * c.a);
    result.g += cm[2][1];

    result.b = (cm[2][2] * c.r);
    result.b += (cm[2][3] * c.g);
    result.b += (cm[3][0] * c.b);
    result.b += (cm[3][1] * c.a);
    result.b += cm[3][2];

    result.a = (cm[3][3] * c.r);
    result.a += (cm[4][0] * c.g);
    result.a += (cm[4][1] * c.b);
    result.a += (cm[4][2] * c.a);
    result.a += cm[4][3];

    var rgb = mix(c.rgb, result.rgb, colorMatrixUniforms.uAlpha);

    rgb.r *= result.a;
    rgb.g *= result.a;
    rgb.b *= result.a;

    return vec4(rgb, result.a);
}`;class _i extends ne{constructor(e={}){const t=new Io({uColorMatrix:{value:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],type:"f32",size:20},uAlpha:{value:1,type:"f32"}}),o=Zt.from({vertex:{source:On,entryPoint:"mainVertex"},fragment:{source:On,entryPoint:"mainFragment"}}),r=Z.from({vertex:ir,fragment:Ai,name:"color-matrix-filter"});super({...e,gpuProgram:o,glProgram:r,resources:{colorMatrixUniforms:t}}),this.alpha=1}_loadMatrix(e,t=!1){let o=e;t&&(this._multiply(o,this.matrix,e),o=this._colorMatrix(o)),this.resources.colorMatrixUniforms.uniforms.uColorMatrix=o,this.resources.colorMatrixUniforms.update()}_multiply(e,t,o){return e[0]=t[0]*o[0]+t[1]*o[5]+t[2]*o[10]+t[3]*o[15],e[1]=t[0]*o[1]+t[1]*o[6]+t[2]*o[11]+t[3]*o[16],e[2]=t[0]*o[2]+t[1]*o[7]+t[2]*o[12]+t[3]*o[17],e[3]=t[0]*o[3]+t[1]*o[8]+t[2]*o[13]+t[3]*o[18],e[4]=t[0]*o[4]+t[1]*o[9]+t[2]*o[14]+t[3]*o[19]+t[4],e[5]=t[5]*o[0]+t[6]*o[5]+t[7]*o[10]+t[8]*o[15],e[6]=t[5]*o[1]+t[6]*o[6]+t[7]*o[11]+t[8]*o[16],e[7]=t[5]*o[2]+t[6]*o[7]+t[7]*o[12]+t[8]*o[17],e[8]=t[5]*o[3]+t[6]*o[8]+t[7]*o[13]+t[8]*o[18],e[9]=t[5]*o[4]+t[6]*o[9]+t[7]*o[14]+t[8]*o[19]+t[9],e[10]=t[10]*o[0]+t[11]*o[5]+t[12]*o[10]+t[13]*o[15],e[11]=t[10]*o[1]+t[11]*o[6]+t[12]*o[11]+t[13]*o[16],e[12]=t[10]*o[2]+t[11]*o[7]+t[12]*o[12]+t[13]*o[17],e[13]=t[10]*o[3]+t[11]*o[8]+t[12]*o[13]+t[13]*o[18],e[14]=t[10]*o[4]+t[11]*o[9]+t[12]*o[14]+t[13]*o[19]+t[14],e[15]=t[15]*o[0]+t[16]*o[5]+t[17]*o[10]+t[18]*o[15],e[16]=t[15]*o[1]+t[16]*o[6]+t[17]*o[11]+t[18]*o[16],e[17]=t[15]*o[2]+t[16]*o[7]+t[17]*o[12]+t[18]*o[17],e[18]=t[15]*o[3]+t[16]*o[8]+t[17]*o[13]+t[18]*o[18],e[19]=t[15]*o[4]+t[16]*o[9]+t[17]*o[14]+t[18]*o[19]+t[19],e}_colorMatrix(e){const t=new Float32Array(e);return t[4]/=255,t[9]/=255,t[14]/=255,t[19]/=255,t}brightness(e,t){const o=[e,0,0,0,0,0,e,0,0,0,0,0,e,0,0,0,0,0,1,0];this._loadMatrix(o,t)}tint(e,t){const[o,r,s]=T.shared.setValue(e).toArray(),i=[o,0,0,0,0,0,r,0,0,0,0,0,s,0,0,0,0,0,1,0];this._loadMatrix(i,t)}greyscale(e,t){const o=[e,e,e,0,0,e,e,e,0,0,e,e,e,0,0,0,0,0,1,0];this._loadMatrix(o,t)}grayscale(e,t){this.greyscale(e,t)}blackAndWhite(e){const t=[.3,.6,.1,0,0,.3,.6,.1,0,0,.3,.6,.1,0,0,0,0,0,1,0];this._loadMatrix(t,e)}hue(e,t){e=(e||0)/180*Math.PI;const o=Math.cos(e),r=Math.sin(e),s=Math.sqrt,i=1/3,c=s(i),a=o+(1-o)*i,l=i*(1-o)-c*r,d=i*(1-o)+c*r,h=i*(1-o)+c*r,p=o+i*(1-o),u=i*(1-o)-c*r,f=i*(1-o)-c*r,g=i*(1-o)+c*r,v=o+i*(1-o),y=[a,l,d,0,0,h,p,u,0,0,f,g,v,0,0,0,0,0,1,0];this._loadMatrix(y,t)}contrast(e,t){const o=(e||0)+1,r=-.5*(o-1),s=[o,0,0,0,r,0,o,0,0,r,0,0,o,0,r,0,0,0,1,0];this._loadMatrix(s,t)}saturate(e=0,t){const o=e*2/3+1,r=(o-1)*-.5,s=[o,r,r,0,0,r,o,r,0,0,r,r,o,0,0,0,0,0,1,0];this._loadMatrix(s,t)}desaturate(){this.saturate(-1)}negative(e){const t=[-1,0,0,1,0,0,-1,0,1,0,0,0,-1,1,0,0,0,0,1,0];this._loadMatrix(t,e)}sepia(e){const t=[.393,.7689999,.18899999,0,0,.349,.6859999,.16799999,0,0,.272,.5339999,.13099999,0,0,0,0,0,1,0];this._loadMatrix(t,e)}technicolor(e){const t=[1.9125277891456083,-.8545344976951645,-.09155508482755585,0,11.793603434377337,-.3087833385928097,1.7658908555458428,-.10601743074722245,0,-70.35205161461398,-.231103377548616,-.7501899197440212,1.847597816108189,0,30.950940869491138,0,0,0,1,0];this._loadMatrix(t,e)}polaroid(e){const t=[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0];this._loadMatrix(t,e)}toBGR(e){const t=[0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0];this._loadMatrix(t,e)}kodachrome(e){const t=[1.1285582396593525,-.3967382283601348,-.03992559172921793,0,63.72958762196502,-.16404339962244616,1.0835251566291304,-.05498805115633132,0,24.732407896706203,-.16786010706155763,-.5603416277695248,1.6014850761964943,0,35.62982807460946,0,0,0,1,0];this._loadMatrix(t,e)}browni(e){const t=[.5997023498159715,.34553243048391263,-.2708298674538042,0,47.43192855600873,-.037703249837783157,.8609577587992641,.15059552388459913,0,-36.96841498319127,.24113635128153335,-.07441037908422492,.44972182064877153,0,-7.562075277591283,0,0,0,1,0];this._loadMatrix(t,e)}vintage(e){const t=[.6279345635605994,.3202183420819367,-.03965408211312453,0,9.651285835294123,.02578397704808868,.6441188644374771,.03259127616149294,0,7.462829176470591,.0466055556782719,-.0851232987247891,.5241648018700465,0,5.159190588235296,0,0,0,1,0];this._loadMatrix(t,e)}colorTone(e,t,o,r,s){e||(e=.2),t||(t=.15),o||(o=16770432),r||(r=3375104);const i=T.shared,[c,a,l]=i.setValue(o).toArray(),[d,h,p]=i.setValue(r).toArray(),u=[.3,.59,.11,0,0,c,a,l,e,0,d,h,p,t,0,c-d,a-h,l-p,0,0];this._loadMatrix(u,s)}night(e,t){e||(e=.1);const o=[e*-2,-e,0,0,0,-e,0,e,0,0,0,e,e*2,0,0,0,0,0,1,0];this._loadMatrix(o,t)}predator(e,t){const o=[11.224130630493164*e,-4.794486999511719*e,-2.8746118545532227*e,0*e,.40342438220977783*e,-3.6330697536468506*e,9.193157196044922*e,-2.951810836791992*e,0*e,-1.316135048866272*e,-3.2184197902679443*e,-4.2375030517578125*e,7.476448059082031*e,0*e,.8044459223747253*e,0,0,0,1,0];this._loadMatrix(o,t)}lsd(e){const t=[2,-.4,.5,0,0,-.5,2,-.4,0,0,-.4,-.5,3,0,0,0,0,0,1,0];this._loadMatrix(t,e)}reset(){const e=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0];this._loadMatrix(e,!1)}get matrix(){return this.resources.colorMatrixUniforms.uniforms.uColorMatrix}set matrix(e){this.resources.colorMatrixUniforms.uniforms.uColorMatrix=e}get alpha(){return this.resources.colorMatrixUniforms.uniforms.uAlpha}set alpha(e){this.resources.colorMatrixUniforms.uniforms.uAlpha=e}}class xe extends ae{constructor(...e){let t=e[0];Array.isArray(e[0])&&(t={textures:e[0],autoUpdate:e[1]});const{animationSpeed:o=1,autoPlay:r=!1,autoUpdate:s=!0,loop:i=!0,onComplete:c=null,onFrameChange:a=null,onLoop:l=null,textures:d,updateAnchor:h=!1,...p}=t,[u]=d;super({...p,texture:u instanceof V?u:u.texture}),this._textures=null,this._durations=null,this._autoUpdate=s,this._isConnectedToTicker=!1,this.animationSpeed=o,this.loop=i,this.updateAnchor=h,this.onComplete=c,this.onFrameChange=a,this.onLoop=l,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=d,r&&this.play()}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(he.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(he.shared.add(this.update,this,qr.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(e){this.stop(),this.currentFrame=e}gotoAndPlay(e){this.currentFrame=e,this.play()}update(e){if(!this._playing)return;const t=e.deltaTime,o=this.animationSpeed*t,r=this.currentFrame;if(this._durations!==null){let s=this._currentTime%1*this._durations[this.currentFrame];for(s+=o/60*1e3;s<0;)this._currentTime--,s+=this._durations[this.currentFrame];const i=Math.sign(this.animationSpeed*t);for(this._currentTime=Math.floor(this._currentTime);s>=this._durations[this.currentFrame];)s-=this._durations[this.currentFrame]*i,this._currentTime+=i;this._currentTime+=s/this._durations[this.currentFrame]}else this._currentTime+=o;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):r!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<r||this.animationSpeed<0&&this.currentFrame>r)&&this.onLoop(),this._updateTexture())}_updateTexture(){const e=this.currentFrame;this._previousFrame!==e&&(this._previousFrame=e,this.texture=this._textures[e],this.updateAnchor&&this.texture.defaultAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(){this.stop(),super.destroy(),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(e){const t=[];for(let o=0;o<e.length;++o)t.push(V.from(e[o]));return new xe(t)}static fromImages(e){const t=[];for(let o=0;o<e.length;++o)t.push(V.from(e[o]));return new xe(t)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(e){if(e[0]instanceof V)this._textures=e,this._durations=null;else{this._textures=[],this._durations=[];for(let t=0;t<e.length;t++)this._textures.push(e[t].texture),this._durations.push(e[t].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let e=Math.floor(this._currentTime)%this._textures.length;return e<0&&(e+=this._textures.length),e}set currentFrame(e){if(e<0||e>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${e}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const t=this.currentFrame;this._currentTime=e,t!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,!this._autoUpdate&&this._isConnectedToTicker?(he.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(he.shared.add(this.update,this),this._isConnectedToTicker=!0))}}class Oi{constructor({matrix:e,observer:t}={}){this.dirty=!0,this._matrix=e??new Yr,this.observer=t,this.position=new pe(this,0,0),this.scale=new pe(this,1,1),this.pivot=new pe(this,0,0),this.skew=new pe(this,0,0),this._rotation=0,this._cx=1,this._sx=0,this._cy=0,this._sy=1}get matrix(){const e=this._matrix;return this.dirty&&(e.a=this._cx*this.scale.x,e.b=this._sx*this.scale.x,e.c=this._cy*this.scale.y,e.d=this._sy*this.scale.y,e.tx=this.position.x-(this.pivot.x*e.a+this.pivot.y*e.c),e.ty=this.position.y-(this.pivot.x*e.b+this.pivot.y*e.d),this.dirty=!1),e}_onUpdate(e){this.dirty=!0,e===this.skew&&this.updateSkew(),this.observer?._onUpdate(this)}updateSkew(){this._cx=Math.cos(this._rotation+this.skew.y),this._sx=Math.sin(this._rotation+this.skew.y),this._cy=-Math.sin(this._rotation-this.skew.x),this._sy=Math.cos(this._rotation-this.skew.x),this.dirty=!0}toString(){return`[pixi.js/math:Transform position=(${this.position.x}, ${this.position.y}) rotation=${this.rotation} scale=(${this.scale.x}, ${this.scale.y}) skew=(${this.skew.x}, ${this.skew.y}) ]`}setFromMatrix(e){e.decompose(this),this.dirty=!0}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._onUpdate(this.skew))}}const lr=class Xe extends To{constructor(...e){let t=e[0]||{};t instanceof V&&(t={texture:t}),e.length>1&&(_e(Oe,"use new TilingSprite({ texture, width:100, height:100 }) instead"),t.width=e[1],t.height=e[2]),t={...Xe.defaultOptions,...t};const{texture:o,anchor:r,tilePosition:s,tileScale:i,tileRotation:c,width:a,height:l,applyAnchorToTexture:d,roundPixels:h,...p}=t??{};super({label:"TilingSprite",...p}),this.renderPipeId="tilingSprite",this.batched=!0,this.allowChildren=!1,this._anchor=new pe({_onUpdate:()=>{this.onViewUpdate()}}),this.applyAnchorToTexture=d,this.texture=o,this._width=a??o.width,this._height=l??o.height,this._tileTransform=new Oi({observer:{_onUpdate:()=>this.onViewUpdate()}}),r&&(this.anchor=r),this.tilePosition=s,this.tileScale=i,this.tileRotation=c,this.roundPixels=h??!1}static from(e,t={}){return typeof e=="string"?new Xe({texture:Jr.get(e),...t}):new Xe({texture:e,...t})}get uvRespectAnchor(){return Pt("uvRespectAnchor is deprecated, please use applyAnchorToTexture instead"),this.applyAnchorToTexture}set uvRespectAnchor(e){Pt("uvRespectAnchor is deprecated, please use applyAnchorToTexture instead"),this.applyAnchorToTexture=e}get clampMargin(){return this._texture.textureMatrix.clampMargin}set clampMargin(e){this._texture.textureMatrix.clampMargin=e}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}get tilePosition(){return this._tileTransform.position}set tilePosition(e){this._tileTransform.position.copyFrom(e)}get tileScale(){return this._tileTransform.scale}set tileScale(e){typeof e=="number"?this._tileTransform.scale.set(e):this._tileTransform.scale.copyFrom(e)}set tileRotation(e){this._tileTransform.rotation=e}get tileRotation(){return this._tileTransform.rotation}get tileTransform(){return this._tileTransform}set texture(e){e||(e=V.EMPTY);const t=this._texture;t!==e&&(t&&t.dynamic&&t.off("update",this.onViewUpdate,this),e.dynamic&&e.on("update",this.onViewUpdate,this),this._texture=e,this.onViewUpdate())}get texture(){return this._texture}set width(e){this._width=e,this.onViewUpdate()}get width(){return this._width}set height(e){this._height=e,this.onViewUpdate()}get height(){return this._height}setSize(e,t){typeof e=="object"&&(t=e.height??e.width,e=e.width),this._width=e,this._height=t??e,this.onViewUpdate()}getSize(e){return e||(e={}),e.width=this._width,e.height=this._height,e}updateBounds(){const e=this._bounds,t=this._anchor,o=this._width,r=this._height;e.minX=-t._x*o,e.maxX=e.minX+o,e.minY=-t._y*r,e.maxY=e.minY+r}containsPoint(e){const t=this._width,o=this._height,r=-t*this._anchor._x;let s=0;return e.x>=r&&e.x<=r+t&&(s=-o*this._anchor._y,e.y>=s&&e.y<=s+o)}destroy(e=!1){if(super.destroy(e),this._anchor=null,this._tileTransform=null,this._bounds=null,typeof e=="boolean"?e:e?.texture){const o=typeof e=="boolean"?e:e?.textureSource;this._texture.destroy(o)}this._texture=null}};lr.defaultOptions={texture:V.EMPTY,anchor:{x:0,y:0},tilePosition:{x:0,y:0},tileScale:{x:1,y:1},tileRotation:0,applyAnchorToTexture:!1};let Bi=lr;class zi extends To{constructor(e,t){const{text:o,resolution:r,style:s,anchor:i,width:c,height:a,roundPixels:l,...d}=e;super({...d}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=t,this.text=o??"",this.style=s,this.resolution=r??null,this.allowChildren=!1,this._anchor=new pe({_onUpdate:()=>{this.onViewUpdate()}}),i&&(this.anchor=i),this.roundPixels=l??!1,c!==void 0&&(this.width=c),a!==void 0&&(this.height=a)}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}set text(e){e=e.toString(),this._text!==e&&(this._text=e,this.onViewUpdate())}get text(){return this._text}set resolution(e){this._autoResolution=e===null,this._resolution=e,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(e){e||(e={}),this._style?.off("update",this.onViewUpdate,this),e instanceof this._styleClass?this._style=e:this._style=new this._styleClass(e),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(e){this._setWidth(e,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(e){this._setHeight(e,this.bounds.height)}getSize(e){return e||(e={}),e.width=Math.abs(this.scale.x)*this.bounds.width,e.height=Math.abs(this.scale.y)*this.bounds.height,e}setSize(e,t){typeof e=="object"?(t=e.height??e.width,e=e.width):t??(t=e),e!==void 0&&this._setWidth(e,this.bounds.width),t!==void 0&&this._setHeight(t,this.bounds.height)}containsPoint(e){const t=this.bounds.width,o=this.bounds.height,r=-t*this.anchor.x;let s=0;return e.x>=r&&e.x<=r+t&&(s=-o*this.anchor.y,e.y>=s&&e.y<=s+o)}onViewUpdate(){this.didViewUpdate||(this._didTextUpdate=!0),super.onViewUpdate()}_getKey(){return`${this.text}:${this._style.styleKey}:${this._resolution}`}destroy(e=!1){super.destroy(e),this.owner=null,this._bounds=null,this._anchor=null,(typeof e=="boolean"?e:e?.style)&&this._style.destroy(e),this._style=null,this._text=null}}function Fi(n,e){let t=n[0]??{};return(typeof t=="string"||n[1])&&(_e(Oe,`use new ${e}({ text: "hi!", style }) instead`),t={text:t,style:n[1]}),t}class $i extends zi{constructor(...e){const t=Fi(e,"Text");super(t,Kr),this.renderPipeId="text"}updateBounds(){const e=this._bounds,t=this._anchor,o=Qr.measureText(this._text,this._style),{width:r,height:s}=o;e.minX=-t._x*r,e.maxX=e.minX+r,e.minY=-t._y*s,e.maxY=e.minY+s}}class rt extends V{static create(e){return new rt({source:new es(e)})}resize(e,t,o){return this.source.resize(e,t,o),this}}const dr=class ur extends w{constructor(e={}){e={...ur.defaultOptions,...e},super(),this.renderLayerChildren=[],this.sortableChildren=e.sortableChildren,this.sortFunction=e.sortFunction}attach(...e){for(let t=0;t<e.length;t++){const o=e[t];if(o.parentRenderLayer){if(o.parentRenderLayer===this)continue;o.parentRenderLayer.detach(o)}this.renderLayerChildren.push(o),o.parentRenderLayer=this;const r=this.renderGroup||this.parentRenderGroup;r&&(r.structureDidChange=!0)}return e[0]}detach(...e){for(let t=0;t<e.length;t++){const o=e[t],r=this.renderLayerChildren.indexOf(o);r!==-1&&this.renderLayerChildren.splice(r,1),o.parentRenderLayer=null;const s=this.renderGroup||this.parentRenderGroup;s&&(s.structureDidChange=!0)}return e[0]}detachAll(){const e=this.renderLayerChildren;for(let t=0;t<e.length;t++)e[t].parentRenderLayer=null;this.renderLayerChildren.length=0}collectRenderables(e,t,o){const r=this.renderLayerChildren,s=r.length;this.sortableChildren&&this.sortRenderLayerChildren();for(let i=0;i<s;i++)r[i].parent||Pt("Container must be added to both layer and scene graph. Layers only handle render order - the scene graph is required for transforms (addChild)",r[i]),r[i].collectRenderables(e,t,this)}sortRenderLayerChildren(){this.renderLayerChildren.sort(this.sortFunction)}_getGlobalBoundsRecursive(e,t,o){if(!e)return;const r=this.renderLayerChildren;for(let s=0;s<r.length;s++)r[s]._getGlobalBoundsRecursive(!0,t,this)}};dr.defaultOptions={sortableChildren:!1,sortFunction:(n,e)=>n.zIndex-e.zIndex};let Ei=dr;const Bn=Ei,Li=(n,e)=>{const t=Po();P.useLayoutEffect(()=>{bn(C.dispatch,C.getState,n,e)},[n,e]),P.useLayoutEffect(()=>{const o=()=>bn(C.dispatch,C.getState,n,e);if(e){const r=new ResizeObserver(o);return r.observe(e),()=>r.disconnect()}else return window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[t,e,n])},Di=()=>{const{cssUpscale:n,canvasSize:e,rotate90:t}=Qe(Yt);return t?`scale(${n}) rotate(90deg) translate(0, -${e.y}px)`:`scale(${n})`},ji=(n,e=console.error)=>(...t)=>{try{return n(...t)}catch(o){e(o);return}},hr=n=>{for(const[,a]of n)for(const[l]of a)a.set(l,!1);const e=Array.from(Ui(n));let t=e.length,o=t;const r=new Array(t),s={},i=Gi(e);for(;o--;)s[o]||c(e[o],o,new Set,null);return r;function c(a,l,d,h){if(d.has(a)){if(h!==null){const f=n.get(h);f?.has(a)&&f.set(a,!0)}return}if(s[l])return;s[l]=!0;const p=n.get(a),u=Array.from(p?.entries()??Mt);if(l=u.length){d.add(a);do{const[f,g]=u[--l];g||c(f,i.get(f),d,a)}while(l);d.delete(a)}r[--t]=a}};function Ui(n){const e=new Set;for(const[t,o]of n.entries()){e.add(t);for(const r of o.keys())e.add(r)}return e}function Gi(n){const e=new Map;for(let t=0,o=n.length;t<o;t++)e.set(n[t],t);return e}const Hi=(n,e,t,o)=>(n.has(e)||n.set(e,new Map),n.get(e).set(t,o),n),Ce=(n,e,t)=>{const o=n.get(e);return o!==void 0&&(o.delete(t),o.size===0&&n.delete(e)),n},ht=1e-5,zn=-1,ke=(n,e,t,o,r)=>o-r>n&&t<e-r,Wi=0,pr=1,fr=2,mr=3,Vi=(n,e)=>{const t=ke(n.zAxisProjectionMin,n.zAxisProjectionMax,e.zAxisProjectionMin,e.zAxisProjectionMax,ht),o=ke(n.xAxisProjectionMin,n.xAxisProjectionMax,e.xAxisProjectionMin,e.xAxisProjectionMax,ht),r=ke(n.yAxisProjectionMin,n.yAxisProjectionMax,e.yAxisProjectionMin,e.yAxisProjectionMax,ht);return o&&r&&t?pr:r&&t&&ke(n.xAxisProjectionMin,n.xAxisProjectionMax,e.xAxisProjectionMin,e.xAxisProjectionMax,zn)?fr:o&&t&&ke(n.yAxisProjectionMin,n.yAxisProjectionMax,e.yAxisProjectionMin,e.yAxisProjectionMax,zn)?mr:Wi},Xi=(n,e,t,o)=>{for(const r of ts){const s=n[r],i=s+e[r],c=t[r],a=c+o[r];if(i<=c)return 1*(r==="z"?-1:1);if(s>=a)return-1*(r==="z"?-1:1)}return Fn(t)-Fn(n)},Ni=(n,e,t)=>{if(n.fixedZIndex!==void 0||e.fixedZIndex!==void 0)return 0;const o=n.renderAabbOffset?X(n.state.position,n.renderAabbOffset):n.state.position,r=n.renderAabb||n.aabb,s=e.renderAabbOffset?X(e.state.position,e.renderAabbOffset):e.state.position,i=e.renderAabb||e.aabb;switch(Vi(t.getItemAxesProjections(n),t.getItemAxesProjections(e))){case pr:return Xi(o,r,s,i);case fr:return q(o.y,s.y+i.y)&&q(o.z,s.z+i.z)?1:q(s.y,o.y+r.y)&&q(s.z,o.z+r.z)?-1:0;case mr:return q(o.x,s.x+i.x)&&q(o.z,s.z+i.z)?1:q(s.x,o.x+r.x)&&q(s.z,o.z+r.z)?-1:0;default:return 0}},Fn=n=>n.x+n.y-n.z,gr=(n,e=new Ss(zt(n)),t=new Set(zt(n)),o=new Map)=>{const r=new Map;for(const[s,i]of o)if(!n[s])o.delete(s);else for(const[c]of i)n[c]||Ce(o,s,c);for(const s of t)e.updateItemProjectedIndex(s);for(const s of t){if(s.fixedZIndex!==void 0)continue;const i=e.getItemProjectedNeighbourhood(s);{const c=o.get(s.id);c?.forEach((a,l)=>{i.has(n[l])||c.delete(l)}),o.forEach((a,l)=>{i.has(n[l])||Ce(o,l,s.id)})}for(const c of i){if(c.fixedZIndex!==void 0||r.get(c)?.has(s))continue;const a=Ni(s,c,e);if(r.has(s)||r.set(s,new Set),r.get(s).add(c),a===0){Ce(o,s.id,c.id),Ce(o,c.id,s.id);continue}const l=a>0?s.id:c.id,d=a>0?c.id:s.id;Hi(o,d,l,!1),Ce(o,l,d)}}return o},$n=n=>n.fixedZIndex!==void 0,Zi=n=>{const t=n.some(([,i])=>i==="intersects-rendered")?n.filter(([,i])=>i==="intersects-rendered").map(([i])=>i):n.map(([i])=>i);if(t.every($n))return t.toSorted((i,c)=>c.fixedZIndex-i.fixedZIndex).at(0);const o=t.filter(i=>!$n(i));if(o.length===0)return;if(o.length===1)return o[0];const r=Object.fromEntries(o.map(i=>[i.id,i])),s=hr(gr(r));return r[s.at(-1)]},qi=3,Yi=(n,{x:e,y:t},o)=>ns.find(r=>{const s=Is(n.state.position,n.aabb,r);return Jt(Q(s,{x:e,y:t}))<qi}),le=3,pt=1.5;function H({x:n,y:e},t,o){const r={x:n-t.x,y:e-t.y},s=r.x*o.y-r.y*o.x;return Math.abs(s)/os(Math.hypot(o.x,o.y))}const xr={point:{x:-1,y:-1,z:0},normal:{x:0,y:0,z:1}},yr={point:{x:-1,y:0,z:1},normal:{x:0,y:1,z:0}},vr={point:{x:0,y:-1,z:1},normal:{x:1,y:0,z:0}},wr={point:{x:0,y:1,z:1},normal:{x:1,y:0,z:0}},br={point:{x:1,y:0,z:1},normal:{x:0,y:1,z:0}},Cr={point:{x:1,y:-1,z:0},normal:{x:0,y:0,z:1}},kr={point:{x:0,y:-1,z:-1},normal:{x:1,y:0,z:0}},Sr={point:{x:-1,y:1,z:0},normal:{x:0,y:0,z:1}},Ir={point:{x:-1,y:0,z:-1},normal:{x:0,y:1,z:0}},Ji=(n,e,t,o)=>{const{position:r}=n.state,{aabb:s}=n,i=t.x<0,c=t.y<0,a=t.z>0;if((i||c)&&H(e,on(r),{x:0,y:-1})<pt)return xr;if((i||a)&&H(e,rn(r,s),{x:2,y:-1})<pt)return yr;if((c||a)&&H(e,sn(r,s),{x:2,y:1})<pt)return vr;switch(!0){case a:{const l=Ms(r,s);if(H(e,l,{x:2,y:1})<le)return wr;if(H(e,l,{x:-2,y:1})<le)return br;break}case c:{const l=Ps(r,s);if(H(e,l,{x:0,y:-1})<le)return Cr;if(H(e,l,{x:2,y:1})<le)return kr;break}case i:{const l=Ts(r,s);if(H(e,l,{x:0,y:-1})<le)return Sr;if(H(e,l,{x:-2,y:1})<le)return Ir;break}}},Ki={z:1,x:0,y:0},Qi={z:0,x:0,y:-1},En={z:0,x:-1,y:0},ea=(n,{x:e,y:t},o)=>{if(o.type==="item"&&o.item.type==="door"&&n.type==="wall"){const d=n.config.direction;return rs(Rs[d],-1)}const{position:r}=n.state,{aabb:s}=n,i=on(r),c=sn(r,s),a=rn(r,s);return t<c.y-(c.x-e)/2?t<a.y-(e-a.x)/2?Ki:En:e<i.x?Qi:En},Ln=(n,e,t)=>t?{position:n.state.position,aabb:n.aabb}:{position:X(n.state.position,n.renderAabbOffset??ge),aabb:n.renderAabb??n.aabb},Dn=({x:n,y:e},t,o)=>{const r=on(t),s=sn(t,o),i=rn(t,o);return!(n<s.x||n>i.x||e<i.y-(i.x-n)/2||e<s.y-(n-s.x)/2||e>r.y-(n-r.x)/2||e>r.y-(r.x-n)/2)},ta=(n,e,t)=>{const{position:o,aabb:r}=Ln(t,e,!1);if(Dn(n,o,r))return"intersects-rendered";if(e.type==="item"&&t.type==="wall"){const{position:i,aabb:c}=Ln(t,e,!0);if(Dn(n,i,c))return"intersects-unrendered"}return"non-intersecting"},Tr=(n,e,t,o)=>{const r=t.type==="item"&&t.item.type==="door"?1:o,s=R.w*r,i=R.h,c=r===1?0:R.w/2,a=i/2,l=ss(e);return{x:l==="yz"?Math.round(n.x/s)*s:Math.floor((n.x-c)/s)*s,y:l==="xz"?Math.round(n.y/s)*s:Math.floor((n.y-c)/s)*s,z:l==="xy"?Math.round(n.z/i)*i:Math.floor((n.z+a)/i)*i}},na=({state:{position:n},aabb:e},t,o,r,s)=>{const i={x:n.x+(t.x<0?0:e.x),y:n.y+(t.y<0?0:e.y),z:n.z+(t.z<0?0:e.z)},c=_s(i,t,o);return Tr(c,t,r,s)},oa=n=>e=>{const t=As(e);return n.type==="item"&&n.item.type==="door"?t&&e.type==="wall":t},ft=(n,e,t,o)=>{const r=K(e.items).filter(oa(t)).map(a=>[a,ta(n,t,a)]).filter(a=>a[1]!=="non-intersecting"),s=Array.from(r),i=Zi(s),c=e.id;if(i){const a=ea(i,n,t);if(!(a.z>0&&!Object.isExtensible(i.state.stoodOnBy)))return{roomId:c,scrXy:n,world:{itemId:i.id,onItem:{face:a,corner:Yi(i,n),edge:Ji(i,n,a)},position:na(i,a,n,t,o)}}}return{roomId:c,scrXy:n,world:void 0}},ye=40,Ne=(n,e,t)=>{const o=n.cssUpscale*n.gameEngineUpscale;if(t.target===null)throw new Error("Mouse event target is null");const r=t.target.getBoundingClientRect(),s=t.clientX-r.left,i=t.clientY-r.top;return{x:s/o+e.l-ye,y:i/o+e.t-ye}},ra=(n,e)=>{const t=n.cssUpscale*n.gameEngineUpscale;if(e.target===null)throw new Error("Mouse event target is null");const o=e.movementX,r=e.movementY;return{x:o/t,y:r/t}},sa=n=>{n.ticker.remove(n.render,n)},Pr=P.createContext(null),ia=({children:n})=>{const[e,t]=P.useState(null);return P.useEffect(()=>{const o=new sr;return o.init({background:m.pureBlack,sharedTicker:!0}).then(()=>{sa(o),t(o)}),()=>{}},[]),e===null?null:L.jsx(Pr,{value:e,children:n})},ce=()=>P.useContext(Pr),qe=(n,...e)=>n.levelEditor.wallsFloorsLocked&&e.some(t=>t.type==="wall"||t.type==="floor"),Lt=(n,e)=>{const t=C.getState();let o;if(e.world){const r=e.world.itemId,s=r&&n.items[r],i=qe(t,s)?void 0:s.jsonItemId;o=i===void 0?void 0:{jsonItemId:i,pointingAtOnItem:e.world.onItem}}else o=void 0;G(zo(t),o)||C.dispatch(Fo(o))},Ye=({levelEditor:n},e,t)=>{const o=e.items[t]?.jsonItemId;if(o===void 0)return;const r=$o(n,o);if(r!==void 0)return[o,r]},{dispatch:aa}=C;class ca{handleMouseMove({roomState:e,pointingAt:t}){Lt(e,t)}handleMouseUp({roomState:e,pointingAt:t,storeState:o,isClick:r}){if(!r)return;const s=t.world?.itemId;if(s===void 0){console.warn("no itemId");return}const i=e.items[s];if(qe(o,i))return;const c=Ye(o,e,s);if(c===void 0)return;const[,a]=c;aa(an({type:"item",item:{type:a.type,config:a.config}}))}handleMouseDown(e){}handleMouseLeave(e){}}const jn=(n,e,t)=>{const{world:{onItem:{face:o},position:r,itemId:s}}=n;if(o.z>is)return We(r);if(t.type==="door"){const i=e.items[s];if(i.type!=="wall")return;const{config:c,aabb:a,state:{position:l}}=i,d=Os(Eo(c)),h=Be(ee(c.direction)),p=ee(c.direction);if(d[h]<2)return;const u=l[h],f=l[h]+a[h]-Bs,g=l.z,v=l.z+a.z-zs,y={[h]:Math.max(Math.min(r[h],f),u),[p]:r[p],z:Math.max(Math.min(r.z,v),g)};return We(y)}return X(We(r),o)},{dispatch:Se}=C;class la{handleMouseMove({pointingAtChanged:e,roomState:t,pointingAt:o,tool:r,storeState:s}){if(!e||(Se(Ot()),o.world===void 0))return;const i=Ye(s,t,o.world.itemId);if(i===void 0)return;const[,c]=i,a=jn(o,t,r.item);if(a===void 0)return;const{item:l}=r,d=l.type==="door"?as(l,p=>{const u=t.items[o.world.itemId];p.config.direction=u.config.direction}):r.item;ci({roomState:t,blockPosition:a,itemTool:d})||Se(kn({blockPosition:a,pointedAtItemJson:c,preview:!0}))}handleMouseUp({roomState:e,pointingAt:t,tool:o,storeState:r,isClick:s}){if(!s)return;if(t.world===void 0){Se(an({type:"pointer"}));return}const i=Ye(r,e,t.world.itemId);if(i===void 0)return;const[,c]=i,a=jn(t,e,o.item);a!==void 0&&Se(kn({blockPosition:a,pointedAtItemJson:c,preview:!1}))}handleMouseDown(e){}handleMouseLeave(e){Se(Ot())}}const da=n=>Do(e=>e>0?e:e>-1?1:-e+1,n),ua=({jsonItem:n,blockDragAccVec:e,resizeEdgeDirection:t})=>{const o=n.position,r=Fs(n),s=Rt(e,t,Lo(n)),i=X(r,s),c=da(i),a=Do((l,d,h,p,u)=>{const f=d<1;return l<0!==f?f?h-u+1:h+p-u:f?h+p-1:h},t,i,o,r,c);return{timesDelta:At(c,r),positionDelta:At(a,o)}},ha=5,{dispatch:Ie}=C,pa=(n,e,t)=>{const o=t?.world?.itemId;if(o===void 0)return _t;const r=e.items[o].jsonItemId;if(r===void 0)return _t;const{selectedJsonItemIds:s}=n.levelEditor;return s.includes(r)?s:[r]},fa=(n,e,t)=>{const o=n.world?.onItem.edge,r=Rt(...et(t).map(i=>Lo(i))),s=Rt(o?.point??ge,r);return Qt(s)>0?o.normal:e?{x:1,y:0,z:0}:{x:0,y:0,z:1}},ma=(n,e,t,o,r,s)=>{if(n===void 0)return;const i=Q(e,n.scrXy),c=Jt(i);if(!(r||c>ha))return;const l=fa(n,o,s),d=Us(l,t);return o?{x:0,y:0,z:d.z}:d},Un=(n,e=!1)=>{const t=C.getState().levelEditor;return Tr(n,{x:0,y:0,z:1},t.tool,e?1:t.gridResolution)};class ga{handleMouseMove({roomState:e,pointingAt:t,storeState:o,mouseDownPointingAtRef:r,mouseEvent:s,upscale:i,dragAccVec:c,roomRenderSize:a}){const l=ra(i,s),d=pa(o,e,r.current);if(d.length===0){Lt(e,t);return}const h=d.map(U=>$s(o,U));if(qe(o,...h))return;const u=t.roomId===r.current?.roomId?ma(r.current,Ne(i,a,s),l,s.metaKey||s.shiftKey,c.current!==void 0,h):void 0;if(!u){Lt(e,t);return}d.length===1&&!Es(o,d[0])&&C.dispatch(ct({jsonItemIds:d}));const f=r.current?.world?.onItem.edge,g=f&&h.every(U=>jo(U)),v=c.current??ge,y=X(v,u),b=Un(y,g);if(c.current=y,Kt(Un(v,g),b))return;const I=We(b);let M,D;if(g){const[,U]=Ye(o,e,r.current.world.itemId);({timesDelta:D,positionDelta:M}=ua({jsonItem:U,blockDragAccVec:I,resizeEdgeDirection:f.point}))}else M=I;li({roomState:e,jsonItemIds:d,blockPositionDelta:M,timesDelta:D})||Ie(Ls({jsonItemIds:d,positionDelta:M,timesDelta:D}))}handleMouseUp({roomState:e,pointingAt:t,storeState:o,mouseEvent:r,isClick:s,isDragEnd:i}){if(s){const c=t.world===void 0?void 0:e.items[t.world.itemId];if(c?.jsonItemId===void 0||qe(o,c)){Ie(ct({jsonItemIds:[]}));return}Ie(r.ctrlKey||r.metaKey?Ds({jsonItemId:c.jsonItemId}):ct({jsonItemIds:[c.jsonItemId]}))}else i&&Ie(js())}handleMouseDown(e){}handleMouseLeave(e){Ie(Fo(void 0))}}const Ue={item:new la,pointer:new ga,eyeDropper:new ca},xa=n=>{const e=ce(),t=Qe(Yt),o=Po(),r=P.useRef(void 0),s=P.useRef(void 0),i=P.useRef(void 0);P.useEffect(()=>{if(n===null)return;const c=p=>{const u=C.getState(),f=Ee(u),g=lt(u),v=Ne(t,g,p),y=Te(u),b=ft(v,f,y,u.levelEditor.gridResolution),I=!G(b.world,r.current?.world);Ue[y.type].handleMouseMove({pointingAtChanged:I,roomState:f,pointingAt:b,tool:y,storeState:u,mouseDownPointingAtRef:s,mouseEvent:p,upscale:t,dragAccVec:i,roomRenderSize:g}),r.current=b},a=p=>{const u=C.getState(),f=Ee(u);if(f.id!==u.levelEditor.currentlyEditingRoomId)return;const g=lt(u),v=Ne(t,g,p),y=Te(C.getState()),b=ft(v,f,y,u.levelEditor.gridResolution),I=i.current!==void 0,M=!I&&b.roomId===s.current?.roomId&&b.world?.itemId===s.current?.world?.itemId,D=s.current;if(i.current=void 0,s.current=void 0,C.dispatch(Gs(!1)),!M&&!I){console.log("mouseUp - not a click or drag end - skipping");return}Ue[y.type].handleMouseUp({roomState:f,pointingAt:b,tool:y,storeState:u,mouseDownPointingAt:D,mouseEvent:p,upscale:t,isClick:M,isDragEnd:I})},l=p=>{const u=C.getState(),f=Ee(u),g=Te(u);i.current=void 0,s.current=void 0,Ue[g.type].handleMouseLeave({roomState:f,tool:g,storeState:u,mouseEvent:p})},d=p=>{const u=C.getState(),f=Ee(u),g=lt(u),v=Ne(t,g,p),y=Te(u),b=ft(v,f,y,u.levelEditor.gridResolution);console.log("setting mouseDownPointingAtRef to",b),s.current=b,Ue[y.type].handleMouseDown({roomState:f,pointingAt:b,tool:y,storeState:u,mouseEvent:p,upscale:t})},h=ji(c);return n.addEventListener("mousemove",h),n.addEventListener("mouseup",a),n.addEventListener("mousedown",d),n.addEventListener("mouseleave",l),()=>{n.removeEventListener("mousemove",h),n.removeEventListener("mouseup",a),n.removeEventListener("mousedown",d),n.removeEventListener("mouseleave",l)}},[e.stage,t,n,o])},ya={amigaHiResPal:"Amiga Hi-Res PAL",classicMac:"Classic Mac",amigaLowResPal:"Amiga Low-Res PAL",zxSpectrum:"ZX Spectrum",handheld:"Handheld"},va=({selectedResolution:n,onResolutionChange:e})=>{const t=$e.indexOf(n),o=t<$e.length-1,r=t>0,{justDone:s,doneNow:i}=di();return L.jsxs("div",{className:"absolute scale-editor top-0 right-1 z-slightlyAbove flex gap-0 leading-none text-white",children:[s>0&&L.jsx(dt,{className:"px-1 bg-moss items-center flex",children:ya[n]}),L.jsx(Pn,{small:!0,disabled:!r,tooltipContent:`##zoom ⬇

makes things look *smaller* by *increasing* emulated resolution`,onClick:()=>{r&&(e($e[t-1]),i())},shortcutKeys:["-"],children:L.jsx(dt,{children:"-"})}),L.jsx(Pn,{small:!0,disabled:!o,tooltipContent:`##zoom ⬆

makes things look *bigger* by *decreasing* emulated resolution`,onClick:()=>{o&&(e($e[t+1]),i())},shortcutKeys:["⇧+","="],children:L.jsx(dt,{children:"+"})})]})},wa=n=>{const e=ce();P.useEffect(()=>{if(n)return n.appendChild(e.canvas),()=>{n.removeChild(e.canvas)}},[n,e])},ba=n=>{const e=ce(),[t]=P.useState(()=>new w({label:"editorPositioner"})),o=Uo();P.useEffect(()=>{if(n.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return t.addChild(n.output.graphics),e.stage.addChild(t),()=>{e.stage.removeChild(t),t.removeChild(n.output.graphics)}},[n,e,t]),P.useEffect(()=>{t.x=-o.l+ye,t.y=-o.t+ye},[t,o])},Ca=(n,e)=>{const t=P.useCallback(()=>{if(n===null)return;const o=Math.max(0,(n.scrollWidth-n.clientWidth)/2),r=Math.max(0,(n.scrollHeight-n.clientHeight)/2);n.scrollTo(o,r)},[n]);P.useEffect(()=>{if(n!==null)return Mo({actionCreator:Bt,effect(){setTimeout(t,0)}})},[t,n]),P.useEffect(()=>{if(n===null||e===null)return;if(e.querySelector("canvas"))setTimeout(t,0);else{const r=new MutationObserver(()=>{e.querySelector("canvas")&&(t(),r.disconnect())});return r.observe(e,{childList:!0,subtree:!0}),()=>r.disconnect()}},[n,e,t])},ka=()=>{const n=ce(),e=Qe(t=>t.upscale.upscale.gameEngineUpscale);n.stage.scale=e},Sa=()=>{P.useEffect(()=>Mo({actionCreator:an,effect(n,{dispatch:e}){e(Ot())}}))},Ia=()=>{const n=ce(),e=Uo(),t=Qe(o=>o.upscale.upscale);P.useEffect(()=>{const o=(2*ye+e.w)*t.gameEngineUpscale,r=(2*ye+e.h)*t.gameEngineUpscale;n.renderer?.resize(o,r)},[n.renderer,e,t])},Ta=({levelEditor:n})=>{const{dragInProgress:e,clickableAnnotationHovered:t,hoveredItem:o,selectedJsonItemIds:r}=n;if(e)return $("cursor-grabbing");if(t)return $("cursor-pointer");if(o){const s=$o(n,o.jsonItemId);if(s!==void 0&&jo(s))if(o.pointingAtOnItem.corner){if(Kt(o.pointingAtOnItem.corner,{x:1,y:1,z:1}))return $("cursor-n-resize")}else{const{edge:i}=o.pointingAtOnItem;if(i){if(G(i,Sr))return $("cursor-e-resize");if(G(i,xr))return $("cursor-s-resize");if(G(i,Cr))return $("cursor-w-resize");if(G(i,yr)||G(i,wr))return $("cursor-ne-resize");if(G(i,vr)||G(i,br))return $("cursor-nw-resize");if(G(i,Ir))return $("cursor-se-resize");if(G(i,kr))return $("cursor-sw-resize")}}return r.includes(o.jsonItemId)?$("cursor-grab"):$("cursor-default")}return $("cursor-crosshair")},Pa=()=>Hs(Ta),k=new window.AudioContext,Dt={pureBlack:new T("#000000"),shadow:new T("#0D1C2A"),midGrey:new T("#3D403B"),lightGrey:new T("#827F63"),white:new T("#F7FDF6"),pastelBlue:new T("#1F75FC"),metallicBlue:new T("#003664"),pink:new T("#AD5195"),moss:new T("#595D00"),redShadow:new T("#412629"),midRed:new T("#9A372C"),lightBeige:new T("#B57048"),highlightBeige:new T("#D99D49"),alpha:new T("#00404D"),replaceLight:new T("#006847"),replaceDark:new T("#00171C")},ve=`in vec2 aPosition;
out vec2 vTextureCoord;

uniform vec4 uInputSize;
uniform vec4 uOutputFrame;
uniform vec4 uOutputTexture;

vec4 filterVertexPosition( void )
{
    vec2 position = aPosition * uOutputFrame.zw + uOutputFrame.xy;
    
    position.x = position.x * (2.0 / uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*uOutputTexture.z / uOutputTexture.y) - uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

vec2 filterTextureCoord( void )
{
    return aPosition * (uOutputFrame.zw * uInputSize.zw);
}

void main(void)
{
    gl_Position = filterVertexPosition();
    vTextureCoord = filterTextureCoord();
}
`,Ma=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    finalColor = vec4(c.rgb * 0.5, c.a);
}
`;class Ra extends ne{constructor(){const e=Z.from({vertex:ve,fragment:Ma,name:"halfbrite-filter"});super({glProgram:e,resources:{}})}}const Mr=6;function*Aa(n,e,t,o=1){const r=2**Mr-1,s=Math.floor(n*r+.5),i=Math.floor(e*r+.5),c=Math.floor(t*r+.5);for(let a=-o;a<=o;a++)for(let l=-o;l<=o;l++)for(let d=-o;d<=o;d++){const h=s+a,p=i+l,u=c+d;if(h<0||h>r||p<0||p>r||u<0||u>r)continue;const f=Math.sqrt(a*a+l*l+d*d),g=u%8*64,v=Math.floor(u/8)*64,y=g+h,b=v+p;yield{x:y,y:b,distance:f}}}const _a=`#version 300 es
// some old/mid-spec Android devices (eg, Pixel 7a) need this to be high
// precision, or they 'miss' the locations on the LUT
precision highp float;

in vec2 vTextureCoord;
out vec4 finalColor;

// Must match TypeScript: 2^mortonEncodeRgbBitDepth^1.5
// With mortonEncodeRgbBitDepth = 6: 64^1.5 = 512
const float lutW = 512.0;

uniform sampler2D uTexture;
uniform sampler2D uLut;

/**
 * Block-based encoding for 6-bit RGB values
 * Blue determines which 64x64 block, red/green are x/y within block
 */
ivec2 blockEncode(vec3 color) {
    // Convert to 6-bit integers (0-63)
    ivec3 c6 = ivec3(floor(color * 63.0 + 0.5));

    // Blue determines which 64x64 block in an 8x8 grid
    int blockX = (c6.b % 8) * 64;
    int blockY = (c6.b / 8) * 64;

    // Within the block, red is X and green is Y
    int x = blockX + c6.r;
    int y = blockY + c6.g;

    return ivec2(x, y);
}

void main(void) {

    vec4 c = texture(uTexture, vTextureCoord);

    // Get block-encoded position for this color (returns integer coordinates)
    ivec2 lutPos = blockEncode(c.rgb);

    // use the Morton position to look up the replacement in the LUT:
    // Convert to normalized coordinates for better cross-platform compatibility
    vec2 normalizedPos = vec2(
        (float(lutPos.x) + 0.5) / lutW,
        (float(lutPos.y) + 0.5) / lutW
    );
    vec4 replacementColour = texture(uLut, normalizedPos);

    // use original if either:
    //      original alpha is 0 (because keep transparent)
    //      or lut alpha is 0 (signals unwritten slot in the LUT)
    // The alpha channel stores closeness (0 = unwritten, >0 = has replacement)
    float shouldReplace = c.a * step(0.004, replacementColour.a); // > 1/255 means written

    // Use the replacement color but force alpha to be fully opaque (or match original alpha)
    vec4 replacement = vec4(replacementColour.rgb, c.a);
    finalColor = mix(c, replacement, shouldReplace);
}
`,Re=(2**Mr)**(3/2),Oa=Re*Re,Gn=new Map,Ba=n=>{const e=new Uint8Array(Oa*4);for(const o of Xo)for(const[r,s]of cs(n)){const i=m[r];for(const{x:c,y:a,distance:l}of Aa(i.red*o,i.green*o,i.blue*o,2)){const d=a*Re+c,h=e[d*4+3],p=Math.max(1,Math.floor(255-l/1.732*254));(h===0||p>h)&&(e[d*4+0]=Math.floor(s.red*o*255),e[d*4+1]=Math.floor(s.green*o*255),e[d*4+2]=Math.floor(s.blue*o*255),e[d*4+3]=p)}}for(let o=3;o<e.length;o+=4)e[o]>0&&(e[o]=255);return V.from({resource:e,width:Re,height:Re,scaleMode:"nearest",antialias:!1})};class za extends ne{#e;constructor(e){const t=Object.keys(e).length,o=Z.from({vertex:ve,fragment:_a,name:"palette-swop-filter"}),r=Ba(e);super({glProgram:o,resources:{colorReplaceUniforms:{uOriginal:{value:new Float32Array(3*t),type:"vec3<f32>",size:t},uReplacement:{value:new Float32Array(3*t),type:"vec3<f32>",size:t}},uLut:r.source}}),this.#e=r;const s=this.resources.colorReplaceUniforms.uniforms;Object.entries(e).forEach(([i,c],a)=>{m[i].toArray().forEach((l,d)=>{s.uOriginal[a*3+d]=l}),c.toArray().forEach((l,d)=>{s.uReplacement[a*3+d]=l})})}get lut(){return this.#e}destroy(e){this.#e?.destroy(!0),this.#e=null,super.destroy(e)}}const Fa=n=>Object.entries(n).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>`${e}:${t.toHex()}`).join("|"),F=n=>{const e=Fa(n);let t=Gn.get(e);return t||(t=new za(n),Gn.set(e,t)),t},$a=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uTargetColor;

vec4 black = vec4(0.0, 0.0, 0.0, 1.0);

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    // 1 if black, 0 if non-black
    float isBlack = step(length(c.rgb), 0.01);

    // keep original if either:
    //      * black
    //      * transparent

    finalColor = mix(    
        vec4(uTargetColor, 1),    
        c, 
        max(isBlack, 1.0 - c.a)
    );
}
`;class A extends ne{uniforms;constructor(e="white"){const t=Z.from({vertex:ve,fragment:$a,name:"revert-colourise-filter"});super({glProgram:t,resources:{colorReplaceUniforms:{uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this.targetColor=e}set targetColor(e){const[t,o,r]=new T(e).toArray();this.uniforms.uTargetColor[0]=t,this.uniforms.uTargetColor[1]=o,this.uniforms.uTargetColor[2]=r}}const Rr=({basic:n,dimmed:e})=>({replaceLight:n,replaceDark:e}),jt=({color:{hue:n,shade:e},planet:t})=>{const o=n==="yellow"?e==="dimmed"||t==="jail"?ui:hi:Zo[n][e].main;return Rr(o)},hn={lightBeige:m.lightGrey,redShadow:m.shadow,pink:m.lightGrey,moss:m.lightGrey,midRed:m.midGrey,highlightBeige:m.lightGrey,pastelBlue:m.lightGrey,metallicBlue:m.midGrey,replaceLight:m.lightGrey,replaceDark:m.midGrey};F(hn);const Ea=F(Ao(hn,"metallicBlue","pastelBlue"));F(Ao(hn,"pink"));const La=F({midGrey:m.midRed,lightGrey:m.lightBeige,white:m.highlightBeige,metallicBlue:m.redShadow,pink:m.midRed,moss:m.midRed,replaceDark:m.midRed,replaceLight:m.lightBeige}),Hn=(n,e)=>{const t=Ze(n.color).edges[e],o=t.original;return t.dimInOriginal?No(o):o},Ar=new T("#424249"),Da=new T("#494908"),ja=new T("#554055"),Ua=new T("#404055"),Ga={blacktooth:{pureBlack:W(m.moss,.15)},safari:{pureBlack:W(m.moss,.17)},jail:{pureBlack:W(m.redShadow,.2)},egyptus:{pureBlack:W(m.redShadow)},moonbase:{shadow:Ar,pureBlack:W(m.metallicBlue,.2)},bookworld:{pureBlack:W(m.highlightBeige,.1)},penitentiary:{pureBlack:W(m.midGrey,.2)}},Ha={yellow:{shadow:Da},white:{shadow:Ar},magenta:{shadow:ja},cyan:{shadow:Ua}},Wa=(n,e)=>{if(n){if(e.color.shade==="dimmed"){const t=jt(e),o=Ro(t,([r,s])=>{for(const[i,c]of ls(m))for(const a of Xo)if(W(c,a).toHex()===s.toHex())return[r,W(Dt[i],a)];return[r,s]});return F({...Dt,...o})}return F({...Ga[e.planet]??se,...Ha[e.color.hue]??se,...jt(e)})}else return new A(e.color.shade==="dimmed"?No(Ze(e.color).main.original):Ze(e.color).main.original)},_r=(n,e,t)=>t?F(Rr(Zo[n.color.hue][n.color.shade].edges[e])):new A(Ze(n.color).edges[e].original),Or=n=>F(jt(n)),Va=n=>{switch(n.color.hue){case"white":return F({replaceLight:m.lightGrey,replaceDark:m.midGrey});default:return}},Br=n=>{switch(n.color.hue){case"white":return F({replaceLight:m.lightBeige,replaceDark:m.midRed,shadow:m.redShadow});case"yellow":return Or({planet:n.planet,color:{hue:"yellow",shade:"dimmed"}});default:return}};new Ra;const oe=_t;F(Dt);const Ut=()=>{throw new Error(`sounds not loaded - only call this from inside code 
      (like in a render loop) that is protected and only executed once 
      loading has happened`)},O=n=>{const e=typeof n=="string"?{soundId:n}:n,{playbackRate:t=1,soundId:o,connectTo:r,loop:s=!1,varyPlaybackRate:i=!1,randomiseStartPoint:c=!1}=e,a=k.createBufferSource(),l=Ut()[o];return a.buffer=l,a.loop=s,a.playbackRate.value=i?t-.05+Math.random()*.1:t,s&&c?a.start(0,l.duration*Math.random()):a.start(),r!==void 0&&a.connect(r),a},de=(n,e,t)=>{const o=k.createGain();return e!==void 0&&(o.gain.value=e),n.connect(o),o.connect(t),o},B=({start:n,change:e,loop:t,stop:o,startAndLoopTogether:r=!1,noStartOnFirstFrame:s=!0},i)=>{let c=!0,a,l;return d=>{if(!!d!=!!l)d?n!==void 0&&!(c&&s)?(a&&(a.onended=null,a.stop()),a=O({...n}),de(a,n.gain,i),t!==void 0&&(r?(a=O({...t,loop:!0}),de(a,t.gain,i)):a.onended=()=>{l&&(a&&(a.onended=null,a.stop()),a=O({...t,loop:!0}),de(a,t.gain,i))})):t!==void 0&&(a=O({...t,loop:!0}),de(a,t.gain,i)):(a&&a.loop&&(a.onended=null,a.stop()),o!==void 0&&(a=O({...o}),de(a,o.gain,i)));else if(l!==d&&e!==void 0){const p=O({...e});de(p,e.gain,i)}c=!1,l=d}};class Xa{constructor(e){this.renderContext=e,this.output.gain.value=4}output=k.createGain();#e=B({loop:{soundId:"rollingBallLoop",playbackRate:.5}},this.output);tick(){const{renderContext:{item:{state:{vels:{sliding:e},standingOnItemId:t}}}}=this,o=(e.x!==0||e.y!==0)&&t!==null;this.#e(o)}destroy(){}}class Na{constructor(e){this.renderContext=e;const{item:{config:{was:t}}}=e;switch(t.type){case"pickup":{t.gives!=="scroll"&&O({soundId:"bonus",connectTo:this.output});break}case"disappearing":{O({soundId:"destroy",connectTo:this.output});break}case"hushPuppy":{this.output.gain.value=.5,O({soundId:"hushPuppyVanish",connectTo:this.output});break}}}output=k.createGain();tick(){}destroy(){}}class Za{constructor(e){this.renderContext=e,this.#e.connect(this.output)}output=k.createGain();#e=k.createGain();#t=void 0;tick(){const{renderContext:{item:{state:{pressed:e}}}}=this,t=this.#t?.pressed;t!==void 0&&t!==e&&O({soundId:"switchClick",playbackRate:e?.95:1.05,connectTo:this.#e}),this.#t={pressed:e}}destroy(){}}class pn{constructor(e,t,o=1){this.renderContext=e,this.#e=B({start:t},this.output),this.output.gain.value=o}output=k.createGain();#e;tick({lastRenderRoomTime:e}){const{renderContext:{item:t}}=this,{state:{collidedWith:{roomTime:o,by:r}}}=t,s=o>(e??cn)&&!pi(tt(r));this.#e(s)}destroy(){}}class qa{constructor(e){this.renderContext=e,this.#e.connect(this.output),this.#e.gain.value=.5,this.#n=new pn(e,{soundId:"metalHit"},.3),this.#n.output.connect(this.output)}output=k.createGain();#e=k.createGain();#t=B({start:{soundId:"servoStart",playbackRate:.5},loop:{soundId:"servoLoop",playbackRate:.5},stop:{soundId:"servoStop",playbackRate:.5}},this.#e);#n;tick(e){const{renderContext:{item:t,room:{roomTime:o,items:r}}}=this,{state:{actedOnAt:{roomTime:s,by:i}}}=t,c=o===s&&et(tt(i)).some(a=>Go(r[a]));this.#t(c),this.#n.tick(e)}destroy(){}}const ze=n=>{for(const e in n)return!0;return!1},mt=2;class Ya{constructor(e){this.renderContext=e}output=k.createGain();#e=B({start:{soundId:"conveyorStart",playbackRate:mt},loop:{soundId:"conveyorLoop",playbackRate:mt},stop:{soundId:"conveyorEnd",playbackRate:mt}},this.output);tick(){const{renderContext:{item:{state:{stoodOnBy:e}}}}=this,t=ze(e);this.#e(t)}destroy(){this.#e(!1)}}class Ja{constructor(e){this.renderContext=e,O({soundId:"hooter",connectTo:this.output})}output=k.createGain();tick(){}destroy(){}}const Ka=3;class Qa{constructor(e){this.renderContext=e,this.output.gain.value=.7}output=k.createGain();#e=O({soundId:"helicopter",loop:!0,connectTo:this.output});tick(){const{renderContext:{item:{state:{vels:{lift:{z:e}}}}}}=this;this.#e.playbackRate.value=Math.max(.5,1+Ka*e)}destroy(){}}const Wn={skiHead:{soundId:"softBump"},turtle:{soundId:"softBump"},dalek:{soundId:"metalHit",gain:.1},homingBot:{soundId:"metalHit",gain:.2},computerBot:{soundId:"metalHit",gain:.2}},Vn={cyberman:{soundId:"jetpackTurnaround",gain:1.2},dalek:{soundId:"mojoTurn",gain:.3}},Xn={cyberman:{soundId:"jetpackLoop",gain:.7},emperorsGuardian:{soundId:"jetpackLoop"},dalek:{soundId:"mojoLoop",gain:.2},bubbleRobot:{soundId:"bubbleRobotLoop"},helicopterBug:{soundId:"helicopter"}},Nn={homingBot:{start:{soundId:"detect"},loop:{soundId:"robotWhirLoop",gain:4},startAndLoopTogether:!0},computerBot:{loop:{soundId:"robotBeepingLoop",randomiseStartPoint:!0,varyPlaybackRate:!0}}};class ec{constructor(e){this.renderContext=e,this.#e.connect(this.output),this.#t.connect(this.output),this.#t.gain.value=.66;const{item:{config:{which:t}}}=e;Wn[t]!==void 0&&(this.#r=new pn(e,Wn[t]),this.#r.output.connect(this.output)),Vn[t]!==void 0&&(this.#n=B({change:Vn[t]},this.#e)),Nn[t]!==void 0&&(this.#s=B(Nn[t],this.#e)),Xn[t]!==void 0&&(this.#o=B({loop:Xn[t]},this.#t))}output=k.createGain();#e=k.createGain();#t=k.createGain();#n;#o;#r;#s;tick(e){const{renderContext:{item:t}}=this,{state:{facing:o,activated:r,busyLickingDoughnutsOffFace:s,vels:{walking:i}}}=t;if(this.#n){const c=_o(o);this.#n(c)}if(this.#r&&this.#r.tick(e),this.#o){const c=r&&!s;this.#o(c)}if(this.#s){const c=!Kt(i,ge);this.#s(c)}}destroy(){}}const tc=n=>{if(Ws(n))return n.state;if(Vs(n))return n.state.heels},nc=.8,oc=1.2,rc=.8;class gt{constructor(e){this.renderContext=e;const{general:{soundSettings:t},item:{type:o}}=e,{noFootsteps:r}={...en.soundSettings,...t};r||(this.#e=k.createGain(),this.#e.gain.value=nc,this.#e.connect(this.output),this.#t=B({loop:{soundId:`${o==="headOverHeels"?"heels":o}Walk`}},this.#e)),this.#n.gain.value=rc,this.#n.connect(this.output),this.#a.gain.value=oc,this.#a.connect(this.output),this.#s.connect(this.output),this.#o=B({start:{soundId:`${o==="headOverHeels"?"head":o}Jump`}},this.#n),this.#r=B({loop:{soundId:`${o==="headOverHeels"?"head":o}Fall`}},this.#n)}output=k.createGain();#e;#t;#n=k.createGain();#o;#r;#s=k.createGain();#i=B({start:{soundId:"landing"},noStartOnFirstFrame:!0},this.#s);#a=k.createGain();#l=B({start:{soundId:"carry",playbackRate:.95},stop:{soundId:"carry",playbackRate:1.05}},this.#a);#c={teleportingPhase:null,positionZ:0};tick({lastRenderRoomTime:e}){const{renderContext:{item:t}}=this,{state:{action:o,teleporting:r,jumpStartZ:s,jumped:i,standingOnItemId:c,position:{z:a},vels:{gravity:{z:l}},collidedWith:{roomTime:d,by:h}}}=t,p=tc(t),{teleportingPhase:u,positionZ:f}=this.#c,g=r?r.phase:null,v=i&&a>s&&a>f&&l>0,y=a<f&&l<0&&c===null;this.#r(y),this.#o(v),this.#t!==void 0&&this.#t(!v&&!y&&o==="moving"),p!==void 0&&this.#l(p.carrying!==null);const b=c!==null&&d>(e??cn)&&h[c];if(this.#i(b),g!==null&&g!==u)if(g==="in"){const I=Ut().teleportIn,M=k.createBufferSource();M.buffer=I,M.connect(this.output),M.start()}else{const I=Ut().teleportOut,M=k.createBufferSource();M.buffer=I,M.connect(this.output),M.start()}this.#c={teleportingPhase:g,positionZ:a}}destroy(){}}class sc{constructor(e){this.renderContext=e}output=k.createGain();#e=void 0;tick(){const{renderContext:{item:{state:{stoodOnBy:e},config:{style:t}}}}=this;if(t!=="drum")return;const o=this.#e?.stoodOn??!1,r=ze(e);!o&&r&&O({soundId:"drum",connectTo:this.output}),this.#e={stoodOn:r}}destroy(){}}class ic{constructor(e){this.renderContext=e,this.scrapeBracketed=B({loop:{soundId:"stepStoolScraping"}},this.output),this.output.gain.value=.4}output=k.createGain();scrapeBracketed;tick({movedItems:e}){const{renderContext:{item:t,room:{roomTime:o}}}=this,{state:{actedOnAt:{roomTime:r},standingOnItemId:s}}=t,i=o===r&&s!==null&&e.has(t);this.scrapeBracketed(i)}destroy(){}}class ac extends pn{constructor(e){super(e,{soundId:"glassClink",varyPlaybackRate:!0},.8),this.renderContext=e}}class cc{constructor(e){this.renderContext=e}output=k.createGain();tick({lastRenderRoomTime:e}){const{renderContext:{item:{state:{stoodOnBy:t,stoodOnUntilRoomTime:o}}}}=this,r=ze(t);e!==void 0&&o>e&&!r&&O({soundId:"springBoing",connectTo:this.output})}destroy(){}}class lc{constructor(e){this.renderContext=e,this.#e.connect(this.output)}output=k.createGain();#e=k.createGain();#t=void 0;tick(){const{renderContext:{item:{state:{setting:e},config:t}}}=this,o=t.type==="in-store"?Oo(C.getState().gameMenus,t.path)?"right":"left":e,r=this.#t?.setting;r!==void 0&&r!==o&&O({soundId:"switchClick",playbackRate:o==="right"?.95:1.05,connectTo:this.#e}),this.#t={setting:o}}destroy(){}}const Fe=(n,e)=>et(tt(n)).map(t=>{const o=e.items[t];if(o===void 0)throw new Error(`item ${t} in stoodOnBy is not in the room`);return o}),zr=n=>{let e=2166136261;const t=n.length;for(let o=Math.max(0,t-9);o<t;o++)e^=n.charCodeAt(o),e=Math.imul(e,1540483477),e^=e>>>15;return(e>>>0)/4294967295},dc=1e3/25,Fr=n=>{const e=nt.animations[n],t=e.length,{animationSpeed:o}=e;return t*dc/o};Fr("bubbles.white");Fr("head.fadeOut");const fn=({config:{activatedOnStoreValue:n}})=>n===void 0?!0:!!ds(C.getState().gameMenus.gameInPlay,n);class uc{constructor(e){this.renderContext=e}output=k.createGain();#e=B({loop:{soundId:"teleportWarningSiren"}},this.output);tick(){const{renderContext:{item:e,room:t}}=this;this.#e(fn(e)&&Fe(e.state.stoodOnBy,t).some(ln))}destroy(){}}const hc=(n,e)=>Yo(Fe(n.state.stoodOnBy,e).filter(Ho));class pc{constructor(e){this.renderContext=e,this.output.gain.value=2}output=k.createGain();#e=void 0;tick(e){const{renderContext:{item:t,room:o}}=this,r=hc(t,o);this.#e!==void 0&&r<this.#e&&O({soundId:"toasterPopUpSoundUrl",connectTo:this.output}),this.#e=r}destroy(){}}const fc={lift:Qa,switch:lc,button:Za,bubbles:Na,head:gt,heels:gt,headOverHeels:gt,teleporter:uc,monster:ec,conveyor:Ya,spring:cc,portableBlock:sc,charles:qa,ball:Xa,pushableBlock:ic,firedDoughnut:Ja,slidingBlock:ac},mc=n=>{if(n.item.type==="deadlyBlock"&&n.item.config.style==="toaster")return new pc(n);const e=fc[n.item.type];if(e)return new e(n)},Zn=R.h*-1,qn=R.h*Ns,gc=0,xc=R.w*16,yc={x:0,y:0,z:0},xt=(n,e,t)=>(n-e)/(t-e)*2-1,vc=.5,wc=.3;class bc{constructor(e,t){this.renderContext=e,this.childRenderer=t,t.output.connect(this.output),this.output.rolloffFactor=2,this.output.maxDistance=5,this.output.distanceModel="exponential";const o=Xs(e.room).floors;this.soundPositionMinX=o.edgeLeftX,this.soundPositionMaxX=o.edgeRightX}output=k.createPanner();soundPositionMinX;soundPositionMaxX;tick(e){this.childRenderer.tick(e);const{item:t}=this.renderContext,o=t.state,r=us(hs(yc,t.aabb,.5),o.position),s=xt(Ve(r),this.soundPositionMinX,this.soundPositionMaxX),i=xt(r.z,Zn,qn);if(!Number.isFinite(i))throw new Error(`y position for sound rendering is not finite;
        positionY = numberInRangeToMinus1To1Range(
          itemCentrePosition = ${r.z},
          ${Zn},
          ${qn},
        );
        itemCentrePosition = addXyz(
          itemState.position = ${JSON.stringify(o.position)},
          scaleXyz(${JSON.stringify(t.aabb)}, 0.5),
        )`);const c=xt(r.x+r.y,gc,xc);this.output.positionX.value=s*vc,this.output.positionY.value=i,this.output.positionZ.value=c*wc}destroy(){this.childRenderer.destroy()}}const Yn={x:.5,y:1},Jn=n=>typeof n!="string"&&Object.hasOwn(n,"animationId"),Gt=n=>{if(typeof n=="string")return Gt({textureId:n});{const{anchor:e,flipX:t,pivot:o,x:r,y:s,filter:i,times:c,label:a}=n;if(n.times){const d=Zs(c);if(Qt(d)>=2){const p=new w({label:a??"timesXyz"});for(let{x:u}=d;u>=1;u--)for(let{y:f}=d;f>=1;f--)for(let g=1;g<=d.z;g++){const v=n.textureId??n.textureIdCallback?.(u-1,f-1,g-1),y={...n,textureId:v,label:`(${u},${f},${g})`};"randomiseStartFrame"in y&&(y.randomiseStartFrame=`${y.randomiseStartFrame}${u},${f},${g}`),delete y.times;const b=Gt(y),I=ie({x:u-1,y:f-1,z:g-1});b.x+=I.x,b.y+=+I.y,p.addChild(b)}return p}}let l;if(Jn(n))l=Cc(n);else{const d=n.textureId??n.textureIdCallback?.(0,0,0);l=new ae(te().textures[d])}if(e===void 0&&o===void 0)if(Jn(n))l.anchor=Yn;else{const d=n.textureId??n.textureIdCallback?.(0,0,0),h=te().data.frames[d];if(h===void 0)throw new Error(`no spritesheet entry for textureId "${d}"`);const p=h.frame;p.pivot!==void 0?l.pivot=p.pivot:l.anchor=Yn}else e!==void 0&&(l.anchor=e),o!==void 0&&(l.pivot=o);return r!==void 0&&(l.x=r),s!==void 0&&(l.y=s),i!==void 0&&(l.filters=i),a!==void 0&&(l.label=a),l.eventMode="static",t===!0&&(l.scale.x=-1),l}},x=Gt;function Cc({animationId:n,reverse:e,playOnce:t,paused:o,randomiseStartFrame:r,gameSpeed:s=1}){const c=te().animations[n].map(d=>({texture:d,time:ps}));e&&c.reverse();const a=new xe(c),l=o?0:Math.sqrt(s);return a.animationSpeed=nt.animations[n].animationSpeed*l,a.gotoAndPlay(r!==void 0?Math.floor(zr(r)*c.length):0),t!==void 0&&(a.loop=!1,a.onComplete=()=>{a.stop(),t==="and-destroy"&&(a.visible=!1)}),a}const kc={Container:"📦",Sprite:"🖼️",UniqueTextureSprite:"✨",Graphics:"🎨",Text:"📝",AnimatedSprite:"🎬",TilingSprite:"🔲",BitmapText:"🔤",Mesh:"🔺",NineSliceSprite:"🔳"},Je=(n,e="",t=!0,o=!0,r=[])=>{const s=[];o&&s.push("");const i=n.constructor.name,c=i.startsWith("_")?i.slice(1):i;let a=kc[c]||"📌";r.forEach((u,f)=>{u.mask===n&&(f===0?a+="😷":a+=`😷^${f+1}`)});const l=n.label&&n.label!==c?` "${n.label}"`:"",d=[];try{(n.x!==0||n.y!==0)&&d.push(`@(${n.x}, ${n.y})`)}catch{d.push("@(ERROR)")}if(n.children.length>2&&d.push(`children: ${n.children.length}`),n.visible||d.push("hidden"),n.alpha<1&&d.push(`alpha: ${n.alpha.toFixed(2)}`),n.mask&&d.push("😷 masked"),n instanceof ae){const u=n;if(u.texture===null||u.texture===void 0)d.push("texture: NO TEXTURE");else{const f=u.texture.label||"(anon texture)";d.push(`texture: "${f}"`)}}const h=o?"":e+(t?"└── ":"├── ");if(s.push(`${h}${a} ${c}${l}`),d.length>0){const u=n.children.length>0,f=o?u?"│  ":"   ":e+(t?"    ":"│   ")+(u?"│  ":"   ");d.forEach(g=>{s.push(`${f}→ ${g}`)})}const p=o?"":e+(t?"    ":"│   ");return n.children.forEach((u,f)=>{const g=f===n.children.length-1;s.push(Je(u,p,g,!1,[n,...r]))}),s.join(`
`)+(o?`
`:"")};class Sc extends ae{constructor(...e){const[t]=e;super(t)}destroy(e){const t=this.texture!==null;typeof e=="boolean"?super.destroy({texture:t,textureSource:e,children:e}):super.destroy({...e,texture:t})}}const Ic=(n,e,t)=>{const o=e.getLocalBounds(),r=Math.ceil(o.maxX-o.minX),s=Math.ceil(o.maxY-o.minY),i=t!==void 0?t.width===r&&t.height===s:!1,c=i?t:rt.create({width:r,height:s,antialias:!1,autoGenerateMipmaps:!1});c.label=`renderTexture of ${e.label??"(anon)"}`,t&&!i&&t.destroy();const{x:a,y:l}=e;e.x-=o.minX,e.y-=o.minY;try{n.render({container:e,target:c,clear:i})}catch(d){throw new Error(`renderContainerToTexture: failed to render to texture. Container:
 ${Je(e)}`,{cause:d})}return e.x=a,e.y=l,c},J=(n,e,t,o)=>{const r=e.getLocalBounds(),s=t?.texture&&t?.texture instanceof rt?t.texture:void 0,i=Ic(n,e,s),c=t||new Sc;return c.texture=i,c.label=o??`sprite of container (${e.label})`,c.pivot={x:Math.floor(-r.minX),y:Math.floor(-r.minY)},c},we=(n,e)=>e instanceof ae?e:J(n,e),Tc=(n,e,t)=>e==="tower"?"tower":e==="book"?"book.x":e==="organic"&&n?`block.organic.dark${t?".disappearing":""}`:`block.${e}${t?".disappearing":""}`,Pc=({renderContext:{general:{pixiRenderer:n},item:{config:{style:e,times:t},state:{disappearing:o}},room:r},currentRendering:s})=>{const i=s?.renderProps,c=o!==null;return i===void 0||i.isDissapearing!==c?{output:we(n,x({textureId:Tc(r.color.shade==="dimmed",e,c),filter:e==="book"?Br(r):void 0,times:t})),renderProps:{isDissapearing:c}}:"no-update"},Mc=({renderContext:{item:{state:{pressed:n}}},currentRendering:e})=>{const t=e?.renderProps;return t===void 0||n!==t.pressed?{output:x({textureId:n?"buttonInGame.pressed":"buttonInGame"}),renderProps:{pressed:n}}:"no-update"},yt={animationId:"bubbles.cold"},fe=({top:n,bottom:e="headlessBase",filter:t})=>{const o=new w({filters:t}),r=x(e);o.addChild(r);const s=x(n);return s.y=-12,o.addChild(s),o[st]=s,o[mn]=r,o},st=Symbol(),mn=Symbol(),Rc=({top:n,bottom:e})=>{const t=new w;return t.addChild(e),n.y=-12,t.addChild(n),t[st]=n,t[mn]=e,t},Ac=({renderContext:{item:{state:{facing:n,actedOnAt:{roomTime:e,by:t}}},room:{roomTime:o,items:r}},currentRendering:s})=>{const i=s?.renderProps,c=tn(n)??"towards",a=o===e&&et(tt(t)).some(d=>Go(r[d]));return i===void 0||c!==i.facingXy4||a!==i.controlledByJoystick?{output:fe({top:`charles.${c}`,bottom:a?"headlessBase.all":"headlessBase"}),renderProps:{facingXy4:c,controlledByJoystick:a}}:"no-update"},it=n=>n,Kn=500,_c=nt.animations["conveyor.x"].animationSpeed,Qn=nt.animations["conveyor.x"].length,Oc=n=>1-(1-n)**2,Bc=(n,e)=>{for(let t=0;t<n.children.length;t++){const o=n.children[t],r=t%Qn;o.gotoAndStop(e?Qn-r-1:r)}},zc=(n,e,t=1)=>{const o=ee(n),r=x({animationId:`conveyor.${o}`,reverse:n==="towards"||n==="right",times:e,gameSpeed:t}),s=r instanceof xe?new w({children:[r]}):r;return Bc(s,n==="towards"||n==="right"),s},Fc=({renderContext:{item:{config:{times:n},state:{stoodOnBy:e,direction:t}},room:{roomTime:o},general:{gameState:r}},currentRendering:s})=>{const i=s?.renderProps,c=ze(e),a=(!c&&i?.moving?o:i?.roomTimeStoppedMoving)??cn,l=c?0:Math.min(o-a,Kn),d=s?.output,p=!d||t!==i?.direction?zc(t,n,r?.gameSpeed):d,u=Math.max(0,1-l/Kn);for(const f of p.children)if(u===0)f.stop();else{const g=_c*Oc(u);f.play(),f.animationSpeed=g}return{output:p,renderProps:{moving:c,roomTimeStoppedMoving:a,direction:t}}},$c=it(Fc);function $r(n,e){const t=e||new w;for(const o of n)t.addChild(o);return t}const at=(n,e)=>{const t=e&&{x:e.x??1,y:e.y??1};return x({...typeof n=="string"?{textureId:n}:n,times:t})},re=n=>_(({renderContext:{item:e}})=>dn(e)?x({...typeof n=="string"?{textureId:n}:n,times:ot(e)}):x(n)),Ec=n=>_(({renderContext:{item:e,general:{gameState:t,paused:o}}})=>dn(e)?x({...n,times:ot(e),paused:o,gameSpeed:t?.gameSpeed}):x({...n,paused:o,gameSpeed:t?.gameSpeed})),E=n=>_(({renderContext:{item:e,general:{pixiRenderer:t}}})=>{if(dn(e))return we(t,at(n,ot(e)));{const o=x(n);return o instanceof ae?o:J(t,o)}}),_=n=>(({renderContext:e,currentRendering:t,tickContext:o})=>t===void 0?{output:n({renderContext:e,currentRendering:void 0,tickContext:o}),renderProps:se}:"no-update"),Y=n=>(({renderContext:{general:{pixiRenderer:e},item:t},currentRendering:o})=>{if(o===void 0){const r=ot(t),s={output:we(e,at(n(t.config),r)),renderProps:se};return r&&(s.output.y-=((r.z??1)-1)*R.h),s}else return"no-update"}),Lc=(n,e,t)=>{const r=te().textures[`door.frame.${n.planet}.${e}.near`]!==void 0?n.planet:"generic",s=n.color.shade==="dimmed"&&te().textures[`door.frame.${r}.dark.${e}.${t}`]!==void 0;return`door.frame.${r}${s?".dark":""}.${e}.${t}`};function*Dc({config:{direction:n,inHiddenWall:e,height:t}},o){const r=nn(n),s=r==="y"?1:16;function*i(c){if(e){if(t!==0){const a=x({textureId:`generic.door.floatingThreshold.${r}`,...Pe(c,{y:-12*t})});a.filters=_r(o,r==="x"?"towards":"right",!0),yield a}}else{yield x({pivot:{x:s,y:9},textureId:`generic.door.legs.base.${r}`,...Pe(c,{})});for(let a=1;a<t;a++)yield x({pivot:{x:s,y:9},textureId:`generic.door.legs.pillar.${r}`,...Pe(c,{y:-a*R.h})})}}yield*i(ie({...me,[r]:1})),yield*i(me),e||(yield x({pivot:{x:16,y:R.h*t+13},textureId:`generic.door.legs.threshold.double.${r}`,...ie({...me,[r]:1})}))}const Er=(n,e)=>{const t=nn(n),o=Be(t),r=8;return n==="towards"||n==="right"?S({[o]:e[o]-r}):me},jc=_(({renderContext:{item:n,room:e}})=>$r(Dc(n,e),new w({...Er(n.config.direction,n.aabb)}))),Uc=_(({renderContext:{item:{config:{direction:n,part:e,toRoom:t},aabb:o},room:r}})=>{const s=fs(C.getState())??C.getState().levelEditor?.campaignInProgress,i=nn(n),c=s?.rooms[t]??r;return x({textureId:Lc(r,i,e),filter:Or(c),...Er(n,o)})}),Gc=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform vec2 uTextureSize;
uniform sampler2D uTexture;
uniform vec3 uOutline;
uniform float uOutlineWidth;

void main(void) {
    vec2 scaledTexelSize = vec2(1.0f) / vec2(textureSize(uTexture, 0)) * uOutlineWidth;    
    
    // Calculate offset coordinates
    vec2 rightCoord = vec2(vTextureCoord.x + scaledTexelSize.x, vTextureCoord.y);
    vec2 leftCoord = vec2(vTextureCoord.x - scaledTexelSize.x, vTextureCoord.y);
    vec2 belowCoord = vec2(vTextureCoord.x, vTextureCoord.y + scaledTexelSize.y);
    vec2 aboveCoord = vec2(vTextureCoord.x, vTextureCoord.y - scaledTexelSize.y);
    
    // Create boundary masks (1.0 if within bounds, 0.0 if out of bounds)
    // seems to work fine without this, but could multiply colourToX by this to get zero'd out when OOB
    // float rightInBounds = step(rightCoord.x, 1.0);
    // float leftInBounds = step(0.0, leftCoord.x);
    // float belowInBounds = step(belowCoord.y, 1.0);
    // float aboveInBounds = step(0.0, aboveCoord.y);
    
    vec4 colourToRight = texture(uTexture, rightCoord);
    vec4 colourToLeft = texture(uTexture, leftCoord);
    vec4 colourBelow = texture(uTexture, belowCoord);
    vec4 colourAbove = texture(uTexture, aboveCoord);
    
    // Check if any neighbor is opaque (combine all alpha values)
    float hasOpaqueNeighbor = max(max(colourToRight.a, colourToLeft.a), 
                                  max(colourBelow.a, colourAbove.a));

    vec4 originalColour = texture(uTexture, vTextureCoord);
        
    finalColor = mix(
        originalColour, 
        vec4(uOutline, 1), 
        // 1 if: original colour is transparent and has an opaque neighbour - use outline colour
        // 0 if: original colour is opaque or has no opaque neighbour - use original colour (transparent or sprite)
        (1.0 - originalColour.a) * hasOpaqueNeighbor
    );
}
`;let Ht=Bo(C.getState());C.subscribe(()=>{Ht=Bo(C.getState())});class Wt extends ne{outlineWidth;constructor({color:e,width:t}){const o=Z.from({vertex:ve,fragment:Gc,name:"outline-filter"}),r=t??Ht;super({glProgram:o,padding:r,resources:{colorReplaceUniforms:{uOutline:{value:new Float32Array(3),type:"vec3<f32>"},uOutlineWidth:{value:new Float32Array(1),type:"f32"}}}}),this.outlineWidth=t;const s=this.resources.colorReplaceUniforms.uniforms,[i,c,a]=e.toArray();s.uOutline[0]=i,s.uOutline[1]=c,s.uOutline[2]=a}apply(e,t,o,r){const s=this.resources.colorReplaceUniforms.uniforms,i=this.outlineWidth??Ht;this.padding=i,s.uOutlineWidth[0]=i,super.apply(e,t,o,r)}}const z={...Ro(m,([n,e])=>[n,new Wt({color:e})]),black1pxFilter:new Wt({color:m.pureBlack,width:1})},Ge=z.pureBlack;new A;new A;new A;new A(m.moss);new A;new A(m[Me.head]),new A(m.midGrey),new A(m[Me.heels]),new A(m.midGrey);const Hc=n=>{const e=`hud.char.${ms(n)}`;try{qo(e)}catch(t){throw new Error(`no texture id for char "${n}": ${t.message}`,{cause:t})}return e},Wc=(n,e)=>(n+.5-e/2)*gs.w,Vc=n=>typeof n=="string"?n==="infinite"?"":n:n.toString(),Lr=(n,e)=>{const t=Vc(e),o=Yo(t),r=n.children.length,s=o!==r;try{let i=0;for(const c of t){const a=Hc(c);let l;if(i<r){l=n.getChildAt(i);const d=te().textures[a];l.texture=d}else l=x(a),n.addChild(l);i++}}catch(i){throw console.error("invalid string is",t,"and on window as window.invalid"),console.error(i),window.invalid=e,new Error(`could not show text "${e}" in container because: "${i.message}"`,{cause:i})}if(s){o<r&&n.removeChildren(o);for(let i=0;i<o;i++){const c=n.getChildAt(i);c.x=Wc(n.getChildIndex(c),o)}}return n},Xc=qs.floatingText,eo=12,to=R.h*3,no=[m.shadow,m.midGrey,m.redShadow,m.metallicBlue,m.midRed,m.moss,m.pink,m.lightBeige,m.pastelBlue,m.lightGrey,m.highlightBeige],oo=[...no,...new Array(20).fill(m.white),...no.toReversed()],Nc=({renderContext:{item:{config:{textLines:n,appearanceRoomTime:e}},room:{roomTime:t},general:{displaySettings:{uncolourised:o}},frontLayer:r},currentRendering:s})=>{const i=s?.output;let c;const l=(t-e)*Xc;if(i===void 0){c=new w({filters:z.pureBlack}),r?.attach(c);for(let h=0;h<n.length;h++){const p=n[h],u=Lr(new w({label:p,y:h*eo,filters:o?oe:new A(m.pink)}),p.toUpperCase());c.addChild(u)}}else c=i;let d=!1;for(let h=0;h<n.length;h++){const p=c.children[h],[u]=p.filters,f=l+h*-eo,g=f>0&&f<to;if(p.visible=g,d||=g,g&&u){const v=Math.floor(f/to*oo.length);u.targetColor=oo[v]}}return c.visible=d,c.y=-l,{output:c,renderProps:se}},ro=(n,e)=>e===0?n:Math.round(n/e)*e,so=n=>n-Math.floor(n),Zc=(n,e,t,o)=>n<=o&&t<=e,qc=`#version 300 es
precision lowp float;

out vec4 finalColor;

in vec2 vTextureCoord;
uniform sampler2D uBackBuffer;
uniform vec3 uTargetColor;
// do not use uTexture in this frag - for some reason it causes pixi's render pipeline
// to take away the backbuffer, which we rely on sampling from

void main() {
    vec3 bg = texture(uBackBuffer, vTextureCoord).rgb;

    float isBlack = step(length(bg), 0.001f); // 1 if black, 0 otherwise
    finalColor = mix(vec4(uTargetColor, 1.0f), vec4(0, 0, 0, 0), isBlack);


}`;class io extends ne{uniforms;constructor(e="white"){const t=Z.from({vertex:ve,fragment:qc,name:"colour-clash-filter"});super({glProgram:t,resources:{colorReplaceUniforms:{uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}},blendRequired:!0}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this.targetColor=e}set targetColor(e){const[t,o,r]=new T(e).toArray();this.uniforms.uTargetColor[0]=t,this.uniforms.uTargetColor[1]=o,this.uniforms.uTargetColor[2]=r}}const Yc=({state:{position:n}},e)=>{const t=r=>r.config.direction==="away"||r.config.direction==="left";return $r(K(e.items).filter(r=>r.type==="wall"||r.type==="doorLegs").filter(t).map(r=>{const{id:s,config:{direction:i},state:{position:c}}=r;return x({textureId:"floorOverdraw.cornerNearWall",label:s,...S(At(c,n)),times:r.type==="wall"?Eo(r.config):{[Be(ee(i))]:2},anchor:{x:0,y:1},flipX:i==="away"})}),new w({label:"floorOverdraws"}))},Jc=(n,e)=>{const{config:{naturalFootprint:{aabb:t,position:o}},state:{position:r}}=e,s=Ve(Q(ge,r)),{left:i,right:c}=K(n.items).filter(Ys).filter(a=>{const{state:{position:l},aabb:d}=a,h=a.config.direction,p=ee(h),u=Be(p),f=h==="away"||h==="left",g=o[p]+(f?1:0)*t[p],v=l[p]+(f?0:1)*d[p];return g!==v?!1:Zc(l[u],l[u]+d[u],o[u],o[u]+t[u])}).reduce((a,{aabb:l,renderAabb:d,renderAabbOffset:h,state:{position:p},fixedZIndex:u})=>{const f=u===Js,g=f?l:d??l,v=X(p,h??ge),y=Ve(X(v,{x:g.x,y:f?g.y:0}))+s,b=Ve(X(v,{x:f?g.x:0,y:g.y}))+s;return{left:Math.min(a.left,y),right:Math.max(a.right,b)}},{left:9999,right:-9999});if(c>i)return new N().rect(i,-500,c-i,500).fill("rgba(255, 0, 0)")},ao=({colourised:n,direction:e,room:t,times:o,position:r,colourSwap:s})=>x({label:`floorEdge(${e})`,textureId:`floorEdge.${e}`,times:o,filter:s?_r(t,e,n):void 0,...S(r)}),Kc=({room:n,xSize:e,ySize:t,y:o})=>{const r=new w({label:"floorColourClash"}),s=Hn(n,"right");for(let c=0;c<=t;c++){const a=ie({x:0,y:c,z:0}),l=new N().rect(a.x-(c===0?0:8),a.y,24,8).fill(s);l.filters=new io(s),r.addChild(l)}const i=Hn(n,"towards");for(let c=0;c<=e;c++){const a=ie({x:c,y:0,z:0}),l=new N().rect(a.x-16,a.y,8*(c===0?2:3),8).fill(i);l.filters=new io(i),r.addChild(l)}return r.y=o,r},Qc=_(({renderContext:{room:n,item:e,general:{colourised:t,pixiRenderer:o},colourClashLayer:r,frontLayer:s}})=>{const{color:{shade:i}}=n,{config:c,state:{position:a},aabb:l}=e,{floorType:d,naturalFootprint:h}=c,p=new w({label:"floorAppearance"}),u=new w({label:"sprites"}),f=S({...l,y:0}),g=S({...l,x:0,y:0}),v=S({...l,x:0}),y=S(l);if(d!=="none"){const b=new w({label:"tiles"}),I=d==="deadly"?`generic${i==="dimmed"?".dark":""}.floor.deadly`:`${c.scenery}${i==="dimmed"?".dark":""}.floor`,M=te().textures[I];try{qo(I)}catch(Wr){throw new Error(`no floor textureId for floorType: ${d}, shade: ${i}`,{cause:Wr})}const D=Q(h.position,a),j={x:so(D.x/R.w),y:so(D.y/R.w)},U=8,gn={x:f.x,y:y.y-U,width:v.x-f.x,height:g.y-y.y+2*U},Gr=Q(ie(Pe(j,{x:.5,y:.5})),{y:l.z},gn),Hr=new Bi({texture:M,tilePosition:Gr,...gn});b.addChild(Hr),b.addChild(Yc(e,n));const xn=new N().moveTo(y.x,y.y).lineTo(v.x,v.y).lineTo(v.x,v.y+3).lineTo(g.x,g.y+3).lineTo(f.x,f.y+3).lineTo(f.x,f.y).fill({color:16711680,alpha:1}),yn=J(o,xn);xn.destroy(),b.addChild(yn),b.mask=yn,b.filters=Va(n)??oe;const vn=new w({children:[b]});vn.filters=z.black1pxFilter,u.addChild(vn)}{const b=new w({label:"edges"});if(d==="none"){const j=new N().moveTo(v.x,v.y+10).lineTo(v.x,v.y+100).lineTo(f.x,f.y+100).lineTo(f.x,f.y+10).lineTo(g.x,g.y+10).fill(0),U=J(o,j);p.addChild(U),s.attach(U),j.destroy()}const I=Math.ceil(l.y/R.w);b.addChild(ao({colourised:t,direction:"right",room:n,times:{y:I},position:{z:l.z},colourSwap:t}));const M=Math.ceil(l.x/R.w);b.addChild(ao({colourised:t,direction:"towards",room:n,times:{x:M},position:{z:l.z},colourSwap:t})),u.addChild(b);const D=Jc(n,e);if(D!==void 0){const j=J(o,D);u.addChild(j),u.mask=j,D.destroy()}if(p.addChild(J(o,u)),u.destroy({children:!0}),!t){const j=Kc({xSize:M,ySize:I,y:-l.z+1,room:n});p.addChild(j),r.attach(j)}}return p}),el=["cyberman","dalek","skiHead","bubbleRobot","computerBot","turtle","homingBot"],tl=200,nl=1,ol=(n,e)=>{const t=zr(e);return Math.sin((n+t*2e4)/tl)*nl},co=({id:n,config:{which:e},state:t},o,r)=>{if((e==="cyberman"||e==="bubbleRobot")&&t.activated||e==="emperorsGuardian"){const s=r;s[st].y=-12+ol(o.roomTime,n)}},rl=({renderContext:{item:n,room:e,general:{paused:t,gameState:o}},currentRendering:r})=>{const{config:s,state:i,id:c}=n,a=r?.renderProps,{activated:l,busyLickingDoughnutsOffFace:d}=i,h=d?La:l?void 0:el.includes(s.which)?Ea:void 0;switch(s.which){case"skiHead":case"turtle":case"cyberman":case"computerBot":case"elephant":case"elephantHead":case"monkey":{const p=tn(i.facing)??"towards";if(!(a===void 0||l!==a.activated||d!==a.busyLickingDoughnutsOffFace||p!==a.facingXy4))return co(n,e,r.output),"no-update";const f={facingXy4:p,activated:l,busyLickingDoughnutsOffFace:d};switch(s.which){case"skiHead":return{output:x({textureId:`${s.which}.${s.style}.${p}`,filter:h}),renderProps:f};case"elephantHead":return{output:x({textureId:`elephant.${p}`,filter:h}),renderProps:f};case"turtle":return{output:x(l&&!d?{animationId:`${s.which}.${p}`,filter:h,paused:t,gameSpeed:o?.gameSpeed,randomiseStartFrame:c}:{textureId:`${s.which}.${p}.1`,filter:h}),renderProps:f};case"cyberman":return{output:i.activated||i.busyLickingDoughnutsOffFace?fe({top:{textureId:`${s.which}.${p}`,filter:h||void 0},bottom:{...yt,paused:t,gameSpeed:o?.gameSpeed}}):x({textureId:`${s.which}.${p}`,filter:h}),renderProps:f};case"computerBot":case"elephant":case"monkey":return{output:fe({top:`${s.which}.${p}`,bottom:{animationId:"headlessBase.flash",playOnce:"and-stop",gameSpeed:o?.gameSpeed},filter:h}),renderProps:f};default:throw new Error(`unexpected monster ${s}`)}break}case"homingBot":{const p=!xs(i.vels.walking,me);return a===void 0||d!==a.busyLickingDoughnutsOffFace||l!==a.activated||p!==a.walking?{filter:h,output:x(l&&!d?{animationId:p?"headlessBase.flash":"headlessBase.scan",filter:h,gameSpeed:o?.gameSpeed}:{textureId:"headlessBase",filter:h,gameSpeed:o?.gameSpeed}),renderProps:{activated:l,busyLickingDoughnutsOffFace:d,walking:p}}:"no-update"}case"helicopterBug":case"emperor":case"dalek":case"bubbleRobot":case"emperorsGuardian":{if(!(a===void 0||d!==a.busyLickingDoughnutsOffFace||l!==a.activated))return co(n,e,r.output),"no-update";const u={activated:l,busyLickingDoughnutsOffFace:d};switch(s.which){case"helicopterBug":case"dalek":return{output:x(l&&!d?{animationId:s.which,filter:h,paused:t,gameSpeed:o?.gameSpeed,randomiseStartFrame:c}:{textureId:`${s.which}.1`,filter:h}),renderProps:u};case"bubbleRobot":return{output:fe({top:{...yt,randomiseStartFrame:c,paused:t,gameSpeed:o?.gameSpeed},filter:h}),renderProps:u};case"emperorsGuardian":return{output:fe({top:"ball",bottom:{...yt,paused:t,gameSpeed:o?.gameSpeed},filter:h}),renderProps:u};case"emperor":return{output:x({animationId:"bubbles.cold",filter:h,paused:t,gameSpeed:o?.gameSpeed}),renderProps:u};default:throw new Error(`unexpected monster ${s}`)}break}default:throw new Error(`unexpected monster ${s}`)}},sl=n=>{const{gameTime:e,lastDiedAt:t}=n.type==="headOverHeels"?n.state.head:n.state;return e-t<Ks},vt=n=>{if(n===void 0)return 0;const{shieldCollectedAt:e,gameTime:t}=n;return e!==null&&e+Sn>t?100-Math.ceil((t-e)/(Sn/100)):0},il=n=>n.type==="headOverHeels"?vt(n.state.head)>0||vt(n.state.heels)>0:vt(n.state)>0,al=`#version 300 es
precision lowp float;

in vec2 vTextureCoord;
out vec4 finalColor;

uniform sampler2D uTexture;
uniform vec3 uColour;

void main(void) {
    vec4 c = texture(uTexture, vTextureCoord);

    // we know c.a is either 0 or 1, so no need to do a step()

    finalColor = mix(c, vec4(uColour, 1), c.a);
}
`;class Ke extends ne{constructor(e){const t=Z.from({vertex:ve,fragment:al,name:"oneColour-filter"});super({glProgram:t,resources:{colorReplaceUniforms:{uColour:{value:new Float32Array(3),type:"vec3<f32>"}}}});const o=this.resources.colorReplaceUniforms.uniforms,[r,s,i]=e.toArray();o.uColour[0]=r,o.uColour[1]=s,o.uColour[2]=i}}const Vt=.02,cl=({name:n,action:e,facingXy8:t,teleportingPhase:o,gravityZ:r,paused:s,gameSpeed:i})=>{if(e==="death")return{animationId:`${n}.fadeOut`,paused:s,gameSpeed:i};if(o==="out")return{animationId:`${n}.fadeOut`,paused:s,gameSpeed:i};if(o==="in")return{animationId:`${n}.fadeOut`,paused:s,gameSpeed:i};if(e==="moving")return{animationId:`${n}.walking.${t}`,paused:s,gameSpeed:i};if(e==="jumping")return{textureId:r<Vt?`${n}.walking.${t}.2`:`${n}.walking.${t}.1`};if(e==="falling"){const a=`${n}.falling.${t}`;if(fi(a))return{textureId:a}}const c=`${n}.idle.${t}`;return un(c)?{animationId:c,paused:s,gameSpeed:i}:{textureId:`${n}.walking.${t}.2`}},Xt=Symbol(),Nt=Symbol(),ll=(n,e)=>{n[Xt].removeChildren(),n[Xt].addChild(x(cl(e)))},Dr=F({pastelBlue:m.pink}),wt=(n,e,t,o)=>{const r=new w,s=new w;r[Xt]=s,r.addChild(s);const i=x({animationId:e?`shine.${n}InSymbio`:"shine",paused:t,filter:n==="heels"?Dr:oe,flipX:n==="heels",gameSpeed:o??1});return r[Nt]=i,r},lo=({gameTime:n,switchedToAt:e},t,o)=>(t==="headOverHeels"||t===o)&&e+Qs>n,dl=n=>{if(!sl(n))return!1;const{gameTime:e,lastDiedAt:t}=n.type==="headOverHeels"?n.state.head:n.state;return(e-t)%In<In*ei},uo=(n,e)=>{n.filters?Array.isArray(n.filters)?n.filters=[...n.filters,e]:n.filters=[n.filters,e].flat():n.filters=e},ho=(n,e)=>{n.filters=Array.isArray(n.filters)?n.filters.filter(t=>!(t instanceof e)):n.filters instanceof e?oe:n.filters},ul=(n,{highlighted:e,flashing:t,shining:o},r,s)=>{const i=e?Me[n]:o?"midRed":null,c=r?.highlighted?Me[n]:r?.shining?"midRed":null;i!==c&&(ho(s,Wt),i!==null&&uo(s,z[i]));const a=r?.flashing??!1;t&&!a?uo(s,new Ke(m[Me[n]])):!t&&a&&ho(s,Ke)},hl=(n,e,t)=>{e&&!t?n.addChild(n[Nt]):!e&&t&&n.removeChild(n[Nt])},bt=(n,e,t,o,r,s,i)=>{t&&ll(e,{name:n,...o,gameSpeed:s,paused:r}),ul(n,o,i,e),hl(e,o.shining,i?.shining??!1)},pl=({renderContext:{item:n,general:{gameState:e,paused:t}},currentRendering:o})=>{const{type:r,state:{action:s,facing:i,teleporting:c,vels:{gravity:{z:a}}}}=n,l=o?.renderProps,d=o?.output,h=_o(i)??"towards",p=e!==void 0&&(n.type==="headOverHeels"?lo(n.state.head,"headOverHeels","headOverHeels"):lo(n.state,n.type,e.currentCharacterName)),u=dl(n),f=il(n),g=Qt(i),v=c?.phase??null,y={action:s,facingXy8:h,teleportingPhase:v,flashing:u,highlighted:p,shining:f,gravityZ:a},b=l===void 0||l.action!==s||l.facingXy8!==h||l.teleportingPhase!==v||l?.gravityZ>Vt!=a>Vt;let I;if(r==="headOverHeels"){I=d??Rc({top:wt("head",!0,t,e?.gameSpeed),bottom:wt("heels",!0,t,e?.gameSpeed)});const M=I;bt("head",M[st],b,y,t,e?.gameSpeed,l),bt("heels",M[mn],b,y,t,e?.gameSpeed,l)}else I=d??wt(r,!1,t,e?.gameSpeed),bt(r,I,b,y,t,e?.gameSpeed,l);return s==="moving"&&d instanceof xe&&(d.animationSpeed=g*ys),{output:I,renderProps:y}},Ct=it(pl),po=F({pastelBlue:m.moss,metallicBlue:m.moss,pink:m.moss}),kt=(n,e,t,o,r)=>{const s=`${n}.idle.${e}`;return un(s)?{animationId:s,randomiseStartFrame:t,paused:o,gameSpeed:r}:{textureId:`${n}.walking.${e}.2`}},fl=({renderContext:{item:{id:n,config:{which:e,startDirection:t}},general:{paused:o,gameState:r}},currentRendering:s})=>s?.renderProps===void 0?{output:e==="headOverHeels"?fe({top:kt("head",t,n,o,r?.gameSpeed),bottom:kt("heels",t,n,o,r?.gameSpeed),filter:po}):x({...kt(e,t,n,o,r?.gameSpeed),filter:po}),renderProps:se}:"no-update",ml=({renderContext:{item:{state:{vels:{sliding:n}},config:{startingPhase:e}},general:{paused:t}},tickContext:{deltaMS:o},currentRendering:r})=>{const i=(r?.renderProps?.distanceTravelled??0)+Jt(n)*(t?0:o),a=r?.output??x("spikyBall.1"),d=(Math.floor(i*2/He.w)+e)%2+1;return a.texture=te().textures[`spikyBall.${d}`],{output:a,renderProps:{distanceTravelled:i}}},gl=it(ml),xl=({renderContext:{item:{state:{stoodOnBy:n,stoodOnUntilRoomTime:e}},general:{paused:t,gameState:o}},tickContext:{lastRenderRoomTime:r},currentRendering:s})=>{const i=s?.renderProps,c=ze(n);let a;return s?.output?a=s?.output:(a=x({animationId:"spring.bounce",gameSpeed:o?.gameSpeed,paused:t}),a.loop=!1,a.gotoAndStop(0)),r!==void 0&&e>r&&!c&&!t?a.gotoAndPlay(0):c&&!(i?.compressed??!1)&&a.gotoAndStop(1),{output:a,renderProps:{compressed:c}}},yl=it(xl),vl=({renderContext:{item:{state:{setting:n},config:e}},currentRendering:t})=>{const o=t?.renderProps,r=e.type==="in-store"?Oo(C.getState().gameMenus,e.path)?"right":"left":n;return o===void 0||r!==o.setting?{output:x(`switch.${r}`),renderProps:{setting:r}}:"no-update"},wl=({renderContext:{item:n,room:e,general:{paused:t,gameState:o}},currentRendering:r})=>{const{state:{stoodOnBy:s},config:{times:i}}=n,c=r?.renderProps,a=fn(n),l=a&&Fe(s,e).some(ln);return c===void 0||a!==c.activated||l!==c.flashing?{output:l?new w({children:[x({textureId:"teleporter",times:i}),x({animationId:"teleporter.flashing",times:i,paused:t,gameSpeed:o?.gameSpeed})]}):x({textureId:a?"teleporter":"block.artificial",times:i}),renderProps:{flashing:l,activated:a}}:"no-update"},bl=({state:{stoodOnBy:n,position:e},config:{times:t}},o)=>{const r=new Array(t?.x??1).fill(null).map(()=>new Array(t?.y??1));return Fe(n,o).filter(Ho).forEach(({id:s,state:{position:i}})=>{const c=Q(i,e),a={x:Math.floor(c.x/R.w),y:Math.floor(c.y/R.d)};a.x<0||a.x>=(t?.x??1)||a.y<0||a.y>=(t?.y??1)||(r[a.x][a.y]=s)}),r},Cl=(n,e)=>{let t=0,o=1;for(const r of e)for(const s of r)s!==void 0&&n.items[s]?.state.activated&&(t|=o),o<<=1;return t},kl=({renderContext:{item:n,room:e,general:{pixiRenderer:t}},currentRendering:o})=>{const{config:{times:r}}=n,s=o===void 0?bl(n,e):o.renderProps.chargePositions,i=Cl(e,s);if(!(i!==o?.renderProps.cybermanActivationBitmask))return"no-update";const a=x({textureIdCallback(d,h){const p=s[d][h];return p===void 0||e.items[p]?.state.everActivated?"toaster.off":"toaster.on"},times:r??se});return{output:we(t,a),renderProps:{chargePositions:s,cybermanActivationBitmask:i}}},Sl=(n,e,t,o)=>`${n}${o?".dark":""}.wall.${e}.${t}`,Il=_(({renderContext:{general:{pixiRenderer:n,gameState:e},item:{id:t,config:o},room:r}})=>{if(o.direction==="right"||o.direction==="towards")throw new Error(`wall is near: ${t}`);const{direction:s,tiles:i}=o,c=Be(ee(s)),a=new w({label:"wallTiles"}),l=new w({label:"wallAnimations"});for(let h=0;h<o.tiles.length;h++){const p=ie({[c]:h});if(a.addChild(x({textureId:Sl(r.planet,i[h],s,r.color.shade==="dimmed"),...p,pivot:s==="away"?{x:He.w,y:He.h}:{x:0,y:He.h}})),r.planet==="moonbase"){const u=`moonbase.wall.screen.${i[h]}.away`;un(u)&&l.addChild(x({animationId:u,randomiseStartFrame:`${t}${h}`,flipX:s==="left",x:p.x+(s==="away"?-8:8),y:p.y-23,gameSpeed:e?.gameSpeed}))}}const d=new w({label:"wallAppearance"});return d.addChild(J(n,a)),l.children.length>0&&d.addChild(l),d}),Tl=F({white:m.lightBeige,highlightBeige:m.lightBeige,midRed:m.redShadow}),Pl={head:Ct,heels:Ct,headOverHeels:Ct,doorFrame:Uc,doorLegs:jc,monster:rl,floatingText:Nc,barrier:_(({renderContext:{item:{config:{axis:n,times:e,disappearing:t}}}})=>x({textureId:`barrier.${n}`,times:e,filter:t?Tl:void 0})),deadlyBlock:_(({renderContext:{item:{config:n,id:e},general:{paused:t,gameState:o}}})=>{switch(n.style){case"volcano":return x({animationId:"volcano",times:n.times,randomiseStartFrame:e,paused:t,gameSpeed:o?.gameSpeed});case"toaster":throw new Error("use the special toaster appearance instead");default:throw n.style,new Error("unknown deadly block style")}}),spikes:re("spikes"),slidingDeadly:gl,slidingBlock:_(({renderContext:{item:{config:{style:n}},room:e}})=>x(n==="book"?{textureId:"book.y",filter:Br(e)}:n)),block:Pc,switch:vl,button:Mc,conveyor:$c,lift:_(({renderContext:{general:{paused:n,gameState:e}}})=>{const t=new w,o={x:Cn.w/2,y:Cn.h};return t.addChild(x({animationId:"lift",pivot:o,paused:n,gameSpeed:e?.gameSpeed})),t.addChild(x({textureId:"lift.static",pivot:o})),t}),teleporter:wl,sceneryCrown:_(({renderContext:{item:{config:{planet:n}}}})=>x({textureId:`crown.${n}`})),pickup:_(({renderContext:{item:{config:n},general:{paused:e,gameState:t}}})=>{if(n.gives==="crown")return x({textureId:`crown.${n.planet}`});const r={shield:"whiteRabbit",jumps:"whiteRabbit",fast:"whiteRabbit","extra-life":"whiteRabbit",bag:"bag",doughnuts:"doughnuts",hooter:"hooter",scroll:{textureId:"scroll"},reincarnation:{animationId:"fish",paused:e,gameSpeed:t?.gameSpeed}}[n.gives];return x(r)}),moveableDeadly:re("fish.1"),charles:Ac,joystick:re("joystick"),movingPlatform:re("sandwich"),pushableBlock:re("stepStool"),portableBlock:_(({renderContext:{item:{config:{style:n}}}})=>x(n)),spring:yl,sceneryPlayer:fl,hushPuppy:re("hushPuppy"),bubbles:_(({renderContext:{item:{id:n,config:{style:e}},general:{paused:t,gameState:o}}})=>x({animationId:`bubbles.bounce.${e}`,paused:t,gameSpeed:o?.gameSpeed,randomiseStartFrame:n})),firedDoughnut:Ec({animationId:"bubbles.doughnut"}),ball:re("ball"),floor:Qc,particle:_(({renderContext:{item:{config:{forCharacter:n}},general:{paused:e,gameState:t}}})=>x({animationId:"particle.fade",anchor:{x:.5,y:.5},filter:n==="heels"?Dr:oe,paused:e,gameSpeed:t?.gameSpeed}))},Ml=n=>{if(n.type==="wall"){const{direction:e}=n.config;return e==="right"||e==="towards"?void 0:Il}return n.type==="deadlyBlock"&&n.config.style==="toaster"?kl:Pl[n.type]};class Rl{constructor(e,t){this.renderContext=t,this.#e=e,this.#t.addChild(...e.map(o=>o.output))}#e;#t=new w({label:"CompositeRenderer"});tick(e){for(const t of this.#e)t.tick(e)}destroy(){for(const e of this.#e)e.destroy()}get output(){return this.#t}}const Al=m.pastelBlue,fo=z.highlightBeige,_l=z.lightBeige,mo=z.midRed,Ol=z.white,go=new A(Al),St=new A(m.white),xo=new A(m.midRed),Bl=new A(m.lightBeige),zl=new A(m.pastelBlue),yo={left:"↖",away:"↗",right:"↘",towards:"↙"},vo=n=>n.type==="switch"&&n.config.type==="in-room"||n.type==="button",wo=(n,e)=>{switch(n){case"back-forth":switch(e){case"left":return"↖↘";case"right":return"↘↖";case"away":return"↗↙";case"towards":return"↙↗";default:throw new Error("Unexpected startDirection")}case"forwards":switch(e){case"left":return"↖";case"right":return"↘";case"away":return"↗";case"towards":return"↙";default:throw new Error("Unexpected startDirection")}case"clockwise":switch(e){case"left":return"↖↗↘↙";case"right":return"↘↙↖↘";case"away":return"↗↘↙↖";case"towards":return"↙↖↗↘";default:throw new Error("Unexpected startDirection")}case"towards-analogue":return"➡.⬅"}return""},Fl=n=>n.type==="monster"&&n.config.activated==="after-player-near";class $l{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output),this.#e()}output=new w({label:"EditorAnnotationsRenderer"});#e(){const e=this.renderContext.item;switch(e.type){case"pickup":if(e.config.gives==="shield"||e.config.gives==="extra-life"||e.config.gives==="jumps"||e.config.gives==="fast"){const t={shield:"🛡",jumps:"♨",fast:"⚡","extra-life":"+2"};this.#t({annotationText:t[e.config.gives],yAdj:-16})}break;case"doorFrame":if(e.config.part==="near"){const{rooms:t}=C.getState().levelEditor.campaignInProgress,{config:{toRoom:o,direction:r}}=e;if(o!==ti){const s=!!t[o],i=yo[r],c=r==="away"||r==="right"?`${o}${i}`:`${i}${o}`;this.#t({annotationText:c,yAdj:r==="left"||r==="away"?-48:0,filter:s?St:xo,clickDispatch:s?()=>Bt(o):void 0})}}break;case"teleporter":{const{rooms:t}=C.getState().levelEditor.campaignInProgress,{config:{toRoom:o}}=e,r=!!t[o];this.#t({annotationText:`➡${o}`,yAdj:-12,filter:r?St:xo,clickDispatch:r?()=>Bt(o):void 0})}break;case"conveyor":{const{config:{direction:t}}=e,o=yo[t];this.#t({annotationText:o,yAdj:-12})}break;case"movingPlatform":{const{config:{movement:t,startDirection:o}}=e;this.#t({annotationText:wo(t,o),yAdj:-12})}break;case"monster":{const{config:t}=e;switch(!0){case(t.which==="cyberman"&&t.activated==="after-player-near"):this.#t({annotationText:"wake",filter:Bl,yAdj:-12});break;case(t.which==="turtle"||t.which==="skiHead"):this.#t({annotationText:wo(t.movement,t.startDirection),yAdj:-12});break}}break}}#t({annotationText:e,yAdj:t=0,filter:o=St,clickDispatch:r}){const{renderContext:{frontLayer:s}}=this,i=Lr(new w({label:"EditorAnnotationTextContainer",filters:[o,z.pureBlack]}),e);i.y=t,r!==void 0&&(i.eventMode="static",i.on("click",()=>{C.dispatch(r())}),i.on("mouseover",()=>{C.getState().levelEditor.tool.type==="pointer"&&(C.dispatch(Tn(!0)),i.filters=[zl,z.pureBlack])}),i.on("mouseout",()=>{C.dispatch(Tn(!1)),i.filters=[o,z.pureBlack]}),i.cursor="pointer"),this.output.addChild(i),s.attach(i)}tick(e){this.#n(),this.childRenderer.tick(e)}#n(){const{renderContext:{room:e}}=this,t=this.renderContext.item,{clickableAnnotationHovered:o}=C.getState().levelEditor,{jsonItemId:r}=t,s=C.getState(),i=zo(s),c=ni(s),a=Te(s),l=r&&i?.jsonItemId===r&&!o,d=r&&c.includes(r),h=()=>r!==void 0&&(K(e.items).some(p=>p.jsonItemId===i?.jsonItemId&&vo(p)&&p.config.modifies.some(u=>u.expectType===t.type&&(u.targets===void 0||u.targets.includes(r))))||vo(t)&&K(e.items).some(({jsonItemId:p,type:u})=>p!==void 0&&p===i?.jsonItemId&&t.config.modifies.some(f=>f.expectType===u&&(f.targets===void 0||f.targets.includes(p))))||t.type==="charles"&&K(e.items).some(p=>p.jsonItemId===i?.jsonItemId&&p.type==="joystick"&&p.config.controls.some(u=>u===r))||t.type==="joystick"&&t.config.controls.some(p=>i?.jsonItemId===p));this.output.filters=l&&d?[go,a.type==="eyeDropper"?mo:fo]:l?a.type==="eyeDropper"?mo:fo:d?go:h()?Ol:Fl(t)?_l:oe}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const El=(n,e,t)=>e.general.editor?new $l(e,t):t;class Ll{constructor(e,t){this.renderContext=e,this.appearance=t,this.output=new w({label:"AppearanceRenderer"})}#e;output;destroy(){this.output.destroy({children:!0})}tick(e){const t=this.appearance({renderContext:this.renderContext,currentRendering:this.#e,tickContext:e});t!=="no-update"&&(this.output.children.at(0)!==t.output&&(this.#e?.output&&(this.output.removeChild(this.#e.output),this.#e.output.destroy({texture:!0,children:!0})),t.output!==void 0&&this.output.addChild(t.output)),this.#e=t)}}class jr extends Ll{}const bo=(n,e)=>{e.poly([S({}),S({x:n.x}),S({x:n.x,y:n.y}),S({y:n.y})]).poly([S({}),S({z:n.z}),S({y:n.y,z:n.z}),S({y:n.y})]).poly([S({x:n.x}),S({x:n.x,z:n.z}),S(n),S({x:n.x,y:n.y})]).poly([S({z:n.z}),S({x:n.x,z:n.z}),S({x:n.x,y:n.y,z:n.z}),S({y:n.y,z:n.z})])},Co=(n,e)=>{const t=new N;return bo(n,t),t.stroke({width:.5,color:e,alpha:1}),t.eventMode="static",t.on("pointerenter",()=>{t.fill({color:e,alpha:.5})}),t.on("pointerleave",()=>{t.clear(),bo(n,t),t.stroke({width:.5,color:e,alpha:1})}),t},Dl={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",pickup:"rgba(0,196,255)",emitter:"rgba(0,255,255)",stopAutowalk:"rgba(255,128,128)",floatingText:"rgba(128,0,255)"};class jl{constructor(e){this.renderContext=e;const{item:t}=e,o=Dl[t.type]??"rgba(255,255,255)";if(this.#e=new w({label:`ItemBoundingBoxRenderer ${t.id}`}),oi("portal")(t)){const s=S(t.config.relativePoint);this.#e.addChild(new N().circle(s.x,s.y,5).stroke(o)),this.#e.addChild(new N().circle(s.x,s.y,2).fill(o))}if(this.#e.addChild(new N({label:"objectOrigin"}).circle(0,0,2).fill(o)),this.#e.addChild(Co(t.aabb,o)),t.renderAabb){const s="rgba(184, 184, 255)",i=Co(t.renderAabb,s);if(t.renderAabbOffset){const c=S(t.renderAabbOffset);i.position.set(c.x,c.y),i.circle(0,0,2).fill(s)}this.#e.addChild(i)}this.#e.eventMode="static";let r;this.#e.on("pointerenter",()=>{if(r!==void 0)return;const s=`${t.id} ${t.type}
@(${t.state.position.x}, ${t.state.position.y}, ${t.state.position.z})}
#(${t.aabb.x}, ${t.aabb.y}, ${t.aabb.z})}`;this.#e.addChild(r=new $i({text:s,style:{fill:o,fontSize:6,fontFamily:"Menlo"}})),r.resolution=4}),this.#e.on("pointerleave",()=>{r!==void 0&&(this.#e.removeChild(r),r=void 0)}),e.frontLayer.attach(this.#e)}#e;tick(){}destroy(){this.#e.destroy({children:!0})}get output(){return this.#e}}const Ul=[new Ke(m.midRed),z.pureBlack],Gl=[new Ke(m.moss),z.pureBlack],Hl=75;class Wl{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output)}output=new w({label:"ItemFlashOnSwitchedRenderer"});tick(e){const{renderContext:{item:{state:{switchedAtRoomTime:t,switchedSetting:o}},room:{roomTime:r}}}=this;this.output.filters=r-t<Hl?o==="left"?Gl:Ul:oe,this.childRenderer.tick(e)}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const Vl=(n,e)=>{const{item:t,room:{items:o}}=n;return K(o).filter(ri).some(({config:{modifies:s}})=>s.some(i=>i.targets===void 0?i.expectType===t.type:i.targets.includes(t.id)))?new Wl(n,e):e},Xl=(n,e,t,o)=>{const r=1/o;n.x=ro(e,r),n.y=ro(t,r)},Ur=new _i;Ur.matrix=[0,0,0,1,0,0,.3,0,0,0,0,0,.3,0,0,0,0,0,1,0];class Nl{constructor(e,t){this.renderContext=e,this.wrappedRenderer=t,this.output=new w({label:`ItemPositionRenderer ${e.item.id}`,children:[t.output]}),this.#t()}output;#e=new Map;#t(){const{general:{upscale:{gameEngineUpscale:e}}}=this.renderContext,t=S(this.renderContext.item.state.position);Xl(this.output,t.x,t.y,e)}tick(e){this.wrappedRenderer?.tick(e),e.movedItems.has(this.renderContext.item)&&this.#t(),this.#s()}#n(){const e=this.renderContext.item.id,t=this.renderContext.zEdges.get(e);if(!t)return Mt;let o;for(const[r,s]of t)s&&(o||(o=new Set),o.add(r));return o??Mt}#o(e,t){const o=new w({label:`maskWith: ${e}`,children:[t,this.output.children[0]]});return this.output.addChild(o),o.setMask({mask:t,inverse:!0}),this.#e.set(e,o),o}#r(e,t){const[o,r]=t.children,s=t.parent;s.removeChild(t),s.addChild(r),t.mask=null,o.destroy(),t.destroy(),this.#e.delete(e)}#s(){const{pixiRenderer:e}=this.renderContext.general,t=this.#n();for(const o of this.#e.keys())if(!t.has(o)){const r=this.#e.get(o);if(r)try{this.#r(o,r)}catch(s){throw new Error(`error while destroying masking container ${Je(r)} 
              for our rendering: ${Je(this.output)}`,{cause:s})}}for(const o of t){const r=this.#e.get(o),s=r?.children[0],i=this.renderContext.getItemRenderPipeline(o)?.itemAppearanceRenderer?.output;if(i===void 0)throw new Error("nothing to use as a mask");const c=i.filters;i.filters=Ur;const a=J(e,i,s,`red mask: ${o}`);i.filters=c,r===void 0&&this.#o(o,a);const l=this.renderContext.room.items[o],d=Q(S(l.state.position),S(this.renderContext.item.state.position));a.x=d.x,a.y=d.y}}destroy(){this.output.destroy({children:!0}),this.wrappedRenderer?.destroy()}}const It=(n,e=1)=>({renderContext:{item:{state:{facing:t}}},currentRendering:o})=>{const r=o?.renderProps,s=tn(t)??"towards";if(!(r===void 0||s!==r.facingXy4))return"no-update";const c=x(s==="left"||s==="away"?`shadowMask.${n}.away`:`shadowMask.${n}.right`);return c.y=-(R.h*(e-1)),c.scale.x=s==="away"||s==="right"?1:-1,{output:c,renderProps:{facingXy4:s}}},Zl=({renderContext:{general:{pixiRenderer:n},item:e,room:t},currentRendering:o})=>{const{state:{stoodOnBy:r},config:{times:s}}=e,i=o?.renderProps,c=fn(e),a=c&&Fe(r,t).find(ln)!==void 0;return i===void 0||c!==i.activated||a!==i.flashing?{output:we(n,at({textureId:a?"shadowMask.teleporter.flashing":c?"shadowMask.teleporter":"shadowMask.fullBlock"},s)),renderProps:{flashing:a,activated:c}}:"no-update"},ko={lift:E("shadowMask.smallBlock"),conveyor:Y(({direction:n})=>({textureId:"shadowMask.conveyor",flipX:ee(n)==="x"})),doorLegs:Y(({direction:n})=>({textureId:n==="right"||n==="towards"?"shadowMask.door.floatingThreshold.double.y":"shadowMask.door.legs.threshold.double.y",flipX:ee(n)==="y"})),teleporter:Zl,floor:"no-mask",barrier:Y(({axis:n})=>({textureId:"shadowMask.barrier.y",flipX:n==="x",y:-1})),spring:E("shadowMask.smallRound"),block:Y(({style:n})=>n==="tower"?"shadowMask.tower":"shadowMask.fullBlock"),pushableBlock:E("shadowMask.stepStool"),movingPlatform:E("shadowMask.fullBlock"),hushPuppy:E("shadowMask.hushPuppy"),portableBlock:Y(({style:n})=>n==="drum"?"shadowMask.smallRound":"shadowMask.smallBlock"),slidingBlock:Y(({style:n})=>n==="book"?"shadowMask.fullBlock":"shadowMask.smallRound"),deadlyBlock:Y(({style:n})=>n==="volcano"?"shadowMask.volcano":"shadowMask.toaster"),spikes:E("shadowMask.spikes"),switch:E("shadowMask.switch"),button:E("shadowMask.buttonInGame"),pickup:Y(({gives:n})=>{switch(n){case"scroll":return"shadowMask.scroll";case"doughnuts":return"shadowMask.doughnuts";case"fast":case"extra-life":case"jumps":case"shield":return"shadowMask.whiteRabbit";default:return"blank"}}),slidingDeadly:E("shadowMask.smallRound"),ball:E("shadowMask.ball"),"monster.dalek":E("shadowMask.dalek"),"monster.turtle":It("turtle"),"monster.skiHead":It("skiHead"),"monster.homingBot":E("shadowMask.smallRound"),joystick:E("shadowMask.joystick"),charles:It("charles",2)},ql=n=>{switch(n.type){case"monster":return ko[`monster.${n.config.which}`];case"floor":return n.config.floorType==="none"?void 0:"no-mask";default:return ko[n.type]}},Yl=n=>n.shadowCastTexture!==void 0,Jl=new Ri({alpha:1-mi}),ue={id:"spaceAbove",state:{position:{x:0,y:0,z:0}},aabb:{x:0,y:0,z:ii}};class Kl{constructor(e,t){if(this.renderContext=e,this.#e.filters=Jl,t!=="no-mask")if(this.#n=new jr(e,t),e.item.shadowOffset===void 0)this.#e.addChild(this.#n.output);else{const o=new w({label:"shadowMaskOffset",...S(e.item.shadowOffset),children:[this.#n.output]});this.#e.addChild(o)}this.#e.addChild(this.#t)}#e=new w({label:"ItemShadowRenderer"});#t=new w({label:"shadows"});#n;#o=new Map;get#r(){return C.getState().gameMenus.userSettings.displaySettings.showShadowMasks}#s(e){if(this.#n===void 0)return;const t=this.#n.output.children.at(0);this.#n.tick(e);const o=this.#n.output.children.at(0);if(o===void 0||!(o instanceof ae)){const{item:r}=this.renderContext;throw new Error(`ItemShadowRenderer: this.#shadowMaskRenderer didn't create a sprite for item "${r.id}" of type "${r.type}". Have got ${o}`)}t!==o&&(this.#r?this.renderContext.frontLayer.attach(o):this.#e.mask=o)}destroy(){this.#e.destroy(!0),this.#n?.destroy();for(const e of Object.values(this.#o))e.sprite.destroy()}tick(e){const{movedItems:t}=e,{item:o,general:{pixiRenderer:r},room:s}=this.renderContext,i=t.has(o),c=o.state.position.z+o.aabb.z;ue.state.position.x=o.state.position.x,ue.state.position.y=o.state.position.y,ue.state.position.z=c,ue.aabb.x=o.aabb.x,ue.aabb.y=o.aabb.y;const a=new Set(si(ue,s[Wo],d=>d!==o&&Yl(d)&&(d.castsShadowWhileStoodOn||d.state.position.z>o.state.position.z+o.aabb.z)));let l=!1;for(const[d,h]of this.#o)a.has(d)||(this.#t.removeChild(h),h.destroy(),this.#o.delete(d));for(const d of a){l=!0;let h=this.#o.get(d),p=!1;if(!h){const{times:u}=d.config;h=we(r,at(d.shadowCastTexture,u)),h.label=d.id,this.#t.addChild(h),this.#o.set(d,h),p=!0}if(p||i||t.has(d)){const u=S({...Pe(Q(d.state.position,o.state.position),d.shadowOffset??me),z:o.aabb.z});h.x=u.x,h.y=u.y}}this.#e.visible=l,l&&this.#s(e)}get output(){return this.#e}}const Ql=n=>{const e=ql(n.item);return e===void 0?void 0:new Kl(n,e)};class ed{constructor(e,t){this.renderContext=e,this.componentRenderers=t,this.output={graphics:t.graphics?.output,sound:t.sound?.output}}output;tick(e){this.componentRenderers.graphics?.tick(e),this.componentRenderers.sound?.tick(e)}destroy(){this.componentRenderers.graphics?.destroy(),this.componentRenderers.sound?.destroy()}}const td=()=>z.moss;class nd{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output)}output=new w({label:"PortableItemPickUpNextHighlightRenderer"});#e=!1;tick(e){const{wouldPickUpNext:t}=this.renderContext.item.state;t!==!this.#e&&(this.output.filters=t?[td()]:oe),this.#e=t,this.childRenderer.tick(e)}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const od=(n,e,t)=>ai(n)?new nd(e,t):t,rd=(n,e)=>{e!==void 0&&C.getState().gameMenus.cheatsOn&&(e.eventMode="static",e.on("pointertap",()=>{C.dispatch(bs({item:n,pixiContainer:e}))}))},sd=n=>{const e=C.getState(),t=vs(e),o=!ws(e),{item:r}=n,s=t==="all"||t==="non-wall"&&n.item.type!=="wall",i=[],c=Ml(r);let a;if(c!==void 0){a=new jr(n,c);const u=Vl(n,a);i.push(El(r,n,od(r,n,u)))}if(o){const u=Ql(n);u!==void 0&&i.push(u)}s&&i.push(new jl(n));let l;if(i.length===0)l=void 0;else{const u=i.length===1?i[0]:new Rl(i,n);l=new Nl(n,u),rd(r,l.output)}const d=n.general.soundSettings.mute??en.soundSettings.mute,h=n.general.paused||d?void 0:mc(n),p=h===void 0?void 0:new bc(n,h);return{top:new ed(n,{graphics:l,sound:p}),itemAppearanceRenderer:a}};class id{constructor(e){this.renderContext=e;const{general:{colourised:t,soundSettings:o}}=e;this.initFilters();const s=o.mute??en.soundSettings.mute?void 0:k.createGain();this.output={sound:s,graphics:new w({label:`RoomRenderer(${e.room.id})`})},this.output.graphics.addChild(this.#t),t||(this.#n=new Bn({sortableChildren:!1}),this.output.graphics.addChild(this.#n)),this.output.graphics.addChild(this.#o)}#e=!1;#t=new w({label:"items",cullableChildren:!0});#n;#o=new Bn({sortableChildren:!1});output;#r=void 0;#s=new Map;#i=new Map;initFilters(){const{general:{colourised:e},room:t}=this.renderContext;this.#t.filters=Wa(e,t)}#a=e=>this.#i.get(e);#l(e,t){let o=this.#i.get(t.id);if(o===void 0){o=sd({...this.renderContext,colourClashLayer:this.#n,frontLayer:this.#o,item:t,zEdges:this.#s,getItemRenderPipeline:this.#a}),this.#i.set(t.id,o);const{graphics:r,sound:s}=o.top.output;if(r&&(this.#t.addChild(r),t.fixedZIndex&&(r.zIndex=t.fixedZIndex)),s){if(!this.output.sound)throw new Error("item renderer has sound, but room renderer does not - this probably means that they disagree on if the user has sound muted");s.connect(this.output.sound)}}try{o.top.tick(e)}catch(r){throw new Error(`RoomRenderer: error while ticking item "${t.id}"
in room "${this.renderContext.room.id}"
item in play object is:
           
${JSON.stringify(t,null,2)}`,{cause:r})}}#c(e){const{room:t}=this.renderContext,o={...e,lastRenderRoomTime:this.#r},r=new Set,s=c=>{if(r.has(c))return;const a=this.#s.get(c);if(a)for(const[l,d]of a.entries())d&&s(l);this.#l(o,t.items[c]),r.add(c)};for(const c in t.items)s(c);let i=!1;for(const[c,a]of this.#i.entries())t.items[c]===void 0&&(a.top.destroy(),this.#i.delete(c),i=!0);i&&this.#u()}#u(){if(this.#n)for(const e of this.#n.renderLayerChildren)e.parent===null&&this.#n.detach(e);for(const e of this.#o.renderLayerChildren)e.parent===null&&this.#o.detach(e)}#h(e){for(let t=0;t<e.length;t++){const o=this.#i.get(e[t]);if(o===void 0)throw new Error(`Item id=${e[t]} does not have a renderer - cannot assign a z-index`);const r=o.top.output.graphics;if(!r)throw new Error(`order ${e[t]} was given a z-order by sorting, but item has no graphics`);r.zIndex=t}}get#d(){return this.#r!==void 0}tick(e){const t=this.#d?e:{...e,movedItems:new Set(K(this.renderContext.room.items))},{renderContext:{room:o}}=this;gr(o.items,o[Wo],t.movedItems,this.#s);const r=hr(this.#s);this.#c(t),(!this.#d||t.movedItems.size>0)&&this.#h(r),this.#r=this.renderContext.room.roomTime}destroy(){this.output.graphics.label=this.output.graphics.label+"DESTROYED",this.output.graphics.destroy({children:!0}),this.output.sound?.disconnect(),this.#i.forEach(e=>{e.top.destroy()}),this.#e=!0}get destroyed(){return this.#e}}const ad=(n,e)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:e},soundSettings:{mute:!0},pixiRenderer:n,gameState:void 0,paused:!1,colourised:!0,upscale:Yt(C.getState()),editor:!0}),So=(n,e,t)=>new id({room:n,general:ad(e,t)}),cd=()=>{const{renderer:n}=ce(),e=Cs();if(!n)throw new Error("this should never be falsey (typescript violation)");const t=Vo(),[o,r]=P.useState(()=>So(t,n,e));return P.useEffect(()=>{const s=So(t,n,e);return r(s),()=>{s.destroy()}},[t,n,e]),o},ld=n=>{const e=Vo(),t=ce();P.useEffect(()=>{let o=0;const r=({deltaMS:s})=>{if(n.destroyed)return;n.renderContext.room!==e&&console.warn("room renderer does not have the current room");const i=new Set(zt(e.items));e.roomTime+=s,n.tick({deltaMS:s,movedItems:i,progression:o++}),t.render()};return he.shared.add(r),()=>{he.shared.remove(r)}},[n,e,t])};ks.defaultOptions.scaleMode="nearest";const dd=()=>{const n=cd(),[e,t]=P.useState(null),[o,r]=P.useState(null),[s,i]=P.useState("amigaLowResPal"),c=Pa();return Li(s,o??void 0),Ia(),ba(n),ld(n),xa(e),wa(e),ka(),Sa(),Ca(o,e),L.jsxs("div",{className:"w-full h-full relative",children:[L.jsx(va,{selectedResolution:s,onResolutionChange:i}),L.jsx("div",{ref:r,className:`w-full h-full ${c} scale-editor bg-editor-checkerboard overflow-scroll scrollbar scrollbar-w-1 scrollbar-track-pureBlack scrollbar-thumb-metallicBlue`,children:L.jsx("div",{style:{transform:Di(),transformOrigin:"center center"},ref:t,tabIndex:1,className:"focus-visible:outline-none"})})]})},ud=()=>L.jsx(ia,{children:L.jsx(dd,{})}),xd=Object.freeze(Object.defineProperty({__proto__:null,default:ud},Symbol.toStringTag,{value:"Module"}));export{tr as A,Ko as C,ne as F,rt as R,Ci as S,nr as V,Pi as a,xd as b,bi as u};
