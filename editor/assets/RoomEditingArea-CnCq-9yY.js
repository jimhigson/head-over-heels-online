const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-C_7-IE0G.js","assets/index-BrJohlus.js","assets/index-B-dhTsk9.css","assets/BufferResource-BIhs2IVS.js","assets/RenderTargetSystem-r3VUDvmN.js","assets/levelEditorSlice-DV1_qcla.js","assets/RoomJson-B7DN8xX4.js","assets/LevelEditor-dgNeyyT-.js","assets/halfBrite-bBKz2fn-.js","assets/WebGLRenderer-DWj51YUE.js","assets/CanvasRenderer-DkZdGmU3.js"])))=>i.map(i=>d[i]);
import{r as Bi,g as zi,l as me,e as J,E as Zs,u as Ks,q as M,ad as ae,af as fe,C as Y,ae as Js,D as Q,b8 as gr,U as Qs,n as ve,Q as Ze,W as eo,X as Ke,b9 as Je,I as Qt,ag as Fi,B as mr,b as Qe,a2 as le,T as q,M as be,ba as ot,c as ke,d as Ei,P as Bt,m as Li,O as Wi,J as Di,N as Ui,ai as $i,al as Vi,t as Gi,x as to,ac as ji,bb as Hi,R as Ni,bc as ro,bd as Xi,be as er,a9 as tr,j as dn,F as rr,w as hn,bf as et,bg as Dn,bh as Un,bi as Yi,$ as qi,a0 as no,a8 as Ct,bj as so,bk as U,bl as $n,aJ as O,an as lr,bm as pn,bn as Vr,au as Se,as as Ie,bo as Zi,bp as Ki,bq as fn,at as Oe,br as Ji,aD as Qi,av as ut,bs as se,bt as ce,aw as ea,aG as It,aH as Be,aM as ta,b5 as jt,ay as Gr,b3 as gn,bu as Ne,bv as jr,i as Te,aL as mn,aV as Vn,aU as ra,bw as zt,bx as oo,ar as cr,by as xn,aN as yn,bz as io,bA as Mt,bB as na,bC as sa,bD as oa,bE as ct,bF as Tt,aC as Xe,bG as ia,bH as aa,bI as la,bJ as Gn,bK as _t,bL as ca,ab as Ye,bM as xr,bN as yr,ao,aX as lo,bO as ua,aZ as da,bP as wn,bQ as ha,b0 as He,aF as vn,bR as vt,bS as co,bT as Ft,bU as pa,bV as fa,G as Ce,b1 as ga,bW as ma,aq as Ht,bX as jn,bY as xa,bZ as ya,b_ as wa,b$ as va,c0 as ba}from"./index-BrJohlus.js";import{G as Sa,p as Ca,a as bn,b as Sn,c as Cn,d as Ta,e as _a,f as ka,u as Ia,i as Re,g as Ma,h as Pa,j,o as Ra,s as uo,k as ho,l as po,m as Tn,n as Nt,q as Aa,w as fo,r as Oa,t as Ba,v as Hr,x as Hn,y as za,z as go,A as mo,B as Fa,C as Ea,D as wr,E as xo,F as La,H as Wa,I as Da,J as Ua,K as $a,L as Et,M as vr,N as wt,O as Va,P as yo,Q as Nr,R as Ga,S as Xr,T as wo,U as ja,V as Ha,W as _n,X as vo,Y as Na,Z as Xt,_ as Xa,$ as Ya,a0 as qe,a1 as kn,a2 as ur,a3 as L,a4 as qa,a5 as Za,a6 as Ka,a7 as Ja,a8 as Nn,a9 as Qa,aa as Xn,ab as el,ac as tl,ad as Yn,ae as rl,af as nl,ag as sl,ah as ol,ai as bo,aj as il,ak as al,al as In}from"./levelEditorSlice-DV1_qcla.js";import{o as Yr}from"./RoomJson-B7DN8xX4.js";import{s as S,a as ll,i as cl,g as ul,u as dl,B as br,T as qn,t as ne,b as hl,r as Z,c as dr,d as pl,e as So,f as Co,h as Mn}from"./LevelEditor-dgNeyyT-.js";import{h as Le,s as fl}from"./halfBrite-bBKz2fn-.js";var Lt={},Zn;function gl(){if(Zn)return Lt;Zn=1;const{ensureIterable:n}=Bi();function e(r){const s=n(r);let o=0;for(const i of s)o++;return o}Lt.__size=e;const t=e;return Lt.size=t,Lt}var Sr,Kn;function ml(){return Kn||(Kn=1,Sr=gl().size),Sr}var xl=ml();const To=zi(xl),qr=[];me.handleByNamedList(J.Environment,qr);async function yl(n){if(!n)for(let e=0;e<qr.length;e++){const t=qr[e];if(t.value.test()){await t.value.load();return}}}let pt;function wl(){if(typeof pt=="boolean")return pt;try{pt=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{pt=!1}return pt}var _o=(n=>(n[n.NONE=0]="NONE",n[n.COLOR=16384]="COLOR",n[n.STENCIL=1024]="STENCIL",n[n.DEPTH=256]="DEPTH",n[n.COLOR_DEPTH=16640]="COLOR_DEPTH",n[n.COLOR_STENCIL=17408]="COLOR_STENCIL",n[n.DEPTH_STENCIL=1280]="DEPTH_STENCIL",n[n.ALL=17664]="ALL",n))(_o||{});class vl{constructor(e){this.items=[],this._name=e}emit(e,t,r,s,o,i,a,l){const{name:c,items:u}=this;for(let d=0,h=u.length;d<h;d++)u[d][c](e,t,r,s,o,i,a,l);return this}add(e){return e[this._name]&&(this.remove(e),this.items.push(e)),this}remove(e){const t=this.items.indexOf(e);return t!==-1&&this.items.splice(t,1),this}contains(e){return this.items.indexOf(e)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const bl=["init","destroy","contextChange","resolutionChange","resetState","renderEnd","renderStart","render","update","postrender","prerender"],ko=class Io extends Zs{constructor(e){super(),this.tick=0,this.uid=Ks("renderer"),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=e.type,this.name=e.name,this.config=e;const t=[...bl,...this.config.runners??[]];this._addRunners(...t),this._unsafeEvalCheck()}async init(e={}){const t=e.skipExtensionImports===!0?!0:e.manageImports===!1;await yl(t),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const r in this._systemsHash)e={...this._systemsHash[r].constructor.defaultOptions,...e};e={...Io.defaultOptions,...e},this._roundPixels=e.roundPixels?1:0;for(let r=0;r<this.runners.init.items.length;r++)await this.runners.init.items[r].init(e);this._initOptions=e}render(e,t){this.tick++;let r=e;if(r instanceof M&&(r={container:r},t&&(ae(fe,"passing a second argument is deprecated, please use render options instead"),r.target=t.renderTexture)),r.target||(r.target=this.view.renderTarget),r.target===this.view.renderTarget&&(this._lastObjectRendered=r.container,r.clearColor??(r.clearColor=this.background.colorRgba),r.clear??(r.clear=this.background.clearBeforeRender)),r.clearColor){const s=Array.isArray(r.clearColor)&&r.clearColor.length===4;r.clearColor=s?r.clearColor:Y.shared.setValue(r.clearColor).toArray()}r.transform||(r.container.updateLocalTransform(),r.transform=r.container.localTransform),r.container.visible&&(r.container.enableRenderGroup(),this.runners.prerender.emit(r),this.runners.renderStart.emit(r),this.runners.render.emit(r),this.runners.renderEnd.emit(r),this.runners.postrender.emit(r))}resize(e,t,r){const s=this.view.resolution;this.view.resize(e,t,r),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),r!==void 0&&r!==s&&this.runners.resolutionChange.emit(r)}clear(e={}){const t=this;e.target||(e.target=t.renderTarget.renderTarget),e.clearColor||(e.clearColor=this.background.colorRgba),e.clear??(e.clear=_o.ALL);const{clear:r,clearColor:s,target:o,mipLevel:i,layer:a}=e;Y.shared.setValue(s??this.background.colorRgba),t.renderTarget.clear(o,r,Y.shared.toArray(),i??0,a??0)}get resolution(){return this.view.resolution}set resolution(e){this.view.resolution=e,this.runners.resolutionChange.emit(e)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...e){e.forEach(t=>{this.runners[t]=new vl(t)})}_addSystems(e){let t;for(t in e){const r=e[t];this._addSystem(r.value,r.name)}}_addSystem(e,t){const r=new e(this);if(this[t])throw new Error(`Whoops! The name "${t}" is already in use`);this[t]=r,this._systemsHash[t]=r;for(const s in this.runners)this.runners[s].add(r);return this}_addPipes(e,t){const r=t.reduce((s,o)=>(s[o.name]=o.value,s),{});e.forEach(s=>{const o=s.value,i=s.name,a=r[i];this.renderPipes[i]=new o(this,a?new a:null),this.runners.destroy.add(this.renderPipes[i])})}destroy(e=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(e),(e===!0||typeof e=="object"&&e.releaseGlobalResources)&&Js.release(),Object.values(this.runners).forEach(t=>{t.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(e){return this.textureGenerator.generateTexture(e)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!wl())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}resetState(){this.runners.resetState.emit()}};ko.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let Mo=ko,Wt;function Sl(n){return Wt!==void 0||(Wt=(()=>{const e={stencil:!0,failIfMajorPerformanceCaveat:n??Mo.defaultOptions.failIfMajorPerformanceCaveat};try{if(!Q.get().getWebGLRenderingContext())return!1;let r=Q.get().createCanvas().getContext("webgl",e);const s=!!r?.getContextAttributes()?.stencil;if(r){const o=r.getExtension("WEBGL_lose_context");o&&o.loseContext()}return r=null,s}catch{return!1}})()),Wt}let Dt;async function Cl(n={}){return Dt!==void 0||(Dt=await(async()=>{const e=Q.get().getNavigator().gpu;if(!e)return!1;try{return await(await e.requestAdapter(n)).requestDevice(),!0}catch{return!1}})()),Dt}const Jn=["webgl","webgpu","canvas"];async function Tl(n){let e=[];n.preference?(e.push(n.preference),Jn.forEach(o=>{o!==n.preference&&e.push(o)})):e=Jn.slice();let t,r={};for(let o=0;o<e.length;o++){const i=e[o];if(i==="webgpu"&&await Cl()){const{WebGPURenderer:a}=await gr(async()=>{const{WebGPURenderer:l}=await import("./WebGPURenderer-C_7-IE0G.js");return{WebGPURenderer:l}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));t=a,r={...n,...n.webgpu};break}else if(i==="webgl"&&Sl(n.failIfMajorPerformanceCaveat??Mo.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:a}=await gr(async()=>{const{WebGLRenderer:l}=await import("./WebGLRenderer-DWj51YUE.js");return{WebGLRenderer:l}},__vite__mapDeps([9,1,2,3,4,5,6,7,8]));t=a,r={...n,...n.webgl};break}else if(i==="canvas"){const{CanvasRenderer:a}=await gr(async()=>{const{CanvasRenderer:l}=await import("./CanvasRenderer-DkZdGmU3.js");return{CanvasRenderer:l}},__vite__mapDeps([10,1,2,4,5,6,7,8]));t=a,r={...n,...n.canvasOptions};break}}if(delete r.webgpu,delete r.webgl,delete r.canvasOptions,!t)throw new Error("No available renderer for the current environment");const s=new t;return await s.init(r),s}const Po="8.16.0";class Ro{static init(){globalThis.__PIXI_APP_INIT__?.(this,Po)}static destroy(){}}Ro.extension=J.Application;class _l{constructor(e){this._renderer=e}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,Po)}destroy(){this._renderer=null}}_l.extension={type:[J.WebGLSystem,J.WebGPUSystem],name:"initHook",priority:-10};class Ao{static init(e){Object.defineProperty(this,"resizeTo",{configurable:!0,set(t){globalThis.removeEventListener("resize",this.queueResize),this._resizeTo=t,t&&(globalThis.addEventListener("resize",this.queueResize),this.resize())},get(){return this._resizeTo}}),this.queueResize=()=>{this._resizeTo&&(this._cancelResize(),this._resizeId=requestAnimationFrame(()=>this.resize()))},this._cancelResize=()=>{this._resizeId&&(cancelAnimationFrame(this._resizeId),this._resizeId=null)},this.resize=()=>{if(!this._resizeTo)return;this._cancelResize();let t,r;if(this._resizeTo===globalThis.window)t=globalThis.innerWidth,r=globalThis.innerHeight;else{const{clientWidth:s,clientHeight:o}=this._resizeTo;t=s,r=o}this.renderer.resize(t,r),this.render()},this._resizeId=null,this._resizeTo=null,this.resizeTo=e.resizeTo||null}static destroy(){globalThis.removeEventListener("resize",this.queueResize),this._cancelResize(),this._cancelResize=null,this.queueResize=null,this.resizeTo=null,this.resize=null}}Ao.extension=J.Application;class Oo{static init(e){e=Object.assign({autoStart:!0,sharedTicker:!1},e),Object.defineProperty(this,"ticker",{configurable:!0,set(t){this._ticker&&this._ticker.remove(this.render,this),this._ticker=t,t&&t.add(this.render,this,Qs.LOW)},get(){return this._ticker}}),this.stop=()=>{this._ticker.stop()},this.start=()=>{this._ticker.start()},this._ticker=null,this.ticker=e.sharedTicker?ve.shared:new ve,e.autoStart&&this.start()}static destroy(){if(this._ticker){const e=this._ticker;this.ticker=null,e.destroy()}}}Oo.extension=J.Application;me.add(Ao);me.add(Oo);const Bo=class Zr{constructor(...e){this.stage=new M,e[0]!==void 0&&ae(fe,"Application constructor options are deprecated, please use Application.init() instead.")}async init(e){e={...e},this.stage||(this.stage=new M),this.renderer=await Tl(e),Zr._plugins.forEach(t=>{t.init.call(this,e)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return ae(fe,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(e=!1,t=!1){const r=Zr._plugins.slice(0);r.reverse(),r.forEach(s=>{s.destroy.call(this)}),this.stage.destroy(t),this.stage=null,this.renderer.destroy(e),this.renderer=null}};Bo._plugins=[];let zo=Bo;me.handleByList(J.Application,zo._plugins);me.add(Ro);var kl=`
in vec2 vTextureCoord;

out vec4 finalColor;

uniform float uAlpha;
uniform sampler2D uTexture;

void main()
{
    finalColor =  texture(uTexture, vTextureCoord) * uAlpha;
}
`,Qn=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct AlphaUniforms {
  uAlpha:f32,
};

@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;

@group(1) @binding(0) var<uniform> alphaUniforms : AlphaUniforms;

struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>
  };

fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

fn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  
}

fn getSize() -> vec2<f32>
{
  return gfu.uGlobalFrame.zw;
}
  
@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition)
  );
}

@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
  @builtin(position) position: vec4<f32>
) -> @location(0) vec4<f32> {
 
    var sample = textureSample(uTexture, uSampler, uv);
    
    return sample * alphaUniforms.uAlpha;
}`;const Fo=class Eo extends Ze{constructor(e){e={...Eo.defaultOptions,...e};const t=eo.from({vertex:{source:Qn,entryPoint:"mainVertex"},fragment:{source:Qn,entryPoint:"mainFragment"}}),r=Ke.from({vertex:Je,fragment:kl,name:"alpha-filter"}),{alpha:s,...o}=e,i=new Qt({uAlpha:{value:s,type:"f32"}});super({...o,gpuProgram:t,glProgram:r,resources:{alphaUniforms:i}})}get alpha(){return this.resources.alphaUniforms.uniforms.uAlpha}set alpha(e){this.resources.alphaUniforms.uniforms.uAlpha=e}};Fo.defaultOptions={alpha:1};let Il=Fo;var Ml=`
in vec2 vTextureCoord;
in vec4 vColor;

out vec4 finalColor;

uniform float uColorMatrix[20];
uniform float uAlpha;

uniform sampler2D uTexture;

float rand(vec2 co)
{
    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);
}

void main()
{
    vec4 color = texture(uTexture, vTextureCoord);
    float randomValue = rand(gl_FragCoord.xy * 0.2);
    float diff = (randomValue - 0.5) *  0.5;

    if (uAlpha == 0.0) {
        finalColor = color;
        return;
    }

    if (color.a > 0.0) {
        color.rgb /= color.a;
    }

    vec4 result;

    result.r = (uColorMatrix[0] * color.r);
        result.r += (uColorMatrix[1] * color.g);
        result.r += (uColorMatrix[2] * color.b);
        result.r += (uColorMatrix[3] * color.a);
        result.r += uColorMatrix[4];

    result.g = (uColorMatrix[5] * color.r);
        result.g += (uColorMatrix[6] * color.g);
        result.g += (uColorMatrix[7] * color.b);
        result.g += (uColorMatrix[8] * color.a);
        result.g += uColorMatrix[9];

    result.b = (uColorMatrix[10] * color.r);
       result.b += (uColorMatrix[11] * color.g);
       result.b += (uColorMatrix[12] * color.b);
       result.b += (uColorMatrix[13] * color.a);
       result.b += uColorMatrix[14];

    result.a = (uColorMatrix[15] * color.r);
       result.a += (uColorMatrix[16] * color.g);
       result.a += (uColorMatrix[17] * color.b);
       result.a += (uColorMatrix[18] * color.a);
       result.a += uColorMatrix[19];

    vec3 rgb = mix(color.rgb, result.rgb, uAlpha);

    // Premultiply alpha again.
    rgb *= result.a;

    finalColor = vec4(rgb, result.a);
}
`,es=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct ColorMatrixUniforms {
  uColorMatrix:array<vec4<f32>, 5>,
  uAlpha:f32,
};


@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;
@group(1) @binding(0) var<uniform> colorMatrixUniforms : ColorMatrixUniforms;


struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>,
  };
  
fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition),
  );
}


@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
) -> @location(0) vec4<f32> {


  var c = textureSample(uTexture, uSampler, uv);
  
  if (colorMatrixUniforms.uAlpha == 0.0) {
    return c;
  }

 
    // Un-premultiply alpha before applying the color matrix. See issue #3539.
    if (c.a > 0.0) {
      c.r /= c.a;
      c.g /= c.a;
      c.b /= c.a;
    }

    var cm = colorMatrixUniforms.uColorMatrix;


    var result = vec4<f32>(0.);

    result.r = (cm[0][0] * c.r);
    result.r += (cm[0][1] * c.g);
    result.r += (cm[0][2] * c.b);
    result.r += (cm[0][3] * c.a);
    result.r += cm[1][0];

    result.g = (cm[1][1] * c.r);
    result.g += (cm[1][2] * c.g);
    result.g += (cm[1][3] * c.b);
    result.g += (cm[2][0] * c.a);
    result.g += cm[2][1];

    result.b = (cm[2][2] * c.r);
    result.b += (cm[2][3] * c.g);
    result.b += (cm[3][0] * c.b);
    result.b += (cm[3][1] * c.a);
    result.b += cm[3][2];

    result.a = (cm[3][3] * c.r);
    result.a += (cm[4][0] * c.g);
    result.a += (cm[4][1] * c.b);
    result.a += (cm[4][2] * c.a);
    result.a += cm[4][3];

    var rgb = mix(c.rgb, result.rgb, colorMatrixUniforms.uAlpha);

    rgb.r *= result.a;
    rgb.g *= result.a;
    rgb.b *= result.a;

    return vec4(rgb, result.a);
}`;class Pl extends Ze{constructor(e={}){const t=new Qt({uColorMatrix:{value:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],type:"f32",size:20},uAlpha:{value:1,type:"f32"}}),r=eo.from({vertex:{source:es,entryPoint:"mainVertex"},fragment:{source:es,entryPoint:"mainFragment"}}),s=Ke.from({vertex:Je,fragment:Ml,name:"color-matrix-filter"});super({...e,gpuProgram:r,glProgram:s,resources:{colorMatrixUniforms:t}}),this.alpha=1}_loadMatrix(e,t=!1){let r=e;t&&(this._multiply(r,this.matrix,e),r=this._colorMatrix(r)),this.resources.colorMatrixUniforms.uniforms.uColorMatrix=r,this.resources.colorMatrixUniforms.update()}_multiply(e,t,r){return e[0]=t[0]*r[0]+t[1]*r[5]+t[2]*r[10]+t[3]*r[15],e[1]=t[0]*r[1]+t[1]*r[6]+t[2]*r[11]+t[3]*r[16],e[2]=t[0]*r[2]+t[1]*r[7]+t[2]*r[12]+t[3]*r[17],e[3]=t[0]*r[3]+t[1]*r[8]+t[2]*r[13]+t[3]*r[18],e[4]=t[0]*r[4]+t[1]*r[9]+t[2]*r[14]+t[3]*r[19]+t[4],e[5]=t[5]*r[0]+t[6]*r[5]+t[7]*r[10]+t[8]*r[15],e[6]=t[5]*r[1]+t[6]*r[6]+t[7]*r[11]+t[8]*r[16],e[7]=t[5]*r[2]+t[6]*r[7]+t[7]*r[12]+t[8]*r[17],e[8]=t[5]*r[3]+t[6]*r[8]+t[7]*r[13]+t[8]*r[18],e[9]=t[5]*r[4]+t[6]*r[9]+t[7]*r[14]+t[8]*r[19]+t[9],e[10]=t[10]*r[0]+t[11]*r[5]+t[12]*r[10]+t[13]*r[15],e[11]=t[10]*r[1]+t[11]*r[6]+t[12]*r[11]+t[13]*r[16],e[12]=t[10]*r[2]+t[11]*r[7]+t[12]*r[12]+t[13]*r[17],e[13]=t[10]*r[3]+t[11]*r[8]+t[12]*r[13]+t[13]*r[18],e[14]=t[10]*r[4]+t[11]*r[9]+t[12]*r[14]+t[13]*r[19]+t[14],e[15]=t[15]*r[0]+t[16]*r[5]+t[17]*r[10]+t[18]*r[15],e[16]=t[15]*r[1]+t[16]*r[6]+t[17]*r[11]+t[18]*r[16],e[17]=t[15]*r[2]+t[16]*r[7]+t[17]*r[12]+t[18]*r[17],e[18]=t[15]*r[3]+t[16]*r[8]+t[17]*r[13]+t[18]*r[18],e[19]=t[15]*r[4]+t[16]*r[9]+t[17]*r[14]+t[18]*r[19]+t[19],e}_colorMatrix(e){const t=new Float32Array(e);return t[4]/=255,t[9]/=255,t[14]/=255,t[19]/=255,t}brightness(e,t){const r=[e,0,0,0,0,0,e,0,0,0,0,0,e,0,0,0,0,0,1,0];this._loadMatrix(r,t)}tint(e,t){const[r,s,o]=Y.shared.setValue(e).toArray(),i=[r,0,0,0,0,0,s,0,0,0,0,0,o,0,0,0,0,0,1,0];this._loadMatrix(i,t)}greyscale(e,t){const r=[e,e,e,0,0,e,e,e,0,0,e,e,e,0,0,0,0,0,1,0];this._loadMatrix(r,t)}grayscale(e,t){this.greyscale(e,t)}blackAndWhite(e){const t=[.3,.6,.1,0,0,.3,.6,.1,0,0,.3,.6,.1,0,0,0,0,0,1,0];this._loadMatrix(t,e)}hue(e,t){e=(e||0)/180*Math.PI;const r=Math.cos(e),s=Math.sin(e),o=Math.sqrt,i=1/3,a=o(i),l=r+(1-r)*i,c=i*(1-r)-a*s,u=i*(1-r)+a*s,d=i*(1-r)+a*s,h=r+i*(1-r),p=i*(1-r)-a*s,f=i*(1-r)-a*s,m=i*(1-r)+a*s,g=r+i*(1-r),x=[l,c,u,0,0,d,h,p,0,0,f,m,g,0,0,0,0,0,1,0];this._loadMatrix(x,t)}contrast(e,t){const r=(e||0)+1,s=-.5*(r-1),o=[r,0,0,0,s,0,r,0,0,s,0,0,r,0,s,0,0,0,1,0];this._loadMatrix(o,t)}saturate(e=0,t){const r=e*2/3+1,s=(r-1)*-.5,o=[r,s,s,0,0,s,r,s,0,0,s,s,r,0,0,0,0,0,1,0];this._loadMatrix(o,t)}desaturate(){this.saturate(-1)}negative(e){const t=[-1,0,0,1,0,0,-1,0,1,0,0,0,-1,1,0,0,0,0,1,0];this._loadMatrix(t,e)}sepia(e){const t=[.393,.7689999,.18899999,0,0,.349,.6859999,.16799999,0,0,.272,.5339999,.13099999,0,0,0,0,0,1,0];this._loadMatrix(t,e)}technicolor(e){const t=[1.9125277891456083,-.8545344976951645,-.09155508482755585,0,11.793603434377337,-.3087833385928097,1.7658908555458428,-.10601743074722245,0,-70.35205161461398,-.231103377548616,-.7501899197440212,1.847597816108189,0,30.950940869491138,0,0,0,1,0];this._loadMatrix(t,e)}polaroid(e){const t=[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0];this._loadMatrix(t,e)}toBGR(e){const t=[0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0];this._loadMatrix(t,e)}kodachrome(e){const t=[1.1285582396593525,-.3967382283601348,-.03992559172921793,0,63.72958762196502,-.16404339962244616,1.0835251566291304,-.05498805115633132,0,24.732407896706203,-.16786010706155763,-.5603416277695248,1.6014850761964943,0,35.62982807460946,0,0,0,1,0];this._loadMatrix(t,e)}browni(e){const t=[.5997023498159715,.34553243048391263,-.2708298674538042,0,47.43192855600873,-.037703249837783157,.8609577587992641,.15059552388459913,0,-36.96841498319127,.24113635128153335,-.07441037908422492,.44972182064877153,0,-7.562075277591283,0,0,0,1,0];this._loadMatrix(t,e)}vintage(e){const t=[.6279345635605994,.3202183420819367,-.03965408211312453,0,9.651285835294123,.02578397704808868,.6441188644374771,.03259127616149294,0,7.462829176470591,.0466055556782719,-.0851232987247891,.5241648018700465,0,5.159190588235296,0,0,0,1,0];this._loadMatrix(t,e)}colorTone(e,t,r,s,o){e||(e=.2),t||(t=.15),r||(r=16770432),s||(s=3375104);const i=Y.shared,[a,l,c]=i.setValue(r).toArray(),[u,d,h]=i.setValue(s).toArray(),p=[.3,.59,.11,0,0,a,l,c,e,0,u,d,h,t,0,a-u,l-d,c-h,0,0];this._loadMatrix(p,o)}night(e,t){e||(e=.1);const r=[e*-2,-e,0,0,0,-e,0,e,0,0,0,e,e*2,0,0,0,0,0,1,0];this._loadMatrix(r,t)}predator(e,t){const r=[11.224130630493164*e,-4.794486999511719*e,-2.8746118545532227*e,0*e,.40342438220977783*e,-3.6330697536468506*e,9.193157196044922*e,-2.951810836791992*e,0*e,-1.316135048866272*e,-3.2184197902679443*e,-4.2375030517578125*e,7.476448059082031*e,0*e,.8044459223747253*e,0,0,0,1,0];this._loadMatrix(r,t)}lsd(e){const t=[2,-.4,.5,0,0,-.5,2,-.4,0,0,-.4,-.5,3,0,0,0,0,0,1,0];this._loadMatrix(t,e)}reset(){const e=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0];this._loadMatrix(e,!1)}get matrix(){return this.resources.colorMatrixUniforms.uniforms.uColorMatrix}set matrix(e){this.resources.colorMatrixUniforms.uniforms.uColorMatrix=e}get alpha(){return this.resources.colorMatrixUniforms.uniforms.uAlpha}set alpha(e){this.resources.colorMatrixUniforms.uniforms.uAlpha=e}}const Lo=class Wo extends Fi{constructor(...e){let t=e[0]??{};t instanceof Float32Array&&(ae(fe,"use new MeshGeometry({ positions, uvs, indices }) instead"),t={positions:t,uvs:e[1],indices:e[2]}),t={...Wo.defaultOptions,...t};const r=t.positions||new Float32Array([0,0,1,0,1,1,0,1]);let s=t.uvs;s||(t.positions?s=new Float32Array(r.length):s=new Float32Array([0,0,1,0,1,1,0,1]));const o=t.indices||new Uint32Array([0,1,2,0,2,3]),i=t.shrinkBuffersToFit,a=new mr({data:r,label:"attribute-mesh-positions",shrinkToFit:i,usage:Qe.VERTEX|Qe.COPY_DST}),l=new mr({data:s,label:"attribute-mesh-uvs",shrinkToFit:i,usage:Qe.VERTEX|Qe.COPY_DST}),c=new mr({data:o,label:"index-mesh-buffer",shrinkToFit:i,usage:Qe.INDEX|Qe.COPY_DST});super({attributes:{aPosition:{buffer:a,format:"float32x2",stride:8,offset:0},aUV:{buffer:l,format:"float32x2",stride:8,offset:0}},indexBuffer:c,topology:t.topology}),this.batchMode="auto"}get positions(){return this.attributes.aPosition.buffer.data}set positions(e){this.attributes.aPosition.buffer.data=e}get uvs(){return this.attributes.aUV.buffer.data}set uvs(e){this.attributes.aUV.buffer.data=e}get indices(){return this.indexBuffer.data}set indices(e){this.indexBuffer.data=e}};Lo.defaultOptions={topology:"triangle-list",shrinkBuffersToFit:!1};let Do=Lo;class Rl{constructor(){this.batcherName="default",this.packAsQuad=!1,this.indexOffset=0,this.attributeOffset=0,this.roundPixels=0,this._batcher=null,this._batch=null,this._textureMatrixUpdateId=-1,this._uvUpdateId=-1}get blendMode(){return this.renderable.groupBlendMode}get topology(){return this._topology||this.geometry.topology}set topology(e){this._topology=e}reset(){this.renderable=null,this.texture=null,this._batcher=null,this._batch=null,this.geometry=null,this._uvUpdateId=-1,this._textureMatrixUpdateId=-1}setTexture(e){this.texture!==e&&(this.texture=e,this._textureMatrixUpdateId=-1)}get uvs(){const t=this.geometry.getBuffer("aUV"),r=t.data;let s=r;const o=this.texture.textureMatrix;return o.isSimple||(s=this._transformedUvs,(this._textureMatrixUpdateId!==o._updateID||this._uvUpdateId!==t._updateID)&&((!s||s.length<r.length)&&(s=this._transformedUvs=new Float32Array(r.length)),this._textureMatrixUpdateId=o._updateID,this._uvUpdateId=t._updateID,o.multiplyUvs(r,s))),s}get positions(){return this.geometry.positions}get indices(){return this.geometry.indices}get color(){return this.renderable.groupColorAlpha}get groupTransform(){return this.renderable.groupTransform}get attributeSize(){return this.geometry.positions.length/2}get indexSize(){return this.geometry.indices.length}}class ge extends le{constructor(...e){let t=e[0];Array.isArray(e[0])&&(t={textures:e[0],autoUpdate:e[1]});const{animationSpeed:r=1,autoPlay:s=!1,autoUpdate:o=!0,loop:i=!0,onComplete:a=null,onFrameChange:l=null,onLoop:c=null,textures:u,updateAnchor:d=!1,...h}=t,[p]=u;super({...h,texture:p instanceof q?p:p.texture}),this._textures=null,this._durations=null,this._autoUpdate=o,this._isConnectedToTicker=!1,this.animationSpeed=r,this.loop=i,this.updateAnchor=d,this.onComplete=a,this.onFrameChange=l,this.onLoop=c,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=u,s&&this.play()}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(ve.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(ve.shared.add(this.update,this,Qs.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(e){this.stop(),this.currentFrame=e}gotoAndPlay(e){this.currentFrame=e,this.play()}update(e){if(!this._playing)return;const t=e.deltaTime,r=this.animationSpeed*t,s=this.currentFrame;if(this._durations!==null){let o=this._currentTime%1*this._durations[this.currentFrame];for(o+=r/60*1e3;o<0;)this._currentTime--,o+=this._durations[this.currentFrame];const i=Math.sign(this.animationSpeed*t);for(this._currentTime=Math.floor(this._currentTime);o>=this._durations[this.currentFrame];)o-=this._durations[this.currentFrame]*i,this._currentTime+=i;this._currentTime+=o/this._durations[this.currentFrame]}else this._currentTime+=r;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):s!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<s||this.animationSpeed<0&&this.currentFrame>s)&&this.onLoop(),this._updateTexture())}_updateTexture(){const e=this.currentFrame;this._previousFrame!==e&&(this._previousFrame=e,this.texture=this._textures[e],this.updateAnchor&&this.texture.defaultAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(e=!1){if(typeof e=="boolean"?e:e?.texture){const r=typeof e=="boolean"?e:e?.textureSource;this._textures.forEach(s=>{this.texture!==s&&s.destroy(r)})}this._textures=[],this._durations=null,this.stop(),super.destroy(e),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(e){const t=[];for(let r=0;r<e.length;++r)t.push(q.from(e[r]));return new ge(t)}static fromImages(e){const t=[];for(let r=0;r<e.length;++r)t.push(q.from(e[r]));return new ge(t)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(e){if(e[0]instanceof q)this._textures=e,this._durations=null;else{this._textures=[],this._durations=[];for(let t=0;t<e.length;t++)this._textures.push(e[t].texture),this._durations.push(e[t].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let e=Math.floor(this._currentTime)%this._textures.length;return e<0&&(e+=this._textures.length),e}set currentFrame(e){if(e<0||e>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${e}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const t=this.currentFrame;this._currentTime=e,t!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,!this._autoUpdate&&this._isConnectedToTicker?(ve.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(ve.shared.add(this.update,this),this._isConnectedToTicker=!0))}}class Al{constructor({matrix:e,observer:t}={}){this.dirty=!0,this._matrix=e??new be,this.observer=t,this.position=new ot(this,0,0),this.scale=new ot(this,1,1),this.pivot=new ot(this,0,0),this.skew=new ot(this,0,0),this._rotation=0,this._cx=1,this._sx=0,this._cy=0,this._sy=1}get matrix(){const e=this._matrix;return this.dirty&&(e.a=this._cx*this.scale.x,e.b=this._sx*this.scale.x,e.c=this._cy*this.scale.y,e.d=this._sy*this.scale.y,e.tx=this.position.x-(this.pivot.x*e.a+this.pivot.y*e.c),e.ty=this.position.y-(this.pivot.x*e.b+this.pivot.y*e.d),this.dirty=!1),e}_onUpdate(e){this.dirty=!0,e===this.skew&&this.updateSkew(),this.observer?._onUpdate(this)}updateSkew(){this._cx=Math.cos(this._rotation+this.skew.y),this._sx=Math.sin(this._rotation+this.skew.y),this._cy=-Math.sin(this._rotation-this.skew.x),this._sy=Math.cos(this._rotation-this.skew.x),this.dirty=!0}toString(){return`[pixi.js/math:Transform position=(${this.position.x}, ${this.position.y}) rotation=${this.rotation} scale=(${this.scale.x}, ${this.scale.y}) skew=(${this.skew.x}, ${this.skew.y}) ]`}setFromMatrix(e){e.decompose(this),this.dirty=!0}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._onUpdate(this.skew))}}let tt;function ts(n){const e=Q.get().createCanvas(6,1),t=e.getContext("2d");return t.fillStyle=n,t.fillRect(0,0,6,1),e}function Ol(){if(tt!==void 0)return tt;try{const n=ts("#ff00ff"),e=ts("#ffff00"),r=Q.get().createCanvas(6,1).getContext("2d");r.globalCompositeOperation="multiply",r.drawImage(n,0,0),r.drawImage(e,2,0);const s=r.getImageData(2,0,1,1);if(!s)tt=!1;else{const o=s.data;tt=o[0]===255&&o[1]===0&&o[2]===0}}catch{tt=!1}return tt}const G={canvas:null,convertTintToImage:!1,cacheStepsPerColorChannel:8,canUseMultiply:Ol(),tintMethod:null,_canvasSourceCache:new WeakMap,_unpremultipliedCache:new WeakMap,getCanvasSource:n=>{const e=n.source,t=e?.resource;if(!t)return null;const r=e.alphaMode==="premultiplied-alpha",s=e.resourceWidth??e.pixelWidth,o=e.resourceHeight??e.pixelHeight,i=s!==e.pixelWidth||o!==e.pixelHeight;if(r){if((t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas)&&!i)return t;const a=G._unpremultipliedCache.get(e);if(a?.resourceId===e._resourceId)return a.canvas}if(t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||t instanceof Uint16Array||t instanceof Int16Array||t instanceof Uint32Array||t instanceof Int32Array||t instanceof Float32Array||t instanceof ArrayBuffer){const a=G._canvasSourceCache.get(e);if(a?.resourceId===e._resourceId)return a.canvas;const l=Q.get().createCanvas(e.pixelWidth,e.pixelHeight),c=l.getContext("2d"),u=c.createImageData(e.pixelWidth,e.pixelHeight),d=u.data,h=t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength);if(e.format==="bgra8unorm")for(let p=0;p<d.length&&p+3<h.length;p+=4)d[p]=h[p+2],d[p+1]=h[p+1],d[p+2]=h[p],d[p+3]=h[p+3];else d.set(h.subarray(0,d.length));return c.putImageData(u,0,0),G._canvasSourceCache.set(e,{canvas:l,resourceId:e._resourceId}),l}if(r){const a=Q.get().createCanvas(e.pixelWidth,e.pixelHeight),l=a.getContext("2d",{willReadFrequently:!0});a.width=e.pixelWidth,a.height=e.pixelHeight,l.drawImage(t,0,0);const c=l.getImageData(0,0,a.width,a.height),u=c.data;for(let d=0;d<u.length;d+=4){const h=u[d+3];if(h>0){const p=255/h;u[d]=Math.min(255,u[d]*p+.5),u[d+1]=Math.min(255,u[d+1]*p+.5),u[d+2]=Math.min(255,u[d+2]*p+.5)}}return l.putImageData(c,0,0),G._unpremultipliedCache.set(e,{canvas:a,resourceId:e._resourceId}),a}if(i){const a=G._canvasSourceCache.get(e);if(a?.resourceId===e._resourceId)return a.canvas;const l=Q.get().createCanvas(e.pixelWidth,e.pixelHeight),c=l.getContext("2d");return l.width=e.pixelWidth,l.height=e.pixelHeight,c.drawImage(t,0,0),G._canvasSourceCache.set(e,{canvas:l,resourceId:e._resourceId}),l}return t},getTintedCanvas:(n,e)=>{const t=n.texture,r=Y.shared.setValue(e).toHex(),s=t.tintCache||(t.tintCache={}),o=s[r],i=t.source._resourceId;if(o?.tintId===i)return o;const a=o&&"getContext"in o?o:Q.get().createCanvas();return G.tintMethod(t,e,a),a.tintId=i,s[r]=a,s[r]},getTintedPattern:(n,e)=>{const t=Y.shared.setValue(e).toHex(),r=n.patternCache||(n.patternCache={}),s=n.source._resourceId;let o=r[t];return o?.tintId===s||(G.canvas||(G.canvas=Q.get().createCanvas()),G.tintMethod(n,e,G.canvas),o=G.canvas.getContext("2d").createPattern(G.canvas,"repeat"),o.tintId=s,r[t]=o),o},applyPatternTransform:(n,e,t=!0)=>{if(!e)return;const r=n;if(!r.setTransform)return;const s=globalThis.DOMMatrix;if(!s)return;const o=new s([e.a,e.b,e.c,e.d,e.tx,e.ty]);r.setTransform(t?o.inverse():o)},tintWithMultiply:(n,e,t)=>{const r=t.getContext("2d"),s=n.frame.clone(),o=n.source._resolution??n.source.resolution??1,i=n.rotate;s.x*=o,s.y*=o,s.width*=o,s.height*=o;const a=ke.isVertical(i),l=a?s.height:s.width,c=a?s.width:s.height;t.width=Math.ceil(l),t.height=Math.ceil(c),r.save(),r.fillStyle=Y.shared.setValue(e).toHex(),r.fillRect(0,0,l,c),r.globalCompositeOperation="multiply";const u=G.getCanvasSource(n);if(!u){r.restore();return}i&&G._applyInverseRotation(r,i,s.width,s.height),r.drawImage(u,s.x,s.y,s.width,s.height,0,0,s.width,s.height),r.globalCompositeOperation="destination-atop",r.drawImage(u,s.x,s.y,s.width,s.height,0,0,s.width,s.height),r.restore()},tintWithOverlay:(n,e,t)=>{const r=t.getContext("2d"),s=n.frame.clone(),o=n.source._resolution??n.source.resolution??1,i=n.rotate;s.x*=o,s.y*=o,s.width*=o,s.height*=o;const a=ke.isVertical(i),l=a?s.height:s.width,c=a?s.width:s.height;t.width=Math.ceil(l),t.height=Math.ceil(c),r.save(),r.globalCompositeOperation="copy",r.fillStyle=Y.shared.setValue(e).toHex(),r.fillRect(0,0,l,c),r.globalCompositeOperation="destination-atop";const u=G.getCanvasSource(n);if(!u){r.restore();return}i&&G._applyInverseRotation(r,i,s.width,s.height),r.drawImage(u,s.x,s.y,s.width,s.height,0,0,s.width,s.height),r.restore()},tintWithPerPixel:(n,e,t)=>{const r=t.getContext("2d"),s=n.frame.clone(),o=n.source._resolution??n.source.resolution??1,i=n.rotate;s.x*=o,s.y*=o,s.width*=o,s.height*=o;const a=ke.isVertical(i),l=a?s.height:s.width,c=a?s.width:s.height;t.width=Math.ceil(l),t.height=Math.ceil(c),r.save(),r.globalCompositeOperation="copy";const u=G.getCanvasSource(n);if(!u){r.restore();return}i&&G._applyInverseRotation(r,i,s.width,s.height),r.drawImage(u,s.x,s.y,s.width,s.height,0,0,s.width,s.height),r.restore();const d=e>>16&255,h=e>>8&255,p=e&255,f=r.getImageData(0,0,l,c),m=f.data;for(let g=0;g<m.length;g+=4)m[g]=m[g]*d/255,m[g+1]=m[g+1]*h/255,m[g+2]=m[g+2]*p/255;r.putImageData(f,0,0)},_applyInverseRotation:(n,e,t,r)=>{const s=ke.inv(e),o=ke.uX(s),i=ke.uY(s),a=ke.vX(s),l=ke.vY(s),c=-Math.min(0,o*t,a*r,o*t+a*r),u=-Math.min(0,i*t,l*r,i*t+l*r);n.transform(o,i,a,l,c,u)}};G.tintMethod=G.canUseMultiply?G.tintWithMultiply:G.tintWithPerPixel;const Ut=new be,ft=new be,he=[new Bt,new Bt,new Bt,new Bt];class Uo{constructor(e){this._renderer=e}validateRenderable(e){return!1}addRenderable(e,t){this._renderer.renderPipes.batch.break(t),t.add(e)}updateRenderable(e){}execute(e){const t=this._renderer,r=t.canvasContext,s=r.activeContext;s.save(),r.setBlendMode(e.groupBlendMode);const o=t.globalUniforms.globalUniformData?.worldColor??4294967295,i=e.groupColorAlpha,a=(o>>>24&255)/255,l=(i>>>24&255)/255,c=t.filter?.alphaMultiplier??1,u=a*l*c;if(u<=0){s.restore();return}s.globalAlpha=u;const d=o&16777215,h=i&16777215,p=Ei(Li(h,d)),f=e.texture,m=G.getTintedPattern(f,p),g=e.width,x=e.height,T=e.groupTransform,C=f.source._resolution??f.source.resolution??1;ft.copyFrom(e._tileTransform.matrix),e.applyAnchorToTexture||ft.translate(-e.anchor.x*g,-e.anchor.y*x),ft.scale(1/C,1/C),Ut.identity(),Ut.prepend(ft),Ut.prepend(T);const v=t._roundPixels|e._roundPixels;r.setContextTransform(Ut,v===1),s.fillStyle=m;const y=e.anchor.x*-g,b=e.anchor.y*-x;he[0].set(y,b),he[1].set(y+g,b),he[2].set(y+g,b+x),he[3].set(y,b+x);for(let w=0;w<4;w++)ft.applyInverse(he[w],he[w]);s.beginPath(),s.moveTo(he[0].x,he[0].y);for(let w=1;w<4;w++)s.lineTo(he[w].x,he[w].y);s.closePath(),s.fill(),s.restore()}destroy(){this._renderer=null}}Uo.extension={type:[J.CanvasPipes],name:"tilingSprite"};const Yt={name:"local-uniform-bit",vertex:{header:`

            struct LocalUniforms {
                uTransformMatrix:mat3x3<f32>,
                uColor:vec4<f32>,
                uRound:f32,
            }

            @group(1) @binding(0) var<uniform> localUniforms : LocalUniforms;
        `,main:`
            vColor *= localUniforms.uColor;
            modelMatrix *= localUniforms.uTransformMatrix;
        `,end:`
            if(localUniforms.uRound == 1)
            {
                vPosition = vec4(roundPixels(vPosition.xy, globalUniforms.uResolution), vPosition.zw);
            }
        `}},jp={...Yt,vertex:{...Yt.vertex,header:Yt.vertex.header.replace("group(1)","group(2)")}},Bl={name:"local-uniform-bit",vertex:{header:`

            uniform mat3 uTransformMatrix;
            uniform vec4 uColor;
            uniform float uRound;
        `,main:`
            vColor *= uColor;
            modelMatrix = uTransformMatrix;
        `,end:`
            if(uRound == 1.)
            {
                gl_Position.xy = roundPixels(gl_Position.xy, uResolution);
            }
        `}},zl={name:"tiling-bit",vertex:{header:`
            struct TilingUniforms {
                uMapCoord:mat3x3<f32>,
                uClampFrame:vec4<f32>,
                uClampOffset:vec2<f32>,
                uTextureTransform:mat3x3<f32>,
                uSizeAnchor:vec4<f32>
            };

            @group(2) @binding(0) var<uniform> tilingUniforms: TilingUniforms;
            @group(2) @binding(1) var uTexture: texture_2d<f32>;
            @group(2) @binding(2) var uSampler: sampler;
        `,main:`
            uv = (tilingUniforms.uTextureTransform * vec3(uv, 1.0)).xy;

            position = (position - tilingUniforms.uSizeAnchor.zw) * tilingUniforms.uSizeAnchor.xy;
        `},fragment:{header:`
            struct TilingUniforms {
                uMapCoord:mat3x3<f32>,
                uClampFrame:vec4<f32>,
                uClampOffset:vec2<f32>,
                uTextureTransform:mat3x3<f32>,
                uSizeAnchor:vec4<f32>
            };

            @group(2) @binding(0) var<uniform> tilingUniforms: TilingUniforms;
            @group(2) @binding(1) var uTexture: texture_2d<f32>;
            @group(2) @binding(2) var uSampler: sampler;
        `,main:`

            var coord = vUV + ceil(tilingUniforms.uClampOffset - vUV);
            coord = (tilingUniforms.uMapCoord * vec3(coord, 1.0)).xy;
            var unclamped = coord;
            coord = clamp(coord, tilingUniforms.uClampFrame.xy, tilingUniforms.uClampFrame.zw);

            var bias = 0.;

            if(unclamped.x == coord.x && unclamped.y == coord.y)
            {
                bias = -32.;
            }

            outColor = textureSampleBias(uTexture, uSampler, coord, bias);
        `}},Fl={name:"tiling-bit",vertex:{header:`
            uniform mat3 uTextureTransform;
            uniform vec4 uSizeAnchor;

        `,main:`
            uv = (uTextureTransform * vec3(aUV, 1.0)).xy;

            position = (position - uSizeAnchor.zw) * uSizeAnchor.xy;
        `},fragment:{header:`
            uniform sampler2D uTexture;
            uniform mat3 uMapCoord;
            uniform vec4 uClampFrame;
            uniform vec2 uClampOffset;
        `,main:`

        vec2 coord = vUV + ceil(uClampOffset - vUV);
        coord = (uMapCoord * vec3(coord, 1.0)).xy;
        vec2 unclamped = coord;
        coord = clamp(coord, uClampFrame.xy, uClampFrame.zw);

        outColor = texture(uTexture, coord, unclamped == coord ? 0.0 : -32.0);// lod-bias very negative to force lod 0

        `}};let Cr,Tr;class El extends Wi{constructor(){Cr??(Cr=Di({name:"tiling-sprite-shader",bits:[Yt,zl,Ui]})),Tr??(Tr=$i({name:"tiling-sprite-shader",bits:[Bl,Fl,Vi]}));const e=new Qt({uMapCoord:{value:new be,type:"mat3x3<f32>"},uClampFrame:{value:new Float32Array([0,0,1,1]),type:"vec4<f32>"},uClampOffset:{value:new Float32Array([0,0]),type:"vec2<f32>"},uTextureTransform:{value:new be,type:"mat3x3<f32>"},uSizeAnchor:{value:new Float32Array([100,100,.5,.5]),type:"vec4<f32>"}});super({glProgram:Tr,gpuProgram:Cr,resources:{localUniforms:new Qt({uTransformMatrix:{value:new be,type:"mat3x3<f32>"},uColor:{value:new Float32Array([1,1,1,1]),type:"vec4<f32>"},uRound:{value:0,type:"f32"}}),tilingUniforms:e,uTexture:q.EMPTY.source,uSampler:q.EMPTY.source.style}})}updateUniforms(e,t,r,s,o,i){const a=this.resources.tilingUniforms,l=i.width,c=i.height,u=i.textureMatrix,d=a.uniforms.uTextureTransform;d.set(r.a*l/e,r.b*l/t,r.c*c/e,r.d*c/t,r.tx/e,r.ty/t),d.invert(),a.uniforms.uMapCoord=u.mapCoord,a.uniforms.uClampFrame=u.uClampFrame,a.uniforms.uClampOffset=u.uClampOffset,a.uniforms.uTextureTransform=d,a.uniforms.uSizeAnchor[0]=e,a.uniforms.uSizeAnchor[1]=t,a.uniforms.uSizeAnchor[2]=s,a.uniforms.uSizeAnchor[3]=o,i&&(this.resources.uTexture=i.source,this.resources.uSampler=i.source.style)}}class Ll extends Do{constructor(){super({positions:new Float32Array([0,0,1,0,1,1,0,1]),uvs:new Float32Array([0,0,1,0,1,1,0,1]),indices:new Uint32Array([0,1,2,0,2,3])})}}function Wl(n,e){const t=n.anchor.x,r=n.anchor.y;e[0]=-t*n.width,e[1]=-r*n.height,e[2]=(1-t)*n.width,e[3]=-r*n.height,e[4]=(1-t)*n.width,e[5]=(1-r)*n.height,e[6]=-t*n.width,e[7]=(1-r)*n.height}function Dl(n,e,t,r){let s=0;const o=n.length/e,i=r.a,a=r.b,l=r.c,c=r.d,u=r.tx,d=r.ty;for(t*=e;s<o;){const h=n[t],p=n[t+1];n[t]=i*h+l*p+u,n[t+1]=a*h+c*p+d,t+=e,s++}}function Ul(n,e){const t=n.texture,r=t.frame.width,s=t.frame.height;let o=0,i=0;n.applyAnchorToTexture&&(o=n.anchor.x,i=n.anchor.y),e[0]=e[6]=-o,e[2]=e[4]=1-o,e[1]=e[3]=-i,e[5]=e[7]=1-i;const a=be.shared;a.copyFrom(n._tileTransform.matrix),a.tx/=n.width,a.ty/=n.height,a.invert(),a.scale(n.width/r,n.height/s),Dl(e,2,0,a)}const qt=new Ll;class $l{constructor(){this.canBatch=!0,this.geometry=new Do({indices:qt.indices.slice(),positions:qt.positions.slice(),uvs:qt.uvs.slice()})}destroy(){this.geometry.destroy(),this.shader?.destroy()}}class $o{constructor(e){this._state=Gi.default2d,this._renderer=e,this._managedTilingSprites=new to({renderer:e,type:"renderable",name:"tilingSprite"})}validateRenderable(e){const t=this._getTilingSpriteData(e),r=t.canBatch;this._updateCanBatch(e);const s=t.canBatch;if(s&&s===r){const{batchableMesh:o}=t;return!o._batcher.checkAndUpdateTexture(o,e.texture)}return r!==s}addRenderable(e,t){const r=this._renderer.renderPipes.batch;this._updateCanBatch(e);const s=this._getTilingSpriteData(e),{geometry:o,canBatch:i}=s;if(i){s.batchableMesh||(s.batchableMesh=new Rl);const a=s.batchableMesh;e.didViewUpdate&&(this._updateBatchableMesh(e),a.geometry=o,a.renderable=e,a.transform=e.groupTransform,a.setTexture(e._texture)),a.roundPixels=this._renderer._roundPixels|e._roundPixels,r.addToBatch(a,t)}else r.break(t),s.shader||(s.shader=new El),this.updateRenderable(e),t.add(e)}execute(e){const t=this._renderer,{shader:r}=this._getTilingSpriteData(e);r.groups[0]=t.globalUniforms.bindGroup;const s=r.resources.localUniforms.uniforms;s.uTransformMatrix=e.groupTransform,s.uRound=t._roundPixels|e._roundPixels,ji(e.groupColorAlpha,s.uColor,0),this._state.blendMode=Hi(e.groupBlendMode,e.texture._source),t.encoder.draw({geometry:qt,shader:r,state:this._state})}updateRenderable(e){const t=this._getTilingSpriteData(e),{canBatch:r}=t;if(r){const{batchableMesh:s}=t;e.didViewUpdate&&this._updateBatchableMesh(e),s._batcher.updateElement(s)}else if(e.didViewUpdate){const{shader:s}=t;s.updateUniforms(e.width,e.height,e._tileTransform.matrix,e.anchor.x,e.anchor.y,e.texture)}}_getTilingSpriteData(e){return e._gpuData[this._renderer.uid]||this._initTilingSpriteData(e)}_initTilingSpriteData(e){const t=new $l;return t.renderable=e,e._gpuData[this._renderer.uid]=t,this._managedTilingSprites.add(e),t}_updateBatchableMesh(e){const t=this._getTilingSpriteData(e),{geometry:r}=t,s=e.texture.source.style;s.addressMode!=="repeat"&&(s.addressMode="repeat",s.update()),Ul(e,r.uvs),Wl(e,r.positions)}destroy(){this._managedTilingSprites.destroy(),this._renderer=null}_updateCanBatch(e){const t=this._getTilingSpriteData(e),r=e.texture;let s=!0;return this._renderer.type===Ni.WEBGL&&(s=this._renderer.context.supports.nonPowOf2wrapping),t.canBatch=r.textureMatrix.isSimple&&(s||r.source.isPowerOfTwo),t.canBatch}}$o.extension={type:[J.WebGLPipes,J.WebGPUPipes],name:"tilingSprite"};me.add(Uo);me.add($o);const Vo=class Zt extends ro{constructor(...e){let t=e[0]||{};t instanceof q&&(t={texture:t}),e.length>1&&(ae(fe,"use new TilingSprite({ texture, width:100, height:100 }) instead"),t.width=e[1],t.height=e[2]),t={...Zt.defaultOptions,...t};const{texture:r,anchor:s,tilePosition:o,tileScale:i,tileRotation:a,width:l,height:c,applyAnchorToTexture:u,roundPixels:d,...h}=t??{};super({label:"TilingSprite",...h}),this.renderPipeId="tilingSprite",this.batched=!0,this.allowChildren=!1,this._anchor=new ot({_onUpdate:()=>{this.onViewUpdate()}}),this.applyAnchorToTexture=u,this.texture=r,this._width=l??r.width,this._height=c??r.height,this._tileTransform=new Al({observer:{_onUpdate:()=>this.onViewUpdate()}}),s&&(this.anchor=s),this.tilePosition=o,this.tileScale=i,this.tileRotation=a,this.roundPixels=d??!1}static from(e,t={}){return typeof e=="string"?new Zt({texture:Xi.get(e),...t}):new Zt({texture:e,...t})}get uvRespectAnchor(){return ae(fe,"uvRespectAnchor is deprecated, please use applyAnchorToTexture instead"),this.applyAnchorToTexture}set uvRespectAnchor(e){ae(fe,"uvRespectAnchor is deprecated, please use applyAnchorToTexture instead"),this.applyAnchorToTexture=e}get clampMargin(){return this._texture.textureMatrix.clampMargin}set clampMargin(e){this._texture.textureMatrix.clampMargin=e}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}get tilePosition(){return this._tileTransform.position}set tilePosition(e){this._tileTransform.position.copyFrom(e)}get tileScale(){return this._tileTransform.scale}set tileScale(e){typeof e=="number"?this._tileTransform.scale.set(e):this._tileTransform.scale.copyFrom(e)}set tileRotation(e){this._tileTransform.rotation=e}get tileRotation(){return this._tileTransform.rotation}get tileTransform(){return this._tileTransform}set texture(e){e||(e=q.EMPTY);const t=this._texture;t!==e&&(t&&t.dynamic&&t.off("update",this.onViewUpdate,this),e.dynamic&&e.on("update",this.onViewUpdate,this),this._texture=e,this.onViewUpdate())}get texture(){return this._texture}set width(e){this._width=e,this.onViewUpdate()}get width(){return this._width}set height(e){this._height=e,this.onViewUpdate()}get height(){return this._height}setSize(e,t){typeof e=="object"&&(t=e.height??e.width,e=e.width),this._width=e,this._height=t??e,this.onViewUpdate()}getSize(e){return e||(e={}),e.width=this._width,e.height=this._height,e}updateBounds(){const e=this._bounds,t=this._anchor,r=this._width,s=this._height;e.minX=-t._x*r,e.maxX=e.minX+r,e.minY=-t._y*s,e.maxY=e.minY+s}containsPoint(e){const t=this._width,r=this._height,s=-t*this._anchor._x;let o=0;return e.x>=s&&e.x<=s+t&&(o=-r*this._anchor._y,e.y>=o&&e.y<=o+r)}destroy(e=!1){if(super.destroy(e),this._anchor=null,this._tileTransform=null,this._bounds=null,typeof e=="boolean"?e:e?.texture){const r=typeof e=="boolean"?e:e?.textureSource;this._texture.destroy(r)}this._texture=null}};Vo.defaultOptions={texture:q.EMPTY,anchor:{x:0,y:0},tilePosition:{x:0,y:0},tileScale:{x:1,y:1},tileRotation:0,applyAnchorToTexture:!1};let Vl=Vo;class Gl extends ro{constructor(e,t){const{text:r,resolution:s,style:o,anchor:i,width:a,height:l,roundPixels:c,...u}=e;super({...u}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=t,this.text=r??"",this.style=o,this.resolution=s??null,this.allowChildren=!1,this._anchor=new ot({_onUpdate:()=>{this.onViewUpdate()}}),i&&(this.anchor=i),this.roundPixels=c??!1,a!==void 0&&(this.width=a),l!==void 0&&(this.height=l)}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}set text(e){e=e.toString(),this._text!==e&&(this._text=e,this.onViewUpdate())}get text(){return this._text}set resolution(e){this._autoResolution=e===null,this._resolution=e,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(e){e||(e={}),this._style?.off("update",this.onViewUpdate,this),e instanceof this._styleClass?this._style=e:this._style=new this._styleClass(e),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(e){this._setWidth(e,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(e){this._setHeight(e,this.bounds.height)}getSize(e){return e||(e={}),e.width=Math.abs(this.scale.x)*this.bounds.width,e.height=Math.abs(this.scale.y)*this.bounds.height,e}setSize(e,t){typeof e=="object"?(t=e.height??e.width,e=e.width):t??(t=e),e!==void 0&&this._setWidth(e,this.bounds.width),t!==void 0&&this._setHeight(t,this.bounds.height)}containsPoint(e){const t=this.bounds.width,r=this.bounds.height,s=-t*this.anchor.x;let o=0;return e.x>=s&&e.x<=s+t&&(o=-r*this.anchor.y,e.y>=o&&e.y<=o+r)}onViewUpdate(){this.didViewUpdate||(this._didTextUpdate=!0),super.onViewUpdate()}destroy(e=!1){super.destroy(e),this.owner=null,this._bounds=null,this._anchor=null,(typeof e=="boolean"?e:e?.style)&&this._style.destroy(e),this._style=null,this._text=null}get styleKey(){return`${this._text}:${this._style.styleKey}:${this._resolution}`}}function jl(n,e){let t=n[0]??{};return(typeof t=="string"||n[1])&&(ae(fe,`use new ${e}({ text: "hi!", style }) instead`),t={text:t,style:n[1]}),t}class Hl{constructor(e){this._canvasPool=Object.create(null),this.canvasOptions=e||{},this.enableFullScreen=!1}_createCanvasAndContext(e,t){const r=Q.get().createCanvas();r.width=e,r.height=t;const s=r.getContext("2d");return{canvas:r,context:s}}getOptimalCanvasAndContext(e,t,r=1){e=Math.ceil(e*r-1e-6),t=Math.ceil(t*r-1e-6),e=er(e),t=er(t);const s=(e<<17)+(t<<1);this._canvasPool[s]||(this._canvasPool[s]=[]);let o=this._canvasPool[s].pop();return o||(o=this._createCanvasAndContext(e,t)),o}returnCanvasAndContext(e){const t=e.canvas,{width:r,height:s}=t,o=(r<<17)+(s<<1);e.context.resetTransform(),e.context.clearRect(0,0,r,s),this._canvasPool[o].push(e)}clear(){this._canvasPool={}}}const Kr=new Hl;Js.register(Kr);let We=null,we=null;function Nl(n,e){We||(We=Q.get().createCanvas(256,128),we=We.getContext("2d",{willReadFrequently:!0}),we.globalCompositeOperation="copy",we.globalAlpha=1),(We.width<n||We.height<e)&&(We.width=er(n),We.height=er(e))}function rs(n,e,t){for(let r=0,s=4*t*e;r<e;++r,s+=4)if(n[s+3]!==0)return!1;return!0}function ns(n,e,t,r,s){const o=4*e;for(let i=r,a=r*o+4*t;i<=s;++i,a+=o)if(n[a+3]!==0)return!1;return!0}function Xl(...n){let e=n[0];e.canvas||(e={canvas:n[0],resolution:n[1]});const{canvas:t}=e,r=Math.min(e.resolution??1,1),s=e.width??t.width,o=e.height??t.height;let i=e.output;if(Nl(s,o),!we)throw new TypeError("Failed to get canvas 2D context");we.drawImage(t,0,0,s,o,0,0,s*r,o*r);const l=we.getImageData(0,0,s,o).data;let c=0,u=0,d=s-1,h=o-1;for(;u<o&&rs(l,s,u);)++u;if(u===o)return tr.EMPTY;for(;rs(l,s,h);)--h;for(;ns(l,s,c,u,h);)++c;for(;ns(l,s,d,u,h);)--d;return++d,++h,we.globalCompositeOperation="source-over",we.strokeRect(c,u,d-c,h-u),we.globalCompositeOperation="copy",i??(i=new tr),i.set(c/r,u/r,(d-c)/r,(h-u)/r),i}class Yl{constructor(e=0,t=0,r=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=e,this.resetTtl=r,this.size=0,this.ttl=t}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(e){if(this.has(e)){const t=this.items[e];delete this.items[e],this.size--,t.prev!==null&&(t.prev.next=t.next),t.next!==null&&(t.next.prev=t.prev),this.first===t&&(this.first=t.next),this.last===t&&(this.last=t.prev)}return this}entries(e=this.keys()){const t=new Array(e.length);for(let r=0;r<e.length;r++){const s=e[r];t[r]=[s,this.get(s)]}return t}evict(e=!1){if(e||this.size>0){const t=this.first;delete this.items[t.key],--this.size===0?(this.first=null,this.last=null):(this.first=t.next,this.first.prev=null)}return this}expiresAt(e){let t;return this.has(e)&&(t=this.items[e].expiry),t}get(e){const t=this.items[e];if(t!==void 0){if(this.ttl>0&&t.expiry<=Date.now()){this.delete(e);return}return this.moveToEnd(t),t.value}}has(e){return e in this.items}moveToEnd(e){this.last!==e&&(e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.first===e&&(this.first=e.next),e.prev=this.last,e.next=null,this.last!==null&&(this.last.next=e),this.last=e,this.first===null&&(this.first=e))}keys(){const e=new Array(this.size);let t=this.first,r=0;for(;t!==null;)e[r++]=t.key,t=t.next;return e}setWithEvicted(e,t,r=this.resetTtl){let s=null;if(this.has(e))this.set(e,t,!0,r);else{this.max>0&&this.size===this.max&&(s={...this.first},this.evict(!0));let o=this.items[e]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:e,prev:this.last,next:null,value:t};++this.size===1?this.first=o:this.last.next=o,this.last=o}return s}set(e,t,r=!1,s=this.resetTtl){let o=this.items[e];return r||o!==void 0?(o.value=t,r===!1&&s&&(o.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.moveToEnd(o)):(this.max>0&&this.size===this.max&&this.evict(!0),o=this.items[e]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:e,prev:this.last,next:null,value:t},++this.size===1?this.first=o:this.last.next=o,this.last=o),this}values(e=this.keys()){const t=new Array(e.length);for(let r=0;r<e.length;r++)t[r]=this.get(e[r]);return t}}function ql(n=1e3,e=0,t=!1){if(isNaN(n)||n<0)throw new TypeError("Invalid max value");if(isNaN(e)||e<0)throw new TypeError("Invalid ttl value");if(typeof t!="boolean")throw new TypeError("Invalid resetTtl value");return new Yl(n,e,t)}function Go(n){return!!n.tagStyles&&Object.keys(n.tagStyles).length>0}function jo(n){return n.includes("<")}function Zl(n,e){return n.clone().assign(e)}function Kl(n,e){const t=[],r=e.tagStyles;if(!Go(e)||!jo(n))return t.push({text:n,style:e}),t;const s=[e],o=[];let i="",a=0;for(;a<n.length;){const l=n[a];if(l==="<"){const c=n.indexOf(">",a);if(c===-1){i+=l,a++;continue}const u=n.slice(a+1,c);if(u.startsWith("/")){const d=u.slice(1).trim();if(o.length>0&&o[o.length-1]===d){i.length>0&&(t.push({text:i,style:s[s.length-1]}),i=""),s.pop(),o.pop(),a=c+1;continue}else{i+=n.slice(a,c+1),a=c+1;continue}}else{const d=u.trim();if(r[d]){i.length>0&&(t.push({text:i,style:s[s.length-1]}),i="");const h=s[s.length-1],p=Zl(h,r[d]);s.push(p),o.push(d),a=c+1;continue}else{i+=n.slice(a,c+1),a=c+1;continue}}}else i+=l,a++}return i.length>0&&t.push({text:i,style:s[s.length-1]}),t}const Jl=[10,13],Ql=new Set(Jl),ec=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288],tc=new Set(ec),rc=/(\r\n|\r|\n)/,nc=/(?:\r\n|\r|\n)/;function Pn(n){return typeof n!="string"?!1:Ql.has(n.charCodeAt(0))}function ue(n,e){return typeof n!="string"?!1:tc.has(n.charCodeAt(0))}function Ho(n){return n==="normal"||n==="pre-line"}function No(n){return n==="normal"}function ye(n){if(typeof n!="string")return"";let e=n.length-1;for(;e>=0&&ue(n[e]);)e--;return e<n.length-1?n.slice(0,e+1):n}function Xo(n){const e=[],t=[];if(typeof n!="string")return e;for(let r=0;r<n.length;r++){const s=n[r],o=n[r+1];if(ue(s)||Pn(s)){t.length>0&&(e.push(t.join("")),t.length=0),s==="\r"&&o===`
`?(e.push(`\r
`),r++):e.push(s);continue}t.push(s)}return t.length>0&&e.push(t.join("")),e}function Yo(n,e,t,r){const s=t(n),o=[];for(let i=0;i<s.length;i++){let a=s[i],l=a,c=1;for(;s[i+c];){const u=s[i+c];if(!r(l,u,n,i,e))a+=u,l=u,c++;else break}i+=c-1,o.push(a)}return o}const sc=/\r\n|\r|\n/g;function oc(n,e,t,r,s,o,i,a){const l=Kl(n,e);if(No(e.whiteSpace))for(let F=0;F<l.length;F++){const V=l[F];l[F]={text:V.text.replace(sc," "),style:V.style}}const u=[];let d=[];for(const F of l){const V=F.text.split(rc);for(let H=0;H<V.length;H++){const E=V[H];E===`\r
`||E==="\r"||E===`
`?(u.push(d),d=[]):E.length>0&&d.push({text:E,style:F.style})}}(d.length>0||u.length===0)&&u.push(d);const h=t?ic(u,e,r,s,i,a):u,p=[],f=[],m=[],g=[],x=[];let T=0;const C=e._fontString,v=o(C);v.fontSize===0&&(v.fontSize=e.fontSize,v.ascent=e.fontSize);let y="",b=!!e.dropShadow;for(const F of h){let V=0,H=v.ascent,E=v.descent,D="";for(const N of F){const te=N.style._fontString,oe=o(te);te!==y&&(r.font=te,y=te);const de=s(N.text,N.style.letterSpacing,r);V+=de,H=Math.max(H,oe.ascent),E=Math.max(E,oe.descent),D+=N.text,!b&&N.style.dropShadow&&(b=!0)}F.length===0&&(H=v.ascent,E=v.descent),p.push(V),f.push(H),m.push(E),x.push(D);const z=e.lineHeight||H+E;g.push(z+e.leading),T=Math.max(T,V)}const w=e._stroke?.width||0,W=(t&&e.align!=="left"&&e.align!=="justify"?Math.max(T,e.wordWrapWidth):T)+w+(e.dropShadow?e.dropShadow.distance:0);let R=0;for(let F=0;F<g.length;F++)R+=g[F];R=Math.max(R,g[0]+w);const $=R+(e.dropShadow?e.dropShadow.distance:0),A=e.lineHeight||v.fontSize;return{width:W,height:$,lines:x,lineWidths:p,lineHeight:A+e.leading,maxLineWidth:T,fontProperties:v,runsByLine:h,lineAscents:f,lineDescents:m,lineHeights:g,hasDropShadow:b}}function ic(n,e,t,r,s,o){const{letterSpacing:i,whiteSpace:a,wordWrapWidth:l,breakWords:c}=e,u=Ho(a),d=l+i,h={};let p="";const f=(g,x)=>{const T=`${g}|${x.styleKey}`;let C=h[T];if(C===void 0){const v=x._fontString;v!==p&&(t.font=v,p=v),C=r(g,x.letterSpacing,t)+x.letterSpacing,h[T]=C}return C},m=[];for(const g of n){const x=ac(g),T=m.length,C=R=>{let $=0,A=R;do{const{token:F,style:V}=x[A];$+=f(F,V),A++}while(A<x.length&&x[A].continuesFromPrevious);return $},v=R=>{const $=[];let A=R;do $.push({token:x[A].token,style:x[A].style}),A++;while(A<x.length&&x[A].continuesFromPrevious);return $};let y=[],b=0,w=!u,k=null;const B=()=>{k&&k.text.length>0&&y.push(k),k=null},W=()=>{if(B(),y.length>0){const R=y[y.length-1];R.text=ye(R.text),R.text.length===0&&y.pop()}m.push(y),y=[],b=0,w=!1};for(let R=0;R<x.length;R++){const{token:$,style:A,continuesFromPrevious:F}=x[R],V=f($,A);if(u){const D=ue($),z=k?.text[k.text.length-1]??y[y.length-1]?.text.slice(-1)??"",N=z?ue(z):!1;if(D&&N)continue}const H=!F,E=H?C(R):V;if(E>d&&H)if(b>0&&W(),c){const D=v(R);for(let z=0;z<D.length;z++){const N=D[z].token,te=D[z].style,oe=Yo(N,c,o,s);for(const de of oe){const Ee=f(de,te);Ee+b>d&&W(),!k||k.style!==te?(B(),k={text:de,style:te}):k.text+=de,b+=Ee}}R+=D.length-1}else{const D=v(R);B(),m.push(D.map(z=>({text:z.token,style:z.style}))),w=!1,R+=D.length-1}else if(E+b>d&&H){if(ue($)){w=!1;continue}W(),k={text:$,style:A},b=V}else if(F&&!c)!k||k.style!==A?(B(),k={text:$,style:A}):k.text+=$,b+=V;else{const D=ue($);if(b===0&&D&&!w)continue;!k||k.style!==A?(B(),k={text:$,style:A}):k.text+=$,b+=V}}if(B(),y.length>0){const R=y[y.length-1];R.text=ye(R.text),R.text.length===0&&y.pop()}(y.length>0||m.length===T)&&m.push(y)}return m}function ac(n){const e=[];let t=!1;for(const r of n){const s=Xo(r.text);let o=!0;for(const i of s){const a=ue(i)||Pn(i),l=o&&t&&!a;e.push({token:i,style:r.style,continuesFromPrevious:l}),t=!a,o=!1}}return e}const lc={willReadFrequently:!0};function ss(n,e,t,r,s){let o=t[n];return typeof o!="number"&&(o=s(n,e,r)+e,t[n]=o),o}function cc(n,e,t,r,s,o,i){const a=t.getContext("2d",lc);a.font=e._fontString;let l=0,c="";const u=[],d=Object.create(null),{letterSpacing:h,whiteSpace:p}=e,f=Ho(p),m=No(p);let g=!f;const x=e.wordWrapWidth+h,T=Xo(n);for(let v=0;v<T.length;v++){let y=T[v];if(Pn(y)){if(!m){u.push(ye(c)),g=!f,c="",l=0;continue}y=" "}if(f){const w=ue(y),k=ue(c[c.length-1]);if(w&&k)continue}const b=ss(y,h,d,a,r);if(b>x)if(c!==""&&(u.push(ye(c)),c="",l=0),s(y,e.breakWords)){const w=Yo(y,e.breakWords,i,o);for(const k of w){const B=ss(k,h,d,a,r);B+l>x&&(u.push(ye(c)),g=!1,c="",l=0),c+=k,l+=B}}else c.length>0&&(u.push(ye(c)),c="",l=0),u.push(ye(y)),g=!1,c="",l=0;else b+l>x&&(g=!1,u.push(ye(c)),c="",l=0),(c.length>0||!ue(y)||g)&&(c+=y,l+=b)}const C=ye(c);return C.length>0&&u.push(C),u.join(`
`)}const os={willReadFrequently:!0},_e=class I{static get experimentalLetterSpacingSupported(){let e=I._experimentalLetterSpacingSupported;if(e===void 0){const t=Q.get().getCanvasRenderingContext2D().prototype;e=I._experimentalLetterSpacingSupported="letterSpacing"in t||"textLetterSpacing"in t}return e}constructor(e,t,r,s,o,i,a,l,c,u){this.text=e,this.style=t,this.width=r,this.height=s,this.lines=o,this.lineWidths=i,this.lineHeight=a,this.maxLineWidth=l,this.fontProperties=c,u&&(this.runsByLine=u.runsByLine,this.lineAscents=u.lineAscents,this.lineDescents=u.lineDescents,this.lineHeights=u.lineHeights,this.hasDropShadow=u.hasDropShadow)}static measureText(e=" ",t,r=I._canvas,s=t.wordWrap){const o=`${e}-${t.styleKey}-wordWrap-${s}`;if(I._measurementCache.has(o))return I._measurementCache.get(o);if(Go(t)&&jo(e)){const y=oc(e,t,s,I._context,I._measureText,I.measureFont,I.canBreakChars,I.wordWrapSplit),b=new I(e,t,y.width,y.height,y.lines,y.lineWidths,y.lineHeight,y.maxLineWidth,y.fontProperties,{runsByLine:y.runsByLine,lineAscents:y.lineAscents,lineDescents:y.lineDescents,lineHeights:y.lineHeights,hasDropShadow:y.hasDropShadow});return I._measurementCache.set(o,b),b}const a=t._fontString,l=I.measureFont(a);l.fontSize===0&&(l.fontSize=t.fontSize,l.ascent=t.fontSize,l.descent=0);const c=I._context;c.font=a;const d=(s?I._wordWrap(e,t,r):e).split(nc),h=new Array(d.length);let p=0;for(let y=0;y<d.length;y++){const b=I._measureText(d[y],t.letterSpacing,c);h[y]=b,p=Math.max(p,b)}const f=t._stroke?.width??0,m=t.lineHeight||l.fontSize,g=I._getAlignWidth(p,t,s),x=I._adjustWidthForStyle(g,t),T=Math.max(m,l.fontSize+f)+(d.length-1)*(m+t.leading),C=I._adjustHeightForStyle(T,t),v=new I(e,t,x,C,d,h,m+t.leading,p,l);return I._measurementCache.set(o,v),v}static _adjustWidthForStyle(e,t){const r=t._stroke?.width||0;let s=e+r;return t.dropShadow&&(s+=t.dropShadow.distance),s}static _adjustHeightForStyle(e,t){let r=e;return t.dropShadow&&(r+=t.dropShadow.distance),r}static _getAlignWidth(e,t,r){return r&&t.align!=="left"&&t.align!=="justify"?Math.max(e,t.wordWrapWidth):e}static _measureText(e,t,r){let s=!1;I.experimentalLetterSpacingSupported&&(I.experimentalLetterSpacing?(r.letterSpacing=`${t}px`,r.textLetterSpacing=`${t}px`,s=!0):(r.letterSpacing="0px",r.textLetterSpacing="0px"));const o=r.measureText(e);let i=o.width;const a=-(o.actualBoundingBoxLeft??0);let c=(o.actualBoundingBoxRight??0)-a;if(i>0)if(s)i-=t,c-=t;else{const u=(I.graphemeSegmenter(e).length-1)*t;i+=u,c+=u}return Math.max(i,c)}static _wordWrap(e,t,r=I._canvas){return cc(e,t,r,I._measureText,I.canBreakWords,I.canBreakChars,I.wordWrapSplit)}static isBreakingSpace(e,t){return ue(e)}static canBreakWords(e,t){return t}static canBreakChars(e,t,r,s,o){return!0}static wordWrapSplit(e){return I.graphemeSegmenter(e)}static measureFont(e){if(I._fonts[e])return I._fonts[e];const t=I._context;t.font=e;const r=t.measureText(I.METRICS_STRING+I.BASELINE_SYMBOL),s=r.actualBoundingBoxAscent??0,o=r.actualBoundingBoxDescent??0,i={ascent:s,descent:o,fontSize:s+o};return I._fonts[e]=i,i}static clearMetrics(e=""){e?delete I._fonts[e]:I._fonts={}}static get _canvas(){if(!I.__canvas){let e;try{const t=new OffscreenCanvas(0,0);if(t.getContext("2d",os)?.measureText)return I.__canvas=t,t;e=Q.get().createCanvas()}catch{e=Q.get().createCanvas()}e.width=e.height=10,I.__canvas=e}return I.__canvas}static get _context(){return I.__context||(I.__context=I._canvas.getContext("2d",os)),I.__context}};_e.METRICS_STRING="|q";_e.BASELINE_SYMBOL="M";_e.BASELINE_MULTIPLIER=1.4;_e.HEIGHT_MULTIPLIER=2;_e.graphemeSegmenter=(()=>{if(typeof Intl?.Segmenter=="function"){const n=new Intl.Segmenter;return e=>{const t=n.segment(e),r=[];let s=0;for(const o of t)r[s++]=o.segment;return r}}return n=>[...n]})();_e.experimentalLetterSpacing=!1;_e._fonts={};_e._measurementCache=ql(1e3);let Pe=_e;const uc=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];function Jr(n){const e=typeof n.fontSize=="number"?`${n.fontSize}px`:n.fontSize;let t=n.fontFamily;Array.isArray(n.fontFamily)||(t=n.fontFamily.split(","));for(let r=t.length-1;r>=0;r--){let s=t[r].trim();!/([\"\'])[^\'\"]+\1/.test(s)&&!uc.includes(s)&&(s=`"${s}"`),t[r]=s}return`${n.fontStyle} ${n.fontVariant} ${n.fontWeight} ${e} ${t.join(",")}`}const is=1e5;function $t(n,e,t,r=0,s=0,o=0){if(n.texture===q.WHITE&&!n.fill)return Y.shared.setValue(n.color).setAlpha(n.alpha??1).toHexa();if(n.fill){if(n.fill instanceof dn){const i=n.fill,a=e.createPattern(i.texture.source.resource,"repeat"),l=i.transform.copyTo(be.shared);return l.scale(i.texture.source.pixelWidth,i.texture.source.pixelHeight),a.setTransform(l),a}else if(n.fill instanceof rr){const i=n.fill,a=i.type==="linear",l=i.textureSpace==="local";let c=1,u=1;l&&t&&(c=t.width+r,u=t.height+r);let d,h=!1;if(a){const{start:p,end:f}=i;d=e.createLinearGradient(p.x*c+s,p.y*u+o,f.x*c+s,f.y*u+o),h=Math.abs(f.x-p.x)<Math.abs((f.y-p.y)*.1)}else{const{center:p,innerRadius:f,outerCenter:m,outerRadius:g}=i;d=e.createRadialGradient(p.x*c+s,p.y*u+o,f*c,m.x*c+s,m.y*u+o,g*c)}if(h&&l&&t){const p=t.lineHeight/u;for(let f=0;f<t.lines.length;f++){const m=(f*t.lineHeight+r/2)/u;i.colorStops.forEach(g=>{let x=m+g.offset*p;x=Math.max(0,Math.min(1,x)),d.addColorStop(Math.floor(x*is)/is,Y.shared.setValue(g.color).toHex())})}}else i.colorStops.forEach(p=>{d.addColorStop(p.offset,Y.shared.setValue(p.color).toHex())});return d}}else{const i=e.createPattern(n.texture.source.resource,"repeat"),a=n.matrix.copyTo(be.shared);return a.scale(n.texture.source.pixelWidth,n.texture.source.pixelHeight),i.setTransform(a),i}return hn("FillStyle not recognised",n),"red"}const as=new tr;class dc{getCanvasAndContext(e){const{text:t,style:r,resolution:s=1}=e,o=r._getFinalPadding(),i=Pe.measureText(t||" ",r),a=Math.ceil(Math.ceil(Math.max(1,i.width)+o*2)*s),l=Math.ceil(Math.ceil(Math.max(1,i.height)+o*2)*s),c=Kr.getOptimalCanvasAndContext(a,l);this._renderTextToCanvas(r,o,s,c,i);const u=r.trim?Xl({canvas:c.canvas,width:a,height:l,resolution:1,output:as}):as.set(0,0,a,l);return{canvasAndContext:c,frame:u}}returnCanvasAndContext(e){Kr.returnCanvasAndContext(e)}_renderTextToCanvas(e,t,r,s,o){if(o.runsByLine&&o.runsByLine.length>0){this._renderTaggedTextToCanvas(o,e,t,r,s);return}const{canvas:i,context:a}=s,l=Jr(e),c=o.lines,u=o.lineHeight,d=o.lineWidths,h=o.maxLineWidth,p=o.fontProperties,f=i.height;if(a.resetTransform(),a.scale(r,r),a.textBaseline=e.textBaseline,e._stroke?.width){const b=e._stroke;a.lineWidth=b.width,a.miterLimit=b.miterLimit,a.lineJoin=b.join,a.lineCap=b.cap}a.font=l;let m,g;const x=e.dropShadow?2:1,T=e.wordWrap?e.wordWrapWidth:h,v=(e._stroke?.width??0)/2;let y=(u-p.fontSize)/2;u-p.fontSize<0&&(y=0);for(let b=0;b<x;++b){const w=e.dropShadow&&b===0,k=w?Math.ceil(Math.max(1,f)+t*2):0,B=k*r;if(w)this._setupDropShadow(a,e,r,B);else{const W=e._gradientBounds,R=e._gradientOffset;if(W){const $={width:W.width,height:W.height,lineHeight:W.height,lines:o.lines};this._setFillAndStrokeStyles(a,e,$,t,v,R?.x??0,R?.y??0)}else R?this._setFillAndStrokeStyles(a,e,o,t,v,R.x,R.y):this._setFillAndStrokeStyles(a,e,o,t,v);a.shadowColor="black"}for(let W=0;W<c.length;W++)m=v,g=v+W*u+p.ascent+y,m+=this._getAlignmentOffset(d[W],T,e.align),e._stroke?.width&&this._drawLetterSpacing(c[W],e,s,m+t,g+t-k,!0),e._fill!==void 0&&this._drawLetterSpacing(c[W],e,s,m+t,g+t-k)}}_renderTaggedTextToCanvas(e,t,r,s,o){const{canvas:i,context:a}=o,{runsByLine:l,lineWidths:c,maxLineWidth:u,lineAscents:d,lineHeights:h,hasDropShadow:p}=e,f=i.height;a.resetTransform(),a.scale(s,s),a.textBaseline=t.textBaseline;const m=p?2:1,g=t.wordWrap?t.wordWrapWidth:u,T=(t._stroke?.width??0)/2,C=[];for(let v=0;v<l.length;v++){const y=l[v],b=[];for(const w of y){const k=Jr(w.style);a.font=k,b.push({width:Pe._measureText(w.text,w.style.letterSpacing,a),font:k})}C.push(b)}for(let v=0;v<m;++v){const y=p&&v===0,b=y?Math.ceil(Math.max(1,f)+r*2):0,w=b*s;y||(a.shadowColor="black");let k=T;for(let B=0;B<l.length;B++){const W=l[B],R=c[B],$=d[B],A=h[B],F=C[B];let V=T;V+=this._getAlignmentOffset(R,g,t.align);const H=k+$;let E=V+r;for(let D=0;D<W.length;D++){const z=W[D],{width:N,font:te}=F[D];if(a.font=te,a.textBaseline=z.style.textBaseline,z.style._stroke?.width){const oe=z.style._stroke;if(a.lineWidth=oe.width,a.miterLimit=oe.miterLimit,a.lineJoin=oe.join,a.lineCap=oe.cap,y)if(z.style.dropShadow)this._setupDropShadow(a,z.style,s,w);else{E+=N;continue}else{const de=Pe.measureFont(te),Ee=z.style.lineHeight||de.fontSize,Oi={width:N,height:Ee,lineHeight:Ee,lines:[z.text]};a.strokeStyle=$t(oe,a,Oi,r*2,E-r,k)}this._drawLetterSpacing(z.text,z.style,o,E,H+r-b,!0)}E+=N}E=V+r;for(let D=0;D<W.length;D++){const z=W[D],{width:N,font:te}=F[D];if(a.font=te,a.textBaseline=z.style.textBaseline,z.style._fill!==void 0){if(y)if(z.style.dropShadow)this._setupDropShadow(a,z.style,s,w);else{E+=N;continue}else{const oe=Pe.measureFont(te),de=z.style.lineHeight||oe.fontSize,Ee={width:N,height:de,lineHeight:de,lines:[z.text]};a.fillStyle=$t(z.style._fill,a,Ee,r*2,E-r,k)}this._drawLetterSpacing(z.text,z.style,o,E,H+r-b,!1)}E+=N}k+=A}}}_setFillAndStrokeStyles(e,t,r,s,o,i=0,a=0){if(e.fillStyle=t._fill?$t(t._fill,e,r,s*2,i,a):null,t._stroke?.width){const l=o+s*2;e.strokeStyle=$t(t._stroke,e,r,l,i,a)}}_setupDropShadow(e,t,r,s){e.fillStyle="black",e.strokeStyle="black";const o=t.dropShadow,i=o.color,a=o.alpha;e.shadowColor=Y.shared.setValue(i).setAlpha(a).toRgbaString();const l=o.blur*r,c=o.distance*r;e.shadowBlur=l,e.shadowOffsetX=Math.cos(o.angle)*c,e.shadowOffsetY=Math.sin(o.angle)*c+s}_getAlignmentOffset(e,t,r){return r==="right"?t-e:r==="center"?(t-e)/2:0}_drawLetterSpacing(e,t,r,s,o,i=!1){const{context:a}=r,l=t.letterSpacing;let c=!1;if(Pe.experimentalLetterSpacingSupported&&(Pe.experimentalLetterSpacing?(a.letterSpacing=`${l}px`,a.textLetterSpacing=`${l}px`,c=!0):(a.letterSpacing="0px",a.textLetterSpacing="0px")),l===0||c){i?a.strokeText(e,s,o):a.fillText(e,s,o);return}let u=s;const d=Pe.graphemeSegmenter(e);let h=a.measureText(e).width,p=0;for(let f=0;f<d.length;++f){const m=d[f];i?a.strokeText(m,u,o):a.fillText(m,u,o);let g="";for(let x=f+1;x<d.length;++x)g+=d[x];p=a.measureText(g).width,u+=h-p+l,h=p}}}const it=new dc,Rn=class Ue extends Zs{constructor(e={}){super(),this.uid=Ks("textStyle"),this._tick=0,this._cachedFontString=null,hc(e),e instanceof Ue&&(e=e._toObject());const s={...Ue.defaultTextStyle,...e};for(const o in s){const i=o;this[i]=s[o]}this._tagStyles=e.tagStyles??void 0,this.update(),this._tick=0}get align(){return this._align}set align(e){this._align!==e&&(this._align=e,this.update())}get breakWords(){return this._breakWords}set breakWords(e){this._breakWords!==e&&(this._breakWords=e,this.update())}get dropShadow(){return this._dropShadow}set dropShadow(e){this._dropShadow!==e&&(e!==null&&typeof e=="object"?this._dropShadow=this._createProxy({...Ue.defaultDropShadow,...e}):this._dropShadow=e?this._createProxy({...Ue.defaultDropShadow}):null,this.update())}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this.update())}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize!==e&&(typeof e=="string"?this._fontSize=parseInt(e,10):this._fontSize=e,this.update())}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle!==e&&(this._fontStyle=e.toLowerCase(),this.update())}get fontVariant(){return this._fontVariant}set fontVariant(e){this._fontVariant!==e&&(this._fontVariant=e,this.update())}get fontWeight(){return this._fontWeight}set fontWeight(e){this._fontWeight!==e&&(this._fontWeight=e,this.update())}get leading(){return this._leading}set leading(e){this._leading!==e&&(this._leading=e,this.update())}get letterSpacing(){return this._letterSpacing}set letterSpacing(e){this._letterSpacing!==e&&(this._letterSpacing=e,this.update())}get lineHeight(){return this._lineHeight}set lineHeight(e){this._lineHeight!==e&&(this._lineHeight=e,this.update())}get padding(){return this._padding}set padding(e){this._padding!==e&&(this._padding=e,this.update())}get filters(){return this._filters}set filters(e){this._filters!==e&&(this._filters=Object.freeze(e),this.update())}get trim(){return this._trim}set trim(e){this._trim!==e&&(this._trim=e,this.update())}get textBaseline(){return this._textBaseline}set textBaseline(e){this._textBaseline!==e&&(this._textBaseline=e,this.update())}get whiteSpace(){return this._whiteSpace}set whiteSpace(e){this._whiteSpace!==e&&(this._whiteSpace=e,this.update())}get wordWrap(){return this._wordWrap}set wordWrap(e){this._wordWrap!==e&&(this._wordWrap=e,this.update())}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(e){this._wordWrapWidth!==e&&(this._wordWrapWidth=e,this.update())}get fill(){return this._originalFill}set fill(e){e!==this._originalFill&&(this._originalFill=e,this._isFillStyle(e)&&(this._originalFill=this._createProxy({...et.defaultFillStyle,...e},()=>{this._fill=Dn({...this._originalFill},et.defaultFillStyle)})),this._fill=Dn(e===0?"black":e,et.defaultFillStyle),this.update())}get stroke(){return this._originalStroke}set stroke(e){e!==this._originalStroke&&(this._originalStroke=e,this._isFillStyle(e)&&(this._originalStroke=this._createProxy({...et.defaultStrokeStyle,...e},()=>{this._stroke=Un({...this._originalStroke},et.defaultStrokeStyle)})),this._stroke=Un(e,et.defaultStrokeStyle),this.update())}get tagStyles(){return this._tagStyles}set tagStyles(e){this._tagStyles!==e&&(this._tagStyles=e??void 0,this.update())}update(){this._tick++,this._cachedFontString=null,this.emit("update",this)}reset(){const e=Ue.defaultTextStyle;for(const t in e)this[t]=e[t]}assign(e){for(const t in e){const r=t;this[r]=e[t]}return this}get styleKey(){return`${this.uid}-${this._tick}`}get _fontString(){return this._cachedFontString===null&&(this._cachedFontString=Jr(this)),this._cachedFontString}_toObject(){return{align:this.align,breakWords:this.breakWords,dropShadow:this._dropShadow?{...this._dropShadow}:null,fill:this._fill?{...this._fill}:void 0,fontFamily:this.fontFamily,fontSize:this.fontSize,fontStyle:this.fontStyle,fontVariant:this.fontVariant,fontWeight:this.fontWeight,leading:this.leading,letterSpacing:this.letterSpacing,lineHeight:this.lineHeight,padding:this.padding,stroke:this._stroke?{...this._stroke}:void 0,textBaseline:this.textBaseline,trim:this.trim,whiteSpace:this.whiteSpace,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth,filters:this._filters?[...this._filters]:void 0,tagStyles:this._tagStyles?{...this._tagStyles}:void 0}}clone(){return new Ue(this._toObject())}_getFinalPadding(){let e=0;if(this._filters)for(let t=0;t<this._filters.length;t++)e+=this._filters[t].padding;return Math.max(this._padding,e)}destroy(e=!1){if(this.removeAllListeners(),typeof e=="boolean"?e:e?.texture){const r=typeof e=="boolean"?e:e?.textureSource;this._fill?.texture&&this._fill.texture.destroy(r),this._originalFill?.texture&&this._originalFill.texture.destroy(r),this._stroke?.texture&&this._stroke.texture.destroy(r),this._originalStroke?.texture&&this._originalStroke.texture.destroy(r)}this._fill=null,this._stroke=null,this.dropShadow=null,this._originalStroke=null,this._originalFill=null}_createProxy(e,t){return new Proxy(e,{set:(r,s,o)=>(r[s]===o||(r[s]=o,t?.(s,o),this.update()),!0)})}_isFillStyle(e){return(e??null)!==null&&!(Y.isColorLike(e)||e instanceof rr||e instanceof dn)}};Rn.defaultDropShadow={alpha:1,angle:Math.PI/6,blur:0,color:"black",distance:5};Rn.defaultTextStyle={align:"left",breakWords:!1,dropShadow:null,fill:"black",fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",leading:0,letterSpacing:0,lineHeight:0,padding:0,stroke:null,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100};let nr=Rn;function hc(n){const e=n;if(typeof e.dropShadow=="boolean"&&e.dropShadow){const t=nr.defaultDropShadow;n.dropShadow={alpha:e.dropShadowAlpha??t.alpha,angle:e.dropShadowAngle??t.angle,blur:e.dropShadowBlur??t.blur,color:e.dropShadowColor??t.color,distance:e.dropShadowDistance??t.distance}}if(e.strokeThickness!==void 0){ae(fe,"strokeThickness is now a part of stroke");const t=e.stroke;let r={};if(Y.isColorLike(t))r.color=t;else if(t instanceof rr||t instanceof dn)r.fill=t;else if(Object.hasOwnProperty.call(t,"color")||Object.hasOwnProperty.call(t,"fill"))r=t;else throw new Error("Invalid stroke value.");n.stroke={...r,width:e.strokeThickness}}if(Array.isArray(e.fillGradientStops)){if(ae(fe,"gradient fill is now a fill pattern: `new FillGradient(...)`"),!Array.isArray(e.fill)||e.fill.length===0)throw new Error("Invalid fill value. Expected an array of colors for gradient fill.");e.fill.length!==e.fillGradientStops.length&&hn("The number of fill colors must match the number of fill gradient stops.");const t=new rr({start:{x:0,y:0},end:{x:0,y:1},textureSpace:"local"}),r=e.fillGradientStops.slice(),s=e.fill.map(o=>Y.shared.setValue(o).toNumber());r.forEach((o,i)=>{t.addColorStop(o,s[i])}),n.fill={fill:t}}}function pc(n,e){const{texture:t,bounds:r}=n,s=e._style._getFinalPadding();Yi(r,e._anchor,t);const o=e._anchor._x*s*2,i=e._anchor._y*s*2;r.minX-=s-o,r.minY-=s-i,r.maxX-=s-o,r.maxY-=s-i}class fc{constructor(){this.batcherName="default",this.topology="triangle-list",this.attributeSize=4,this.indexSize=6,this.packAsQuad=!0,this.roundPixels=0,this._attributeStart=0,this._batcher=null,this._batch=null}get blendMode(){return this.renderable.groupBlendMode}get color(){return this.renderable.groupColorAlpha}reset(){this.renderable=null,this.texture=null,this._batcher=null,this._batch=null,this.bounds=null}destroy(){this.reset()}}class gc extends fc{}class qo{constructor(e){this._renderer=e,e.runners.resolutionChange.add(this),this._managedTexts=new to({renderer:e,type:"renderable",onUnload:this.onTextUnload.bind(this),name:"canvasText"})}resolutionChange(){for(const e in this._managedTexts.items){const t=this._managedTexts.items[e];t?._autoResolution&&t.onViewUpdate()}}validateRenderable(e){const t=this._getGpuText(e),r=e.styleKey;return t.currentKey!==r?!0:e._didTextUpdate}addRenderable(e,t){const r=this._getGpuText(e);if(e._didTextUpdate){const s=e._autoResolution?this._renderer.resolution:e.resolution;(r.currentKey!==e.styleKey||e._resolution!==s)&&this._updateGpuText(e),e._didTextUpdate=!1,pc(r,e)}this._renderer.renderPipes.batch.addToBatch(r,t)}updateRenderable(e){const t=this._getGpuText(e);t._batcher.updateElement(t)}_updateGpuText(e){const t=this._getGpuText(e);t.texture&&this._renderer.canvasText.decreaseReferenceCount(t.currentKey),e._resolution=e._autoResolution?this._renderer.resolution:e.resolution,t.texture=this._renderer.canvasText.getManagedTexture(e),t.currentKey=e.styleKey}_getGpuText(e){return e._gpuData[this._renderer.uid]||this.initGpuText(e)}initGpuText(e){const t=new gc;return t.currentKey="--",t.renderable=e,t.transform=e.groupTransform,t.bounds={minX:0,maxX:1,minY:0,maxY:0},t.roundPixels=this._renderer._roundPixels|e._roundPixels,e._gpuData[this._renderer.uid]=t,this._managedTexts.add(e),t}onTextUnload(e){const t=e._gpuData[this._renderer.uid];if(!t)return;const{canvasText:r}=this._renderer;r.getReferenceCount(t.currentKey)>0?r.decreaseReferenceCount(t.currentKey):t.texture&&r.returnTexture(t.texture)}destroy(){this._managedTexts.destroy(),this._renderer=null}}qo.extension={type:[J.WebGLPipes,J.WebGPUPipes,J.CanvasPipes],name:"text"};const mc=new qi;function xc(n,e,t,r){const s=mc;s.minX=0,s.minY=0,s.maxX=n.width/r|0,s.maxY=n.height/r|0;const o=no.getOptimalTexture(s.width,s.height,r,!1);return o.source.uploadMethodId="image",o.source.resource=n,o.source.alphaMode="premultiply-alpha-on-upload",o.frame.width=e/r,o.frame.height=t/r,o.source.emit("update",o.source),o.updateUvs(),o}class Zo{constructor(e,t){this._activeTextures={},this._renderer=e,this._retainCanvasContext=t}getTexture(e,t,r,s){typeof e=="string"&&(ae("8.0.0","CanvasTextSystem.getTexture: Use object TextOptions instead of separate arguments"),e={text:e,style:r,resolution:t}),e.style instanceof nr||(e.style=new nr(e.style)),e.textureStyle instanceof Ct||(e.textureStyle=new Ct(e.textureStyle)),typeof e.text!="string"&&(e.text=e.text.toString());const{text:o,style:i,textureStyle:a}=e,l=e.resolution??this._renderer.resolution,{frame:c,canvasAndContext:u}=it.getCanvasAndContext({text:o,style:i,resolution:l}),d=xc(u.canvas,c.width,c.height,l);if(a&&(d.source.style=a),i.trim&&(c.pad(i.padding),d.frame.copyFrom(c),d.frame.scale(1/l),d.updateUvs()),i.filters){const h=this._applyFilters(d,i.filters);return this.returnTexture(d),it.returnCanvasAndContext(u),h}return this._renderer.texture.initSource(d._source),this._retainCanvasContext||it.returnCanvasAndContext(u),d}returnTexture(e){const t=e.source,r=t.resource;if(this._retainCanvasContext&&r?.getContext){const s=r.getContext("2d");s&&it.returnCanvasAndContext({canvas:r,context:s})}t.resource=null,t.uploadMethodId="unknown",t.alphaMode="no-premultiply-alpha",no.returnTexture(e,!0)}renderTextToCanvas(){ae("8.10.0","CanvasTextSystem.renderTextToCanvas: no longer supported, use CanvasTextSystem.getTexture instead")}getManagedTexture(e){e._resolution=e._autoResolution?this._renderer.resolution:e.resolution;const t=e.styleKey;if(this._activeTextures[t])return this._increaseReferenceCount(t),this._activeTextures[t].texture;const r=this.getTexture({text:e.text,style:e.style,resolution:e._resolution,textureStyle:e.textureStyle});return this._activeTextures[t]={texture:r,usageCount:1},r}decreaseReferenceCount(e){const t=this._activeTextures[e];t&&(t.usageCount--,t.usageCount===0&&(this.returnTexture(t.texture),this._activeTextures[e]=null))}getReferenceCount(e){return this._activeTextures[e]?.usageCount??0}_increaseReferenceCount(e){this._activeTextures[e].usageCount++}_applyFilters(e,t){const r=this._renderer.renderTarget.renderTarget,s=this._renderer.filter.generateFilteredTexture({texture:e,filters:t});return this._renderer.renderTarget.bind(r,!1),s}destroy(){this._renderer=null;for(const e in this._activeTextures)this._activeTextures[e]&&this.returnTexture(this._activeTextures[e].texture);this._activeTextures=null}}class Ko extends Zo{constructor(e){super(e,!0)}}Ko.extension={type:[J.CanvasSystem],name:"canvasText"};class Jo extends Zo{constructor(e){super(e,!1)}}Jo.extension={type:[J.WebGLSystem,J.WebGPUSystem],name:"canvasText"};me.add(Ko);me.add(Jo);me.add(qo);class yc extends Gl{constructor(...e){const t=jl(e,"Text");super(t,nr),this.renderPipeId="text",t.textureStyle&&(this.textureStyle=t.textureStyle instanceof Ct?t.textureStyle:new Ct(t.textureStyle))}updateBounds(){const e=this._bounds,t=this._anchor;let r=0,s=0;if(this._style.trim){const{frame:o,canvasAndContext:i}=it.getCanvasAndContext({text:this.text,style:this._style,resolution:1});it.returnCanvasAndContext(i),r=o.width,s=o.height}else{const o=Pe.measureText(this._text,this._style);r=o.width,s=o.height}e.minX=-t._x*r,e.maxX=e.minX+r,e.minY=-t._y*s,e.maxY=e.minY+s}}const Qo=class ei extends M{constructor(e={}){e={...ei.defaultOptions,...e},super(),this.renderLayerChildren=[],this.sortableChildren=e.sortableChildren,this.sortFunction=e.sortFunction}attach(...e){for(let t=0;t<e.length;t++){const r=e[t];if(r.parentRenderLayer){if(r.parentRenderLayer===this)continue;r.parentRenderLayer.detach(r)}this.renderLayerChildren.push(r),r.parentRenderLayer=this;const s=this.renderGroup||this.parentRenderGroup;s&&(s.structureDidChange=!0)}return e[0]}detach(...e){for(let t=0;t<e.length;t++){const r=e[t],s=this.renderLayerChildren.indexOf(r);s!==-1&&this.renderLayerChildren.splice(s,1),r.parentRenderLayer=null;const o=this.renderGroup||this.parentRenderGroup;o&&(o.structureDidChange=!0)}return e[0]}detachAll(){const e=this.renderLayerChildren;for(let t=0;t<e.length;t++)e[t].parentRenderLayer=null;this.renderLayerChildren.length=0}collectRenderables(e,t,r){const s=this.renderLayerChildren,o=s.length;this.sortableChildren&&this.sortRenderLayerChildren();for(let i=0;i<o;i++)s[i].parent||hn("Container must be added to both layer and scene graph. Layers only handle render order - the scene graph is required for transforms (addChild)",s[i]),s[i].collectRenderables(e,t,this)}sortRenderLayerChildren(){this.renderLayerChildren.sort(this.sortFunction)}_getGlobalBoundsRecursive(e,t,r){if(!e)return;const s=this.renderLayerChildren;for(let o=0;o<s.length;o++)s[o]._getGlobalBoundsRecursive(!0,t,this)}getFastGlobalBounds(e,t){return super.getFastGlobalBounds(e,t)}addChild(...e){throw new Error("RenderLayer.addChild() is not available. Please use RenderLayer.attach()")}removeChild(...e){throw new Error("RenderLayer.removeChild() is not available. Please use RenderLayer.detach()")}removeChildren(e,t){throw new Error("RenderLayer.removeChildren() is not available. Please use RenderLayer.detach()")}removeChildAt(e){throw new Error("RenderLayer.removeChildAt() is not available")}getChildAt(e){throw new Error("RenderLayer.getChildAt() is not available")}setChildIndex(e,t){throw new Error("RenderLayer.setChildIndex() is not available")}getChildIndex(e){throw new Error("RenderLayer.getChildIndex() is not available")}addChildAt(e,t){throw new Error("RenderLayer.addChildAt() is not available")}swapChildren(e,t){throw new Error("RenderLayer.swapChildren() is not available")}reparentChild(...e){throw new Error("RenderLayer.reparentChild() is not available with the render layer")}reparentChildAt(e,t){throw new Error("RenderLayer.reparentChildAt() is not available with the render layer")}};Qo.defaultOptions={sortableChildren:!1,sortFunction:(n,e)=>n.zIndex-e.zIndex};let ls=Qo;const wc=(n,e)=>{const t=so();U.useLayoutEffect(()=>{$n(O.dispatch,O.getState,n,e)},[n,e]),U.useLayoutEffect(()=>{const r=()=>$n(O.dispatch,O.getState,n,e);if(e){const s=new ResizeObserver(r);return s.observe(e),()=>s.disconnect()}else return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[t,e,n])},vc=()=>{const{cssUpscale:n,canvasSize:e,rotate90:t}=lr(pn);return t?`scale(${n}) rotate(90deg) translate(0, -${e.y}px)`:`scale(${n})`},bc=(n,e=console.error)=>(...t)=>{try{return n(...t)}catch(r){e(r);return}},ti=n=>{for(const[,l]of n)for(const[c]of l)l.set(c,!1);const e=Array.from(Sc(n));let t=e.length,r=t;const s=new Array(t),o={},i=Cc(e);for(;r--;)o[r]||a(e[r],r,new Set,null);return s;function a(l,c,u,d){if(u.has(l)){if(d!==null){const f=n.get(d);f?.has(l)&&f.set(l,!0)}return}if(o[c])return;o[c]=!0;const h=n.get(l),p=Array.from(h?.entries()??Vr);if(c=p.length){u.add(l);do{const[f,m]=p[--c];m||a(f,i.get(f),u,l)}while(c);u.delete(l)}s[--t]=l}};function Sc(n){const e=new Set;for(const[t,r]of n.entries()){e.add(t);for(const s of r.keys())e.add(s)}return e}function Cc(n){const e=new Map;for(let t=0,r=n.length;t<r;t++)e.set(n[t],t);return e}const Tc=(n,e,t,r)=>(n.has(e)||n.set(e,new Map),n.get(e).set(t,r),n),gt=(n,e,t)=>{const r=n.get(e);return r!==void 0&&(r.delete(t),r.size===0&&n.delete(e)),n},_r=1e-5,cs=-1,mt=(n,e,t,r,s)=>r-s>n&&t<e-s,_c=0,ri=1,ni=2,si=3,kc=(n,e)=>{const t=mt(n.zAxisProjectionMin,n.zAxisProjectionMax,e.zAxisProjectionMin,e.zAxisProjectionMax,_r),r=mt(n.xAxisProjectionMin,n.xAxisProjectionMax,e.xAxisProjectionMin,e.xAxisProjectionMax,_r),s=mt(n.yAxisProjectionMin,n.yAxisProjectionMax,e.yAxisProjectionMin,e.yAxisProjectionMax,_r);return r&&s&&t?ri:s&&t&&mt(n.xAxisProjectionMin,n.xAxisProjectionMax,e.xAxisProjectionMin,e.xAxisProjectionMax,cs)?ni:r&&t&&mt(n.yAxisProjectionMin,n.yAxisProjectionMax,e.yAxisProjectionMin,e.yAxisProjectionMax,cs)?si:_c},Ic=(n,e,t,r)=>{for(const s of Zi){const o=n[s],i=o+e[s],a=t[s],l=a+r[s];if(i<=a)return 1*(s==="z"?-1:1);if(o>=l)return-1*(s==="z"?-1:1)}return us(t)-us(n)},Mc=(n,e,t)=>{if(n.fixedZIndex!==void 0||e.fixedZIndex!==void 0)return 0;const r=n.renderAabbOffset?Se(n.state.position,n.renderAabbOffset):n.state.position,s=n.renderAabb||n.aabb,o=e.renderAabbOffset?Se(e.state.position,e.renderAabbOffset):e.state.position,i=e.renderAabb||e.aabb;switch(kc(t.getItemAxesProjections(n),t.getItemAxesProjections(e))){case ri:return Ic(r,s,o,i);case ni:return Ie(r.y,o.y+i.y)&&Ie(r.z,o.z+i.z)?1:Ie(o.y,r.y+s.y)&&Ie(o.z,r.z+s.z)?-1:0;case si:return Ie(r.x,o.x+i.x)&&Ie(r.z,o.z+i.z)?1:Ie(o.x,r.x+s.x)&&Ie(o.z,r.z+s.z)?-1:0;default:return 0}},us=n=>n.x+n.y-n.z,oi=(n,e=new Sa(Yr(n)),t=Yr(n),r=new Map)=>{const s=new Map;for(const[o,i]of r)if(!n[o])r.delete(o);else for(const[a]of i)n[a]||gt(r,o,a);for(const o of t)e.updateItemProjectedIndex(o);for(const o of t){if(o.fixedZIndex!==void 0)continue;const i=e.getItemProjectedNeighbourhood(o);{const a=r.get(o.id);a?.forEach((l,c)=>{i.has(n[c])||a.delete(c)}),r.forEach((l,c)=>{i.has(n[c])||gt(r,c,o.id)})}for(const a of i){if(a.fixedZIndex!==void 0||s.get(a)?.has(o))continue;const l=Mc(o,a,e);if(s.has(o)||s.set(o,new Set),s.get(o).add(a),l===0){gt(r,o.id,a.id),gt(r,a.id,o.id);continue}const c=l>0?o.id:a.id,u=l>0?a.id:o.id;Tc(r,u,c,!1),gt(r,c,u)}}return r},ds=n=>n.fixedZIndex!==void 0,Pc=n=>{const t=n.some(([,i])=>i==="intersects-rendered")?n.filter(([,i])=>i==="intersects-rendered").map(([i])=>i):n.map(([i])=>i);if(t.every(ds))return t.toSorted((i,a)=>a.fixedZIndex-i.fixedZIndex).at(0);const r=t.filter(i=>!ds(i));if(r.length===0)return;if(r.length===1)return r[0];const s=Object.fromEntries(r.map(i=>[i.id,i])),o=ti(oi(s));return s[o.at(-1)]},Rc=3,Ac=(n,{x:e,y:t},r)=>Ki.find(s=>{const o=Ca(n.state.position,n.aabb,s);return fn(Oe(o,{x:e,y:t}))<Rc}),rt=3,kr=1.5;function xe({x:n,y:e},t,r){const s={x:n-t.x,y:e-t.y},o=s.x*r.y-s.y*r.x;return Math.abs(o)/Ji(Math.hypot(r.x,r.y))}const ii={point:{x:-1,y:-1,z:0},normal:{x:0,y:0,z:1}},ai={point:{x:-1,y:0,z:1},normal:{x:0,y:1,z:0}},li={point:{x:0,y:-1,z:1},normal:{x:1,y:0,z:0}},ci={point:{x:0,y:1,z:1},normal:{x:1,y:0,z:0}},ui={point:{x:1,y:0,z:1},normal:{x:0,y:1,z:0}},di={point:{x:1,y:-1,z:0},normal:{x:0,y:0,z:1}},hi={point:{x:0,y:-1,z:-1},normal:{x:1,y:0,z:0}},pi={point:{x:-1,y:1,z:0},normal:{x:0,y:0,z:1}},fi={point:{x:-1,y:0,z:-1},normal:{x:0,y:1,z:0}},Oc=(n,e,t,r)=>{const{position:s}=n.state,{aabb:o}=n,i=t.x<0,a=t.y<0,l=t.z>0;if((i||a)&&xe(e,bn(s),{x:0,y:-1})<kr)return ii;if((i||l)&&xe(e,Sn(s,o),{x:2,y:-1})<kr)return ai;if((a||l)&&xe(e,Cn(s,o),{x:2,y:1})<kr)return li;switch(!0){case l:{const c=ka(s,o);if(xe(e,c,{x:2,y:1})<rt)return ci;if(xe(e,c,{x:-2,y:1})<rt)return ui;break}case a:{const c=_a(s,o);if(xe(e,c,{x:0,y:-1})<rt)return di;if(xe(e,c,{x:2,y:1})<rt)return hi;break}case i:{const c=Ta(s,o);if(xe(e,c,{x:0,y:-1})<rt)return pi;if(xe(e,c,{x:-2,y:1})<rt)return fi;break}}},Bc={z:1,x:0,y:0},zc={z:0,x:0,y:-1},hs={z:0,x:-1,y:0},Fc=(n,{x:e,y:t},r)=>{if(r.type==="item"&&r.item.type==="door"&&n.type==="wall"){const u=n.config.direction;return Qi(Ia[u],-1)}const{position:s}=n.state,{aabb:o}=n,i=bn(s),a=Cn(s,o),l=Sn(s,o);return t<a.y-(a.x-e)/2?t<l.y-(e-l.x)/2?Bc:hs:e<i.x?zc:hs},ps=(n,e,t)=>t?{position:n.state.position,aabb:n.aabb}:{position:Se(n.state.position,n.renderAabbOffset??ut),aabb:n.renderAabb??n.aabb},fs=({x:n,y:e},t,r)=>{const s=bn(t),o=Cn(t,r),i=Sn(t,r);return!(n<o.x||n>i.x||e<i.y-(i.x-n)/2||e<o.y-(n-o.x)/2||e>s.y-(n-s.x)/2||e>s.y-(s.x-n)/2)},Ec=(n,e,t)=>{const{position:r,aabb:s}=ps(t,e,!1);if(fs(n,r,s))return"intersects-rendered";if(e.type==="item"&&t.type==="wall"){const{position:i,aabb:a}=ps(t,e,!0);if(fs(n,i,a))return"intersects-unrendered"}return"non-intersecting"},gi=(n,e,t,r)=>{const s=t.type==="item"&&t.item.type==="door"?1:r,o=j.x*s,i=j.z,a=s===1?0:j.x/2,l=i/2,c=Ra(e);return{x:c==="yz"?Math.round(n.x/o)*o:Math.floor((n.x-a)/o)*o,y:c==="xz"?Math.round(n.y/o)*o:Math.floor((n.y-a)/o)*o,z:c==="xy"?Math.round(n.z/i)*i:Math.floor((n.z+l)/i)*i}},Lc=({state:{position:n},aabb:e},t,r,s,o)=>{const i={x:n.x+(t.x<0?0:e.x),y:n.y+(t.y<0?0:e.y),z:n.z+(t.z<0?0:e.z)},a=Pa(i,t,r);return gi(a,t,s,o)},Wc=n=>e=>{const t=Ma(e);return n.type==="item"&&n.item.type==="door"?t&&e.type==="wall":t},Ir=(n,e,t,r)=>{const s=Re(e.items).filter(Wc(t)).map(l=>[l,Ec(n,t,l)]).filter(l=>l[1]!=="non-intersecting"),o=Array.from(s),i=Pc(o),a=e.id;if(i){const l=Fc(i,n,t);if(!(l.z>0&&!Object.isExtensible(i.state.stoodOnBy)))return{roomId:a,scrXy:n,world:{itemId:i.id,onItem:{face:l,corner:Ac(i,n),edge:Oc(i,n,l)},position:Lc(i,l,n,t,r)}}}return{roomId:a,scrXy:n,world:void 0}},dt=40,Kt=(n,e,t)=>{const r=n.cssUpscale*n.gameEngineUpscale;if(t.target===null)throw new Error("Mouse event target is null");const s=t.target.getBoundingClientRect(),o=t.clientX-s.left,i=t.clientY-s.top;return{x:o/r+e.l-dt,y:i/r+e.t-dt}},Dc=(n,e)=>{const t=n.cssUpscale*n.gameEngineUpscale;if(e.target===null)throw new Error("Mouse event target is null");const r=e.movementX,s=e.movementY;return{x:r/t,y:s/t}},Uc=n=>{n.ticker.remove(n.render,n)},mi=U.createContext(null),$c=({children:n})=>{const[e,t]=U.useState(null);return U.useEffect(()=>{const r=new zo;return r.init({background:S.pureBlack,sharedTicker:!0,useBackBuffer:!0}).then(()=>{Uc(r),t(r)}),()=>{}},[]),e===null?null:se.jsx(mi,{value:e,children:n})},Fe=()=>U.useContext(mi),sr=(n,...e)=>n.levelEditor.wallsFloorsLocked&&e.some(t=>t.type==="wall"||t.type==="floor"),Qr=(n,e)=>{const t=O.getState();let r;if(e.world){const s=e.world.itemId,o=s&&n.items[s],i=sr(t,o)?void 0:o.jsonItemId;r=i===void 0?void 0:{jsonItemId:i,pointingAtOnItem:e.world.onItem}}else r=void 0;ce(uo(t),r)||O.dispatch(ho(r))},or=({levelEditor:n},e,t)=>{const r=e.items[t]?.jsonItemId;if(r===void 0)return;const s=po(n,r);if(s!==void 0)return[r,s]},{dispatch:Vc}=O;class Gc{handleMouseMove({roomState:e,pointingAt:t}){Qr(e,t)}handleMouseUp({roomState:e,pointingAt:t,storeState:r,isClick:s}){if(!s)return;const o=t.world?.itemId;if(o===void 0){console.warn("no itemId");return}const i=e.items[o];if(sr(r,i))return;const a=or(r,e,o);if(a===void 0)return;const[,l]=a;Vc(Tn({type:"item",item:{type:l.type,config:l.config}}))}handleMouseDown(e){}handleMouseLeave(e){}}const gs=(n,e,t)=>{const{world:{onItem:{face:r},position:s,itemId:o}}=n;if(r.z>ea)return Nt(s);if(t.type==="door"){const i=e.items[o];if(i.type!=="wall")return;const{config:a,aabb:l,state:{position:c}}=i,u=Aa(fo(a)),d=It(Be(a.direction)),h=Be(a.direction);if(u[d]<2)return;const p=c[d],f=c[d]+l[d]-Oa,m=c.z,g=c.z+l.z-Ba,x={[d]:Math.max(Math.min(s[d],f),p),[h]:s[h],z:Math.max(Math.min(s.z,g),m)};return Nt(x)}return Se(Nt(s),r)},{dispatch:xt}=O;class jc{handleMouseMove({pointingAtChanged:e,roomState:t,pointingAt:r,tool:s,storeState:o}){if(!e||(xt(Hr()),r.world===void 0))return;const i=or(o,t,r.world.itemId);if(i===void 0)return;const[,a]=i,l=gs(r,t,s.item);if(l===void 0)return;const{item:c}=s,u=c.type==="door"?ta(c,h=>{const p=t.items[r.world.itemId];h.config.direction=p.config.direction}):s.item;ll({roomState:t,blockPosition:l,itemTool:u})||xt(Hn({blockPosition:l,pointedAtItemJson:a,preview:!0}))}handleMouseUp({roomState:e,pointingAt:t,tool:r,storeState:s,isClick:o}){if(!o)return;if(t.world===void 0){xt(Tn({type:"pointer"}));return}const i=or(s,e,t.world.itemId);if(i===void 0)return;const[,a]=i,l=gs(t,e,r.item);l!==void 0&&xt(Hn({blockPosition:l,pointedAtItemJson:a,preview:!1}))}handleMouseDown(e){}handleMouseLeave(e){xt(Hr())}}const Hc=n=>mo(e=>e>0?e:e>-1?1:-e+1,n),Nc=({jsonItem:n,blockDragAccVec:e,resizeEdgeDirection:t})=>{const r=n.position,s=za(n),o=jt(e,t,go(n)),i=Se(s,o),a=Hc(i),l=mo((c,u,d,h,p)=>{const f=u<1;return c<0!==f?f?d-p+1:d+h-p:f?d+h-1:d},t,i,r,s,a);return{timesDelta:Gr(a,s),positionDelta:Gr(l,r)}},Xc=5,{dispatch:yt}=O,Yc=(n,e,t)=>{const r=t?.world?.itemId;if(r===void 0)return Ne;const s=e.items[r].jsonItemId;if(s===void 0)return Ne;const{selectedJsonItemIds:o}=n.levelEditor;return o.includes(s)?o:[s]},qc=(n,e,t)=>{const r=n.world?.onItem.edge,s=jt(...Te(t).map(l=>go(l))),o=jt(r?.point??ut,s);if(mn(o)>0)return r.normal;const i=jt(...Te(t).map(l=>ul(l))),a=$a(i);switch(a){case"xyz":return e?Vn:jr;case"x":case"y":case"xy":return jr;case"z":case"xz":return ra;case"yz":return Vn;case"":return;default:throw new Error(`unexpected movable vector description ${a}`)}},Zc=(n,e,t,r,s,o)=>{if(n===void 0)return;const i=Oe(e,n.scrXy),a=fn(i);if(!(s||a>Xc))return;const c=qc(n,r,o);if(c===void 0)return;const u=Ua(c,t);return r?{x:0,y:0,z:u.z}:u},ms=(n,e=!1)=>{const t=O.getState().levelEditor;return gi(n,jr,t.tool,e?1:t.gridResolution)};class Kc{handleMouseMove({roomState:e,pointingAt:t,storeState:r,mouseDownPointingAtRef:s,mouseEvent:o,upscale:i,dragAccVec:a,roomRenderSize:l}){const c=Dc(i,o),u=Yc(r,e,s.current);if(u.length===0){Qr(e,t);return}const d=u.map(w=>Fa(r,w));if(sr(r,...d))return;const p=t.roomId===s.current?.roomId?Zc(s.current,Kt(i,l,o),c,o.metaKey||o.shiftKey,a.current!==void 0,d):void 0;if(!p){Qr(e,t);return}u.length===1&&!Ea(r,u[0])&&O.dispatch(wr({jsonItemIds:u}));const f=s.current?.world?.onItem.edge,m=f&&d.every(w=>xo(w)),g=a.current??ut,x=Se(g,p),T=ms(x,m);if(a.current=x,gn(ms(g,m),T))return;const C=Nt(T);let v,y;if(m){const[,w]=or(r,e,s.current.world.itemId);({timesDelta:y,positionDelta:v}=Nc({jsonItem:w,blockDragAccVec:C,resizeEdgeDirection:f.point}))}else v=C;cl({roomState:e,jsonItemIds:u,blockPositionDelta:v,timesDelta:y})||yt(La({jsonItemIds:u,positionDelta:v,timesDelta:y}))}handleMouseUp({roomState:e,pointingAt:t,storeState:r,mouseEvent:s,isClick:o,isDragEnd:i}){if(o){const a=t.world===void 0?void 0:e.items[t.world.itemId];if(a?.jsonItemId===void 0||sr(r,a)){yt(wr({jsonItemIds:[]}));return}yt(s.ctrlKey||s.metaKey?Wa({jsonItemId:a.jsonItemId}):wr({jsonItemIds:[a.jsonItemId]}))}else i&&yt(Da())}handleMouseDown(e){}handleMouseLeave(e){yt(ho(void 0))}}const Vt={item:new jc,pointer:new Kc,eyeDropper:new Gc},Jc=n=>{const e=Fe(),t=lr(pn),r=so(),s=U.useRef(void 0),o=U.useRef(void 0),i=U.useRef(void 0);U.useEffect(()=>{if(n===null)return;const a=h=>{const p=O.getState(),f=Et(p),m=vr(p),g=Kt(t,m,h),x=wt(p),T=Ir(g,f,x,p.levelEditor.gridResolution),C=!ce(T.world,s.current?.world);Vt[x.type].handleMouseMove({pointingAtChanged:C,roomState:f,pointingAt:T,tool:x,storeState:p,mouseDownPointingAtRef:o,mouseEvent:h,upscale:t,dragAccVec:i,roomRenderSize:m}),s.current=T},l=h=>{const p=O.getState(),f=Et(p);if(f.id!==p.levelEditor.currentlyEditingRoomId)return;const m=vr(p),g=Kt(t,m,h),x=wt(O.getState()),T=Ir(g,f,x,p.levelEditor.gridResolution),C=i.current!==void 0,v=!C&&T.roomId===o.current?.roomId&&T.world?.itemId===o.current?.world?.itemId,y=o.current;if(i.current=void 0,o.current=void 0,O.dispatch(Va(!1)),!v&&!C){console.log("mouseUp - not a click or drag end - skipping");return}Vt[x.type].handleMouseUp({roomState:f,pointingAt:T,tool:x,storeState:p,mouseDownPointingAt:y,mouseEvent:h,upscale:t,isClick:v,isDragEnd:C})},c=h=>{const p=O.getState(),f=Et(p),m=wt(p);i.current=void 0,o.current=void 0,Vt[m.type].handleMouseLeave({roomState:f,tool:m,storeState:p,mouseEvent:h})},u=h=>{const p=O.getState(),f=Et(p),m=vr(p),g=Kt(t,m,h),x=wt(p),T=Ir(g,f,x,p.levelEditor.gridResolution);console.log("setting mouseDownPointingAtRef to",T),o.current=T,Vt[x.type].handleMouseDown({roomState:f,pointingAt:T,tool:x,storeState:p,mouseEvent:h,upscale:t})},d=bc(a);return n.addEventListener("mousemove",d),n.addEventListener("mouseup",l),n.addEventListener("mousedown",u),n.addEventListener("mouseleave",c),()=>{n.removeEventListener("mousemove",d),n.removeEventListener("mouseup",l),n.removeEventListener("mousedown",u),n.removeEventListener("mouseleave",c)}},[e.stage,t,n,r])},Qc={amigaHiResPal:"Amiga Hi-Res PAL",classicMac:"Classic Mac",amigaLowResPal:"Amiga Low-Res PAL",zxSpectrum:"ZX Spectrum",handheld:"Handheld"},eu=({selectedResolution:n,onResolutionChange:e})=>{const t=zt.indexOf(n),r=t<zt.length-1,s=t>0,{justDone:o,doneNow:i}=dl();return se.jsxs("div",{className:"absolute scale-editor top-0 right-1 z-slightlyAbove flex gap-0 leading-none text-white",children:[o>0&&se.jsx(br,{className:"px-1 bg-moss items-center flex",children:Qc[n]}),se.jsx(qn,{small:!0,disabled:!s,tooltipContent:`##zoom 

makes things look *smaller* by *increasing* emulated resolution`,onClick:()=>{s&&(e(zt[t-1]),i())},shortcutKeys:["-"],children:se.jsx(br,{children:"-"})}),se.jsx(qn,{small:!0,disabled:!r,tooltipContent:`##zoom 

makes things look *bigger* by *decreasing* emulated resolution`,onClick:()=>{r&&(e(zt[t+1]),i())},shortcutKeys:["+","="],children:se.jsx(br,{children:"+"})})]})},tu=n=>{const e=Fe();U.useEffect(()=>{if(n)return n.appendChild(e.canvas),()=>{n.removeChild(e.canvas)}},[n,e])},ru=n=>{const e=Fe(),[t]=U.useState(()=>new M({label:"editorPositioner"})),r=yo();U.useEffect(()=>{if(n.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return t.addChild(n.output.graphics),e.stage.addChild(t),()=>{e.stage.removeChild(t),t.removeChild(n.output.graphics)}},[n,e,t]),U.useEffect(()=>{t.x=-r.l+dt,t.y=-r.t+dt},[t,r])},nu=(n,e)=>{const t=U.useCallback(()=>{if(n===null)return;const r=Math.max(0,(n.scrollWidth-n.clientWidth)/2),s=Math.max(0,(n.scrollHeight-n.clientHeight)/2);n.scrollTo(r,s)},[n]);U.useEffect(()=>{if(n!==null)return oo({actionCreator:Nr,effect(){setTimeout(t,0)}})},[t,n]),U.useEffect(()=>{if(n===null||e===null)return;if(e.querySelector("canvas"))setTimeout(t,0);else{const s=new MutationObserver(()=>{e.querySelector("canvas")&&(t(),s.disconnect())});return s.observe(e,{childList:!0,subtree:!0}),()=>s.disconnect()}},[n,e,t])},su=()=>{const n=Fe(),e=lr(t=>t.upscale.upscale.gameEngineUpscale);n.stage.scale=e},ou=()=>{U.useEffect(()=>oo({actionCreator:Tn,effect(n,{dispatch:e}){e(Hr())}}))},iu=()=>{const n=Fe(),e=yo(),t=lr(r=>r.upscale.upscale);U.useEffect(()=>{const r=(2*dt+e.w)*t.gameEngineUpscale,s=(2*dt+e.h)*t.gameEngineUpscale;n.renderer?.resize(r,s)},[n.renderer,e,t])},au=({levelEditor:n})=>{const{dragInProgress:e,clickableAnnotationHovered:t,hoveredItem:r,selectedJsonItemIds:s}=n;if(e)return ne("cursor-grabbing");if(t)return ne("cursor-pointer");if(r){const o=po(n,r.jsonItemId);if(o!==void 0&&xo(o))if(r.pointingAtOnItem.corner){if(gn(r.pointingAtOnItem.corner,{x:1,y:1,z:1}))return ne("cursor-n-resize")}else{const{edge:i}=r.pointingAtOnItem;if(i){if(ce(i,pi))return ne("cursor-e-resize");if(ce(i,ii))return ne("cursor-s-resize");if(ce(i,di))return ne("cursor-w-resize");if(ce(i,ai)||ce(i,ci))return ne("cursor-ne-resize");if(ce(i,li)||ce(i,ui))return ne("cursor-nw-resize");if(ce(i,fi))return ne("cursor-se-resize");if(ce(i,hi))return ne("cursor-sw-resize")}}return s.includes(r.jsonItemId)?ne("cursor-grab"):ne("cursor-default")}return ne("cursor-crosshair")},lu=()=>Ga(au),P=new window.AudioContext,An=.1,bt=(n,e)=>{const t=P.currentTime+An;e.gain.linearRampToValueAtTime(0,t),n.stop(t),n.onended=()=>{n.disconnect(),e.disconnect()}},$e=(n,{gain:e,randomiseStartPoint:t},r)=>{const s=P.createGain(),o=e??s.gain.defaultValue;return t?(s.gain.setValueAtTime(0,P.currentTime),s.gain.linearRampToValueAtTime(o,P.currentTime+An)):e!==void 0&&(s.gain.value=e),n.connect(s),s.connect(r),s},en=()=>{throw new Error(`sounds not loaded - only call this from inside code 
      (like in a render loop) that is protected and only executed once 
      loading has happened`)},X=n=>{const e=typeof n=="string"?{soundId:n}:n,{playbackRate:t=1,soundId:r,connectTo:s,loop:o=!1,varyPlaybackRate:i=!1,randomiseStartPoint:a=!1}=e,l=P.createBufferSource(),c=en()[r];return l.buffer=c,l.loop=o,l.playbackRate.value=i?t-.05+Math.random()*.1:t,o&&a?l.start(0,c.duration*Math.random()):l.start(),s!==void 0&&l.connect(s),l},re=({start:n,change:e,loop:t,stop:r,startAndLoopTogether:s=!1,noStartOnFirstFrame:o=!0},i)=>{let a=!0,l,c,u;return d=>{if(!!d!=!!u)d?n!==void 0&&!(a&&o)?(l&&c&&(l.onended=null,bt(l,c)),l=X({...n}),c=$e(l,n,i),t!==void 0&&(s?(l=X({...t,loop:!0}),c=$e(l,t,i)):l.onended=()=>{u&&(l&&c&&(l.onended=null,bt(l,c)),l=X({...t,loop:!0}),c=$e(l,t,i))})):t!==void 0&&(l=X({...t,loop:!0}),c=$e(l,t,i)):(l&&l.loop&&c&&(l.onended=null,bt(l,c)),r!==void 0&&(l=X({...r}),c=$e(l,r,i)));else if(u!==d&&e!==void 0){const p=X({...e});c=$e(p,e,i)}a=!1,u=d}},cu={soundId:"fall"},uu={soundId:"woodScrape",gain:.8,randomiseStartPoint:!0,playbackRate:.8},du={soundId:"softBump"},hu=(n,e)=>{let t=!1;for(const r in n){if(r!==e)return!0;t=!0}return!t};class ee{constructor(e,t){this.renderContext=e;const r=P.createGain();r.connect(this.output),this.#e=re({loop:t?.fall??cu},r);const s=P.createGain();s.connect(this.output),this.#t=t?.standingOn===null?void 0:re({start:t?.standingOn??du,noStartOnFirstFrame:!0},s);const o=P.createGain();o.connect(this.output),this.#r=t?.collision&&re({start:t.collision,noStartOnFirstFrame:!0},o);const i=P.createGain();i.connect(this.output),this.#n=t?.pushed===null?void 0:re({loop:t?.pushed??uu},i)}output=P.createGain();#e;#t;#r;#n;currentPositionZ=0;tick({lastRenderRoomTime:e,movedItems:t},r=!1){const{renderContext:{item:s,room:{roomTime:o}}}=this,{state:{standingOnItemId:i,position:{z:a},vels:{gravity:{z:l}},actedOnAt:{roomTime:c,actedInXY:u,by:d},collidedWith:{roomTime:h,by:p}}}=s;if(this.#e!==void 0){const{currentPositionZ:f}=this,m=a<f&&l<0&&i===null;this.#e(m),this.currentPositionZ=a}if(this.#t!==void 0){const f=i!==null&&h>(e??Xr)&&p[i];this.#t(f)}if(this.#r!==void 0){const f=h>(e??Xr)&&!hl(cr(p));this.#r(f)}if(this.#n!==void 0){const f=!r&&o===c&&u&&i!==null&&hu(d,i)&&t.has(s);this.#n(f)}}destroy(){this.#e?.(!1),this.#n?.(!1)}}const xs={soundId:"rollingBallLoop",playbackRate:.5,gain:4};class pu{constructor(e){this.renderContext=e,this.#t=new ee(e,{pushed:xs,collision:{soundId:"ballHit",gain:.7,varyPlaybackRate:!0},standingOn:{soundId:"ballHit"}}),this.#t.output.connect(this.output)}output=P.createGain();#e=re({loop:xs},this.output);#t;tick(e){const{renderContext:{item:{state:{vels:{sliding:t},standingOnItemId:r}}}}=this,s=(t.x!==0||t.y!==0)&&r!==null;this.#e(s),this.#t.tick(e,s)}destroy(){this.#e(!1),this.#t.destroy()}}class fu{constructor(e){this.renderContext=e;const{item:{config:{was:t}}}=e;switch(t.type){case"pickup":{t.gives!=="scroll"&&X({soundId:"bonus",connectTo:this.output});break}case"disappearing":{X({soundId:"destroy",connectTo:this.output});break}case"hushPuppy":{this.output.gain.value=.5,X({soundId:"hushPuppyVanish",connectTo:this.output});break}}}output=P.createGain();tick(){}destroy(){}}class gu{constructor(e){this.renderContext=e,this.#e.connect(this.output)}output=P.createGain();#e=P.createGain();#t=void 0;tick(){const{renderContext:{item:{state:{pressed:e}}}}=this;this.#t!==void 0&&this.#t!==e&&X({soundId:"switchClick",playbackRate:e?.95:1.05,connectTo:this.#e}),this.#t=e}destroy(){}}class mu{constructor(e){this.renderContext=e,this.#e.connect(this.output),this.#e.gain.value=.5,this.#r=new ee(e,{collision:{soundId:"metalHit",gain:.3},pushed:{soundId:"heavyMetalScraping",gain:.4}}),this.#r.output.connect(this.output)}output=P.createGain();#e=P.createGain();#t=re({start:{soundId:"servoStart",playbackRate:.5},loop:{soundId:"servoLoop",playbackRate:.5},stop:{soundId:"servoStop",playbackRate:.5}},this.#e);#r;tick(e){const{renderContext:{item:t,room:{roomTime:r,items:s}}}=this,{state:{actedOnAt:{roomTime:o,by:i}}}=t,a=r===o&&Te(cr(i)).some(l=>wo(s[l]));this.#t(a),this.#r.tick(e,a)}destroy(){this.#t(!1),this.#r.destroy()}}const Pt=n=>{for(const e in n)return!0;return!1},Mr=2;class xu{constructor(e){this.renderContext=e}output=P.createGain();#e=re({start:{soundId:"conveyorStart",playbackRate:Mr},loop:{soundId:"conveyorLoop",playbackRate:Mr},stop:{soundId:"conveyorEnd",playbackRate:Mr}},this.output);tick(){const{renderContext:{item:{state:{stoodOnBy:e}}}}=this,t=Pt(e);this.#e(t)}destroy(){this.#e(!1)}}class yu{constructor(e){this.renderContext=e,this.#e=new ee(e,{standingOn:{soundId:"drum"}}),this.#e.output.connect(this.output)}output=P.createGain();#e;#t=!1;tick(e){const{renderContext:{item:{state:{stoodOnBy:t}}}}=this,r=Pt(t);!this.#t&&r&&X({soundId:"drum",connectTo:this.output}),this.#t=r,this.#e.tick(e)}destroy(){this.#e.destroy()}}class wu{constructor(e){this.renderContext=e,X({soundId:"hooter",connectTo:this.output})}output=P.createGain();tick(){}destroy(){}}const vu=3;class bu{constructor(e){this.renderContext=e,this.output.gain.value=.7}output=P.createGain();#e=X({soundId:"helicopter",loop:!0,connectTo:this.output});tick(){const{renderContext:{item:{state:{vels:{lift:{z:e}}}}}}=this;this.#e.playbackRate.value=Math.max(.5,1+vu*e)}destroy(){bt(this.#e,this.output)}}const Su={skiHead:{soundId:"softBump"},turtle:{soundId:"softBump"},dalek:{soundId:"metalHit",gain:.1},homingBot:{soundId:"metalHit",gain:.2},computerBot:{soundId:"metalHit",gain:.2}},ys={cyberman:{soundId:"jetpackTurnaround",gain:1.2},dalek:{soundId:"mojoTurn",gain:.3}},ws={cyberman:{soundId:"jetpackLoop",gain:.7},emperorsGuardian:{soundId:"jetpackLoop"},dalek:{soundId:"mojoLoop",gain:.2},bubbleRobot:{soundId:"bubbleRobotLoop"},helicopterBug:{soundId:"helicopter"},homingBot:{soundId:"lowHum",randomiseStartPoint:!0}},vs={homingBot:{start:{soundId:"detect"},loop:{soundId:"robotWhirLoop",gain:4},startAndLoopTogether:!0},computerBot:{loop:{soundId:"robotBeepingLoop",randomiseStartPoint:!0,varyPlaybackRate:!0}}};class Cu{constructor(e){this.renderContext=e,this.#e.connect(this.output),this.#t.connect(this.output),this.#t.gain.value=.66;const{item:{config:{which:t}}}=e,r=Su[t];this.#s=new ee(e,r?{collision:r}:void 0),this.#s.output.connect(this.output),ys[t]!==void 0&&(this.#r=re({change:ys[t]},this.#e)),vs[t]!==void 0&&(this.#o=re(vs[t],this.#e)),ws[t]!==void 0&&(this.#n=re({loop:ws[t]},this.#t))}output=P.createGain();#e=P.createGain();#t=P.createGain();#r;#n;#s;#o;tick(e){const{renderContext:{item:t}}=this,{state:{facing:r,activated:s,busyLickingDoughnutsOffFace:o,vels:{walking:i}}}=t;if(this.#r){const l=xn(r);this.#r(l)}if(this.#n){const l=s&&!o;this.#n(l)}const a=!gn(i,ut);this.#o&&this.#o(a),this.#s.tick(e,a)}destroy(){this.#n?.(!1),this.#o?.(!1),this.#s.destroy()}}class Tu{constructor(e){this.renderContext=e,this.#e=new ee(e,{pushed:null}),this.#e.output.connect(this.output)}output=P.createGain();#e;tick(e){this.#e.tick(e)}destroy(){this.#e.destroy()}}const _u=n=>{if(ja(n))return n.state;if(Ha(n))return n.state.heels},ku=.8,Iu=1.2,Mu=.8;class Pr{constructor(e){this.renderContext=e;const{general:{soundSettings:t},item:{type:r}}=e;(t.noFootsteps??yn.soundSettings.noFootsteps)||(this.#e=P.createGain(),this.#e.gain.value=ku,this.#e.connect(this.output),this.#t=re({loop:{soundId:`${r==="headOverHeels"?"heels":r}Walk`}},this.#e)),this.#r.gain.value=Mu,this.#r.connect(this.output),this.#s.gain.value=Iu,this.#s.connect(this.output),this.#n=re({start:{soundId:`${r==="headOverHeels"?"head":r}Jump`}},this.#r),this.#i=new ee(e,{fall:r==="headOverHeels"||r==="head"?{soundId:"headFall"}:void 0,standingOn:{soundId:"softBump"},collision:{soundId:"softBump",gain:.5}}),this.#i.output.connect(this.output)}output=P.createGain();#e;#t;#r=P.createGain();#n;#s=P.createGain();#o=re({start:{soundId:"carry",playbackRate:.95},stop:{soundId:"carry",playbackRate:1.05}},this.#s);#i;#a=null;tick(e){const{renderContext:{item:t}}=this,{state:{action:r,teleporting:s,jumpStartZ:o,jumped:i,standingOnItemId:a,position:{z:l},vels:{gravity:{z:c}}}}=t,u=_u(t),d=s?s.phase:null,h=i&&l>o&&l>this.#i.currentPositionZ&&c>0;this.#n(h);const p=l<this.#i.currentPositionZ&&c<0&&a===null,f=!h&&!p&&r==="moving";if(this.#t!==void 0&&this.#t(f),u!==void 0&&this.#o(u.carrying!==null),d!==null&&d!==this.#a)if(d==="in"){const m=en().teleportIn,g=P.createBufferSource();g.buffer=m,g.connect(this.output),g.start()}else{const m=en().teleportOut,g=P.createBufferSource();g.buffer=m,g.connect(this.output),g.start()}this.#a=d,this.#i.tick(e,f||r==="falling")}destroy(){this.#t?.(!1),this.#n(!1),this.#o(!1),this.#i.destroy()}}class Pu{constructor(e){this.renderContext=e,this.#e=new ee(e,{standingOn:{soundId:"metalHit"},pushed:{soundId:"heavyMetalScraping",gain:.4}}),this.#e.output.connect(this.output)}output=P.createGain();#e;tick(e){this.#e.tick(e)}destroy(){this.#e.destroy()}}const Ru={collision:{soundId:"glassClink",varyPlaybackRate:!0,gain:.8},pushed:{soundId:"iceScrape",varyPlaybackRate:!0,randomiseStartPoint:!0}};class Au{constructor(e){this.renderContext=e,this.#e=new ee(e,e.item.config.style==="puck"?Ru:void 0),this.#e.output.connect(this.output)}output=P.createGain();#e;tick(e){this.#e.tick(e)}destroy(){this.#e.destroy()}}class Ou{constructor(e){this.renderContext=e,this.#e=new ee(e,{collision:{soundId:"glassClink",varyPlaybackRate:!0,gain:.8,playbackRate:1.5},pushed:{soundId:"glassClink",varyPlaybackRate:!0,playbackRate:1.5}}),this.#e.output.connect(this.output)}output=P.createGain();#e;tick(e){this.#e.tick(e)}destroy(){this.#e.destroy()}}class Bu{constructor(e){this.renderContext=e;const{item:{state:t}}=e;t.played===!1&&(this.#e=X(e.item.config.soundOptions),$e(this.#e,e.item.config.soundOptions,this.output),t.played=!0)}output=P.createGain();#e;tick(e){}destroy(){this.#e!==void 0&&bt(this.#e,this.output)}}class zu{constructor(e){this.renderContext=e,this.#e=new ee(e),this.#e.output.connect(this.output)}output=P.createGain();#e;tick(e){const{renderContext:{item:{state:{stoodOnBy:t,stoodOnUntilRoomTime:r}}}}=this,s=Pt(t);e.lastRenderRoomTime!==void 0&&r>e.lastRenderRoomTime&&!s&&X({soundId:"springBoing",connectTo:this.output}),this.#e.tick(e)}destroy(){this.#e.destroy()}}class Fu{constructor(e){this.renderContext=e,this.#e.connect(this.output)}output=P.createGain();#e=P.createGain();#t=void 0;tick(){const{renderContext:{item:{state:{setting:e},config:t}}}=this,r=t.type==="in-store"?io(O.getState().gameMenus,t.path)?"right":"left":e;this.#t!==void 0&&this.#t!==r&&X({soundId:"switchClick",playbackRate:r==="right"?.95:1.05,connectTo:this.#e}),this.#t=r}destroy(){}}const Rt=(n,e)=>Te(cr(n)).map(t=>{const r=e.items[t];if(r===void 0)throw new Error(`item ${t} in stoodOnBy is not in the room`);return r}),xi=n=>{let e=2166136261;const t=n.length;for(let r=Math.max(0,t-9);r<t;r++)e^=n.charCodeAt(r),e=Math.imul(e,1540483477),e^=e>>>15;return(e>>>0)/4294967295},Eu=1e3/25,yi=n=>{const e=Mt.animations[n],t=e.length,{animationSpeed:r}=e;return t*Eu/r};yi("bubbles.white");yi("head.fadeOut");const On=({config:{activatedOnStoreValue:n}})=>n===void 0?!0:!!na(O.getState().gameMenus.gameInPlay,n);class Lu{constructor(e){this.renderContext=e}output=P.createGain();#e=re({loop:{soundId:"teleportWarningSiren"}},this.output);tick(){const{renderContext:{item:e,room:t}}=this;this.#e(On(e)&&Rt(e.state.stoodOnBy,t).some(_n))}destroy(){this.#e(!1)}}const Wu=(n,e)=>To(Rt(n.state.stoodOnBy,e).filter(vo));class Du{constructor(e){this.renderContext=e,this.output.gain.value=2}output=P.createGain();#e=void 0;tick(e){const{renderContext:{item:t,room:r}}=this,s=Wu(t,r);this.#e!==void 0&&s<this.#e&&X({soundId:"toasterPopUpSoundUrl",connectTo:this.output}),this.#e=s}destroy(){}}const Uu={lift:bu,switch:Fu,button:gu,bubbles:fu,head:Pr,heels:Pr,headOverHeels:Pr,teleporter:Lu,monster:Cu,conveyor:xu,spring:zu,portableBlock:ee,charles:mu,ball:pu,pushableBlock:Pu,firedDoughnut:wu,slidingBlock:Au,pickup:ee,movingPlatform:Tu,moveableDeadly:ee,slidingDeadly:Ou,soundEffect:Bu,sceneryPlayer:ee,sceneryCrown:ee},$u=n=>{if(n.item.type==="deadlyBlock"&&n.item.config.style==="toaster")return new Du(n);if(n.item.type==="portableBlock"&&n.item.config.style==="drum")return new yu(n);const e=Uu[n.item.type];if(e)return new e(n)},bs=j.z*-1,Ss=j.z*Xa,Vu=0,Gu=j.x*16,ju={x:0,y:0,z:0},Rr=(n,e,t)=>(n-e)/(t-e)*2-1,Hu=.3,Nu=.3;class Xu{constructor(e,t){this.renderContext=e,this.childRenderer=t,t.output.connect(this.output),this.output.rolloffFactor=2,this.output.maxDistance=5,this.output.distanceModel="exponential";const r=Na(e.room).floors;this.#e=r.edgeLeftX,this.#t=r.edgeRightX}output=P.createPanner();#e;#t;tick(e){this.childRenderer.tick(e);const{item:t}=this.renderContext,r=t.state,s=sa(oa(ju,t.aabb,.5),r.position),o=Rr(Xt(s),this.#e,this.#t),i=Rr(s.z,bs,Ss);if(!Number.isFinite(i))throw new Error(`y position for sound rendering is not finite;
        positionY = numberInRangeToMinus1To1Range(
          itemCentrePosition = ${s.z},
          ${bs},
          ${Ss},
        );
        itemCentrePosition = addXyz(
          itemState.position = ${JSON.stringify(r.position)},
          scaleXyz(${JSON.stringify(t.aabb)}, 0.5),
        )`);const a=Rr(s.x+s.y,Vu,Gu);this.output.positionX.value=o*Hu,this.output.positionY.value=i,this.output.positionZ.value=a*Nu}destroy(){this.childRenderer.destroy()}}const wi={white:{basic:{main:"white",edges:{towards:{hue:"cyan",dimInOriginal:!1},right:{hue:"yellow",dimInOriginal:!0}},hud:{brightHue:"yellow",dimmedHue:"magenta",icons:"cyan"}},dimmed:{main:"white",edges:{towards:{hue:"green",dimInOriginal:!1},right:{hue:"cyan",dimInOriginal:!0}},hud:{brightHue:"yellow",dimmedHue:"magenta",icons:"cyan"}}},yellow:{basic:{main:"yellow",edges:{towards:{hue:"green",dimInOriginal:!1},right:{hue:"white",dimInOriginal:!0}},hud:{brightHue:"cyan",dimmedHue:"magenta",icons:"green"}},dimmed:{main:"yellow",edges:{towards:{hue:"cyan",dimInOriginal:!0},right:{hue:"cyan",dimInOriginal:!1}},hud:{brightHue:"cyan",dimmedHue:"magenta",icons:"green"}}},magenta:{basic:{main:"magenta",edges:{towards:{hue:"green",dimInOriginal:!0},right:{hue:"cyan",dimInOriginal:!0}},hud:{brightHue:"white",dimmedHue:"cyan",icons:"yellow"}},dimmed:{main:"magenta",edges:{towards:{hue:"green",dimInOriginal:!0},right:{hue:"cyan",dimInOriginal:!0}},hud:{brightHue:"white",dimmedHue:"cyan",icons:"yellow"}}},cyan:{basic:{main:"cyan",edges:{towards:{hue:"magenta",dimInOriginal:!1},right:{hue:"white",dimInOriginal:!1}},hud:{brightHue:"white",dimmedHue:"green",icons:"yellow"}},dimmed:{main:"cyan",edges:{towards:{hue:"magenta",dimInOriginal:!0},right:{hue:"white",dimInOriginal:!0}},hud:{brightHue:"white",dimmedHue:"green",icons:"yellow"}}},green:{basic:{main:"green",edges:{towards:{hue:"cyan",dimInOriginal:!1},right:{hue:"yellow",dimInOriginal:!1}},hud:{brightHue:"white",dimmedHue:"magenta",icons:"cyan"}},dimmed:{main:"green",edges:{towards:{hue:"cyan",dimInOriginal:!0},right:{hue:"yellow",dimInOriginal:!0}},hud:{brightHue:"white",dimmedHue:"magenta",icons:"cyan"}}}},Yu=n=>wi[n.hue][n.shade],Cs={head:"pastelBlue",heels:"pink"},Ts=(n,e)=>{const t=Yu(n.color).edges[e];return ct(t.hue,t.dimInOriginal?"dimmed":"basic")},qu=Tt.filter(n=>n.startsWith("door.")),tn=n=>/\.floor$/.test(n),rn=n=>/\.wall\.[^.]+\.(away|left)$|door\.legs\.pillar/.test(n),_s=n=>/door\.legs\.pillar/.test(n),Zu=n=>/\.wall\.[^.]+\.left$/.test(n),Ar=n=>tn(n)||rn(n),Ku=(n,e,t)=>({ambient:[{lutType:"sparse",paletteSwaps:Z(t.hue,t.shade==="dimmed")},t.shade==="basic"?vi(e,t):{lutType:"sparse",paletteSwaps:{...dr}}],textureSpecific:[...Qu(e,t),...Ju(e,t),...ed(t)],noReplacePlaceholderTextures:qu}),Ju=(n,e)=>{const{edges:t}=wi[e.hue][e.shade],r=Z(t.right.hue,e.shade==="dimmed","light-mid"),s=Z(t.towards.hue,e.shade==="dimmed","mid-dark");return[{textureIds:["floorEdge.half.right","floorEdge.right","generic.door.floatingThreshold.y"],paletteSwaps:r},{textureIds:["floorEdge.half.towards","floorEdge.towards","generic.door.floatingThreshold.x"],paletteSwaps:s}]},Qu=(n,e)=>{if(n==="jail")return[{textureIds:Ar,paletteSwaps:Z(e.hue,e.shade==="dimmed","mid-dark")}];if(n==="blacktooth"&&e.shade==="dimmed")return[{textureIds:rn,paletteSwaps:Z(e.hue,!0,"light-mid")}];if(e.hue==="white"||e.hue==="yellow")switch(n){case"market":return[{textureIds:Ar,paletteSwaps:Z(e.hue,e.shade==="dimmed","mid-dark")}];case"egyptus":return[{textureIds:_s,paletteSwaps:Z(e.hue,e.shade==="dimmed","light-dark")},{textureIds:tn,paletteSwaps:Z(e.hue,e.shade==="dimmed","mid-dark")},{textureIds:Zu,paletteSwaps:Z(e.hue,e.shade==="dimmed","light-mid")},{textureIds:rn,paletteSwaps:Z(e.hue,e.shade==="dimmed","mid-dark")}];case"moonbase":case"penitentiary":case"safari":case"bookworld":return[{textureIds:tn,paletteSwaps:Z(e.hue,e.shade==="dimmed","mid-dark")}];case"blacktooth":return[{textureIds:_s,paletteSwaps:Z(e.hue,e.shade==="dimmed","light-dark")},{textureIds:Ar,paletteSwaps:Z(e.hue,e.shade==="dimmed","light-mid")}]}return Ne},ed=n=>{const{hue:e,shade:t}=n;return e==="white"||e==="yellow"?[{textureIds:["book.x","book.y"],paletteSwaps:{...Z(e,t==="dimmed","light-mid"),shadow:pl(`swop_${e}Dim`,t==="dimmed")}}]:t==="dimmed"?[{textureIds:["book.x","book.y"],paletteSwaps:{...Z(n.hue,!0,n.hue==="cyan"?"light-mid":"mid-dark")}}]:Ne},td={blacktooth:{pureBlack:Le(S.moss,.15)},safari:{pureBlack:Le(S.moss,.17)},jail:{pureBlack:Le(S.redShadow,.2)},egyptus:{pureBlack:Le(S.redShadow)},moonbase:{shadow:S.shadow_greyBlue,pureBlack:Le(S.metallicBlue,.2)},bookworld:{shadow:S.shadow_brown,pureBlack:Le(S.highlightBeige,.1)},penitentiary:{pureBlack:Le(S.midGrey,.2)}},rd={yellow:{shadow:S.shadow_brown},white:{shadow:S.shadow_greyBlue},magenta:{shadow:S.shadow_magenta},cyan:{shadow:S.shadow_blue}},vi=(n,e)=>({lutType:"sparse",paletteSwaps:{...rd[e.hue]??Xe,...td[n]??Xe}}),Bn=6;function*nd(n,e,t,r=1){const s=2**Bn-1,o=Math.floor(n*s+.5),i=Math.floor(e*s+.5),a=Math.floor(t*s+.5);for(let l=-r;l<=r;l++)for(let c=-r;c<=r;c++)for(let u=-r;u<=r;u++){const d=o+l,h=i+c,p=a+u;if(d<0||d>s||h<0||h>s||p<0||p>s)continue;const f=Math.sqrt(l*l+c*c+u*u),m=p%8*64,g=Math.floor(p/8)*64,x=m+d,T=g+h;yield{x,y:T,distance:f}}}const Ae=(2**Bn)**(3/2),bi=Ae*Ae,sd=n=>{const e=new Uint8Array(bi*4);for(const r of fl)for(const[s,o]of ia(n)){const i=S[s];for(const{x:a,y:l,distance:c}of nd(i.red*r,i.green*r,i.blue*r,2)){const u=l*Ae+a,d=e[u*4+3],h=Math.max(1,Math.floor(255-c/1.732*254));(d===0||h>d)&&(e[u*4+0]=Math.floor(o.red*r*255),e[u*4+1]=Math.floor(o.green*r*255),e[u*4+2]=Math.floor(o.blue*r*255),e[u*4+3]=h)}}for(let r=3;r<e.length;r+=4)e[r]>0&&(e[r]=255);return q.from({resource:e,width:Ae,height:Ae,scaleMode:"nearest",antialias:!1})},{floor:Gt,min:od}=Math,id=n=>{if(n instanceof Map)return n;const e=new Map,t=Object.entries(n);for(const[r,s]of t){const o=S[r],i=typeof s=="string"?S[s]:s;e.set(o,i)}return e},ks={red:0,blue:0,green:0},ad=9;function ld(n){const e=id(n),t=new Uint8Array(bi*4).fill(255),r=e.keys().toArray(),s=e.values().map(g=>({red:Gt(g.red*255),green:Gt(g.green*255),blue:Gt(g.blue*255)})).toArray(),o=r.length,i=2**Bn,a=1/(i-1),l=new Array(o),c=new Array(o),u=[];let d=0;for(let g=0;g<i;g++){const x=new Array(o);for(let T=0;T<o;T++){const C=d-r[T].green;x[T]=C*C}u[g]=x,d+=a}const h=[];let p=0;for(let g=0;g<i;g++){const x=new Array(o);for(let T=0;T<o;T++){const C=p-r[T].red;x[T]=C*C}h[g]=x,p+=a}let f=0;for(let g=0;g<i;g++){const x=g%8*64,T=Gt(g/8)*64;for(let C=0;C<o;C++){const v=f-r[C].blue;l[C]=v*v}for(let C=0;C<i;C++){const v=u[C];let b=(T+C)*Ae+x<<2;for(let w=0;w<o;w++)c[w]=l[w]+v[w];for(let w=0;w<i;){const k=h[w];let B=ks,W=9999;for(let A=0;A<o;A++){const F=c[A]+k[A];F<W&&(B=s[A],W=F)}let R=1;const $=od(w+ad,i-1);for(let A=$;A>w;A--){let F=ks,V=9999;const H=h[A];for(let E=0;E<o;E++){const D=c[E]+H[E];D<V&&(F=s[E],V=D)}if(F===B){R=A-w+1;break}}for(let A=0;A<R;A++)t[b++]=B.red,t[b++]=B.green,t[b]=B.blue,b+=2;w+=R}}f+=a}return q.from({resource:t,width:Ae,height:Ae,scaleMode:"nearest",antialias:!1})}var cd=`#version 300 es
precision highp float;in vec2 vTextureCoord;out vec4 finalColor;uniform sampler2D uTexture;uniform sampler2D uLut;uniform sampler2D uMask;const float lutW=512.0;ivec2 blockEncode(vec3 color){ivec3 c6=ivec3(floor(color*63.0+0.5));int blockX=(c6.b % 8)*64;int blockY=(c6.b/8)*64;int x=blockX+c6.r;int y=blockY+c6.g;return ivec2(x,y);}vec4 lutColourReplace(sampler2D lut,vec4 inputColour){ivec2 lutPos=blockEncode(inputColour.rgb);vec2 normalizedPos=vec2((float(lutPos.x)+0.5)/lutW,(float(lutPos.y)+0.5)/lutW);vec4 replacementColour=texture(lut,normalizedPos);float shouldReplace=step(0.99,inputColour.a)*step(0.004,replacementColour.a);vec4 replacement=vec4(replacementColour.rgb,inputColour.a);return mix(inputColour,replacement,shouldReplace);}void main(void){vec4 c=texture(uTexture,vTextureCoord);float maskVal=texture(uMask,vTextureCoord).r;finalColor=mix(c,lutColourReplace(uLut,c),maskVal);}`;const ud=Ke.from({vertex:Je,fragment:cd,name:"palette-swop-filter1"});class St extends Ze{constructor({paletteSwaps:e,lutType:t},r=q.WHITE){const s=(t==="voronoi"?ld:sd)(e);super({glProgram:ud,resources:{colorReplaceUniforms:{},uLut:s.source,uMask:r.source}}),this.mask=r,this.#e=s}#e;destroy(e){const t=e===!0||typeof e=="object"&&e.destroyPrograms,r=e===!0||typeof e=="object"&&e.destroyLutTexture,s=this.lutTexture!==q.WHITE&&e===!0||typeof e=="object"&&e.destroyMask;r&&this.#e?.destroy(!0),this.#e=null,s&&this.mask?.destroy(!0),super.destroy(t)}get lutTexture(){return this.#e}}const Si={ambient:[]},dd=Te(Tt).filter(n=>n.startsWith("shadow.")||n.startsWith("shadowMask.")||n.startsWith("hud.")).toArray(),hd=n=>typeof n=="function"?Te(Tt).filter(n):n,pd=(n,e)=>new St({paletteSwaps:ao(S,([t])=>t==="replaceDark"||t==="replaceLight"?[t,n]:[t,e]),lutType:"sparse"}),fd=(n,{ambient:e,textureSpecific:t=Ne,noReplacePlaceholderTextures:r=Ne},s=aa())=>{const o=[];for(const{textureIds:u,paletteSwaps:d}of t){const h=Gn(n,{rects:{textureIds:u,color:xr},clearColour:yr}),p=new St({paletteSwaps:d,lutType:"sparse"},h);o.push(p)}const i=r.length>0?pd(yr,xr):void 0,a=Gn(n,{clearColour:xr,rects:{textureIds:ca(dd,Te(t).filter(({dodgeAmbient:u})=>u).flatMap(({textureIds:u})=>hd(u))),color:yr},placeholderColoursMasks:i?{textureIds:r,filter:i,originalSpritesheet:_t()}:void 0});i?.destroy({destroyLutTexture:!0,destroyMask:!0});for(const u of e){const d=new St(u,a);o.push(d)}const l=new le(s);l.filters=o;const c=Ye.create({width:s.width,height:s.height});n.render({container:l,target:c}),l.destroy(!1),a.destroy();for(const u of o)u instanceof St?u.destroy({destroyLutTexture:!0,destroyMask:!0,destroyPrograms:!1}):u.destroy(!1);return c},At=(n,e,t)=>{const r=fd(n,e,t),s=new la(r.source,structuredClone(Mt));return s.parseSync(),s.textureSource.scaleMode="nearest",s},zn={ambient:[{paletteSwaps:dr,lutType:"sparse"}]},ir=(n,e,t)=>{const r=q.from(e.textureSource),s=At(n,t,r);return r.destroy(),e.textureSource.destroy(),e.destroy(!0),s};let at,nn=Si;const gd=()=>{at!==void 0&&(at.textureSource.destroy(),at.destroy(!0),at=void 0)},md=(n,e,t,r)=>{gd(),nn=Ku(e,t,r)??Si,at=At(n,nn)},xd=()=>at,Jt=n=>{let e=S[n];for(const t of nn.ambient)e=t.paletteSwaps[n]??e;return e};let Ve;const Fn={lightBeige:S.lightGrey,redShadow:S.shadow,pink:S.lightGrey,moss:S.lightGrey,midRed:S.midGrey,highlightBeige:S.lightGrey,pastelBlue:S.lightGrey,metallicBlue:S.midGrey,replaceLight:S.lightGrey,replaceDark:S.midGrey},yd=lo(Fn,"metallicBlue","pastelBlue"),wd=lo(Fn,"pink"),vd={ambient:[{paletteSwaps:Fn,lutType:"sparse"}],textureSpecific:[{textureIds:Tt.filter(n=>n.startsWith("head.")),paletteSwaps:yd,dodgeAmbient:!0},{textureIds:Tt.filter(n=>n.startsWith("heels.")),paletteSwaps:wd,dodgeAmbient:!0}]},bd=()=>{Ve!==void 0&&(Ve.textureSource.destroy(),Ve.destroy(!0),Ve=void 0)},Sd=(n,e,t)=>{bd();let r=At(n,vd);t.shade==="dimmed"?r=ir(n,r,zn):r=ir(n,r,{ambient:[vi(e,t)]}),Ve=r},Cd=()=>{if(Ve===void 0)throw new Error("swopped spritesheet undefined - should only be called when we know for sure it is available");return Ve};let Ge;const Td={midGrey:S.midRed,lightGrey:S.lightBeige,white:S.highlightBeige,metallicBlue:S.redShadow,shadow:S.redShadow,pastelBlue:S.lightBeige,pink:S.midRed,moss:S.midRed,replaceDark:S.midRed,replaceLight:S.lightBeige},_d=()=>{Ge!==void 0&&(Ge.textureSource.destroy(),Ge.destroy(!0),Ge=void 0)},kd=(n,e)=>{_d();let t=At(n,{ambient:[{paletteSwaps:Td,lutType:"sparse"}]});e&&(t=ir(n,t,zn)),Ge=t},Id=()=>{if(Ge===void 0)throw new Error("swopped spritesheet undefined - should only be called when we know for sure it is available");return Ge};let je;const Md={pastelBlue:S.moss,metallicBlue:S.moss,pink:S.moss},Pd=()=>{je!==void 0&&(je.textureSource.destroy(),je.destroy(!0),je=void 0)},Rd=(n,e)=>{Pd();let t=At(n,{ambient:[{paletteSwaps:Md,lutType:"sparse"}]});e&&(t=ir(n,t,zn)),je=t},Ad=()=>{if(je===void 0)throw new Error("swopped spritesheet undefined - should only be called when we know for sure it is available");return je},Od=()=>{throw new Error("swopped spritesheet undefined - should only be called when we know for sure it is available")},kt=n=>{try{switch(n){case"original":return _t();case"deactivated":return Cd();case"doughnutted":return Id();case"for-current-room":return xd();case"sceneryPlayer":return Ad();case"uncolourised":return Od();default:return n}}catch(e){throw new Error(`could not get spritesheet variant "${n}"`,{cause:e})}},Or={x:.5,y:1},Is=n=>typeof n!="string"&&Object.hasOwn(n,"animationId"),sn=n=>{const{anchor:e,flipX:t,pivot:r,x:s,y:o,times:i,label:a}=n;if(n.times){const c=Ya(i);if(mn(c)>=2){const d=new M({label:a??"timesXyz"});for(let{x:h}=c;h>=1;h--)for(let{y:p}=c;p>=1;p--)for(let f=1;f<=c.z;f++){const m={...n,label:`(${h},${p},${f})`,...n.subSpriteVariations?.(h-1,p-1,f-1),subSpriteVariations:void 0};"randomiseStartFrame"in m&&(m.randomiseStartFrame=`${m.randomiseStartFrame}${h},${p},${f}`),delete m.times;const g=sn(m),x=qe({x:h-1,y:p-1,z:f-1});g.x+=x.x,g.y+=+x.y,d.addChild(g)}return d}}if(n.subSpriteVariations!==void 0)return sn({...n,...n.subSpriteVariations(0,0,0),subSpriteVariations:void 0});let l;if(Is(n))l=Bd(n);else{const{textureId:c}=n,u=kt(n.spritesheetVariant??"original");l=new le(c!==void 0?u.textures[c]:q.EMPTY)}if(e===void 0&&r===void 0)if(Is(n))l.anchor=Or;else{const{textureId:c}=n,u=c!==void 0?kt(n.spritesheetVariant??"original").data.frames[c]:void 0;if(u!==void 0){const d=u.frame;d.pivot!==void 0?l.pivot=d.pivot:l.anchor=Or}else l.anchor=Or}else e!==void 0&&(l.anchor=e),r!==void 0&&(l.pivot=r);return s!==void 0&&(l.x=s),o!==void 0&&(l.y=o),a!==void 0&&(l.label=a),l.eventMode="static",t===!0&&(l.scale.x=-1),l},Ci=(n,e=!1)=>{const t=ve.shared.speed,r=e||t===0?0:Math.sqrt(t)/t;return Mt.animations[n].animationSpeed*r},Ti=n=>n.map(e=>({texture:e,time:ua}));function Bd({animationId:n,reverse:e,playOnce:t,paused:r,randomiseStartFrame:s,spritesheetVariant:o}){const i=kt(o).animations[n],a=Ti(i);e&&a.reverse();const l=new ge(a);return l.animationSpeed=Ci(n,r),l.gotoAndPlay(s!==void 0?Math.floor(xi(s)*a.length):0),t!==void 0&&(l.loop=!1,l.onComplete=()=>{l.stop(),t==="and-destroy"&&(l.visible=!1)}),l}const _=sn,zd={Container:"",Sprite:"",UniqueTextureSprite:"",Graphics:"",Text:"",AnimatedSprite:"",TilingSprite:"",BitmapText:"",Mesh:"",NineSliceSprite:""},Fd=n=>{const e=n.constructor.name;return e.startsWith("_")?e.slice(1):e},Ed=n=>zd[n]||"",Ld=n=>{const e=[];try{(n.x!==0||n.y!==0)&&e.push(`@(x=${n.x}, y=${n.y})`)}catch{e.push("@(ERROR)")}if(n.children.length>0&&e.push(`children: ${n.children.length}`),n.visible||e.push("hidden"),n.alpha<1&&e.push(`alpha: ${n.alpha.toFixed(2)}`),n.mask&&e.push(" masked"),n instanceof le)if(n.texture===null||n.texture===void 0)e.push("texture: NO TEXTURE");else{const t=n.texture.label||"(anon texture)";e.push(`texture: "${t}"`)}return e},Wd=(n,e)=>n.label&&n.label!==e?` "${n.label}"`:"",ar=(n,e="",t=!0,r=!0,s=[])=>{const o=[];r&&o.push("");const i=Fd(n);let a=Ed(i);s.forEach((h,p)=>{h.mask===n&&(p===0?a+="":a+=`^${p+1}`)});const l=Wd(n,i),c=Ld(n),u=r?"":e+(t?" ":" ");if(o.push(`${u}${a} ${i}${l}`),c.length>0){const h=n.children.length>0,p=r?h?"  ":"   ":e+(t?"    ":"   ")+(h?"  ":"   ");c.forEach(f=>{o.push(`${p} ${f}`)})}const d=r?"":e+(t?"    ":"   ");return n.children.forEach((h,p)=>{const f=p===n.children.length-1;o.push(ar(h,d,f,!1,[n,...s]))}),o.join(`
`)+(r?`
`:"")};class Dd extends ge{destroy(e){const t=this.textures.map(r=>"texture"in r?r.texture:r).filter(r=>r instanceof Ye);super.destroy(e);for(const r of t)r.destroy(!0)}}class Ud extends le{constructor(...e){const[t]=e;super(t)}destroy(e){const t=this.texture!==null;typeof e=="boolean"?super.destroy({texture:t,textureSource:this.texture instanceof Ye,children:e}):super.destroy({...e,texture:t,textureSource:this.texture instanceof Ye})}}const En=(n,e,t)=>{const r=e.getLocalBounds(),s=Math.ceil(r.maxX-r.minX),o=Math.ceil(r.maxY-r.minY),i=t!==void 0?t.width===s&&t.height===o:!1,a=i?t:Ye.create({width:s,height:o,antialias:!1,autoGenerateMipmaps:!1});a.label=`renderTexture of ${e.label??"(anon)"}`,t&&!i&&t.destroy();const{x:l,y:c}=e;e.x-=r.minX,e.y-=r.minY;try{n.render({container:e,target:a,clear:i})}catch(u){throw new Error(`renderContainerToTexture: failed to render to texture. Container:
 ${ar(e)}`,{cause:u})}return e.x=l,e.y=c,a},pe=(n,e,t,r)=>{const s=e.getLocalBounds(),o=t?.texture&&t?.texture instanceof Ye?t.texture:void 0,i=En(n,e,o),a=t||new Ud;return a.texture=i,a.label=r??`sprite of container (${e.label})`,a.pivot={x:Math.floor(-s.minX),y:Math.floor(-s.minY)},a},Ln=(n,e,t,r)=>{if(e instanceof ge||e instanceof le)return e;const s=e.getLocalBounds(),o=e.children.find(l=>l instanceof ge)?.textures.length??1,i=Te(da(0,o)).map(l=>{if(l>0)for(const c of e.children)c instanceof ge&&c.gotoAndStop((c.currentFrame+1)%o);return En(n,e)}).toArray(),a=new Dd(Ti(i));return a.animationSpeed=Ci(t,!1),a.gotoAndPlay(0),a.label=`animated sprite of container (${e.label})`,a.pivot={x:Math.floor(-s.minX),y:Math.floor(-s.minY)},a},ht=(n,e)=>e instanceof le?e:pe(n,e),$d=(n,e,t)=>e==="tower"?"tower":e==="book"?"book.x":e==="organic"&&n?`block.organic.dark${t?".disappearing":""}`:`block.${e}${t?".disappearing":""}`,Vd=({renderContext:{general:{pixiRenderer:n,colourised:e},item:{config:{style:t,times:r},state:{disappearing:s}},room:o},currentRendering:i})=>{const a=i?.renderProps,l=s!==null;return a===void 0||a.isDissapearing!==l?{output:ht(n,_({textureId:$d(o.color.shade==="dimmed",t,l),times:r,spritesheetVariant:e?"for-current-room":"uncolourised"})),renderProps:{isDissapearing:l}}:"no-update"},Gd=({renderContext:{item:{state:{pressed:n}},general:{colourised:e}},currentRendering:t})=>{const r=t?.renderProps;return r===void 0||n!==r.pressed?{output:_({textureId:n?"buttonInGame.pressed":"buttonInGame",spritesheetVariant:e?"for-current-room":"uncolourised"}),renderProps:{pressed:n}}:"no-update"},lt=({top:n,bottom:e})=>{const t=new M,r=_(e);t.addChild(r);const s=_(n);return s.y=-12,t.addChild(s),t[hr]=s,t[Wn]=r,t},hr=Symbol(),Wn=Symbol(),jd=({top:n,bottom:e})=>{const t=new M;return t.addChild(e),n.y=-j.z,t.addChild(n),t[hr]=n,t[Wn]=e,t},Hd=({renderContext:{item:{state:{facing:n,actedOnAt:{roomTime:e,by:t}}},room:{roomTime:r,items:s},general:{colourised:o}},currentRendering:i})=>{const a=i?.renderProps,l=wn(n)??"towards",c=r===e&&Te(cr(t)).some(h=>wo(s[h]));if(!(a===void 0||l!==a.facingXy4||c!==a.controlledByJoystick))return"no-update";const d=o?"for-current-room":"uncolourised";return{output:lt({top:{textureId:`charles.${l}`,spritesheetVariant:d},bottom:{textureId:c?"headlessBase.all":"headlessBase",spritesheetVariant:d}}),renderProps:{facingXy4:l,controlledByJoystick:c}}},Ot=n=>n,Ms=250,Nd=Mt.animations["conveyor.x"].animationSpeed,Ps=Mt.animations["conveyor.x"].length,Xd=n=>1-(1-n)**2,Yd=3,qd=(n,e)=>{for(let t=0;t<n.children.length;t++){const r=n.children[t],s=t*Yd%Ps;r.gotoAndStop(e?Ps-s-1:s)}},Zd=(n,e,t)=>{const r=Be(n),s=_({animationId:`conveyor.${r}`,reverse:n==="towards"||n==="right",times:e,spritesheetVariant:t}),o=s instanceof ge?new M({children:[s]}):s;return qd(o,n==="towards"||n==="right"),o},Kd=({renderContext:{item:{config:{times:n},state:{stoodOnBy:e,direction:t}},room:{roomTime:r},general:{colourised:s,pixiRenderer:o}},currentRendering:i})=>{const a=i?.renderProps,l=Pt(e),c=!l&&(a?.moving??!1),u=c?r:a?.roomTimeStoppedMoving??Xr,d=l?0:Math.min(r-u,Ms),h=i?.output,p=!h||t!==a?.direction,m=p?Ln(o,Zd(t,n,s?"for-current-room":"uncolourised"),"conveyor.x"):h,g=Math.max(0,1-d/Ms);if(g===0)m.stop();else{const x=Nd*Xd(g);m.play(),m.animationSpeed=x}return p||c||l!==a?.moving?{output:m,renderProps:{moving:l,roomTimeStoppedMoving:u,direction:t}}:"no-update"},Jd=Ot(Kd);function _i(n,e){const t=e||new M;for(const r of n)t.addChild(r);return t}const pr=(n,e)=>{const t=e&&{x:e.x??1,y:e.y??1};return _({...n,times:t})},nt=n=>K(({renderContext:{item:e,general:{colourised:t}}})=>kn(e)?_({...typeof n=="string"?{textureId:n}:n,times:ur(e),spritesheetVariant:t?"for-current-room":"uncolourised"}):_({...typeof n=="string"?{textureId:n}:n,spritesheetVariant:t?"for-current-room":"uncolourised"})),Qd=n=>K(({renderContext:{item:e,general:{paused:t,colourised:r}}})=>kn(e)?_({...n,times:ur(e),paused:t,spritesheetVariant:r?"for-current-room":"uncolourised"}):_({...n,paused:t,spritesheetVariant:r?"for-current-room":"uncolourised"})),ie=n=>K(({renderContext:{item:e,general:{pixiRenderer:t}}})=>{if(kn(e))return ht(t,pr(n,ur(e)));{const r=_(n);return r instanceof le?r:pe(t,r)}}),K=n=>(({renderContext:e,currentRendering:t,tickContext:r})=>t===void 0?{output:n({renderContext:e,currentRendering:void 0,tickContext:r}),renderProps:Xe}:"no-update"),Me=n=>(({renderContext:{general:{pixiRenderer:e},item:t},currentRendering:r})=>{if(r===void 0){const s=ur(t),o={output:ht(e,pr(n(t.config),s)),renderProps:Xe};return s&&(o.output.y-=((s.z??1)-1)*j.z),o}else return"no-update"}),eh=(n,e,t)=>{const s=_t().textures[`door.frame.${n.planet}.${e}.near`]!==void 0?n.planet:"generic",o=n.color.shade==="dimmed"&&_t().textures[`door.frame.${s}.dark.${e}.${t}`]!==void 0;return`door.frame.${s}${o?".dark":""}.${e}.${t}`};function*th({config:{direction:n,inHiddenWall:e,height:t}},r){const s=vn(n),o=s==="y"?1:16;function*i(a){if(e)t!==0&&(yield _({textureId:`generic.door.floatingThreshold.${s}`,...vt(a,{y:-j.z*t}),spritesheetVariant:r}));else{yield _({pivot:{x:o,y:9},textureId:`generic.door.legs.base.${s}`,...vt(a,{}),spritesheetVariant:r});for(let l=1;l<t;l++)yield _({pivot:{x:o,y:9},textureId:`generic.door.legs.pillar.${s}`,...vt(a,{y:-l*j.z}),spritesheetVariant:r})}}yield*i(qe({...He,[s]:1})),yield*i(He),e||(yield _({pivot:{x:16,y:j.z*t+13},textureId:`generic.door.legs.threshold.double.${s}`,...qe({...He,[s]:1}),spritesheetVariant:r}))}const ki=(n,e)=>{const t=vn(n),r=It(t),s=8;return n==="towards"||n==="right"?L({[r]:e[r]-s}):He},rh=K(({renderContext:{item:n,general:{pixiRenderer:e,colourised:t}}})=>{const s=_i(th(n,t?"for-current-room":"uncolourised")),o=pe(e,s),i=ki(n.config.direction,n.aabb);return o.x=i.x,o.y=i.y,o}),nh=K(({renderContext:{item:{config:{direction:n,part:e,toRoom:t},aabb:r},room:s,general:{pixiRenderer:o,colourised:i}}})=>{const a=ha(O.getState())??O.getState().levelEditor?.campaignInProgress,l=vn(n),c=a?.rooms[t]??s,u=new St({paletteSwaps:Z(c.color.hue,s.color.shade==="dimmed",s.planet==="moonbase"?"light-mid":"light-dark"),lutType:"sparse"}),{x:d,y:h}=ki(n,r),p=_({textureId:eh(s,l,e),x:d,y:h,spritesheetVariant:i?"for-current-room":"uncolourised"});p.filters=u;const f=new M({children:[p]}),m=pe(o,f);return f.destroy({children:!0}),u.destroy({destroyLutTexture:!0,destroyMask:!0}),e==="top"&&(m.y=.5),m});var sh=`#version 300 es
precision lowp float;in vec2 vTextureCoord;out vec4 finalColor;uniform vec2 uTextureSize;uniform sampler2D uTexture;uniform vec3 uOutline;uniform float uOutlineWidth;void main(void){vec2 scaledTexelSize=vec2(1.0f)/vec2(textureSize(uTexture,0))*uOutlineWidth;vec2 rightCoord=vec2(vTextureCoord.x+scaledTexelSize.x,vTextureCoord.y);vec2 leftCoord=vec2(vTextureCoord.x-scaledTexelSize.x,vTextureCoord.y);vec2 belowCoord=vec2(vTextureCoord.x,vTextureCoord.y+scaledTexelSize.y);vec2 aboveCoord=vec2(vTextureCoord.x,vTextureCoord.y-scaledTexelSize.y);vec4 colourToRight=texture(uTexture,rightCoord);vec4 colourToLeft=texture(uTexture,leftCoord);vec4 colourBelow=texture(uTexture,belowCoord);vec4 colourAbove=texture(uTexture,aboveCoord);float hasOpaqueNeighbor=max(max(colourToRight.a,colourToLeft.a),max(colourBelow.a,colourAbove.a));vec4 originalColour=texture(uTexture,vTextureCoord);finalColor=mix(originalColour,vec4(uOutline,1),(1.0-originalColour.a)*hasOpaqueNeighbor);}`;let on=co(O.getState());O.subscribe(()=>{on=co(O.getState())});const oh=Ke.from({vertex:Je,fragment:sh,name:"outline-filter"});class ze extends Ze{#e;constructor({color:e,width:t}){const r=t??on;super({glProgram:oh,padding:r,resources:{colorReplaceUniforms:{uOutline:{value:new Float32Array(3),type:"vec3<f32>"},uOutlineWidth:{value:new Float32Array(1),type:"f32"}}}}),this.#e=t;const s=this.resources.colorReplaceUniforms.uniforms,[o,i,a]=e.toArray();s.uOutline[0]=o,s.uOutline[1]=i,s.uOutline[2]=a}apply(e,t,r,s){const o=this.resources.colorReplaceUniforms.uniforms,i=this.#e??on;this.padding=i,o.uOutlineWidth[0]=i,super.apply(e,t,r,s)}}const fr={...ao(S,([n,e])=>[n,new ze({color:e})]),black1pxFilter:new ze({color:S.pureBlack,width:1})},ih=n=>{const e=`hud.char.${pa(n)}`;try{So(e)}catch(t){throw new Error(`no texture id for char "${n}": ${t.message}`,{cause:t})}return e},ah=n=>typeof n=="string"?n==="infinite"?"":n:n.toString();class Ii extends M{#e;#t="";#r;#n;#s;#o;#i;constructor({pixiRenderer:e,doubleHeight:t=!1,doubleWidth:r=!1,outline:s=!1,label:o="text",x:i,y:a,tint:l,text:c}){super({label:o,x:i,y:a,tint:l}),this.#e=e,this.#o=t?2:1,this.#i=r?2:1,this.#r=new le,this.#r.y=-(Ft.h*this.#o+1),this.addChild(this.#r),this.#s=new M,this.addChild(this.#s),this.#n=new M,this.#n.scale={x:this.#i,y:this.#o},s&&(this.#n.filters=new ze({color:S.pureBlack,width:1})),this.#s.addChild(this.#n),c!==void 0&&(this.text=c)}get text(){return this.#t}set text(e){const t=ah(e);this.#t!==t&&(this.#a(t),this.#s.visible=!0,this.#s.boundsArea=new tr(-1,-1,(Ft.w*t.length+2)*this.#i,(Ft.h+2)*this.#o),this.#r.texture&&this.#r.texture.destroy(!0),this.#r.texture=En(this.#e,this.#s),this.#r.x=-this.#r.texture.frame.width/2,this.#s.visible=!1,this.#t=t)}#a(e){const t=To(e),r=this.#n.children.length,s=t!==r;try{const o=_t().textures;let i=0;for(const a of e){const l=ih(a);let c;i<r?(c=this.#n.getChildAt(i),c.texture=o[l]):(c=new le(o[l]),this.#n.addChild(c)),i++}}catch(o){throw console.error("invalid string is",e,"and on window as window.invalid"),console.error(o),window.invalid=e,new Error(`could not show text "${e}" in container because: "${o.message}"`,{cause:o})}if(s){t<r&&this.#n.removeChildren(t);for(let o=0;o<t;o++){const i=this.#n.getChildAt(o);i.x=o*Ft.w}}}destroy(e){this.#r.destroy({texture:!0,textureSource:!0}),super.destroy(e)}get characterSpriteContainer(){return this.#n}}const lh=qa.floatingText,Rs=12,As=j.z*3,Os=[S.shadow,S.redShadow,S.midGrey,S.metallicBlue,S.midRed,S.moss,S.pink,S.lightBeige,S.pastelBlue,S.lightGrey,S.highlightBeige],Bs=[...Os,...new Array(20).fill(S.white),...Os.toReversed()],ch=({renderContext:{item:{config:{textLines:n,appearanceRoomTime:e}},room:{roomTime:t},general:{displaySettings:{uncolourised:r},pixiRenderer:s},frontLayer:o},currentRendering:i})=>{const a=i?.output;let l;const u=(t-e)*lh;if(a===void 0){l=new M,o?.attach(l);for(let h=0;h<n.length;h++){const p=n[h],f=new Ii({pixiRenderer:s,y:h*Rs,outline:!0,text:p.toUpperCase()});l.addChild(f)}}else l=a;let d=!1;for(let h=0;h<n.length;h++){const p=l.children[h],f=u+h*-Rs,m=f>0&&f<As;if(p.visible=m,d||=m,m&&!r){const g=Math.floor(f/As*Bs.length);p.tint=Bs[g]}}return l.visible=d,l.y=-u,{output:l,renderProps:Xe}},zs=(n,e)=>e===0?n:Math.round(n/e)*e,Fs=n=>n-Math.floor(n),uh=(n,e,t,r)=>n<=r&&t<=e;var dh=`#version 300 es
precision lowp float;out vec4 finalColor;in vec2 vTextureCoord;uniform sampler2D uBackTexture;uniform sampler2D uTexture;uniform vec4 uTintColour;vec4 transparent=vec4(0.0,0.0,0.0,0.0);vec4 black=vec4(0.0,0.0,0.0,1.0);void main(){vec4 fg=texture(uTexture,vTextureCoord);vec3 bg=texture(uBackTexture,vTextureCoord).rgb;float fgIsTransparent=step(fg.a,0.001f);float bgIsBlack=step(length(bg),0.001f);finalColor=mix(mix(uTintColour,black,bgIsBlack),transparent,fgIsTransparent);}`;const hh=Ke.from({vertex:Je,fragment:dh,name:"colour-clash-filter"});class Es extends Ze{constructor(e){super({glProgram:hh,resources:{uBackTexture:q.EMPTY,colourClashUniforms:{uTintColour:{value:e,type:"vec4<f32>"}}},blendRequired:!0})}}const ph=({state:{position:n}},e,t)=>{const r=o=>o.config.direction==="away"||o.config.direction==="left";return _i(Re(e.items).filter(o=>o.type==="wall"||o.type==="doorLegs").filter(r).map(o=>{const{id:i,config:{direction:a},state:{position:l}}=o;return _({textureId:"floorOverdraw.cornerNearWall",label:i,...L(Gr(l,n)),times:o.type==="wall"?fo(o.config):{[It(Be(a))]:2},anchor:{x:0,y:1},flipX:a==="away",spritesheetVariant:t?"for-current-room":"uncolourised"})}),new M({label:"floorOverdraws"}))},fh=(n,e)=>{const{config:{naturalFootprint:{aabb:t,position:r}},state:{position:s}}=e,o=Xt(Oe(ut,s)),{left:i,right:a}=Re(n.items).filter(Za).filter(l=>{const{state:{position:c},aabb:u}=l,d=l.config.direction,h=Be(d),p=It(h),f=d==="away"||d==="left",m=r[h]+(f?1:0)*t[h],g=c[h]+(f?0:1)*u[h];return m!==g?!1:uh(c[p],c[p]+u[p],r[p],r[p]+t[p])}).reduce((l,{aabb:c,renderAabb:u,renderAabbOffset:d,state:{position:h},fixedZIndex:p})=>{const f=p===Ka,m=f?c:u??c,g=Se(h,d??ut),x=Xt(Se(g,{x:m.x,y:f?m.y:0}))+o,T=Xt(Se(g,{x:f?m.x:0,y:m.y}))+o;return{left:Math.min(l.left,x),right:Math.max(l.right,T)}},{left:9999,right:-9999});if(a>i)return new Ce().rect(i,-500,a-i,500).fill("rgba(255, 0, 0)")},Ls=({direction:n,times:e,position:t,colourised:r})=>_({label:`floorEdge(${n})`,textureId:`floorEdge.${n}`,times:e,...L(t),spritesheetVariant:r?"for-current-room":"uncolourised"}),gh=({room:n,xSize:e,ySize:t,y:r})=>{const s=new M({label:"floorColourClash"}),o=Ts(n,"right"),i=new M({label:"floorColourClash.right",filters:[new Es(o)]});for(let c=0;c<=t;c++){const u=qe({x:0,y:c,z:0}),d=new Ce().rect(u.x-(c===0?0:8),u.y,24,8).fill(o);i.addChild(d)}s.addChild(i);const a=Ts(n,"towards"),l=new M({label:"floorColourClash.towards",filters:[new Es(a)]});for(let c=0;c<=e;c++){const u=qe({x:c,y:0,z:0}),d=new Ce().rect(u.x-16,u.y,8*(c===0?2:3),8).fill(a);l.addChild(d)}return s.addChild(l),s.y=r,s},mh=K(({renderContext:{room:n,item:e,general:{colourised:t,pixiRenderer:r},colourClashLayer:s,frontLayer:o}})=>{const{color:{shade:i}}=n,{config:a,state:{position:l},aabb:c}=e,{floorType:u,naturalFootprint:d}=a,h=new M({label:"floorAppearance"}),p=new M({label:"sprites"}),f=L({...c,y:0}),m=L({...c,x:0,y:0}),g=L({...c,x:0}),x=L(c),T=new ze({color:t?Jt("pureBlack"):fa.black,width:1});if(u!=="none"){const C=new M({label:"tiles"}),v=u==="deadly"?`generic${i==="dimmed"?".dark":""}.floor.deadly`:`${a.scenery}${i==="dimmed"?".dark":""}.floor`,y=kt(t?"for-current-room":"uncolourised").textures[v];try{So(v)}catch(V){throw new Error(`no floor textureId for floorType: ${u}, shade: ${i}`,{cause:V})}const b=Oe(d.position,l),w={x:Fs(b.x/j.x),y:Fs(b.y/j.x)},k=8,B={x:f.x,y:x.y-k,width:g.x-f.x,height:m.y-x.y+2*k},W=Oe(qe(vt(w,{x:.5,y:.5})),{y:c.z},B),R=new Vl({texture:y,tilePosition:W,...B});C.addChild(R),C.addChild(ph(e,n,t));const $=new Ce().moveTo(x.x,x.y).lineTo(g.x,g.y).lineTo(g.x,g.y+3).lineTo(m.x,m.y+3).lineTo(f.x,f.y+3).lineTo(f.x,f.y).fill({color:16711680,alpha:1}),A=pe(r,$);$.destroy(),C.addChild(A),C.mask=A;const F=new M({children:[C]});F.filters=T,p.addChild(F)}{const C=new M({label:"edges"});if(u==="none"){const w=new Ce().moveTo(g.x,g.y+10).lineTo(g.x,g.y+100).lineTo(f.x,f.y+100).lineTo(f.x,f.y+10).lineTo(m.x,m.y+10).fill(0),k=pe(r,w);h.addChild(k),o.attach(k),w.destroy()}const v=Math.ceil(c.y/j.x);C.addChild(Ls({direction:"right",times:{y:v},position:{z:c.z},colourised:t}));const y=Math.ceil(c.x/j.x);C.addChild(Ls({direction:"towards",times:{x:y},position:{z:c.z},colourised:t})),p.addChild(C);const b=fh(n,e);if(b!==void 0){const w=pe(r,b);p.addChild(w),p.mask=w,b.destroy()}if(h.addChild(pe(r,p)),p.destroy({children:!0}),T.destroy(!1),!t){const w=gh({xSize:y,ySize:v,y:-c.z+1,room:n});h.addChild(w),s.attach(w)}}return h}),xh=n=>{const e=new M({label:"joystick"});return e.addChild(_({textureId:"joystick.stick",spritesheetVariant:n})),e.addChild(_({textureId:"joystick.ball",spritesheetVariant:n})),e},yh=new Map([["towards",{x:-1,y:1}],["right",{x:1,y:1}],["left",{x:-1,y:0}],["away",{x:1,y:0}],[void 0,He]]),wh=({renderContext:{item:{state:{actedOnAt:n,lastPushDirection:e}},room:{roomTime:t},general:{colourised:r}},currentRendering:s})=>{const o=s?.renderProps,i=t===n.roomTime?e:void 0,a=o?.pushDirection;if(!(o===void 0||i!==a))return"no-update";const c=s?.output??xh(r?"for-current-room":"uncolourised"),u=c.getChildAt(1),d=yh.get(i);return u.x=d?.x??0,u.y=d?.y??0,{output:c,renderProps:{pushDirection:i}}},vh=["cyberman","dalek","skiHead","bubbleRobot","computerBot","turtle","homingBot"],Ws=(n,e,t,r)=>{const s=xi(r);return Math.sin((n+s*2e4)/e)*t},bh=50,Sh=200,Ch=.25,Th=1,De=({id:n,config:{which:e},state:t},r,s)=>{const o=e==="emperorsGuardian"||e==="helicopterBug",i=e==="cyberman"||e==="bubbleRobot"||e==="computerBot"||e==="emperorsGuardian";if((i||e==="helicopterBug")&&t.activated||o){const l=e==="computerBot"||e==="helicopterBug",c=l?bh:Sh,u=l?Ch:Th;if(i){const d=s;d[hr].y=-j.z+Ws(r.roomTime,c,u,n)}else s.y=Ws(r.roomTime,c,u,n)}return s},_h=({renderContext:{item:n,room:e,general:{paused:t,colourised:r}},currentRendering:s})=>{const{config:o,state:i,id:a}=n,l=s?.renderProps,{activated:c,busyLickingDoughnutsOffFace:u}=i,d=r?u?"doughnutted":!c&&vh.includes(o.which)?"deactivated":"for-current-room":"uncolourised";switch(o.which){case"skiHead":case"turtle":case"cyberman":case"computerBot":case"elephant":case"elephantHead":case"monkey":{const h=wn(i.facing)??"towards";if(!(l===void 0||c!==l.activated||u!==l.busyLickingDoughnutsOffFace||h!==l.facingXy4))return De(n,e,s.output),"no-update";const f={facingXy4:h,activated:c,busyLickingDoughnutsOffFace:u};switch(o.which){case"skiHead":return{output:_({textureId:`${o.which}.${o.style}.${h}`,spritesheetVariant:d}),renderProps:f};case"elephantHead":return{output:_({textureId:`elephant.${h}`,spritesheetVariant:d}),renderProps:f};case"turtle":return{output:_(c&&!u?{animationId:`${o.which}.${h}`,spritesheetVariant:d,paused:t,randomiseStartFrame:a}:{textureId:`${o.which}.${h}.1`,spritesheetVariant:d}),renderProps:f};case"cyberman":return{output:i.activated||i.busyLickingDoughnutsOffFace?De(n,e,lt({top:{textureId:`${o.which}.${h}`,spritesheetVariant:d},bottom:{animationId:"bubbles.jetpack",paused:t,spritesheetVariant:d}})):_({textureId:`${o.which}.${h}`,spritesheetVariant:d}),renderProps:f};case"computerBot":case"elephant":case"monkey":return{output:De(n,e,lt({top:{textureId:`${o.which}.${h}`,spritesheetVariant:d},bottom:{animationId:"headlessBase.flash",playOnce:"and-stop",spritesheetVariant:d}})),renderProps:f};default:throw new Error(`unexpected monster ${o}`)}break}case"homingBot":{const h=!ga(i.vels.walking,He);return l===void 0||u!==l.busyLickingDoughnutsOffFace||c!==l.activated||h!==l.walking?{spritesheetVariant:d,output:_(c&&!u?{animationId:h?"headlessBase.flash":"headlessBase.scan",spritesheetVariant:d}:{textureId:"headlessBase",spritesheetVariant:d}),renderProps:{activated:c,busyLickingDoughnutsOffFace:u,walking:h}}:"no-update"}case"helicopterBug":case"emperor":case"dalek":case"bubbleRobot":case"emperorsGuardian":{if(!(l===void 0||u!==l.busyLickingDoughnutsOffFace||c!==l.activated))return De(n,e,s.output),"no-update";const p={activated:c,busyLickingDoughnutsOffFace:u};switch(o.which){case"helicopterBug":case"dalek":return{output:De(n,e,_(c&&!u?{animationId:o.which==="dalek"&&e.color.shade==="dimmed"&&(e.planet==="blacktooth"||e.planet==="egyptus"||e.planet==="moonbase")?"dalek.dark":o.which,spritesheetVariant:d,paused:t,randomiseStartFrame:a}:{textureId:`${o.which}.1`,spritesheetVariant:d})),renderProps:p};case"bubbleRobot":return{output:De(n,e,lt({top:{animationId:"bubbles.blueGreen",randomiseStartFrame:a,paused:t,spritesheetVariant:d},bottom:{textureId:"headlessBase",spritesheetVariant:d}})),renderProps:p};case"emperorsGuardian":return{output:De(n,e,lt({top:{textureId:"ball.blueGreen",spritesheetVariant:d},bottom:{animationId:"bubbles.cold",spritesheetVariant:d,paused:t}})),renderProps:p};case"emperor":return{output:_({animationId:"bubbles.cold",spritesheetVariant:d,paused:t}),renderProps:p};default:throw new Error(`unexpected monster ${o}`)}break}default:throw new Error(`unexpected monster ${o}`)}},kh=n=>{const{gameTime:e,lastDiedAt:t}=n.type==="headOverHeels"?n.state.head:n.state;return e-t<Ja},Br=n=>{if(n===void 0)return 0;const{shieldCollectedAt:e,gameTime:t}=n;return e!==null&&e+Nn>t?100-Math.ceil((t-e)/(Nn/100)):0},Ih=n=>n.type==="headOverHeels"?Br(n.state.head)>0||Br(n.state.heels)>0:Br(n.state)>0;var Mh=`#version 300 es
precision lowp float;in vec2 vTextureCoord;out vec4 finalColor;uniform sampler2D uTexture;uniform vec3 uColour;void main(void){vec4 c=texture(uTexture,vTextureCoord);finalColor=mix(c,vec4(uColour,1),c.a);}`;const Ph=Ke.from({vertex:Je,fragment:Mh,name:"oneColour-filter"});class an extends Ze{constructor(e){super({glProgram:Ph,resources:{colorReplaceUniforms:{uColour:{value:new Float32Array(3),type:"vec3<f32>"}}}});const t=this.resources.colorReplaceUniforms.uniforms,[r,s,o]=e.toArray();t.uColour[0]=r,t.uColour[1]=s,t.uColour[2]=o}}const ln=.02,Rh=({name:n,action:e,facingXy8:t,teleportingPhase:r,gravityZ:s,paused:o,spritesheetVariant:i})=>{if(e==="death")return{animationId:`${n}.fadeOut`,paused:o,spritesheetVariant:i};if(r==="out")return{animationId:`${n}.fadeOut`,paused:o,spritesheetVariant:i};if(r==="in")return{animationId:`${n}.fadeOut`,paused:o,spritesheetVariant:i};if(e==="moving")return{animationId:`${n}.walking.${t}`,paused:o,spritesheetVariant:i};if(e==="jumping")return{textureId:s<ln?`${n}.walking.${t}.2`:`${n}.walking.${t}.1`,spritesheetVariant:i};if(e==="falling"){const l=`${n}.falling.${t}`;if(Co(l))return{textureId:l,spritesheetVariant:i}}const a=`${n}.idle.${t}`;return Mn(a)?{animationId:a,paused:o,spritesheetVariant:i}:{textureId:`${n}.walking.${t}.2`,spritesheetVariant:i}},cn=Symbol(),Mi=Symbol(),Ah=(n,e)=>{n[cn].removeChildren(),n[cn].addChild(_(Rh(e)))},zr=(n,e,t,r,s)=>{const o=new M,i=new M;o[cn]=i,o.addChild(i);const a=_({animationId:e?`shine.${n}InSymbio`:`shine.${n}`,paused:t,flipX:n==="heels",spritesheetVariant:r?"for-current-room":"uncolourised"});o.addChild(a),o[Mi]=a,o.filters=[new ze({color:s?ct(s):Jt(Cs[n])}),new ze({color:s?ct(s):Jt("midRed")}),new an(s?ct(s):Jt(Cs[n]))];for(const l of o.filters)l.enabled=!1;return o},Ds=({gameTime:n,switchedToAt:e},t,r)=>(t==="headOverHeels"||t===r)&&e+Qa>n,Oh=n=>{if(!kh(n))return!1;const{gameTime:e,lastDiedAt:t}=n.type==="headOverHeels"?n.state.head:n.state;return(e-t)%Xn<Xn*el},Bh=({highlighted:n,flashing:e,shining:t},r)=>{const[s,o,i]=r.filters;s.enabled=n,o.enabled=!n&&t,i.enabled=e},zh=(n,e)=>{n[Mi].visible=e},Fr=(n,e,t,r,s,o)=>{t&&Ah(e,{name:n,...r,paused:s,spritesheetVariant:o}),Bh(r,e),zh(e,r.shining)},Fh=({renderContext:{item:n,general:{gameState:e,paused:t,colourised:r},room:s},currentRendering:o})=>{const{type:i,state:{action:a,facing:l,visualFacingVector:c,teleporting:u,vels:{gravity:{z:d}}}}=n,h=o?.renderProps,p=o?.output,f=xn(c??l)??"towards",m=e!==void 0&&(n.type==="headOverHeels"?Ds(n.state.head,"headOverHeels","headOverHeels"):Ds(n.state,n.type,e.currentCharacterName)),g=Oh(n),x=Ih(n),T=mn(l),C=u?.phase??null,v={action:a,facingXy8:f,teleportingPhase:C,flashing:g,highlighted:m,shining:x,gravityZ:d},y=h===void 0||h.action!==a||h.facingXy8!==f||h.teleportingPhase!==C||h?.gravityZ>ln!=d>ln;let b;const w=r?"for-current-room":"uncolourised",k=r?void 0:s.color;if(i==="headOverHeels"){b=p??jd({top:zr("head",!0,t,r,k),bottom:zr("heels",!0,t,r,k)});const B=b;Fr("head",B[hr],y,v,t,w),Fr("heels",B[Wn],y,v,t,w)}else b=p??zr(i,!1,t,r,k),Fr(i,b,y,v,t,w);return a==="moving"&&p instanceof ge&&(p.animationSpeed=T*ma),{output:b,renderProps:v}},Er=Ot(Fh),Lr=(n,e,t,r,s)=>{const o=`${n}.idle.${e}`,i=s?"sceneryPlayer":"uncolourised";return Mn(o)?{animationId:o,randomiseStartFrame:t,paused:r,spritesheetVariant:i}:{textureId:`${n}.walking.${e}.2`,spritesheetVariant:i}},Eh=({renderContext:{item:{id:n,config:{which:e,startDirection:t}},general:{paused:r,colourised:s}},currentRendering:o})=>o?.renderProps===void 0?{output:e==="headOverHeels"?lt({top:Lr("head",t,n,r,s),bottom:Lr("heels",t,n,r,s)}):_(Lr(e,t,n,r,s)),renderProps:Xe}:"no-update",Lh=({renderContext:{item:{state:{vels:{sliding:n}},config:{startingPhase:e}},general:{paused:t,colourised:r}},tickContext:{deltaMS:s},currentRendering:o})=>{const a=(o?.renderProps?.distanceTravelled??0)+fn(n)*(t?0:s),l=o?.output,c=r?"for-current-room":"uncolourised",u=l??_({textureId:"spikyBall.1",spritesheetVariant:c}),h=(Math.floor(a*2/Ht.w)+e)%2+1;return u.texture=kt(c).textures[`spikyBall.${h}`],{output:u,renderProps:{distanceTravelled:a}}},Wh=Ot(Lh),Pi=n=>({renderContext:{item:{state:{stoodOnBy:e,stoodOnUntilRoomTime:t}},general:{paused:r,colourised:s}},tickContext:{lastRenderRoomTime:o},currentRendering:i})=>{const a=i?.renderProps,l=Pt(e);let c;return i?.output?c=i?.output:(c=_({animationId:n?"shadowMask.spring.bounce":"spring.bounce",paused:r,spritesheetVariant:s?"for-current-room":"uncolourised"}),c.loop=!1,c.gotoAndStop(0)),o!==void 0&&t>o&&!l&&!r?c.gotoAndPlay(0):l!==(a?.compressed??!1)&&(l?c.gotoAndStop(1):c.gotoAndStop(0)),{output:c,renderProps:{compressed:l}}},Dh=Ot(Pi(!1)),Uh=Ot(Pi(!0)),$h=n=>{const{gameMenus:e}=O.getState();try{return io(e,n.path)?"right":"left"}catch(t){throw new Error(`Error getting switch setting from store for switch with path "${n.path}"

while store has: ${JSON.stringify(e,null,2)}`,{cause:t})}},Vh=({renderContext:{item:{state:{setting:n},config:e},general:{colourised:t}},currentRendering:r})=>{const s=r?.renderProps,o=e.type==="in-store"?$h(e):n;return s===void 0||o!==s.setting?{output:_({textureId:`switch.${o}`,spritesheetVariant:t?"for-current-room":"uncolourised"}),renderProps:{setting:o}}:"no-update"},Gh=({renderContext:{item:n,room:e,general:{paused:t,colourised:r}},currentRendering:s})=>{const{state:{stoodOnBy:o},config:{times:i}}=n,a=s?.renderProps,l=On(n),c=l&&Rt(o,e).some(_n);if(!(a===void 0||l!==a.activated||c!==a.flashing))return"no-update";const d=r?"for-current-room":"uncolourised";return{output:_(c?{animationId:"teleporter.flashing",times:i,paused:t,spritesheetVariant:d}:{textureId:l?"teleporter":"block.artificial",times:i,spritesheetVariant:d}),renderProps:{flashing:c,activated:l}}},jh=({state:{stoodOnBy:n,position:e},config:{times:t}},r)=>{const s=new Array(t?.x??1).fill(null).map(()=>new Array(t?.y??1));return Rt(n,r).filter(vo).forEach(({id:o,state:{position:i}})=>{const a=Oe(i,e),l={x:Math.floor(a.x/j.x),y:Math.floor(a.y/j.y)};l.x<0||l.x>=(t?.x??1)||l.y<0||l.y>=(t?.y??1)||(s[l.x][l.y]=o)}),s},Hh=(n,e)=>{let t=0,r=1;for(const s of e)for(const o of s)o!==void 0&&n.items[o]?.state.activated&&(t|=r),r<<=1;return t},Nh=({renderContext:{item:n,room:e,general:{pixiRenderer:t,colourised:r}},currentRendering:s})=>{const{config:{times:o}}=n,i=s===void 0?jh(n,e):s.renderProps.chargePositions,a=Hh(e,i);if(!(a!==s?.renderProps.cybermanActivationBitmask))return"no-update";const c=_({subSpriteVariations(d,h){const p=i[d][h];return p===void 0?{animationId:"toaster.off"}:e.items[p]?.state.everActivated?{animationId:"toaster.off"}:{textureId:"toaster.on"}},times:o??Xe,spritesheetVariant:r?"for-current-room":"uncolourised"});return{output:Ln(t,c,"toaster.off"),renderProps:{chargePositions:i,cybermanActivationBitmask:a}}},Xh=(n,e,t,r)=>`${n}${r?".dark":""}.wall.${e}.${t}`,Yh=K(({renderContext:{general:{pixiRenderer:n,colourised:e},item:{id:t,config:r},room:s}})=>{if(r.direction==="right"||r.direction==="towards")throw new Error(`wall is near: ${t}`);const{direction:o,tiles:i}=r,a=It(Be(o)),l=new M({label:"wallTiles"}),c=new M({label:"wallAnimations"});for(let d=0;d<r.tiles.length;d++){const h=qe({[a]:d});if(l.addChild(_({textureId:Xh(s.planet,i[d],o,s.color.shade==="dimmed"),...h,pivot:o==="away"?{x:Ht.w,y:Ht.h}:{x:0,y:Ht.h},spritesheetVariant:e?"for-current-room":"uncolourised"})),s.planet==="moonbase"){const p=`moonbase.wall.screen.${i[d]}.away`;Mn(p)&&c.addChild(_({animationId:p,randomiseStartFrame:`${t}${d}`,flipX:o==="left",x:h.x+(o==="away"?-8:8),y:h.y-23,spritesheetVariant:e?"for-current-room":"uncolourised"}))}}const u=new M({label:"wallAppearance"});return u.addChild(pe(n,l)),c.children.length>0&&u.addChild(c),u}),qh={head:Er,heels:Er,headOverHeels:Er,doorFrame:nh,doorLegs:rh,monster:_h,floatingText:ch,barrier:K(({renderContext:{item:{config:{axis:n,times:e,disappearing:t}},general:{colourised:r,pixiRenderer:s}}})=>ht(s,_({textureId:`barrier.${n}${t?".disappearing":""}`,times:e,spritesheetVariant:r?"for-current-room":"uncolourised"}))),deadlyBlock:K(({renderContext:{item:{config:n,id:e},general:{paused:t,colourised:r,pixiRenderer:s}}})=>{switch(n.style){case"volcano":{const o=_({animationId:"volcano",times:n.times,randomiseStartFrame:e,paused:t,spritesheetVariant:r?"for-current-room":"uncolourised"});return Ln(s,o,"volcano")}case"toaster":throw new Error("use the special toaster appearance instead");default:throw n.style,new Error("unknown deadly block style")}}),spikes:nt("spikes"),slidingDeadly:Wh,slidingBlock:K(({renderContext:{item:{config:{style:n}},general:{colourised:e}}})=>{const t=e?"for-current-room":"uncolourised";return _(n==="book"?{textureId:"book.y",spritesheetVariant:t}:{textureId:n,spritesheetVariant:t})}),block:Vd,switch:Vh,button:Gd,conveyor:Jd,lift:K(({renderContext:{general:{paused:n,colourised:e}}})=>{const t=new M,r=e?"for-current-room":"uncolourised",s={x:jn.w/2,y:jn.h};return t.addChild(_({animationId:"lift",pivot:s,paused:n,spritesheetVariant:r})),t.addChild(_({textureId:"lift.static",pivot:s,spritesheetVariant:r})),t}),teleporter:Gh,sceneryCrown:K(({renderContext:{item:{config:{planet:n}},general:{colourised:e}}})=>_({textureId:`crown.${n}`,spritesheetVariant:e?"for-current-room":"uncolourised"})),pickup:K(({renderContext:{item:{config:n},general:{paused:e,colourised:t}}})=>{const r=t?"for-current-room":"uncolourised";if(n.gives==="crown")return _({textureId:`crown.${n.planet}`,spritesheetVariant:r});const o={shield:{textureId:"whiteRabbit",spritesheetVariant:r},jumps:{textureId:"whiteRabbit",spritesheetVariant:r},fast:{textureId:"whiteRabbit",spritesheetVariant:r},"extra-life":{textureId:"whiteRabbit",spritesheetVariant:r},bag:{textureId:"bag",spritesheetVariant:r},doughnuts:{textureId:"doughnuts",spritesheetVariant:r},hooter:{textureId:"hooter",spritesheetVariant:r},scroll:{textureId:"scroll",spritesheetVariant:r},reincarnation:{animationId:"fish",paused:e,spritesheetVariant:r}}[n.gives];return _(o)}),moveableDeadly:nt("fish.1"),charles:Hd,joystick:wh,movingPlatform:nt("sandwich"),pushableBlock:nt("stepStool"),portableBlock:K(({renderContext:{item:{config:{style:n}},general:{colourised:e}}})=>_({textureId:n,spritesheetVariant:e?"for-current-room":"uncolourised"})),spring:Dh,sceneryPlayer:Eh,hushPuppy:nt("hushPuppy"),bubbles:K(({renderContext:{item:{id:n,config:{style:e}},general:{paused:t,colourised:r}}})=>_({animationId:`bubbles.bounce.${e}`,paused:t,randomiseStartFrame:n,spritesheetVariant:r?"for-current-room":"uncolourised"})),firedDoughnut:Qd({animationId:"bubbles.doughnut"}),ball:nt("ball"),floor:mh,particle:K(({renderContext:{item:{config:{forCharacter:n}},general:{paused:e,colourised:t}}})=>_({animationId:`particle.${n==="head"?"head":"heels"}.fade`,anchor:{x:.5,y:.5},paused:e,spritesheetVariant:t?"for-current-room":"uncolourised"}))},Zh=n=>{if(n.type==="wall"){const{direction:e}=n.config;return e==="right"||e==="towards"?void 0:Yh}return n.type==="deadlyBlock"&&n.config.style==="toaster"?Nh:qh[n.type]};class Kh{constructor(e,t){this.renderContext=t,this.#e=e,this.#t.addChild(...e.map(r=>r.output))}#e;#t=new M({label:"CompositeRenderer"});tick(e){for(const t of this.#e)t.tick(e)}destroy(){for(const e of this.#e)e.destroy()}get output(){return this.#t}}var Jh=`#version 300 es
precision lowp float;in vec2 vTextureCoord;out vec4 finalColor;uniform sampler2D uTexture;uniform vec3 uTargetColor;const float blackThreshold=sqrt(3.0)*0.15;void main(void){vec4 c=texture(uTexture,vTextureCoord);float isBlack=step(length(c.rgb),blackThreshold);finalColor=mix(vec4(uTargetColor,1),c,max(isBlack,1.0-c.a));}`;const Qh=Ke.from({vertex:Je,fragment:Jh,name:"revert-colourise-filter"});class ep extends Ze{uniforms;constructor(e="white"){super({glProgram:Qh,resources:{colorReplaceUniforms:{uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this.targetColor=e}set targetColor(e){const[t,r,s]=new Y(e).toArray();this.uniforms.uTargetColor[0]=t,this.uniforms.uTargetColor[1]=r,this.uniforms.uTargetColor[2]=s}}const tp=Ne,rp=S.pastelBlue,Us=fr.highlightBeige,np=S.lightBeige,sp=fr.lightBeige,$s=fr.midRed,op=fr.white,Vs=new ep(rp),Wr=S.white,Gs=S.midRed,ip=S.pastelBlue,js={left:"",away:"",right:"",towards:""},Hs=n=>n.type==="switch"&&n.config.type==="in-room"||n.type==="button",Ns=(n,e)=>{switch(n){case"back-forth":switch(e){case"left":return"";case"right":return"";case"away":return"";case"towards":return"";default:throw new Error("Unexpected startDirection")}case"forwards":switch(e){case"left":return"";case"right":return"";case"away":return"";case"towards":return"";default:throw new Error("Unexpected startDirection")}case"clockwise":switch(e){case"left":return"";case"right":return"";case"away":return"";case"towards":return"";default:throw new Error("Unexpected startDirection")}case"towards-analogue":return"."}return""},ap=n=>n.type==="monster"&&n.config.activated==="after-player-near";class lp{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output),this.#e()}output=new M({label:"EditorAnnotationsRenderer"});#e(){const e=this.renderContext.item;switch(e.type){case"pickup":if(e.config.gives==="shield"||e.config.gives==="extra-life"||e.config.gives==="jumps"||e.config.gives==="fast"){const t={shield:"",jumps:"",fast:"","extra-life":"+2"};this.#t({annotationText:t[e.config.gives],yAdj:-16})}break;case"doorFrame":if(e.config.part==="near"){const{rooms:t}=O.getState().levelEditor.campaignInProgress,{config:{toRoom:r,direction:s}}=e;if(r!==tl){const o=!!t[r],i=js[s],a=s==="away"||s==="right"?`${r}${i}`:`${i}${r}`;this.#t({annotationText:a,yAdj:s==="left"||s==="away"?-48:0,tint:o?Wr:Gs,clickDispatch:o?()=>Nr(r):void 0})}}break;case"teleporter":{const{rooms:t}=O.getState().levelEditor.campaignInProgress,{config:{toRoom:r}}=e,s=!!t[r];this.#t({annotationText:`${r}`,yAdj:-12,tint:s?Wr:Gs,clickDispatch:s?()=>Nr(r):void 0})}break;case"conveyor":{const{config:{direction:t}}=e,r=js[t];this.#t({annotationText:r,yAdj:-12})}break;case"movingPlatform":{const{config:{movement:t,startDirection:r}}=e;this.#t({annotationText:Ns(t,r),yAdj:-12})}break;case"monster":{const{config:t}=e;switch(!0){case(t.which==="cyberman"&&t.activated==="after-player-near"):this.#t({annotationText:"wake",tint:np,yAdj:-12});break;case(t.which==="turtle"||t.which==="skiHead"):this.#t({annotationText:Ns(t.movement,t.startDirection),yAdj:-12});break}}break}}#t({annotationText:e,yAdj:t=0,tint:r=Wr,clickDispatch:s}){const{renderContext:{frontLayer:o,general:{pixiRenderer:i}}}=this,a=new Ii({pixiRenderer:i,label:"EditorAnnotationTextContainer",outline:!0,tint:r,text:e,y:t});s!==void 0&&(a.eventMode="static",a.on("click",()=>{O.dispatch(s())}),a.on("mouseover",()=>{O.getState().levelEditor.tool.type==="pointer"&&(O.dispatch(Yn(!0)),a.tint=ip)}),a.on("mouseout",()=>{O.dispatch(Yn(!1)),a.tint=r}),a.cursor="pointer"),this.output.addChild(a),o.attach(a)}tick(e){this.#r(),this.childRenderer.tick(e)}#r(){const{renderContext:{room:e}}=this,t=this.renderContext.item,{clickableAnnotationHovered:r}=O.getState().levelEditor,{jsonItemId:s}=t,o=O.getState(),i=uo(o),a=rl(o),l=wt(o),c=s&&i?.jsonItemId===s&&!r,u=s&&a.includes(s),d=()=>s!==void 0&&(Re(e.items).some(h=>h.jsonItemId===i?.jsonItemId&&Hs(h)&&h.config.modifies.some(p=>p.expectType===t.type&&(p.targets===void 0||p.targets.includes(s))))||Hs(t)&&Re(e.items).some(({jsonItemId:h,type:p})=>h!==void 0&&h===i?.jsonItemId&&t.config.modifies.some(f=>f.expectType===p&&(f.targets===void 0||f.targets.includes(h))))||t.type==="charles"&&Re(e.items).some(h=>h.jsonItemId===i?.jsonItemId&&h.type==="joystick"&&h.config.controls.some(p=>p===s))||t.type==="joystick"&&t.config.controls.some(h=>i?.jsonItemId===h));this.output.filters=c&&u?[Vs,l.type==="eyeDropper"?$s:Us]:c?l.type==="eyeDropper"?$s:Us:u?Vs:d()?op:ap(t)?sp:tp}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const cp=(n,e,t)=>e.general.editor?new lp(e,t):t,un=n=>{if(n instanceof le){const{texture:e}=n;e instanceof Ye&&e.destroy(!0)}for(const e of n.children)un(e)};class up{constructor(e,t){this.renderContext=e,this.appearance=t}#e;output=new M({label:"AppearanceRenderer"});destroy(){this.#e?.output&&un(this.#e.output),this.output.destroy({children:!0})}tick(e){const t=this.appearance({renderContext:this.renderContext,currentRendering:this.#e,tickContext:e});t!=="no-update"&&(this.output.children.at(0)!==t.output&&(this.#e?.output&&(this.output.removeChild(this.#e.output),un(this.#e.output),this.#e.output.destroy({texture:!1,children:!0})),t.output!==void 0&&this.output.addChild(t.output)),this.#e=t)}}class Ri extends up{}const Xs=(n,e)=>{e.poly([L({}),L({x:n.x}),L({x:n.x,y:n.y}),L({y:n.y})]).poly([L({}),L({z:n.z}),L({y:n.y,z:n.z}),L({y:n.y})]).poly([L({x:n.x}),L({x:n.x,z:n.z}),L(n),L({x:n.x,y:n.y})]).poly([L({z:n.z}),L({x:n.x,z:n.z}),L({x:n.x,y:n.y,z:n.z}),L({y:n.y,z:n.z})])},Ys=(n,e)=>{const t=new Ce;return Xs(n,t),t.stroke({width:.5,color:e,alpha:1}),t.eventMode="static",t.on("pointerenter",()=>{t.fill({color:e,alpha:.5})}),t.on("pointerleave",()=>{t.clear(),Xs(n,t),t.stroke({width:.5,color:e,alpha:1})}),t},dp={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",pickup:"rgba(0,196,255)",emitter:"rgba(0,255,255)",stopAutowalk:"rgba(255,128,128)",floatingText:"rgba(128,0,255)"};class hp{constructor(e){this.renderContext=e;const{item:t}=e,r=dp[t.type]??"rgba(255,255,255)";if(this.#e=new M({label:`ItemBoundingBoxRenderer ${t.id}`}),nl("portal")(t)){const o=L(t.config.relativePoint);this.#e.addChild(new Ce().circle(o.x,o.y,5).stroke(r)),this.#e.addChild(new Ce().circle(o.x,o.y,2).fill(r))}if(this.#e.addChild(new Ce({label:"objectOrigin"}).circle(0,0,2).fill(r)),this.#e.addChild(Ys(t.aabb,r)),t.renderAabb){const o="rgba(184, 184, 255)",i=Ys(t.renderAabb,o);if(t.renderAabbOffset){const a=L(t.renderAabbOffset);i.position.set(a.x,a.y),i.circle(0,0,2).fill(o)}this.#e.addChild(i)}this.#e.eventMode="static";let s;this.#e.on("pointerenter",()=>{if(s!==void 0)return;const o=`${t.id} ${t.type}
@(${t.state.position.x}, ${t.state.position.y}, ${t.state.position.z})}
#(${t.aabb.x}, ${t.aabb.y}, ${t.aabb.z})}`;this.#e.addChild(s=new yc({text:o,style:{fill:r,fontSize:6,fontFamily:"Menlo"}})),s.resolution=4}),this.#e.on("pointerleave",()=>{s!==void 0&&(this.#e.removeChild(s),s=void 0)}),e.frontLayer.attach(this.#e)}#e;tick(){}destroy(){this.#e.destroy({children:!0})}get output(){return this.#e}}const pp=75;class fp{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output);const r=e.room.color.shade==="dimmed"?dr:S;this.#e=new an(r.moss),this.#t=new an(r.midRed),this.#r=new ze({color:r.pureBlack}),this.#e.enabled=!1,this.#t.enabled=!1,this.#r.enabled=!1,this.output.filters=[this.#e,this.#t,this.#r]}output=new M({label:"ItemFlashOnSwitchedRenderer"});#e;#t;#r;tick(e){const{renderContext:{item:{state:{switchedAtRoomTime:t,switchedSetting:r}},room:{roomTime:s}}}=this,o=s-t<pp,i=r==="left";this.#e.enabled=o&&i,this.#t.enabled=o&&!i,this.#r.enabled=o,this.childRenderer.tick(e)}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const gp=(n,e)=>{const{item:t,room:{items:r}}=n;return Re(r).filter(sl).some(({config:{modifies:o}})=>o.some(i=>i.targets===void 0?i.expectType===t.type:i.targets.includes(t.id)))?new fp(n,e):e},mp=(n,e,t,r)=>{const s=1/r;n.x=zs(e,s),n.y=zs(t,s)},Ai=new Pl;Ai.matrix=[0,0,0,1,0,0,.3,0,0,0,0,0,.3,0,0,0,0,0,1,0];class xp{constructor(e,t){this.renderContext=e,this.wrappedRenderer=t,this.output=new M({label:`ItemPositionRenderer ${e.item.id}`,children:[t.output]}),this.#t()}output;#e=new Map;#t(){const{general:{upscale:{gameEngineUpscale:e}}}=this.renderContext,t=L(this.renderContext.item.state.position);mp(this.output,t.x,t.y,e)}tick(e){this.wrappedRenderer?.tick(e),e.movedItems.has(this.renderContext.item)&&this.#t(),this.#o()}#r(){const e=this.renderContext.item.id,t=this.renderContext.zEdges.get(e);if(!t)return Vr;let r;for(const[s,o]of t)o&&(r||(r=new Set),r.add(s));return r??Vr}#n(e,t){const r=new M({label:`maskWith: ${e}`,children:[t,this.output.children[0]]});return this.output.addChild(r),r.setMask({mask:t,inverse:!0}),this.#e.set(e,r),r}#s(e,t){const[r,s]=t.children,o=t.parent;o.removeChild(t),o.addChild(s),t.mask=null,r.destroy(),t.destroy(),this.#e.delete(e)}#o(){const{pixiRenderer:e}=this.renderContext.general,t=this.#r();for(const r of this.#e.keys())if(!t.has(r)){const s=this.#e.get(r);if(s)try{this.#s(r,s)}catch(o){throw new Error(`error while destroying masking container ${ar(s)} 
              for our rendering: ${ar(this.output)}`,{cause:o})}}for(const r of t){const s=this.#e.get(r),o=s?.children[0],i=this.renderContext.getItemRenderPipeline(r)?.itemAppearanceRenderer?.output;if(i===void 0)throw new Error("nothing to use as a mask");const a=i.filters;i.filters=Ai;const l=pe(e,i,o,`red mask: ${r}`);i.filters=a,s===void 0&&this.#n(r,l);const c=this.renderContext.room.items[r],u=Oe(L(c.state.position),L(this.renderContext.item.state.position));l.x=u.x,l.y=u.y}}destroy(){this.output.destroy({children:!0}),this.wrappedRenderer?.destroy()}}const Dr=(n,e=1)=>({renderContext:{item:{state:{facing:t}}},currentRendering:r})=>{const s=r?.renderProps,o=wn(t)??"towards";if(!(s===void 0||o!==s.facingXy4))return"no-update";const a=_({textureId:o==="left"||o==="away"?`shadowMask.${n}.away`:`shadowMask.${n}.right`,spritesheetVariant:"original"});return a.y=-(j.z*(e-1)),a.scale.x=o==="away"||o==="right"?1:-1,{output:a,renderProps:{facingXy4:o}}},yp={left:"away",towardsLeft:"awayRight",towards:"right"},wp=(n,e,t)=>{if(!e)return`shadowMask.${n}.${t}`;const r=`shadowMask.${n}.falling.${t}`;return Co(r)?r:`shadowMask.${n}.${t}`},Ur=(n,e=1)=>({renderContext:{item:t},currentRendering:r})=>{const s=t.type==="sceneryPlayer"?"idle":t.state.action,o=r?.renderProps,i=t.type==="sceneryPlayer"?t.config.startDirection:xn(t.state.visualFacingVector??t.state.facing)??"towards",a=s==="falling";if(!(o===void 0||i!==o.facingXy8||a!==o.falling))return"no-update";const c=yp[i],d=wp(n,a,c??i),h=_({textureId:d,spritesheetVariant:"original"});return h.y=-(j.z*(e-1)),h.scale.x=c===void 0?1:-1,{output:h,renderProps:{facingXy8:i,falling:a}}},vp=({renderContext:{general:{pixiRenderer:n},item:e,room:t},currentRendering:r})=>{const{state:{stoodOnBy:s},config:{times:o}}=e,i=r?.renderProps,a=On(e),l=a&&Rt(s,t).find(_n)!==void 0;return i===void 0||a!==i.activated||l!==i.flashing?{output:ht(n,pr({textureId:l?"shadowMask.teleporter.flashing":a?"shadowMask.teleporter":"shadowMask.artificial",spritesheetVariant:"original"},o)),renderProps:{flashing:l,activated:a}}:"no-update"},$r={lift:ie({textureId:"shadowMask.smallBlock",spritesheetVariant:"original"}),conveyor:Me(({direction:n})=>({textureId:"shadowMask.conveyor",flipX:Be(n)==="x",spritesheetVariant:"original"})),doorLegs:Me(({direction:n})=>({textureId:n==="right"||n==="towards"?"shadowMask.door.floatingThreshold.double.y":"shadowMask.door.legs.threshold.double.y",flipX:Be(n)==="y",spritesheetVariant:"original"})),teleporter:vp,floor:"no-mask",barrier:Me(({axis:n})=>({textureId:"shadowMask.barrier.y",flipX:n==="x",y:-1,spritesheetVariant:"original"})),spring:Uh,block:Me(({style:n})=>({textureId:`shadowMask.${n}`,spritesheetVariant:"original"})),pushableBlock:ie({textureId:"shadowMask.stepStool",spritesheetVariant:"original"}),movingPlatform:ie({textureId:"shadowMask.sandwich",spritesheetVariant:"original"}),hushPuppy:ie({textureId:"shadowMask.hushPuppy",spritesheetVariant:"original"}),portableBlock:Me(({style:n})=>({textureId:n==="drum"?"shadowMask.drum":"shadowMask.smallBlock",spritesheetVariant:"original"})),slidingBlock:Me(({style:n})=>n==="book"?{textureId:"shadowMask.book",flipX:!0,spritesheetVariant:"original"}:{textureId:"shadowMask.smallRound",spritesheetVariant:"original"}),deadlyBlock:Me(({style:n})=>({textureId:n==="volcano"?"shadowMask.volcano":"shadowMask.toaster",spritesheetVariant:"original"})),spikes:ie({textureId:"shadowMask.spikes",spritesheetVariant:"original"}),switch:ie({textureId:"shadowMask.switch",spritesheetVariant:"original"}),button:ie({textureId:"shadowMask.buttonInGame",spritesheetVariant:"original"}),pickup:Me(({gives:n})=>{switch(n){case"scroll":return{textureId:"shadowMask.scroll",spritesheetVariant:"original"};case"doughnuts":return{textureId:"shadowMask.doughnuts",spritesheetVariant:"original"};case"fast":case"extra-life":case"jumps":case"shield":return{textureId:"shadowMask.whiteRabbit",spritesheetVariant:"original"};default:return{textureId:"blank",spritesheetVariant:"original"}}}),slidingDeadly:ie({textureId:"shadowMask.smallRound",spritesheetVariant:"original"}),ball:ie({textureId:"shadowMask.ball",spritesheetVariant:"original"}),"monster.dalek":ie({textureId:"shadowMask.dalek",spritesheetVariant:"original"}),"monster.turtle":Dr("turtle"),"monster.skiHead":Dr("skiHead"),"monster.homingBot":ie({textureId:"shadowMask.smallRound",spritesheetVariant:"original"}),joystick:ie({textureId:"shadowMask.joystick",spritesheetVariant:"original"}),charles:Dr("charles",2),head:Ur("head"),heels:Ur("heels"),headOverHeels:Ur("head",2)},bp=n=>{switch(n.type){case"sceneryPlayer":return $r[n.config.which];case"monster":return $r[`monster.${n.config.which}`];case"floor":return n.config.floorType==="none"?void 0:"no-mask";default:return $r[n.type]}},Sp=.66,Cp=n=>n.shadowCastTexture!==void 0,st={id:"spaceAbove",state:{position:{x:0,y:0,z:0}},aabb:{x:0,y:0,z:il}};class Tp{constructor(e,t){this.renderContext=e,this.appearance=t,this.#e.addChild(this.#t),this.#s||(this.#e.filters=new Il({alpha:Sp}))}#e=new M({label:"ItemShadowRenderer"});#t=new M({label:"shadows"});#r;#n=new Map;initShadowMaskRenderer(){const{renderContext:e,appearance:t}=this;if(t!=="no-mask")if(this.#r=new Ri(e,t),e.item.shadowOffset===void 0)this.#e.addChild(this.#r.output);else{const r=new M({label:"shadowMaskOffset",children:[this.#r.output],...L(e.item.shadowOffset)});this.#e.addChild(r)}}get#s(){return O.getState().gameMenus.userSettings.displaySettings.showShadowMasks}#o(e){if(this.#r===void 0)return;const t=this.#r.output.children.at(0);this.#r.tick(e);const r=this.#r.output.children.at(0);if(r===void 0||!(r instanceof le)){const{item:s}=this.renderContext;throw new Error(`ItemShadowRenderer: this.#shadowMaskRenderer didn't create a sprite for item "${s.id}" of type "${s.type}". Have got ${r}`)}t!==r&&(this.#s?this.renderContext.frontLayer.attach(r):this.#e.mask=r)}destroy(){this.#e.destroy(!0),this.#r?.destroy();for(const e of Object.values(this.#n))e.sprite.destroy()}tick(e){const{movedItems:t}=e,{item:r,general:{pixiRenderer:s},room:o}=this.renderContext,i=t.has(r),a=r.state.position.z+r.aabb.z;st.state.position.x=r.state.position.x,st.state.position.y=r.state.position.y,st.state.position.z=a,st.aabb.x=r.aabb.x,st.aabb.y=r.aabb.y;const l=new Set(ol(st,o[bo],u=>u!==r&&Cp(u)&&(u.castsShadowWhileStoodOn||u.state.position.z>r.state.position.z+r.aabb.z)&&!u.noShadowCastOn?.includes(r.type)));let c=!1;for(const[u,d]of this.#n)l.has(u)||(this.#t.removeChild(d),d.destroy(),this.#n.delete(u));for(const u of l){c=!0;let d=this.#n.get(u),h=!1;if(!d){const{times:p}=u.config,{shadowCastTexture:f}=u,m=pr(typeof f=="string"?{textureId:f}:f,p);d=ht(s,m),d.label=u.id,this.#t.addChild(d),this.#n.set(u,d),h=!0}if(h||i||t.has(u)){const p=L({...vt(Oe(u.state.position,r.state.position),u.shadowOffset??He),z:r.aabb.z});d.x=p.x,d.y=p.y}}this.#e.visible=c,c?(this.#r===void 0&&this.initShadowMaskRenderer(),this.#o(e)):this.#r!==void 0&&(this.#r.destroy(),this.#r=void 0)}get output(){return this.#e}}const _p=n=>{const e=bp(n.item);return e===void 0?void 0:new Tp(n,e)};class kp{constructor(e,t){this.renderContext=e,this.componentRenderers=t,this.output={graphics:t.graphics?.output,sound:t.sound?.output}}output;tick(e){this.componentRenderers.graphics?.tick(e),this.componentRenderers.sound?.tick(e)}destroy(){this.componentRenderers.graphics?.destroy(),this.componentRenderers.sound?.destroy()}}class Ip{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output);const{general:{colourised:r},room:s}=e;this.#e=new ze({color:r?(s.color.shade==="dimmed"?dr:S).moss:ct(s.color)}),this.#e.enabled=!1,this.output.filters=this.#e}output=new M({label:"PortableItemPickUpNextHighlightRenderer"});#e;tick(e){const{wouldPickUpNext:t}=this.renderContext.item.state;this.#e.enabled=t,this.childRenderer.tick(e)}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const Mp=(n,e,t)=>al(n)?new Ip(e,t):t,Pp=(n,e)=>{const{gameMenus:{cheatsOn:t}}=O.getState();e!==void 0&&t&&(e.eventMode="static",e.on("pointertap",()=>{O.dispatch(wa({item:n,pixiContainer:e}))}))},Rp=n=>{const e=O.getState(),t=xa(e),r=!ya(e),{general:{paused:s}}=n,{item:o}=n,i=t==="all"||t==="non-wall"&&n.item.type!=="wall",a=[],l=Zh(o);let c;if(l!==void 0){c=new Ri(n,l);const f=gp(n,c);a.push(cp(o,n,Mp(o,n,f)))}if(r&&!s){const f=_p(n);f!==void 0&&a.push(f)}i&&a.push(new hp(n));let u;if(a.length===0)u=void 0;else{const f=a.length===1?a[0]:new Kh(a,n);u=new xp(n,f),Pp(o,u.output)}const d=n.general.soundSettings.mute??yn.soundSettings.mute,h=s||d?void 0:$u(n),p=h===void 0?void 0:o.noSoundPan?h:new Xu(n,h);return{top:new kp(n,{graphics:u,sound:p}),itemAppearanceRenderer:c}};class Ap{constructor(e){this.renderContext=e;const{general:{colourised:t,soundSettings:r},room:s}=e,i=r.mute??yn.soundSettings.mute?void 0:P.createGain();this.output={sound:i,graphics:new M({label:`RoomRenderer(${e.room.id})`})},this.output.graphics.addChild(this.#t),t||(this.#r=new ls({sortableChildren:!1}),this.output.graphics.addChild(this.#r)),this.output.graphics.addChild(this.#n),t||(this.#t.tint=ct(s.color))}#e=!1;#t=new M({label:"items",cullableChildren:!0});#r;#n=new ls({sortableChildren:!1});output;#s=void 0;#o=new Map;#i=new Map;#a=e=>this.#i.get(e);#c(e,t){let r=this.#i.get(t.id);if(r===void 0){r=Rp({...this.renderContext,colourClashLayer:this.#r,frontLayer:this.#n,item:t,zEdges:this.#o,getItemRenderPipeline:this.#a}),this.#i.set(t.id,r);const{graphics:s,sound:o}=r.top.output;if(s&&(this.#t.addChild(s),t.fixedZIndex&&(s.zIndex=t.fixedZIndex)),o){if(!this.output.sound)throw new Error("item renderer has sound, but room renderer does not - this probably means that they disagree on if the user has sound muted");o.connect(this.output.sound)}}try{r.top.tick(e)}catch(s){throw new Error(`RoomRenderer: error while ticking item "${t.id}"
in room "${this.renderContext.room.id}"
item in play object is:
           
${JSON.stringify(t,null,2)}`,{cause:s})}}#u(e){const{room:t}=this.renderContext,r={...e,lastRenderRoomTime:this.#s},s=new Set,o=a=>{if(s.has(a))return;const l=this.#o.get(a);if(l)for(const[c,u]of l.entries())u&&o(c);this.#c(r,t.items[a]),s.add(a)};for(const a in t.items)o(a);let i=!1;for(const[a,l]of this.#i.entries())t.items[a]===void 0&&(l.top.destroy(),this.#i.delete(a),i=!0);i&&this.#d()}#d(){if(this.#r)for(const e of this.#r.renderLayerChildren)e.parent===null&&this.#r.detach(e);for(const e of this.#n.renderLayerChildren)e.parent===null&&this.#n.detach(e)}#h(e){for(let t=0;t<e.length;t++){const r=this.#i.get(e[t]);if(r===void 0)throw new Error(`Item id=${e[t]} does not have a renderer - cannot assign a z-index`);const s=r.top.output.graphics;if(!s)throw new Error(`order ${e[t]} was given a z-order by sorting, but item has no graphics`);s.zIndex=t}}get#l(){return this.#s!==void 0}tick(e){const t=this.#l?e:{...e,movedItems:new Set(Re(this.renderContext.room.items))},{renderContext:{room:r}}=this;oi(r.items,r[bo],t.movedItems,this.#o);const s=ti(this.#o);this.#u(t),(!this.#l||t.movedItems.size>0)&&this.#h(s),this.#s=this.renderContext.room.roomTime}destroy(){this.output.graphics.label=this.output.graphics.label+"DESTROYED",this.output.graphics.destroy({children:!0});const{sound:e}=this.output;if(e){const t=An*1e3;setTimeout(()=>{e.disconnect()},t)}this.#i.forEach(t=>{t.top.destroy()}),this.#e=!0}get destroyed(){return this.#e}}const Op=(n,e)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:e},soundSettings:{mute:!0},pixiRenderer:n,gameState:void 0,paused:!1,colourised:!0,upscale:pn(O.getState()),editor:!0}),qs=(n,e,t)=>new Ap({room:n,general:Op(e,t)}),Bp=()=>{const{renderer:n}=Fe(),e=va();if(!n)throw new Error("this should never be falsey (typescript violation)");const t=In(),[r,s]=U.useState(()=>qs(t,n,e));return U.useEffect(()=>{const o=qs(t,n,e);return s(o),()=>{o.destroy()}},[t,n,e]),r},zp=n=>{const e=In(),t=Fe();U.useEffect(()=>{const r=({deltaMS:s})=>{if(n.destroyed)return;n.renderContext.room!==e&&console.warn("room renderer does not have the current room");const o=new Set(Yr(e.items));e.roomTime+=s,n.tick({deltaMS:s,movedItems:o}),t.render()};return ve.shared.add(r),()=>{ve.shared.remove(r)}},[n,e,t])},Fp=(n,e,t,r)=>{{const s=r.shade==="dimmed";md(n,e,t,r),Sd(n,t,r),kd(n,s),Rd(n,s)}},Ep=()=>{const{renderer:n}=Fe();if(!n)throw new Error("this should never be falsey (typescript violation)");const{planet:e,color:t}=In();U.useEffect(()=>{ba(n)},[n]),U.useEffect(()=>{Fp(n,!0,e,t)},[t,n,e])};Ct.defaultOptions.scaleMode="nearest";const Lp=()=>{const n=Bp(),[e,t]=U.useState(null),[r,s]=U.useState(null),[o,i]=U.useState("amigaLowResPal"),a=lu();return wc(o,r??void 0),iu(),ru(n),Ep(),zp(n),Jc(e),tu(e),su(),ou(),nu(r,e),se.jsxs("div",{className:"w-full h-full relative",children:[se.jsx(eu,{selectedResolution:o,onResolutionChange:i}),se.jsx("div",{ref:s,className:`w-full h-full ${a} scale-editor bg-editor-checkerboard overflow-scroll scrollbar scrollbar-w-1 scrollbar-track-pureBlack scrollbar-thumb-metallicBlue`,children:se.jsx("div",{style:{transform:vc(),transformOrigin:"center center"},ref:t,tabIndex:1,className:"focus-visible:outline-none"})})]})},Wp=()=>se.jsx($c,{children:se.jsx(Lp,{})}),Hp=Object.freeze(Object.defineProperty({__proto__:null,default:Wp},Symbol.toStringTag,{value:"Module"}));export{Mo as A,fc as B,_o as C,_l as R,vl as S,Po as V,Ol as a,Kr as b,G as c,Yt as d,Bl as e,Hp as f,jp as l,wl as u};
