const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/WebGPURenderer-DOfS2vcT.js","assets/index-B6K_Irl4.js","assets/index-Dqb_537q.css","assets/colorToUniform-3MxHuUz8.js","assets/SharedSystems-BXypR5E3.js","assets/CanvasTextGenerator-DeW2Jc0B.js","assets/levelEditorSlice-CErNxXB-.js","assets/RoomJson-DkxgJaz9.js","assets/LevelEditor-D2AOUI8d.js","assets/halfBrite-C2Zamgwx.js","assets/WebGLRenderer-DlorIj2q.js"])))=>i.map(i=>d[i]);
import{r as tn,g as rn,j as wr,h as Ge,E as ys,u as ws,k as v,d as ue,v as he,C as Pe,c as vs,D as Kt,b2 as Xr,Q as ye,W as on,X as we,b3 as ve,H as nn,a2 as V,T as F,e as ae,U as bs,M as Cs,b4 as ke,b5 as sn,b6 as Ss,a8 as Qt,w as Is,b7 as an,b8 as P,b9 as Nr,aF as C,aj as Ct,ba as vr,bb as er,aq as q,ao as K,bc as ks,bd as Ts,be as br,ap as re,bf as Ms,az as Ps,ar as Ae,bg as D,bh as H,as as Rs,aC as Ne,aD as oe,aI as As,a$ as ut,au as tr,aZ as Cr,bi as fe,bj as rr,i as Y,aH as Sr,aP as qr,aO as _s,bk as rt,bl as cn,an as St,bm as Ir,bn as kr,bo as ln,bp as qe,bq as Os,br as zs,bs as Bs,bt as Re,bu as He,ay as me,bv as Es,bw as $s,bx as Fs,by as Zr,bz as We,ab as ge,bA as Rt,bB as At,ak as dn,aR as un,bC as Ls,aT as Ds,bD as Tr,bE as js,aW as pe,aB as Mr,bF as Ve,bG as hn,bH as ot,R as Vs,bI as Us,bJ as Gs,bK as Z,aX as Hs,bL as Ws,am as ht,bM as Yr,bN as Xs,bO as Ns,bP as qs,bQ as Zs,bR as Ys}from"./index-B6K_Irl4.js";import{G as Js,p as Ks,a as Pr,b as Rr,c as Ar,d as Qs,e as ei,f as ti,u as ri,i as ee,g as oi,h as ni,j as R,o as si,s as pn,k as fn,l as mn,m as _r,n as pt,q as ii,w as gn,r as ai,t as ci,v as or,x as Jr,y as li,z as xn,A as yn,B as di,C as ui,D as _t,E as wn,F as hi,H as pi,I as fi,J as mi,K as gi,L as nt,M as Ot,N as je,O as xi,P as vn,Q as nr,R as yi,S as Or,T as bn,U as wi,V as vi,W as zr,X as Cn,Y as bi,Z as ft,_ as Ci,$ as Si,a0 as xe,a1 as Br,a2 as It,a3 as M,a4 as Ii,a5 as ki,a6 as Ti,a7 as Mi,a8 as Kr,a9 as Pi,aa as Qr,ab as Ri,ac as Ai,ad as eo,ae as _i,af as Oi,ag as zi,ah as Bi,ai as Sn,aj as Ei,ak as $i,al as Er}from"./levelEditorSlice-CErNxXB-.js";import{o as sr}from"./RoomJson-DkxgJaz9.js";import{s as g,a as Fi,i as Li,g as Di,u as ji,B as zt,T as to,t as L,b as Vi,r as O,c as kt,d as Ui,e as In,f as kn,h as $r}from"./LevelEditor-D2AOUI8d.js";import{h as ie,s as Gi}from"./halfBrite-C2Zamgwx.js";import{T as Hi,a as ro,b as Wi}from"./CanvasTextGenerator-DeW2Jc0B.js";var st={},oo;function Xi(){if(oo)return st;oo=1;const{wrapWithIterableIterator:r,ensureIterable:e}=tn();function*t(...n){for(const s of n)yield*e(s)}st.__concat=t;const o=r(t);return st.concat=o,st}var it={},no;function Ni(){if(no)return it;no=1;const{ensureIterable:r}=tn();function e(o){const n=r(o);let s=0;for(const i of n)s++;return s}it.__size=e;const t=e;return it.size=t,it}var Bt,so;function qi(){return so||(so=1,Bt=Xi().concat),Bt}var Zi=qi();const Yi=rn(Zi);var Et,io;function Ji(){return io||(io=1,Et=Ni().size),Et}var Ki=Ji();const Tn=rn(Ki),ir=[];wr.handleByNamedList(Ge.Environment,ir);async function Qi(r){if(!r)for(let e=0;e<ir.length;e++){const t=ir[e];if(t.value.test()){await t.value.load();return}}}let Ee;function ea(){if(typeof Ee=="boolean")return Ee;try{Ee=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{Ee=!1}return Ee}var Mn=(r=>(r[r.NONE=0]="NONE",r[r.COLOR=16384]="COLOR",r[r.STENCIL=1024]="STENCIL",r[r.DEPTH=256]="DEPTH",r[r.COLOR_DEPTH=16640]="COLOR_DEPTH",r[r.COLOR_STENCIL=17408]="COLOR_STENCIL",r[r.DEPTH_STENCIL=1280]="DEPTH_STENCIL",r[r.ALL=17664]="ALL",r))(Mn||{});class ta{constructor(e){this.items=[],this._name=e}emit(e,t,o,n,s,i,c,a){const{name:l,items:d}=this;for(let h=0,u=d.length;h<u;h++)d[h][l](e,t,o,n,s,i,c,a);return this}add(e){return e[this._name]&&(this.remove(e),this.items.push(e)),this}remove(e){const t=this.items.indexOf(e);return t!==-1&&this.items.splice(t,1),this}contains(e){return this.items.indexOf(e)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const ra=["init","destroy","contextChange","resolutionChange","resetState","renderEnd","renderStart","render","update","postrender","prerender"],Pn=class Rn extends ys{constructor(e){super(),this.tick=0,this.uid=ws("renderer"),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=e.type,this.name=e.name,this.config=e;const t=[...ra,...this.config.runners??[]];this._addRunners(...t),this._unsafeEvalCheck()}async init(e={}){const t=e.skipExtensionImports===!0?!0:e.manageImports===!1;await Qi(t),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const o in this._systemsHash)e={...this._systemsHash[o].constructor.defaultOptions,...e};e={...Rn.defaultOptions,...e},this._roundPixels=e.roundPixels?1:0;for(let o=0;o<this.runners.init.items.length;o++)await this.runners.init.items[o].init(e);this._initOptions=e}render(e,t){this.tick++;let o=e;if(o instanceof v&&(o={container:o},t&&(ue(he,"passing a second argument is deprecated, please use render options instead"),o.target=t.renderTexture)),o.target||(o.target=this.view.renderTarget),o.target===this.view.renderTarget&&(this._lastObjectRendered=o.container,o.clearColor??(o.clearColor=this.background.colorRgba),o.clear??(o.clear=this.background.clearBeforeRender)),o.clearColor){const n=Array.isArray(o.clearColor)&&o.clearColor.length===4;o.clearColor=n?o.clearColor:Pe.shared.setValue(o.clearColor).toArray()}o.transform||(o.container.updateLocalTransform(),o.transform=o.container.localTransform),o.container.visible&&(o.container.enableRenderGroup(),this.runners.prerender.emit(o),this.runners.renderStart.emit(o),this.runners.render.emit(o),this.runners.renderEnd.emit(o),this.runners.postrender.emit(o))}resize(e,t,o){const n=this.view.resolution;this.view.resize(e,t,o),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),o!==void 0&&o!==n&&this.runners.resolutionChange.emit(o)}clear(e={}){const t=this;e.target||(e.target=t.renderTarget.renderTarget),e.clearColor||(e.clearColor=this.background.colorRgba),e.clear??(e.clear=Mn.ALL);const{clear:o,clearColor:n,target:s}=e;Pe.shared.setValue(n??this.background.colorRgba),t.renderTarget.clear(s,o,Pe.shared.toArray())}get resolution(){return this.view.resolution}set resolution(e){this.view.resolution=e,this.runners.resolutionChange.emit(e)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...e){e.forEach(t=>{this.runners[t]=new ta(t)})}_addSystems(e){let t;for(t in e){const o=e[t];this._addSystem(o.value,o.name)}}_addSystem(e,t){const o=new e(this);if(this[t])throw new Error(`Whoops! The name "${t}" is already in use`);this[t]=o,this._systemsHash[t]=o;for(const n in this.runners)this.runners[n].add(o);return this}_addPipes(e,t){const o=t.reduce((n,s)=>(n[s.name]=s.value,n),{});e.forEach(n=>{const s=n.value,i=n.name,c=o[i];this.renderPipes[i]=new s(this,c?new c:null),this.runners.destroy.add(this.renderPipes[i])})}destroy(e=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(e),(e===!0||typeof e=="object"&&e.releaseGlobalResources)&&vs.release(),Object.values(this.runners).forEach(t=>{t.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(e){return this.textureGenerator.generateTexture(e)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!ea())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}resetState(){this.runners.resetState.emit()}};Pn.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let An=Pn,at;function oa(r){return at!==void 0||(at=(()=>{const e={stencil:!0,failIfMajorPerformanceCaveat:r??An.defaultOptions.failIfMajorPerformanceCaveat};try{if(!Kt.get().getWebGLRenderingContext())return!1;let o=Kt.get().createCanvas().getContext("webgl",e);const n=!!o?.getContextAttributes()?.stencil;if(o){const s=o.getExtension("WEBGL_lose_context");s&&s.loseContext()}return o=null,n}catch{return!1}})()),at}let ct;async function na(r={}){return ct!==void 0||(ct=await(async()=>{const e=Kt.get().getNavigator().gpu;if(!e)return!1;try{return await(await e.requestAdapter(r)).requestDevice(),!0}catch{return!1}})()),ct}const ao=["webgl","webgpu","canvas"];async function sa(r){let e=[];r.preference?(e.push(r.preference),ao.forEach(s=>{s!==r.preference&&e.push(s)})):e=ao.slice();let t,o={};for(let s=0;s<e.length;s++){const i=e[s];if(i==="webgpu"&&await na()){const{WebGPURenderer:c}=await Xr(async()=>{const{WebGPURenderer:a}=await import("./WebGPURenderer-DOfS2vcT.js");return{WebGPURenderer:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]));t=c,o={...r,...r.webgpu};break}else if(i==="webgl"&&oa(r.failIfMajorPerformanceCaveat??An.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:c}=await Xr(async()=>{const{WebGLRenderer:a}=await import("./WebGLRenderer-DlorIj2q.js");return{WebGLRenderer:a}},__vite__mapDeps([10,1,2,3,4,6,7,8,9,5]));t=c,o={...r,...r.webgl};break}else if(i==="canvas")throw o={...r},new Error("CanvasRenderer is not yet implemented")}if(delete o.webgpu,delete o.webgl,!t)throw new Error("No available renderer for the current environment");const n=new t;return await n.init(o),n}const _n="8.15.0";class On{static init(){globalThis.__PIXI_APP_INIT__?.(this,_n)}static destroy(){}}On.extension=Ge.Application;class ia{constructor(e){this._renderer=e}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,_n)}destroy(){this._renderer=null}}ia.extension={type:[Ge.WebGLSystem,Ge.WebGPUSystem],name:"initHook",priority:-10};const zn=class ar{constructor(...e){this.stage=new v,e[0]!==void 0&&ue(he,"Application constructor options are deprecated, please use Application.init() instead.")}async init(e){e={...e},this.stage||(this.stage=new v),this.renderer=await sa(e),ar._plugins.forEach(t=>{t.init.call(this,e)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return ue(he,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(e=!1,t=!1){const o=ar._plugins.slice(0);o.reverse(),o.forEach(n=>{n.destroy.call(this)}),this.stage.destroy(t),this.stage=null,this.renderer.destroy(e),this.renderer=null}};zn._plugins=[];let Bn=zn;wr.handleByList(Ge.Application,Bn._plugins);wr.add(On);var aa=`
in vec2 vTextureCoord;

out vec4 finalColor;

uniform float uAlpha;
uniform sampler2D uTexture;

void main()
{
    finalColor =  texture(uTexture, vTextureCoord) * uAlpha;
}
`,co=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct AlphaUniforms {
  uAlpha:f32,
};

@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;

@group(1) @binding(0) var<uniform> alphaUniforms : AlphaUniforms;

struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>
  };

fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
    return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

fn globalTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return  (aPosition.xy / gfu.uGlobalFrame.zw) + (gfu.uGlobalFrame.xy / gfu.uGlobalFrame.zw);  
}

fn getSize() -> vec2<f32>
{
  return gfu.uGlobalFrame.zw;
}
  
@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition)
  );
}

@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
  @builtin(position) position: vec4<f32>
) -> @location(0) vec4<f32> {
 
    var sample = textureSample(uTexture, uSampler, uv);
    
    return sample * alphaUniforms.uAlpha;
}`;const En=class $n extends ye{constructor(e){e={...$n.defaultOptions,...e};const t=on.from({vertex:{source:co,entryPoint:"mainVertex"},fragment:{source:co,entryPoint:"mainFragment"}}),o=we.from({vertex:ve,fragment:aa,name:"alpha-filter"}),{alpha:n,...s}=e,i=new nn({uAlpha:{value:n,type:"f32"}});super({...s,gpuProgram:t,glProgram:o,resources:{alphaUniforms:i}})}get alpha(){return this.resources.alphaUniforms.uniforms.uAlpha}set alpha(e){this.resources.alphaUniforms.uniforms.uAlpha=e}};En.defaultOptions={alpha:1};let ca=En;var la=`
in vec2 vTextureCoord;
in vec4 vColor;

out vec4 finalColor;

uniform float uColorMatrix[20];
uniform float uAlpha;

uniform sampler2D uTexture;

float rand(vec2 co)
{
    return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);
}

void main()
{
    vec4 color = texture(uTexture, vTextureCoord);
    float randomValue = rand(gl_FragCoord.xy * 0.2);
    float diff = (randomValue - 0.5) *  0.5;

    if (uAlpha == 0.0) {
        finalColor = color;
        return;
    }

    if (color.a > 0.0) {
        color.rgb /= color.a;
    }

    vec4 result;

    result.r = (uColorMatrix[0] * color.r);
        result.r += (uColorMatrix[1] * color.g);
        result.r += (uColorMatrix[2] * color.b);
        result.r += (uColorMatrix[3] * color.a);
        result.r += uColorMatrix[4];

    result.g = (uColorMatrix[5] * color.r);
        result.g += (uColorMatrix[6] * color.g);
        result.g += (uColorMatrix[7] * color.b);
        result.g += (uColorMatrix[8] * color.a);
        result.g += uColorMatrix[9];

    result.b = (uColorMatrix[10] * color.r);
       result.b += (uColorMatrix[11] * color.g);
       result.b += (uColorMatrix[12] * color.b);
       result.b += (uColorMatrix[13] * color.a);
       result.b += uColorMatrix[14];

    result.a = (uColorMatrix[15] * color.r);
       result.a += (uColorMatrix[16] * color.g);
       result.a += (uColorMatrix[17] * color.b);
       result.a += (uColorMatrix[18] * color.a);
       result.a += uColorMatrix[19];

    vec3 rgb = mix(color.rgb, result.rgb, uAlpha);

    // Premultiply alpha again.
    rgb *= result.a;

    finalColor = vec4(rgb, result.a);
}
`,lo=`struct GlobalFilterUniforms {
  uInputSize:vec4<f32>,
  uInputPixel:vec4<f32>,
  uInputClamp:vec4<f32>,
  uOutputFrame:vec4<f32>,
  uGlobalFrame:vec4<f32>,
  uOutputTexture:vec4<f32>,
};

struct ColorMatrixUniforms {
  uColorMatrix:array<vec4<f32>, 5>,
  uAlpha:f32,
};


@group(0) @binding(0) var<uniform> gfu: GlobalFilterUniforms;
@group(0) @binding(1) var uTexture: texture_2d<f32>;
@group(0) @binding(2) var uSampler : sampler;
@group(1) @binding(0) var<uniform> colorMatrixUniforms : ColorMatrixUniforms;


struct VSOutput {
    @builtin(position) position: vec4<f32>,
    @location(0) uv : vec2<f32>,
  };
  
fn filterVertexPosition(aPosition:vec2<f32>) -> vec4<f32>
{
    var position = aPosition * gfu.uOutputFrame.zw + gfu.uOutputFrame.xy;

    position.x = position.x * (2.0 / gfu.uOutputTexture.x) - 1.0;
    position.y = position.y * (2.0*gfu.uOutputTexture.z / gfu.uOutputTexture.y) - gfu.uOutputTexture.z;

    return vec4(position, 0.0, 1.0);
}

fn filterTextureCoord( aPosition:vec2<f32> ) -> vec2<f32>
{
  return aPosition * (gfu.uOutputFrame.zw * gfu.uInputSize.zw);
}

@vertex
fn mainVertex(
  @location(0) aPosition : vec2<f32>, 
) -> VSOutput {
  return VSOutput(
   filterVertexPosition(aPosition),
   filterTextureCoord(aPosition),
  );
}


@fragment
fn mainFragment(
  @location(0) uv: vec2<f32>,
) -> @location(0) vec4<f32> {


  var c = textureSample(uTexture, uSampler, uv);
  
  if (colorMatrixUniforms.uAlpha == 0.0) {
    return c;
  }

 
    // Un-premultiply alpha before applying the color matrix. See issue #3539.
    if (c.a > 0.0) {
      c.r /= c.a;
      c.g /= c.a;
      c.b /= c.a;
    }

    var cm = colorMatrixUniforms.uColorMatrix;


    var result = vec4<f32>(0.);

    result.r = (cm[0][0] * c.r);
    result.r += (cm[0][1] * c.g);
    result.r += (cm[0][2] * c.b);
    result.r += (cm[0][3] * c.a);
    result.r += cm[1][0];

    result.g = (cm[1][1] * c.r);
    result.g += (cm[1][2] * c.g);
    result.g += (cm[1][3] * c.b);
    result.g += (cm[2][0] * c.a);
    result.g += cm[2][1];

    result.b = (cm[2][2] * c.r);
    result.b += (cm[2][3] * c.g);
    result.b += (cm[3][0] * c.b);
    result.b += (cm[3][1] * c.a);
    result.b += cm[3][2];

    result.a = (cm[3][3] * c.r);
    result.a += (cm[4][0] * c.g);
    result.a += (cm[4][1] * c.b);
    result.a += (cm[4][2] * c.a);
    result.a += cm[4][3];

    var rgb = mix(c.rgb, result.rgb, colorMatrixUniforms.uAlpha);

    rgb.r *= result.a;
    rgb.g *= result.a;
    rgb.b *= result.a;

    return vec4(rgb, result.a);
}`;class da extends ye{constructor(e={}){const t=new nn({uColorMatrix:{value:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],type:"f32",size:20},uAlpha:{value:1,type:"f32"}}),o=on.from({vertex:{source:lo,entryPoint:"mainVertex"},fragment:{source:lo,entryPoint:"mainFragment"}}),n=we.from({vertex:ve,fragment:la,name:"color-matrix-filter"});super({...e,gpuProgram:o,glProgram:n,resources:{colorMatrixUniforms:t}}),this.alpha=1}_loadMatrix(e,t=!1){let o=e;t&&(this._multiply(o,this.matrix,e),o=this._colorMatrix(o)),this.resources.colorMatrixUniforms.uniforms.uColorMatrix=o,this.resources.colorMatrixUniforms.update()}_multiply(e,t,o){return e[0]=t[0]*o[0]+t[1]*o[5]+t[2]*o[10]+t[3]*o[15],e[1]=t[0]*o[1]+t[1]*o[6]+t[2]*o[11]+t[3]*o[16],e[2]=t[0]*o[2]+t[1]*o[7]+t[2]*o[12]+t[3]*o[17],e[3]=t[0]*o[3]+t[1]*o[8]+t[2]*o[13]+t[3]*o[18],e[4]=t[0]*o[4]+t[1]*o[9]+t[2]*o[14]+t[3]*o[19]+t[4],e[5]=t[5]*o[0]+t[6]*o[5]+t[7]*o[10]+t[8]*o[15],e[6]=t[5]*o[1]+t[6]*o[6]+t[7]*o[11]+t[8]*o[16],e[7]=t[5]*o[2]+t[6]*o[7]+t[7]*o[12]+t[8]*o[17],e[8]=t[5]*o[3]+t[6]*o[8]+t[7]*o[13]+t[8]*o[18],e[9]=t[5]*o[4]+t[6]*o[9]+t[7]*o[14]+t[8]*o[19]+t[9],e[10]=t[10]*o[0]+t[11]*o[5]+t[12]*o[10]+t[13]*o[15],e[11]=t[10]*o[1]+t[11]*o[6]+t[12]*o[11]+t[13]*o[16],e[12]=t[10]*o[2]+t[11]*o[7]+t[12]*o[12]+t[13]*o[17],e[13]=t[10]*o[3]+t[11]*o[8]+t[12]*o[13]+t[13]*o[18],e[14]=t[10]*o[4]+t[11]*o[9]+t[12]*o[14]+t[13]*o[19]+t[14],e[15]=t[15]*o[0]+t[16]*o[5]+t[17]*o[10]+t[18]*o[15],e[16]=t[15]*o[1]+t[16]*o[6]+t[17]*o[11]+t[18]*o[16],e[17]=t[15]*o[2]+t[16]*o[7]+t[17]*o[12]+t[18]*o[17],e[18]=t[15]*o[3]+t[16]*o[8]+t[17]*o[13]+t[18]*o[18],e[19]=t[15]*o[4]+t[16]*o[9]+t[17]*o[14]+t[18]*o[19]+t[19],e}_colorMatrix(e){const t=new Float32Array(e);return t[4]/=255,t[9]/=255,t[14]/=255,t[19]/=255,t}brightness(e,t){const o=[e,0,0,0,0,0,e,0,0,0,0,0,e,0,0,0,0,0,1,0];this._loadMatrix(o,t)}tint(e,t){const[o,n,s]=Pe.shared.setValue(e).toArray(),i=[o,0,0,0,0,0,n,0,0,0,0,0,s,0,0,0,0,0,1,0];this._loadMatrix(i,t)}greyscale(e,t){const o=[e,e,e,0,0,e,e,e,0,0,e,e,e,0,0,0,0,0,1,0];this._loadMatrix(o,t)}grayscale(e,t){this.greyscale(e,t)}blackAndWhite(e){const t=[.3,.6,.1,0,0,.3,.6,.1,0,0,.3,.6,.1,0,0,0,0,0,1,0];this._loadMatrix(t,e)}hue(e,t){e=(e||0)/180*Math.PI;const o=Math.cos(e),n=Math.sin(e),s=Math.sqrt,i=1/3,c=s(i),a=o+(1-o)*i,l=i*(1-o)-c*n,d=i*(1-o)+c*n,h=i*(1-o)+c*n,u=o+i*(1-o),p=i*(1-o)-c*n,f=i*(1-o)-c*n,m=i*(1-o)+c*n,x=o+i*(1-o),w=[a,l,d,0,0,h,u,p,0,0,f,m,x,0,0,0,0,0,1,0];this._loadMatrix(w,t)}contrast(e,t){const o=(e||0)+1,n=-.5*(o-1),s=[o,0,0,0,n,0,o,0,0,n,0,0,o,0,n,0,0,0,1,0];this._loadMatrix(s,t)}saturate(e=0,t){const o=e*2/3+1,n=(o-1)*-.5,s=[o,n,n,0,0,n,o,n,0,0,n,n,o,0,0,0,0,0,1,0];this._loadMatrix(s,t)}desaturate(){this.saturate(-1)}negative(e){const t=[-1,0,0,1,0,0,-1,0,1,0,0,0,-1,1,0,0,0,0,1,0];this._loadMatrix(t,e)}sepia(e){const t=[.393,.7689999,.18899999,0,0,.349,.6859999,.16799999,0,0,.272,.5339999,.13099999,0,0,0,0,0,1,0];this._loadMatrix(t,e)}technicolor(e){const t=[1.9125277891456083,-.8545344976951645,-.09155508482755585,0,11.793603434377337,-.3087833385928097,1.7658908555458428,-.10601743074722245,0,-70.35205161461398,-.231103377548616,-.7501899197440212,1.847597816108189,0,30.950940869491138,0,0,0,1,0];this._loadMatrix(t,e)}polaroid(e){const t=[1.438,-.062,-.062,0,0,-.122,1.378,-.122,0,0,-.016,-.016,1.483,0,0,0,0,0,1,0];this._loadMatrix(t,e)}toBGR(e){const t=[0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0];this._loadMatrix(t,e)}kodachrome(e){const t=[1.1285582396593525,-.3967382283601348,-.03992559172921793,0,63.72958762196502,-.16404339962244616,1.0835251566291304,-.05498805115633132,0,24.732407896706203,-.16786010706155763,-.5603416277695248,1.6014850761964943,0,35.62982807460946,0,0,0,1,0];this._loadMatrix(t,e)}browni(e){const t=[.5997023498159715,.34553243048391263,-.2708298674538042,0,47.43192855600873,-.037703249837783157,.8609577587992641,.15059552388459913,0,-36.96841498319127,.24113635128153335,-.07441037908422492,.44972182064877153,0,-7.562075277591283,0,0,0,1,0];this._loadMatrix(t,e)}vintage(e){const t=[.6279345635605994,.3202183420819367,-.03965408211312453,0,9.651285835294123,.02578397704808868,.6441188644374771,.03259127616149294,0,7.462829176470591,.0466055556782719,-.0851232987247891,.5241648018700465,0,5.159190588235296,0,0,0,1,0];this._loadMatrix(t,e)}colorTone(e,t,o,n,s){e||(e=.2),t||(t=.15),o||(o=16770432),n||(n=3375104);const i=Pe.shared,[c,a,l]=i.setValue(o).toArray(),[d,h,u]=i.setValue(n).toArray(),p=[.3,.59,.11,0,0,c,a,l,e,0,d,h,u,t,0,c-d,a-h,l-u,0,0];this._loadMatrix(p,s)}night(e,t){e||(e=.1);const o=[e*-2,-e,0,0,0,-e,0,e,0,0,0,e,e*2,0,0,0,0,0,1,0];this._loadMatrix(o,t)}predator(e,t){const o=[11.224130630493164*e,-4.794486999511719*e,-2.8746118545532227*e,0*e,.40342438220977783*e,-3.6330697536468506*e,9.193157196044922*e,-2.951810836791992*e,0*e,-1.316135048866272*e,-3.2184197902679443*e,-4.2375030517578125*e,7.476448059082031*e,0*e,.8044459223747253*e,0,0,0,1,0];this._loadMatrix(o,t)}lsd(e){const t=[2,-.4,.5,0,0,-.5,2,-.4,0,0,-.4,-.5,3,0,0,0,0,0,1,0];this._loadMatrix(t,e)}reset(){const e=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0];this._loadMatrix(e,!1)}get matrix(){return this.resources.colorMatrixUniforms.uniforms.uColorMatrix}set matrix(e){this.resources.colorMatrixUniforms.uniforms.uColorMatrix=e}get alpha(){return this.resources.colorMatrixUniforms.uniforms.uAlpha}set alpha(e){this.resources.colorMatrixUniforms.uniforms.uAlpha=e}}class X extends V{constructor(...e){let t=e[0];Array.isArray(e[0])&&(t={textures:e[0],autoUpdate:e[1]});const{animationSpeed:o=1,autoPlay:n=!1,autoUpdate:s=!0,loop:i=!0,onComplete:c=null,onFrameChange:a=null,onLoop:l=null,textures:d,updateAnchor:h=!1,...u}=t,[p]=d;super({...u,texture:p instanceof F?p:p.texture}),this._textures=null,this._durations=null,this._autoUpdate=s,this._isConnectedToTicker=!1,this.animationSpeed=o,this.loop=i,this.updateAnchor=h,this.onComplete=c,this.onFrameChange=a,this.onLoop=l,this._currentTime=0,this._playing=!1,this._previousFrame=null,this.textures=d,n&&this.play()}stop(){this._playing&&(this._playing=!1,this._autoUpdate&&this._isConnectedToTicker&&(ae.shared.remove(this.update,this),this._isConnectedToTicker=!1))}play(){this._playing||(this._playing=!0,this._autoUpdate&&!this._isConnectedToTicker&&(ae.shared.add(this.update,this,bs.HIGH),this._isConnectedToTicker=!0))}gotoAndStop(e){this.stop(),this.currentFrame=e}gotoAndPlay(e){this.currentFrame=e,this.play()}update(e){if(!this._playing)return;const t=e.deltaTime,o=this.animationSpeed*t,n=this.currentFrame;if(this._durations!==null){let s=this._currentTime%1*this._durations[this.currentFrame];for(s+=o/60*1e3;s<0;)this._currentTime--,s+=this._durations[this.currentFrame];const i=Math.sign(this.animationSpeed*t);for(this._currentTime=Math.floor(this._currentTime);s>=this._durations[this.currentFrame];)s-=this._durations[this.currentFrame]*i,this._currentTime+=i;this._currentTime+=s/this._durations[this.currentFrame]}else this._currentTime+=o;this._currentTime<0&&!this.loop?(this.gotoAndStop(0),this.onComplete&&this.onComplete()):this._currentTime>=this._textures.length&&!this.loop?(this.gotoAndStop(this._textures.length-1),this.onComplete&&this.onComplete()):n!==this.currentFrame&&(this.loop&&this.onLoop&&(this.animationSpeed>0&&this.currentFrame<n||this.animationSpeed<0&&this.currentFrame>n)&&this.onLoop(),this._updateTexture())}_updateTexture(){const e=this.currentFrame;this._previousFrame!==e&&(this._previousFrame=e,this.texture=this._textures[e],this.updateAnchor&&this.texture.defaultAnchor&&this.anchor.copyFrom(this.texture.defaultAnchor),this.onFrameChange&&this.onFrameChange(this.currentFrame))}destroy(e=!1){if(typeof e=="boolean"?e:e?.texture){const o=typeof e=="boolean"?e:e?.textureSource;this._textures.forEach(n=>{this.texture!==n&&n.destroy(o)})}this._textures=[],this._durations=null,this.stop(),super.destroy(e),this.onComplete=null,this.onFrameChange=null,this.onLoop=null}static fromFrames(e){const t=[];for(let o=0;o<e.length;++o)t.push(F.from(e[o]));return new X(t)}static fromImages(e){const t=[];for(let o=0;o<e.length;++o)t.push(F.from(e[o]));return new X(t)}get totalFrames(){return this._textures.length}get textures(){return this._textures}set textures(e){if(e[0]instanceof F)this._textures=e,this._durations=null;else{this._textures=[],this._durations=[];for(let t=0;t<e.length;t++)this._textures.push(e[t].texture),this._durations.push(e[t].time)}this._previousFrame=null,this.gotoAndStop(0),this._updateTexture()}get currentFrame(){let e=Math.floor(this._currentTime)%this._textures.length;return e<0&&(e+=this._textures.length),e}set currentFrame(e){if(e<0||e>this.totalFrames-1)throw new Error(`[AnimatedSprite]: Invalid frame index value ${e}, expected to be between 0 and totalFrames ${this.totalFrames}.`);const t=this.currentFrame;this._currentTime=e,t!==this.currentFrame&&this._updateTexture()}get playing(){return this._playing}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,!this._autoUpdate&&this._isConnectedToTicker?(ae.shared.remove(this.update,this),this._isConnectedToTicker=!1):this._autoUpdate&&!this._isConnectedToTicker&&this._playing&&(ae.shared.add(this.update,this),this._isConnectedToTicker=!0))}}class ua{constructor({matrix:e,observer:t}={}){this.dirty=!0,this._matrix=e??new Cs,this.observer=t,this.position=new ke(this,0,0),this.scale=new ke(this,1,1),this.pivot=new ke(this,0,0),this.skew=new ke(this,0,0),this._rotation=0,this._cx=1,this._sx=0,this._cy=0,this._sy=1}get matrix(){const e=this._matrix;return this.dirty&&(e.a=this._cx*this.scale.x,e.b=this._sx*this.scale.x,e.c=this._cy*this.scale.y,e.d=this._sy*this.scale.y,e.tx=this.position.x-(this.pivot.x*e.a+this.pivot.y*e.c),e.ty=this.position.y-(this.pivot.x*e.b+this.pivot.y*e.d),this.dirty=!1),e}_onUpdate(e){this.dirty=!0,e===this.skew&&this.updateSkew(),this.observer?._onUpdate(this)}updateSkew(){this._cx=Math.cos(this._rotation+this.skew.y),this._sx=Math.sin(this._rotation+this.skew.y),this._cy=-Math.sin(this._rotation-this.skew.x),this._sy=Math.cos(this._rotation-this.skew.x),this.dirty=!0}toString(){return`[pixi.js/math:Transform position=(${this.position.x}, ${this.position.y}) rotation=${this.rotation} scale=(${this.scale.x}, ${this.scale.y}) skew=(${this.skew.x}, ${this.skew.y}) ]`}setFromMatrix(e){e.decompose(this),this.dirty=!0}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._onUpdate(this.skew))}}const Fn=class mt extends sn{constructor(...e){let t=e[0]||{};t instanceof F&&(t={texture:t}),e.length>1&&(ue(he,"use new TilingSprite({ texture, width:100, height:100 }) instead"),t.width=e[1],t.height=e[2]),t={...mt.defaultOptions,...t};const{texture:o,anchor:n,tilePosition:s,tileScale:i,tileRotation:c,width:a,height:l,applyAnchorToTexture:d,roundPixels:h,...u}=t??{};super({label:"TilingSprite",...u}),this.renderPipeId="tilingSprite",this.batched=!0,this.allowChildren=!1,this._anchor=new ke({_onUpdate:()=>{this.onViewUpdate()}}),this.applyAnchorToTexture=d,this.texture=o,this._width=a??o.width,this._height=l??o.height,this._tileTransform=new ua({observer:{_onUpdate:()=>this.onViewUpdate()}}),n&&(this.anchor=n),this.tilePosition=s,this.tileScale=i,this.tileRotation=c,this.roundPixels=h??!1}static from(e,t={}){return typeof e=="string"?new mt({texture:Ss.get(e),...t}):new mt({texture:e,...t})}get uvRespectAnchor(){return ue(he,"uvRespectAnchor is deprecated, please use applyAnchorToTexture instead"),this.applyAnchorToTexture}set uvRespectAnchor(e){ue(he,"uvRespectAnchor is deprecated, please use applyAnchorToTexture instead"),this.applyAnchorToTexture=e}get clampMargin(){return this._texture.textureMatrix.clampMargin}set clampMargin(e){this._texture.textureMatrix.clampMargin=e}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}get tilePosition(){return this._tileTransform.position}set tilePosition(e){this._tileTransform.position.copyFrom(e)}get tileScale(){return this._tileTransform.scale}set tileScale(e){typeof e=="number"?this._tileTransform.scale.set(e):this._tileTransform.scale.copyFrom(e)}set tileRotation(e){this._tileTransform.rotation=e}get tileRotation(){return this._tileTransform.rotation}get tileTransform(){return this._tileTransform}set texture(e){e||(e=F.EMPTY);const t=this._texture;t!==e&&(t&&t.dynamic&&t.off("update",this.onViewUpdate,this),e.dynamic&&e.on("update",this.onViewUpdate,this),this._texture=e,this.onViewUpdate())}get texture(){return this._texture}set width(e){this._width=e,this.onViewUpdate()}get width(){return this._width}set height(e){this._height=e,this.onViewUpdate()}get height(){return this._height}setSize(e,t){typeof e=="object"&&(t=e.height??e.width,e=e.width),this._width=e,this._height=t??e,this.onViewUpdate()}getSize(e){return e||(e={}),e.width=this._width,e.height=this._height,e}updateBounds(){const e=this._bounds,t=this._anchor,o=this._width,n=this._height;e.minX=-t._x*o,e.maxX=e.minX+o,e.minY=-t._y*n,e.maxY=e.minY+n}containsPoint(e){const t=this._width,o=this._height,n=-t*this._anchor._x;let s=0;return e.x>=n&&e.x<=n+t&&(s=-o*this._anchor._y,e.y>=s&&e.y<=s+o)}destroy(e=!1){if(super.destroy(e),this._anchor=null,this._tileTransform=null,this._bounds=null,typeof e=="boolean"?e:e?.texture){const o=typeof e=="boolean"?e:e?.textureSource;this._texture.destroy(o)}this._texture=null}};Fn.defaultOptions={texture:F.EMPTY,anchor:{x:0,y:0},tilePosition:{x:0,y:0},tileScale:{x:1,y:1},tileRotation:0,applyAnchorToTexture:!1};let ha=Fn;class pa extends sn{constructor(e,t){const{text:o,resolution:n,style:s,anchor:i,width:c,height:a,roundPixels:l,...d}=e;super({...d}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=t,this.text=o??"",this.style=s,this.resolution=n??null,this.allowChildren=!1,this._anchor=new ke({_onUpdate:()=>{this.onViewUpdate()}}),i&&(this.anchor=i),this.roundPixels=l??!1,c!==void 0&&(this.width=c),a!==void 0&&(this.height=a)}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}set text(e){e=e.toString(),this._text!==e&&(this._text=e,this.onViewUpdate())}get text(){return this._text}set resolution(e){this._autoResolution=e===null,this._resolution=e,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(e){e||(e={}),this._style?.off("update",this.onViewUpdate,this),e instanceof this._styleClass?this._style=e:this._style=new this._styleClass(e),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(e){this._setWidth(e,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(e){this._setHeight(e,this.bounds.height)}getSize(e){return e||(e={}),e.width=Math.abs(this.scale.x)*this.bounds.width,e.height=Math.abs(this.scale.y)*this.bounds.height,e}setSize(e,t){typeof e=="object"?(t=e.height??e.width,e=e.width):t??(t=e),e!==void 0&&this._setWidth(e,this.bounds.width),t!==void 0&&this._setHeight(t,this.bounds.height)}containsPoint(e){const t=this.bounds.width,o=this.bounds.height,n=-t*this.anchor.x;let s=0;return e.x>=n&&e.x<=n+t&&(s=-o*this.anchor.y,e.y>=s&&e.y<=s+o)}onViewUpdate(){this.didViewUpdate||(this._didTextUpdate=!0),super.onViewUpdate()}destroy(e=!1){super.destroy(e),this.owner=null,this._bounds=null,this._anchor=null,(typeof e=="boolean"?e:e?.style)&&this._style.destroy(e),this._style=null,this._text=null}get styleKey(){return`${this._text}:${this._style.styleKey}:${this._resolution}`}}function fa(r,e){let t=r[0]??{};return(typeof t=="string"||r[1])&&(ue(he,`use new ${e}({ text: "hi!", style }) instead`),t={text:t,style:r[1]}),t}class ma extends pa{constructor(...e){const t=fa(e,"Text");super(t,Hi),this.renderPipeId="text",t.textureStyle&&(this.textureStyle=t.textureStyle instanceof Qt?t.textureStyle:new Qt(t.textureStyle))}updateBounds(){const e=this._bounds,t=this._anchor;let o=0,n=0;if(this._style.trim){const{frame:s,canvasAndContext:i}=ro.getCanvasAndContext({text:this.text,style:this._style,resolution:1});ro.returnCanvasAndContext(i),o=s.width,n=s.height}else{const s=Wi.measureText(this._text,this._style);o=s.width,n=s.height}e.minX=-t._x*o,e.maxX=e.minX+o,e.minY=-t._y*n,e.maxY=e.minY+n}}const Ln=class Dn extends v{constructor(e={}){e={...Dn.defaultOptions,...e},super(),this.renderLayerChildren=[],this.sortableChildren=e.sortableChildren,this.sortFunction=e.sortFunction}attach(...e){for(let t=0;t<e.length;t++){const o=e[t];if(o.parentRenderLayer){if(o.parentRenderLayer===this)continue;o.parentRenderLayer.detach(o)}this.renderLayerChildren.push(o),o.parentRenderLayer=this;const n=this.renderGroup||this.parentRenderGroup;n&&(n.structureDidChange=!0)}return e[0]}detach(...e){for(let t=0;t<e.length;t++){const o=e[t],n=this.renderLayerChildren.indexOf(o);n!==-1&&this.renderLayerChildren.splice(n,1),o.parentRenderLayer=null;const s=this.renderGroup||this.parentRenderGroup;s&&(s.structureDidChange=!0)}return e[0]}detachAll(){const e=this.renderLayerChildren;for(let t=0;t<e.length;t++)e[t].parentRenderLayer=null;this.renderLayerChildren.length=0}collectRenderables(e,t,o){const n=this.renderLayerChildren,s=n.length;this.sortableChildren&&this.sortRenderLayerChildren();for(let i=0;i<s;i++)n[i].parent||Is("Container must be added to both layer and scene graph. Layers only handle render order - the scene graph is required for transforms (addChild)",n[i]),n[i].collectRenderables(e,t,this)}sortRenderLayerChildren(){this.renderLayerChildren.sort(this.sortFunction)}_getGlobalBoundsRecursive(e,t,o){if(!e)return;const n=this.renderLayerChildren;for(let s=0;s<n.length;s++)n[s]._getGlobalBoundsRecursive(!0,t,this)}getFastGlobalBounds(e,t){return super.getFastGlobalBounds(e,t)}addChild(...e){throw new Error("RenderLayer.addChild() is not available. Please use RenderLayer.attach()")}removeChild(...e){throw new Error("RenderLayer.removeChild() is not available. Please use RenderLayer.detach()")}removeChildren(e,t){throw new Error("RenderLayer.removeChildren() is not available. Please use RenderLayer.detach()")}removeChildAt(e){throw new Error("RenderLayer.removeChildAt() is not available")}getChildAt(e){throw new Error("RenderLayer.getChildAt() is not available")}setChildIndex(e,t){throw new Error("RenderLayer.setChildIndex() is not available")}getChildIndex(e){throw new Error("RenderLayer.getChildIndex() is not available")}addChildAt(e,t){throw new Error("RenderLayer.addChildAt() is not available")}swapChildren(e,t){throw new Error("RenderLayer.swapChildren() is not available")}reparentChild(...e){throw new Error("RenderLayer.reparentChild() is not available with the render layer")}reparentChildAt(e,t){throw new Error("RenderLayer.reparentChildAt() is not available with the render layer")}};Ln.defaultOptions={sortableChildren:!1,sortFunction:(r,e)=>r.zIndex-e.zIndex};let uo=Ln;const ga=(r,e)=>{const t=an();P.useLayoutEffect(()=>{Nr(C.dispatch,C.getState,r,e)},[r,e]),P.useLayoutEffect(()=>{const o=()=>Nr(C.dispatch,C.getState,r,e);if(e){const n=new ResizeObserver(o);return n.observe(e),()=>n.disconnect()}else return window.addEventListener("resize",o),()=>window.removeEventListener("resize",o)},[t,e,r])},xa=()=>{const{cssUpscale:r,canvasSize:e,rotate90:t}=Ct(vr);return t?`scale(${r}) rotate(90deg) translate(0, -${e.y}px)`:`scale(${r})`},ya=(r,e=console.error)=>(...t)=>{try{return r(...t)}catch(o){e(o);return}},jn=r=>{for(const[,a]of r)for(const[l]of a)a.set(l,!1);const e=Array.from(wa(r));let t=e.length,o=t;const n=new Array(t),s={},i=va(e);for(;o--;)s[o]||c(e[o],o,new Set,null);return n;function c(a,l,d,h){if(d.has(a)){if(h!==null){const f=r.get(h);f?.has(a)&&f.set(a,!0)}return}if(s[l])return;s[l]=!0;const u=r.get(a),p=Array.from(u?.entries()??er);if(l=p.length){d.add(a);do{const[f,m]=p[--l];m||c(f,i.get(f),d,a)}while(l);d.delete(a)}n[--t]=a}};function wa(r){const e=new Set;for(const[t,o]of r.entries()){e.add(t);for(const n of o.keys())e.add(n)}return e}function va(r){const e=new Map;for(let t=0,o=r.length;t<o;t++)e.set(r[t],t);return e}const ba=(r,e,t,o)=>(r.has(e)||r.set(e,new Map),r.get(e).set(t,o),r),$e=(r,e,t)=>{const o=r.get(e);return o!==void 0&&(o.delete(t),o.size===0&&r.delete(e)),r},$t=1e-5,ho=-1,Fe=(r,e,t,o,n)=>o-n>r&&t<e-n,Ca=0,Vn=1,Un=2,Gn=3,Sa=(r,e)=>{const t=Fe(r.zAxisProjectionMin,r.zAxisProjectionMax,e.zAxisProjectionMin,e.zAxisProjectionMax,$t),o=Fe(r.xAxisProjectionMin,r.xAxisProjectionMax,e.xAxisProjectionMin,e.xAxisProjectionMax,$t),n=Fe(r.yAxisProjectionMin,r.yAxisProjectionMax,e.yAxisProjectionMin,e.yAxisProjectionMax,$t);return o&&n&&t?Vn:n&&t&&Fe(r.xAxisProjectionMin,r.xAxisProjectionMax,e.xAxisProjectionMin,e.xAxisProjectionMax,ho)?Un:o&&t&&Fe(r.yAxisProjectionMin,r.yAxisProjectionMax,e.yAxisProjectionMin,e.yAxisProjectionMax,ho)?Gn:Ca},Ia=(r,e,t,o)=>{for(const n of ks){const s=r[n],i=s+e[n],c=t[n],a=c+o[n];if(i<=c)return 1*(n==="z"?-1:1);if(s>=a)return-1*(n==="z"?-1:1)}return po(t)-po(r)},ka=(r,e,t)=>{if(r.fixedZIndex!==void 0||e.fixedZIndex!==void 0)return 0;const o=r.renderAabbOffset?q(r.state.position,r.renderAabbOffset):r.state.position,n=r.renderAabb||r.aabb,s=e.renderAabbOffset?q(e.state.position,e.renderAabbOffset):e.state.position,i=e.renderAabb||e.aabb;switch(Sa(t.getItemAxesProjections(r),t.getItemAxesProjections(e))){case Vn:return Ia(o,n,s,i);case Un:return K(o.y,s.y+i.y)&&K(o.z,s.z+i.z)?1:K(s.y,o.y+n.y)&&K(s.z,o.z+n.z)?-1:0;case Gn:return K(o.x,s.x+i.x)&&K(o.z,s.z+i.z)?1:K(s.x,o.x+n.x)&&K(s.z,o.z+n.z)?-1:0;default:return 0}},po=r=>r.x+r.y-r.z,Hn=(r,e=new Js(sr(r)),t=new Set(sr(r)),o=new Map)=>{const n=new Map;for(const[s,i]of o)if(!r[s])o.delete(s);else for(const[c]of i)r[c]||$e(o,s,c);for(const s of t)e.updateItemProjectedIndex(s);for(const s of t){if(s.fixedZIndex!==void 0)continue;const i=e.getItemProjectedNeighbourhood(s);{const c=o.get(s.id);c?.forEach((a,l)=>{i.has(r[l])||c.delete(l)}),o.forEach((a,l)=>{i.has(r[l])||$e(o,l,s.id)})}for(const c of i){if(c.fixedZIndex!==void 0||n.get(c)?.has(s))continue;const a=ka(s,c,e);if(n.has(s)||n.set(s,new Set),n.get(s).add(c),a===0){$e(o,s.id,c.id),$e(o,c.id,s.id);continue}const l=a>0?s.id:c.id,d=a>0?c.id:s.id;ba(o,d,l,!1),$e(o,l,d)}}return o},fo=r=>r.fixedZIndex!==void 0,Ta=r=>{const t=r.some(([,i])=>i==="intersects-rendered")?r.filter(([,i])=>i==="intersects-rendered").map(([i])=>i):r.map(([i])=>i);if(t.every(fo))return t.toSorted((i,c)=>c.fixedZIndex-i.fixedZIndex).at(0);const o=t.filter(i=>!fo(i));if(o.length===0)return;if(o.length===1)return o[0];const n=Object.fromEntries(o.map(i=>[i.id,i])),s=jn(Hn(n));return n[s.at(-1)]},Ma=3,Pa=(r,{x:e,y:t},o)=>Ts.find(n=>{const s=Ks(r.state.position,r.aabb,n);return br(re(s,{x:e,y:t}))<Ma}),be=3,Ft=1.5;function N({x:r,y:e},t,o){const n={x:r-t.x,y:e-t.y},s=n.x*o.y-n.y*o.x;return Math.abs(s)/Ms(Math.hypot(o.x,o.y))}const Wn={point:{x:-1,y:-1,z:0},normal:{x:0,y:0,z:1}},Xn={point:{x:-1,y:0,z:1},normal:{x:0,y:1,z:0}},Nn={point:{x:0,y:-1,z:1},normal:{x:1,y:0,z:0}},qn={point:{x:0,y:1,z:1},normal:{x:1,y:0,z:0}},Zn={point:{x:1,y:0,z:1},normal:{x:0,y:1,z:0}},Yn={point:{x:1,y:-1,z:0},normal:{x:0,y:0,z:1}},Jn={point:{x:0,y:-1,z:-1},normal:{x:1,y:0,z:0}},Kn={point:{x:-1,y:1,z:0},normal:{x:0,y:0,z:1}},Qn={point:{x:-1,y:0,z:-1},normal:{x:0,y:1,z:0}},Ra=(r,e,t,o)=>{const{position:n}=r.state,{aabb:s}=r,i=t.x<0,c=t.y<0,a=t.z>0;if((i||c)&&N(e,Pr(n),{x:0,y:-1})<Ft)return Wn;if((i||a)&&N(e,Rr(n,s),{x:2,y:-1})<Ft)return Xn;if((c||a)&&N(e,Ar(n,s),{x:2,y:1})<Ft)return Nn;switch(!0){case a:{const l=ti(n,s);if(N(e,l,{x:2,y:1})<be)return qn;if(N(e,l,{x:-2,y:1})<be)return Zn;break}case c:{const l=ei(n,s);if(N(e,l,{x:0,y:-1})<be)return Yn;if(N(e,l,{x:2,y:1})<be)return Jn;break}case i:{const l=Qs(n,s);if(N(e,l,{x:0,y:-1})<be)return Kn;if(N(e,l,{x:-2,y:1})<be)return Qn;break}}},Aa={z:1,x:0,y:0},_a={z:0,x:0,y:-1},mo={z:0,x:-1,y:0},Oa=(r,{x:e,y:t},o)=>{if(o.type==="item"&&o.item.type==="door"&&r.type==="wall"){const d=r.config.direction;return Ps(ri[d],-1)}const{position:n}=r.state,{aabb:s}=r,i=Pr(n),c=Ar(n,s),a=Rr(n,s);return t<c.y-(c.x-e)/2?t<a.y-(e-a.x)/2?Aa:mo:e<i.x?_a:mo},go=(r,e,t)=>t?{position:r.state.position,aabb:r.aabb}:{position:q(r.state.position,r.renderAabbOffset??Ae),aabb:r.renderAabb??r.aabb},xo=({x:r,y:e},t,o)=>{const n=Pr(t),s=Ar(t,o),i=Rr(t,o);return!(r<s.x||r>i.x||e<i.y-(i.x-r)/2||e<s.y-(r-s.x)/2||e>n.y-(r-n.x)/2||e>n.y-(n.x-r)/2)},za=(r,e,t)=>{const{position:o,aabb:n}=go(t,e,!1);if(xo(r,o,n))return"intersects-rendered";if(e.type==="item"&&t.type==="wall"){const{position:i,aabb:c}=go(t,e,!0);if(xo(r,i,c))return"intersects-unrendered"}return"non-intersecting"},es=(r,e,t,o)=>{const n=t.type==="item"&&t.item.type==="door"?1:o,s=R.x*n,i=R.z,c=n===1?0:R.x/2,a=i/2,l=si(e);return{x:l==="yz"?Math.round(r.x/s)*s:Math.floor((r.x-c)/s)*s,y:l==="xz"?Math.round(r.y/s)*s:Math.floor((r.y-c)/s)*s,z:l==="xy"?Math.round(r.z/i)*i:Math.floor((r.z+a)/i)*i}},Ba=({state:{position:r},aabb:e},t,o,n,s)=>{const i={x:r.x+(t.x<0?0:e.x),y:r.y+(t.y<0?0:e.y),z:r.z+(t.z<0?0:e.z)},c=ni(i,t,o);return es(c,t,n,s)},Ea=r=>e=>{const t=oi(e);return r.type==="item"&&r.item.type==="door"?t&&e.type==="wall":t},Lt=(r,e,t,o)=>{const n=ee(e.items).filter(Ea(t)).map(a=>[a,za(r,t,a)]).filter(a=>a[1]!=="non-intersecting"),s=Array.from(n),i=Ta(s),c=e.id;if(i){const a=Oa(i,r,t);if(!(a.z>0&&!Object.isExtensible(i.state.stoodOnBy)))return{roomId:c,scrXy:r,world:{itemId:i.id,onItem:{face:a,corner:Pa(i,r),edge:Ra(i,r,a)},position:Ba(i,a,r,t,o)}}}return{roomId:c,scrXy:r,world:void 0}},_e=40,gt=(r,e,t)=>{const o=r.cssUpscale*r.gameEngineUpscale;if(t.target===null)throw new Error("Mouse event target is null");const n=t.target.getBoundingClientRect(),s=t.clientX-n.left,i=t.clientY-n.top;return{x:s/o+e.l-_e,y:i/o+e.t-_e}},$a=(r,e)=>{const t=r.cssUpscale*r.gameEngineUpscale;if(e.target===null)throw new Error("Mouse event target is null");const o=e.movementX,n=e.movementY;return{x:o/t,y:n/t}},Fa=r=>{r.ticker.remove(r.render,r)},ts=P.createContext(null),La=({children:r})=>{const[e,t]=P.useState(null);return P.useEffect(()=>{const o=new Bn;return o.init({background:g.pureBlack,sharedTicker:!0,useBackBuffer:!0}).then(()=>{Fa(o),t(o)}),()=>{}},[]),e===null?null:D.jsx(ts,{value:e,children:r})},se=()=>P.useContext(ts),yt=(r,...e)=>r.levelEditor.wallsFloorsLocked&&e.some(t=>t.type==="wall"||t.type==="floor"),cr=(r,e)=>{const t=C.getState();let o;if(e.world){const n=e.world.itemId,s=n&&r.items[n],i=yt(t,s)?void 0:s.jsonItemId;o=i===void 0?void 0:{jsonItemId:i,pointingAtOnItem:e.world.onItem}}else o=void 0;H(pn(t),o)||C.dispatch(fn(o))},wt=({levelEditor:r},e,t)=>{const o=e.items[t]?.jsonItemId;if(o===void 0)return;const n=mn(r,o);if(n!==void 0)return[o,n]},{dispatch:Da}=C;class ja{handleMouseMove({roomState:e,pointingAt:t}){cr(e,t)}handleMouseUp({roomState:e,pointingAt:t,storeState:o,isClick:n}){if(!n)return;const s=t.world?.itemId;if(s===void 0){console.warn("no itemId");return}const i=e.items[s];if(yt(o,i))return;const c=wt(o,e,s);if(c===void 0)return;const[,a]=c;Da(_r({type:"item",item:{type:a.type,config:a.config}}))}handleMouseDown(e){}handleMouseLeave(e){}}const yo=(r,e,t)=>{const{world:{onItem:{face:o},position:n,itemId:s}}=r;if(o.z>Rs)return pt(n);if(t.type==="door"){const i=e.items[s];if(i.type!=="wall")return;const{config:c,aabb:a,state:{position:l}}=i,d=ii(gn(c)),h=Ne(oe(c.direction)),u=oe(c.direction);if(d[h]<2)return;const p=l[h],f=l[h]+a[h]-ai,m=l.z,x=l.z+a.z-ci,w={[h]:Math.max(Math.min(n[h],f),p),[u]:n[u],z:Math.max(Math.min(n.z,x),m)};return pt(w)}return q(pt(n),o)},{dispatch:Le}=C;class Va{handleMouseMove({pointingAtChanged:e,roomState:t,pointingAt:o,tool:n,storeState:s}){if(!e||(Le(or()),o.world===void 0))return;const i=wt(s,t,o.world.itemId);if(i===void 0)return;const[,c]=i,a=yo(o,t,n.item);if(a===void 0)return;const{item:l}=n,d=l.type==="door"?As(l,u=>{const p=t.items[o.world.itemId];u.config.direction=p.config.direction}):n.item;Fi({roomState:t,blockPosition:a,itemTool:d})||Le(Jr({blockPosition:a,pointedAtItemJson:c,preview:!0}))}handleMouseUp({roomState:e,pointingAt:t,tool:o,storeState:n,isClick:s}){if(!s)return;if(t.world===void 0){Le(_r({type:"pointer"}));return}const i=wt(n,e,t.world.itemId);if(i===void 0)return;const[,c]=i,a=yo(t,e,o.item);a!==void 0&&Le(Jr({blockPosition:a,pointedAtItemJson:c,preview:!1}))}handleMouseDown(e){}handleMouseLeave(e){Le(or())}}const Ua=r=>yn(e=>e>0?e:e>-1?1:-e+1,r),Ga=({jsonItem:r,blockDragAccVec:e,resizeEdgeDirection:t})=>{const o=r.position,n=li(r),s=ut(e,t,xn(r)),i=q(n,s),c=Ua(i),a=yn((l,d,h,u,p)=>{const f=d<1;return l<0!==f?f?h-p+1:h+u-p:f?h+u-1:h},t,i,o,n,c);return{timesDelta:tr(c,n),positionDelta:tr(a,o)}},Ha=5,{dispatch:De}=C,Wa=(r,e,t)=>{const o=t?.world?.itemId;if(o===void 0)return fe;const n=e.items[o].jsonItemId;if(n===void 0)return fe;const{selectedJsonItemIds:s}=r.levelEditor;return s.includes(n)?s:[n]},Xa=(r,e,t)=>{const o=r.world?.onItem.edge,n=ut(...Y(t).map(a=>xn(a))),s=ut(o?.point??Ae,n);if(Sr(s)>0)return o.normal;const i=ut(...Y(t).map(a=>Di(a))),c=gi(i);switch(c){case"xyz":return e?qr:rr;case"x":case"y":case"xy":return rr;case"z":case"xz":return _s;case"yz":return qr;case"":return;default:throw new Error(`unexpected movable vector description ${c}`)}},Na=(r,e,t,o,n,s)=>{if(r===void 0)return;const i=re(e,r.scrXy),c=br(i);if(!(n||c>Ha))return;const l=Xa(r,o,s);if(l===void 0)return;const d=mi(l,t);return o?{x:0,y:0,z:d.z}:d},wo=(r,e=!1)=>{const t=C.getState().levelEditor;return es(r,rr,t.tool,e?1:t.gridResolution)};class qa{handleMouseMove({roomState:e,pointingAt:t,storeState:o,mouseDownPointingAtRef:n,mouseEvent:s,upscale:i,dragAccVec:c,roomRenderSize:a}){const l=$a(i,s),d=Wa(o,e,n.current);if(d.length===0){cr(e,t);return}const h=d.map(I=>di(o,I));if(yt(o,...h))return;const p=t.roomId===n.current?.roomId?Na(n.current,gt(i,a,s),l,s.metaKey||s.shiftKey,c.current!==void 0,h):void 0;if(!p){cr(e,t);return}d.length===1&&!ui(o,d[0])&&C.dispatch(_t({jsonItemIds:d}));const f=n.current?.world?.onItem.edge,m=f&&h.every(I=>wn(I)),x=c.current??Ae,w=q(x,p),S=wo(w,m);if(c.current=w,Cr(wo(x,m),S))return;const b=pt(S);let k,E;if(m){const[,I]=wt(o,e,n.current.world.itemId);({timesDelta:E,positionDelta:k}=Ga({jsonItem:I,blockDragAccVec:b,resizeEdgeDirection:f.point}))}else k=b;Li({roomState:e,jsonItemIds:d,blockPositionDelta:k,timesDelta:E})||De(hi({jsonItemIds:d,positionDelta:k,timesDelta:E}))}handleMouseUp({roomState:e,pointingAt:t,storeState:o,mouseEvent:n,isClick:s,isDragEnd:i}){if(s){const c=t.world===void 0?void 0:e.items[t.world.itemId];if(c?.jsonItemId===void 0||yt(o,c)){De(_t({jsonItemIds:[]}));return}De(n.ctrlKey||n.metaKey?pi({jsonItemId:c.jsonItemId}):_t({jsonItemIds:[c.jsonItemId]}))}else i&&De(fi())}handleMouseDown(e){}handleMouseLeave(e){De(fn(void 0))}}const lt={item:new Va,pointer:new qa,eyeDropper:new ja},Za=r=>{const e=se(),t=Ct(vr),o=an(),n=P.useRef(void 0),s=P.useRef(void 0),i=P.useRef(void 0);P.useEffect(()=>{if(r===null)return;const c=u=>{const p=C.getState(),f=nt(p),m=Ot(p),x=gt(t,m,u),w=je(p),S=Lt(x,f,w,p.levelEditor.gridResolution),b=!H(S.world,n.current?.world);lt[w.type].handleMouseMove({pointingAtChanged:b,roomState:f,pointingAt:S,tool:w,storeState:p,mouseDownPointingAtRef:s,mouseEvent:u,upscale:t,dragAccVec:i,roomRenderSize:m}),n.current=S},a=u=>{const p=C.getState(),f=nt(p);if(f.id!==p.levelEditor.currentlyEditingRoomId)return;const m=Ot(p),x=gt(t,m,u),w=je(C.getState()),S=Lt(x,f,w,p.levelEditor.gridResolution),b=i.current!==void 0,k=!b&&S.roomId===s.current?.roomId&&S.world?.itemId===s.current?.world?.itemId,E=s.current;if(i.current=void 0,s.current=void 0,C.dispatch(xi(!1)),!k&&!b){console.log("mouseUp - not a click or drag end - skipping");return}lt[w.type].handleMouseUp({roomState:f,pointingAt:S,tool:w,storeState:p,mouseDownPointingAt:E,mouseEvent:u,upscale:t,isClick:k,isDragEnd:b})},l=u=>{const p=C.getState(),f=nt(p),m=je(p);i.current=void 0,s.current=void 0,lt[m.type].handleMouseLeave({roomState:f,tool:m,storeState:p,mouseEvent:u})},d=u=>{const p=C.getState(),f=nt(p),m=Ot(p),x=gt(t,m,u),w=je(p),S=Lt(x,f,w,p.levelEditor.gridResolution);console.log("setting mouseDownPointingAtRef to",S),s.current=S,lt[w.type].handleMouseDown({roomState:f,pointingAt:S,tool:w,storeState:p,mouseEvent:u,upscale:t})},h=ya(c);return r.addEventListener("mousemove",h),r.addEventListener("mouseup",a),r.addEventListener("mousedown",d),r.addEventListener("mouseleave",l),()=>{r.removeEventListener("mousemove",h),r.removeEventListener("mouseup",a),r.removeEventListener("mousedown",d),r.removeEventListener("mouseleave",l)}},[e.stage,t,r,o])},Ya={amigaHiResPal:"Amiga Hi-Res PAL",classicMac:"Classic Mac",amigaLowResPal:"Amiga Low-Res PAL",zxSpectrum:"ZX Spectrum",handheld:"Handheld"},Ja=({selectedResolution:r,onResolutionChange:e})=>{const t=rt.indexOf(r),o=t<rt.length-1,n=t>0,{justDone:s,doneNow:i}=ji();return D.jsxs("div",{className:"absolute scale-editor top-0 right-1 z-slightlyAbove flex gap-0 leading-none text-white",children:[s>0&&D.jsx(zt,{className:"px-1 bg-moss items-center flex",children:Ya[r]}),D.jsx(to,{small:!0,disabled:!n,tooltipContent:`##zoom 

makes things look *smaller* by *increasing* emulated resolution`,onClick:()=>{n&&(e(rt[t-1]),i())},shortcutKeys:["-"],children:D.jsx(zt,{children:"-"})}),D.jsx(to,{small:!0,disabled:!o,tooltipContent:`##zoom 

makes things look *bigger* by *decreasing* emulated resolution`,onClick:()=>{o&&(e(rt[t+1]),i())},shortcutKeys:["+","="],children:D.jsx(zt,{children:"+"})})]})},Ka=r=>{const e=se();P.useEffect(()=>{if(r)return r.appendChild(e.canvas),()=>{r.removeChild(e.canvas)}},[r,e])},Qa=r=>{const e=se(),[t]=P.useState(()=>new v({label:"editorPositioner"})),o=vn();P.useEffect(()=>{if(r.destroyed){console.log("useAddRoomRendererOutputToApplicationStage: room renderer was destroyed, will not add its output to app");return}return t.addChild(r.output.graphics),e.stage.addChild(t),()=>{e.stage.removeChild(t),t.removeChild(r.output.graphics)}},[r,e,t]),P.useEffect(()=>{t.x=-o.l+_e,t.y=-o.t+_e},[t,o])},ec=(r,e)=>{const t=P.useCallback(()=>{if(r===null)return;const o=Math.max(0,(r.scrollWidth-r.clientWidth)/2),n=Math.max(0,(r.scrollHeight-r.clientHeight)/2);r.scrollTo(o,n)},[r]);P.useEffect(()=>{if(r!==null)return cn({actionCreator:nr,effect(){setTimeout(t,0)}})},[t,r]),P.useEffect(()=>{if(r===null||e===null)return;if(e.querySelector("canvas"))setTimeout(t,0);else{const n=new MutationObserver(()=>{e.querySelector("canvas")&&(t(),n.disconnect())});return n.observe(e,{childList:!0,subtree:!0}),()=>n.disconnect()}},[r,e,t])},tc=()=>{const r=se(),e=Ct(t=>t.upscale.upscale.gameEngineUpscale);r.stage.scale=e},rc=()=>{P.useEffect(()=>cn({actionCreator:_r,effect(r,{dispatch:e}){e(or())}}))},oc=()=>{const r=se(),e=vn(),t=Ct(o=>o.upscale.upscale);P.useEffect(()=>{const o=(2*_e+e.w)*t.gameEngineUpscale,n=(2*_e+e.h)*t.gameEngineUpscale;r.renderer?.resize(o,n)},[r.renderer,e,t])},nc=({levelEditor:r})=>{const{dragInProgress:e,clickableAnnotationHovered:t,hoveredItem:o,selectedJsonItemIds:n}=r;if(e)return L("cursor-grabbing");if(t)return L("cursor-pointer");if(o){const s=mn(r,o.jsonItemId);if(s!==void 0&&wn(s))if(o.pointingAtOnItem.corner){if(Cr(o.pointingAtOnItem.corner,{x:1,y:1,z:1}))return L("cursor-n-resize")}else{const{edge:i}=o.pointingAtOnItem;if(i){if(H(i,Kn))return L("cursor-e-resize");if(H(i,Wn))return L("cursor-s-resize");if(H(i,Yn))return L("cursor-w-resize");if(H(i,Xn)||H(i,qn))return L("cursor-ne-resize");if(H(i,Nn)||H(i,Zn))return L("cursor-nw-resize");if(H(i,Qn))return L("cursor-se-resize");if(H(i,Jn))return L("cursor-sw-resize")}}return n.includes(o.jsonItemId)?L("cursor-grab"):L("cursor-default")}return L("cursor-crosshair")},sc=()=>yi(nc),T=new window.AudioContext,lr=()=>{throw new Error(`sounds not loaded - only call this from inside code 
      (like in a render loop) that is protected and only executed once 
      loading has happened`)},B=r=>{const e=typeof r=="string"?{soundId:r}:r,{playbackRate:t=1,soundId:o,connectTo:n,loop:s=!1,varyPlaybackRate:i=!1,randomiseStartPoint:c=!1}=e,a=T.createBufferSource(),l=lr()[o];return a.buffer=l,a.loop=s,a.playbackRate.value=i?t-.05+Math.random()*.1:t,s&&c?a.start(0,l.duration*Math.random()):a.start(),n!==void 0&&a.connect(n),a},Ce=(r,e,t)=>{const o=T.createGain();return e!==void 0&&(o.gain.value=e),r.connect(o),o.connect(t),o},$=({start:r,change:e,loop:t,stop:o,startAndLoopTogether:n=!1,noStartOnFirstFrame:s=!0},i)=>{let c=!0,a,l;return d=>{if(!!d!=!!l)d?r!==void 0&&!(c&&s)?(a&&(a.onended=null,a.stop()),a=B({...r}),Ce(a,r.gain,i),t!==void 0&&(n?(a=B({...t,loop:!0}),Ce(a,t.gain,i)):a.onended=()=>{l&&(a&&(a.onended=null,a.stop()),a=B({...t,loop:!0}),Ce(a,t.gain,i))})):t!==void 0&&(a=B({...t,loop:!0}),Ce(a,t.gain,i)):(a&&a.loop&&(a.onended=null,a.stop()),o!==void 0&&(a=B({...o}),Ce(a,o.gain,i)));else if(l!==d&&e!==void 0){const u=B({...e});Ce(u,e.gain,i)}c=!1,l=d}};class ic{constructor(e){this.renderContext=e,this.output.gain.value=4}output=T.createGain();#e=$({loop:{soundId:"rollingBallLoop",playbackRate:.5}},this.output);tick(){const{renderContext:{item:{state:{vels:{sliding:e},standingOnItemId:t}}}}=this,o=(e.x!==0||e.y!==0)&&t!==null;this.#e(o)}destroy(){}}class ac{constructor(e){this.renderContext=e;const{item:{config:{was:t}}}=e;switch(t.type){case"pickup":{t.gives!=="scroll"&&B({soundId:"bonus",connectTo:this.output});break}case"disappearing":{B({soundId:"destroy",connectTo:this.output});break}case"hushPuppy":{this.output.gain.value=.5,B({soundId:"hushPuppyVanish",connectTo:this.output});break}}}output=T.createGain();tick(){}destroy(){}}class cc{constructor(e){this.renderContext=e,this.#e.connect(this.output)}output=T.createGain();#e=T.createGain();#r=void 0;tick(){const{renderContext:{item:{state:{pressed:e}}}}=this,t=this.#r?.pressed;t!==void 0&&t!==e&&B({soundId:"switchClick",playbackRate:e?.95:1.05,connectTo:this.#e}),this.#r={pressed:e}}destroy(){}}class Fr{constructor(e,t,o=1){this.renderContext=e,this.#e=$({start:t},this.output),this.output.gain.value=o}output=T.createGain();#e;tick({lastRenderRoomTime:e}){const{renderContext:{item:t}}=this,{state:{collidedWith:{roomTime:o,by:n}}}=t,s=o>(e??Or)&&!Vi(St(n));this.#e(s)}destroy(){}}class lc{constructor(e){this.renderContext=e,this.#e.connect(this.output),this.#e.gain.value=.5,this.#t=new Fr(e,{soundId:"metalHit"},.3),this.#t.output.connect(this.output)}output=T.createGain();#e=T.createGain();#r=$({start:{soundId:"servoStart",playbackRate:.5},loop:{soundId:"servoLoop",playbackRate:.5},stop:{soundId:"servoStop",playbackRate:.5}},this.#e);#t;tick(e){const{renderContext:{item:t,room:{roomTime:o,items:n}}}=this,{state:{actedOnAt:{roomTime:s,by:i}}}=t,c=o===s&&Y(St(i)).some(a=>bn(n[a]));this.#r(c),this.#t.tick(e)}destroy(){}}const Ze=r=>{for(const e in r)return!0;return!1},Dt=2;class dc{constructor(e){this.renderContext=e}output=T.createGain();#e=$({start:{soundId:"conveyorStart",playbackRate:Dt},loop:{soundId:"conveyorLoop",playbackRate:Dt},stop:{soundId:"conveyorEnd",playbackRate:Dt}},this.output);tick(){const{renderContext:{item:{state:{stoodOnBy:e}}}}=this,t=Ze(e);this.#e(t)}destroy(){this.#e(!1)}}class uc{constructor(e){this.renderContext=e,B({soundId:"hooter",connectTo:this.output})}output=T.createGain();tick(){}destroy(){}}const hc=3;class pc{constructor(e){this.renderContext=e,this.output.gain.value=.7}output=T.createGain();#e=B({soundId:"helicopter",loop:!0,connectTo:this.output});tick(){const{renderContext:{item:{state:{vels:{lift:{z:e}}}}}}=this;this.#e.playbackRate.value=Math.max(.5,1+hc*e)}destroy(){}}const vo={skiHead:{soundId:"softBump"},turtle:{soundId:"softBump"},dalek:{soundId:"metalHit",gain:.1},homingBot:{soundId:"metalHit",gain:.2},computerBot:{soundId:"metalHit",gain:.2}},bo={cyberman:{soundId:"jetpackTurnaround",gain:1.2},dalek:{soundId:"mojoTurn",gain:.3}},Co={cyberman:{soundId:"jetpackLoop",gain:.7},emperorsGuardian:{soundId:"jetpackLoop"},dalek:{soundId:"mojoLoop",gain:.2},bubbleRobot:{soundId:"bubbleRobotLoop"},helicopterBug:{soundId:"helicopter"}},So={homingBot:{start:{soundId:"detect"},loop:{soundId:"robotWhirLoop",gain:4},startAndLoopTogether:!0},computerBot:{loop:{soundId:"robotBeepingLoop",randomiseStartPoint:!0,varyPlaybackRate:!0}}};class fc{constructor(e){this.renderContext=e,this.#e.connect(this.output),this.#r.connect(this.output),this.#r.gain.value=.66;const{item:{config:{which:t}}}=e;vo[t]!==void 0&&(this.#n=new Fr(e,vo[t]),this.#n.output.connect(this.output)),bo[t]!==void 0&&(this.#t=$({change:bo[t]},this.#e)),So[t]!==void 0&&(this.#s=$(So[t],this.#e)),Co[t]!==void 0&&(this.#o=$({loop:Co[t]},this.#r))}output=T.createGain();#e=T.createGain();#r=T.createGain();#t;#o;#n;#s;tick(e){const{renderContext:{item:t}}=this,{state:{facing:o,activated:n,busyLickingDoughnutsOffFace:s,vels:{walking:i}}}=t;if(this.#t){const c=Ir(o);this.#t(c)}if(this.#n&&this.#n.tick(e),this.#o){const c=n&&!s;this.#o(c)}if(this.#s){const c=!Cr(i,Ae);this.#s(c)}}destroy(){}}const mc=r=>{if(wi(r))return r.state;if(vi(r))return r.state.heels},gc=.8,xc=1.2,yc=.8;class jt{constructor(e){this.renderContext=e;const{general:{soundSettings:t},item:{type:o}}=e,{noFootsteps:n}={...kr.soundSettings,...t};n||(this.#e=T.createGain(),this.#e.gain.value=gc,this.#e.connect(this.output),this.#r=$({loop:{soundId:`${o==="headOverHeels"?"heels":o}Walk`}},this.#e)),this.#t.gain.value=yc,this.#t.connect(this.output),this.#a.gain.value=xc,this.#a.connect(this.output),this.#s.connect(this.output),this.#o=$({start:{soundId:`${o==="headOverHeels"?"head":o}Jump`}},this.#t),this.#n=$({loop:{soundId:`${o==="headOverHeels"?"head":o}Fall`}},this.#t)}output=T.createGain();#e;#r;#t=T.createGain();#o;#n;#s=T.createGain();#i=$({start:{soundId:"landing"},noStartOnFirstFrame:!0},this.#s);#a=T.createGain();#l=$({start:{soundId:"carry",playbackRate:.95},stop:{soundId:"carry",playbackRate:1.05}},this.#a);#c={teleportingPhase:null,positionZ:0};tick({lastRenderRoomTime:e}){const{renderContext:{item:t}}=this,{state:{action:o,teleporting:n,jumpStartZ:s,jumped:i,standingOnItemId:c,position:{z:a},vels:{gravity:{z:l}},collidedWith:{roomTime:d,by:h}}}=t,u=mc(t),{teleportingPhase:p,positionZ:f}=this.#c,m=n?n.phase:null,x=i&&a>s&&a>f&&l>0,w=a<f&&l<0&&c===null;this.#n(w),this.#o(x),this.#r!==void 0&&this.#r(!x&&!w&&o==="moving"),u!==void 0&&this.#l(u.carrying!==null);const S=c!==null&&d>(e??Or)&&h[c];if(this.#i(S),m!==null&&m!==p)if(m==="in"){const b=lr().teleportIn,k=T.createBufferSource();k.buffer=b,k.connect(this.output),k.start()}else{const b=lr().teleportOut,k=T.createBufferSource();k.buffer=b,k.connect(this.output),k.start()}this.#c={teleportingPhase:m,positionZ:a}}destroy(){}}class wc{constructor(e){this.renderContext=e}output=T.createGain();#e=void 0;tick(){const{renderContext:{item:{state:{stoodOnBy:e},config:{style:t}}}}=this;if(t!=="drum")return;const o=this.#e?.stoodOn??!1,n=Ze(e);!o&&n&&B({soundId:"drum",connectTo:this.output}),this.#e={stoodOn:n}}destroy(){}}class vc{constructor(e){this.renderContext=e,this.scrapeBracketed=$({loop:{soundId:"stepStoolScraping"}},this.output),this.output.gain.value=.4}output=T.createGain();scrapeBracketed;tick({movedItems:e}){const{renderContext:{item:t,room:{roomTime:o}}}=this,{state:{actedOnAt:{roomTime:n},standingOnItemId:s}}=t,i=o===n&&s!==null&&e.has(t);this.scrapeBracketed(i)}destroy(){}}class bc extends Fr{constructor(e){super(e,{soundId:"glassClink",varyPlaybackRate:!0},.8),this.renderContext=e}}class Cc{constructor(e){this.renderContext=e}output=T.createGain();tick({lastRenderRoomTime:e}){const{renderContext:{item:{state:{stoodOnBy:t,stoodOnUntilRoomTime:o}}}}=this,n=Ze(t);e!==void 0&&o>e&&!n&&B({soundId:"springBoing",connectTo:this.output})}destroy(){}}class Sc{constructor(e){this.renderContext=e,this.#e.connect(this.output)}output=T.createGain();#e=T.createGain();#r=void 0;tick(){const{renderContext:{item:{state:{setting:e},config:t}}}=this,o=t.type==="in-store"?ln(C.getState().gameMenus,t.path)?"right":"left":e,n=this.#r?.setting;n!==void 0&&n!==o&&B({soundId:"switchClick",playbackRate:o==="right"?.95:1.05,connectTo:this.#e}),this.#r={setting:o}}destroy(){}}const Ye=(r,e)=>Y(St(r)).map(t=>{const o=e.items[t];if(o===void 0)throw new Error(`item ${t} in stoodOnBy is not in the room`);return o}),rs=r=>{let e=2166136261;const t=r.length;for(let o=Math.max(0,t-9);o<t;o++)e^=r.charCodeAt(o),e=Math.imul(e,1540483477),e^=e>>>15;return(e>>>0)/4294967295},Ic=1e3/25,os=r=>{const e=qe.animations[r],t=e.length,{animationSpeed:o}=e;return t*Ic/o};os("bubbles.white");os("head.fadeOut");const Lr=({config:{activatedOnStoreValue:r}})=>r===void 0?!0:!!Os(C.getState().gameMenus.gameInPlay,r);class kc{constructor(e){this.renderContext=e}output=T.createGain();#e=$({loop:{soundId:"teleportWarningSiren"}},this.output);tick(){const{renderContext:{item:e,room:t}}=this;this.#e(Lr(e)&&Ye(e.state.stoodOnBy,t).some(zr))}destroy(){}}const Tc=(r,e)=>Tn(Ye(r.state.stoodOnBy,e).filter(Cn));class Mc{constructor(e){this.renderContext=e,this.output.gain.value=2}output=T.createGain();#e=void 0;tick(e){const{renderContext:{item:t,room:o}}=this,n=Tc(t,o);this.#e!==void 0&&n<this.#e&&B({soundId:"toasterPopUpSoundUrl",connectTo:this.output}),this.#e=n}destroy(){}}const Pc={lift:pc,switch:Sc,button:cc,bubbles:ac,head:jt,heels:jt,headOverHeels:jt,teleporter:kc,monster:fc,conveyor:dc,spring:Cc,portableBlock:wc,charles:lc,ball:ic,pushableBlock:vc,firedDoughnut:uc,slidingBlock:bc},Rc=r=>{if(r.item.type==="deadlyBlock"&&r.item.config.style==="toaster")return new Mc(r);const e=Pc[r.item.type];if(e)return new e(r)},Io=R.z*-1,ko=R.z*Ci,Ac=0,_c=R.x*16,Oc={x:0,y:0,z:0},Vt=(r,e,t)=>(r-e)/(t-e)*2-1,zc=.5,Bc=.3;class Ec{constructor(e,t){this.renderContext=e,this.childRenderer=t,t.output.connect(this.output),this.output.rolloffFactor=2,this.output.maxDistance=5,this.output.distanceModel="exponential";const o=bi(e.room).floors;this.soundPositionMinX=o.edgeLeftX,this.soundPositionMaxX=o.edgeRightX}output=T.createPanner();soundPositionMinX;soundPositionMaxX;tick(e){this.childRenderer.tick(e);const{item:t}=this.renderContext,o=t.state,n=zs(Bs(Oc,t.aabb,.5),o.position),s=Vt(ft(n),this.soundPositionMinX,this.soundPositionMaxX),i=Vt(n.z,Io,ko);if(!Number.isFinite(i))throw new Error(`y position for sound rendering is not finite;
        positionY = numberInRangeToMinus1To1Range(
          itemCentrePosition = ${n.z},
          ${Io},
          ${ko},
        );
        itemCentrePosition = addXyz(
          itemState.position = ${JSON.stringify(o.position)},
          scaleXyz(${JSON.stringify(t.aabb)}, 0.5),
        )`);const c=Vt(n.x+n.y,Ac,_c);this.output.positionX.value=s*zc,this.output.positionY.value=i,this.output.positionZ.value=c*Bc}destroy(){this.childRenderer.destroy()}}const ns={white:{basic:{main:"white",edges:{towards:{hue:"cyan",dimInOriginal:!1},right:{hue:"yellow",dimInOriginal:!0}},hud:{brightHue:"yellow",dimmedHue:"magenta",icons:"cyan"}},dimmed:{main:"white",edges:{towards:{hue:"green",dimInOriginal:!1},right:{hue:"cyan",dimInOriginal:!0}},hud:{brightHue:"yellow",dimmedHue:"magenta",icons:"cyan"}}},yellow:{basic:{main:"yellow",edges:{towards:{hue:"green",dimInOriginal:!1},right:{hue:"white",dimInOriginal:!0}},hud:{brightHue:"cyan",dimmedHue:"magenta",icons:"green"}},dimmed:{main:"yellow",edges:{towards:{hue:"cyan",dimInOriginal:!0},right:{hue:"cyan",dimInOriginal:!1}},hud:{brightHue:"cyan",dimmedHue:"magenta",icons:"green"}}},magenta:{basic:{main:"magenta",edges:{towards:{hue:"green",dimInOriginal:!0},right:{hue:"cyan",dimInOriginal:!0}},hud:{brightHue:"white",dimmedHue:"cyan",icons:"yellow"}},dimmed:{main:"magenta",edges:{towards:{hue:"green",dimInOriginal:!0},right:{hue:"cyan",dimInOriginal:!0}},hud:{brightHue:"white",dimmedHue:"cyan",icons:"yellow"}}},cyan:{basic:{main:"cyan",edges:{towards:{hue:"magenta",dimInOriginal:!1},right:{hue:"white",dimInOriginal:!1}},hud:{brightHue:"white",dimmedHue:"green",icons:"yellow"}},dimmed:{main:"cyan",edges:{towards:{hue:"magenta",dimInOriginal:!0},right:{hue:"white",dimInOriginal:!0}},hud:{brightHue:"white",dimmedHue:"green",icons:"yellow"}}},green:{basic:{main:"green",edges:{towards:{hue:"cyan",dimInOriginal:!1},right:{hue:"yellow",dimInOriginal:!1}},hud:{brightHue:"white",dimmedHue:"magenta",icons:"cyan"}},dimmed:{main:"green",edges:{towards:{hue:"cyan",dimInOriginal:!0},right:{hue:"yellow",dimInOriginal:!0}},hud:{brightHue:"white",dimmedHue:"magenta",icons:"cyan"}}}},$c=r=>ns[r.hue][r.shade],To={head:"pastelBlue",heels:"pink"},Mo=(r,e)=>{const t=$c(r.color).edges[e];return Re(t.hue,t.dimInOriginal?"dimmed":"basic")},Fc=He.filter(r=>r.startsWith("door.")),dr=r=>/\.floor$/.test(r),ur=r=>/\.wall\.[^.]+\.(away|left)$|door\.legs\.pillar/.test(r),Po=r=>/door\.legs\.pillar/.test(r),Lc=r=>/\.wall\.[^.]+\.left$/.test(r),Ut=r=>dr(r)||ur(r),Dc=(r,e,t)=>({ambient:[{lutType:"sparse",paletteSwaps:O(t.hue,t.shade==="dimmed")},t.shade==="basic"?ss(e,t):{lutType:"sparse",paletteSwaps:{...kt}}],textureSpecific:[...Vc(e,t),...jc(e,t),...Uc(t)],noReplacePlaceholderTextures:Fc}),jc=(r,e)=>{const{edges:t}=ns[e.hue][e.shade],o=O(t.right.hue,e.shade==="dimmed","light-mid"),n=O(t.towards.hue,e.shade==="dimmed","mid-dark");return[{textureIds:["floorEdge.half.right","floorEdge.right","generic.door.floatingThreshold.y"],paletteSwaps:o},{textureIds:["floorEdge.half.towards","floorEdge.towards","generic.door.floatingThreshold.x"],paletteSwaps:n}]},Vc=(r,e)=>{if(r==="jail")return[{textureIds:Ut,paletteSwaps:O(e.hue,e.shade==="dimmed","mid-dark")}];if(r==="blacktooth"&&e.shade==="dimmed")return[{textureIds:ur,paletteSwaps:O(e.hue,!0,"light-mid")}];if(e.hue==="white"||e.hue==="yellow")switch(r){case"market":return[{textureIds:Ut,paletteSwaps:O(e.hue,e.shade==="dimmed","mid-dark")}];case"egyptus":return[{textureIds:Po,paletteSwaps:O(e.hue,e.shade==="dimmed","light-dark")},{textureIds:dr,paletteSwaps:O(e.hue,e.shade==="dimmed","mid-dark")},{textureIds:Lc,paletteSwaps:O(e.hue,e.shade==="dimmed","light-mid")},{textureIds:ur,paletteSwaps:O(e.hue,e.shade==="dimmed","mid-dark")}];case"moonbase":case"penitentiary":case"safari":case"bookworld":return[{textureIds:dr,paletteSwaps:O(e.hue,e.shade==="dimmed","mid-dark")}];case"blacktooth":return[{textureIds:Po,paletteSwaps:O(e.hue,e.shade==="dimmed","light-dark")},{textureIds:Ut,paletteSwaps:O(e.hue,e.shade==="dimmed","light-mid")}]}return fe},Uc=r=>{const{hue:e,shade:t}=r;return e==="white"||e==="yellow"?[{textureIds:["book.x","book.y"],paletteSwaps:{...O(e,t==="dimmed","light-mid"),shadow:Ui(`swop_${e}Dim`,t==="dimmed")}}]:t==="dimmed"?[{textureIds:["book.x","book.y"],paletteSwaps:{...O(r.hue,!0,r.hue==="cyan"?"light-mid":"mid-dark")}}]:fe},Gc={blacktooth:{pureBlack:ie(g.moss,.15)},safari:{pureBlack:ie(g.moss,.17)},jail:{pureBlack:ie(g.redShadow,.2)},egyptus:{pureBlack:ie(g.redShadow)},moonbase:{shadow:g.shadow_greyBlue,pureBlack:ie(g.metallicBlue,.2)},bookworld:{shadow:g.shadow_brown,pureBlack:ie(g.highlightBeige,.1)},penitentiary:{pureBlack:ie(g.midGrey,.2)}},Hc={yellow:{shadow:g.shadow_brown},white:{shadow:g.shadow_greyBlue},magenta:{shadow:g.shadow_magenta},cyan:{shadow:g.shadow_blue}},ss=(r,e)=>({lutType:"sparse",paletteSwaps:{...Hc[e.hue]??me,...Gc[r]??me}}),Dr=6;function*Wc(r,e,t,o=1){const n=2**Dr-1,s=Math.floor(r*n+.5),i=Math.floor(e*n+.5),c=Math.floor(t*n+.5);for(let a=-o;a<=o;a++)for(let l=-o;l<=o;l++)for(let d=-o;d<=o;d++){const h=s+a,u=i+l,p=c+d;if(h<0||h>n||u<0||u>n||p<0||p>n)continue;const f=Math.sqrt(a*a+l*l+d*d),m=p%8*64,x=Math.floor(p/8)*64,w=m+h,S=x+u;yield{x:w,y:S,distance:f}}}const te=(2**Dr)**(3/2),is=te*te,Xc=r=>{const e=new Uint8Array(is*4);for(const o of Gi)for(const[n,s]of Es(r)){const i=g[n];for(const{x:c,y:a,distance:l}of Wc(i.red*o,i.green*o,i.blue*o,2)){const d=a*te+c,h=e[d*4+3],u=Math.max(1,Math.floor(255-l/1.732*254));(h===0||u>h)&&(e[d*4+0]=Math.floor(s.red*o*255),e[d*4+1]=Math.floor(s.green*o*255),e[d*4+2]=Math.floor(s.blue*o*255),e[d*4+3]=u)}}for(let o=3;o<e.length;o+=4)e[o]>0&&(e[o]=255);return F.from({resource:e,width:te,height:te,scaleMode:"nearest",antialias:!1})},{floor:dt,min:Nc}=Math,qc=r=>{if(r instanceof Map)return r;const e=new Map,t=Object.entries(r);for(const[o,n]of t){const s=g[o],i=typeof n=="string"?g[n]:n;e.set(s,i)}return e},Ro={red:0,blue:0,green:0},Zc=9;function Yc(r){const e=qc(r),t=new Uint8Array(is*4).fill(255),o=e.keys().toArray(),n=e.values().map(x=>({red:dt(x.red*255),green:dt(x.green*255),blue:dt(x.blue*255)})).toArray(),s=o.length,i=2**Dr,c=1/(i-1),a=new Array(s),l=new Array(s),d=[];let h=0;for(let x=0;x<i;x++){const w=new Array(s);for(let S=0;S<s;S++){const b=h-o[S].green;w[S]=b*b}d[x]=w,h+=c}const u=[];let p=0;for(let x=0;x<i;x++){const w=new Array(s);for(let S=0;S<s;S++){const b=p-o[S].red;w[S]=b*b}u[x]=w,p+=c}let f=0;for(let x=0;x<i;x++){const w=x%8*64,S=dt(x/8)*64;for(let b=0;b<s;b++){const k=f-o[b].blue;a[b]=k*k}for(let b=0;b<i;b++){const k=d[b];let A=(S+b)*te+w<<2;for(let I=0;I<s;I++)l[I]=a[I]+k[I];for(let I=0;I<i;){const U=u[I];let G=Ro,Qe=9999;for(let _=0;_<s;_++){const J=l[_]+U[_];J<Qe&&(G=n[_],Qe=J)}let ze=1;const et=Nc(I+Zc,i-1);for(let _=et;_>I;_--){let J=Ro,tt=9999;const xs=u[_];for(let Be=0;Be<s;Be++){const Wr=l[Be]+xs[Be];Wr<tt&&(J=n[Be],tt=Wr)}if(J===G){ze=_-I+1;break}}for(let _=0;_<ze;_++)t[A++]=G.red,t[A++]=G.green,t[A]=G.blue,A+=2;I+=ze}}f+=c}return F.from({resource:t,width:te,height:te,scaleMode:"nearest",antialias:!1})}var Jc=`#version 300 es
precision highp float;in vec2 vTextureCoord;out vec4 finalColor;uniform sampler2D uTexture;uniform sampler2D uLut;uniform sampler2D uMask;const float lutW=512.0;ivec2 blockEncode(vec3 color){ivec3 c6=ivec3(floor(color*63.0+0.5));int blockX=(c6.b % 8)*64;int blockY=(c6.b/8)*64;int x=blockX+c6.r;int y=blockY+c6.g;return ivec2(x,y);}vec4 lutColourReplace(sampler2D lut,vec4 inputColour){ivec2 lutPos=blockEncode(inputColour.rgb);vec2 normalizedPos=vec2((float(lutPos.x)+0.5)/lutW,(float(lutPos.y)+0.5)/lutW);vec4 replacementColour=texture(lut,normalizedPos);float shouldReplace=step(0.99,inputColour.a)*step(0.004,replacementColour.a);vec4 replacement=vec4(replacementColour.rgb,inputColour.a);return mix(inputColour,replacement,shouldReplace);}void main(void){vec4 c=texture(uTexture,vTextureCoord);float maskVal=texture(uMask,vTextureCoord).r;finalColor=mix(c,lutColourReplace(uLut,c),maskVal);}`;const Kc=we.from({vertex:ve,fragment:Jc,name:"palette-swop-filter1"});class Ue extends ye{constructor({paletteSwaps:e,lutType:t},o=F.WHITE){const n=(t==="voronoi"?Yc:Xc)(e);super({glProgram:Kc,resources:{colorReplaceUniforms:{},uLut:n.source,uMask:o.source}}),this.mask=o,this.#e=n}#e;destroy(e){const t=e===!0||typeof e=="object"&&e.destroyPrograms,o=e===!0||typeof e=="object"&&e.destroyLutTexture,n=this.lutTexture!==F.WHITE&&e===!0||typeof e=="object"&&e.destroyMask;o&&this.#e?.destroy(!0),this.#e=null,n&&this.mask?.destroy(!0),super.destroy(t)}get lutTexture(){return this.#e}}const as={ambient:[]},Qc=Y(He).filter(r=>r.startsWith("shadow.")||r.startsWith("shadowMask.")||r.startsWith("hud.")).toArray(),el=r=>typeof r=="function"?Y(He).filter(r):r,tl=(r,e)=>new Ue({paletteSwaps:dn(g,([t])=>t==="replaceDark"||t==="replaceLight"?[t,r]:[t,e]),lutType:"sparse"}),rl=(r,{ambient:e,textureSpecific:t=fe,noReplacePlaceholderTextures:o=fe},n=$s())=>{const s=[];for(const{textureIds:d,paletteSwaps:h}of t){const u=Zr(r,{rects:{textureIds:d,color:Rt},clearColour:At}),p=new Ue({paletteSwaps:h,lutType:"sparse"},u);s.push(p)}const i=o.length>0?tl(At,Rt):void 0,c=Zr(r,{clearColour:Rt,rects:{textureIds:Yi(Qc,Y(t).filter(({dodgeAmbient:d})=>d).flatMap(({textureIds:d})=>el(d))),color:At},placeholderColoursMasks:i?{textureIds:o,filter:i,originalSpritesheet:We()}:void 0});i?.destroy({destroyLutTexture:!0,destroyMask:!0});for(const d of e){const h=new Ue(d,c);s.push(h)}const a=new V(n);a.filters=s;const l=ge.create({width:n.width,height:n.height});r.render({container:a,target:l}),a.destroy(!1),c.destroy();for(const d of s)d instanceof Ue?d.destroy({destroyLutTexture:!0,destroyMask:!0,destroyPrograms:!1}):d.destroy(!1);return l},Je=(r,e,t)=>{const o=rl(r,e,t),n=new Fs(o.source,structuredClone(qe));return n.parseSync(),n.textureSource.scaleMode="nearest",n},jr={ambient:[{paletteSwaps:kt,lutType:"sparse"}]},vt=(r,e,t)=>{const o=F.from(e.textureSource),n=Je(r,t,o);return o.destroy(),e.textureSource.destroy(),e.destroy(!0),n};let Te,hr=as;const ol=()=>{Te!==void 0&&(Te.textureSource.destroy(),Te.destroy(!0),Te=void 0)},nl=(r,e,t,o)=>{ol(),hr=Dc(e,t,o)??as,Te=Je(r,hr)},sl=()=>Te,xt=r=>{let e=g[r];for(const t of hr.ambient)e=t.paletteSwaps[r]??e;return e};let ce;const Vr={lightBeige:g.lightGrey,redShadow:g.shadow,pink:g.lightGrey,moss:g.lightGrey,midRed:g.midGrey,highlightBeige:g.lightGrey,pastelBlue:g.lightGrey,metallicBlue:g.midGrey,replaceLight:g.lightGrey,replaceDark:g.midGrey},il=un(Vr,"metallicBlue","pastelBlue"),al=un(Vr,"pink"),cl={ambient:[{paletteSwaps:Vr,lutType:"sparse"}],textureSpecific:[{textureIds:He.filter(r=>r.startsWith("head.")),paletteSwaps:il,dodgeAmbient:!0},{textureIds:He.filter(r=>r.startsWith("heels.")),paletteSwaps:al,dodgeAmbient:!0}]},ll=()=>{ce!==void 0&&(ce.textureSource.destroy(),ce.destroy(!0),ce=void 0)},dl=(r,e,t)=>{ll();let o=Je(r,cl);t.shade==="dimmed"?o=vt(r,o,jr):o=vt(r,o,{ambient:[ss(e,t)]}),ce=o},ul=()=>{if(ce===void 0)throw new Error("swopped spritesheet undefined - should only be called when we know for sure it is available");return ce};let le;const hl={midGrey:g.midRed,lightGrey:g.lightBeige,white:g.highlightBeige,metallicBlue:g.redShadow,shadow:g.redShadow,pastelBlue:g.lightBeige,pink:g.midRed,moss:g.midRed,replaceDark:g.midRed,replaceLight:g.lightBeige},pl=()=>{le!==void 0&&(le.textureSource.destroy(),le.destroy(!0),le=void 0)},fl=(r,e)=>{pl();let t=Je(r,{ambient:[{paletteSwaps:hl,lutType:"sparse"}]});e&&(t=vt(r,t,jr)),le=t},ml=()=>{if(le===void 0)throw new Error("swopped spritesheet undefined - should only be called when we know for sure it is available");return le};let de;const gl={pastelBlue:g.moss,metallicBlue:g.moss,pink:g.moss},xl=()=>{de!==void 0&&(de.textureSource.destroy(),de.destroy(!0),de=void 0)},yl=(r,e)=>{xl();let t=Je(r,{ambient:[{paletteSwaps:gl,lutType:"sparse"}]});e&&(t=vt(r,t,jr)),de=t},wl=()=>{if(de===void 0)throw new Error("swopped spritesheet undefined - should only be called when we know for sure it is available");return de},vl=()=>{throw new Error("swopped spritesheet undefined - should only be called when we know for sure it is available")},Xe=r=>{try{switch(r){case"original":return We();case"deactivated":return ul();case"doughnutted":return ml();case"for-current-room":return sl();case"sceneryPlayer":return wl();case"uncolourised":return vl();default:return r}}catch(e){throw new Error(`could not get spritesheet variant "${r}"`,{cause:e})}},Gt={x:.5,y:1},Ao=r=>typeof r!="string"&&Object.hasOwn(r,"animationId"),pr=r=>{const{anchor:e,flipX:t,pivot:o,x:n,y:s,times:i,label:c}=r;if(r.times){const l=Si(i);if(Sr(l)>=2){const h=new v({label:c??"timesXyz"});for(let{x:u}=l;u>=1;u--)for(let{y:p}=l;p>=1;p--)for(let f=1;f<=l.z;f++){const m={...r,label:`(${u},${p},${f})`,...r.subSpriteVariations?.(u-1,p-1,f-1),subSpriteVariations:void 0};"randomiseStartFrame"in m&&(m.randomiseStartFrame=`${m.randomiseStartFrame}${u},${p},${f}`),delete m.times;const x=pr(m),w=xe({x:u-1,y:p-1,z:f-1});x.x+=w.x,x.y+=+w.y,h.addChild(x)}return h}}if(r.subSpriteVariations!==void 0)return pr({...r,...r.subSpriteVariations(0,0,0),subSpriteVariations:void 0});let a;if(Ao(r))a=bl(r);else{const{textureId:l}=r,d=Xe(r.spritesheetVariant??"original");a=new V(l!==void 0?d.textures[l]:F.EMPTY)}if(e===void 0&&o===void 0)if(Ao(r))a.anchor=Gt;else{const{textureId:l}=r,d=l!==void 0?Xe(r.spritesheetVariant??"original").data.frames[l]:void 0;if(d!==void 0){const h=d.frame;h.pivot!==void 0?a.pivot=h.pivot:a.anchor=Gt}else a.anchor=Gt}else e!==void 0&&(a.anchor=e),o!==void 0&&(a.pivot=o);return n!==void 0&&(a.x=n),s!==void 0&&(a.y=s),c!==void 0&&(a.label=c),a.eventMode="static",t===!0&&(a.scale.x=-1),a},cs=(r,e=!1)=>{const t=ae.shared.speed,o=e||t===0?0:Math.sqrt(t)/t;return qe.animations[r].animationSpeed*o},ls=r=>r.map(e=>({texture:e,time:Ls}));function bl({animationId:r,reverse:e,playOnce:t,paused:o,randomiseStartFrame:n,spritesheetVariant:s}){const i=Xe(s).animations[r],c=ls(i);e&&c.reverse();const a=new X(c);return a.animationSpeed=cs(r,o),a.gotoAndPlay(n!==void 0?Math.floor(rs(n)*c.length):0),t!==void 0&&(a.loop=!1,a.onComplete=()=>{a.stop(),t==="and-destroy"&&(a.visible=!1)}),a}const y=pr,Cl={Container:"",Sprite:"",UniqueTextureSprite:"",Graphics:"",Text:"",AnimatedSprite:"",TilingSprite:"",BitmapText:"",Mesh:"",NineSliceSprite:""},Sl=r=>{const e=r.constructor.name;return e.startsWith("_")?e.slice(1):e},Il=r=>Cl[r]||"",kl=r=>{const e=[];try{(r.x!==0||r.y!==0)&&e.push(`@(x=${r.x}, y=${r.y})`)}catch{e.push("@(ERROR)")}if(r.children.length>0&&e.push(`children: ${r.children.length}`),r.visible||e.push("hidden"),r.alpha<1&&e.push(`alpha: ${r.alpha.toFixed(2)}`),r.mask&&e.push(" masked"),r instanceof V)if(r.texture===null||r.texture===void 0)e.push("texture: NO TEXTURE");else{const t=r.texture.label||"(anon texture)";e.push(`texture: "${t}"`)}return e},Tl=(r,e)=>r.label&&r.label!==e?` "${r.label}"`:"",bt=(r,e="",t=!0,o=!0,n=[])=>{const s=[];o&&s.push("");const i=Sl(r);let c=Il(i);n.forEach((u,p)=>{u.mask===r&&(p===0?c+="":c+=`^${p+1}`)});const a=Tl(r,i),l=kl(r),d=o?"":e+(t?" ":" ");if(s.push(`${d}${c} ${i}${a}`),l.length>0){const u=r.children.length>0,p=o?u?"  ":"   ":e+(t?"    ":"   ")+(u?"  ":"   ");l.forEach(f=>{s.push(`${p} ${f}`)})}const h=o?"":e+(t?"    ":"   ");return r.children.forEach((u,p)=>{const f=p===r.children.length-1;s.push(bt(u,h,f,!1,[r,...n]))}),s.join(`
`)+(o?`
`:"")};class Ml extends X{destroy(e){const t=this.textures.map(o=>"texture"in o?o.texture:o).filter(o=>o instanceof ge);super.destroy(e);for(const o of t)o.destroy(!0)}}class Pl extends V{constructor(...e){const[t]=e;super(t)}destroy(e){const t=this.texture!==null;typeof e=="boolean"?super.destroy({texture:t,textureSource:this.texture instanceof ge,children:e}):super.destroy({...e,texture:t,textureSource:this.texture instanceof ge})}}const Ur=(r,e,t)=>{const o=e.getLocalBounds(),n=Math.ceil(o.maxX-o.minX),s=Math.ceil(o.maxY-o.minY),i=t!==void 0?t.width===n&&t.height===s:!1,c=i?t:ge.create({width:n,height:s,antialias:!1,autoGenerateMipmaps:!1});c.label=`renderTexture of ${e.label??"(anon)"}`,t&&!i&&t.destroy();const{x:a,y:l}=e;e.x-=o.minX,e.y-=o.minY;try{r.render({container:e,target:c,clear:i})}catch(d){throw new Error(`renderContainerToTexture: failed to render to texture. Container:
 ${bt(e)}`,{cause:d})}return e.x=a,e.y=l,c},W=(r,e,t,o)=>{const n=e.getLocalBounds(),s=t?.texture&&t?.texture instanceof ge?t.texture:void 0,i=Ur(r,e,s),c=t||new Pl;return c.texture=i,c.label=o??`sprite of container (${e.label})`,c.pivot={x:Math.floor(-n.minX),y:Math.floor(-n.minY)},c},Gr=(r,e,t,o)=>{if(e instanceof X||e instanceof V)return e;const n=e.getLocalBounds(),s=e.children.find(a=>a instanceof X)?.textures.length??1,i=Y(Ds(0,s)).map(a=>{if(a>0)for(const l of e.children)l instanceof X&&l.gotoAndStop((l.currentFrame+1)%s);return Ur(r,e)}).toArray(),c=new Ml(ls(i));return c.animationSpeed=cs(t,!1),c.gotoAndPlay(0),c.label=`animated sprite of container (${e.label})`,c.pivot={x:Math.floor(-n.minX),y:Math.floor(-n.minY)},c},Oe=(r,e)=>e instanceof V?e:W(r,e),Rl=(r,e,t)=>e==="tower"?"tower":e==="book"?"book.x":e==="organic"&&r?`block.organic.dark${t?".disappearing":""}`:`block.${e}${t?".disappearing":""}`,Al=({renderContext:{general:{pixiRenderer:r,colourised:e},item:{config:{style:t,times:o},state:{disappearing:n}},room:s},currentRendering:i})=>{const c=i?.renderProps,a=n!==null;return c===void 0||c.isDissapearing!==a?{output:Oe(r,y({textureId:Rl(s.color.shade==="dimmed",t,a),times:o,spritesheetVariant:e?"for-current-room":"uncolourised"})),renderProps:{isDissapearing:a}}:"no-update"},_l=({renderContext:{item:{state:{pressed:r}},general:{colourised:e}},currentRendering:t})=>{const o=t?.renderProps;return o===void 0||r!==o.pressed?{output:y({textureId:r?"buttonInGame.pressed":"buttonInGame",spritesheetVariant:e?"for-current-room":"uncolourised"}),renderProps:{pressed:r}}:"no-update"},Me=({top:r,bottom:e})=>{const t=new v,o=y(e);t.addChild(o);const n=y(r);return n.y=-12,t.addChild(n),t[Tt]=n,t[Hr]=o,t},Tt=Symbol(),Hr=Symbol(),Ol=({top:r,bottom:e})=>{const t=new v;return t.addChild(e),r.y=-R.z,t.addChild(r),t[Tt]=r,t[Hr]=e,t},zl=({renderContext:{item:{state:{facing:r,actedOnAt:{roomTime:e,by:t}}},room:{roomTime:o,items:n},general:{colourised:s}},currentRendering:i})=>{const c=i?.renderProps,a=Tr(r)??"towards",l=o===e&&Y(St(t)).some(u=>bn(n[u]));if(!(c===void 0||a!==c.facingXy4||l!==c.controlledByJoystick))return"no-update";const h=s?"for-current-room":"uncolourised";return{output:Me({top:{textureId:`charles.${a}`,spritesheetVariant:h},bottom:{textureId:l?"headlessBase.all":"headlessBase",spritesheetVariant:h}}),renderProps:{facingXy4:a,controlledByJoystick:l}}},Ke=r=>r,_o=250,Bl=qe.animations["conveyor.x"].animationSpeed,Oo=qe.animations["conveyor.x"].length,El=r=>1-(1-r)**2,$l=3,Fl=(r,e)=>{for(let t=0;t<r.children.length;t++){const o=r.children[t],n=t*$l%Oo;o.gotoAndStop(e?Oo-n-1:n)}},Ll=(r,e,t)=>{const o=oe(r),n=y({animationId:`conveyor.${o}`,reverse:r==="towards"||r==="right",times:e,spritesheetVariant:t}),s=n instanceof X?new v({children:[n]}):n;return Fl(s,r==="towards"||r==="right"),s},Dl=({renderContext:{item:{config:{times:r},state:{stoodOnBy:e,direction:t}},room:{roomTime:o},general:{colourised:n,pixiRenderer:s}},currentRendering:i})=>{const c=i?.renderProps,a=Ze(e),l=!a&&(c?.moving??!1),d=l?o:c?.roomTimeStoppedMoving??Or,h=a?0:Math.min(o-d,_o),u=i?.output,p=!u||t!==c?.direction,m=p?Gr(s,Ll(t,r,n?"for-current-room":"uncolourised"),"conveyor.x"):u,x=Math.max(0,1-h/_o);if(x===0)m.stop();else{const w=Bl*El(x);m.play(),m.animationSpeed=w}return p||l||a!==c?.moving?{output:m,renderProps:{moving:a,roomTimeStoppedMoving:d,direction:t}}:"no-update"},jl=Ke(Dl);function ds(r,e){const t=e||new v;for(const o of r)t.addChild(o);return t}const Mt=(r,e)=>{const t=e&&{x:e.x??1,y:e.y??1};return y({...r,times:t})},Se=r=>z(({renderContext:{item:e,general:{colourised:t}}})=>Br(e)?y({...typeof r=="string"?{textureId:r}:r,times:It(e),spritesheetVariant:t?"for-current-room":"uncolourised"}):y({...typeof r=="string"?{textureId:r}:r,spritesheetVariant:t?"for-current-room":"uncolourised"})),Vl=r=>z(({renderContext:{item:e,general:{paused:t,colourised:o}}})=>Br(e)?y({...r,times:It(e),paused:t,spritesheetVariant:o?"for-current-room":"uncolourised"}):y({...r,paused:t,spritesheetVariant:o?"for-current-room":"uncolourised"})),j=r=>z(({renderContext:{item:e,general:{pixiRenderer:t}}})=>{if(Br(e))return Oe(t,Mt(r,It(e)));{const o=y(r);return o instanceof V?o:W(t,o)}}),z=r=>(({renderContext:e,currentRendering:t,tickContext:o})=>t===void 0?{output:r({renderContext:e,currentRendering:void 0,tickContext:o}),renderProps:me}:"no-update"),Q=r=>(({renderContext:{general:{pixiRenderer:e},item:t},currentRendering:o})=>{if(o===void 0){const n=It(t),s={output:Oe(e,Mt(r(t.config),n)),renderProps:me};return n&&(s.output.y-=((n.z??1)-1)*R.z),s}else return"no-update"}),Ul=(r,e,t)=>{const n=We().textures[`door.frame.${r.planet}.${e}.near`]!==void 0?r.planet:"generic",s=r.color.shade==="dimmed"&&We().textures[`door.frame.${n}.dark.${e}.${t}`]!==void 0;return`door.frame.${n}${s?".dark":""}.${e}.${t}`};function*Gl({config:{direction:r,inHiddenWall:e,height:t}},o){const n=Mr(r),s=n==="y"?1:16;function*i(c){if(e)t!==0&&(yield y({textureId:`generic.door.floatingThreshold.${n}`,...Ve(c,{y:-R.z*t}),spritesheetVariant:o}));else{yield y({pivot:{x:s,y:9},textureId:`generic.door.legs.base.${n}`,...Ve(c,{}),spritesheetVariant:o});for(let a=1;a<t;a++)yield y({pivot:{x:s,y:9},textureId:`generic.door.legs.pillar.${n}`,...Ve(c,{y:-a*R.z}),spritesheetVariant:o})}}yield*i(xe({...pe,[n]:1})),yield*i(pe),e||(yield y({pivot:{x:16,y:R.z*t+13},textureId:`generic.door.legs.threshold.double.${n}`,...xe({...pe,[n]:1}),spritesheetVariant:o}))}const us=(r,e)=>{const t=Mr(r),o=Ne(t),n=8;return r==="towards"||r==="right"?M({[o]:e[o]-n}):pe},Hl=z(({renderContext:{item:r,general:{pixiRenderer:e,colourised:t}}})=>{const n=ds(Gl(r,t?"for-current-room":"uncolourised")),s=W(e,n),i=us(r.config.direction,r.aabb);return s.x=i.x,s.y=i.y,s}),Wl=z(({renderContext:{item:{config:{direction:r,part:e,toRoom:t},aabb:o},room:n,general:{pixiRenderer:s,colourised:i}}})=>{const c=js(C.getState())??C.getState().levelEditor?.campaignInProgress,a=Mr(r),l=c?.rooms[t]??n,d=new Ue({paletteSwaps:O(l.color.hue,n.color.shade==="dimmed",n.planet==="moonbase"?"light-mid":"light-dark"),lutType:"sparse"}),{x:h,y:u}=us(r,o),p=y({textureId:Ul(n,a,e),x:h,y:u,spritesheetVariant:i?"for-current-room":"uncolourised"});p.filters=d;const f=new v({children:[p]}),m=W(s,f);return f.destroy({children:!0}),d.destroy({destroyLutTexture:!0,destroyMask:!0}),e==="top"&&(m.y=.5),m});var Xl=`#version 300 es
precision lowp float;in vec2 vTextureCoord;out vec4 finalColor;uniform vec2 uTextureSize;uniform sampler2D uTexture;uniform vec3 uOutline;uniform float uOutlineWidth;void main(void){vec2 scaledTexelSize=vec2(1.0f)/vec2(textureSize(uTexture,0))*uOutlineWidth;vec2 rightCoord=vec2(vTextureCoord.x+scaledTexelSize.x,vTextureCoord.y);vec2 leftCoord=vec2(vTextureCoord.x-scaledTexelSize.x,vTextureCoord.y);vec2 belowCoord=vec2(vTextureCoord.x,vTextureCoord.y+scaledTexelSize.y);vec2 aboveCoord=vec2(vTextureCoord.x,vTextureCoord.y-scaledTexelSize.y);vec4 colourToRight=texture(uTexture,rightCoord);vec4 colourToLeft=texture(uTexture,leftCoord);vec4 colourBelow=texture(uTexture,belowCoord);vec4 colourAbove=texture(uTexture,aboveCoord);float hasOpaqueNeighbor=max(max(colourToRight.a,colourToLeft.a),max(colourBelow.a,colourAbove.a));vec4 originalColour=texture(uTexture,vTextureCoord);finalColor=mix(originalColour,vec4(uOutline,1),(1.0-originalColour.a)*hasOpaqueNeighbor);}`;let fr=hn(C.getState());C.subscribe(()=>{fr=hn(C.getState())});const Nl=we.from({vertex:ve,fragment:Xl,name:"outline-filter"});class ne extends ye{outlineWidth;constructor({color:e,width:t}){const o=t??fr;super({glProgram:Nl,padding:o,resources:{colorReplaceUniforms:{uOutline:{value:new Float32Array(3),type:"vec3<f32>"},uOutlineWidth:{value:new Float32Array(1),type:"f32"}}}}),this.outlineWidth=t;const n=this.resources.colorReplaceUniforms.uniforms,[s,i,c]=e.toArray();n.uOutline[0]=s,n.uOutline[1]=i,n.uOutline[2]=c}apply(e,t,o,n){const s=this.resources.colorReplaceUniforms.uniforms,i=this.outlineWidth??fr;this.padding=i,s.uOutlineWidth[0]=i,super.apply(e,t,o,n)}}const Pt={...dn(g,([r,e])=>[r,new ne({color:e})]),black1pxFilter:new ne({color:g.pureBlack,width:1})},ql=r=>{const e=`hud.char.${Us(r)}`;try{In(e)}catch(t){throw new Error(`no texture id for char "${r}": ${t.message}`,{cause:t})}return e},Zl=r=>typeof r=="string"?r==="infinite"?"":r:r.toString();class hs extends v{#e;#r="";#t;#o;#n;#s;#i;constructor({pixiRenderer:e,doubleHeight:t=!1,doubleWidth:o=!1,outline:n=!1,label:s="text",x:i,y:c,tint:a,text:l}){super({label:s,x:i,y:c,tint:a}),this.#e=e,this.#s=t?2:1,this.#i=o?2:1,this.#t=new V,this.#t.y=-(ot.h*this.#s+1),this.addChild(this.#t),this.#n=new v,this.addChild(this.#n),this.#o=new v,this.#o.scale={x:this.#i,y:this.#s},n&&(this.#o.filters=new ne({color:g.pureBlack,width:1})),this.#n.addChild(this.#o),l!==void 0&&(this.text=l)}get text(){return this.#r}set text(e){const t=Zl(e);this.#r!==t&&(this.#a(t),this.#n.visible=!0,this.#n.boundsArea=new Vs(-1,-1,(ot.w*t.length+2)*this.#i,(ot.h+2)*this.#s),this.#t.texture&&this.#t.texture.destroy(!0),this.#t.texture=Ur(this.#e,this.#n),this.#t.x=-this.#t.texture.frame.width/2,this.#n.visible=!1,this.#r=t)}#a(e){const t=Tn(e),o=this.#o.children.length,n=t!==o;try{const s=We().textures;let i=0;for(const c of e){const a=ql(c);let l;i<o?(l=this.#o.getChildAt(i),l.texture=s[a]):(l=new V(s[a]),this.#o.addChild(l)),i++}}catch(s){throw console.error("invalid string is",e,"and on window as window.invalid"),console.error(s),window.invalid=e,new Error(`could not show text "${e}" in container because: "${s.message}"`,{cause:s})}if(n){t<o&&this.#o.removeChildren(t);for(let s=0;s<t;s++){const i=this.#o.getChildAt(s);i.x=s*ot.w}}}destroy(e){this.#t.destroy({texture:!0,textureSource:!0}),super.destroy(e)}get characterSpriteContainer(){return this.#o}}const Yl=Ii.floatingText,zo=12,Bo=R.z*3,Eo=[g.shadow,g.redShadow,g.midGrey,g.metallicBlue,g.midRed,g.moss,g.pink,g.lightBeige,g.pastelBlue,g.lightGrey,g.highlightBeige],$o=[...Eo,...new Array(20).fill(g.white),...Eo.toReversed()],Jl=({renderContext:{item:{config:{textLines:r,appearanceRoomTime:e}},room:{roomTime:t},general:{displaySettings:{uncolourised:o},pixiRenderer:n},frontLayer:s},currentRendering:i})=>{const c=i?.output;let a;const d=(t-e)*Yl;if(c===void 0){a=new v,s?.attach(a);for(let u=0;u<r.length;u++){const p=r[u],f=new hs({pixiRenderer:n,y:u*zo,outline:!0,text:p.toUpperCase()});a.addChild(f)}}else a=c;let h=!1;for(let u=0;u<r.length;u++){const p=a.children[u],f=d+u*-zo,m=f>0&&f<Bo;if(p.visible=m,h||=m,m&&!o){const x=Math.floor(f/Bo*$o.length);p.tint=$o[x]}}return a.visible=h,a.y=-d,{output:a,renderProps:me}},Fo=(r,e)=>e===0?r:Math.round(r/e)*e,Lo=r=>r-Math.floor(r),Kl=(r,e,t,o)=>r<=o&&t<=e;var Ql=`#version 300 es
precision lowp float;out vec4 finalColor;in vec2 vTextureCoord;uniform sampler2D uBackTexture;uniform sampler2D uTexture;uniform vec4 uTintColour;vec4 transparent=vec4(0.0,0.0,0.0,0.0);vec4 black=vec4(0.0,0.0,0.0,1.0);void main(){vec4 fg=texture(uTexture,vTextureCoord);vec3 bg=texture(uBackTexture,vTextureCoord).rgb;float fgIsTransparent=step(fg.a,0.001f);float bgIsBlack=step(length(bg),0.001f);finalColor=mix(mix(uTintColour,black,bgIsBlack),transparent,fgIsTransparent);}`;const ed=we.from({vertex:ve,fragment:Ql,name:"colour-clash-filter"});class Do extends ye{constructor(e){super({glProgram:ed,resources:{uBackTexture:F.EMPTY,colourClashUniforms:{uTintColour:{value:e,type:"vec4<f32>"}}},blendRequired:!0})}}const td=({state:{position:r}},e,t)=>{const o=s=>s.config.direction==="away"||s.config.direction==="left";return ds(ee(e.items).filter(s=>s.type==="wall"||s.type==="doorLegs").filter(o).map(s=>{const{id:i,config:{direction:c},state:{position:a}}=s;return y({textureId:"floorOverdraw.cornerNearWall",label:i,...M(tr(a,r)),times:s.type==="wall"?gn(s.config):{[Ne(oe(c))]:2},anchor:{x:0,y:1},flipX:c==="away",spritesheetVariant:t?"for-current-room":"uncolourised"})}),new v({label:"floorOverdraws"}))},rd=(r,e)=>{const{config:{naturalFootprint:{aabb:t,position:o}},state:{position:n}}=e,s=ft(re(Ae,n)),{left:i,right:c}=ee(r.items).filter(ki).filter(a=>{const{state:{position:l},aabb:d}=a,h=a.config.direction,u=oe(h),p=Ne(u),f=h==="away"||h==="left",m=o[u]+(f?1:0)*t[u],x=l[u]+(f?0:1)*d[u];return m!==x?!1:Kl(l[p],l[p]+d[p],o[p],o[p]+t[p])}).reduce((a,{aabb:l,renderAabb:d,renderAabbOffset:h,state:{position:u},fixedZIndex:p})=>{const f=p===Ti,m=f?l:d??l,x=q(u,h??Ae),w=ft(q(x,{x:m.x,y:f?m.y:0}))+s,S=ft(q(x,{x:f?m.x:0,y:m.y}))+s;return{left:Math.min(a.left,w),right:Math.max(a.right,S)}},{left:9999,right:-9999});if(c>i)return new Z().rect(i,-500,c-i,500).fill("rgba(255, 0, 0)")},jo=({direction:r,times:e,position:t,colourised:o})=>y({label:`floorEdge(${r})`,textureId:`floorEdge.${r}`,times:e,...M(t),spritesheetVariant:o?"for-current-room":"uncolourised"}),od=({room:r,xSize:e,ySize:t,y:o})=>{const n=new v({label:"floorColourClash"}),s=Mo(r,"right"),i=new v({label:"floorColourClash.right",filters:[new Do(s)]});for(let l=0;l<=t;l++){const d=xe({x:0,y:l,z:0}),h=new Z().rect(d.x-(l===0?0:8),d.y,24,8).fill(s);i.addChild(h)}n.addChild(i);const c=Mo(r,"towards"),a=new v({label:"floorColourClash.towards",filters:[new Do(c)]});for(let l=0;l<=e;l++){const d=xe({x:l,y:0,z:0}),h=new Z().rect(d.x-16,d.y,8*(l===0?2:3),8).fill(c);a.addChild(h)}return n.addChild(a),n.y=o,n},nd=z(({renderContext:{room:r,item:e,general:{colourised:t,pixiRenderer:o},colourClashLayer:n,frontLayer:s}})=>{const{color:{shade:i}}=r,{config:c,state:{position:a},aabb:l}=e,{floorType:d,naturalFootprint:h}=c,u=new v({label:"floorAppearance"}),p=new v({label:"sprites"}),f=M({...l,y:0}),m=M({...l,x:0,y:0}),x=M({...l,x:0}),w=M(l),S=new ne({color:t?xt("pureBlack"):Gs.black,width:1});if(d!=="none"){const b=new v({label:"tiles"}),k=d==="deadly"?`generic${i==="dimmed"?".dark":""}.floor.deadly`:`${c.scenery}${i==="dimmed"?".dark":""}.floor`,E=Xe(t?"for-current-room":"uncolourised").textures[k];try{In(k)}catch(tt){throw new Error(`no floor textureId for floorType: ${d}, shade: ${i}`,{cause:tt})}const A=re(h.position,a),I={x:Lo(A.x/R.x),y:Lo(A.y/R.x)},U=8,G={x:f.x,y:w.y-U,width:x.x-f.x,height:m.y-w.y+2*U},Qe=re(xe(Ve(I,{x:.5,y:.5})),{y:l.z},G),ze=new ha({texture:E,tilePosition:Qe,...G});b.addChild(ze),b.addChild(td(e,r,t));const et=new Z().moveTo(w.x,w.y).lineTo(x.x,x.y).lineTo(x.x,x.y+3).lineTo(m.x,m.y+3).lineTo(f.x,f.y+3).lineTo(f.x,f.y).fill({color:16711680,alpha:1}),_=W(o,et);et.destroy(),b.addChild(_),b.mask=_;const J=new v({children:[b]});J.filters=S,p.addChild(J)}{const b=new v({label:"edges"});if(d==="none"){const I=new Z().moveTo(x.x,x.y+10).lineTo(x.x,x.y+100).lineTo(f.x,f.y+100).lineTo(f.x,f.y+10).lineTo(m.x,m.y+10).fill(0),U=W(o,I);u.addChild(U),s.attach(U),I.destroy()}const k=Math.ceil(l.y/R.x);b.addChild(jo({direction:"right",times:{y:k},position:{z:l.z},colourised:t}));const E=Math.ceil(l.x/R.x);b.addChild(jo({direction:"towards",times:{x:E},position:{z:l.z},colourised:t})),p.addChild(b);const A=rd(r,e);if(A!==void 0){const I=W(o,A);p.addChild(I),p.mask=I,A.destroy()}if(u.addChild(W(o,p)),p.destroy({children:!0}),S.destroy(!1),!t){const I=od({xSize:E,ySize:k,y:-l.z+1,room:r});u.addChild(I),n.attach(I)}}return u}),sd=r=>{const e=new v({label:"joystick"});return e.addChild(y({textureId:"joystick.stick",spritesheetVariant:r})),e.addChild(y({textureId:"joystick.ball",spritesheetVariant:r})),e},id=new Map([["towards",{x:-1,y:1}],["right",{x:1,y:1}],["left",{x:-1,y:0}],["away",{x:1,y:0}],[void 0,pe]]),ad=({renderContext:{item:{state:{actedOnAt:r,lastPushDirection:e}},room:{roomTime:t},general:{colourised:o}},currentRendering:n})=>{const s=n?.renderProps,i=t===r.roomTime?e:void 0,c=s?.pushDirection;if(!(s===void 0||i!==c))return"no-update";const l=n?.output??sd(o?"for-current-room":"uncolourised"),d=l.getChildAt(1),h=id.get(i);return d.x=h?.x??0,d.y=h?.y??0,{output:l,renderProps:{pushDirection:i}}},cd=["cyberman","dalek","skiHead","bubbleRobot","computerBot","turtle","homingBot"],Vo=(r,e,t,o)=>{const n=rs(o);return Math.sin((r+n*2e4)/e)*t},ld=50,dd=200,ud=.25,hd=1,Uo=({id:r,config:{which:e},state:t},o,n)=>{const s=e==="emperorsGuardian"||e==="helicopterBug",i=e==="cyberman"||e==="bubbleRobot"||e==="computerBot"||e==="emperorsGuardian";if((i||e==="helicopterBug")&&t.activated||s){const a=e==="computerBot"||e==="helicopterBug",l=a?ld:dd,d=a?ud:hd;if(i){const h=n;h[Tt].y=-R.z+Vo(o.roomTime,l,d,r)}else n.y=Vo(o.roomTime,l,d,r)}},pd=({renderContext:{item:r,room:e,general:{paused:t,colourised:o}},currentRendering:n})=>{const{config:s,state:i,id:c}=r,a=n?.renderProps,{activated:l,busyLickingDoughnutsOffFace:d}=i,h=o?d?"doughnutted":!l&&cd.includes(s.which)?"deactivated":"for-current-room":"uncolourised";switch(s.which){case"skiHead":case"turtle":case"cyberman":case"computerBot":case"elephant":case"elephantHead":case"monkey":{const u=Tr(i.facing)??"towards";if(!(a===void 0||l!==a.activated||d!==a.busyLickingDoughnutsOffFace||u!==a.facingXy4))return Uo(r,e,n.output),"no-update";const f={facingXy4:u,activated:l,busyLickingDoughnutsOffFace:d};switch(s.which){case"skiHead":return{output:y({textureId:`${s.which}.${s.style}.${u}`,spritesheetVariant:h}),renderProps:f};case"elephantHead":return{output:y({textureId:`elephant.${u}`,spritesheetVariant:h}),renderProps:f};case"turtle":return{output:y(l&&!d?{animationId:`${s.which}.${u}`,spritesheetVariant:h,paused:t,randomiseStartFrame:c}:{textureId:`${s.which}.${u}.1`,spritesheetVariant:h}),renderProps:f};case"cyberman":return{output:i.activated||i.busyLickingDoughnutsOffFace?Me({top:{textureId:`${s.which}.${u}`,spritesheetVariant:h},bottom:{animationId:"bubbles.jetpack",paused:t,spritesheetVariant:h}}):y({textureId:`${s.which}.${u}`,spritesheetVariant:h}),renderProps:f};case"computerBot":case"elephant":case"monkey":return{output:Me({top:{textureId:`${s.which}.${u}`,spritesheetVariant:h},bottom:{animationId:"headlessBase.flash",playOnce:"and-stop",spritesheetVariant:h}}),renderProps:f};default:throw new Error(`unexpected monster ${s}`)}break}case"homingBot":{const u=!Hs(i.vels.walking,pe);return a===void 0||d!==a.busyLickingDoughnutsOffFace||l!==a.activated||u!==a.walking?{spritesheetVariant:h,output:y(l&&!d?{animationId:u?"headlessBase.flash":"headlessBase.scan",spritesheetVariant:h}:{textureId:"headlessBase",spritesheetVariant:h}),renderProps:{activated:l,busyLickingDoughnutsOffFace:d,walking:u}}:"no-update"}case"helicopterBug":case"emperor":case"dalek":case"bubbleRobot":case"emperorsGuardian":{if(!(a===void 0||d!==a.busyLickingDoughnutsOffFace||l!==a.activated))return Uo(r,e,n.output),"no-update";const p={activated:l,busyLickingDoughnutsOffFace:d};switch(s.which){case"helicopterBug":case"dalek":return{output:y(l&&!d?{animationId:s.which==="dalek"&&e.color.shade==="dimmed"&&(e.planet==="blacktooth"||e.planet==="egyptus"||e.planet==="moonbase")?"dalek.dark":s.which,spritesheetVariant:h,paused:t,randomiseStartFrame:c}:{textureId:`${s.which}.1`,spritesheetVariant:h}),renderProps:p};case"bubbleRobot":return{output:Me({top:{animationId:"bubbles.blueGreen",randomiseStartFrame:c,paused:t,spritesheetVariant:h},bottom:{textureId:"headlessBase",spritesheetVariant:h}}),renderProps:p};case"emperorsGuardian":return{output:Me({top:{textureId:"ball",spritesheetVariant:h},bottom:{animationId:"bubbles.cold",spritesheetVariant:h,paused:t}}),renderProps:p};case"emperor":return{output:y({animationId:"bubbles.cold",spritesheetVariant:h,paused:t}),renderProps:p};default:throw new Error(`unexpected monster ${s}`)}break}default:throw new Error(`unexpected monster ${s}`)}},fd=r=>{const{gameTime:e,lastDiedAt:t}=r.type==="headOverHeels"?r.state.head:r.state;return e-t<Mi},Ht=r=>{if(r===void 0)return 0;const{shieldCollectedAt:e,gameTime:t}=r;return e!==null&&e+Kr>t?100-Math.ceil((t-e)/(Kr/100)):0},md=r=>r.type==="headOverHeels"?Ht(r.state.head)>0||Ht(r.state.heels)>0:Ht(r.state)>0;var gd=`#version 300 es
precision lowp float;in vec2 vTextureCoord;out vec4 finalColor;uniform sampler2D uTexture;uniform vec3 uColour;void main(void){vec4 c=texture(uTexture,vTextureCoord);finalColor=mix(c,vec4(uColour,1),c.a);}`;const xd=we.from({vertex:ve,fragment:gd,name:"oneColour-filter"});class mr extends ye{constructor(e){super({glProgram:xd,resources:{colorReplaceUniforms:{uColour:{value:new Float32Array(3),type:"vec3<f32>"}}}});const t=this.resources.colorReplaceUniforms.uniforms,[o,n,s]=e.toArray();t.uColour[0]=o,t.uColour[1]=n,t.uColour[2]=s}}const gr=.02,yd=({name:r,action:e,facingXy8:t,teleportingPhase:o,gravityZ:n,paused:s,spritesheetVariant:i})=>{if(e==="death")return{animationId:`${r}.fadeOut`,paused:s,spritesheetVariant:i};if(o==="out")return{animationId:`${r}.fadeOut`,paused:s,spritesheetVariant:i};if(o==="in")return{animationId:`${r}.fadeOut`,paused:s,spritesheetVariant:i};if(e==="moving")return{animationId:`${r}.walking.${t}`,paused:s,spritesheetVariant:i};if(e==="jumping")return{textureId:n<gr?`${r}.walking.${t}.2`:`${r}.walking.${t}.1`,spritesheetVariant:i};if(e==="falling"){const a=`${r}.falling.${t}`;if(kn(a))return{textureId:a,spritesheetVariant:i}}const c=`${r}.idle.${t}`;return $r(c)?{animationId:c,paused:s,spritesheetVariant:i}:{textureId:`${r}.walking.${t}.2`,spritesheetVariant:i}},xr=Symbol(),ps=Symbol(),wd=(r,e)=>{r[xr].removeChildren(),r[xr].addChild(y(yd(e)))},Wt=(r,e,t,o,n)=>{const s=new v,i=new v;s[xr]=i,s.addChild(i);const c=y({animationId:e?`shine.${r}InSymbio`:`shine.${r}`,paused:t,flipX:r==="heels",spritesheetVariant:o?"for-current-room":"uncolourised"});s.addChild(c),s[ps]=c,s.filters=[new ne({color:n?Re(n):xt(To[r])}),new ne({color:n?Re(n):xt("midRed")}),new mr(n?Re(n):xt(To[r]))];for(const a of s.filters)a.enabled=!1;return s},Go=({gameTime:r,switchedToAt:e},t,o)=>(t==="headOverHeels"||t===o)&&e+Pi>r,vd=r=>{if(!fd(r))return!1;const{gameTime:e,lastDiedAt:t}=r.type==="headOverHeels"?r.state.head:r.state;return(e-t)%Qr<Qr*Ri},bd=({highlighted:r,flashing:e,shining:t},o)=>{const[n,s,i]=o.filters;n.enabled=r,s.enabled=!r&&t,i.enabled=e},Cd=(r,e)=>{r[ps].visible=e},Xt=(r,e,t,o,n,s)=>{t&&wd(e,{name:r,...o,paused:n,spritesheetVariant:s}),bd(o,e),Cd(e,o.shining)},Sd=({renderContext:{item:r,general:{gameState:e,paused:t,colourised:o},room:n},currentRendering:s})=>{const{type:i,state:{action:c,facing:a,visualFacingVector:l,teleporting:d,vels:{gravity:{z:h}}}}=r,u=s?.renderProps,p=s?.output,f=Ir(l??a)??"towards",m=e!==void 0&&(r.type==="headOverHeels"?Go(r.state.head,"headOverHeels","headOverHeels"):Go(r.state,r.type,e.currentCharacterName)),x=vd(r),w=md(r),S=Sr(a),b=d?.phase??null,k={action:c,facingXy8:f,teleportingPhase:b,flashing:x,highlighted:m,shining:w,gravityZ:h},E=u===void 0||u.action!==c||u.facingXy8!==f||u.teleportingPhase!==b||u?.gravityZ>gr!=h>gr;let A;const I=o?"for-current-room":"uncolourised",U=o?void 0:n.color;if(i==="headOverHeels"){A=p??Ol({top:Wt("head",!0,t,o,U),bottom:Wt("heels",!0,t,o,U)});const G=A;Xt("head",G[Tt],E,k,t,I),Xt("heels",G[Hr],E,k,t,I)}else A=p??Wt(i,!1,t,o,U),Xt(i,A,E,k,t,I);return c==="moving"&&p instanceof X&&(p.animationSpeed=S*Ws),{output:A,renderProps:k}},Nt=Ke(Sd),qt=(r,e,t,o,n)=>{const s=`${r}.idle.${e}`,i=n?"sceneryPlayer":"uncolourised";return $r(s)?{animationId:s,randomiseStartFrame:t,paused:o,spritesheetVariant:i}:{textureId:`${r}.walking.${e}.2`,spritesheetVariant:i}},Id=({renderContext:{item:{id:r,config:{which:e,startDirection:t}},general:{paused:o,colourised:n}},currentRendering:s})=>s?.renderProps===void 0?{output:e==="headOverHeels"?Me({top:qt("head",t,r,o,n),bottom:qt("heels",t,r,o,n)}):y(qt(e,t,r,o,n)),renderProps:me}:"no-update",kd=({renderContext:{item:{state:{vels:{sliding:r}},config:{startingPhase:e}},general:{paused:t,colourised:o}},tickContext:{deltaMS:n},currentRendering:s})=>{const c=(s?.renderProps?.distanceTravelled??0)+br(r)*(t?0:n),a=s?.output,l=o?"for-current-room":"uncolourised",d=a??y({textureId:"spikyBall.1",spritesheetVariant:l}),u=(Math.floor(c*2/ht.w)+e)%2+1;return d.texture=Xe(l).textures[`spikyBall.${u}`],{output:d,renderProps:{distanceTravelled:c}}},Td=Ke(kd),fs=r=>({renderContext:{item:{state:{stoodOnBy:e,stoodOnUntilRoomTime:t}},general:{paused:o,colourised:n}},tickContext:{lastRenderRoomTime:s},currentRendering:i})=>{const c=i?.renderProps,a=Ze(e);let l;return i?.output?l=i?.output:(l=y({animationId:r?"shadowMask.spring.bounce":"spring.bounce",paused:o,spritesheetVariant:n?"for-current-room":"uncolourised"}),l.loop=!1,l.gotoAndStop(0)),s!==void 0&&t>s&&!a&&!o?l.gotoAndPlay(0):a!==(c?.compressed??!1)&&(a?l.gotoAndStop(1):l.gotoAndStop(0)),{output:l,renderProps:{compressed:a}}},Md=Ke(fs(!1)),Pd=Ke(fs(!0)),Rd=r=>{const{gameMenus:e}=C.getState();try{return ln(e,r.path)?"right":"left"}catch(t){throw new Error(`Error getting switch setting from store for switch with path "${r.path}"

while store has: ${JSON.stringify(e,null,2)}`,{cause:t})}},Ad=({renderContext:{item:{state:{setting:r},config:e},general:{colourised:t}},currentRendering:o})=>{const n=o?.renderProps,s=e.type==="in-store"?Rd(e):r;return n===void 0||s!==n.setting?{output:y({textureId:`switch.${s}`,spritesheetVariant:t?"for-current-room":"uncolourised"}),renderProps:{setting:s}}:"no-update"},_d=({renderContext:{item:r,room:e,general:{paused:t,colourised:o}},currentRendering:n})=>{const{state:{stoodOnBy:s},config:{times:i}}=r,c=n?.renderProps,a=Lr(r),l=a&&Ye(s,e).some(zr);if(!(c===void 0||a!==c.activated||l!==c.flashing))return"no-update";const h=o?"for-current-room":"uncolourised";return{output:y(l?{animationId:"teleporter.flashing",times:i,paused:t,spritesheetVariant:h}:{textureId:a?"teleporter":"block.artificial",times:i,spritesheetVariant:h}),renderProps:{flashing:l,activated:a}}},Od=({state:{stoodOnBy:r,position:e},config:{times:t}},o)=>{const n=new Array(t?.x??1).fill(null).map(()=>new Array(t?.y??1));return Ye(r,o).filter(Cn).forEach(({id:s,state:{position:i}})=>{const c=re(i,e),a={x:Math.floor(c.x/R.x),y:Math.floor(c.y/R.y)};a.x<0||a.x>=(t?.x??1)||a.y<0||a.y>=(t?.y??1)||(n[a.x][a.y]=s)}),n},zd=(r,e)=>{let t=0,o=1;for(const n of e)for(const s of n)s!==void 0&&r.items[s]?.state.activated&&(t|=o),o<<=1;return t},Bd=({renderContext:{item:r,room:e,general:{pixiRenderer:t,colourised:o}},currentRendering:n})=>{const{config:{times:s}}=r,i=n===void 0?Od(r,e):n.renderProps.chargePositions,c=zd(e,i);if(!(c!==n?.renderProps.cybermanActivationBitmask))return"no-update";const l=y({subSpriteVariations(h,u){const p=i[h][u];return p===void 0?{animationId:"toaster.off"}:e.items[p]?.state.everActivated?{animationId:"toaster.off"}:{textureId:"toaster.on"}},times:s??me,spritesheetVariant:o?"for-current-room":"uncolourised"});return{output:Gr(t,l,"toaster.off"),renderProps:{chargePositions:i,cybermanActivationBitmask:c}}},Ed=(r,e,t,o)=>`${r}${o?".dark":""}.wall.${e}.${t}`,$d=z(({renderContext:{general:{pixiRenderer:r,colourised:e},item:{id:t,config:o},room:n}})=>{if(o.direction==="right"||o.direction==="towards")throw new Error(`wall is near: ${t}`);const{direction:s,tiles:i}=o,c=Ne(oe(s)),a=new v({label:"wallTiles"}),l=new v({label:"wallAnimations"});for(let h=0;h<o.tiles.length;h++){const u=xe({[c]:h});if(a.addChild(y({textureId:Ed(n.planet,i[h],s,n.color.shade==="dimmed"),...u,pivot:s==="away"?{x:ht.w,y:ht.h}:{x:0,y:ht.h},spritesheetVariant:e?"for-current-room":"uncolourised"})),n.planet==="moonbase"){const p=`moonbase.wall.screen.${i[h]}.away`;$r(p)&&l.addChild(y({animationId:p,randomiseStartFrame:`${t}${h}`,flipX:s==="left",x:u.x+(s==="away"?-8:8),y:u.y-23,spritesheetVariant:e?"for-current-room":"uncolourised"}))}}const d=new v({label:"wallAppearance"});return d.addChild(W(r,a)),l.children.length>0&&d.addChild(l),d}),Fd={head:Nt,heels:Nt,headOverHeels:Nt,doorFrame:Wl,doorLegs:Hl,monster:pd,floatingText:Jl,barrier:z(({renderContext:{item:{config:{axis:r,times:e,disappearing:t}},general:{colourised:o,pixiRenderer:n}}})=>Oe(n,y({textureId:`barrier.${r}${t?".disappearing":""}`,times:e,spritesheetVariant:o?"for-current-room":"uncolourised"}))),deadlyBlock:z(({renderContext:{item:{config:r,id:e},general:{paused:t,colourised:o,pixiRenderer:n}}})=>{switch(r.style){case"volcano":{const s=y({animationId:"volcano",times:r.times,randomiseStartFrame:e,paused:t,spritesheetVariant:o?"for-current-room":"uncolourised"});return Gr(n,s,"volcano")}case"toaster":throw new Error("use the special toaster appearance instead");default:throw r.style,new Error("unknown deadly block style")}}),spikes:Se("spikes"),slidingDeadly:Td,slidingBlock:z(({renderContext:{item:{config:{style:r}},general:{colourised:e}}})=>{const t=e?"for-current-room":"uncolourised";return y(r==="book"?{textureId:"book.y",spritesheetVariant:t}:{textureId:r,spritesheetVariant:t})}),block:Al,switch:Ad,button:_l,conveyor:jl,lift:z(({renderContext:{general:{paused:r,colourised:e}}})=>{const t=new v,o=e?"for-current-room":"uncolourised",n={x:Yr.w/2,y:Yr.h};return t.addChild(y({animationId:"lift",pivot:n,paused:r,spritesheetVariant:o})),t.addChild(y({textureId:"lift.static",pivot:n,spritesheetVariant:o})),t}),teleporter:_d,sceneryCrown:z(({renderContext:{item:{config:{planet:r}},general:{colourised:e}}})=>y({textureId:`crown.${r}`,spritesheetVariant:e?"for-current-room":"uncolourised"})),pickup:z(({renderContext:{item:{config:r},general:{paused:e,colourised:t}}})=>{const o=t?"for-current-room":"uncolourised";if(r.gives==="crown")return y({textureId:`crown.${r.planet}`,spritesheetVariant:o});const s={shield:{textureId:"whiteRabbit",spritesheetVariant:o},jumps:{textureId:"whiteRabbit",spritesheetVariant:o},fast:{textureId:"whiteRabbit",spritesheetVariant:o},"extra-life":{textureId:"whiteRabbit",spritesheetVariant:o},bag:{textureId:"bag",spritesheetVariant:o},doughnuts:{textureId:"doughnuts",spritesheetVariant:o},hooter:{textureId:"hooter",spritesheetVariant:o},scroll:{textureId:"scroll",spritesheetVariant:o},reincarnation:{animationId:"fish",paused:e,spritesheetVariant:o}}[r.gives];return y(s)}),moveableDeadly:Se("fish.1"),charles:zl,joystick:ad,movingPlatform:Se("sandwich"),pushableBlock:Se("stepStool"),portableBlock:z(({renderContext:{item:{config:{style:r}},general:{colourised:e}}})=>y({textureId:r,spritesheetVariant:e?"for-current-room":"uncolourised"})),spring:Md,sceneryPlayer:Id,hushPuppy:Se("hushPuppy"),bubbles:z(({renderContext:{item:{id:r,config:{style:e}},general:{paused:t,colourised:o}}})=>y({animationId:`bubbles.bounce.${e}`,paused:t,randomiseStartFrame:r,spritesheetVariant:o?"for-current-room":"uncolourised"})),firedDoughnut:Vl({animationId:"bubbles.doughnut"}),ball:Se("ball"),floor:nd,particle:z(({renderContext:{item:{config:{forCharacter:r}},general:{paused:e,colourised:t}}})=>y({animationId:`particle.${r==="head"?"head":"heels"}.fade`,anchor:{x:.5,y:.5},paused:e,spritesheetVariant:t?"for-current-room":"uncolourised"}))},Ld=r=>{if(r.type==="wall"){const{direction:e}=r.config;return e==="right"||e==="towards"?void 0:$d}return r.type==="deadlyBlock"&&r.config.style==="toaster"?Bd:Fd[r.type]};class Dd{constructor(e,t){this.renderContext=t,this.#e=e,this.#r.addChild(...e.map(o=>o.output))}#e;#r=new v({label:"CompositeRenderer"});tick(e){for(const t of this.#e)t.tick(e)}destroy(){for(const e of this.#e)e.destroy()}get output(){return this.#r}}var jd=`#version 300 es
precision lowp float;in vec2 vTextureCoord;out vec4 finalColor;uniform sampler2D uTexture;uniform vec3 uTargetColor;const float blackThreshold=sqrt(3.0)*0.1;void main(void){vec4 c=texture(uTexture,vTextureCoord);float isBlack=step(length(c.rgb),blackThreshold);finalColor=mix(vec4(uTargetColor,1),c,max(isBlack,1.0-c.a));}`;const Vd=we.from({vertex:ve,fragment:jd,name:"revert-colourise-filter"});class Ud extends ye{uniforms;constructor(e="white"){super({glProgram:Vd,resources:{colorReplaceUniforms:{uTargetColor:{value:new Float32Array(3),type:"vec3<f32>"}}}}),this.uniforms=this.resources.colorReplaceUniforms.uniforms,this.targetColor=e}set targetColor(e){const[t,o,n]=new Pe(e).toArray();this.uniforms.uTargetColor[0]=t,this.uniforms.uTargetColor[1]=o,this.uniforms.uTargetColor[2]=n}}const Gd=fe,Hd=g.pastelBlue,Ho=Pt.highlightBeige,Wd=g.lightBeige,Xd=Pt.lightBeige,Wo=Pt.midRed,Nd=Pt.white,Xo=new Ud(Hd),Zt=g.white,No=g.midRed,qd=g.pastelBlue,qo={left:"",away:"",right:"",towards:""},Zo=r=>r.type==="switch"&&r.config.type==="in-room"||r.type==="button",Yo=(r,e)=>{switch(r){case"back-forth":switch(e){case"left":return"";case"right":return"";case"away":return"";case"towards":return"";default:throw new Error("Unexpected startDirection")}case"forwards":switch(e){case"left":return"";case"right":return"";case"away":return"";case"towards":return"";default:throw new Error("Unexpected startDirection")}case"clockwise":switch(e){case"left":return"";case"right":return"";case"away":return"";case"towards":return"";default:throw new Error("Unexpected startDirection")}case"towards-analogue":return"."}return""},Zd=r=>r.type==="monster"&&r.config.activated==="after-player-near";class Yd{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output),this.#e()}output=new v({label:"EditorAnnotationsRenderer"});#e(){const e=this.renderContext.item;switch(e.type){case"pickup":if(e.config.gives==="shield"||e.config.gives==="extra-life"||e.config.gives==="jumps"||e.config.gives==="fast"){const t={shield:"",jumps:"",fast:"","extra-life":"+2"};this.#r({annotationText:t[e.config.gives],yAdj:-16})}break;case"doorFrame":if(e.config.part==="near"){const{rooms:t}=C.getState().levelEditor.campaignInProgress,{config:{toRoom:o,direction:n}}=e;if(o!==Ai){const s=!!t[o],i=qo[n],c=n==="away"||n==="right"?`${o}${i}`:`${i}${o}`;this.#r({annotationText:c,yAdj:n==="left"||n==="away"?-48:0,tint:s?Zt:No,clickDispatch:s?()=>nr(o):void 0})}}break;case"teleporter":{const{rooms:t}=C.getState().levelEditor.campaignInProgress,{config:{toRoom:o}}=e,n=!!t[o];this.#r({annotationText:`${o}`,yAdj:-12,tint:n?Zt:No,clickDispatch:n?()=>nr(o):void 0})}break;case"conveyor":{const{config:{direction:t}}=e,o=qo[t];this.#r({annotationText:o,yAdj:-12})}break;case"movingPlatform":{const{config:{movement:t,startDirection:o}}=e;this.#r({annotationText:Yo(t,o),yAdj:-12})}break;case"monster":{const{config:t}=e;switch(!0){case(t.which==="cyberman"&&t.activated==="after-player-near"):this.#r({annotationText:"wake",tint:Wd,yAdj:-12});break;case(t.which==="turtle"||t.which==="skiHead"):this.#r({annotationText:Yo(t.movement,t.startDirection),yAdj:-12});break}}break}}#r({annotationText:e,yAdj:t=0,tint:o=Zt,clickDispatch:n}){const{renderContext:{frontLayer:s,general:{pixiRenderer:i}}}=this,c=new hs({pixiRenderer:i,label:"EditorAnnotationTextContainer",outline:!0,tint:o,text:e,y:t});n!==void 0&&(c.eventMode="static",c.on("click",()=>{C.dispatch(n())}),c.on("mouseover",()=>{C.getState().levelEditor.tool.type==="pointer"&&(C.dispatch(eo(!0)),c.tint=qd)}),c.on("mouseout",()=>{C.dispatch(eo(!1)),c.tint=o}),c.cursor="pointer"),this.output.addChild(c),s.attach(c)}tick(e){this.#t(),this.childRenderer.tick(e)}#t(){const{renderContext:{room:e}}=this,t=this.renderContext.item,{clickableAnnotationHovered:o}=C.getState().levelEditor,{jsonItemId:n}=t,s=C.getState(),i=pn(s),c=_i(s),a=je(s),l=n&&i?.jsonItemId===n&&!o,d=n&&c.includes(n),h=()=>n!==void 0&&(ee(e.items).some(u=>u.jsonItemId===i?.jsonItemId&&Zo(u)&&u.config.modifies.some(p=>p.expectType===t.type&&(p.targets===void 0||p.targets.includes(n))))||Zo(t)&&ee(e.items).some(({jsonItemId:u,type:p})=>u!==void 0&&u===i?.jsonItemId&&t.config.modifies.some(f=>f.expectType===p&&(f.targets===void 0||f.targets.includes(u))))||t.type==="charles"&&ee(e.items).some(u=>u.jsonItemId===i?.jsonItemId&&u.type==="joystick"&&u.config.controls.some(p=>p===n))||t.type==="joystick"&&t.config.controls.some(u=>i?.jsonItemId===u));this.output.filters=l&&d?[Xo,a.type==="eyeDropper"?Wo:Ho]:l?a.type==="eyeDropper"?Wo:Ho:d?Xo:h()?Nd:Zd(t)?Xd:Gd}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const Jd=(r,e,t)=>e.general.editor?new Yd(e,t):t,yr=r=>{if(r instanceof V){const{texture:e}=r;e instanceof ge&&e.destroy(!0)}for(const e of r.children)yr(e)};class Kd{constructor(e,t){this.renderContext=e,this.appearance=t}#e;output=new v({label:"AppearanceRenderer"});destroy(){this.#e?.output&&yr(this.#e.output),this.output.destroy({children:!0})}tick(e){const t=this.appearance({renderContext:this.renderContext,currentRendering:this.#e,tickContext:e});t!=="no-update"&&(this.output.children.at(0)!==t.output&&(this.#e?.output&&(this.output.removeChild(this.#e.output),yr(this.#e.output),this.#e.output.destroy({texture:!1,children:!0})),t.output!==void 0&&this.output.addChild(t.output)),this.#e=t)}}class ms extends Kd{}const Jo=(r,e)=>{e.poly([M({}),M({x:r.x}),M({x:r.x,y:r.y}),M({y:r.y})]).poly([M({}),M({z:r.z}),M({y:r.y,z:r.z}),M({y:r.y})]).poly([M({x:r.x}),M({x:r.x,z:r.z}),M(r),M({x:r.x,y:r.y})]).poly([M({z:r.z}),M({x:r.x,z:r.z}),M({x:r.x,y:r.y,z:r.z}),M({y:r.y,z:r.z})])},Ko=(r,e)=>{const t=new Z;return Jo(r,t),t.stroke({width:.5,color:e,alpha:1}),t.eventMode="static",t.on("pointerenter",()=>{t.fill({color:e,alpha:.5})}),t.on("pointerleave",()=>{t.clear(),Jo(r,t),t.stroke({width:.5,color:e,alpha:1})}),t},Qd={head:"rgba(255,184,0)",wall:"rgba(128,200,0)",portal:"rgba(255,0,255)",pickup:"rgba(0,196,255)",emitter:"rgba(0,255,255)",stopAutowalk:"rgba(255,128,128)",floatingText:"rgba(128,0,255)"};class eu{constructor(e){this.renderContext=e;const{item:t}=e,o=Qd[t.type]??"rgba(255,255,255)";if(this.#e=new v({label:`ItemBoundingBoxRenderer ${t.id}`}),Oi("portal")(t)){const s=M(t.config.relativePoint);this.#e.addChild(new Z().circle(s.x,s.y,5).stroke(o)),this.#e.addChild(new Z().circle(s.x,s.y,2).fill(o))}if(this.#e.addChild(new Z({label:"objectOrigin"}).circle(0,0,2).fill(o)),this.#e.addChild(Ko(t.aabb,o)),t.renderAabb){const s="rgba(184, 184, 255)",i=Ko(t.renderAabb,s);if(t.renderAabbOffset){const c=M(t.renderAabbOffset);i.position.set(c.x,c.y),i.circle(0,0,2).fill(s)}this.#e.addChild(i)}this.#e.eventMode="static";let n;this.#e.on("pointerenter",()=>{if(n!==void 0)return;const s=`${t.id} ${t.type}
@(${t.state.position.x}, ${t.state.position.y}, ${t.state.position.z})}
#(${t.aabb.x}, ${t.aabb.y}, ${t.aabb.z})}`;this.#e.addChild(n=new ma({text:s,style:{fill:o,fontSize:6,fontFamily:"Menlo"}})),n.resolution=4}),this.#e.on("pointerleave",()=>{n!==void 0&&(this.#e.removeChild(n),n=void 0)}),e.frontLayer.attach(this.#e)}#e;tick(){}destroy(){this.#e.destroy({children:!0})}get output(){return this.#e}}const tu=75;class ru{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output);const o=e.room.color.shade==="dimmed"?kt:g;this.#e=new mr(o.moss),this.#r=new mr(o.midRed),this.#t=new ne({color:o.pureBlack}),this.#e.enabled=!1,this.#r.enabled=!1,this.#t.enabled=!1,this.output.filters=[this.#e,this.#r,this.#t]}output=new v({label:"ItemFlashOnSwitchedRenderer"});#e;#r;#t;tick(e){const{renderContext:{item:{state:{switchedAtRoomTime:t,switchedSetting:o}},room:{roomTime:n}}}=this,s=n-t<tu,i=o==="left";this.#e.enabled=s&&i,this.#r.enabled=s&&!i,this.#t.enabled=s,this.childRenderer.tick(e)}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const ou=(r,e)=>{const{item:t,room:{items:o}}=r;return ee(o).filter(zi).some(({config:{modifies:s}})=>s.some(i=>i.targets===void 0?i.expectType===t.type:i.targets.includes(t.id)))?new ru(r,e):e},nu=(r,e,t,o)=>{const n=1/o;r.x=Fo(e,n),r.y=Fo(t,n)},gs=new da;gs.matrix=[0,0,0,1,0,0,.3,0,0,0,0,0,.3,0,0,0,0,0,1,0];class su{constructor(e,t){this.renderContext=e,this.wrappedRenderer=t,this.output=new v({label:`ItemPositionRenderer ${e.item.id}`,children:[t.output]}),this.#r()}output;#e=new Map;#r(){const{general:{upscale:{gameEngineUpscale:e}}}=this.renderContext,t=M(this.renderContext.item.state.position);nu(this.output,t.x,t.y,e)}tick(e){this.wrappedRenderer?.tick(e),e.movedItems.has(this.renderContext.item)&&this.#r(),this.#s()}#t(){const e=this.renderContext.item.id,t=this.renderContext.zEdges.get(e);if(!t)return er;let o;for(const[n,s]of t)s&&(o||(o=new Set),o.add(n));return o??er}#o(e,t){const o=new v({label:`maskWith: ${e}`,children:[t,this.output.children[0]]});return this.output.addChild(o),o.setMask({mask:t,inverse:!0}),this.#e.set(e,o),o}#n(e,t){const[o,n]=t.children,s=t.parent;s.removeChild(t),s.addChild(n),t.mask=null,o.destroy(),t.destroy(),this.#e.delete(e)}#s(){const{pixiRenderer:e}=this.renderContext.general,t=this.#t();for(const o of this.#e.keys())if(!t.has(o)){const n=this.#e.get(o);if(n)try{this.#n(o,n)}catch(s){throw new Error(`error while destroying masking container ${bt(n)} 
              for our rendering: ${bt(this.output)}`,{cause:s})}}for(const o of t){const n=this.#e.get(o),s=n?.children[0],i=this.renderContext.getItemRenderPipeline(o)?.itemAppearanceRenderer?.output;if(i===void 0)throw new Error("nothing to use as a mask");const c=i.filters;i.filters=gs;const a=W(e,i,s,`red mask: ${o}`);i.filters=c,n===void 0&&this.#o(o,a);const l=this.renderContext.room.items[o],d=re(M(l.state.position),M(this.renderContext.item.state.position));a.x=d.x,a.y=d.y}}destroy(){this.output.destroy({children:!0}),this.wrappedRenderer?.destroy()}}const Yt=(r,e=1)=>({renderContext:{item:{state:{facing:t}}},currentRendering:o})=>{const n=o?.renderProps,s=Tr(t)??"towards";if(!(n===void 0||s!==n.facingXy4))return"no-update";const c=y({textureId:s==="left"||s==="away"?`shadowMask.${r}.away`:`shadowMask.${r}.right`,spritesheetVariant:"original"});return c.y=-(R.z*(e-1)),c.scale.x=s==="away"||s==="right"?1:-1,{output:c,renderProps:{facingXy4:s}}},iu={left:"away",towardsLeft:"awayRight",towards:"right"},au=(r,e,t)=>{if(!e)return`shadowMask.${r}.${t}`;const o=`shadowMask.${r}.falling.${t}`;return kn(o)?o:`shadowMask.${r}.${t}`},Jt=(r,e=1)=>({renderContext:{item:{state:{visualFacingVector:t,facing:o,action:n}}},currentRendering:s})=>{const i=s?.renderProps,c=Ir(t??o)??"towards",a=n==="falling";if(!(i===void 0||c!==i.facingXy8||a!==i.falling))return"no-update";const d=iu[c],u=au(r,a,d??c),p=y({textureId:u,spritesheetVariant:"original"});return p.y=-(R.z*(e-1)),p.scale.x=d===void 0?1:-1,{output:p,renderProps:{facingXy8:c,falling:a}}},cu=({renderContext:{general:{pixiRenderer:r},item:e,room:t},currentRendering:o})=>{const{state:{stoodOnBy:n},config:{times:s}}=e,i=o?.renderProps,c=Lr(e),a=c&&Ye(n,t).find(zr)!==void 0;return i===void 0||c!==i.activated||a!==i.flashing?{output:Oe(r,Mt({textureId:a?"shadowMask.teleporter.flashing":c?"shadowMask.teleporter":"shadowMask.artificial",spritesheetVariant:"original"},s)),renderProps:{flashing:a,activated:c}}:"no-update"},Qo={lift:j({textureId:"shadowMask.smallBlock",spritesheetVariant:"original"}),conveyor:Q(({direction:r})=>({textureId:"shadowMask.conveyor",flipX:oe(r)==="x",spritesheetVariant:"original"})),doorLegs:Q(({direction:r})=>({textureId:r==="right"||r==="towards"?"shadowMask.door.floatingThreshold.double.y":"shadowMask.door.legs.threshold.double.y",flipX:oe(r)==="y",spritesheetVariant:"original"})),teleporter:cu,floor:"no-mask",barrier:Q(({axis:r})=>({textureId:"shadowMask.barrier.y",flipX:r==="x",y:-1,spritesheetVariant:"original"})),spring:Pd,block:Q(({style:r})=>({textureId:`shadowMask.${r}`,spritesheetVariant:"original"})),pushableBlock:j({textureId:"shadowMask.stepStool",spritesheetVariant:"original"}),movingPlatform:j({textureId:"shadowMask.sandwich",spritesheetVariant:"original"}),hushPuppy:j({textureId:"shadowMask.hushPuppy",spritesheetVariant:"original"}),portableBlock:Q(({style:r})=>({textureId:r==="drum"?"shadowMask.drum":"shadowMask.smallBlock",spritesheetVariant:"original"})),slidingBlock:Q(({style:r})=>r==="book"?{textureId:"shadowMask.book",flipX:!0,spritesheetVariant:"original"}:{textureId:"shadowMask.smallRound",spritesheetVariant:"original"}),deadlyBlock:Q(({style:r})=>({textureId:r==="volcano"?"shadowMask.volcano":"shadowMask.toaster",spritesheetVariant:"original"})),spikes:j({textureId:"shadowMask.spikes",spritesheetVariant:"original"}),switch:j({textureId:"shadowMask.switch",spritesheetVariant:"original"}),button:j({textureId:"shadowMask.buttonInGame",spritesheetVariant:"original"}),pickup:Q(({gives:r})=>{switch(r){case"scroll":return{textureId:"shadowMask.scroll",spritesheetVariant:"original"};case"doughnuts":return{textureId:"shadowMask.doughnuts",spritesheetVariant:"original"};case"fast":case"extra-life":case"jumps":case"shield":return{textureId:"shadowMask.whiteRabbit",spritesheetVariant:"original"};default:return{textureId:"blank",spritesheetVariant:"original"}}}),slidingDeadly:j({textureId:"shadowMask.smallRound",spritesheetVariant:"original"}),ball:j({textureId:"shadowMask.ball",spritesheetVariant:"original"}),"monster.dalek":j({textureId:"shadowMask.dalek",spritesheetVariant:"original"}),"monster.turtle":Yt("turtle"),"monster.skiHead":Yt("skiHead"),"monster.homingBot":j({textureId:"shadowMask.smallRound",spritesheetVariant:"original"}),joystick:j({textureId:"shadowMask.joystick",spritesheetVariant:"original"}),charles:Yt("charles",2),head:Jt("head"),heels:Jt("heels"),headOverHeels:Jt("head",2)},lu=r=>{switch(r.type){case"monster":return Qo[`monster.${r.config.which}`];case"floor":return r.config.floorType==="none"?void 0:"no-mask";default:return Qo[r.type]}},du=.66,uu=r=>r.shadowCastTexture!==void 0,Ie={id:"spaceAbove",state:{position:{x:0,y:0,z:0}},aabb:{x:0,y:0,z:Ei}};class hu{constructor(e,t){this.renderContext=e,this.appearance=t,this.#e.addChild(this.#r),this.#n||(this.#e.filters=new ca({alpha:du}))}#e=new v({label:"ItemShadowRenderer"});#r=new v({label:"shadows"});#t;#o=new Map;initShadowMaskRenderer(){const{renderContext:e,appearance:t}=this;if(t!=="no-mask")if(this.#t=new ms(e,t),e.item.shadowOffset===void 0)this.#e.addChild(this.#t.output);else{const o=new v({label:"shadowMaskOffset",children:[this.#t.output],...M(e.item.shadowOffset)});this.#e.addChild(o)}}get#n(){return C.getState().gameMenus.userSettings.displaySettings.showShadowMasks}#s(e){if(this.#t===void 0)return;const t=this.#t.output.children.at(0);this.#t.tick(e);const o=this.#t.output.children.at(0);if(o===void 0||!(o instanceof V)){const{item:n}=this.renderContext;throw new Error(`ItemShadowRenderer: this.#shadowMaskRenderer didn't create a sprite for item "${n.id}" of type "${n.type}". Have got ${o}`)}t!==o&&(this.#n?this.renderContext.frontLayer.attach(o):this.#e.mask=o)}destroy(){this.#e.destroy(!0),this.#t?.destroy();for(const e of Object.values(this.#o))e.sprite.destroy()}tick(e){const{movedItems:t}=e,{item:o,general:{pixiRenderer:n},room:s}=this.renderContext,i=t.has(o),c=o.state.position.z+o.aabb.z;Ie.state.position.x=o.state.position.x,Ie.state.position.y=o.state.position.y,Ie.state.position.z=c,Ie.aabb.x=o.aabb.x,Ie.aabb.y=o.aabb.y;const a=new Set(Bi(Ie,s[Sn],d=>d!==o&&uu(d)&&(d.castsShadowWhileStoodOn||d.state.position.z>o.state.position.z+o.aabb.z)&&!d.noShadowCastOn?.includes(o.type)));let l=!1;for(const[d,h]of this.#o)a.has(d)||(this.#r.removeChild(h),h.destroy(),this.#o.delete(d));for(const d of a){l=!0;let h=this.#o.get(d),u=!1;if(!h){const{times:p}=d.config,{shadowCastTexture:f}=d,m=Mt(typeof f=="string"?{textureId:f}:f,p);h=Oe(n,m),h.label=d.id,this.#r.addChild(h),this.#o.set(d,h),u=!0}if(u||i||t.has(d)){const p=M({...Ve(re(d.state.position,o.state.position),d.shadowOffset??pe),z:o.aabb.z});h.x=p.x,h.y=p.y}}this.#e.visible=l,l?(this.#t===void 0&&this.initShadowMaskRenderer(),this.#s(e)):this.#t!==void 0&&(this.#t.destroy(),this.#t=void 0)}get output(){return this.#e}}const pu=r=>{const e=lu(r.item);return e===void 0?void 0:new hu(r,e)};class fu{constructor(e,t){this.renderContext=e,this.componentRenderers=t,this.output={graphics:t.graphics?.output,sound:t.sound?.output}}output;tick(e){this.componentRenderers.graphics?.tick(e),this.componentRenderers.sound?.tick(e)}destroy(){this.componentRenderers.graphics?.destroy(),this.componentRenderers.sound?.destroy()}}class mu{constructor(e,t){this.renderContext=e,this.childRenderer=t,this.output.addChild(t.output);const{general:{colourised:o},room:n}=e;this.#e=new ne({color:o?(n.color.shade==="dimmed"?kt:g).moss:Re(n.color)}),this.#e.enabled=!1,this.output.filters=this.#e}output=new v({label:"PortableItemPickUpNextHighlightRenderer"});#e;tick(e){const{wouldPickUpNext:t}=this.renderContext.item.state;this.#e.enabled=t,this.childRenderer.tick(e)}destroy(){this.output.destroy(),this.childRenderer.destroy()}}const gu=(r,e,t)=>$i(r)?new mu(e,t):t,xu=(r,e)=>{e!==void 0&&C.getState().gameMenus.cheatsOn&&(e.eventMode="static",e.on("pointertap",()=>{C.dispatch(qs({item:r,pixiContainer:e}))}))},yu=r=>{const e=C.getState(),t=Xs(e),o=!Ns(e),{general:{paused:n}}=r,{item:s}=r,i=t==="all"||t==="non-wall"&&r.item.type!=="wall",c=[],a=Ld(s);let l;if(a!==void 0){l=new ms(r,a);const f=ou(r,l);c.push(Jd(s,r,gu(s,r,f)))}if(o&&!n){const f=pu(r);f!==void 0&&c.push(f)}i&&c.push(new eu(r));let d;if(c.length===0)d=void 0;else{const f=c.length===1?c[0]:new Dd(c,r);d=new su(r,f),xu(s,d.output)}const h=r.general.soundSettings.mute??kr.soundSettings.mute,u=n||h?void 0:Rc(r),p=u===void 0?void 0:new Ec(r,u);return{top:new fu(r,{graphics:d,sound:p}),itemAppearanceRenderer:l}};class wu{constructor(e){this.renderContext=e;const{general:{colourised:t,soundSettings:o},room:n}=e,i=o.mute??kr.soundSettings.mute?void 0:T.createGain();this.output={sound:i,graphics:new v({label:`RoomRenderer(${e.room.id})`})},this.output.graphics.addChild(this.#r),t||(this.#t=new uo({sortableChildren:!1}),this.output.graphics.addChild(this.#t)),this.output.graphics.addChild(this.#o),t||(this.#r.tint=Re(n.color))}#e=!1;#r=new v({label:"items",cullableChildren:!0});#t;#o=new uo({sortableChildren:!1});output;#n=void 0;#s=new Map;#i=new Map;#a=e=>this.#i.get(e);#l(e,t){let o=this.#i.get(t.id);if(o===void 0){o=yu({...this.renderContext,colourClashLayer:this.#t,frontLayer:this.#o,item:t,zEdges:this.#s,getItemRenderPipeline:this.#a}),this.#i.set(t.id,o);const{graphics:n,sound:s}=o.top.output;if(n&&(this.#r.addChild(n),t.fixedZIndex&&(n.zIndex=t.fixedZIndex)),s){if(!this.output.sound)throw new Error("item renderer has sound, but room renderer does not - this probably means that they disagree on if the user has sound muted");s.connect(this.output.sound)}}try{o.top.tick(e)}catch(n){throw new Error(`RoomRenderer: error while ticking item "${t.id}"
in room "${this.renderContext.room.id}"
item in play object is:
           
${JSON.stringify(t,null,2)}`,{cause:n})}}#c(e){const{room:t}=this.renderContext,o={...e,lastRenderRoomTime:this.#n},n=new Set,s=c=>{if(n.has(c))return;const a=this.#s.get(c);if(a)for(const[l,d]of a.entries())d&&s(l);this.#l(o,t.items[c]),n.add(c)};for(const c in t.items)s(c);let i=!1;for(const[c,a]of this.#i.entries())t.items[c]===void 0&&(a.top.destroy(),this.#i.delete(c),i=!0);i&&this.#u()}#u(){if(this.#t)for(const e of this.#t.renderLayerChildren)e.parent===null&&this.#t.detach(e);for(const e of this.#o.renderLayerChildren)e.parent===null&&this.#o.detach(e)}#h(e){for(let t=0;t<e.length;t++){const o=this.#i.get(e[t]);if(o===void 0)throw new Error(`Item id=${e[t]} does not have a renderer - cannot assign a z-index`);const n=o.top.output.graphics;if(!n)throw new Error(`order ${e[t]} was given a z-order by sorting, but item has no graphics`);n.zIndex=t}}get#d(){return this.#n!==void 0}tick(e){const t=this.#d?e:{...e,movedItems:new Set(ee(this.renderContext.room.items))},{renderContext:{room:o}}=this;Hn(o.items,o[Sn],t.movedItems,this.#s);const n=jn(this.#s);this.#c(t),(!this.#d||t.movedItems.size>0)&&this.#h(n),this.#n=this.renderContext.room.roomTime}destroy(){this.output.graphics.label=this.output.graphics.label+"DESTROYED",this.output.graphics.destroy({children:!0}),this.output.sound?.disconnect(),this.#i.forEach(e=>{e.top.destroy()}),this.#e=!0}get destroyed(){return this.#e}}const vu=(r,e)=>({displaySettings:{emulatedResolution:"amigaLowResPal",showBoundingBoxes:e},soundSettings:{mute:!0},pixiRenderer:r,gameState:void 0,paused:!1,colourised:!0,upscale:vr(C.getState()),editor:!0}),en=(r,e,t)=>new wu({room:r,general:vu(e,t)}),bu=()=>{const{renderer:r}=se(),e=Zs();if(!r)throw new Error("this should never be falsey (typescript violation)");const t=Er(),[o,n]=P.useState(()=>en(t,r,e));return P.useEffect(()=>{const s=en(t,r,e);return n(s),()=>{s.destroy()}},[t,r,e]),o},Cu=r=>{const e=Er(),t=se();P.useEffect(()=>{const o=({deltaMS:n})=>{if(r.destroyed)return;r.renderContext.room!==e&&console.warn("room renderer does not have the current room");const s=new Set(sr(e.items));e.roomTime+=n,r.tick({deltaMS:n,movedItems:s}),t.render()};return ae.shared.add(o),()=>{ae.shared.remove(o)}},[r,e,t])},Su=(r,e,t,o)=>{{const n=o.shade==="dimmed";nl(r,e,t,o),dl(r,t,o),fl(r,n),yl(r,n)}},Iu=()=>{const{renderer:r}=se();if(!r)throw new Error("this should never be falsey (typescript violation)");const{planet:e,color:t}=Er();P.useEffect(()=>{Ys(r)},[r]),P.useEffect(()=>{Su(r,!0,e,t)},[t,r,e])};Qt.defaultOptions.scaleMode="nearest";const ku=()=>{const r=bu(),[e,t]=P.useState(null),[o,n]=P.useState(null),[s,i]=P.useState("amigaLowResPal"),c=sc();return ga(s,o??void 0),oc(),Qa(r),Iu(),Cu(r),Za(e),Ka(e),tc(),rc(),ec(o,e),D.jsxs("div",{className:"w-full h-full relative",children:[D.jsx(Ja,{selectedResolution:s,onResolutionChange:i}),D.jsx("div",{ref:n,className:`w-full h-full ${c} scale-editor bg-editor-checkerboard overflow-scroll scrollbar scrollbar-w-1 scrollbar-track-pureBlack scrollbar-thumb-metallicBlue`,children:D.jsx("div",{style:{transform:xa(),transformOrigin:"center center"},ref:t,tabIndex:1,className:"focus-visible:outline-none"})})]})},Tu=()=>D.jsx(La,{children:D.jsx(ku,{})}),zu=Object.freeze(Object.defineProperty({__proto__:null,default:Tu},Symbol.toStringTag,{value:"Module"}));export{An as A,Mn as C,ia as R,ta as S,_n as V,zu as a,ea as u};
