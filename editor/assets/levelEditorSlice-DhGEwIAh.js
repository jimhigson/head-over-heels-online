import{r as U,g as ye,aj as Ft,i as Y,ak as it,al as $t,am as xo,an as je,ao as G,ap as nt,aq as m,ar as P,as as bo,at as ae,au as Te,av as Nt,aw as Wt,ax as ge,ay as N,az as eo,aA as Bt,aB as st,aC as oo,aD as Le,aE as Mt,aF as to,aG as _t,aH as io,aI as se,aJ as no,aK as Se,o as rt,aL as wo,aM as vo,aN as Io,aO as Xt,aP as Dt,aQ as zo,aR as Ro,aS as Ht,aT as Yt,aU as Lt,aV as Vt,aW as qt,aX as Gt,aY as at,aZ as Jt,a_ as V,a$ as Kt,b0 as Ut,b1 as Zt}from"./index-BMjrSxtR.js";import{o as ce,i as le,a as q}from"./RoomJson-WsgTWPHf.js";var pe={},me={},ko;function Qt(){if(ko)return me;ko=1;const{ensureIterable:e}=U();function o(i){const n=[];for(const s of i)n.push(s);return n}me.__toArray=o;function t(i){return o(e(i))}return me.toArray=t,me}var Eo;function jt(){if(Eo)return pe;Eo=1;const{iterableCurry:e}=U(),{__toArray:o}=Qt();function*t(n,s){const r=Array.isArray(n)?n:o(n);if(r.length)for(;s--;)yield*r}pe.__cycleTimes=t;const i=e(t);return pe.cycleTimes=i,pe}var he={},Po;function ei(){if(Po)return he;Po=1;const{iterableCurry:e}=U();function*o(i,n){let s=0;for(const r of i)n(r,s++)&&(yield r)}he.__filter=o;const t=e(o);return he.filter=t,he}var xe={},Ao;function oi(){if(Ao)return xe;Ao=1;const{iterableCurry:e}=U(),{__cycleTimes:o}=jt();function t(n){return o(n,1/0)}xe.__cycle=t;const i=e(t);return xe.cycle=i,xe}var be={},Co;function ti(){if(Co)return be;Co=1;const{iterableCurry:e}=U();function*o(i,n){let s=0;for(const r of i)s++>=n&&(yield r)}be.__drop=o;const t=e(o);return be.drop=t,be}var we={},ve={},To;function ii(){if(To)return ve;To=1;const{iterableCurry:e,callReturn:o}=U();function t(n,s){const r=n[Symbol.iterator](),{value:c,done:a}=r.next();return a?s:(o(r),c)}ve.__firstOr=t;const i=e(t,{reduces:!0});return ve.firstOr=i,ve}var So;function ni(){if(So)return we;So=1;const{iterableCurry:e}=U(),{__firstOr:o}=ii();function t(n){return o(n,void 0)}we.__first=t;const i=e(t,{reduces:!0});return we.first=i,we}var Ie={},Oo;function si(){if(Oo)return Ie;Oo=1;const{iterableCurry:e}=U();function*o(i,n){if(n===0)return;let s=0;for(const r of i)if(yield r,++s===n)break}Ie.__take=o;const t=e(o);return Ie.take=t,Ie}var Oe,Fo;function ri(){return Fo||(Fo=1,Oe=oi().cycle),Oe}var ai=ri();const ci=ye(ai);var Fe,$o;function li(){return $o||($o=1,Fe=ti().drop),Fe}var di=li();const fi=ye(di);var $e,No;function ui(){return No||(No=1,$e=ei().filter),$e}var yi=ui();const gi=ye(yi);var Ne,Wo;function pi(){return Wo||(Wo=1,Ne=ni().first),Ne}var mi=pi();const Ve=ye(mi);var We,Bo;function hi(){return Bo||(Bo=1,We=si().take),We}var xi=hi();const bi=ye(xi),ct=e=>()=>Ft(e),Cr=(e,o)=>o?.[e],wi=e=>ce(e),re=e=>Y(wi(e)),vi=Symbol("roomSpatialIndexKey"),h={x:16,y:16,z:12},lt=$t/1e3;h.z*2/1e3,h.z*6/1e3;const dt={head:1,heels:2,charles:1,dalek:Math.SQRT2,bubbleRobot:(Math.SQRT2+1)/2,cyberman:1,skiHead:1,helicopterBug:1,homingBot:2,monkey:1,elephant:1,elephantHead:0,emperor:1,emperorsGuardian:Math.SQRT2,computerBot:1,turtle:1,ball:2.625,firedDoughnut:2,movingPlatform:1,floatingText:1};it(dt,([e,o])=>[e,o*lt]);const Ii=it(dt,([e,o])=>[e,(o*.8+.4)*lt]),Mo=1.1;h.z*2.6+Mo,h.z+1+Mo;const zi=10,Tr=6e4,Ri=8,Sr=750,Or=1500,Fr=200,$r=.25,ki=xo.h-xo.w/2,ft=ki+2,so=9999,Ei=(e,o,t)=>{if(o==="*")return!0;const i=t.meta.subRooms[o];return e.x>=i.physicalPosition.from.x&&e.y>=i.physicalPosition.from.y&&e.x<=i.physicalPosition.to.x&&e.y<=i.physicalPosition.to.y},Nr=({position:e},o,t)=>Ei(e,o,t),Pi=(e,o,t)=>{if(o==="*")return 0;const i=t.meta.subRooms[o],{from:n,to:s}=i.physicalPosition;if(e.x>=n.x&&e.y>=n.y&&e.x<=s.x&&e.y<=s.y)return 0;let r=0,c=0;return e.x<n.x?r=n.x-e.x:e.x>s.x&&(r=e.x-s.x),e.y<n.y?c=n.y-e.y:e.y>s.y&&(c=e.y-s.y),r+c},ro=(e,o,t)=>{const i=t.meta?.subRooms;if(i===void 0)return"*";let n,s=1/0;const r=o==="fine"?{x:e.x/h.x,y:e.y/h.y}:e;for(const c of je(i)){const a=Pi(r,c,t);if(a===0)return c;a<s&&(s=a,n=c)}if(n===void 0)throw new Error(`item not found in any subroom of ${t.id}
      item at ðŸ“ ${JSON.stringify(r)}
      subrooms ${JSON.stringify(t.meta?.subRooms,null,2)}`);return n},Ai=["head","heels"],Ci=[...Ai,"headOverHeels"];h.z;h.x/2;const Ti="@@original",Si="original",Wr={userId:Ti,campaignName:Si,version:-1},Br=e=>`${e.x>.5?"x":""}${e.y>.5?"y":""}${e.z>.5?"z":""}`,Oi=e=>{const{x:o,y:t,z:i}=e;if(G(o,0)&&G(t,0)&&!G(i,0))return"xy";if(G(o,0)&&!G(t,0)&&G(i,0))return"xz";if(!G(o,0)&&G(t,0)&&G(i,0))return"yz";throw new Error(`only axis-aligned planes are supported, cannot get normal plane for ${JSON.stringify(e)}`)},Mr=({x:e=0,y:o=0})=>o-e,X=({x:e=0,y:o=0,z:t=0})=>({x:o-e,y:-(e+o)/2-t}),_r=(e,o,t)=>{const i=X(e),n=nt(t,i);return m(Fi(o,n),e)},Fi=(e,{x:o,y:t})=>{switch(Oi(e)){case"xy":return{x:-o/2-t,y:o/2-t,z:0};case"xz":return{x:-o,y:0,z:o/2-t};case"yz":return{x:0,y:o,z:-o/2-t};default:throw new Error("only axis-aligned planes are supported for unprojection")}},S=({x:e=0,y:o=0,z:t=0})=>({x:e*h.x,y:o*h.y,z:t*h.z}),Xr=({x:e=0,y:o=0,z:t=0})=>({x:e/h.x,y:o/h.y,z:t/h.z}),Dr=e=>X(S(e)),$i={floors:{edgeLeftX:Number.POSITIVE_INFINITY,edgeRightX:Number.NEGATIVE_INFINITY,topEdgeY:Number.POSITIVE_INFINITY,bottomEdgeY:Number.NEGATIVE_INFINITY},allItems:{topEdgeY:Number.POSITIVE_INFINITY}},Ni=e=>re(e.items).reduce((o,t)=>{if(t.type==="floor"){const{config:{naturalFootprint:i},state:{position:n},renderAabb:s,renderAabbOffset:r,aabb:c}=t,a=X(m(i.position,{x:i.aabb.x,z:i.aabb.z})).x,l=X(m(i.position,{y:i.aabb.y,z:i.aabb.z})).x,f=X(m(i.position,i.aabb)).y,u=X(m(n,r??P,{z:(s??c).z})).y;return{allItems:o.allItems,floors:{edgeLeftX:Math.min(o.floors.edgeLeftX,a),edgeRightX:Math.max(o.floors.edgeRightX,l),topEdgeY:Math.min(o.floors.topEdgeY,f),bottomEdgeY:Math.max(o.floors.bottomEdgeY,u)}}}else{const i=X(m(t.state.position,t.renderAabb??t.aabb??P,t.renderAabbOffset??P)).y;return{allItems:{topEdgeY:Math.min(o.allItems.topEdgeY,i)},floors:o.floors}}},$i),Wi={from:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY,z:Number.POSITIVE_INFINITY},to:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY,z:Number.NEGATIVE_INFINITY}},Hr=e=>{const o=le(e).filter(t=>t.type==="floor").reduce((t,i)=>{const{position:n,config:{times:s}}=i;return{from:{x:Math.min(t.from.x,n.x),y:Math.min(t.from.y,n.y),z:Math.min(t.from.z,n.z)},to:{x:Math.max(t.to.x,n.x+s.x),y:Math.max(t.to.y,n.y+s.y),z:Math.max(t.to.z,n.z)}}},Wi);if(isFinite(o.from.x))return o},Bi={jail:["bars"],blacktooth:["plain","plain","armour","shield","shield","armour"],bookworld:["book","book","cowboy"],egyptus:["hieroglyphics","hieroglyphics","hieroglyphics","sarcophagus","sarcophagus"],market:["passage","more-fruits","fruits","more-fruits","fruits"],moonbase:["coil","window1","window2","window3"],penitentiary:["loop","loop","skeleton"],safari:["wall","shield","wall","window","window","wall","shield"]},fe=(e,o,t=0)=>{const i=Bi[e],n=i.length,s=(t%n+n)%n,r=ci(i);return fi(s,bi(o+s,r))},Mi=e=>({awayWall:{type:"wall",config:{direction:"away",tiles:Array.from(fe("blacktooth",e.x))},position:{x:0,y:e.y,z:0}},leftWall:{type:"wall",config:{direction:"left",tiles:Array.from(fe("blacktooth",e.y))},position:{x:e.x,y:0,z:0}},towardsWall:{type:"wall",config:{direction:"towards",times:{x:e.x}},position:{x:0,y:0,z:0}},rightWall:{type:"wall",config:{direction:"right",times:{y:e.y}},position:{x:0,y:0,z:0}}}),ut=e=>({planet:"blacktooth",color:{hue:"cyan",shade:"basic"},items:{floor:{type:"floor",config:{floorType:"standable",scenery:"blacktooth",times:e},position:{x:0,y:0,z:0}},...Mi(e)}}),ao="room_0",_i={id:ao,...ut({x:8,y:8})},Xi={meta:{published:!1},locator:{campaignName:void 0,userId:"anon",version:0},rooms:{[ao]:_i}},co={campaignInProgress:Xi,remoteCampaign:void 0,currentlyEditingRoomId:ao,editingRoomIdHistory:{back:[],forward:[]},previewedEdits:{},tool:{type:"pointer"},hoveredItem:void 0,clickableAnnotationHovered:!1,selectedJsonItemIds:[],gridResolution:1,autoCoalesce:!0,wallsFloorsLocked:!0,dragInProgress:!1,history:{undo:[],redo:[]}},Di=(e,o,t,i)=>!(e.x+o.x<=t.x||e.x>=t.x+i.x)&&!(e.y+o.y<=t.y||e.y>=t.y+i.y)&&!(e.z+o.z<=t.z||e.z>=t.z+i.z),lo=({aabb:e,state:{position:o}},{aabb:t,state:{position:i}})=>Di(o,e,i,t);function*Yr(e,o){for(const t of o)e.id!==t.id&&lo(e,t)&&(yield t)}const Hi=e=>!0;function*Yi(e,o,t=Hi){const i=o.getItemCuboidNeighbourhood(e);for(const n of i)t(n)&&lo(e,n)&&(yield n)}const _o={stopAutowalk:5,portal:5,wall:5,blocker:5,doorLegs:5,sceneryPlayer:5,bubbles:5,switch:10,button:10,doorFrame:15,ball:18,block:20,barrier:20,floor:20,hushPuppy:20,teleporter:20,lift:30,movingPlatform:30,pushableBlock:30,portableBlock:30,sceneryCrown:30,slidingBlock:30,spring:30,joystick:40,charles:40,conveyor:40,head:50,heels:50,headOverHeels:50,pickup:80,firedDoughnut:90,spikes:98,slidingDeadly:100,moveableDeadly:100,deadlyBlock:100,monster:100,floatingText:200,particle:200,emitter:200},Li=(e,o)=>_o[e.type]-_o[o.type],C=(...e)=>{if(e.length===1){const[o]=e;return t=>t.type===o}return o=>e.includes(o.type)},Vi=C("bubbles","stopAutowalk","firedDoughnut","floatingText","emitter","particle"),qi=(e,o)=>Vi(e)||ji(e)&&(o!==void 0&&Ki(o)||e.config.direction.z!==0)||pt(e)&&e.config.floorType==="none",qe=(e,o)=>!qi(e,o),yt=["ball","slidingBlock","slidingDeadly"];C(...yt);const Gi=["portableBlock","spring","sceneryPlayer","sceneryCrown","monster","slidingBlock"],Ji=["dalek","turtle","elephantHead","homingBot","helicopterBug"],Lr=e=>e.type==="slidingBlock"?e.config.style==="puck":e.type==="monster"?Ji.includes(e.config.which):Gi.includes(e.type),Ki=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function Ui(e){return gt.includes(e.type)}const gt=[...Ci,"monster","ball","charles","pushableBlock","movingPlatform","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer","sceneryCrown"],Zi=["monster","deadlyBlock","moveableDeadly","slidingDeadly"];C(...Zi);const Qi=e=>e.config.times!==void 0,ji=C("portal");C("teleporter");const Vr=C("heels");C("head");const qr=C("headOverHeels");C("heels","headOverHeels");C("head","headOverHeels");C("lift");C("button");C("emitter");const en=C("monster"),pt=C("floor");C("pickup");const Gr=e=>e.type==="button"||e.type==="switch"&&e.config.type==="in-room";C("spring");const Jr=C("joystick");C("conveyor");C("hushPuppy");C("firedDoughnut");const Kr=C("wall","doorFrame");C("monster","movingPlatform");const Ur=e=>en(e)&&e.config.which==="cyberman"&&e.state.everActivated===!1,on=(e,o,t,i)=>{const n=Math.max(0,Math.min(e.x+o.x,t.x+i.x)-Math.max(e.x,t.x)),s=Math.max(0,Math.min(e.y+o.y,t.y+i.y)-Math.max(e.y,t.y));return n*s},Xo=({state:{position:e},aabb:o},{state:{position:t},aabb:i})=>on(e,o,t,i),Z={state:{position:{x:0,y:0,z:0}},aabb:{x:0,y:0,z:0}},Q={state:{position:{x:0,y:0,z:0}},aabb:{x:0,y:0,z:0}},tn=(e,o,t=.001)=>{if(!qe(o,e)||e.id===o.id)return!1;const{state:{vels:{gravity:{z:i}}}}=e;return i>0?!1:(Z.state.position.x=e.state.position.x,Z.state.position.y=e.state.position.y,Z.state.position.z=e.state.position.z-bo,Z.aabb.x=e.aabb.x,Z.aabb.y=e.aabb.y,Z.aabb.z=t+bo,Q.state.position.x=o.state.position.x,Q.state.position.y=o.state.position.y,Q.state.position.z=o.state.position.z+o.aabb.z,Q.aabb.x=o.aabb.x,Q.aabb.y=o.aabb.y,Q.aabb.z=0,lo(Z,Q))},nn=(e,o)=>{const i=[...Y(o).filter(s=>tn(e,s))];return i.length===0?void 0:i.reduce((s,r)=>{const c=Li(r,s);return c<0||c===0&&Xo(e,r)>Xo(e,s)?r:s})},sn=e=>X(e),rn=(e,o)=>X(m(e,{x:o.x,z:o.z})),an=(e,o)=>X(m(e,{y:o.y,z:o.z})),Zr=(e,o)=>X(m(e,{y:o.y})),Qr=(e,o)=>X(m(e,{x:o.x})),jr=(e,o)=>X(m(e,o)),ea=(e,o,t)=>X(m(e,{x:t.x*o.x,y:t.y*o.y,z:t.z*o.z})),Do=(e,o,t)=>{const i=rn(o,t),n=an(o,t),s=sn(o),r=e;return r.xAxisProjectionMin=n.y-n.x/2,r.xAxisProjectionMax=s.y-s.x/2,r.yAxisProjectionMin=i.y+i.x/2,r.yAxisProjectionMax=s.y+s.x/2,r.zAxisProjectionMin=i.x,r.zAxisProjectionMax=n.x,r},Ho=h.x*2,Yo=h.x*2,Lo=h.x*2,Vo=h.x*2;class cn{#t=new Map;#o=new Map;#e=new Map;#i=new Map;#n=new Map;constructor(o){if(o)for(const t of o)this.addItem(t)}#a(o,t,i,n){const s=new Set;for(const r of t)n(r).add(o),s.add(r);i.set(o,s)}#c(o,t,i){const n=i.get(o);if(i.delete(o),!!n)for(const s of n){const r=t.get(s);r&&(r.delete(o),r.size===0&&t.delete(s))}}#l(o,t,i,n,s){const r=n.get(o);if(!r)throw new Error(`Item ${o.id} not in index`);const c=new Set(t);let a=!1,l=!1;for(const f of r)if(!c.has(f)){const u=i.get(f);u&&(a=!0,u.delete(o))}for(const f of c)r.has(f)||(s(f).add(o),l=!0);if(a)for(const f of r){const u=i.get(f);u&&u.size===0&&i.delete(f)}a||l?n.set(o,c):c.clear()}addItem(o){if(this.#e.has(o)){const t=this.#e.get(o);throw new Error(`Item ${o.id} is already in the spatial index at ${[...t].join(" ")}`)}this.#a(o,this.#s(o.state.position,o.aabb),this.#e,t=>this.#f(t)),this.#y(o),this.#a(o,this.#r(o),this.#i,t=>this.#u(t))}#d(o,t){return`${o},${t}`}#f(o){let t=this.#t.get(o);return t||(t=new Set,this.#t.set(o,t)),t}#u(o){let t=this.#o.get(o);return t||(t=new Set,this.#o.set(o,t)),t}*#s(o,t){const i=o,n=m(o,t),s=Math.floor(i.x/Yo),r=Math.floor(i.y/Ho),c=Math.floor(n.x/Yo),a=Math.floor(n.y/Ho);for(let l=s;l<=c;l++)for(let f=r;f<=a;f++)yield this.#d(l,f)}#y(o){const t=o.renderAabbOffset?m(o.state.position,o.renderAabbOffset):o.state.position,i=o.renderAabb||o.aabb,n=this.#n.get(o);if(n!==void 0)return Do(n,t,i),n;{const s=Do({},t,i);return this.#n.set(o,s),s}}*#r(o){const t=this.#n.get(o);if(t===void 0)throw new Error("projectionAxes not calculated for "+o.id);const{xAxisProjectionMin:i,xAxisProjectionMax:n,yAxisProjectionMin:s,yAxisProjectionMax:r}=t,c=Math.floor(i/Vo),a=Math.floor(s/Lo),l=Math.floor(n/Vo),f=Math.floor(r/Lo);for(let u=c;u<=l;u++)for(let d=a;d<=f;d++)yield this.#d(u,d)}removeItem(o){if(!this.#e.has(o))throw new Error(`Item ${o.id} is not in the spatial index`);this.#c(o,this.#t,this.#e),this.#c(o,this.#o,this.#i),this.#n.delete(o)}updateItemSpatialIndex(o){this.#l(o,this.#s(o.state.position,o.aabb),this.#t,this.#e,t=>this.#f(t))}updateItemProjectedIndex(o){this.#y(o),this.#l(o,this.#r(o),this.#o,this.#i,t=>this.#u(t))}getCuboidNeighbourhood(o,t,i){const n=new Set;for(const s of this.#s(o,t)){const r=this.#t.get(s);if(r)for(const c of r)c!==i&&n.add(c)}return n}getProjectedNeighbourhood(o,t){const i=new Set;for(const n of this.#r(o)){const s=this.#o.get(n);if(s)for(const r of s)r!==t&&i.add(r)}return i}getItemCuboidNeighbourhood(o){return this.getCuboidNeighbourhood(o.state.position,o.aabb,o)}getItemProjectedNeighbourhood(o){return this.getProjectedNeighbourhood(o,o)}getItemAxesProjections(o){return this.#n.get(o)}debugToString(){const t=Array.from(this.#t.keys()).sort().map(s=>{const r=this.#t.get(s),c=Array.from(r).map(a=>a.id);return`  (${s}) => [${c.join(", ")}]`}),n=Array.from(this.#o.keys()).sort().map(s=>{const r=this.#o.get(s),c=Array.from(r).map(a=>a.id);return`  (${s}) => [${c.join(", ")}]`});return`GridSpatialIndex (${this.#t.size} 2D cells, ${this.#o.size} projected cells, ${this.#e.size} items) {
  2D Cells:
${t.join(`,
`)}
  Projected Cells:
${n.join(`,
`)}
}`}}const ln=({above:e,below:o})=>{const t=o.state.stoodOnBy;if(!Object.isExtensible(t))throw new Error(`${e.id} can't stand on ${o.id} - its standingOn is not extensible`);e.state.previousStandingOnItemId=e.state.standingOnItemId,e.state.standingOnItemId=o.id,t[e.id]=!0},B={x:12,y:12,z:h.z},dn={x:14,y:14,z:h.z},j={x:16,y:16,z:h.z},Be={...B,z:h.z*2},mt=e=>{switch(e.type){case"spring":case"portableBlock":case"moveableDeadly":case"slidingDeadly":case"firedDoughnut":return{aabb:B};case"slidingBlock":return e.config.style==="book"?{aabb:j}:{aabb:B};case"lift":return{aabb:{...B,z:B.z}};case"switch":return{aabb:{...B,z:B.z}};case"button":return{aabb:{x:15,y:15,z:2}};case"pickup":return e.config.gives==="scroll"?{aabb:{x:16,y:4,z:13}}:{aabb:B};case"charles":return{aabb:Be};case"ball":return{aabb:{x:12,y:12,z:12}};case"pushableBlock":case"movingPlatform":return{aabb:j};case"block":switch(e.config.style){case"artificial":case"organic":case"book":return{aabb:j};case"tower":return{aabb:{x:11,y:11,z:h.z}};default:throw new Error("unknown block style")}case"monster":switch(e.config.which){case"skiHead":return{aabb:{...B,z:21}};case"bubbleRobot":case"cyberman":case"elephant":case"emperorsGuardian":case"monkey":case"computerBot":return{aabb:Be};case"helicopterBug":case"dalek":case"emperor":case"homingBot":case"elephantHead":return{aabb:B};case"turtle":return{aabb:B};default:throw e.config,new Error("unknown monster type")}case"deadlyBlock":case"spikes":return{aabb:j};case"bubbles":return{aabb:B};case"conveyor":case"hushPuppy":case"teleporter":return{aabb:j};case"barrier":return{aabb:e.config.axis==="y"?{x:3,y:15,z:h.z}:{x:15,y:3,z:h.z}};case"sceneryPlayer":return e.config.which==="headOverHeels"?{aabb:Be}:{aabb:B};case"emitter":return{aabb:P};default:return{aabb:dn}}},D={aabb:B,castsShadowWhileStoodOn:!1},oe=e=>({x:e.direction==="away"?e.tiles.length:e.direction==="towards"?e.times?.x??1:1,y:e.direction==="left"?e.tiles.length:e.direction==="right"?e.times?.y??1:1}),oa=e=>e.type==="wall"?oe(e.config):Qi(e)?e.config.times:void 0,Ge=(e=ae)=>({x:e.x??1,y:e.y??1,z:e.z??1}),fn=e=>({x:e.x??1,y:e.y??1}),H=e=>{const o=t=>t.config.times!==void 0;return e.type==="wall"?Ge(oe(e.config)):o(e)?Ge(e.config.times):ae},ht=e=>{const o={};let t=!1;return e.x!==1&&(o.x=e.x,t=!0),e.y!==1&&(o.y=e.y,t=!0),e.z!==1&&(o.z=e.z,t=!0),t?o:void 0},ue=(e,o={})=>{const t=Ge(o),i=Te(h,e);return Nt(Wt(t,h),i)},K=-2,W=Number.MIN_SAFE_INTEGER,Me={x:1,y:0,z:0},_e={x:-1,y:0,z:0},Xe={x:0,y:-1,z:0},De={x:0,y:1,z:0},$={away:De,left:Me,right:_e,towards:Xe,down:{x:0,y:0,z:-1},up:{x:0,y:0,z:1},awayRight:ge(m(De,_e)),towardsRight:ge(m(Xe,_e)),towardsLeft:ge(m(Xe,Me)),awayLeft:ge(m(De,Me))},Je=e=>{const o=S(e.position),{aabb:t}=mt(e);if(t===void 0)throw new Error(`item type= ${e.type} config=${JSON.stringify(e.config)} has no bounding box`);return e.type==="wall"?o:m(o,{x:h.x-t.x>>1,y:h.y-t.y>>1})},M=()=>({expires:null,stoodOnBy:{},disappearing:null,switchedAtRoomTime:W,stoodOnUntilRoomTime:W,actedOnAt:{roomTime:W,by:N}}),xt=()=>({gravity:P,movingFloor:P}),Ke=()=>({vels:xt(),latentMovement:[],collidedWith:{roomTime:W,by:N},controlledWithJoystickAtRoomTime:W,standingOnItemId:null,standingOnUntilRoomTime:W,previousStandingOnItemId:null}),un=e=>{const o=gt.includes(e.type);return{...M(),position:Je(e),...o?{...Ke(),vels:{...xt(),...yt.includes(e.type)?{sliding:P}:{},...e.type==="monster"||e.type==="movingPlatform"?{walking:P}:{}}}:{},...e.type==="joystick"||e.type==="emitter"||e.type==="lift"||e.type==="conveyor"||e.type==="teleporter"?{...structuredClone(e.config)}:{},...e.type==="monster"?{activated:e.config.activated==="on",everActivated:e.config.activated==="on",timeOfLastDirectionChange:Number.NEGATIVE_INFINITY,...e.config.which==="skiHead"||e.config.which==="turtle"||e.config.which==="elephantHead"||e.config.which==="cyberman"?{facing:$[e.config.startDirection]}:{facing:$.towards}}:{},...e.type==="pickup"?{disappearing:{on:"touch",byType:e.config.gives==="bag"||e.config.gives==="jumps"?["heels","headOverHeels"]:e.config.gives==="doughnuts"||e.config.gives==="hooter"||e.config.gives==="fast"?["head","headOverHeels"]:["head","heels","headOverHeels"]}}:{},...e.type==="movingPlatform"?{activated:e.config.activated==="on",everActivated:e.config.activated==="on",facing:$[e.config.startDirection]}:{},...e.type==="switch"?{setting:e.config.initialSetting,lastToggledAtRoomTime:W}:{},...e.type==="button"?{pressed:!1}:{},...e.type==="block"?{disappearing:e.config.disappearing??null}:{},...e.type==="conveyor"?{disappearing:e.config.disappearing??null}:{},...e.type==="barrier"?{disappearing:e.config.disappearing??null}:{},...e.type==="lift"?{direction:"up",vels:{lift:P}}:{},...e.type==="charles"?{facing:$.towards}:{},...e.type==="emitter"?{lastEmittedAtRoomTime:W,quantityEmitted:0}:{},...e.type==="firedDoughnut"?{disappearing:{on:"touch"},vels:{fired:e.config.direction?eo($[e.config.direction],Ii.firedDoughnut):P}}:{}}},yn=({config:{direction:e},position:o})=>e==="right"&&o.x===0||e==="towards"&&o.y===0,gn=Object.freeze({textureId:"shadow.door.floatingThreshold.double.y",spritesheetVariant:"original"}),pn=Object.freeze({textureId:"shadow.doorFrame.top.y",spritesheetVariant:"original"}),mn=Object.freeze({textureId:"shadow.doorFrame.top.y",flipX:!0,spritesheetVariant:"original"}),hn=["doorLegs"],xn=Object.freeze({textureId:"shadow.door.floatingThreshold.double.y",flipX:!0,spritesheetVariant:"original"}),He=h.z*2,bn=4,ze=h.z*bn,wn=2,ta=2*h.x,vn=.5,qo=2;function*In(e,o){const{config:{direction:t},position:i}=e,n=st(t),s=oo(n),r=yn(e),c={...P,[s]:r?-.5:0},a=1,l={[s]:r?-a:0},f=a*h.x,u={...P,[s]:f},d=9,y=8,g=8;{const p={[n]:y,[s]:g,z:ze};yield{...e,...D,type:"doorFrame",id:`${o}/frameFar`,jsonItemId:o,config:{...e.config,inHiddenWall:r,part:"far"},state:{...M(),position:S(m(i,{[n]:1.5},c,l)),stoodOnBy:N},aabb:m(p,u),renderAabb:p,renderAabbOffset:r?u:void 0}}{const p={[n]:d,[s]:g,z:ze};yield{...e,...D,type:"doorFrame",id:`${o}/frameNear`,jsonItemId:o,config:{...e.config,inHiddenWall:r,part:"near"},state:{...M(),position:S(m(i,c,l)),stoodOnBy:N},aabb:m(p,u),renderAabb:p,renderAabbOffset:r?u:void 0}}{const p={[n]:2*h.x-d-y,[s]:g,z:ze-He};yield{...e,...D,type:"doorFrame",id:`${o}/frameTop`,jsonItemId:o,config:{...e.config,inHiddenWall:r,part:"top"},state:{...M(),position:m(S(m(i,c,l)),{[n]:d,z:He}),stoodOnBy:N},aabb:m(p,u),renderAabb:p,renderAabbOffset:r?u:void 0,shadowCastTexture:r?void 0:n==="x"?mn:pn,castsShadowWhileStoodOn:!0,noShadowCastOn:r?void 0:hn}}yield{...e,...D,type:"blocker",id:`${o}/blockerAbove`,jsonItemId:o,config:{},renders:!1,state:{...M(),position:m(S(m(i,c,l)),{z:ze}),stoodOnBy:N},aabb:m(S({[n]:2,[s]:a}),{[s]:g,z:so}),renderAabb:P,fixedZIndex:K},yield{...e,...D,type:"portal",id:`${o}/portal`,jsonItemId:o,config:{...Bt(e.config,"toRoom","toDoor"),inHidden:r,relativePoint:S({...P,[s]:r?a+.25:-.25}),direction:$[t]},fixedZIndex:K,state:{...M(),position:m(S(m(i,{[s]:r?-.5-a:.5})),{[n]:d}),stoodOnBy:N},aabb:{[n]:wn*h.x-d-y,[s]:f,z:He}},i.z!==0&&(yield{...e,...D,type:"doorLegs",id:`${o}/legs`,jsonItemId:o,config:{...e.config,inHiddenWall:r,style:"none",side:"away",height:i.z},renders:!0,shadowCastTexture:r?n==="x"?xn:gn:void 0,castsShadowWhileStoodOn:r,state:{...M(),position:{...S(m(i,c,l)),z:0}},aabb:m(S({[n]:2,[s]:.5,z:i.z}),u),renderAabb:r?m(S({[n]:2,[s]:.5,z:.5})):void 0,renderAabbOffset:r?m({[n]:0,[s]:0,z:(i.z-.5)*h.z},{[s]:u[s]}):void 0,shadowOffset:{z:i.z*h.z,[s]:r?u[s]:void 0}}),yield{...D,type:"stopAutowalk",id:`${o}/stopAutowalk`,jsonItemId:o,aabb:S({[n]:2,[s]:qo,z:2}),config:{},fixedZIndex:K,state:{...M(),position:S(Te(i,eo($[t],vn),r?P:{[s]:qo})),stoodOnBy:N}}}const Go=3,Jo=10,Ko=.52,Re=.5,zn=Object.freeze({textureId:"shadow.fullBlock",spritesheetVariant:"original"}),Rn=(e,o,t)=>{const{config:{times:i},position:n}=o,s=m(n,{z:-Go}),r={...i,z:Go};let c=s,a=r;const l=Y(ce(t.items)).filter(d=>d.type==="door");if(n.z===0){const d={};for(const y of l){const{position:g,config:{direction:p}}=y;switch(p){case"towards":!d.towards&&g.y===s.y&&g.x>=s.x&&g.x<=s.x+i.x-2&&(a=m(a,{y:Re}),c=m(c,{y:-Re}),d.towards=!0);break;case"away":!d.away&&g.y===s.y+i.y&&g.x>=s.x&&g.x<=s.x+i.x-2&&(a=m(a,{y:Ko}),d.away=!0);break;case"right":!d.right&&g.x===s.x&&g.y>=s.y&&g.y<=s.y+i.y-2&&(a=m(a,{x:Re}),c=m(c,{x:-Re}),d.right=!0);break;case"left":!d.left&&g.x===s.x+i.x&&g.y>=s.y&&g.y<=s.y+i.y-2&&(a=m(a,{x:Ko}),d.left=!0);break}}}const f=S(c),u=ue(j,a);return{...D,type:"floor",id:e,jsonItemId:e,config:{...o.config,naturalFootprint:{aabb:ue(j,r),position:S(s)}},aabb:u,renderAabb:{...u,z:Jo},renderAabbOffset:{...P,z:u.z-Jo},shadowCastTexture:zn,state:{...M(),position:f}}},kn=Object.freeze({animationId:"shadow.lift",spritesheetVariant:"original"}),Uo=Object.freeze({textureId:"shadow.smallBlock",spritesheetVariant:"original"}),ie=Object.freeze({textureId:"shadow.smallRound",spritesheetVariant:"original"}),ke=Object.freeze({textureId:"shadow.fullBlock",spritesheetVariant:"original"}),En=Object.freeze({textureId:"shadow.fullBlock",flipX:!0,spritesheetVariant:"original"}),Pn=Object.freeze({textureId:"shadow.barrier.y",spritesheetVariant:"original"}),An=Object.freeze({textureId:"shadow.barrier.y",flipX:!0,spritesheetVariant:"original"}),Cn=Object.freeze({textureId:"shadow.scroll",spritesheetVariant:"original"}),Tn=e=>{switch(e.type){case"lift":return kn;case"switch":return Uo;case"conveyor":return Le(e.config.direction)==="x"?En:ke;case"barrier":return e.config.axis==="x"?An:Pn;case"spring":case"firedDoughnut":case"slidingDeadly":return ie;case"block":return e.config.style==="tower"?ie:ke;case"pushableBlock":case"movingPlatform":case"hushPuppy":case"deadlyBlock":case"teleporter":case"spikes":return ke;case"portableBlock":return e.config.style==="drum"?ie:Uo;case"pickup":return e.config.gives==="scroll"?Cn:ie;case"ball":case"charles":case"monster":return ie;case"slidingBlock":return e.config.style==="book"?ke:ie}},Sn=Object.freeze({textureId:"shadow.playable",spritesheetVariant:"original"}),Zo={config:N,shadowCastTexture:Sn,castsShadowWhileStoodOn:!0,aabb:B},Qo=()=>{const e=_t(to.getState());return{action:"idle",jumped:!1,teleporting:null,autoWalk:!1,facing:$.towards,visualFacingVector:$.towards,walkStartFacing:$.towards,walkDistance:0,vels:{walking:P,gravity:P,movingFloor:P},switchedToAt:W,lastDiedAt:W,gameTime:0,jumpStartTime:W,lives:e?"infinite":Ri,jumpStartZ:0}},On=(e,o)=>{const t=Mt(to.getState());return e.config.which==="head"?{id:o,jsonItemId:o,type:"head",...D,...Zo,state:{...M(),...Ke(),...Qo(),hasHooter:!1,gameWalkDistance:0,fastStepsStartedAtDistance:W,shieldCollectedAt:W,doughnuts:t?"infinite":0,position:Je(e),stoodOnUntilRoomTime:W}}:{id:o,jsonItemId:o,type:"heels",...D,...Zo,state:{...M(),...Ke(),...Qo(),carrying:null,hasBag:!1,bigJumps:0,isBigJump:!1,shieldCollectedAt:W,position:Je(e),stoodOnUntilRoomTime:W}}},bt=e=>e==="towards"||e==="right",Fn=Object.freeze({textureId:"shadow.wall.y",spritesheetVariant:"original"}),$n=Object.freeze({textureId:"shadow.wall.y",flipX:!0,spritesheetVariant:"original"}),fo=1,Nn={x:h.x,y:h.y*fo,z:so},Wn={x:h.x,y:0,z:ft},Bn={x:h.x*fo,y:h.y,z:so},Mn={x:0,y:h.y,z:ft},_n=(e,o)=>{const{config:{direction:t},position:i}=o,n=oe(o.config),s=st(t),r=oo(s),c=bt(t),a={...P,[r]:c?-fo:0};return{type:"wall",id:e,jsonItemId:e,config:o.config,aabb:ue(s==="y"?Bn:Nn,n),renderAabb:c?P:ue(s==="y"?Mn:Wn,n),fixedZIndex:c?K:void 0,state:{...M(),position:S(m(i,a)),stoodOnBy:N},shadowCastTexture:s!=="y"?$n:Fn,castsShadowWhileStoodOn:c}};function*wt(e,o,t,i=N,n={},s=""){if(!i[e]&&!(o.type==="pickup"&&o.config.gives==="scroll"&&o.config.source==="manual"&&n[o.config.page]))switch(!0){case o.type==="door":return yield*In(o,e);case o.type==="player":{yield On(o,e);return}case o.type==="wall":{yield _n(e,o);return}case o.type==="floor":{yield Rn(e,o,t);return}case(o.type==="block"&&o.config.disappearing!==void 0&&io(H(o))>=2):{const r=H(o);for(let c=0;c<r.x;c++)for(let a=0;a<r.y;a++)for(let l=0;l<r.z;l++){const f=se(o,u=>{u.position={x:o.position.x+c,y:o.position.y+a,z:o.position.z+l},u.config.times=ae});yield*wt(e,f,t,i,n,`${s}_${c}_${a}_${l}`)}break}case(o.type==="sceneryCrown"&&!to.getState().gameMenus.gameInPlay.planetsLiberated[o.config.planet]):return;default:{const r=mt(o),c=o.config.times!==void 0?{aabb:ue(r.aabb,o.config.times),renderAabb:void 0}:r;let a;try{a=un(o)}catch(l){throw new Error(`loadItemFromJson: error creating initial state for jsonItem ${JSON.stringify(o,null,2)}`,{cause:l})}yield{...o,...D,...c,id:`${e}${s}`,jsonItemId:e,fixedZIndex:o.type==="emitter"?K:void 0,shadowCastTexture:Tn(o),castsShadowWhileStoodOn:o.type==="monster"&&(o.config.which==="emperor"||o.config.which==="emperorsGuardian"||o.config.which==="cyberman"||o.config.which==="turtle"||o.config.which==="helicopterBug")||o.type==="pickup"||o.type==="ball"||o.type==="lift"||o.type==="pushableBlock"||o.type==="sceneryPlayer"||o.type==="slidingDeadly"||o.type==="spring",config:o.config,state:a}}}}const Ee=h.z,Xn=-h.z,Dn=e=>{const o=re(e).filter(pt).reduce((t,{config:{naturalFootprint:{position:{x:i,y:n},aabb:{x:s,y:r}}}})=>{const c=i+s,a=n+r;return{minX:Math.min(t.minX,i),maxX:Math.max(t.maxX,c),minY:Math.min(t.minY,n),maxY:Math.max(t.maxY,a)}},{minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0});if(!(o.minX>o.maxY))return o};function*Hn(e,o){const t=Dn(o);if(t===void 0)return;const{minX:i,maxX:n,minY:s,maxY:r}=t;e.roomBelow!==void 0&&(yield{...D,type:"portal",id:"portal/toRoomBelow",fixedZIndex:K,config:{toRoom:e.roomBelow,relativePoint:{x:(i+n)/2,y:(s+r)/2,z:Ee+h.z},direction:$.down},aabb:{x:n-i,y:r-s,z:Ee},state:{...M(),position:{x:i,y:s,z:Xn-Ee}},renders:!1}),e.roomAbove!==void 0&&(yield{...D,type:"portal",id:"portal/toRoomAbove",fixedZIndex:K,config:{toRoom:e.roomAbove,relativePoint:{...e.ceilingRelativePoint!==void 0?S(e.ceilingRelativePoint):{x:(i+n)/2,y:(s+r)/2},z:-h.z},direction:$.up},aabb:{x:n-i,y:r-s,z:Ee},state:{...M(),position:m({x:i,y:s},{z:h.z*(e.height??zi)})}})}const Yn={x:-9/12,y:-9/12},Ln=S({x:9/12,y:9/12,z:1}),jo=(e,o)=>{const t=`${e.position.x},${e.position.y}`;let i=o.get(t);i===void 0&&(i=new Map,o.set(t,i)),i.set(e.config.direction,e)};function*Vn(e){const o=new Map,t=new Map;for(const i of le(e))switch(i.type){case"wall":jo(i,o);break;case"door":jo(i,t);break}for(const[i,n]of o.entries()){const s=n.get("right"),r=n.get("towards");if(!s||!r)continue;const c=m(s.position,oe(s.config),{x:-1});if(t.get(`${c.x},${c.y}`)?.get("right")===void 0)continue;const a=m(r.position,oe(r.config),{y:-1});if(t.get(`${a.x},${a.y}`)?.get("towards")===void 0)continue;const l=s.position;yield{id:`extraCornerShadow-${i}`,type:"blocker",state:{...M(),position:S(m(l,Yn))},shadowCastTexture:{textureId:"shadow.wallCorner",spritesheetVariant:"original"},castsShadowWhileStoodOn:!0,config:N,aabb:Ln,fixedZIndex:K}}}function*qn(e,o,t,i){const n=no(e.items);for(const[s,r]of n)r.type==="player"&&!i||(yield*wt(s,r,e,o,t))}const Ye=e=>Y(e).reduce((o,t)=>({...o,[t.id]:t}),{}),vt=({roomJson:e,roomPickupsCollected:o,scrollsRead:t,isNewGame:i=!1})=>{const n=Ye(qn(e,o,t,i)),s={...Ye(Hn(e,n)),...n,...Ye(Vn(e))},r=new cn(re(s));for(const a of re(s)){const f=Yi(a,r).find(u=>qe(a)&&qe(u)&&!(a.type==="wall"&&u.type==="wall"));f!==void 0&&console.error(`in room ${e.id} item ${a.id} @${JSON.stringify(a.state.position)} #${JSON.stringify(a.aabb)} is colliding with (solid item) ${f.id} @${JSON.stringify(f.state.position)} #${JSON.stringify(f.aabb)} on loading room ${e.id}`)}for(const a of re(s).filter(Ui)){const l=nn(a,re(s).filter(f=>f.id!==a.id));l!==void 0&&ln({above:a,below:l})}return{...e,roomJson:e,items:s,roomTime:0,[vi]:r}},Gn=Se([e=>O(e.levelEditor),e=>e.levelEditor.previewedEdits],(e,o)=>se(e,t=>{const i=rt(o);for(const[n,s]of i)s===null?delete t.items[n]:t.items[n]=s})),Jn=Se([e=>O(e.levelEditor)],e=>vt({roomJson:e,roomPickupsCollected:N,scrollsRead:N,isNewGame:!0})),Kn=Se([Gn],e=>vt({roomJson:e,roomPickupsCollected:N,scrollsRead:N,isNewGame:!0})),Un=Se([Jn],e=>{const{floors:{edgeLeftX:o,edgeRightX:t,bottomEdgeY:i},allItems:{topEdgeY:n}}=Ni(e);return{l:o,r:t,w:t-o,b:i,t:n,h:i-n}}),ia=ct(Kn),na=ct(Un),O=e=>e.campaignInProgress.rooms[e.currentlyEditingRoomId],Ue=(e,o)=>e.campaignInProgress.rooms[o],It=(e,o,t)=>e.campaignInProgress.rooms[t??e.currentlyEditingRoomId]?.items[o],Zn=(e,o)=>e.selectedJsonItemIds.includes(o),uo="$$final",yo=e=>io(go(e))>0,go=e=>{switch(e.type){case"deadlyBlock":return ae;case"conveyor":if(e.config.disappearing)return P;switch(e.config.direction){case"left":case"right":return Dt;case"away":case"towards":return Xt;default:throw e.config.direction,new Error}case"hushPuppy":return ae;case"teleporter":return Io;case"floor":case"spikes":return Io;case"block":return ae;case"barrier":if(e.config.disappearing)return P;switch(e.config.axis){case"x":return wo;case"y":return vo;default:throw e.config.axis,new Error}case"wall":switch(e.config.direction){case"left":case"right":return vo;case"away":case"towards":return wo;default:throw e.config,new Error}default:return P}};class Ce{#t;#o;#e;constructor(o,t){this.#o={x:-o.x,y:-o.y,z:-o.z},this.#e={x:t.x-o.x+1,y:t.y-o.y+1,z:t.z-o.z+1},this.#t=Array.from({length:this.#e.x},()=>Array.from({length:this.#e.y},()=>Array.from({length:this.#e.z},()=>new Set)))}static fromItems(o){let t=1/0,i=1/0,n=1/0,s=-1/0,r=-1/0,c=-1/0;const a=[...o];for(const[,f]of a){const{x:u,y:d,z:y}=f.position,g=H(f);t=Math.min(t,u),i=Math.min(i,d),n=Math.min(n,y),s=Math.max(s,u+g.x-1),r=Math.max(r,d+g.y-1),c=Math.max(c,y+g.z-1)}if(a.length===0)return new Ce({x:0,y:0,z:0},{x:0,y:0,z:0});const l=new Ce({x:t,y:i,z:n},{x:s,y:r,z:c});for(const f of a){const[,u]=f,{x:d,y,z:g}=u.position,p=H(u);for(let T=0;T<p.x;T++)for(let A=0;A<p.y;A++)for(let I=0;I<p.z;I++)l.add({x:d+T,y:y+A,z:g+I},f)}return l}get(o){const t=o.x+this.#o.x,i=o.y+this.#o.y,n=o.z+this.#o.z;if(this.#i(t,i,n))return this.#t[t][i][n]}set(o,t){const i=o.x+this.#o.x,n=o.y+this.#o.y,s=o.z+this.#o.z;this.#i(i,n,s)&&(this.#t[i][n][s]=t)}add(o,t){const i=this.get(o);i&&i.add(t)}remove(o,t){const i=this.get(o);i&&i.delete(t)}get size(){return{...this.#e}}get minBounds(){return{x:-this.#o.x,y:-this.#o.y,z:-this.#o.z}}get maxBounds(){const o=this.minBounds;return{x:o.x+this.#e.x-1,y:o.y+this.#e.y-1,z:o.z+this.#e.z-1}}*iterate(){const{minBounds:o}=this;for(let t=0;t<this.#e.x;t++)for(let i=0;i<this.#e.y;i++)for(let n=0;n<this.#e.z;n++)yield[{x:t+o.x,y:i+o.y,z:n+o.z},this.#t[t][i][n]]}extractUniqueItems(){const o=new Set,t=[];for(const[,i]of this.iterate())for(const n of i)o.has(n)||(o.add(n),t.push(n));return t}#i(o,t,i){return o>=0&&o<this.#e.x&&t>=0&&t<this.#e.y&&i>=0&&i<this.#e.z}}const J=e=>e.type==="wall"?`wall/${e.config.direction}`:e.type==="teleporter"?zo({type:e.type,config:Ro(e.config,"toPosition","times")}):zo({type:e.type,config:Ro(e.config,"times")}),Qn=e=>yo(e[1]),jn=e=>({x:Math.floor(e.x%1*h.x),y:Math.floor(e.y%1*h.y)}),es=(e,o)=>`${e},${o}`,os=(e,o)=>{let t=e,i=t.length;for(;;){const n=[...is(t,o)];if(n.length===i)return n;i=n.length,t=n}},ts=(e,o=()=>!0)=>{const t=new Map,i=[];for(const s of e){const[,r]=s;if(!o(s))i.push(s);else if(yo(r)){const c=jn(r.position),a=es(c.x,c.y);t.has(a)||t.set(a,[]),t.get(a).push(s)}else i.push(s)}const n=[];for(const[s,r]of t)if(r.length>0){const c=r.map(([y,g])=>[y,{...g,position:{x:Math.floor(g.position.x),y:Math.floor(g.position.y),z:g.position.z}}]),a=os(c,o),[l,f]=s.split(",").map(Number),u=l/h.x,d=f/h.y;for(const[y,g]of a)n.push([y,{...g,position:{x:g.position.x+u,y:g.position.y+d,z:g.position.z}}])}return[...n,...i]},is=(e,o=()=>!0)=>{const t=[],i=[];for(const d of e)o(d)&&Qn(d)?t.push(d):i.push(d);const n=Ce.fromItems(t),s=n.size,{minBounds:r}=n,c=new Map,a=new Map;for(const[,d]of n.iterate())for(const[,y]of d){const g=J(y);a.has(g)||a.set(g,y)}for(const[d]of a)c.set(d,Array.from({length:s.x},()=>Array.from({length:s.y},()=>Array(s.z).fill(!1))));const l=(d,y)=>{const g=H(y),p={x:d.x+g.x-1,y:d.y+g.y-1,z:d.z+g.z-1},T=go(y),A=J(y),I=new Set;I.add(y);const R=b=>{const E=new Set;let k=!1;for(let{x}=d;x<=b.x;x++)for(let{y:w}=d;w<=b.y;w++)for(let{z:v}=d;v<=b.z;v++){const _=n.get({x,y:w,z:v});let te=!1,de=!1;if(_)for(const[,L]of _)J(L)===A?(te=!0,E.add(L)):yo(L)&&L.type!=="wall"&&(de=!0);de&&!te&&(k=!0),(!_||_.size===0)&&(k=!0),te||(k=!0)}if(k)return!1;let F=!1;for(const x of E)I.has(x)||(F=!0,I.add(x));if(!F)return!1;for(const x of E){const w=H(x),v={x:x.position.x+w.x-1,y:x.position.y+w.y-1,z:x.position.z+w.z-1};if(x.position.x<d.x||x.position.y<d.y||x.position.z<d.z||v.x>b.x||v.y>b.y||v.z>b.z)return!1}return!0};let z=!0;for(;z;){if(z=!1,T.x>0&&p.x+1<r.x+s.x){let b=p.x;for(let{y:E}=d;E<=p.y;E++)for(let{z:k}=d;k<=p.z;k++){const F=n.get({x:p.x+1,y:E,z:k});if(F){for(const[,x]of F)if(J(x)===A){const w=H(x),v=x.position.x+w.x-1;b=Math.max(b,v)}}}b>p.x&&R({...p,x:b})&&(p.x=b,z=!0)}if(T.y>0&&p.y+1<r.y+s.y){let b=p.y;for(let{x:E}=d;E<=p.x;E++)for(let{z:k}=d;k<=p.z;k++){const F=n.get({x:E,y:p.y+1,z:k});if(F){for(const[,x]of F)if(J(x)===A){const w=H(x),v=x.position.y+w.y-1;b=Math.max(b,v)}}}b>p.y&&R({...p,y:b})&&(p.y=b,z=!0)}if(T.z>0&&p.z+1<r.z+s.z){let b=p.z;for(let{x:E}=d;E<=p.x;E++)for(let{y:k}=d;k<=p.y;k++){const F=n.get({x:E,y:k,z:p.z+1});if(F){for(const[,x]of F)if(J(x)===A){const w=H(x),v=x.position.z+w.z-1;b=Math.max(b,v)}}}b>p.z&&R({...p,z:b})&&(p.z=b,z=!0)}}return p},f=(d,y)=>{if(d.type==="wall"){if(y.type!=="wall")throw new Error("only walls can join walls");if(d.config.direction!==y.config.direction)throw new Error("walls must have the same direction to join");return d.config.direction==="right"||d.config.direction==="towards"?d:{...d,config:{...d.config,tiles:[...d.config.tiles,...y.config.tiles]}}}return d},u=({x:d,y,z:g},{x:p,y:T,z:A},I)=>{const[R,z]=I,b=J(z),E=p-d+1,k=T-y+1,F=A-g+1;let x=z;if(E+k+F>3){const w={...z.config};if(z.type==="wall")switch(z.config.direction){case"away":case"left":break;case"towards":E!==1&&(w.times={x:E});break;case"right":k!==1&&(w.times={y:k});break}else{const v={...ht(H(z))};E!==1&&(v.x=E),k!==1&&(v.y=k),F!==1&&(v.z=F),w.times=v}x={...z,config:w}}for(let w=d;w<=p;w++)for(let v=y;v<=T;v++)for(let _=g;_<=A;_++)if(c.get(b)[w-r.x][v-r.y][_-r.z]=!0,w!==d||v!==y||_!==g){const te=n.get({x:w,y:v,z:_});if(te)e:for(const de of te){const[,L]=de;if(J(L)===b){L.position.x===w&&L.position.y===v&&L.position.z===_&&(x=f(x,L)),n.remove({x:w,y:v,z:_},de);break e}}}return[R,x]};for(const[d,y]of n.iterate())for(const g of y){const[,p]=g;if(p.position.x===d.x&&p.position.y===d.y&&p.position.z===d.z){const T=J(p),A=c.get(T),I=d.x-r.x,R=d.y-r.y,z=d.z-r.z;if(A&&!A[I][R][z]){const b=l(d,p),E=u(d,b,g);n.remove(d,g),n.add(d,E)}}}return[...n.extractUniqueItems(),...i]},po=(e,o)=>Object.fromEntries(ts(Object.entries(e),o)),ns=e=>e[Math.floor(Math.random()*e.length)],zt=(e,o)=>{e.planet=o;for(const t of Object.values(e.items))t.type==="floor"&&t.config.floorType==="standable"&&(t.config.scenery=o),t.type==="wall"&&(t.config.direction==="away"||t.config.direction==="left")&&(t.config.tiles=Array.from(fe(o,t.config.tiles.length))),t.type==="pickup"&&t.config.gives==="crown"&&Ht.includes(o)&&(t.config.planet=o)},ss={x:8,y:8},rs=(e,o,t,i,n)=>{const s={};for(const f of n){const u={x:f.x*o.x,y:f.y*o.y},d=ut(o);for(const[y,g]of Object.entries(d.items)){const p=`${y}_${f.x}_${f.y}`;s[p]={...g,position:{x:g.position.x+u.x,y:g.position.y+u.y,z:g.position.z}}}}const r=new Set;for(const f of n){const u=n.some(y=>y.x===f.x+1&&y.y===f.y),d=n.some(y=>y.x===f.x&&y.y===f.y+1);u&&(r.add(`leftWall_${f.x}_${f.y}`),r.add(`rightWall_${f.x+1}_${f.y}`)),d&&(r.add(`awayWall_${f.x}_${f.y}`),r.add(`towardsWall_${f.x}_${f.y+1}`))}for(const f of r)delete s[f];const c=po(s),a=n.length>1?Object.fromEntries(n.map((f,u)=>[u.toString(),{gridPosition:f,physicalPosition:{from:{x:f.x*o.x,y:f.y*o.y},to:{x:(f.x+1)*o.x-1,y:(f.y+1)*o.y-1}}}])):void 0,l={id:e,planet:"blacktooth",color:t,items:c,...a&&{meta:{subRooms:a}}};return zt(l,i),l},mo=({state:e,scenery:o,maybeColour:t,roomSize:i=ss,gridPositions:n=[{x:0,y:0}]})=>{const r=`room_${Y(Yt({start:0})).find(l=>e.campaignInProgress.rooms[`room_${l}`]===void 0)}`,c=t??{hue:ns(Lt),shade:Math.random()<.66?"basic":"dimmed"},a=rs(r,i,c,o,n);return e.campaignInProgress.rooms[r]=a,a},Ae=(e,o,t=!1)=>{if(!e.campaignInProgress.rooms[o]){console.warn(`can't change to room ${o} - it doesn't exist`);return}t||e.editingRoomIdHistory.back.push(e.currentlyEditingRoomId),e.currentlyEditingRoomId=o,e.clickableAnnotationHovered=!1,e.hoveredItem=void 0,e.selectedJsonItemIds=[],t||(e.history=co.history)},as={addRoom(e,{payload:{roomSize:o,gridPositions:t=[{x:0,y:0}]}}){const{planet:i}=O(e),n=mo({state:e,scenery:i,roomSize:o,gridPositions:t});Ae(e,n.id)},removeRoom(e){const o=e.campaignInProgress.rooms[e.currentlyEditingRoomId],i=Ve(q(o.items,"door","teleporter"))?.[1].config.toRoom??Ve(gi(n=>n!==e.currentlyEditingRoomId,Vt(e.campaignInProgress.rooms)));i===void 0||i===uo||(delete e.campaignInProgress.rooms[e.currentlyEditingRoomId],e.currentlyEditingRoomId=i)}},Pe=(e,o,t,i)=>o.some(n=>n.config.direction===e)?"doorway":t===void 0?"wall":Object.values(t).some(({gridPosition:n})=>Gt($[e],nt(n,i)))?"open":"wall";function*ne(e){try{yield*cs(e)}catch(o){const t=o;throw new Error(`
  error in recursion ${e.roomId}/${e.subRoomId??"*"}`,{cause:t})}}function*cs({roomId:e,subRoomId:o="*",campaign:t,visited:i={},vectorFromPrevious:n,previousRoomGridPosition:s=P}){if(e==="nowhere"||i[e]?.[o])return;i[e]===void 0&&(i[e]={}),i[e][o]=!0;const r=t.rooms[e];if(r===void 0)throw new Error(`no room in the campaign with id="${e}"`);const c=[...Y(ce(r.items)).filter(y=>y.type==="door").filter(y=>ro(y.position,"block",r)===o)],a=m(s,n===void 0?qt:n),l=r.meta?.subRooms;if(l){if(o==="*")throw new Error(`subRoomId '*' means 'all' and is not allowed for big rooms. Must be one of the sub-rooms in ${e}: ${Object.keys(l)}`);if(!l[o])throw new Error(`Sub-room ${o} not found in room ${e}. Available sub-rooms: ${Object.keys(l)}`)}const f=l?.[o].gridPosition,u={left:Pe("left",c,l,f),right:Pe("right",c,l,f),away:Pe("away",c,l,f),towards:Pe("towards",c,l,f)};if(yield{roomId:e,subRoomId:o,gridPosition:a,boundaries:u},l!==void 0){if(f===void 0)throw new Error(`Sub-room ${o} not found in room ${e}. Available sub-rooms: ${Object.keys(l)}`);for(const[y,{gridPosition:g}]of Y(no(l)))y!==o&&(yield*ne({roomId:e,subRoomId:y,campaign:t,visited:i,vectorFromPrevious:Te({...g,z:0},f),previousRoomGridPosition:a}))}if(r.roomAbove!==void 0){const{roomAbove:y,subRoomAbove:g}=r;yield*ne({roomId:y,subRoomId:g,campaign:t,visited:i,vectorFromPrevious:$.up,previousRoomGridPosition:a})}if(r.roomBelow!==void 0){const{roomBelow:y,subRoomBelow:g}=r;yield*ne({roomId:y,subRoomId:g,campaign:t,visited:i,vectorFromPrevious:$.down,previousRoomGridPosition:a})}for(const y of c){const{toRoom:g}=y.config;if(g!==uo)try{yield*ne({roomId:g,campaign:t,visited:i,subRoomId:y.config.meta?.toSubRoom,vectorFromPrevious:$[y.config.direction],previousRoomGridPosition:a})}catch(p){throw new Error(`error while traversing door ${JSON.stringify(y,null,2)} in room ${e} to room ${g}`,{cause:p})}}const d=r.meta?.nonContiguousRelationship;if(d!==void 0){const{with:{room:y},gridOffset:g}=d;yield*ne({roomId:y,campaign:t,visited:i,subRoomId:"*",vectorFromPrevious:g,previousRoomGridPosition:a})}}const Rt=(e,o)=>{for(let t=1;;t++){const i=t===1?o:`${o}_${t}`;if(!e.items[i])return i}},kt=(e,o,t)=>{if(o.type==="player"){const{which:n}=o.config;return t?`preview-${n}`:n}const i=o.type==="monster"?o.config.which:o.type;return Rt(e,i)},Ze=(e,o,t,i)=>{const n=O(e),s=kt(n,o,i),r=Et(e,i),c={type:o.type,config:o.config,position:t};return r[s]=c,[s,c]},Et=(e,o,t=e.currentlyEditingRoomId)=>o?e.previewedEdits:e.campaignInProgress.rooms[t].items;function*Pt(e,o,t){for(const i of no(e)){const[n,s]=i;if(s===null||s.type!=="wall"||s.config.direction!==o)continue;const{position:r,config:c}=s,a=fn(oe(c)),l=oo(Le(c.direction)),f=Le(c.direction),u=Te(t,r);if(u[f]!==0||u[l]<-1||u[l]>=a[l])continue;if(u[l]===0&&a[l]===2){yield[n,null];continue}const d=2+u[l];if(d===1||d===2){const I=se(s,R=>{R.position=m(r,{[l]:d});const z=R.config;switch(z.direction){case"towards":case"right":z.times[l]=a[l]-d;break;default:z.tiles=z.tiles.slice(d)}});yield[n,I];continue}const g=a[l]-u[l];if(g===2||g===1){const I=se(s,R=>{const z=R.config;switch(z.direction){case"towards":case"right":z.times[l]=a[l]-g;break;default:z.tiles=z.tiles.slice(0,-g)}});yield[n,I];continue}const T=se(s,I=>{const R=I.config;switch(R.direction){case"towards":case"right":R.times[l]=u[l];break;default:R.tiles=R.tiles.slice(0,u[l])}});yield[`${n}/beforeDoor`,T];const A=se(s,I=>{I.position={...r,[l]:t[l]+2};const R=I.config;switch(R.direction){case"towards":case"right":R.times[l]=a[l]-u[l]-2;break;default:R.tiles=R.tiles.slice(u[l]+2)}});yield[`${n}/afterDoor`,A],yield[n,null]}}const At=(e,o,t,i,n)=>{const s=Ue(e,o);if(s===void 0)throw new Error("can't cut hole in walls for a room that does not exist");const r=Et(e,n,o);for(const[c,a]of Pt(s.items,t,i))n?r[c]=a:a===null?delete r[c]:r[c]=a},ls=({state:e,fromRoomJson:o,subRoomId:t,direction:i,isPreview:n,autoAddRooms:s})=>{const r=e.campaignInProgress,c=ne({campaign:r,roomId:o.id,subRoomId:t}),a=Y(c).find(({gridPosition:l})=>Jt(l,$[i]));if(a)return r.rooms[a.roomId];if(!n)return s?mo({state:e,scenery:o.planet}):void 0},ds=e=>q(e.items,"floor").reduce((o,[,t])=>{const i=t.position.y;return Math.min(o,i)},Number.POSITIVE_INFINITY),fs=e=>q(e.items,"floor").reduce((o,[,t])=>{const i=t.position.y+t.config.times.y;return Math.max(o,i)},Number.NEGATIVE_INFINITY),us=e=>q(e.items,"floor").reduce((o,[,t])=>{const i=t.position.x;return Math.min(o,i)},Number.POSITIVE_INFINITY),ys=e=>q(e.items,"floor").reduce((o,[,t])=>{const i=t.position.x+t.config.times.x;return Math.max(o,i)},Number.NEGATIVE_INFINITY),Ct=({state:e,fromRoomJson:o,toRoomJson:t,outgoingDoorEntry:[i,n]})=>{const s=n.config.direction,r=n.position,c=ro(n.position,"block",o),a=Rt(t,"door"),l={x:s==="left"?us(t):s==="right"?ys(t):r.x,y:s==="away"?ds(t):s==="towards"?fs(t):r.y,z:r.z},f=at(s),u={type:"door",config:{toRoom:o.id,direction:f,meta:c==="*"?void 0:{toSubRoom:c}},position:l};t.items[a]=u,u.config.toDoor=i,n.config.toDoor=a,At(e,t.id,f,l,!1)},gs=(e,o,t,i,n)=>{const s=O(e),r=t;At(e,s.id,r,o,n);const c=i.config.toRoom==="+",a=ro(o,"block",s),l=ls({state:e,fromRoomJson:s,subRoomId:a,direction:r,isPreview:n,autoAddRooms:c}),[f,u]=Ze(e,{type:"door",config:{...i.config,toRoom:l?l.id:i.config.toRoom,direction:r}},o,n);!n&&l&&Ct({state:e,fromRoomJson:s,toRoomJson:l,outgoingDoorEntry:[f,u]})},Qe=(e,o)=>{const t=O(e);t.items=po(t.items,o);const i=e.selectedJsonItemIds.filter(n=>t.items[n]!==void 0);i.length!==e.selectedJsonItemIds.length&&(e.selectedJsonItemIds=i)},et=e=>{const o=e,t=O(o).items;o.selectedJsonItemIds=o.selectedJsonItemIds.filter(i=>i in t)},ps={setSelectedItemsInRoom(e,{payload:{jsonItemIds:o}}){const t=O(e).items;o.forEach(i=>{if(!t[i])throw new Error(`Item with json item id "${i}" is not in the current room`)}),e.selectedJsonItemIds=o},toggleSelectedItemInRoom(e,{payload:{jsonItemId:o}}){const t=e.selectedJsonItemIds.indexOf(o);t===-1?e.selectedJsonItemIds.push(o):e.selectedJsonItemIds.splice(t,1)},setHoveredItemInRoom(e,o){e.hoveredItem=o.payload},setClickableAnnotationHovered(e,o){e.clickableAnnotationHovered=o.payload}},ee=e=>{const o=structuredClone(V(O(e))),{history:t}=e;t.redo=[],t.undo.push(o)},ms={undo(e){const o=e,{campaignInProgress:t,history:{undo:i,redo:n},currentlyEditingRoomId:s}=o;i.length!==0&&(n.push(t.rooms[s]),t.rooms[s]=i.pop(),et(o))},redo(e){const o=e,{campaignInProgress:t,history:{redo:i,undo:n},currentlyEditingRoomId:s}=o;i.length!==0&&(n.push(t.rooms[s]),t.rooms[s]=i.pop(),et(o))}},hs={selectCanUndo:e=>e.history.undo.length>0,selectCanRedo:e=>e.history.redo.length>0},xs=e=>e.type==="door",bs=e=>e.type==="monster"&&e.config.which==="cyberman",ws={applyItemTool(e,{payload:{blockPosition:o,pointedAtItemJson:t,preview:i}}){const n=e,{tool:s}=n;if(s.type!=="item")throw new Error("applying item tool reducer while the current tool is not an item tool");switch(i||(ee(n),n.previewedEdits={}),n.selectedJsonItemIds=[],!0){case xs(s.item):{if(t.type!=="wall")throw new Error("doors can only be added on walls");gs(n,o,t.config.direction,s.item,i);break}case(bs(s.item)&&t.type==="deadlyBlock"&&t.config.style==="toaster"&&t.position.z+1===o.z):{Ze(n,{...s.item,config:{...s.item.config,activated:"off"}},o,i);break}default:Ze(n,s.item,o,i)}i||(n.autoCoalesce?Qe(n):Qe(n,r=>r.type==="wall"))}},vs={setCampaignName(e,{payload:o}){const t=e;t.campaignInProgress.locator.campaignName=o},setCampaignUserId(e,{payload:o}){const t=e;t.campaignInProgress.locator.userId=o},setCampaignPublished(e,{payload:o}){const t=e;t.campaignInProgress.meta===void 0?t.campaignInProgress.meta={published:!1}:t.campaignInProgress.meta.published=o}},Is={changeToRoom(e,{payload:o}){Ae(e,o)},roomBack(e){const o=e,{editingRoomIdHistory:t}=o;if(t.back.length===0)return;const i=t.back.pop();t.forward.push(o.currentlyEditingRoomId),Ae(o,i,!0)},roomForward(e){const o=e,{editingRoomIdHistory:t}=o;if(t.forward.length===0)return;const i=t.forward.pop();t.back.push(o.currentlyEditingRoomId),Ae(o,i,!0)}},zs={changeDragInProgress(e,{payload:o}){const t=e;t.dragInProgress=o}},Rs={changeGridResolution(e,{payload:o}){const t=e;t.gridResolution=o},changeWallsFloorsLocked(e,{payload:o}){const t=e;t.wallsFloorsLocked=o}},ks=(e,o)=>{const t=e.currentlyEditingRoomId,i=O(e);for(const n of ce(e.campaignInProgress.rooms)){le(n).filter(r=>r.type==="door"||r.type==="teleporter").filter(r=>r.config.toRoom===t).forEach(r=>{r.config.toRoom=o});const s=n.meta?.nonContiguousRelationship?.with;s?.room===t&&(s.room=o)}e.campaignInProgress.rooms[o]={...i,id:o},delete e.campaignInProgress.rooms[t],e.currentlyEditingRoomId=o};function*Tt(e,o){const t={type:"wall",config:bt(e.config.direction)?e.config.direction==="towards"?{direction:e.config.direction,times:{x:2}}:{direction:e.config.direction,times:{y:2}}:{direction:e.config.direction,tiles:[...fe(o.planet,2,e.position[e.config.direction==="away"?"x":"y"])]},position:{...e.position,z:0}};yield[kt(o,t,!1),t]}const Es=(e,o)=>{const t=e.items[o];if(t.type==="door"){for(const[i,n]of Tt(t,e))e.items[i]=n;e.items=po(e.items)}delete e.items[o]},ot=(e,o)=>{le(e).filter(t=>t.type==="floor").filter(t=>t.position.z===0).forEach(t=>{t.config={...t.config,floorType:o,scenery:o==="standable"?e.planet:void 0}})},Ps={changeRoomColour(e,{payload:o}){const t=e,i=t.campaignInProgress.rooms[t.currentlyEditingRoomId].color;ee(t),Object.assign(i,o)},changeRoomScenery(e,{payload:o}){const t=e,i=O(t);ee(t),zt(i,o)},roomJsonEdited(e,{payload:o}){const t=e;ee(t);const{rooms:i}=t.campaignInProgress,n=i[t.currentlyEditingRoomId];i[t.currentlyEditingRoomId]=o;const s=t.selectedJsonItemIds.filter(a=>o.items[a]!==void 0);s.length!==t.selectedJsonItemIds.length&&(t.selectedJsonItemIds=s),o.id!==t.currentlyEditingRoomId&&ks(t,o.id),q(o.items,"door").filter(([a,l])=>n.items[a]?.type==="door").filter(a=>{const[,l]=a;return l.config.toRoom!==uo&&i[l.config.toRoom]!==void 0}).forEach(([a,l])=>{const f=i[l.config.toRoom],u=at(l.config.direction),d=q(f.items,"door").filter(([,y])=>y.config.direction===u).toArray();switch(d.length){case 0:Ct({state:t,outgoingDoorEntry:[a,l],fromRoomJson:o,toRoomJson:f});break;case 1:{const[[,y]]=d;y.config.toRoom=o.id,y.config.toDoor=a;break}}});const r=n.meta?.nonContiguousRelationship,c=o.meta?.nonContiguousRelationship;if(c!==void 0){const a=i[c.with.room];a.meta={...a.meta,nonContiguousRelationship:{with:{room:o.id},gridOffset:eo(c.gridOffset,-1)}}}if(r?.with.room!==void 0&&c?.with.room!==r.with.room){const a=i[r.with.room];a.meta?.nonContiguousRelationship?.with.room===t.currentlyEditingRoomId&&delete a.meta.nonContiguousRelationship}},deleteSelected(e){const o=e,t=O(o);ee(o),o.selectedJsonItemIds.forEach(i=>{Es(t,i)}),o.selectedJsonItemIds=[]},clearRoom(e){const o=e,t=O(o);ee(o);for(const i of je(t.items)){const n=t.items[i];n.type!=="floor"&&n.type!=="wall"&&n.type!=="door"&&(delete t.items[i],o.selectedJsonItemIds=o.selectedJsonItemIds.filter(s=>s!==i))}},setRoomAboveOrBelow(e,{payload:o}){const t=e,i=o.direction==="above"?"roomAbove":"roomBelow",n=i==="roomAbove"?"roomBelow":"roomAbove",s=O(t),r=o.createNew?mo({state:t,scenery:s.planet,maybeColour:s.color}).id:o.roomId,c=s[i]&&Ue(t,s[i]);c?.[n]===t.currentlyEditingRoomId&&(c[n]=void 0),s[i]=r;const a=r&&Ue(t,r);a!==void 0&&(a[n]=s.id),a?ot(i==="roomBelow"?s:a,"none"):ot(i==="roomBelow"?s:c,"standable")}},As=(e,o)=>{const t=rt(o);for(const[i,n]of t)n===null?delete e.items[i]:e.items[i]=n},Cs={setAutoCoalesce(e,o){e.autoCoalesce=o.payload},resetPreviewedEdits(e){e.previewedEdits={}},commitCurrentPreviewedEdits(e){ee(e),As(O(e),e.previewedEdits),e.autoCoalesce&&Qe(e),e.previewedEdits={}}},Ts=(e,...o)=>({x:e(...o.map(t=>t.x)),y:e(...o.map(t=>t.y)),z:e(...o.map(t=>t.z))}),tt=(e,o,t)=>{const i=t-e.length;i>0?e.push(...fe(o,i,e.length)):i<0&&e.splice(t)};function St(e,o){const t=oe(e.config),i=m(o.position,o.config.times);switch(e.config.direction){case"towards":if(e.position.y===o.position.y&&e.position.x>=o.position.x&&e.position.x<i.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:t.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===o.position.x&&t.x===o.config.times.x,wallTouchesFloorEnd:e.position.x+(t.x??1)===i.x};break;case"right":if(e.position.x===o.position.x&&e.position.y>=o.position.y&&e.position.y<i.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:t.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===o.position.y&&t.y===o.config.times.y,wallTouchesFloorEnd:e.position.y+(t.y??1)===i.y};break;case"away":if(e.position.y===o.position.y+o.config.times.y&&e.position.x>=o.position.x&&e.position.x<i.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:t.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===o.position.x&&t.x===o.config.times.x,wallTouchesFloorEnd:e.position.x+(t.x??1)===i.x};break;case"left":if(e.position.x===o.position.x+o.config.times.x&&e.position.y>=o.position.y&&e.position.y<i.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:t.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===o.position.y&&t.y===o.config.times.y,wallTouchesFloorEnd:e.position.y+(t.y??1)===i.y};break}return null}function*Ot(e,o,t,i,n){const s=m(o.position,i),r=o.config.times,c=n?m(r,n):o.config.times,a=m(o.position,r),l=m(s,c);for(const[f,u]of Y(e)){if(u.type==="wall"&&u.position.z!==o.position.z)continue;if(u.type==="door"){const p=u.config;let T=!1,A={...V(u.position)};switch(p.direction){case"towards":u.position.y===o.position.y&&u.position.x>=o.position.x&&u.position.x<o.position.x+r.x&&(T=!0,A=m(u.position,i));break;case"right":u.position.x===o.position.x&&u.position.y>=o.position.y&&u.position.y<o.position.y+r.y&&(T=!0,A=m(u.position,i));break;case"away":u.position.y===o.position.y+r.y&&u.position.x>=o.position.x&&u.position.x<o.position.x+r.x&&(T=!0,A=m(u.position,{x:i.x,y:i.y+(n?.y??0),z:i.z}));break;case"left":u.position.x===o.position.x+r.x&&u.position.y>=o.position.y&&u.position.y<o.position.y+r.y&&(T=!0,A=m(u.position,{x:i.x+(n?.x??0),y:i.y,z:i.z}));break}if(T){const I=structuredClone(V(u));I.position=A,yield[f,I]}continue}const d=u,y=St(d,o);if(!y||!y.isOnFloorEdge)continue;const g=structuredClone(V(d));switch(d.config.direction){case"towards":case"right":g.position=m(d.position,i);break;case"away":{const p=s.y+c.y;g.position={...d.position,x:d.position.x+i.x,y:p};break}case"left":{const p=s.x+c.x;g.position={...d.position,x:p,y:d.position.y+i.y};break}}if(y.wallFullySpansFloor){const p=c[y.tangentAxis];d.config.direction==="away"||d.config.direction==="left"?tt(g.config.tiles,t,p):g.config.times={[y.tangentAxis]:p},yield[f,g]}else{const p=o.position[y.tangentAxis],T=a[y.tangentAxis],A=s[y.tangentAxis],I=l[y.tangentAxis],R=g.position[y.tangentAxis];if(R>=I){yield[f,null];continue}const z=Math.max(y.wallStart,p),E=Math.min(y.wallStart+y.wallLength,T)-z;let k;if(d.config.direction==="away"||d.config.direction==="left"){const v=o.position[y.normalAxis]+r[y.normalAxis],_=s[y.normalAxis]+c[y.normalAxis];k=v!==_}else k=o.position[y.normalAxis]!==s[y.normalAxis];const F=Math.max(R,A);let x;y.wallTouchesFloorEnd&&!k?x=I:x=Math.min(R+E,I);const w=x-F;w<=0?yield[f,null]:(d.config.direction==="away"||d.config.direction==="left"?tt(g.config.tiles,t,w):g.config.times={[y.tangentAxis]:w},yield[f,g])}}}function*Ss(e,o,t,i){for(const[n,s]of q(e.items,"floor")){const r=St(o,s);if(!r)continue;const c={x:0,y:0,z:0},a={x:0,y:0,z:0},l=t[r.normalAxis],f=t[r.tangentAxis],u=i?i[r.tangentAxis]:0;if(l!==0&&(o.config.direction==="towards"||o.config.direction==="right"?(c[r.normalAxis]=l,a[r.normalAxis]=-l):a[r.normalAxis]=l),f!==0&&(r.wallStart===s.position[r.tangentAxis]?(c[r.tangentAxis]=f,a[r.tangentAxis]=-f):r.wallTouchesFloorEnd&&(a[r.tangentAxis]=f)),u!==0&&r.wallTouchesFloorEnd&&(a[r.tangentAxis]=u),c.x!==0||c.y!==0||a.x!==0||a.y!==0){const d=m(s.config.times,a),y={...s,position:m(s.position,c),config:{...s.config,times:{x:d.x,y:d.y}}};yield[n,y]}yield*Ot(q(e.items,"wall","door"),s,e.planet,c,a)}}const Os={moveOrResizeItemAsPreview(e,{payload:{jsonItemIds:o,timesDelta:t,positionDelta:i}}){const n=e,s=O(n);for(const r of o){const c=It(n,r);if(c===void 0)throw new Error(`no json item found for some of the ids in resize ${r}`);if(c.type==="wall"){for(const[l,f]of Ss(s,c,i,t))n.previewedEdits[l]=f;continue}if(c.type==="floor")for(const[l,f]of Ot(q(s.items,"wall","door"),c,s.planet,i,t))n.previewedEdits[l]=f;if(c.type==="door"){console.log("before healing, room items are",V(s.items));for(const[l,f]of Tt(c,V(s)))console.log("healing",`"${l}"`,f),n.previewedEdits[l]=f}const a={...c,position:m(c.position,i),config:{...c.config}};if(n.previewedEdits[r]=a,Fs(a,t),c.type==="door"){console.log("before cutting room plus previews is",{...V(s.items),...V(n.previewedEdits)});for(const[l,f]of Pt({...V(s.items),...V(n.previewedEdits)},a.config.direction,a.position))console.log("cutting",`"${l}"`,f),n.previewedEdits[l]=f}}n.dragInProgress=!0}},Fs=(e,o)=>{if(o!==void 0){const t=H(e),i=go(e),n=Kt(o,i);if(io(n)>0){const s=ht(Ts((r,c)=>Math.max(1,r+c),t,n));s===void 0?delete e.config.times:e.config.times=s}}},$s={loadCampaign(e,{payload:{campaign:o}}){const t=e;t.remoteCampaign=o,t.campaignInProgress=o,t.hoveredItem=void 0,t.selectedJsonItemIds=[],t.clickableAnnotationHovered=!1,t.dragInProgress=!1,t.history=co.history;const i=Y(ce(o.rooms)).find(n=>le(n).some(s=>s.type==="player"&&s.config.which==="head"))?.id??Y(ce(o.rooms)).find(n=>le(n).some(s=>s.type==="player"&&s.config.which==="heels"))?.id??Ve(je(o.rooms));if(i===void 0)throw new Error("could not find any rooms in this campaign");t.currentlyEditingRoomId=i},setRemoteCampaign(e,{payload:{campaign:o}}){const t=e;t.remoteCampaign=o}},Ns=[1,.5,.125],ho=Ut({name:"levelEditor",initialState:co,reducers:{setTool(e,{payload:o}){const t=e;o.type==="item"&&(t.selectedJsonItemIds=[],t.hoveredItem=void 0),t.tool=o},injected(){},...Rs,...ms,...ws,...zs,...ps,...Ps,...Os,...Cs,...$s,...as,...Is,...vs},selectors:{selectCurrentCampaignInProgress:e=>e.campaignInProgress,selectCurrentEditingRoomJson:O,selectItem:It,selectCurrentEditingRoomColour:e=>O(e).color,selectCurrentEditingRoomScenery:e=>O(e).planet,selectTool:e=>e.tool,selectSelectedJsonItemIds:e=>e.selectedJsonItemIds,selectHoveredItem:e=>e.hoveredItem,selectItemIsSelected:Zn,...hs}}),{addRoom:Ws,applyItemTool:Bs,changeDragInProgress:Ms,changeGridResolution:_s,changeRoomColour:Xs,changeRoomScenery:Ds,changeToRoom:Hs,changeWallsFloorsLocked:Ys,clearRoom:Ls,commitCurrentPreviewedEdits:Vs,deleteSelected:qs,injected:Gs,loadCampaign:Js,moveOrResizeItemAsPreview:Ks,redo:Us,removeRoom:Zs,resetPreviewedEdits:Qs,roomBack:js,roomForward:er,roomJsonEdited:or,setAutoCoalesce:tr,setCampaignName:ir,setCampaignPublished:nr,setCampaignUserId:sr,setClickableAnnotationHovered:rr,setHoveredItemInRoom:ar,setRemoteCampaign:cr,setRoomAboveOrBelow:lr,setSelectedItemsInRoom:dr,setTool:fr,toggleSelectedItemInRoom:ur,undo:yr}=ho.actions,{selectCanRedo:gr,selectCanUndo:pr,selectCurrentCampaignInProgress:mr,selectCurrentEditingRoomColour:hr,selectCurrentEditingRoomJson:xr,selectCurrentEditingRoomScenery:br,selectHoveredItem:wr,selectItem:vr,selectItemIsSelected:Ir,selectSelectedJsonItemIds:zr,selectTool:Rr}=ho.selectors,kr=Zt.withTypes(),sa=Object.freeze(Object.defineProperty({__proto__:null,addRoom:Ws,applyItemTool:Bs,changeDragInProgress:Ms,changeGridResolution:_s,changeRoomColour:Xs,changeRoomScenery:Ds,changeToRoom:Hs,changeWallsFloorsLocked:Ys,clearRoom:Ls,commitCurrentPreviewedEdits:Vs,deleteSelected:qs,gridResolutions:Ns,injected:Gs,levelEditorSlice:ho,loadCampaign:Js,moveOrResizeItemAsPreview:Ks,redo:Us,removeRoom:Zs,resetPreviewedEdits:Qs,roomBack:js,roomForward:er,roomJsonEdited:or,selectCanRedo:gr,selectCanUndo:pr,selectCurrentCampaignInProgress:mr,selectCurrentEditingRoomColour:hr,selectCurrentEditingRoomJson:xr,selectCurrentEditingRoomScenery:br,selectHoveredItem:wr,selectItem:vr,selectItemIsSelected:Ir,selectSelectedJsonItemIds:zr,selectTool:Rr,setAutoCoalesce:tr,setCampaignName:ir,setCampaignPublished:nr,setCampaignUserId:sr,setClickableAnnotationHovered:rr,setHoveredItemInRoom:ar,setRemoteCampaign:cr,setRoomAboveOrBelow:lr,setSelectedItemsInRoom:dr,setTool:fr,toggleSelectedItemInRoom:ur,undo:yr,useAppSelectorWithLevelEditorSlice:kr},Symbol.toStringTag,{value:"Module"}));export{Ge as $,Ts as A,vr as B,Ir as C,dr as D,yo as E,Ks as F,cn as G,ur as H,Vs as I,Fi as J,Br as K,Jn as L,Un as M,Rr as N,Ms as O,na as P,Hs as Q,kr as R,W as S,Jr as T,Vr as U,qr as V,Ki as W,Ur as X,Ni as Y,Mr as Z,zi as _,sn as a,yr as a$,Dr as a0,Qi as a1,oa as a2,X as a3,Ii as a4,Kr as a5,K as a6,Or as a7,Tr as a8,Sr as a9,tr as aA,js as aB,er as aC,Ls as aD,O as aE,or as aF,qs as aG,Ns as aH,_s as aI,Fs as aJ,wt as aK,gi as aL,Yr as aM,mr as aN,lr as aO,br as aP,Ds as aQ,ct as aR,Si as aS,Wr as aT,ir as aU,nr as aV,sr as aW,cr as aX,Js as aY,pr as aZ,gr as a_,Fr as aa,$r as ab,uo as ac,rr as ad,zr as ae,C as af,Gr as ag,Yi as ah,vi as ai,so as aj,Lr as ak,ia as al,Qt as am,ii as an,Ti as ao,Hr as ap,Nr as aq,bi as ar,Cr as as,ro as at,xr as au,ne as av,hr as aw,Xs as ax,Ws as ay,Zs as az,an as b,Us as b0,Ys as b1,fe as b2,sa as b3,rn as c,Zr as d,Qr as e,jr as f,qe as g,_r as h,re as i,h as j,ar as k,It as l,fr as m,Xr as n,Oi as o,ea as p,fn as q,ta as r,wr as s,ze as t,$ as u,Qs as v,oe as w,Bs as x,H as y,go as z};
