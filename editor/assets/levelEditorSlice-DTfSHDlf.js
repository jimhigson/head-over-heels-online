import{a5 as C,a6 as ee,a7 as L,a8 as A,a9 as B,aa as x,ab as z,ac as Be,ad as to,ae as W,af as je,ag as Ge,ah as ro,ai as no,aj as io,ak as so,al as ao,am as q,an as co,ao as be,ap as j,aq as lo,ar as fo,as as De,at as Ne,au as uo,av as Ue,aw as yo,ax as mo,ay as po}from"./index-DKV3Ax6I.js";var G={},D={},Re;function go(){if(Re)return D;Re=1;function e(l,m){var r;if(typeof Symbol>"u"||l[Symbol.iterator]==null){if(Array.isArray(l)||(r=o(l))||m){r&&(l=r);var s=0,i=function(){};return{s:i,n:function(){return s>=l.length?{done:!0}:{done:!1,value:l[s++]}},e:function(u){throw u},f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var c=!0,y=!1,p;return{s:function(){r=l[Symbol.iterator]()},n:function(){var u=r.next();return c=u.done,u},e:function(u){y=!0,p=u},f:function(){try{!c&&r.return!=null&&r.return()}finally{if(y)throw p}}}}function o(l,m){if(l){if(typeof l=="string")return t(l,m);var r=Object.prototype.toString.call(l).slice(8,-1);if(r==="Object"&&l.constructor&&(r=l.constructor.name),r==="Map"||r==="Set")return Array.from(l);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return t(l,m)}}function t(l,m){(m==null||m>l.length)&&(m=l.length);for(var r=0,s=new Array(m);r<m;r++)s[r]=l[r];return s}var n=C(),a=n.ensureIterable;function d(l){var m=[],r=e(l),s;try{for(r.s();!(s=r.n()).done;){var i=s.value;m.push(i)}}catch(c){r.e(c)}finally{r.f()}return m}D.__toArray=d;function f(l){return d(a(l))}return D.toArray=f,D}var Ee;function ho(){if(Ee)return G;Ee=1;var e=ee(),o=e.mark(f),t=C(),n=t.iterableCurry,a=go(),d=a.__toArray;function f(m,r){var s;return e.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(s=Array.isArray(m)?m:d(m),s.length){c.next=3;break}return c.abrupt("return");case 3:if(!r--){c.next=7;break}return c.delegateYield(s,"t0",5);case 5:c.next=3;break;case 7:case"end":return c.stop()}},o)}G.__cycleTimes=f;var l=n(f);return G.cycleTimes=l,G}var N={},Ae;function vo(){if(Ae)return N;Ae=1;var e=ee(),o=e.mark(l);function t(r,s){var i;if(typeof Symbol>"u"||r[Symbol.iterator]==null){if(Array.isArray(r)||(i=n(r))||s){i&&(r=i);var c=0,y=function(){};return{s:y,n:function(){return c>=r.length?{done:!0}:{done:!1,value:r[c++]}},e:function(v){throw v},f:y}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,h=!1,u;return{s:function(){i=r[Symbol.iterator]()},n:function(){var v=i.next();return p=v.done,v},e:function(v){h=!0,u=v},f:function(){try{!p&&i.return!=null&&i.return()}finally{if(h)throw u}}}}function n(r,s){if(r){if(typeof r=="string")return a(r,s);var i=Object.prototype.toString.call(r).slice(8,-1);if(i==="Object"&&r.constructor&&(i=r.constructor.name),i==="Map"||i==="Set")return Array.from(r);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return a(r,s)}}function a(r,s){(s==null||s>r.length)&&(s=r.length);for(var i=0,c=new Array(s);i<s;i++)c[i]=r[i];return c}var d=C(),f=d.iterableCurry;function l(r,s){var i,c,y,p;return e.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:i=0,c=t(r),u.prev=2,c.s();case 4:if((y=c.n()).done){u.next=11;break}if(p=y.value,!s(p,i++)){u.next=9;break}return u.next=9,p;case 9:u.next=4;break;case 11:u.next=16;break;case 13:u.prev=13,u.t0=u.catch(2),c.e(u.t0);case 16:return u.prev=16,c.f(),u.finish(16);case 19:case"end":return u.stop()}},o,null,[[2,13,16,19]])}N.__filter=l;var m=f(l);return N.filter=m,N}var U={},ke;function wo(){if(ke)return U;ke=1;var e=C(),o=e.iterableCurry,t=ho(),n=t.__cycleTimes;function a(f){return n(f,1/0)}U.__cycle=a;var d=o(a);return U.cycle=d,U}var X={},Se;function Io(){if(Se)return X;Se=1;var e=ee(),o=e.mark(l);function t(r,s){var i;if(typeof Symbol>"u"||r[Symbol.iterator]==null){if(Array.isArray(r)||(i=n(r))||s){i&&(r=i);var c=0,y=function(){};return{s:y,n:function(){return c>=r.length?{done:!0}:{done:!1,value:r[c++]}},e:function(v){throw v},f:y}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,h=!1,u;return{s:function(){i=r[Symbol.iterator]()},n:function(){var v=i.next();return p=v.done,v},e:function(v){h=!0,u=v},f:function(){try{!p&&i.return!=null&&i.return()}finally{if(h)throw u}}}}function n(r,s){if(r){if(typeof r=="string")return a(r,s);var i=Object.prototype.toString.call(r).slice(8,-1);if(i==="Object"&&r.constructor&&(i=r.constructor.name),i==="Map"||i==="Set")return Array.from(r);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return a(r,s)}}function a(r,s){(s==null||s>r.length)&&(s=r.length);for(var i=0,c=new Array(s);i<s;i++)c[i]=r[i];return c}var d=C(),f=d.iterableCurry;function l(r,s){var i,c,y,p;return e.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:i=0,c=t(r),u.prev=2,c.s();case 4:if((y=c.n()).done){u.next=11;break}if(p=y.value,!(i++>=s)){u.next=9;break}return u.next=9,p;case 9:u.next=4;break;case 11:u.next=16;break;case 13:u.prev=13,u.t0=u.catch(2),c.e(u.t0);case 16:return u.prev=16,c.f(),u.finish(16);case 19:case"end":return u.stop()}},o,null,[[2,13,16,19]])}X.__drop=l;var m=f(l);return X.drop=m,X}var V={},K={},Ce;function xo(){if(Ce)return K;Ce=1;var e=C(),o=e.iterableCurry,t=e.callReturn;function n(d,f){var l=d[Symbol.iterator](),m=l.next(),r=m.value,s=m.done;return s?f:(t(l),r)}K.__firstOr=n;var a=o(n,{reduces:!0});return K.firstOr=a,K}var Pe;function bo(){if(Pe)return V;Pe=1;var e=C(),o=e.iterableCurry,t=xo(),n=t.__firstOr;function a(f){return n(f,void 0)}V.__first=a;var d=o(a,{reduces:!0});return V.first=d,V}var Y={},Te;function Ro(){if(Te)return Y;Te=1;var e=ee(),o=e.mark(l);function t(r,s){var i;if(typeof Symbol>"u"||r[Symbol.iterator]==null){if(Array.isArray(r)||(i=n(r))||s){i&&(r=i);var c=0,y=function(){};return{s:y,n:function(){return c>=r.length?{done:!0}:{done:!1,value:r[c++]}},e:function(v){throw v},f:y}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var p=!0,h=!1,u;return{s:function(){i=r[Symbol.iterator]()},n:function(){var v=i.next();return p=v.done,v},e:function(v){h=!0,u=v},f:function(){try{!p&&i.return!=null&&i.return()}finally{if(h)throw u}}}}function n(r,s){if(r){if(typeof r=="string")return a(r,s);var i=Object.prototype.toString.call(r).slice(8,-1);if(i==="Object"&&r.constructor&&(i=r.constructor.name),i==="Map"||i==="Set")return Array.from(r);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return a(r,s)}}function a(r,s){(s==null||s>r.length)&&(s=r.length);for(var i=0,c=new Array(s);i<s;i++)c[i]=r[i];return c}var d=C(),f=d.iterableCurry;function l(r,s){var i,c,y,p;return e.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:if(s!==0){u.next=2;break}return u.abrupt("return");case 2:i=0,c=t(r),u.prev=4,c.s();case 6:if((y=c.n()).done){u.next=14;break}return p=y.value,u.next=10,p;case 10:if(++i!==s){u.next=12;break}return u.abrupt("break",14);case 12:u.next=6;break;case 14:u.next=19;break;case 16:u.prev=16,u.t0=u.catch(4),c.e(u.t0);case 19:return u.prev=19,c.f(),u.finish(19);case 22:case"end":return u.stop()}},o,null,[[4,16,19,22]])}Y.__take=l;var m=f(l);return Y.take=m,Y}var te,ze;function Eo(){return ze||(ze=1,te=wo().cycle),te}var Ao=Eo();const ko=L(Ao);var re,Fe;function So(){return Fe||(Fe=1,re=Io().drop),re}var Co=So();const Po=L(Co);var ne,Oe;function To(){return Oe||(Oe=1,ne=vo().filter),ne}var zo=To();const Fo=L(zo);var ie,$e;function Oo(){return $e||($e=1,ie=bo().first),ie}var $o=Oo();const fe=L($o);var se,_e;function _o(){return _e||(_e=1,se=Ro().take),se}var Wo=_o();const qo=L(Wo),R=e=>e.campaignInProgress.rooms[e.currentlyEditingRoomId],ue=(e,o)=>e.campaignInProgress.rooms[o],Xe=(e,o,t)=>e.campaignInProgress.rooms[t??e.currentlyEditingRoomId]?.items[o],Mo=(e,o)=>e.selectedJsonItemIds.includes(o),_=e=>{const o=structuredClone(A(R(e))),{history:t}=e;t.redo=[],t.undo.push(o)},Jo={undo(e){const o=e,{campaignInProgress:t,history:{undo:n,redo:a},currentlyEditingRoomId:d}=o;n.length!==0&&(a.push(t.rooms[d]),t.rooms[d]=n.pop())},redo(e){const o=e,{campaignInProgress:t,history:{redo:n,undo:a},currentlyEditingRoomId:d}=o;n.length!==0&&(a.push(t.rooms[d]),t.rooms[d]=n.pop())}},Lo={selectCanUndo:e=>e.history.undo.length>0,selectCanRedo:e=>e.history.redo.length>0},ae={x:1,y:0,z:0},ce={x:-1,y:0,z:0},le={x:0,y:-1,z:0},de={x:0,y:1,z:0},M={away:de,left:ae,right:ce,towards:le,down:{x:0,y:0,z:-1},up:{x:0,y:0,z:1},awayRight:B(x(de,ce)),towardsRight:B(x(le,ce)),towardsLeft:B(x(le,ae)),awayLeft:B(x(de,ae))},Ho=(e,o,t)=>{if(o==="*")return!0;const n=t.meta.subRooms[o];return e.x>=n.physicalPosition.from.x&&e.y>=n.physicalPosition.from.y&&e.x<=n.physicalPosition.to.x&&e.y<=n.physicalPosition.to.y},Bo=({position:e},o,t)=>Ho(e,o,t),Q=(e,o,t,n)=>o.some(a=>a.config.direction===e)?"doorway":t===void 0?"wall":Object.values(t).some(({gridPosition:a})=>ro(M[e],no(a,n)))?"open":"wall";function*$(e){try{yield*jo(e)}catch(o){const t=o;throw new Error(`
  error in recursion ${e.roomId}/${e.subRoomId??"*"} ---found--v 
 ${t.message}`,{cause:t})}}function*jo({roomId:e,subRoomId:o="*",campaign:t,visited:n={},vectorFromPrevious:a,previousRoomGridPosition:d=W}){if(n[e]?.[o])return;n[e]===void 0&&(n[e]={}),n[e][o]=!0;const f=t.rooms[e];if(f===void 0)throw new Error(`no room in the campaign with id="${e}"`);const l=[...z(Be(f.items)).filter(y=>y.type==="door").filter(y=>Bo(y,o,f))],m=x(d,a===void 0?to:a),r=f.meta?.subRooms;if(r){if(o==="*")throw new Error(`subRoomId '*' means 'all' and is not allowed for big rooms. Must be one of the sub-rooms in ${e}: ${Object.keys(r)}`);if(!r[o])throw new Error(`Sub-room ${o} not found in room ${e}. Available sub-rooms: ${Object.keys(r)}`)}const s=r?.[o].gridPosition,i={left:Q("left",l,r,s),right:Q("right",l,r,s),away:Q("away",l,r,s),towards:Q("towards",l,r,s)};if(yield{roomId:e,subRoomId:o,gridPosition:m,boundaries:i},r!==void 0){if(s===void 0)throw new Error(`Sub-room ${o} not found in room ${e}. Available sub-rooms: ${Object.keys(r)}`);for(const[y,{gridPosition:p}]of z(je(r)))y!==o&&(yield*$({roomId:e,subRoomId:y,campaign:t,visited:n,vectorFromPrevious:Ge({...p,z:0},s),previousRoomGridPosition:m}))}if(f.roomAbove!==void 0){const{roomAbove:y,subRoomAbove:p}=f;yield*$({roomId:y,subRoomId:p,campaign:t,visited:n,vectorFromPrevious:M.up,previousRoomGridPosition:m})}if(f.roomBelow!==void 0){const{roomBelow:y,subRoomBelow:p}=f;yield*$({roomId:y,subRoomId:p,campaign:t,visited:n,vectorFromPrevious:M.down,previousRoomGridPosition:m})}for(const y of l){const{toRoom:p}=y.config;yield*$({roomId:p,campaign:t,visited:n,subRoomId:y.config.meta?.toSubRoom,vectorFromPrevious:M[y.config.direction],previousRoomGridPosition:m})}const c=f.meta?.nonContiguousRelationship;if(c!==void 0){const{with:{room:y},gridOffset:p}=c;yield*$({roomId:y,campaign:t,visited:n,subRoomId:"*",vectorFromPrevious:p,previousRoomGridPosition:m})}}const Go={jail:["bars"],blacktooth:["plain","plain","armour","shield","shield","armour"],bookworld:["book","book","cowboy"],egyptus:["hieroglyphics","hieroglyphics","hieroglyphics","sarcophagus","sarcophagus"],market:["passage","more-fruits","fruits","more-fruits","fruits"],moonbase:["coil","window1","window2","window3"],penitentiary:["loop","loop","skeleton"],safari:["wall","shield","wall","window","window","wall","shield"]},J=(e,o,t=0)=>{const n=ko(Go[e]);return Po(t,qo(o+t,n))},Do=e=>({awayWall:{type:"wall",config:{direction:"away",tiles:Array.from(J("blacktooth",e.x))},position:{x:0,y:e.y,z:0}},leftWall:{type:"wall",config:{direction:"left",tiles:Array.from(J("blacktooth",e.y))},position:{x:e.x,y:0,z:0}},towardsWall:{type:"wall",config:{direction:"towards",times:{x:e.x}},position:{x:0,y:0,z:0}},rightWall:{type:"wall",config:{direction:"right",times:{y:e.y}},position:{x:0,y:0,z:0}}}),Ve=e=>({planet:"blacktooth",color:{hue:"cyan",shade:"basic"},size:e,items:{floor:{type:"floor",config:{floorType:"standable",scenery:"blacktooth",times:e},position:{x:0,y:0,z:0}},...Do(e)}}),Ke=(e,o)=>{e.planet=o;for(const t of Object.values(e.items))t.type==="floor"&&t.config.floorType==="standable"&&(t.config.scenery=o),t.type==="wall"&&(t.config.direction==="away"||t.config.direction==="left")&&(t.config.tiles=Array.from(J(o,t.config.tiles.length))),t.type==="pickup"&&t.config.gives==="crown"&&io.includes(o)&&(t.config.planet=o)},No=e=>e[Math.floor(Math.random()*e.length)],ge=(e,o,t)=>{const a=`room_${z(so({start:0})).find(l=>e.campaignInProgress.rooms[`room_${l}`]===void 0)}`,d=t??{hue:No(ao),shade:Math.random()<.66?"basic":"dimmed"},f={id:a,...structuredClone(Ve({x:8,y:8})),color:d};return Ke(f,o),e.campaignInProgress.rooms[a]=f,f},he=(e,o,t)=>{if(o.type==="player"){const{which:a}=o.config;return t?`preview-${a}`:a}const n=o.type==="monster"?o.config.which:o.type;for(let a=1;;a++){const d=a===1?n:`${n}_${a}`;if(!e.items[d])return d}},ye=(e,o,t,n)=>{const a=R(e),d=he(a,o,n),f=Ye(e,n),l={type:o.type,config:o.config,position:t};return f[d]=l,[d,l]},Ye=(e,o,t=e.currentlyEditingRoomId)=>o?e.previewedEdits:e.campaignInProgress.rooms[t].items,Uo=["head","heels"],Xo=[...Uo,"headOverHeels"],b=(...e)=>o=>e.includes(o.type),Vo=b("bubbles","stopAutowalk","firedDoughnut","floatingText","emitter","particle"),Ko=(e,o)=>Vo(e)||nt(e)&&(o!==void 0&&et(o)||e.config.direction.z!==0)||st(e)&&e.config.floorType==="none",Er=(e,o)=>!Ko(e,o),Yo=["ball","slidingBlock","slidingDeadly"];b(...Yo);const Qo=["portableBlock","spring","sceneryPlayer","sceneryCrown","monster","slidingBlock"],Zo=["dalek","turtle","elephantHead","homingBot","helicopterBug"],Ar=e=>e.type==="slidingBlock"?e.config.style==="puck":e.type==="monster"?Zo.includes(e.config.which):Qo.includes(e.type),et=e=>e.type==="head"||e.type==="heels"||e.type==="headOverHeels";function kr(e){return ot.includes(e.type)}const ot=[...Xo,"monster","ball","charles","pushableBlock","movingPlatform","moveableDeadly","pickup","portableBlock","slidingBlock","slidingDeadly","spring","sceneryPlayer","sceneryCrown"],tt=["monster","deadlyBlock","moveableDeadly","slidingDeadly"];b(...tt);const rt=e=>e.config.times!==void 0,nt=b("portal");b("teleporter");b("heels");b("head");b("heels","headOverHeels");b("head","headOverHeels");b("lift");b("emitter");const it=b("monster"),st=b("floor");b("pickup");b("spring");const Sr=b("joystick");b("monster","movingPlatform");const Cr=e=>it(e)&&e.config.which==="cyberman"&&e.state.everActivated===!1,oe=e=>({x:e.direction==="away"?e.tiles.length:e.direction==="towards"?e.times?.x:1,y:e.direction==="left"?e.tiles.length:e.direction==="right"?e.times?.y:1}),Pr=e=>e.type==="wall"?oe(e.config):rt(e)?e.config.times:void 0,We=(e=q)=>({x:e.x??1,y:e.y??1,z:e.z??1}),at=e=>({x:e.x??1,y:e.y??1}),me=e=>{const o=t=>t.config.times!==void 0;return e.type==="wall"?We(oe(e.config)):o(e)?We(e.config.times):q},ct=e=>{const o={};let t=!1;return e.x!==1&&(o.x=e.x,t=!0),e.y!==1&&(o.y=e.y,t=!0),e.z!==1&&(o.z=e.z,t=!0),t?o:void 0};function*Qe(e,o,t){for(const n of je(e)){const[a,d]=n;if(d===null||d.type!=="wall"||d.config.direction!==o)continue;const{position:f,config:l}=d,m=at(oe(l)),r=co(be(l.direction)),s=be(l.direction),i=Ge(t,f);if(i[s]!==0||i[r]<-1||i[r]>=m[r])continue;if(i[r]===0&&m[r]===2){yield[a,null];continue}const c=2+i[r];if(c===1||c===2){const v=j(d,w=>{w.position=x(f,{[r]:c});const I=w.config;switch(I.direction){case"towards":case"right":I.times[r]=m[r]-c;break;default:I.tiles=I.tiles.slice(c)}});yield[a,v];continue}const p=m[r]-i[r];if(p===2||p===1){const v=j(d,w=>{const I=w.config;switch(I.direction){case"towards":case"right":I.times[r]=m[r]-p;break;default:I.tiles=I.tiles.slice(0,-p)}});yield[a,v];continue}const u=j(d,v=>{const w=v.config;switch(w.direction){case"towards":case"right":w.times[r]=i[r];break;default:w.tiles=w.tiles.slice(0,i[r])}});yield[`${a}/beforeDoor`,u];const g=j(d,v=>{v.position={...f,[r]:t[r]+2};const w=v.config;switch(w.direction){case"towards":case"right":w.times[r]=m[r]-i[r]-2;break;default:w.tiles=w.tiles.slice(i[r]+2)}});yield[`${a}/afterDoor`,g],yield[a,null]}}const qe=(e,o,t,n,a)=>{const d=ue(e,o);if(d===void 0)throw new Error("can't cut hole in walls for a room that does not exist");const f=Ye(e,a,o);for(const[l,m]of Qe(d.items,t,n))a?f[l]=m:m===null?delete f[l]:f[l]=m},lt=(e,o,t,n)=>{const a=e.campaignInProgress,d=z($({campaign:a,roomId:o.id})).find(({gridPosition:f})=>fo(f,M[t]));if(d)return a.rooms[d.roomId];if(!n)return ge(e,o.planet)},dt=(e,o,t,n,a)=>{const d=R(e),f=t;qe(e,d.id,f,o,a);const l=lt(e,d,f,a),[m,r]=ye(e,{type:"door",config:{...n.config,toRoom:l?l.id:"(new)",direction:f}},o,a);if(!a){if(l===void 0)throw new Error("if not a preview, should have guaranteed a room to go to");const s=he(l,n,a),i={x:f==="left"?0:f==="right"?l.size.x:o.x,y:f==="away"?0:f==="towards"?l.size.x:o.y,z:o.z},c=lo(f),y={type:"door",config:{toRoom:d.id,direction:c},position:i};l.items[s]=y,y.config.toDoor=m,r.config.toDoor=s,qe(e,l.id,c,i,!1)}},ft=e=>e.type==="door",ut=e=>e.type==="monster"&&e.config.which==="cyberman",yt={applyItemTool(e,{payload:{blockPosition:o,pointedAtItemJson:t,preview:n}}){const a=e,{tool:d}=a;if(d.type!=="item")throw new Error("applying item tool reducer while the current tool is not an item tool");switch(n||(_(a),a.previewedEdits={}),a.selectedJsonItemIds=[],!0){case ft(d.item):{if(t.type!=="wall")throw new Error("doors can only be added on walls");dt(a,o,t.config.direction,d.item,n);break}case(ut(d.item)&&t.type==="deadlyBlock"&&t.config.style==="toaster"&&t.position.z+1===o.z):{ye(a,{...d.item,config:{...d.item.config,activated:"off"}},o,n);break}default:ye(a,d.item,o,n)}}},mt={changeDragInProgress(e,{payload:o}){const t=e;t.dragInProgress=o}},pt={changeGridResolution(e,{payload:o}){const t=e;t.halfGridResolution=o},changeWallsFloorsLocked(e,{payload:o}){const t=e;t.wallsFloorsLocked=o}},gt={setSelectedItemsInRoom(e,{payload:{jsonItemIds:o}}){e.selectedJsonItemIds=o},toggleSelectedItemInRoom(e,{payload:{jsonItemId:o}}){const t=e.selectedJsonItemIds.indexOf(o);t===-1?e.selectedJsonItemIds.push(o):e.selectedJsonItemIds.splice(t,1)},setHoveredItemInRoom(e,o){e.hoveredItem=o.payload},setClickableAnnotationHovered(e,o){e.clickableAnnotationHovered=o.payload}},ht=e=>De(ve(e))>0,ve=e=>{switch(e.type){case"deadlyBlock":return q;case"conveyor":if(e.config.disappearing)return W;switch(e.config.direction){case"left":case"right":return{x:1,y:0,z:0};case"away":case"towards":return{x:0,y:1,z:0};default:throw e.config.direction,new Error}case"hushPuppy":return q;case"teleporter":return{x:1,y:1,z:0};case"floor":case"spikes":return{x:1,y:1,z:0};case"block":return e.config.disappearing?W:q;case"barrier":if(e.config.disappearing)return W;switch(e.config.axis){case"x":return{x:1,y:0,z:1};case"y":return{x:0,y:1,z:1};default:throw e.config.axis,new Error}case"wall":switch(e.config.direction){case"left":case"right":return{x:0,y:1,z:1};case"away":case"towards":return{x:1,y:0,z:1};default:throw e.config,new Error}default:return W}},vt=(e,...o)=>({x:e(...o.map(t=>t.x)),y:e(...o.map(t=>t.y)),z:e(...o.map(t=>t.z))}),wt=e=>Be(e.items),It=e=>Ne(e),xt=e=>z(wt(e)),Z=(e,...o)=>{const t=z(It(e));return o.length===0?t:t.filter(([,n])=>o.includes(n.type))},Me=(e,o,t)=>{const n=t-e.length;n>0?e.push(...J(o,n,e.length)):n<0&&e.splice(t)},bt=e=>e==="towards"||e==="right";function*Ze(e,o){const t={type:"wall",config:bt(e.config.direction)?e.config.direction==="towards"?{direction:e.config.direction,times:{x:2}}:{direction:e.config.direction,times:{y:2}}:{direction:e.config.direction,tiles:[...J(o.planet,2,e.position[e.config.direction==="away"?"x":"y"])]},position:{...e.position,z:0}};yield[he(o,t,!1),t]}function eo(e,o){const t=oe(e.config),n=x(o.position,o.config.times);switch(e.config.direction){case"towards":if(e.position.y===o.position.y&&e.position.x>=o.position.x&&e.position.x<n.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:t.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===o.position.x&&t.x===o.config.times.x,wallTouchesFloorEnd:e.position.x+(t.x??1)===n.x};break;case"right":if(e.position.x===o.position.x&&e.position.y>=o.position.y&&e.position.y<n.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:t.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===o.position.y&&t.y===o.config.times.y,wallTouchesFloorEnd:e.position.y+(t.y??1)===n.y};break;case"away":if(e.position.y===o.position.y+o.config.times.y&&e.position.x>=o.position.x&&e.position.x<n.x)return{tangentAxis:"x",normalAxis:"y",edgePosition:e.position.y,wallStart:e.position.x,wallLength:t.x??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.x===o.position.x&&t.x===o.config.times.x,wallTouchesFloorEnd:e.position.x+(t.x??1)===n.x};break;case"left":if(e.position.x===o.position.x+o.config.times.x&&e.position.y>=o.position.y&&e.position.y<n.y)return{tangentAxis:"y",normalAxis:"x",edgePosition:e.position.x,wallStart:e.position.y,wallLength:t.y??1,isOnFloorEdge:!0,wallFullySpansFloor:e.position.y===o.position.y&&t.y===o.config.times.y,wallTouchesFloorEnd:e.position.y+(t.y??1)===n.y};break}return null}function*oo(e,o,t,n,a){const d=x(o.position,n),f=o.config.times,l=a?x(f,a):o.config.times,m=x(o.position,f),r=x(d,l);for(const[s,i]of z(e)){if(i.type==="wall"&&i.position.z!==o.position.z)continue;if(i.type==="door"){const h=i.config;let u=!1,g={...A(i.position)};switch(h.direction){case"towards":i.position.y===o.position.y&&i.position.x>=o.position.x&&i.position.x<o.position.x+f.x&&(u=!0,g=x(i.position,n));break;case"right":i.position.x===o.position.x&&i.position.y>=o.position.y&&i.position.y<o.position.y+f.y&&(u=!0,g=x(i.position,n));break;case"away":i.position.y===o.position.y+f.y&&i.position.x>=o.position.x&&i.position.x<o.position.x+f.x&&(u=!0,g=x(i.position,{x:n.x,y:n.y+(a?.y??0),z:n.z}));break;case"left":i.position.x===o.position.x+f.x&&i.position.y>=o.position.y&&i.position.y<o.position.y+f.y&&(u=!0,g=x(i.position,{x:n.x+(a?.x??0),y:n.y,z:n.z}));break}if(u){const v=structuredClone(A(i));v.position=g,yield[s,v]}continue}const c=i,y=eo(c,o);if(!y||!y.isOnFloorEdge)continue;const p=structuredClone(A(c));switch(c.config.direction){case"towards":case"right":p.position=x(c.position,n);break;case"away":{const h=d.y+l.y;p.position={...c.position,x:c.position.x+n.x,y:h};break}case"left":{const h=d.x+l.x;p.position={...c.position,x:h,y:c.position.y+n.y};break}}if(y.wallFullySpansFloor){const h=l[y.tangentAxis];c.config.direction==="away"||c.config.direction==="left"?Me(p.config.tiles,t,h):p.config.times={[y.tangentAxis]:h},yield[s,p]}else{const h=o.position[y.tangentAxis],u=m[y.tangentAxis],g=d[y.tangentAxis],v=r[y.tangentAxis],w=p.position[y.tangentAxis];if(w>=v){yield[s,null];continue}const I=Math.max(y.wallStart,h),k=Math.min(y.wallStart+y.wallLength,u)-I;let E;if(c.config.direction==="away"||c.config.direction==="left"){const P=o.position[y.normalAxis]+f[y.normalAxis],xe=d[y.normalAxis]+l[y.normalAxis];E=P!==xe}else E=o.position[y.normalAxis]!==d[y.normalAxis];const S=Math.max(w,g);let F;y.wallTouchesFloorEnd&&!E?F=v:F=Math.min(w+k,v);const O=F-S;O<=0?yield[s,null]:(c.config.direction==="away"||c.config.direction==="left"?Me(p.config.tiles,t,O):p.config.times={[y.tangentAxis]:O},yield[s,p])}}}function*Rt(e,o,t,n){for(const[a,d]of Z(e.items,"floor")){const f=eo(o,d);if(!f)continue;const l={x:0,y:0,z:0},m={x:0,y:0,z:0},r=t[f.normalAxis],s=t[f.tangentAxis],i=n?n[f.tangentAxis]:0;if(r!==0&&(o.config.direction==="towards"||o.config.direction==="right"?(l[f.normalAxis]=r,m[f.normalAxis]=-r):m[f.normalAxis]=r),s!==0&&(f.wallStart===d.position[f.tangentAxis]?(l[f.tangentAxis]=s,m[f.tangentAxis]=-s):f.wallTouchesFloorEnd&&(m[f.tangentAxis]=s)),i!==0&&f.wallTouchesFloorEnd&&(m[f.tangentAxis]=i),l.x!==0||l.y!==0||m.x!==0||m.y!==0){const c=x(d.config.times,m),y={...d,position:x(d.position,l),config:{...d.config,times:{x:c.x,y:c.y}}};yield[a,y]}yield*oo(Z(e.items,"wall","door"),d,e.planet,l,m)}}const Et={moveOrResizeItemAsPreview(e,{payload:{jsonItemIds:o,timesDelta:t,positionDelta:n}}){const a=e,d=R(a);for(const f of o){const l=Xe(a,f);if(l===void 0)throw new Error(`no json item found for some of the ids in resize ${f}`);if(l.type==="wall"){for(const[r,s]of Rt(d,l,n,t))a.previewedEdits[r]=s;continue}if(l.type==="floor")for(const[r,s]of oo(Z(d.items,"wall","door"),l,d.planet,n,t))a.previewedEdits[r]=s;if(l.type==="door"){console.log("before healing, room items are",A(d.items));for(const[r,s]of Ze(l,A(d)))console.log("healing",`"${r}"`,s),a.previewedEdits[r]=s}const m={...l,position:x(l.position,n),config:{...l.config}};if(a.previewedEdits[f]=m,At(m,t),l.type==="door"){console.log("before cutting room plus previews is",{...A(d.items),...A(a.previewedEdits)});for(const[r,s]of Qe({...A(d.items),...A(a.previewedEdits)},m.config.direction,m.position))console.log("cutting",`"${r}"`,s),a.previewedEdits[r]=s}}a.dragInProgress=!0}},At=(e,o)=>{if(o!==void 0){const t=me(e),n=ve(e),a=uo(o,n);if(De(a)>0){const d=ct(vt((f,l)=>Math.max(1,f+l),t,a));d===void 0?delete e.config.times:e.config.times=d}}};function Je(e){var o="";return t(e),o;function t(a){if(a===null||typeof a!="object"||a.toJSON!=null)o+=JSON.stringify(a);else if(Array.isArray(a)){o+="[";var d=!1;a.forEach(function(l){d&&(o+=","),d=!0,l===void 0&&(l=null),t(l)}),o+="]"}else{o+="{";var f=Object.keys(a).filter(function(l){return a[l]!==void 0}).sort();f.forEach(function(l,m){return n(a,l,m)}),o+="}"}}function n(a,d,f){f>0&&(o+=","),o+=JSON.stringify(d),o+=":",t(a[d])}}const Tr=(e,...o)=>{const t={};for(const n of o)t[n]=e[n];return t},kt=(e,...o)=>{const t={...e};for(const n of o)delete t[n];return t},T=e=>e.type==="wall"?`wall/${e.config.direction}`:e.type==="teleporter"?Je({type:e.type,config:kt(e.config,"toPosition")}):Je({type:e.type,config:e.config}),St=e=>ht(e[1]),Ct=e=>{const o=[];let t=0,n=0,a=0;for(const[,f]of e){const{x:l,y:m,z:r}=f.position,s=me(f),i=s.x,c=s.y,y=s.z;t=Math.max(t,l+i-1),n=Math.max(n,m+c-1),a=Math.max(a,r+y-1)}const d=Array.from({length:t+1},()=>Array.from({length:n+1},()=>Array.from({length:a+1},()=>new Set)));for(const f of e)if(!St(f))o.push(f);else{const[,l]=f,{x:m,y:r,z:s}=l.position,i=me(l),c=i.x,y=i.y,p=i.z;for(let h=0;h<c;h++)for(let u=0;u<y;u++)for(let g=0;g<p;g++){const v=m+h,w=r+u,I=s+g;v<d.length&&w<d[v].length&&I<d[v][w].length&&d[v][w][I].add(f)}}return{consolidatableGrid:d,nonConsolidatable:o}},Pt=e=>{const o=[],t=new Set;for(const n of e)for(const a of n)for(const d of a)for(const f of d){const[l]=f;t.has(l)||(t.add(l),o.push(f))}return o},Tt=e=>{const{consolidatableGrid:o,nonConsolidatable:t}=Ct(e),n={x:o.length,y:o[0].length,z:o[0][0].length},a=new Map,d=new Map;for(let s=0;s<n.x;s++)for(let i=0;i<n.y;i++)for(let c=0;c<n.z;c++)for(const[,y]of o[s][i][c]){const p=T(y);d.has(p)||d.set(p,y)}for(const[s]of d)a.set(s,Array.from({length:n.x},()=>Array.from({length:n.y},()=>Array(n.z).fill(!1))));const f=({x:s,y:i,z:c},y)=>{const p=T(y);return!a.get(p)[s][i][c]&&Array.from(o[s][i][c]).some(([,h])=>T(h)===T(y))},l=(s,i)=>{const c={...s},y=ve(i);if(y.x>0)for(;c.x+1<n.x&&f({...c,x:c.x+1},i);)c.x++;if(y.y>0)for(let p=s.x;p<=c.x;p++)for(;c.y+1<n.y&&Array.from({length:c.x-s.x+1}).every((h,u)=>f({x:s.x+u,y:c.y+1,z:s.z},i));)c.y++;if(y.z>0)for(let p=s.x;p<=c.x;p++)for(let h=s.y;h<=c.y;h++)for(;c.z+1<n.z&&Array.from({length:c.x-s.x+1}).every((u,g)=>Array.from({length:c.y-s.y+1}).every((v,w)=>f({x:s.x+g,y:s.y+w,z:c.z+1},i)));)c.z++;return c},m=(s,i)=>{if(s.type==="wall"){if(i.type!=="wall")throw new Error("only walls can join walls");if(s.config.direction!==i.config.direction)throw new Error("walls must have the same direction to join");if(s.config.direction==="right"||s.config.direction==="towards")return;s.config.tiles=[...s.config.tiles,...i.config.tiles]}},r=({x:s,y:i,z:c},{x:y,y:p,z:h},u)=>{const[,g]=u,v=T(g),w=y-s+1,I=p-i+1,H=h-c+1;if(w+I+H>3)if(g.type==="wall")switch(g.config.direction){case"away":case"left":break;case"towards":w!==1&&(g.config.times={x:w});break;case"right":I!==1&&(g.config.times={y:I});break}else w!==1&&(g.config.times={...g.config.times,x:w}),I!==1&&(g.config.times={...g.config.times,y:I}),H!==1&&(g.config.times={...g.config.times,z:H});for(let k=s;k<=y;k++)for(let E=i;E<=p;E++)for(let S=c;S<=h;S++)if(a.get(v)[k][E][S]=!0,k!==s||E!==i||S!==c){const F=o[k][E][S];e:for(const O of F){const[,P]=O;if(T(P)===v){P.position.x===k&&P.position.y===E&&P.position.z===S&&m(g,P),F.delete(O);break e}}}};for(let s=0;s<n.x;s++)for(let i=0;i<n.y;i++)for(let c=0;c<n.z;c++)for(const y of o[s][i][c]){const[,p]=y;if(p.position.x===s&&p.position.y===i&&p.position.z===c){const h=T(p),u=a.get(h);if(u&&!u[s][i][c]){const g=l({x:s,y:i,z:c},p);r({x:s,y:i,z:c},g,y)}}}return[...Pt(o),...t]},zt=e=>Object.fromEntries(Tt(Object.entries(e))),Ft=(e,o)=>{const t=e.items[o];if(t.type==="door"){for(const[n,a]of Ze(t,e))e.items[n]=a;e.items=zt(e.items)}delete e.items[o]},Le=(e,o)=>{xt(e).filter(t=>t.type==="floor").filter(t=>t.position.z===0).forEach(t=>{t.config={...t.config,floorType:o,scenery:o==="standable"?e.planet:void 0}})},Ot={changeRoomColour(e,{payload:o}){const t=e,n=t.campaignInProgress.rooms[t.currentlyEditingRoomId].color;_(t),Object.assign(n,o)},changeRoomScenery(e,{payload:o}){const t=e,n=R(t);_(t),Ke(n,o)},roomJsonEdited(e,{payload:o}){const t=e;t.campaignInProgress.rooms[t.currentlyEditingRoomId]=o},deleteSelected(e){const o=e,t=R(o);_(o),o.selectedJsonItemIds.forEach(n=>{Ft(t,n)}),o.selectedJsonItemIds=[]},clearRoom(e){const o=e,t=R(o);_(o);for(const n of Ue(t.items)){const a=t.items[n];a.type!=="floor"&&a.type!=="wall"&&a.type!=="door"&&(delete t.items[n],o.selectedJsonItemIds=o.selectedJsonItemIds.filter(d=>d!==n))}},setRoomAboveOrBelow(e,{payload:o}){const t=e,n=o.direction,a=n==="roomAbove"?"roomBelow":"roomAbove",d=R(t),f=o.createNew?ge(t,d.planet,d.color).id:o.roomId,l=d[n]&&ue(t,d[n]);l?.[a]===t.currentlyEditingRoomId&&(l[a]=void 0),d[n]=f;const m=f&&ue(t,f);m!==void 0&&(m[a]=d.id),m?Le(n==="roomBelow"?d:m,"none"):Le(n==="roomBelow"?d:l,"standable")}},$t=(e,o)=>{const t=Ne(o);for(const[n,a]of t)a===null?delete e.items[n]:e.items[n]=a},_t={resetPreviewedEdits(e){e.previewedEdits={}},commitCurrentPreviewedEdits(e){_(e),$t(R(e),e.previewedEdits),e.previewedEdits={}}},we="room_0",Wt={id:we,...Ve({x:8,y:8})},He={name:"new campaign",rooms:{[we]:Wt}},pe={campaignInProgress:He,savedCampaign:He,currentlyEditingRoomId:we,previewedEdits:{},tool:{type:"pointer"},hoveredItem:void 0,clickableAnnotationHovered:!1,selectedJsonItemIds:[],halfGridResolution:!1,wallsFloorsLocked:!0,dragInProgress:!1,history:{undo:[],redo:[]}},qt={loadCampaign(e,{payload:{campaign:o}}){const t=e;t.savedCampaign=o,t.campaignInProgress=o,t.hoveredItem=void 0,t.selectedJsonItemIds=[],t.clickableAnnotationHovered=!1,t.dragInProgress=!1,t.history=pe.history;const n=fe(Ue(o.rooms));if(n===void 0)throw new Error("could not find any rooms in this campaign");t.currentlyEditingRoomId=n},campaignSaved(e,{payload:{campaign:o}}){const t=e;t.savedCampaign=o}},Mt={addRoom(e){const o=e.campaignInProgress.rooms[e.currentlyEditingRoomId],t=ge(e,o.planet);e.currentlyEditingRoomId=t.id},removeRoom(e){const o=e.campaignInProgress.rooms[e.currentlyEditingRoomId],n=fe(Z(o.items,"door","teleporter"))?.[1].config.toRoom??fe(Fo(a=>a!==e.currentlyEditingRoomId,yo(e.campaignInProgress.rooms)));n!==void 0&&(delete e.campaignInProgress.rooms[e.currentlyEditingRoomId],e.currentlyEditingRoomId=n)}},Ie=mo({name:"levelEditor",initialState:pe,reducers:{setTool(e,{payload:o}){const t=e;o.type==="item"&&(t.selectedJsonItemIds=[]),t.tool=o},changeToRoom(e,{payload:o}){const t=e;if(!t.campaignInProgress.rooms[o]){console.warn(`can't change to room ${o} - it doesn't exist`);return}t.currentlyEditingRoomId=o,t.clickableAnnotationHovered=!1,t.hoveredItem=void 0,t.selectedJsonItemIds=[],t.history=pe.history},injected(){},...pt,...Jo,...yt,...mt,...gt,...Ot,...Et,..._t,...qt,...Mt},selectors:{selectCurrentCampaignInProgress:e=>e.campaignInProgress,selectCurrentEditingRoomJson:R,selectItem:Xe,selectCurrentEditingRoomColour:e=>R(e).color,selectCurrentEditingRoomScenery:e=>R(e).planet,selectTool:e=>e.tool,selectSelectedJsonItemIds:e=>e.selectedJsonItemIds,selectHoveredItem:e=>e.hoveredItem,selectItemIsSelected:Mo,...Lo}}),{addRoom:Jt,applyItemTool:Lt,campaignSaved:Ht,changeDragInProgress:Bt,changeGridResolution:jt,changeRoomColour:Gt,changeRoomScenery:Dt,changeToRoom:Nt,changeWallsFloorsLocked:Ut,clearRoom:Xt,commitCurrentPreviewedEdits:Vt,deleteSelected:Kt,injected:Yt,loadCampaign:Qt,moveOrResizeItemAsPreview:Zt,redo:er,removeRoom:or,resetPreviewedEdits:tr,roomJsonEdited:rr,setClickableAnnotationHovered:nr,setHoveredItemInRoom:ir,setRoomAboveOrBelow:sr,setSelectedItemsInRoom:ar,setTool:cr,toggleSelectedItemInRoom:lr,undo:dr}=Ie.actions,{selectCanRedo:fr,selectCanUndo:ur,selectCurrentCampaignInProgress:yr,selectCurrentEditingRoomColour:mr,selectCurrentEditingRoomJson:pr,selectCurrentEditingRoomScenery:gr,selectHoveredItem:hr,selectItem:vr,selectItemIsSelected:wr,selectSelectedJsonItemIds:Ir,selectTool:xr}=Ie.selectors,br=po.withTypes(),zr=Object.freeze(Object.defineProperty({__proto__:null,addRoom:Jt,applyItemTool:Lt,campaignSaved:Ht,changeDragInProgress:Bt,changeGridResolution:jt,changeRoomColour:Gt,changeRoomScenery:Dt,changeToRoom:Nt,changeWallsFloorsLocked:Ut,clearRoom:Xt,commitCurrentPreviewedEdits:Vt,deleteSelected:Kt,injected:Yt,levelEditorSlice:Ie,loadCampaign:Qt,moveOrResizeItemAsPreview:Zt,redo:er,removeRoom:or,resetPreviewedEdits:tr,roomJsonEdited:rr,selectCanRedo:fr,selectCanUndo:ur,selectCurrentCampaignInProgress:yr,selectCurrentEditingRoomColour:mr,selectCurrentEditingRoomJson:pr,selectCurrentEditingRoomScenery:gr,selectHoveredItem:hr,selectItem:vr,selectItemIsSelected:wr,selectSelectedJsonItemIds:Ir,selectTool:xr,setClickableAnnotationHovered:nr,setHoveredItemInRoom:ir,setRoomAboveOrBelow:sr,setSelectedItemsInRoom:ar,setTool:cr,toggleSelectedItemInRoom:lr,undo:dr,useAppSelectorWithLevelEditorSlice:br},Symbol.toStringTag,{value:"Module"}));export{Bt as $,M as A,Yo as B,Tr as C,We as D,oe as E,bt as F,Er as G,kr as H,At as I,Fo as J,Zt as K,Vt as L,Nt as M,b as N,rt as O,Pr as P,et as Q,Sr as R,Cr as S,Ar as T,nr as U,hr as V,Ir as W,at as X,me as Y,ve as Z,vt as _,cr as a,ar as a0,lr as a1,Lt as a2,ir as a3,tr as a4,Xe as a5,vr as a6,wr as a7,ht as a8,rr as a9,zr as aa,mr as b,jt as c,Kt as d,Gt as e,gr as f,Dt as g,ur as h,fr as i,dr as j,er as k,Ut as l,pr as m,J as n,Xt as o,R as p,sr as q,xo as r,xr as s,yr as t,br as u,Ht as v,Qt as w,Jt as x,or as y,ot as z};
